<!DOCTYPE html>
<!-- saved from url=(0080)https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage no-applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/ruby-on-rails/9780136702726/ch10.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="10224494" data-user-uuid="66943332-5511-462c-876e-5d5b720c7edf" data-username="czjtgu3dkobug4zdmolfga2wembsmu" data-account-type="Trial" data-activated-trial-date="12/02/2020" data-archive="9780136702726" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch10.xhtml" data-epub-title="Ruby on Rails Tutorial, 6th Edition" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780136702726"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/css" rel="stylesheet" type="text/css"><title>Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition</title><link rel="stylesheet" href="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/output.731fc84c4f9a.css" type="text/css"><link rel="stylesheet" type="text/css" href="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/font-awesome.min.css"><style type="text/css" title="ibis-book">@page{margin:1em 2em}#sbo-rt-content div{margin-top:1em;margin-bottom:1em;margin-left:1em;margin-right:1em;text-align:justify}#sbo-rt-content div.cover img{max-width:99%;max-height:99%}#sbo-rt-content .att{text-align:right}#sbo-rt-content .cover{margin-top:.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .h1{margin-top:1.5em;margin-bottom:.5em;font-weight:bold;font-size:210%;page-break-after:avoid;border-bottom:solid .1em;text-align:center}#sbo-rt-content .halftitle{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:210%;page-break-after:avoid;text-align:center}#sbo-rt-content .h2{margin-top:1em;margin-bottom:.1em;font-weight:bold;font-size:180%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2f{margin-top:1em;margin-bottom:2.5em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2t{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .center{text-align:center}#sbo-rt-content .h3{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:160%;page-break-after:avoid;text-align:left}#sbo-rt-content .h4{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:130%;page-break-after:avoid;text-align:left}#sbo-rt-content .h5{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:120%;page-break-after:avoid;text-align:left}#sbo-rt-content ul{margin-top:1em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content ul.sq{list-style-type:square}#sbo-rt-content ul.sq li p,#sbo-rt-content ul.sq li p.noindent{margin-top:.5em;margin-left:1em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .left{text-align:left}#sbo-rt-content .ex-title{margin-top:.8em;margin-bottom:.5em;text-indent:.1em;font-size:100%}#sbo-rt-content code{font-family:Courier,Courier New,monospace;font-size:small}#sbo-rt-content pre{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small}#sbo-rt-content .pre3{font-family:Courier,Courier New,monospace;margin-top:1em;margin-bottom:1em;margin-left:2.9em;background-color:#E6E6E6}#sbo-rt-content .equ{margin-top:.8em;margin-bottom:.5em;text-align:center}#sbo-rt-content .footnum{margin-top:.7em;margin-bottom:.5em;text-indent:-1em;margin-left:3.3em}#sbo-rt-content .footnotep{margin-top:.8em;margin-left:.8em;margin-bottom:.5em;text-indent:.8em}#sbo-rt-content .mark1{background-color:#F4F7F9}#sbo-rt-content .codelink{margin-top:.2em;margin-bottom:.5em}#sbo-rt-content .middle img{vertical-align:middle}#sbo-rt-content .box{margin-top:.6em;margin-bottom:1em;margin-left:.1em;margin-right:.8em;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .box-bq{font-size:.8em;margin-top:.8em;margin-bottom:.5em;margin-left:1.6em;text-indent:.1em;background-color:#E6E6E6}#sbo-rt-content .boxip{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:.8em;background-color:#E6E6E6}#sbo-rt-content ol.num{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p,#sbo-rt-content ol.num li p.number{margin-top:.5em;margin-left:.2em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .num-p{margin-top:.5em;margin-bottom:.5em;margin-left:0}#sbo-rt-content .bullet{margin-top:.7em;margin-bottom:.5em;text-indent:-.8em;margin-left:2em}#sbo-rt-content .credit{margin-top:.1em;margin-bottom:.1em;text-indent:-1.5em;margin-left:2em}#sbo-rt-content .box-caption{margin-top:.1em;margin-bottom:1em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:left}#sbo-rt-content .example{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small;border-top:.02em solid black;border-bottom:.02em solid black}#sbo-rt-content .image-l{margin-top:.8em;margin-left:1em;text-align:center}#sbo-rt-content .topbot{margin-top:.8em;margin-bottom:.5em;border-bottom:solid black .1em;border-top:solid black .1em;text-indent:.1em}#sbo-rt-content .uln{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash1{margin-top:.7em;margin-bottom:.7em;margin-left:3em}#sbo-rt-content .tr{border-bottom:.1em solid black}#sbo-rt-content th{text-align:left}#sbo-rt-content td{padding-left:.1em;padding-top:0;padding-bottom:0;vertical-align:top;text-align:left}#sbo-rt-content .mark{background-color:#E6E6E6}#sbo-rt-content .pre1{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:0;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .pre2{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content .tab-thc{margin-top:.1em;margin-bottom:.1em;border-bottom:solid black .1em;text-align:center}#sbo-rt-content .tab-th{margin-top:.1em;border-bottom:solid black .1em;border-top:solid black .1em;text-align:left}#sbo-rt-content .author{margin-top:2.5em;margin-bottom:5.5em;text-align:center;font-size:120%}#sbo-rt-content .pub{margin-top:1.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .pub1{font-weight:bold;font-size:.9em;margin-top:.1em;margin-bottom:.5em;text-align:center}#sbo-rt-content .copy{margin-top:.9em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .copy1{margin-top:.9em;margin-bottom:.2em;text-indent:.02em}#sbo-rt-content .copy2{margin-top:.2em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .title{margin-top:1em;margin-bottom:.2em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:center}#sbo-rt-content .noindent{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .tab-para{margin-top:.1em;margin-bottom:.1em;margin-left:.1em;text-indent:0}#sbo-rt-content .tab-parai{margin-top:.1em;margin-bottom:.1em;margin-left:1.1em;text-indent:-1.1em}#sbo-rt-content .boxnp{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .toc-intro{margin-top:.1em;margin-bottom:.5em;margin-left:1.5em;text-align:left}#sbo-rt-content .tocchap{margin-top:1.5em;margin-bottom:.4em;margin-left:3.4em;text-indent:-4em}#sbo-rt-content .toclev1{margin-top:.4em;margin-bottom:.4em;margin-left:1em}#sbo-rt-content .toclev2{margin-top:.4em;margin-bottom:.4em;margin-left:2.6em}#sbo-rt-content .toclev1a{margin-top:.4em;margin-bottom:.4em;margin-left:.5em}#sbo-rt-content .toc-index{margin-top:2em;margin-bottom:.4em;margin-left:.7em}#sbo-rt-content .indexmain{margin-top:.4em;margin-bottom:.2em;margin-left:.8em;text-indent:-.8em}#sbo-rt-content .indexsub{margin-top:.4em;margin-bottom:.2em;margin-left:1.7em;text-indent:-.7em}#sbo-rt-content .indexsubsub{margin-top:.4em;margin-bottom:.2em;font-style:italic;margin-left:3em;text-indent:-.9em}#sbo-rt-content figcaption{margin-top:.8em;margin-bottom:.5em;color:black;text-align:left;text-indent:.1em}#sbo-rt-content .subtitle{margin-top:.1em;margin-bottom:1em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .edition{margin-top:2em;margin-bottom:3em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .indent{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:1.5em}#sbo-rt-content .h2a{margin-top:.1em;margin-bottom:2em;font-weight:bold;font-size:190%;page-break-after:avoid;text-align:left}#sbo-rt-content figure>img{max-width:99%;max-height:99%}#sbo-rt-content figure{margin-top:1em;margin-bottom:1em;margin-left:.5em;margin-right:1.5em}#sbo-rt-content none{list-style-type:none}#sbo-rt-content a{text-decoration:none}#sbo-rt-content .footnote{font-size:.8em;margin-top:.1em;margin-bottom:.5em;margin-left:.8em}#sbo-rt-content .none{margin-top:.5em;margin-left:1em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content div.image-p img{width:80%}#sbo-rt-content .image-p{page-break-before:always;text-align:center}#sbo-rt-content table{border-collapse:collapse;border-spacing:0;background:transparent;vertical-align:top;margin-top:.1em;margin-right:.1em;margin-bottom:.9em;margin-left:0;width:100%}#sbo-rt-content .tab-parar{margin-top:.1em;margin-bottom:.1em;text-indent:.1em;text-align:right}#sbo-rt-content .h2i{margin-top:1em;margin-bottom:2.1em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content pre{overflow:auto;-ms-overflow:auto;-moz-overflow:auto;-webkit-overflow:auto;-ms-padding-bottom:5pt;-moz-padding-bottom:5pt;-webkit-padding-bottom:5pt}#sbo-rt-content .maroon{color:#BB2121}#sbo-rt-content .green{color:#005A00}#sbo-rt-content .green1{color:#48785D}#sbo-rt-content .navy{color:#504B72}#sbo-rt-content .ash{color:#666}#sbo-rt-content .blue{color:#408080}#sbo-rt-content .green3{color:#00A100}#sbo-rt-content .blue1{color:#0000B8}#sbo-rt-content .violet{color:#1A177D}#sbo-rt-content .pink{color:#A131A1}#sbo-rt-content .pink1{color:#A131A1}#sbo-rt-content .red{color:#800}#sbo-rt-content .blue3{color:#2E3192}#sbo-rt-content .red2{color:#B80000}#sbo-rt-content .green4{color:#269200}#sbo-rt-content .ash1{color:#666}#sbo-rt-content .ash2{color:#33484A}#sbo-rt-content .red2{color:#640000}#sbo-rt-content .ash3{color:#7D8F29}#sbo-rt-content .red5{color:#BD7B00}#sbo-rt-content .maroon1{color:#B66600}#sbo-rt-content .blue5{color:#1F3BFF}#sbo-rt-content .red6{color:#B68}#sbo-rt-content .green7{color:#14B600}#sbo-rt-content .maroon2{color:#B66600}#sbo-rt-content .pink2{color:#AC21FF}#sbo-rt-content .pink3{color:#AC21FF}#sbo-rt-content .lighgreen{color:#5FA100}#sbo-rt-content .lighblue{color:#269271}#sbo-rt-content .darkmaroon{color:#269271}#sbo-rt-content .maroon5{color:#A10000}#sbo-rt-content .blue6{color:#0000B9}#sbo-rt-content .marko{background-color:#FAF9CE}#sbo-rt-content .green5{color:#1C8B43}#sbo-rt-content .colork1{color:#136433;font-weight:bold}#sbo-rt-content .colork2{color:#504C72}#sbo-rt-content .colork3{color:#51785D}#sbo-rt-content .colork4{color:#303192}#sbo-rt-content .colork5{color:#955744}#sbo-rt-content .colork6{color:#5C70BA}#sbo-rt-content .colork7{color:#487864}#sbo-rt-content .colork8{color:#5C5778}#sbo-rt-content .colork9{color:#666}#sbo-rt-content .colork10{color:#48785D}#sbo-rt-content .colork11{color:#BC654D}#sbo-rt-content .colork12{color:#3E8185}#sbo-rt-content .colork13{color:#C62425}#sbo-rt-content .colork14{color:#1D8C43}#sbo-rt-content .colork15{color:#0D8140}#sbo-rt-content .colork16{color:#BB2425}#sbo-rt-content .colork17{color:#985744}#sbo-rt-content .colork18{color:#6C8896}#sbo-rt-content .colork19{color:#2A2C80}#sbo-rt-content .colork20{color:#BD2425}#sbo-rt-content .redk1{color:#EE1C25}#sbo-rt-content .colork21{color:#2A2C77}#sbo-rt-content .colork22{color:#955744}#sbo-rt-content .colork23{color:#BC6561}#sbo-rt-content .colork24{color:#BE7D2B}#sbo-rt-content .colork25{color:#8E7C5D}#sbo-rt-content .colork26{color:#7C5778}#sbo-rt-content .colork27{color:#9D1C1F}#sbo-rt-content .colork28{color:#AA5744}#sbo-rt-content .colork29{color:#C59861}#sbo-rt-content .grayk1{color:#C0908E}#sbo-rt-content .pd_green{color:#48785d}#sbo-rt-content .dark-green{color:#146333}#sbo-rt-content .mark1{background-color:#faf9ce}#sbo-rt-content .mark{background-color:#faf9ce}#sbo-rt-content .pd_ash{color:#666}#sbo-rt-content .pd_blue7{color:#6c8896}#sbo-rt-content .pd_blue1{color:#504b72}#sbo-rt-content .pd_red{color:#965744}#sbo-rt-content .pd_red2{color:#bb654e}#sbo-rt-content .pd_red5{color:#ed1c24}#sbo-rt-content .pd_blue5{color:#2e3192}#sbo-rt-content .pd_green4{color:#269200}#sbo-rt-content .pd_green5{color:#1c8b43}#sbo-rt-content .pd_blue3{color:#2c2c78}#sbo-rt-content .pd_orange{color:#c49847}</style><script type="text/javascript" async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/cool-2.1.15.min.js.download"></script><script type="text/javascript" async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/ec.js.download"></script><script type="text/javascript" async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/analytics.js.download"></script><script type="text/javascript" async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/f.txt"></script><script type="text/javascript" async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/js"></script><script crossorigin="anonymous" integrity="sha256-NiDMmov61Y536X/eLXLiDGzFVFmNLtPyu4b5aFB54ks=" type="text/javascript" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/appcues.main.11e38ef4746fd64ab30c11794299d10b30bcb704.js.download" async=""></script><script async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/gtm.js.download"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780136702726/chapter/ch10.xhtml",
          "book_id": "9780136702726",
          "chapter_uri": "ch10.xhtml",
          "position": 27.4567491080775,
          "user_uuid": "66943332-5511-462c-876e-5d5b720c7edf",
          "next_chapter_uri": "/library/view/ruby-on-rails/9780136702726/ch11.xhtml"
        
      },
      title: "Ruby on Rails Tutorial, 6th Edition",
      author_list: "Michael Hartl",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: true
    };
    // ]]></script><script src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/modernizr.8e35451ddb64.js.download"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta name="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta property="og:title" content="Chapter 10. Updating, Showing, and Deleting Users"><meta itemprop="isPartOf" content="/library/view/ruby-on-rails/9780136702726/"><meta itemprop="name" content="Chapter 10. Updating, Showing, and Deleting Users"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780136702726/"><meta property="og:description" itemprop="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9780136702726"><meta property="og:book:author" itemprop="author" content="Michael Hartl"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '66943332-5511-462c-876e-5d5b720c7edf';
      dataLayer.push({userIdentifier: '66943332-5511-462c-876e-5d5b720c7edf'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = 'ba5f3401-307d-4b66-90a6-a97047c63525';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/vendor.3eecedff6f59.js.download"></script><script defer="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/reader.772cf1e31d6c.js.download"></script><iframe src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/saved_resource.html"></iframe><iframe src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(3).html"></iframe><iframe src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(4).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-q9sKb2HpA5fJjN1cK9LjLaEXff5ix81Rv1Y3xJFptPE=" crossorigin="anonymous" href="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/container.11e38ef4746fd64ab30c11794299d10b30bcb704.css"><iframe src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(5).html"></iframe><script src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/f(1).txt"></script><script async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/MathJax.js.download"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
</style><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax.MathJax_FullWidth {text-align: center; display: table-cell!important; width: 10000em!important}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax_LineBox {display: table!important}
.MathJax_LineBox span {display: table-cell!important; width: 10000em!important; min-width: 0; max-width: none; padding: 0; border: 0; margin: 0}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?V=2.7.1') format('opentype')}
</style><style type="text/css">@font-face {font-family: MathJax_AMS; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_AMS-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_AMS-Regular.otf?V=2.7.1') format('opentype')}
</style></head>


<body class="reading sidenav  scalefonts subscribe-panel library nav-collapsed"><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="working hide" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/66943332-5511-462c-876e-5d5b720c7edf/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Attend</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/live-training/" class="l2 nav-icn"><span>Live Trainings</span></a></li><li><a href="https://learning.oreilly.com/featured/architectural-katas" class="l2 nav-icn"><span>Architectural Katas</span></a></li><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interact</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/?classification=content-scenario" class="l2 nav-icn"><span>Scenarios</span></a></li><li><a href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario" class="l2 nav-icn"><span>Sandboxes</span></a></li><li><a href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li><a href="https://learning.oreilly.com/answers/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"></path></svg><span>Answers</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://learning.oreilly.com/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Ruby on Rails Tutorial, 6th Edition
      
    </h1></span></a><div class="toc-contents" style="max-height: 0px;">
  <div class="sbo-toc">
    <button type="button" class="sbo-toc-thumb close"><div class="visuallyhidden">Close</div></button>
      <section class="ios-app-teaser">
        <ul>
            <li><a class="js-toc-link toc-link" href="https://itunes.apple.com/gb/app/safari-queue-library-over/id881697395?mt=8" role="button">Install App</a></li>
            <li><a class="js-toc-link toc-link" href="safaridetail://9780136702726" role="button">Open in App</a></li>
        </ul>
      </section>
      <div class="sbo-book-meta">
        
        <span class="cover">
         <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">
          <img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/saved_resource" alt="Cover image for Ruby on Rails Tutorial, 6th Edition" height="184" width="141">
        </a>
        </span>
        <span class="title">
          
            
                <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
                  <img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/addison-wesley.png" class="publisher-logo video" alt="publisher logo">
                </a>
            
          

          <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">Ruby on Rails Tutorial, 6th Edition</a>
        </span>
        
        <span class="authors">by Michael Hartl</span>
        

        
        <span class="publishers t-publishers">Published by
          <!-- Show publisher page link if publisher pages switch is on -->
          
            <a class="t-publisher-link toc-link js-toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
              Addison-Wesley Professional</a>, 2020
          
        </span>
        

    

    </div>
  <ol class="tocList">
    
    
    
     

     <li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/cover.xhtml">
        Cover Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref00.xhtml">
        About This eBook <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/halftitle.xhtml">
        Halftitle Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/title.xhtml">
        Title Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/copy.xhtml">
        Copyright Page <span class="minutes">(02:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/toc.xhtml#toc">
        Contents <span class="minutes">(05:45 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref02.xhtml#pref02">
        Foreword <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref03.xhtml#pref03">
        Acknowledgments <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref04.xhtml#pref04">
        About the Author <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#ch01">
        Chapter 1. From Zero to Deploy <span class="minutes">(77:03 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">
        Chapter 2. A Toy App <span class="minutes">(50:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03">
        Chapter 3. Mostly Static Pages <span class="minutes">(63:15 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04">
        Chapter 4. Rails-Flavored Ruby <span class="minutes">(57:30 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">
        Chapter 5. Filling in the Layout <span class="minutes">(60:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">
        Chapter 6. Modeling Users <span class="minutes">(67:51 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">
        Chapter 7. Sign Up <span class="minutes">(79:21 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">
        Chapter 8. Basic Login <span class="minutes">(66:42 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">
        Chapter 9. Advanced Login <span class="minutes">(52:54 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1 currently-reading">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">
        Chapter 10. Updating, Showing, and Deleting Users <span class="minutes">(73:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">
        Chapter 11. Account Activation <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">
        Chapter 12. Password Reset <span class="minutes">(48:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">
        Chapter 13. User Microposts <span class="minutes">(106:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">
        Chapter 14. Following Users <span class="minutes">(78:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml#index">
        Index <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/credits.xhtml#credits">
        Credits <span class="minutes">(19:33 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01_images.xhtml#ch01_images">
        Code Snippets <span class="minutes">(09:12 mins)</span>
       </a>
      
        
      
   </li></ol>
 </div>



</div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780136702726/chapter/ch10.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li class="currently-reading"><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml&amp;text=Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition&amp;via=OReillyMedia"><span>Twitter</span></a></li><li class="currently-reading"><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Facebook</span></a></li><li class="currently-reading"><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Google Plus</span></a></li><li class="currently-reading"><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Chapter%2010.%20Updating%2C%20Showing%2C%20and%20Deleting%20Users&amp;body=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml%0D%0Afrom%20Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document"><script src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/48743.js.download"></script>
<script>
  var userId = "66943332-5511-462c-876e-5d5b720c7edf";

  var userObject = {
    firstName: "Trn",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2020-12-01",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 12. Password Reset</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 14. Following Users</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section epub:type="chapter">
<h2 class="h2" id="ch13"><span epub:type="pagebreak" id="page_627"></span>Chapter 13</h2>
<h2 class="h2a">User Microposts</h2>
<p class="noindent">In the course of developing the core sample application, weve now encountered four resourcesusers, sessions, account activations, and password resetsbut only the first of these is backed by an Active Record model with a table in the database. The time has finally come to add a second such resource: user <em>microposts</em>, which are short messages associated with a particular user.<sup><a id="ch13fn1a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn1" class="totri-footnote">1</a></sup> We first saw microposts in larval form in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">Chapter 2</a>. In this chapter we will make a full-strength version of the sketch from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#sec2_3">Section 2.3</a> by constructing the Micropost data model, associating it with the User model using the <span class="colork1"><code><strong>has_many</strong></code></span> and <span class="colork1"><code><strong>belongs_to</strong></code></span> methods, and then making the forms and partials needed to manipulate and display the results (including, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4">Section 13.4</a>, uploaded images). In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">Chapter 14</a>, well complete our tiny Twitter clone by adding the notion of <em>following</em> users to receive a <em>feed</em> of their microposts.</p>
<p class="footnote"><a id="ch13fn1" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn1a" class="totri-footnote">1</a>. The name is motivated by the common description of Twitter as a <em>microblog</em>; since blogs have posts, microblogs should have <em>microposts</em>, which can be thought of as the generic equivalent of tweets.</p>
<section>
<h3 class="h3" id="sec13_1">13.1 A Micropost Model</h3>
<p class="noindent">We begin the Microposts resource by creating a Micropost model, which captures the essential characteristics of microposts. What follows builds on the work from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#sec2_3">Section 2.3</a>; as with the model in that section, our new Micropost model will include data validations and an association with the User model. Unlike that model, the present Micropost model will be fully tested, and will also have a default <em>ordering</em> and automatic <em>destruction</em> if its parent user is destroyed.<span epub:type="pagebreak" id="page_628"></span></p>
<p class="indent">If youre using Git for version control, I suggest making a topic branch at this time:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg628-01a" id="pg628-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork2"><strong>$</strong></span> git checkout -b user-microposts</pre>
<section>
<h4 class="h4" id="sec13_1_1">13.1.1 The Basic Model</h4>
<p class="noindent">The Micropost model needs only two attributes: a <span class="colork1"><code><strong>content</strong></code></span> attribute to hold the microposts content and a <span class="colork1"><code><strong>user_id</strong></code></span> to associate a micropost with a particular user. The result is a Micropost model with the structure shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig01">Figure 13.1</a>.</p>
<figure id="ch13fig01" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_01.jpg" alt="Image" width="469" height="270" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_01.jpg">
<figcaption><p><strong>Figure 13.1:</strong> The Micropost data model.</p></figcaption>
</figure>
<p class="indent">Its worth noting that the model in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig01">Figure 13.1</a> uses the <span class="colork1"><code><strong>text</strong></code></span> data type for micropost content (instead of <span class="colork1"><code><strong>string</strong></code></span>), which is capable of storing an arbitrary amount of text. Even though the content will be restricted to fewer than 140 characters (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_2">Section 13.1.2</a>) and hence would fit inside the 255-character <span class="colork1"><code><strong>string</strong></code></span> type, using <span class="colork1"><code><strong>text</strong></code></span> better expresses the nature of microposts, which are more naturally thought of as blocks of text. Indeed, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_2">Section 13.3.2</a> well use a text <em>area</em> instead of a text field for submitting microposts. In addition, using <span class="colork1"><code><strong>text</strong></code></span> gives us greater flexibility should we wish to increase the length limit at a future date (as part of internationalization, for example). Finally, using the <span class="colork1"><code><strong>text</strong></code></span> type results in no performance difference in production,<sup><a id="ch13fn2a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn2" class="totri-footnote">2</a></sup> so it costs us nothing to use it here.</p>
<p class="footnote"><a id="ch13fn2" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn2a" class="totri-footnote">2</a>. <a href="http://www.postgresql.org/docs/9.1/static/datatype-character.html">www.postgresql.org/docs/9.1/static/datatype-character.html</a><span epub:type="pagebreak" id="page_629"></span></p>
<p class="indent">As with the case of the User model (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a>), we generate the Micropost model using <span class="colork1"><code><strong>generate model</strong></code></span> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex01">Listing 13.1</a>).</p>
<p class="ex-title" id="ch13ex01"><strong>Listing 13.1:</strong> Generating the Micropost model.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-01a" id="lis13-01">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork2"><strong>$</strong></span> rails generate model Micropost content:text user:references</pre>
</div>
<p class="indent">This migration leads to the creation of the Micropost model shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex02">Listing 13.2</a>. In addition to inheriting from <span class="colork1"><code><strong>ApplicationRecord</strong></code></span> as usual (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_2">Section 6.1.2</a>), the generated model includes a line indicating that a micropost <span class="colork1"><code><strong>belongs_to</strong></code></span> a user, which is included as a result of the <span class="colork1"><code><strong>user:references</strong></code></span> argument in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex01">Listing 13.1</a>. Well explore the implications of this line in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_3">Section 13.1.3</a>.</p>
<p class="ex-title" id="ch13ex02"><strong>Listing 13.2:</strong> The generated Micropost model.</p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-02a" id="lis13-02">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork3">class</span> <span class="colork4">Micropost</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
   belongs_to :<span class="colork6">user</span>
<span class="colork7"><strong>end</strong></span></pre>
</div>
<p class="indent">The <span class="colork1"><code><strong>generate</strong></code></span> command in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex01">Listing 13.1</a> also produces a migration to create a <span class="colork1"><code><strong>microposts</strong></code></span> table in the database (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex03">Listing 13.3</a>); compare it to the analogous migration for the <span class="colork1"><code><strong>users</strong></code></span> table from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>. The biggest difference is the use of <span class="colork1"><code><strong>references</strong></code></span>, which automatically adds a <span class="colork1"><code><strong>user_id</strong></code></span> column (along with an index and a foreign key reference)<sup><a id="ch13fn3a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn3" class="totri-footnote">3</a></sup> for use in the user/micropost association. As with the User model, the Micropost model migration automatically includes the <span class="colork1"><code><strong>t.timestamps</strong></code></span> line, which (as mentioned in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_1">Section 6.1.1</a>) adds the magic <span class="colork1"><code><strong>created_at</strong></code></span> and <span class="colork1"><code><strong>updated_at</strong></code></span> columns shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig01">Figure 13.1</a>. (Well put the <span class="colork1"><code><strong>created_at</strong></code></span> column to work starting in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_4">Section 13.1.4</a>.)</p>
<p class="footnote"><a id="ch13fn3" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn3a" class="totri-footnote">3</a>. The foreign key reference is a database-level constraint indicating that the user id in the microposts table refers to the id column in the users table. This detail will never be important in this tutorial, and the foreign key constraint isnt even supported by all databases. (Its supported by PostgreSQL, which we use in production, but not by the development SQLite database adapter.) Well learn more about foreign keys in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_2">Section 14.1.2</a>.<span epub:type="pagebreak" id="page_630"></span></p>
<p class="ex-title" id="ch13ex03"><strong>Listing 13.3:</strong> The Micropost migration with added index.</p>
<pre class="pre2">db/migrate/[timestamp]_create_microposts.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-03a" id="lis13-03">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork3">class</span> <span class="colork4">CreateMicroposts</span></strong> <span class="colork5">&lt; ActiveRecord::Migration[6.0]</span>
  <span class="colork10"><strong>def</strong></span> <span class="colork6">change</span>
    create_table <span class="colork8">:microposts</span> <span class="colork10"><strong>do</strong></span> <span class="colork9">|</span>t<span class="colork9">|</span>
      t<span class="colork8">.</span>text <span class="colork8">:content</span>
      t<span class="colork8">.</span>references <span class="colork8">:user</span>, <span class="colork8">null:</span> <span class="colork10"><strong>false</strong></span>, <span class="colork8">foreign_key:</span> <span class="colork10"><strong>true</strong></span>

      t<span class="colork8">.</span>timestamps
    <span class="colork6"><strong>end</strong></span>
<span class="mark">    add_index <span class="colork8">:microposts</span>, <span class="colork8">[:user_id, :created_at]</span></span>
  <span class="colork10"><strong>end</strong></span>
<span class="colork10"><strong>end</strong></span></pre>
</div>
<p class="indent">Because we expect to retrieve all the microposts associated with a given user id in reverse order of creation, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex03">Listing 13.3</a> adds an index (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#box6_2">Box 6.2</a>) on the <span class="colork1"><code><strong>user_id</strong></code></span> and <strong>created_at</strong> columns:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg630-01a" id="pg630-01">Click here to view code image</a></p>
<pre class="pre1">add_index <span class="colork8">:microposts</span>, <span class="colork8">[:user_id, :created_at]</span></pre>
<p class="noindent">By including both the <span class="colork1"><code><strong>user_id</strong></code></span> and <span class="colork1"><code><strong>created_at</strong></code></span> columns as an array, we arrange for Rails to create a <em>multiple key index</em>, which means that Active Record uses <em>both</em> keys at the same time.</p>
<p class="indent">With the migration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex03">Listing 13.3</a>, we can update the database as usual:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg630-02a" id="pg630-02">Click here to view code image</a></p>
<pre class="pre1">$ rails db:migrate</pre>
<section>
<h5 class="h5" id="lev147">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Using <span class="colork1"><code><strong>Micropost.new</strong></code></span> in the console, instantiate a new Micropost object called <span class="colork1"><code><strong>micropost</strong></code></span> with content Lorem ipsum and user id equal to the id of the first user in the database. What are the values of the magic columns <span class="colork1"><code><strong>created_at</strong></code></span> and <span class="colork1"><code><strong>updated_at</strong></code></span>?<span epub:type="pagebreak" id="page_631"></span></p></li>
<li><p class="num">What is <span class="colork1"><code><strong>micropost.user</strong></code></span> for the micropost in the previous exercise? What about <span class="colork1"><code><strong>micropost.user.name</strong></code></span>?</p></li>
<li><p class="num">Save the micropost to the database. What are the values of the magic columns now?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_1_2">13.1.2 Micropost Validations</h4>
<p class="noindent">Now that weve created the basic model, well add some validations to enforce the desired design constraints. One of the necessary aspects of the Micropost model is the presence of a user id to indicate which user made the micropost. The idiomatically correct way to do this is to use Active Record <em>associations</em>, which well implement in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_3">Section 13.1.3</a>. For now, though, well work with the <span class="colork1"><code><strong>Micropost</strong></code></span> model directly.</p>
<p class="indent">The initial micropost tests parallel those for the User model (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex07">Listing 6.7</a>). In the <span class="colork1"><code><strong>setup</strong></code></span> step, we create a new micropost while associating it with a valid user from the fixtures, and then check that the result is valid. Because every micropost should have a user id, well add a test for a <span class="colork1"><code><strong>user_id</strong></code></span> presence validation. Putting these elements together yields the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex04">Listing 13.4</a>.</p>
<p class="ex-title" id="ch13ex04"><strong>Listing 13.4:</strong> Tests for the validity of a new micropost. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">test/models/micropost_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-04a" id="lis13-04">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostTest</span></strong> <span class="colork9">&lt;</span> <span class="colork5">ActiveSupport::TestCase</span>

  <span class="colork10"><strong>def</strong></span> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
<span class="bcolork1"><span class="colork12">    # This code is not idiomatically correct.</span></span>
<span class="mark"><span class="colork4">    @micropost</span> <span class="colork13">= Micropost.</span>new(<span class="colork4">content:</span> <span class="colork13">"Lorem ipsum"</span>, <span class="colork4">user_id: @user.</span>id)</span>
  <span class="colork10"><strong>end</strong></span>

  <span class="colork10">test</span> <span class="colork11">"should be valid"</span> <span class="colork10"><strong>do</strong></span>
    assert <span class="colork8">@micropost.</span>valid?
  <span class="colork10"><strong>end</strong></span>

  <span class="colork10">test</span> <span class="colork11">"user id should be present"</span> <span class="colork10"><strong>do</strong></span>
    <span class="colork4">@micropost.</span>user_id = <span class="colork10"><strong>nil</strong></span>
    assert_not <span class="colork4">@micropost.</span>valid?
  <span class="colork10"><strong>end</strong></span>
<span class="colork10"><strong>end</strong></span></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_632"></span>As indicated by the comment in the <span class="colork1"><code><strong>setup</strong></code></span> method, the code to create the micropost is not idiomatically correct. Well fix this problem in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_3">Section 13.1.3</a>.</p>
<p class="indent">As with the original User model test (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex05">Listing 6.5</a>), the first test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex04">Listing 13.4</a> is just a reality check, but the second is a test of the presence of the user id, for which well add the presence validation shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex05">Listing 13.5</a>.</p>
<p class="ex-title" id="ch13ex05"><strong>Listing 13.5:</strong> A validation for the microposts <span class="colork1"><code><strong>user_id</strong></code></span>. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-05a" id="lis13-05">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:user</span>
<span class="mark">  validates :<span class="colork4">user_id</span>, <span class="colork4">presence</span>: <span class="colork15"><strong>true</strong></span></span>
<span class="colork10"><strong>end</strong></span></pre>
</div>
<p class="indent">By the way, as of Rails 5 the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex04">Listing 13.4</a> actually pass without the validation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex05">Listing 13.5</a>, but only when using the idiomatically incorrect line highlighted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex04">Listing 13.4</a>. The user id presence validation is necessary after switching to the idiomatically correct code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex012">Listing 13.12</a>, so we include it here for convenience.</p>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex05">Listing 13.5</a> the tests should (still) be <span class="colork15"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex06"><strong>Listing 13.6:</strong> <span class="colork14"><small>GREEN</small></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-06a" id="lis13-06">Click here to view code image</a></p>
<div class="example">
<pre>$ rails test:models</pre>
</div>
<p class="indent">Next, well add validations for the microposts <span class="colork1"><code><strong>content</strong></code></span> attribute (following the example from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#sec2_3_2">Section 2.3.2</a>). As with the <span class="colork1"><code><strong>user_id</strong></code></span>, the <span class="colork1"><code><strong>content</strong></code></span> attribute must be present, and it is further constrained to be no longer than 140 characters (which is what puts the <em>micro</em> in micropost).</p>
<p class="indent">As with the User model validations (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2">Section 6.2</a>), well add the micropost content validations using test-driven development. The resulting tests generally follow the examples from the User model validation tests, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex07">Listing 13.7</a>.</p>
<p class="ex-title" id="ch13ex07"><strong>Listing 13.7:</strong> Tests for the Micropost model validations. <span class="colork14"><small>RED</small></span></p>
<pre class="pre2">test/models/micropost_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-07a" id="lis13-07">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostTest</span></strong> <span class="colork5">&lt; ActiveSupport::TestCase</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
<span epub:type="pagebreak" id="page_633"></span>    <span class="colork8">@micropost =</span> <span class="colork4">Micropost.new</span>(content: <span class="colork16">"Lorem ipsum"</span>, <span class="colork8">user_id: @user.</span>id)
  <span class="colork10"><strong>end</strong></span>

  <span class="colork16">test "should be valid"</span> <span class="colork10"><strong>do</strong></span>
    assert <span class="colork8">@micropost.</span>valid?
  <span class="colork10"><strong>end</strong></span>

  <span class="colork8">test</span> <span class="colork16">"user id should be present"</span> <span class="colork5"><strong>do</strong></span>
    <span class="colork8">@micropost.</span>user_id = <span class="colork10"><strong>nil</strong></span>
    assert_not <span class="colork8">@micropost.</span>valid?
  <span class="colork10"><strong>end</strong></span>

<span class="mark">  <span class="colork8">test</span> <span class="colork16">"content should be present"</span> <span class="colork10"><strong>do</strong></span></span>
<span class="mark">    <span class="colork8">@micropost.</span>content <span class="colork16">= " "</span></span>
<span class="mark">    assert_not <span class="colork8">@micropost.</span>valid?</span>
<span class="mark">  <span class="colork10"><strong>end</strong></span></span>

<span class="mark">  <span class="colork16">test "content should be at most 140 characters"</span> <span class="colork10"><strong>do</strong></span></span>
<span class="mark">    <span class="colork8">@micropost.</span>content <span class="colork16">= "a" * 141</span></span>
<span class="mark">    assert_not <span class="colork8">@micropost.</span>valid?</span>
<span class="mark">  <span class="colork10"><strong>end</strong></span></span>
<span class="colork10"><strong>end</strong></span></pre>
</div>
<p class="noindent">As in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2">Section 6.2</a>, the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex07">Listing 13.7</a> uses string multiplication to test the micropost length validation:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg633-01a" id="pg633-01">Click here to view code image</a></p>
<pre class="pre1"><strong>$</strong> rails console
<strong>&gt;</strong>&gt; <span class="colork11">"a"</span> * <span class="colork11">10</span>
=&gt; <span class="colork1">"aaaaaaaaaa"</span>
<strong>&gt;</strong>&gt; <span class="colork11">"a"</span> * <span class="colork11">141</span>
=&gt; <span class="colork1">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span></pre>
<p class="indent">The corresponding application code is virtually identical to the <span class="colork1"><code><strong>name</strong></code></span> validation for users (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex016">Listing 6.16</a>), as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex08">Listing 13.8</a>.</p>
<p class="ex-title" id="ch13ex08"><strong>Listing 13.8:</strong> The Micropost model validations. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-08a" id="lis13-08">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork16">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:user</span>
  validates <span class="colork8">:user_id</span>, <span class="colork8">presence:</span> <span class="colork3"><strong>true</strong></span>
<span class="mark">  validates :<span class="colork8">content</span>, <span class="colork8">presence</span>: <span class="colork3"><strong>true</strong></span>, <span class="colork4">length:</span> { <span class="colork4">maximum</span>: <span class="colork3">140</span> }</span>
<span class="colork10"><strong>end</strong></span></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_634"></span>At this point, the full test suite should be <span class="colork14"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex09"><strong>Listing 13.9:</strong> <span class="colork14"><small>GREEN</small></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-09a" id="lis13-09">Click here to view code image</a></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev148">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">At the console, instantiate a micropost with no user id and blank content. Is it valid? What are the full error messages?</p></li>
<li><p class="num">At the console, instantiate a second micropost with no user id and content thats too long. Is it valid? What are the full error messages?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_1_3">13.1.3 User/Micropost Associations</h4>
<p class="noindent">When constructing data models for web applications, it is essential to be able to make <em>associations</em> between individual models. In the present case, each micropost is associated with one user, and each user is associated with (potentially) many micropostsa relationship seen briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#sec2_3_3">Section 2.3.3</a> and shown schematically in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig02">Figure 13.2</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig03">Figure 13.3</a>. As part of implementing these associations, well write tests for the Micropost model and add a couple of tests to the User model.</p>
<figure id="ch13fig02" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_02.jpg" alt="Image" width="674" height="211" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_02.jpg">
<figcaption><p><strong>Figure 13.2:</strong> The <span class="colork1"><code><strong>belongs_to</strong></code></span> relationship between a micropost and its associated user.</p>
</figcaption>
</figure>
<figure id="ch13fig03" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_03.jpg" alt="Image" width="753" height="305" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_03.jpg">
<figcaption><p><strong>Figure 13.3:</strong> The <span class="colork1"><code><strong>has_many</strong></code></span> relationship between a user and its microposts.</p>
</figcaption>
</figure>
<p class="indent">Using the <span class="colork1"><code><strong>belongs_to</strong></code></span>/<code><strong>has_many</strong></code> association defined in this section, Rails constructs the methods shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13tab01">Table 13.1</a>. Note from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13tab01">Table 13.1</a> that instead of<span epub:type="pagebreak" id="page_635"></span></p>
<figure id="ch13tab01">
<figcaption><p class="left"><strong>Table 13.1:</strong> A summary of user/micropost association methods.</p></figcaption>
<table class="topbot">
<thead>
<tr>
<th class="tab-th"><p class="tab-para">Method</p></th>
<th class="tab-th"><p class="tab-para">Purpose</p></th></tr>
</thead>
<tbody>
<tr>
<td><p class="tab-para"><span class="colork1"><code><strong>micropost.user</strong></code></span></p></td>
<td><p class="tab-para">Returns the User object associated with the micropost</p></td></tr>
<tr>
<td><p class="tab-para"><span class="colork1"><code><strong>user.microposts</strong></code></span></p></td>
<td><p class="tab-para">Returns a collection of the users microposts</p></td></tr>
<tr>
<td><p class="tab-para"><span class="colork1"><code><strong>user.microposts.create(arg)</strong></code></span></p></td>
<td><p class="tab-para">Creates a micropost associated with <span class="colork1"><code><strong>user</strong></code></span></p></td></tr>
<tr>
<td><p class="tab-para"><span class="colork1"><code><strong>user.microposts.create!(arg)</strong></code></span></p></td>
<td><p class="tab-para">Creates a micropost associated with <span class="colork1"><code><strong>user</strong></code></span> (exception on failure)</p></td></tr>
<tr>
<td><p class="tab-para"><span class="colork1"><code><strong>user.microposts.build(arg)</strong></code></span></p></td>
<td><p class="tab-para">Returns a new Micropost object associated with <span class="colork1"><code><strong>user</strong></code></span></p></td></tr>
<tr>
<td><p class="tab-para"><span class="colork1"><code><strong>user.microposts.find_by(id: 1)</strong></code></span></p></td>
<td>Finds the micropost with id <span class="colork1"><code><strong>1</strong></code></span> and <span class="colork1"><code><strong>user_id</strong></code></span> equal to <span class="colork1"><code><strong>user.id</strong></code></span></td>
</tr>
</tbody>
</table>
</figure>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg635-01a" id="pg635-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork17">Micropost.</span>create
<span class="colork17">Micropost.</span>create!
<span class="colork17">Micropost.</span>new</pre>
<p class="noindent">we have</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg635-02a" id="pg635-02">Click here to view code image</a></p>
<pre class="pre1">user<span class="colork17">.</span>microposts<span class="colork17">.</span>create
user<span class="colork17">.</span>microposts<span class="colork17">.</span>create!
user<span class="colork17">.</span>microposts<span class="colork17">.</span>build</pre>
<p class="noindent">These latter methods constitute the idiomatically correct way to make a micropostnamely, <em>through</em> its association with a user. When a new micropost is made in this <span epub:type="pagebreak" id="page_636"></span>way, its <span class="colork1"><code><strong>user_id</strong></code></span> is automatically set to the right value. In particular, we can replace the code</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg636-01a" id="pg636-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
<span class="colork18"># This code is not idiomatically correct.</span>
<span class="colork8">@micropost =</span> <span class="colork5">Micropost.</span>new(content: <span class="colork5">"Lorem ipsum"</span>, <span class="colork8">user_id: @user.</span>id)</pre>
<p class="noindent">from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex04">Listing 13.4</a> with this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg636-02a" id="pg636-02">Click here to view code image</a></p>
<pre class="pre1"><span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
<span class="colork8">@micropost = @user.</span>microposts.build(<span class="colork8">content</span>: <span class="colork5">"Lorem ipsum"</span>)</pre>
<p class="noindent">(As with <span class="colork1"><code><strong>new</strong></code></span>, <span class="colork1"><code><strong>build</strong></code></span> returns an object in memory but doesnt modify the database.)<sup><a id="ch13fn4a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn4" class="totri-footnote">4</a></sup> Once we define the proper associations, the resulting <span class="colork1"><code><strong>@micropost</strong></code></span> variable will automatically have a <span class="colork1"><code><strong>user_id</strong></code></span> attribute equal to its associated users id.</p>
<p class="footnote"><a id="ch13fn4" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn4a" class="totri-footnote">4</a>. In fact, if you look at the source, youll see that <span class="colork1"><code><strong>build</strong></code></span> is actually just an alias for <span class="colork1"><code><strong>new</strong></code></span>. Thanks to reader Abdullah Budri for pointing this out.</p>
<p class="indent">To get code like <span class="colork1"><code><strong>@user.microposts.build</strong></code></span> to work, we need to update the User and Micropost models with code to associate them. The first part of this code was included automatically by the migration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex03">Listing 13.3</a> via <span class="colork1"><code><strong>belongs_to :user</strong></code></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex010">Listing 13.10</a>. The second half of the association, <span class="colork1"><code><strong>has_many :microposts</strong></code></span>, needs to be added by hand, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex011">Listing 13.11</a>.</p>
<p class="ex-title" id="ch13ex010"><strong>Listing 13.10:</strong> A micropost <span class="colork1"><code><strong>belongs_to</strong></code></span> a user. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-10a" id="lis13-10">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
<span class="mark">  belongs_to <span class="colork8">:user</span></span>
  validates <span class="colork8">:user_id</span>, <span class="colork8">presence</span>: <span class="colork10"><strong>true</strong></span>
  validates <span class="colork8">:content</span>, <span class="colork8">presence</span>: <span class="colork10"><strong>true</strong></span>, <span class="colork8">length</span>: { <span class="colork8">maximum</span>: <span class="colork8">140</span> }
<span class="colork10"><strong>end</strong></span></pre>
</div>
<p class="ex-title" id="ch13ex011"><strong>Listing 13.11:</strong> A user <span class="colork1"><code><strong>has_many</strong></code></span> microposts. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-11a" id="lis13-11">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
<span class="mark">  has_many <span class="colork8">:microposts</span></span>

<span epub:type="pagebreak" id="page_637"></span>  <strong>.</strong>
  <strong>.</strong>
  <strong>.</strong>
<span class="colork10"><strong>end</strong></span></pre>
</div>
<p class="indent">With the association thus made, we can update the <span class="colork1"><code><strong>setup</strong></code></span> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex04">Listing 13.4</a> with the idiomatically correct way to build a new micropost, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex012">Listing 13.12</a>.</p>
<p class="ex-title" id="ch13ex012"><strong>Listing 13.12:</strong> Using idiomatically correct code to build a micropost. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">test/models/micropost_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-12a" id="lis13-12">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork5">require 'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostTest</span></strong> <span class="colork5">&lt; ActiveSupport::TestCase</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
<span class="mark">    <span class="colork8">@micropost = @user.</span>microposts.build(<span class="colork19">content:</span> <span class="colork20">"Lorem ipsum"</span>)</span>
  <strong><span class="colork10">end</span></strong>

  <span class="colork10">test</span> <span class="colork11">"should be valid"</span> <strong><span class="colork10">do</span></strong>
    assert <span class="colork8">@micropost.</span>valid?
  <strong><span class="colork10">end</span></strong>

  <span class="colork10">test</span> <span class="colork11">"user id should be present"</span> <strong><span class="colork10">do</span></strong>
    <span class="colork8">@micropost.</span>user_id = <strong><span class="colork10">nil</span></strong>
    assert_not <span class="colork8">@micropost.</span>valid?
  <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">.</span></strong>
  <strong><span class="colork10">.</span></strong>
  <strong><span class="colork10">.</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Of course, after this minor refactoring the test suite should still be <span class="colork14"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex013"><strong>Listing 13.13:</strong> <span class="colork14"><small>GREEN</small></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-13a" id="lis13-13">Click here to view code image</a></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev149">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_638"></span></p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Set <span class="colork1"><code><strong>user</strong></code></span> to the first user in the database. What happens when you execute the command <span class="colork1"><code><strong>micropost = user.microposts.create(content: "Lorem ipsum")</strong></code></span>?</p></li>
<li><p class="num">The previous exercise should have created a micropost in the database. Confirm this by running <span class="colork1"><code><strong>user.microposts.find(micropost.id)</strong></code></span>. What if you write <span class="colork1"><code><strong>micropost</strong></code></span> instead of <span class="colork1"><code><strong>micropost.id</strong></code></span>?</p></li>
<li><p class="num">What is the value of <span class="colork1"><code><strong>user == micropost.user</strong></code></span>? How about <span class="colork1"><code><strong>user.microposts.first == micropost</strong></code></span>?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_1_4">13.1.4 Micropost Refinements</h4>
<p class="noindent">In this section, well add a couple of refinements to the user/micropost association. In particular, well arrange for a users microposts to be retrieved in a specific <em>order</em>, and well make microposts <em>dependent</em> on users so that they will be automatically destroyed if their associated user is destroyed.</p>
<section>
<h5 class="h5" id="lev150">Default Scope</h5>
<p class="noindent">By default, the <span class="colork1"><code><strong>user.microposts</strong></code></span> method makes no guarantees about the order of the posts, but (following the convention of blogs and Twitter) we want the microposts to come out in reverse order of when they were created so that the most recent post appears first.<sup><a id="ch13fn5a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn5" class="totri-footnote">5</a></sup> Well arrange for this to happen using a <em>default scope</em>.</p>
<p class="footnote"><a id="ch13fn5" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn5a" class="totri-footnote">5</a>. We briefly encountered a similar issue in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_5">Section 10.5</a> in the context of the users index.</p>
<p class="indent">This is exactly the sort of feature that could easily lead to a spurious passing test (i.e., a test that would pass even if the application code were wrong), so well proceed using test-driven development to be sure were testing the right thing. In particular, lets write a test to verify that the first micropost in the database is the same as a fixture micropost well call <span class="colork1"><code><strong>most_recent</strong></code></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex014">Listing 13.14</a>.</p>
<p class="ex-title" id="ch13ex014"><strong>Listing 13.14:</strong> Testing the micropost order. <span class="redk1"><small>RED</small></span></p>
<pre class="pre2">test/models/micropost_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-14a" id="lis13-14">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostTest</span></strong> <span class="colork5">&lt; ActiveSupport::TestCase</span>

<span epub:type="pagebreak" id="page_639"></span>  <strong>.</strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <span class="colork10">test</span> <span class="colork11">"order should be most recent first"</span> <strong><span class="colork10">do</span></strong>
    assert_equal microposts(<span class="colork8">:most_recent</span>), <span class="colork11">Micropost.</span>first
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex014">Listing 13.14</a> relies on having some micropost fixtures, which we can define in analogy with the user fixtures, last seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex05">Listing 11.5</a>. In addition to the <span class="colork1"><code><strong>content</strong></code></span> attribute defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_1">Section 13.1.1</a>, we need to define the associated <span class="colork1"><code><strong>user</strong></code></span>. Conveniently, Rails includes a way to build associations in fixtures, like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg639-01a" id="pg639-01">Click here to view code image</a></p>
<pre class="pre1">orange:
  content: <span class="colork16">"I just ate an orange!"</span>
  created_at: &lt;%= 10.minutes.ago %&gt;
  user: michael</pre>
<p class="noindent">By identifying the <span class="colork1"><code><strong>user</strong></code></span> as <span class="colork1"><code><strong>michael</strong></code></span>, we tell Rails to associate this micropost with the corresponding user in the users fixture:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg639-02a" id="pg639-02">Click here to view code image</a></p>
<pre class="pre1">michael:
  name: Michael Example
  email: michael@example.com
  .
  .
  .</pre>
<p class="indent">The full micropost fixtures appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex015">Listing 13.15</a>.</p>
<p class="ex-title" id="ch13ex015"><strong>Listing 13.15:</strong> Micropost fixtures.</p>
<pre class="pre2">test/fixtures/microposts.yml</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-15a" id="lis13-15">Click here to view code image</a></p>
<div class="example">
<pre>orange:
  content: <span class="colork16">"I just ate an orange!"</span>
  created_at: &lt;%= 10.minutes.ago %&gt;
  user: michael

tau_manifesto:
  content: <span class="colork16">"Check out the @tauday site by @mhartl: https://tauday.com"</span>
  created_at: &lt;%= 3.years.ago %&gt;
  user: michael
<span epub:type="pagebreak" id="page_640"></span>cat_video:
  content: <span class="colork16">"Sad cats are sad: https://youtu.be/PKffm2uI4dk"</span>
  created_at: &lt;%= 2.hours.ago %&gt;
  user: michael

most_recent:
  content: <span class="colork16">"Writing a short test"</span>
  created_at: &lt;%= Time.zone.now %&gt;
  user: michael</pre>
</div>
<p class="noindent">Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex015">Listing 13.15</a> explicitly sets the <span class="colork1"><code><strong>created_at</strong></code></span> column using embedded Ruby. Because its a magic column automatically updated by Rails, setting <span class="colork1"><code><strong>created_at</strong></code></span> by hand isnt ordinarily possible, but it is possible in fixtures.<sup><a id="ch13fn6a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn6" class="totri-footnote">6</a></sup></p>
<p class="footnote"><a id="ch13fn6" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn6a" class="totri-footnote">6</a>. In practice this might not be necessary, and in fact on many systems the fixtures are created in the order in which they appear in the file. In this case, the final fixture in the file is created last (and hence is most recent), but it would be foolish to rely on this behavior, which is brittle and probably system-dependent.</p>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex014">Listing 13.14</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex015">Listing 13.15</a>, the test suite should be <span class="redk1"><small>RED</small></span>:</p>
<p class="ex-title" id="ch13ex016"><strong>Listing 13.16:</strong> <span class="redk1"><small>RED</small></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-16a" id="lis13-16">Click here to view code image</a></p>
<div class="example">
<pre>$ rails test test/models/micropost_test.rb</pre>
</div>
<p class="indent">Well get the test to pass using a Rails method called <span class="colork1"><code><strong>default_scope</strong></code></span>, which among other things can be used to set the default order in which elements are retrieved from the database. To enforce a particular order, well include the <span class="colork1"><code><strong>order</strong></code></span> argument in <span class="colork1"><code><strong>default_scope</strong></code></span>, which lets us order by the <span class="colork1"><code><strong>created_at</strong></code></span> column:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg640-01a" id="pg640-01">Click here to view code image</a></p>
<pre class="pre1">order(<span class="colork8">:created_at</span>)</pre>
<p class="noindent">Unfortunately, this orders the results in <em>ascending</em> order from smallest to biggest, which means that the oldest microposts come out first. To pull them out in reverse order, we can push down one level deeper and include a string with some raw SQL:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg640-02a" id="pg640-02">Click here to view code image</a></p>
<pre class="pre1">order(<span class="colork16">'created_at DESC'</span>)</pre>
<p class="noindent">Here <span class="colork1"><code><strong>DESC</strong></code></span> is SQL for descendingthat is, in descending order from newest to oldest.<sup><a id="ch13fn7a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn7" class="totri-footnote">7</a></sup> In older versions of Rails, using this raw SQL used to be the only option to <span epub:type="pagebreak" id="page_641"></span>get the desired behavior, but as of Rails 4.0 we can use a more natural pure-Ruby syntax as well:</p>
<p class="footnote"><a id="ch13fn7" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn7a" class="totri-footnote">7</a>. SQL is case-insensitive, but the convention is to write SQL keywords (such as <span class="colork1"><code><strong>DESC</strong></code></span>) in all-caps.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg641-01a" id="pg641-01">Click here to view code image</a></p>
<pre class="pre1">order(<span class="colork8">created_at: :desc</span>)</pre>
<p class="noindent">Adding this in a default scope for the Micropost model gives <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex017">Listing 13.17</a>.</p>
<p class="ex-title" id="ch13ex017"><strong>Listing 13.17:</strong> Ordering the microposts with <span class="colork1"><code><strong>default_scope</strong></code></span>. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-17a" id="lis13-17">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:user</span>
<span class="mark">  default_scope -&gt; { order(<span class="colork21">created_at: :desc</span>) }</span>
  validates <span class="colork8">:user_id</span>, <span class="colork8">presence</span>: <strong><span class="colork3">true</span></strong>
  validates <span class="colork8">:content</span>, <span class="colork8">presence:</span> <strong><span class="colork10">true</span></strong>, <span class="colork8">length</span>: { <span class="colork8">maximum</span>: <span class="colork8">140</span> }
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex017">Listing 13.17</a> introduces the stabby lambda syntax for an object called a <em>Proc</em> (procedure) or <em>lambda</em>, which is an <em>anonymous function</em> (a function created without a name). The stabby lambda <span class="colork1"><code><strong>-&gt;</strong></code></span> takes in a block (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_2">Section 4.3.2</a>) and returns a Proc, which can then be evaluated with the <span class="colork1"><code><strong>call</strong></code></span> method. We can see how it works at the console:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg641-02a" id="pg641-02">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork10">&gt;</span></strong>&gt; -&gt; <span class="colork9">{</span> puts <span class="colork11">"foo"</span> <span class="colork9">}</span>
<span class="colork1">=&gt; #&lt;Proc:0x007fab938d0108@(irb):1 (lambda)&gt;</span>
<strong><span class="colork10">&gt;</span></strong>&gt; -&gt; <span class="colork9">{</span> <span class="colork11">puts "foo"</span> <span class="colork9">}</span>.call
<span class="colork9">foo</span>
<span class="colork9">=&gt; nil</span></pre>
<p class="noindent">(This is a somewhat advanced Ruby topic, so dont worry if it doesnt make sense right away.)</p>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex017">Listing 13.17</a>, the tests should be <span class="colork14"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex018"><strong>Listing 13.18:</strong> <span class="colork14"><small>GREEN</small></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-18a" id="lis13-18">Click here to view code image</a></p>
<div class="example">
<pre>$ rails test</pre>
</div>
</section>
<section>
<h5 class="h5" id="lev151">Dependent: Destroy</h5>
<p class="noindent">Apart from proper ordering, there is a second refinement wed like to add to microposts. Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_4">Section 10.4</a> that site administrators have the power to <em>destroy</em> users. <span epub:type="pagebreak" id="page_642"></span>It stands to reason that, if a user is destroyed, the users microposts should be destroyed as well.</p>
<p class="indent">We can arrange for this behavior by passing an option to the <span class="colork1"><code><strong>has_many</strong></code></span> association method, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex019">Listing 13.19</a>.</p>
<p class="ex-title" id="ch13ex019"><strong>Listing 13.19:</strong> Ensuring that a users microposts are destroyed along with the user.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-19a" id="lis13-19">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
<span class="mark">  has_many <span class="colork8">:microposts</span>, <span class="colork8">dependent:</span> <span class="colork8">:destroy</span></span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">Here the option <span class="colork1"><code><strong>dependent: :destroy</strong></code></span> arranges for the dependent microposts to be destroyed when the user itself is destroyed. This prevents userless microposts from being stranded in the database when admins choose to remove users from the system.</p>
<p class="indent">We can verify that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex019">Listing 13.19</a> is working with a test for the User model. All we need to do is save the user (so it gets an id) and create an associated micropost. Then we check that destroying the user reduces the micropost count by 1. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex020">Listing 13.20</a>. (Compare this code to the integration test for delete links in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex062">Listing 10.62</a>.)</p>
<p class="ex-title" id="ch13ex020"><strong>Listing 13.20:</strong> A test of <span class="colork1"><code><strong>dependent: :destroy</strong></code></span>. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">test/models/user_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-20a" id="lis13-20">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">UserTest</span></strong> <span class="colork5">&lt; ActiveSupport::TestCase</span>

  <strong><span class="colork10">def</span></strong> <span class="colork21">setup</span>
    <span class="colork8">@user =</span> <span class="colork5">User.</span>new(<span class="colork5">name</span>: <span class="colork5">"Example User"</span>, <span class="colork8">email:</span> <span class="colork5">"user@example.com"</span>,
                     <span class="colork8">password:</span> <span class="colork5">"foobar"</span>, <span class="colork8">password_confirmation:</span> <span class="colork9">"foobar"</span>)
  <strong><span class="colork10">end</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <span class="colork8">test</span> <span class="colork9">"associated microposts should be destroyed"</span> <strong><span class="colork10">do</span></strong>
    <span class="colork8">@user.</span>save
    <span class="colork8">@user.</span>microposts.create!(<span class="colork8">content:</span> <span class="colork9">"Lorem ipsum"</span>)
    assert_difference <span class="colork9">'Micropost.count'</span>, <span class="colork9">-1</span> <strong><span class="colork10">do</span></strong>
<span epub:type="pagebreak" id="page_643"></span>      <span class="colork8">@user.</span>destroy
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">If the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex019">Listing 13.19</a> is working correctly, the test suite should still be <span class="colork14"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex021"><strong>Listing 13.21:</strong> <span class="colork14"><small>GREEN</small></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-21a" id="lis13-21">Click here to view code image</a></p>
<div class="example">
<pre><code>$ rails test</code></pre>
</div>
</section>
<section>
<h5 class="h5" id="lev152">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">How does the value of <span class="colork1"><code><strong>Micropost.first.created_at</strong></code></span> compare to <span class="colork1"><code><strong>Micropost.last.created_at</strong></code></span>?</p></li>
<li><p class="num">What are the SQL queries for <span class="colork1"><code><strong>Micropost.first</strong></code></span> and <span class="colork1"><code><strong>Micropost.last</strong></code></span>? <em>Hint</em>: They are printed out by the console.</p></li>
<li><p class="num">Let <span class="colork1"><code><strong>user</strong></code></span> be the first user in the database. What is the id of its first micropost? Destroy the first user in the database using the <span class="colork1"><code><strong>destroy</strong></code></span> method, then confirm using <span class="colork1"><code><strong>Micropost.find</strong></code></span> that the users first micropost was also destroyed.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec13_2">13.2 Showing Microposts</h3>
<p class="noindent">Although we dont yet have a way to create microposts through the webthat comes in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_2">Section 13.3.2</a>this wont stop us from displaying them (and testing that display). Following Twitters lead, well plan to display a users microposts not on a separate microposts <span class="colork1"><code><strong>index</strong></code></span> page but rather directly on the user <span class="colork1"><code><strong>show</strong></code></span> page itself, as mocked up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig04">Figure 13.4</a>.<sup><a id="ch13fn8a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn8" class="totri-footnote">8</a></sup> Well start with fairly simple ERb templates for adding a micropost display to the user profile, and then well add microposts to the seed data from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_2">Section 10.3.2</a> so that we have something to display.</p>
<p class="footnote"><a id="ch13fn8" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn8a" class="totri-footnote">8</a>. This and other figures in this chapter: Baby photo was retrieved from <a href="https://www.flickr.com/photos/glasgows/338937124/">https://www.flickr.com/photos/glasgows/338937124/</a> on 2014-08-25. Copyright  2008 by M&amp;R Glasgow and used unaltered under the terms of the CC BY license.<span epub:type="pagebreak" id="page_644"></span></p>
<figure id="ch13fig04" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_04.jpg" alt="Image" width="706" height="636" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_04.jpg">
<figcaption><p><strong>Figure 13.4:</strong> A mockup of a profile page with microposts.</p></figcaption>
</figure>
<section>
<h4 class="h4" id="sec13_2_1">13.2.1 Rendering Microposts</h4>
<p class="noindent">Our plan is to display the microposts for each user on the users profile page (<code><strong>show.html.erb</strong></code>), together with a running count of how many microposts theyve made. As well see, many of the ideas are similar to our work in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3">Section 10.3</a> on showing all users.</p>
<p class="indent">In case youve added some microposts in the exercises, its a good idea to reset and reseed the database at this time:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg644-01a" id="pg644-01">Click here to view code image</a></p>
<pre class="pre1">$ rails db:migrate:reset
$ rails db:seed</pre>
<p class="indent"><span epub:type="pagebreak" id="page_645"></span>Although we wont need the Microposts controller until <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3">Section 13.3</a>, we will need the views directory in just a moment, so lets generate the controller now:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg645-01a" id="pg645-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails generate controller Microposts</pre>
<p class="indent">Our primary purpose in this section is to render all the microposts for each user. We saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_5">Section 10.3.5</a> that the code</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg645-02a" id="pg645-02">Click here to view code image</a></p>
<pre class="pre1">&lt;<strong><span class="colork10">ul</span></strong> <span class="colork5">class</span><span class="colork9">=</span><span class="colork11">"users"</span>&gt;
  <span class="colork9">&lt;%=</span> render @users <span class="colork9">%&gt;</span>
&lt;/<strong><span class="colork10">ul</span></strong>&gt;</pre>
<p class="noindent">automatically renders each of the users in the <span class="colork1"><code><strong>@users</strong></code></span> variable using the <span class="colork1"><code><strong>_user.html.erb</strong></code></span> partial. Well define an analogous <span class="colork1"><code><strong>_micropost.html.erb</strong></code></span> partial so that we can use the same technique on a collection of microposts as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg645-03a" id="pg645-03">Click here to view code image</a></p>
<pre class="pre1">&lt;<strong><span class="colork10">ol</span></strong> <span class="colork5">class</span><span class="colork9">=</span><span class="colork11">"microposts"</span>&gt;
  &lt;<span class="colork9">%=</span> render <span class="colork8">@microposts</span> <span class="colork9">%&gt;</span>
&lt;/<strong><span class="colork10">ol</span></strong>&gt;</pre>
<p class="noindent">Note that weve used the <em>ordered list</em> tag <span class="colork1"><code><strong>ol</strong></code></span> (as opposed to an unordered list <span class="colork1"><code><strong>ul</strong></code></span>) because microposts are listed in a particular order (reverse-chronological). The corresponding partial appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex022">Listing 13.22</a>.</p>
<p class="ex-title" id="ch13ex022"><strong>Listing 13.22:</strong> A partial for showing a single micropost.</p>
<pre class="pre2">app/views/microposts/_micropost.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-22a" id="lis13-22">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<strong><span class="colork10">li</span></strong> <span class="colork9">id="micropost-&lt;%=</span> micropost.id <span class="colork9">%&gt;</span>"&gt;
  <span class="colork9">&lt;%=</span> link_to gravatar_for(micropost.user, size: 50), micropost.user <span class="colork9">%&gt;</span>
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork9">class="user"</span>&gt;<span class="colork9">&lt;%=</span> link_to micropost.user.name, micropost.user <span class="colork9">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork9">class="content"</span>&gt;<span class="colork9">&lt;%=</span> micropost.content <span class="colork9">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork9">class="timestamp"</span>&gt;
    Posted <span class="colork9">&lt;%=</span> time_ago_in_words(micropost.created_at) <span class="colork9">%&gt;</span> ago.
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
&lt;/<strong><span class="colork10">li</span></strong>&gt;</pre>
</div>
<p class="noindent">This uses the awesome <span class="colork1"><code><strong>time_ago_in_words</strong></code></span> helper method, whose meaning is probably clear and whose effect we will see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_2_2">Section 13.2.2</a>. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex022">Listing 13.22</a> also adds a CSS id for each micropost using<span epub:type="pagebreak" id="page_646"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg646-01a" id="pg646-01">Click here to view code image</a></p>
<pre class="pre1">&lt;<strong><span class="colork10">li</span></strong> <span class="colork9">id="micropost-&lt;%=</span> micropost.id <span class="colork9">%&gt;"</span>&gt;</pre>
<p class="noindent">This is a generally good practice, as it opens up the possibility of manipulating individual microposts at a future date (using JavaScript, for example).</p>
<p class="indent">The next step is to address the difficulty of displaying a potentially large number of microposts. Well solve this problem the same way we solved it for users in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_3">Section 10.3.3</a>namely, using pagination. As before, well use the <span class="colork1"><code><strong>will_paginate</strong></code></span> method:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg646-02a" id="pg646-02">Click here to view code image</a></p>
<pre class="pre1"><span class="colork9">&lt;%=</span> will_paginate <span class="colork8">@microposts</span> <span class="colork9">%&gt;</span></pre>
<p class="noindent">If you compare this with the analogous line on the user index page, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex045">Listing 10.45</a>, youll see that before we had just</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg646-03a" id="pg646-03">Click here to view code image</a></p>
<pre class="pre1"><span class="colork9">&lt;%=</span> will_paginate <span class="colork9">%&gt;</span></pre>
<p class="noindent">This worked because, in the context of the Users controller, <span class="colork1"><code><strong>will_paginate</strong></code></span> <em>assumes</em> the existence of an instance variable called <span class="colork1"><code><strong>@users</strong></code></span> (which, as we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_3">Section 10.3.3</a>, should be of class <span class="colork1"><code><strong>ActiveRecord::Relation</strong></code></span>). In the present case, since we are still in the Users controller but want to paginate <em>microposts</em> instead, well pass an explicit <span class="colork1"><code><strong>@microposts</strong></code></span> variable to <span class="colork1"><code><strong>will_paginate</strong></code></span>. Of course, this means that we will have to define such a variable in the user <span class="colork1"><code><strong>show</strong></code></span> action (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex023">Listing 13.23</a>).</p>
<p class="ex-title" id="ch13ex023"><strong>Listing 13.23:</strong> Adding an <span class="colork1"><code><strong>@microposts</strong></code></span> instance variable to the user <span class="colork1"><code><strong>show</strong></code></span> action.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-23a" id="lis13-23">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">UsersController</span></strong> <span class="colork9">&lt; ApplicationController</span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork10">def</span></strong> <span class="colork21">show</span>
    <span class="colork8">@user =</span> <span class="colork9">User.</span>find(params<span class="colork8">[:id]</span>)
<span class="mark">    <span class="colork8">@microposts =</span> @user<span class="colork9">.</span>microposts<span class="colork9">.</span>paginate(<span class="colork8">page:</span> params<span class="colork8">[:page]</span>)</span>
  <strong><span class="colork10">end</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">Notice here how clever <span class="colork1"><code><strong>paginate</strong></code></span> is: It even works <em>through</em> the microposts association, reaching into the <code>microposts</code> table and pulling out the desired page of microposts.<span epub:type="pagebreak" id="page_647"></span></p>
<p class="indent">Our final task is to display the number of microposts for each user, which we can do with the <span class="colork1"><code><strong>count</strong></code></span> method:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg647-01a" id="pg647-01">Click here to view code image</a></p>
<pre class="pre1">user.microposts.count</pre>
<p class="noindent">As with <span class="colork1"><code><strong>paginate</strong></code></span>, we can use the <span class="colork1"><code><strong>count</strong></code></span> method through the association. In particular, <span class="colork1"><code><strong>count</strong></code></span> does <em>not</em> pull all the microposts out of the database and then call <span class="colork1"><code><strong>length</strong></code></span> on the resulting array, as this would become inefficient as the number of microposts grew. Instead, it performs the calculation directly in the database, asking the database to count the microposts with the given <span class="colork1"><code><strong>user_id</strong></code></span> (an operation for which all databases are highly optimized). (In the unlikely event that finding the count is still a bottleneck in your application, you can make it even faster using a <em>counter cache</em>.)</p>
<p class="indent">Putting all the elements together, we are now in a position to add microposts to the profile page, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex024">Listing 13.24</a>. Note the use of <span class="colork1"><code><strong>if @user.microposts.any?</strong></code></span> (a construction we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex021">Listing 7.21</a>), which makes sure that an empty list wont be displayed when the user has no microposts.</p>
<p class="ex-title" id="ch13ex024"><strong>Listing 13.24:</strong> Adding microposts to the user <span class="colork1"><code><strong>show</strong></code></span> page.</p>
<pre class="pre2">app/views/users/show.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-24a" id="lis13-24">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> provide(<span class="colork8">:title</span>, <span class="colork8">@user.</span>name) <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"row"</span>&gt;
  &lt;<strong><span class="colork10">aside</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"col-md-4"</span>&gt;
    &lt;<strong><span class="colork10">section</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"user_info"</span>&gt;
      &lt;<strong><span class="colork10">h1</span></strong>&gt;
        <span class="colork22">&lt;%=</span> gravatar_for <span class="colork8">@user</span> <span class="colork22">%&gt;</span>
        <span class="colork22">&lt;%=</span> <span class="colork8">@user.</span>name <span class="colork22">%&gt;</span>
      &lt;/<strong><span class="colork10">h1</span></strong>&gt;
    &lt;/<strong><span class="colork10">section</span></strong>&gt;
  &lt;/<strong><span class="colork10">aside</span></strong>&gt;
<span class="mark">  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"col-md-8"</span>&gt;</span>
<span class="mark">    <span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> <span class="colork8">@user.</span>microposts.any? <span class="colork22">%&gt;</span></span>
<span class="mark">      &lt;<strong><span class="colork10">h3</span></strong>&gt;Microposts (<span class="colork22">&lt;%=</span> <span class="colork8">@user.</span>microposts.count %&gt;)&lt;/<strong>h3</strong>&gt;</span>
<span class="mark">      &lt;<strong><span class="colork10">ol</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"microposts"</span>&gt;</span>
<span class="mark">        <span class="colork22">&lt;%=</span> render <span class="colork8">@microposts</span> <span class="colork23">%&gt;</span></span>
<span class="mark">      &lt;/<strong><span class="colork10">ol</span></strong>&gt;</span>
<span class="mark">      <span class="colork22">&lt;%=</span> will_paginate @microposts <span class="colork23">%&gt;</span></span>
<span class="mark">    <span class="colork22">&lt;%</span> <strong>end</strong> <span class="colork23">%&gt;</span></span>
<span class="mark">  &lt;/<strong><span class="colork10">div</span></strong>&gt;</span>
&lt;/<strong><span class="colork10">div</span></strong>&gt;</pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_648"></span>At this point, we can get a look at our updated user profile page in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig05">Figure 13.5</a>. Its rather ... disappointing. Of course, we do not currently have any microposts. Its time to change that.</p>
<figure id="ch13fig05" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_05.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_05.jpg">
<figcaption><p><strong>Figure 13.5:</strong> The user profile page with code for micropostsbut no microposts.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev153">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">As mentioned briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_3">Section 7.3.3</a>, helper methods like <span class="colork1"><code><strong>time_ago_in_words</strong></code></span> are available in the Rails console via the <span class="colork1"><code><strong>helper</strong></code></span> object. Using <span class="colork1"><code><strong>helper</strong></code></span>, apply <span class="colork1"><code><strong>time_ago_in_words</strong></code></span> to <span class="colork1"><code><strong>3.weeks.ago</strong></code></span> and <span class="colork1"><code><strong>6.months.ago</strong></code></span>.</p></li>
<li><p class="num">What is the result of <span class="colork1"><code><strong>helper.time_ago_in_words(1.year.ago)</strong></code></span>?<span epub:type="pagebreak" id="page_649"></span></p></li>
<li><p class="num">What is the Ruby class for a page of microposts? <em>Hint</em>: Use the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex023">Listing 13.23</a> as your model, and call the <span class="colork1"><code><strong>class</strong></code></span> method on <span class="colork1"><code><strong>paginate</strong></code></span> with the argument <span class="colork1"><code><strong>page: nil</strong></code></span>.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_2_2">13.2.2 Sample Microposts</h4>
<p class="noindent">With all the work making templates for user microposts in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_2_1">Section 13.2.1</a>, the ending was rather anticlimactic. We can rectify this sad situation by adding microposts to the seed data from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_2">Section 10.3.2</a>.</p>
<p class="indent">Adding sample microposts for <em>all</em> the users actually takes a rather long time, so for now well select just the first six users (i.e., the five users with custom Gravatars, and one with the default Gravatar) using the <span class="colork1"><code><strong>take</strong></code></span> method:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg649-01a" id="pg649-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork5">User.</span>order(<span class="colork8">:created_at</span>).take(<span class="colork8">6</span>)</pre>
<p class="noindent">The call to <span class="colork1"><code><strong>order</strong></code></span> ensures that we find the first six users that were created.</p>
<p class="indent">For each of the selected users, well make 50 microposts (plenty to overflow the pagination limit of 30). To generate sample content for each micropost, well use the Faker gems handy <code>Lorem.sentence</code> method.<sup><a id="ch13fn9a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn9" class="totri-footnote">9</a></sup> The result is the new seed data method shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex025">Listing 13.25</a>. (The reason for the order of the loops in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex025">Listing 13.25</a> is to intermix the microposts for use in the status feed (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_3">Section 14.3</a>). Looping over the users first gives feeds with big runs of microposts from the same user, which is visually unappealing.)</p>
<p class="footnote"><a id="ch13fn9" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn9a">9.</a> <span class="colork1"><code><strong>Faker::Lorem.sentence</strong></code></span> returns <em>lorem ipsum</em> text; as noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">Chapter 6</a>, <em>lorem ipsum</em> has a fascinating back story, see <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean</a>.</p>
<p class="ex-title" id="ch13ex025"><strong>Listing 13.25:</strong> Adding microposts to the sample data.</p>
<pre class="pre2">db/seeds.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-25a" id="lis13-25">Click here to view code image</a></p>
<div class="example">
<pre> <strong><span class="colork9">.</span></strong>
 <strong><span class="colork9">.</span></strong>
 <strong><span class="colork9">.</span></strong>
 <span class="colork18"># Generate microposts for a subset of users.</span>
 users = <span class="colork5">User.</span>order(<span class="colork8">:created_at</span>).take(<span class="colork8">6</span>)
 <span class="colork8">50</span>.times <strong><span class="colork10">do</span></strong>
   content <span class="colork8">=</span> <span class="colork5">Faker::Lorem.</span>sentence(<span class="colork8">word_count</span>: <span class="colork8">5</span>)
   users<span class="colork9">.</span>each { <span class="colork5">|</span>user<span class="colork5">|</span> user<span class="colork9">.</span>microposts<span class="colork9">.</span>create!(content: content) }
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_650"></span>At this point, we can reseed the development database as usual:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg650-01a" id="pg650-01">Click here to view code image</a></p>
<pre class="pre1">$ rails db:migrate:reset
$ rails db:seed</pre>
<p class="noindent">You should also quit and restart the Rails development server.</p>
<p class="indent">With that, we are in a position to enjoy the fruits of our <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_2_1">Section 13.2.1</a> labors by displaying information for each micropost.<sup><a id="ch13fn10a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn10">10</a></sup> The preliminary results appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig06">Figure 13.6</a>.</p>
<p class="footnote"><a id="ch13fn10" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn10a">10</a>. By design, the Faker gems <em>lorem ipsum</em> text is randomized, so the contents of your sample microposts will differ.</p>
<figure id="ch13fig06" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_06.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_06.jpg">
<figcaption><p><strong>Figure 13.6:</strong> The user profile with unstyled microposts.</p></figcaption>
</figure>
<p class="indent"><span epub:type="pagebreak" id="page_651"></span>The page shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig06">Figure 13.6</a> has no micropost-specific styling, so lets add some (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex026">Listing 13.26</a>) and take a look at the resulting pages.<sup><a id="ch13fn11a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn11">11</a></sup></p>
<p class="footnote"><a id="ch13fn11" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn11a">11</a>. For convenience, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex026">Listing 13.26</a> actually has <em>all</em> the CSS needed for this chapter.</p>
<p class="ex-title" id="ch13ex026"><strong>Listing 13.26:</strong> The CSS for microposts (including all the CSS for this chapter).</p>
<pre class="pre2">app/assets/stylesheets/custom.scss</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-26a" id="lis13-26">Click here to view code image</a></p>
<div class="example">
<pre> <strong><span class="colork9">.</span></strong>
 <strong><span class="colork9">.</span></strong>
 <strong><span class="colork9">.</span></strong>
 /* <strong><span class="colork10">microposts</span></strong> */

<strong><span class="colork4">.microposts</span></strong> {
  <strong><span class="colork10">list-style</span></strong><span class="colork10">:</span> <strong><span class="colork10">none</span></strong><span class="colork10">;</span>
  <strong><span class="colork10">padding</span></strong><span class="colork10">:</span> <strong><span class="colork10">0</span></strong><span class="colork10">;</span>
  <span class="colork10"><strong>li</strong></span> {
    <span class="colork10"><strong>padding</strong>: <strong>10px 0</strong>;</span>
    <strong><span class="colork10">border-top</span></strong><span class="colork10">:</span> <strong><span class="colork10">1px solid</span> <span class="colork4">#e8e8e8</span></strong><span class="colork4">;</span>
}
<strong><span class="colork4">.user</span></strong> {
  <strong><span class="colork10">margin-top</span></strong><span class="colork10">:</span> <strong><span class="colork10">5em</span></strong><span class="colork10">;</span>
  <span class="colork10"><strong>padding-top</strong>: <strong>0</strong>;</span>
}
<strong><span class="colork4">.content</span></strong> {
  <span class="colork10"><strong>display</strong>: <strong>block</strong>;</span>
  <span class="colork10"><strong>margin-left</strong>: <strong>60px</strong>;</span>
  <strong><span class="colork10">img</span></strong> {
    <span class="colork10"><strong>display</strong>: <strong>block</strong>;</span>
    <span class="colork10"><strong>padding</strong>: <strong>5px 0</strong>;</span>

  }

}
<strong><span class="colork4">.timestamp</span></strong> {
  <strong><span class="colork10">color</span></strong><span class="colork10">:</span> $<strong><span class="colork10">gray-light</span></strong>;
  <strong><span class="colork10">display</span></strong><span class="colork10">:</span> <strong><span class="colork10">block</span></strong><span class="colork10">;</span>
  <span class="colork10"><strong>margin-left</strong>: <strong>60px</strong>;</span>
}
<strong><span class="colork4">.gravatar</span></strong> {
  <span class="colork10"><strong>float</strong>: <strong>left</strong>;</span>
  <span class="colork10"><strong>margin-right</strong>: <strong>10px</strong>;</span>
  <span class="colork10"><strong>margin-top</strong>: <strong>5px</strong>;</span>
 }
}
<span class="colork10"><strong>aside</strong></span> {
  <strong><span class="colork10">textarea</span></strong> {
<span epub:type="pagebreak" id="page_652"></span>  <strong><span class="colork10">height</span></strong><span class="colork10">:</span> <strong><span class="colork10">100px</span></strong><span class="colork10">;</span>
  <span class="colork10"><strong>margin-bottom</strong>: <strong>5px</strong>;</span>
 }

}

<strong><span class="colork10">span</span><span class="colork4">.image</span></strong> {
  <span class="colork10"><strong>margin-top</strong>: <strong>10px</strong>;</span>
  <strong><span class="colork10">input</span></strong> {
    <span class="colork10"><strong>border</strong>: <strong>0</strong>;</span>
 }
}</pre>
</div>
<p class="noindent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig07">Figure 13.7</a> shows the user profile page for the first user, while <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig08">Figure 13.8</a> shows the profile for a second user. Finally, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig09">Figure 13.9</a> shows the <em>second</em> page of microposts for the first user, along with the pagination links at the bottom of the display. In all three cases, observe that each micropost display indicates the time since it was created <span epub:type="pagebreak" id="page_653"></span>(e.g., Posted 1 minute ago.); this is the work of the <span class="colork1"><code><strong>time_ago_in_words</strong></code></span> method from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex022">Listing 13.22</a>. If you wait a couple of minutes and reload the pages, youll see how the text gets automatically updated based on the new time.</p>
<figure id="ch13fig07" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_07.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_07.jpg">
<figcaption><p><strong>Figure 13.7:</strong> The user profile with microposts (/users/1).</p></figcaption>
</figure>
<figure id="ch13fig08" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_08.jpg" alt="Image" width="748" height="578" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_08.jpg">
<figcaption><p><strong>Figure 13.8:</strong> The profile of a different user, also with microposts (/users/5).</p></figcaption>
</figure>
<figure id="ch13fig09" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_09.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_09.jpg">
<figcaption><p><strong>Figure 13.9:</strong> Micropost pagination links (/users/1?page=2).</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev154">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">See if you can guess the result of running <span class="colork1"><code><strong>(1..10).to_a.take(6)</strong></code></span>. Check at the console to see if your guess is right.</p></li>
<li><p class="num">Is the <span class="colork1"><code><strong>to_a</strong></code></span> method in the previous exercise necessary?<span epub:type="pagebreak" id="page_654"></span></p></li>
<li><p class="num">Faker has a huge number of occasionally amusing applications. By consulting the Faker documentation (<a href="http://github.com/stympy/faker">github.com/stympy/faker</a>), learn how to print out a fake university name, a fake phone number, a fake Hipster Ipsum sentence, and a fake Chuck Norris fact.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_2_3">13.2.3 Profile Micropost Tests</h4>
<p class="noindent">Because newly activated users get redirected to their profile pages, we already have a test that the profile page renders correctly (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex033">Listing 11.33</a>). In this section, well write a short integration test for some of the other elements on the profile page, including the work from this section. Well start by generating an integration test for the profiles of our sites users:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg654-01a" id="pg654-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails generate integration_test users_profile
      <span class="colork1">invoke  test_unit</span>
      <span class="colork1">create    test/integration/users_profile_test.rb</span></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_655"></span>To test micropost pagination, well also generate some additional micropost fixtures using the same embedded Ruby technique we used to make additional users in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex047">Listing 10.47</a>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg655-01a" id="pg655-01">Click here to view code image</a></p>
<pre class="pre1">&lt;% 30.times do |n| <span class="colork22">%&gt;</span>
micropost_<span class="colork22">&lt;%=</span> n %&gt;:
  content: <span class="colork22">&lt;%=</span> Faker::Lorem.sentence(5) <span class="colork22">%&gt;</span>
  created_at: <span class="colork22">&lt;%=</span> 42.days.ago <span class="colork22">%&gt;</span>
  user: michael
&lt;% end <span class="colork9">%&gt;</span></pre>
<p class="noindent">Adding this to the code from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex015">Listing 13.15</a> gives the updated micropost fixtures in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex027">Listing 13.27</a>.</p>
<p class="ex-title" id="ch13ex027"><strong>Listing 13.27:</strong> Micropost fixtures with generated microposts.</p>
<pre class="pre2">test/fixtures/microposts.yml</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-27a" id="lis13-27">Click here to view code image</a></p>
<div class="example">
<pre>orange:
  content: <span class="colork16">"I just ate an orange!"</span>
  created_at: &lt;%= 10.minutes.ago %&gt;
  user: michael

tau_manifesto:
  content: <span class="colork16">"Check out the @tauday site by @mhartl: https://tauday.com"</span>
  created_at: &lt;%= 3.years.ago %&gt;
  user: michael

cat_video:
  content: <span class="colork16">"Sad cats are sad: https://youtu.be/PKffm2uI4dk"</span>
  created_at: &lt;%= 2.hours.ago %&gt;
  user: michael

most_recent:
  content: <span class="colork16">"Writing a short test"</span>
  created_at: &lt;%= Time.zone.now %&gt;
  user: michael

<span class="mark">&lt;% 30.times do |n| <span class="colork23">%&gt;</span></span>
<span class="mark">micropost_<span class="colork22">&lt;%=</span> n %&gt;:</span>
<span class="mark">  content: <span class="colork22">&lt;%=</span> Faker::Lorem.sentence(word_count: 5) <span class="colork23">%&gt;</span></span>
<span class="mark">  created_at: <span class="colork22">&lt;%=</span> 42.days.ago <span class="colork23">%&gt;</span></span>
<span class="mark">  user: michael</span>
<span class="mark">&lt;% end %&gt;</span></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_656"></span>With the test data thus prepared, the test itself is fairly straightforward: We visit the user profile page and check for the page title and the users name, Gravatar, micropost count, and paginated microposts. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex028">Listing 13.28</a>. Note the use of the <span class="colork1"><code><strong>full_title</strong></code></span> helper from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04ex02">Listing 4.2</a> to test the pages title, which we gain access to by including the Application Helper module into the test.<sup><a id="ch13fn12a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn12">12</a></sup></p>
<p class="footnote"><a id="ch13fn12" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn12a">12</a>. If youd like to refactor other tests to use <span class="colork1"><code><strong>full_title</strong></code></span> (such as those in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03ex032">Listing 3.32</a>), you should include the Application Helper in <span class="colork1"><code><strong>test_helper.rb</strong></code></span> instead.</p>
<p class="ex-title" id="ch13ex028"><strong>Listing 13.28:</strong> A test for the user profile. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/users_profile_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-28a" id="lis13-28">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">UsersProfileTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>
<span class="mark">  <strong><span class="redk1">include</span></strong> <span class="redk1">ApplicationHelper</span></span>

  <strong><span class="colork10">def</span></strong> <span class="colork8">setup</span>
    <span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
  <strong><span class="colork10">end</span></strong>

  <span class="colork8">test</span> <span class="colork11">"profile display"</span> <strong><span class="colork10">do</span></strong>
    get user_path(<span class="colork8">@user</span>)
    assert_template <span class="colork11">'users/show'</span>
    assert_select <span class="colork11">'title'</span>, full_title(<span class="colork8">@user.</span>name)
    assert_select <span class="colork11">'h1'</span>, <span class="colork8">text:</span> <span class="colork8">@user.</span>name
    assert_select <span class="colork11">'h1&gt;img.gravatar'</span>
    assert_match <span class="colork8">@user.</span>microposts<span class="colork9">.</span>count<span class="colork9">.</span>to_s, response.body
    assert_select <span class="colork11">'div.pagination'</span>
    <span class="colork8">@user.</span>microposts.paginate(<span class="colork8">page</span>: <span class="colork8">1</span>).each <strong><span class="colork10">do</span></strong> |micropost|
      assert_match micropost.content, response.body
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">The micropost count assertion in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex028">Listing 13.28</a> uses <span class="colork1"><code><strong>response.body</strong></code></span>, which we saw briefly in the <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a> exercises (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#sec12_3_3">Section 12.3.3</a>). Despite its name, <span class="colork1"><code><strong>response.body</strong></code></span> contains the full HTML source of the pageand not just the pages body. So, if all we care about is that the number of microposts appears <em>somewhere</em> on the page, we can look for a match as follows:<span epub:type="pagebreak" id="page_657"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg657-01a" id="pg657-01">Click here to view code image</a></p>
<pre class="pre1">assert_match <span class="colork8">@user.</span>microposts<span class="colork9">.</span>count<span class="colork9">.</span>to_s, response.body</pre>
<p class="noindent">This is a much less specific assertion than <span class="colork1"><code><strong>assert_select</strong></code></span>; in particular, unlike <span class="colork1"><code><strong>assert_select</strong></code></span>, using <span class="colork1"><code><strong>assert_match</strong></code></span> in this context doesnt require us to indicate which HTML tag were looking for.</p>
<p class="indent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex028">Listing 13.28</a> also introduces the nesting syntax for <span class="colork1"><code><strong>assert_select</strong></code></span>:</p>
<pre class="pre1">assert_select <span class="colork11">'h1&gt;img.gravatar'</span></pre>
<p class="noindent">This checks for an <span class="colork1"><code><strong>img</strong></code></span> tag with class <span class="colork1"><code><strong>gravatar</strong></code></span> <em>inside</em> a top-level heading tag (<code><strong>h1</strong></code>).</p>
<p class="indent">Because the application code was working, the test suite should be <span class="colork14"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex029"><strong>Listing 13.29:</strong> <span class="colork14"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev155">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Comment out the application code needed to change the two <span class="colork1"><code><strong>'h1'</strong></code></span> lines in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex028">Listing 13.28</a> from <span class="colork14"><small>GREEN</small></span> to <span class="redk1"><small>RED</small></span>.</p></li>
<li><p class="num">Update <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex028">Listing 13.28</a> to test that <span class="colork1"><code><strong>will_paginate</strong></code></span> appears only <em>once</em>. <em>Hint</em>: Refer to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05tab02">Table 5.2</a>.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec13_3">13.3 Manipulating Microposts</h3>
<p class="noindent">Having finished both the data modeling and display templates for microposts, we now turn our attention to the interface for creating them through the web. In this section, well also see the first hint of a <em>status feed</em>a notion brought to full fruition in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">Chapter 14</a>. Finally, as with users, well make it possible to destroy microposts through the web.</p>
<p class="indent">There is one break with past convention worth noting: The interface to the Microposts resource will run principally through the Profile and Home pages, so we <span epub:type="pagebreak" id="page_658"></span>wont need actions like <span class="colork1"><code><strong>new</strong></code></span> or <span class="colork1"><code><strong>edit</strong></code></span> in the Microposts controller; well need only <span class="colork1"><code><strong>create</strong></code></span> and <span class="colork1"><code><strong>destroy</strong></code></span>. This leads to the routes for the Microposts resource shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex030">Listing 13.30</a>. The code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex030">Listing 13.30</a> leads in turn to the RESTful routes shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13tab02">Table 13.2</a>, which is a small subset of the full set of routes seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02tab03">Table 2.3</a>. Of course, this simplicity is a sign of being <em>more</em> advanced, not less: Weve come a long way since our reliance on scaffolding in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">Chapter 2</a>, and we no longer need most of its complexity.</p>
<figure id="ch13tab02">
<figcaption><p><strong>Table 13.2:</strong> RESTful routes provided by the Microposts resource in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex030">Listing 13.30</a>.</p></figcaption>
<table class="topbot">
<thead>
<tr>
<th class="tab-th"><p class="tab-para"><strong>HTTP request</strong></p></th>
<th class="tab-th"><p class="tab-para"><strong>URL</strong></p></th>
<th class="tab-th"><p class="tab-para"><strong>Action</strong></p></th>
<th class="tab-th"><p class="tab-para"><strong>Named route</strong></p></th></tr>
</thead>
<tbody>
<tr>
<td><p class="tab-para"><code>POST</code></p></td>
<td><p class="tab-para">/microposts</p></td>
<td><p class="tab-para"><code><strong><span class="colork1">create</span></strong></code></p></td>
<td><p class="tab-para"><strong><code><span class="colork1">microposts_path</span></code></strong></p></td></tr>
<tr>
<td><p class="tab-para"><code>DELETE</code></p></td>
<td><p class="tab-para">/microposts/1</p></td>
<td><p class="tab-para"><code><strong><span class="colork1">destroy</span></strong></code></p></td>
<td><p class="tab-para"><code><strong><span class="colork1">micropost_path(micropost)</span></strong></code></p></td>
</tr>
</tbody>
</table>
</figure>
<p class="ex-title" id="ch13ex030"><strong>Listing 13.30:</strong> Routes for the Microposts resource.</p>
<pre class="pre2">config/routes.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-30a" id="lis13-30">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork11">Rails.</span>application<span class="colork9">.</span>routes<span class="colork9">.</span>draw <strong><span class="colork10">do</span></strong>
  root   <span class="colork11">'static_pages#home'</span>
  get    <span class="colork11">'/help'</span>,    <span class="colork8">to</span>: <span class="colork11">'static_pages#help'</span>
  get    <span class="colork11">'/about'</span>,   <span class="colork8">to</span>: <span class="colork11">'static_pages#about'</span>
  get    <span class="colork11">'/contact'</span>, <span class="colork8">to</span>: <span class="colork11">'static_pages#contact'</span>
  get    <span class="colork11">'/signup'</span>,  <span class="colork8">to</span>: <span class="colork11">'users#new'</span>
  get    <span class="colork11">'/login'</span>,   <span class="colork8">to</span>: <span class="colork11">'sessions#new'</span>
  post   <span class="colork11">'/login'</span>,   <span class="colork8">to</span>: <span class="colork11">'sessions#create'</span>
  delete <span class="colork11">'/logout'</span>,  <span class="colork8">to</span>: <span class="colork11">'sessions#destroy'</span>
  resources <span class="colork8">:users</span>
  resources <span class="colork8">:account_activations</span>,    <span class="colork8">only</span>: <span class="colork8">[:edit]</span>
  resources <span class="colork8">:password_resets</span>,        <span class="colork8">only</span>: <span class="colork8">[:new, :create, :edit, :update]</span>
<span class="mark">  resources :microposts,             only: [:create, :destroy]</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<section>
<h4 class="h4" id="sec13_3_1">13.3.1 Micropost Access Control</h4>
<p class="noindent">We begin our development of the Microposts resource with some access control in the Microposts controller. In particular, because we access microposts through their associated users, both the <span class="colork1"><code><strong>create</strong></code></span> and <span class="colork1"><code><strong>destroy</strong></code></span> actions must require users to be logged in.<span epub:type="pagebreak" id="page_659"></span></p>
<p class="indent">Tests to enforce logged-in status mirror those for the Users controller (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex020">Listing 10.20</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex061">Listing 10.61</a>). We simply issue the correct request to each action and confirm that the micropost count is unchanged and the result is redirected to the login URL, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex031">Listing 13.31</a>.</p>
<p class="ex-title" id="ch13ex031"><strong>Listing 13.31:</strong> Authorization tests for the Microposts controller. <span class="redk1"><small>RED</small></span></p>
<pre class="pre2">test/controllers/microposts_controller_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-31a" id="lis13-31">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostsControllerTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@micropost</span> = microposts(<span class="colork8">:orange</span>)
  <strong><span class="colork10">end</span></strong>

  <span class="colork11">test "should redirect create when not logged in"</span> <strong><span class="colork10">do</span></strong>
    assert_no_difference <span class="colork11">'Micropost.count'</span> <strong><span class="colork10">do</span></strong>
      post microposts_path, <span class="colork8">params</span>: { <span class="colork8">micropost</span>: { <span class="colork8">content</span>: <span class="colork23">"Lorem ipsum"</span> } }
    <strong><span class="colork10">end</span></strong>
    assert_redirected_to login_url
  <strong><span class="colork10">end</span></strong>

  <span class="colork8">test</span> <span class="colork11">"should redirect destroy when not logged in"</span> <strong><span class="colork10">do</span></strong>
    assert_no_difference <span class="colork11">'Micropost.count'</span> <strong><span class="colork10">do</span></strong>
      delete micropost_path(<span class="colork8">@micropost</span>)
    <strong><span class="colork10">end</span></strong>
    assert_redirected_to login_url
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Writing the application code needed to get the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex031">Listing 13.31</a> to pass requires a little refactoring first. Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_1">Section 10.2.1</a> that we enforced the login requirement using a before filter that called the <span class="colork1"><code><strong>logged_in_user</strong></code></span> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex015">Listing 10.15</a>). At the time, we needed that method only in the Users controller, but now we find that we need it in the Microposts controller as well, so well move it into the Application controller, which is the base class of all controllers (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_4">Section 4.4.4</a>).<sup><a id="ch13fn13a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn13">13</a></sup> The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex032">Listing 13.32</a>.</p>
<p class="footnote"><a id="ch13fn13" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn13a">13</a>. Unlike the behavior in languages like Java or C++, private methods in Ruby can be called from derived classes. Thanks to reader Vishal Antony for bringing this difference to my attention.<span epub:type="pagebreak" id="page_660"></span></p>
<p class="ex-title" id="ch13ex032"><strong>Listing 13.32:</strong> Moving the <span class="colork1"><code><strong>logged_in_user</strong></code></span> method into the Application controller. <span class="redk1"><small>RED</small></span></p>
<pre class="pre2">app/controllers/application_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-32a" id="lis13-32">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">ApplicationController</span></strong> <span class="colork11">&lt; ActionController::Base</span>
  <strong><span class="colork10">include</span></strong> <span class="colork11">SessionsHelper</span>

  <strong><span class="colork10">private</span></strong>

    <span class="colork8"># Confirms a logged-in user.</span>
    <strong><span class="colork10">def</span></strong> <span class="colork4">logged_in_user</span>
      <strong><span class="colork10">unless</span></strong> logged_in?
        store_location
        flash<span class="colork8">[:danger] =</span> <span class="colork11">"Please log in."</span>
        redirect_to login_url
      <strong><span class="colork10">end</span></strong>
    <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">To avoid code repetition, you should also remove <span class="colork1"><code><strong>logged_in_user</strong></code></span> from the Users controller at this time (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex033">Listing 13.33</a>).</p>
<p class="ex-title" id="ch13ex033"><strong>Listing 13.33:</strong> The Users controller with the logged-in user filter removed. <span class="redk1"><small>RED</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-33a" id="lis13-33">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">UsersController</span></strong> <span class="colork9">&lt; ApplicationController</span>
  before_action <span class="colork8">:logged_in_user, only</span>: <span class="colork8">[:index, :edit, :update, :destroy]</span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork10">private</span></strong>

    <strong><span class="colork10">def</span></strong> <span class="colork4">user_params</span>
      params.require(<span class="colork8">:user</span>)<span class="colork9">.</span>permit(<span class="colork8">:name</span>, <span class="colork8">:email</span>, <span class="colork8">:password,</span>
                                  <span class="colork8">:password_confirmation</span>)
    <strong><span class="colork10">end</span></strong>

    <span class="colork8"># Before filters</span>

    <span class="colork8"># Confirms the correct user.</span>
    <strong><span class="colork10">def</span></strong> <span class="colork4">correct_user</span>
      <span class="colork8">@user =</span> <span class="colork11">User.</span>find(params<span class="colork8">[:id]</span>)
      redirect_to(root_url) <strong><span class="colork10">unless</span></strong> current_user?(<span class="colork8">@user</span>)
    <strong><span class="colork10">end</span></strong>
<span epub:type="pagebreak" id="page_661"></span>    <span class="colork8"># Confirms an admin user.</span>
    <strong><span class="colork10">def</span></strong> <span class="colork4">admin_user</span>
       redirect_to(root_url) <strong><span class="colork10">unless</span></strong> current_user<span class="colork9">.</span>admin?
    <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex032">Listing 13.32</a>, the <span class="colork1"><code><strong>logged_in_user</strong></code></span> method is now available in the Microposts controller, which means that we can add <span class="colork1"><code><strong>create</strong></code></span> and <span class="colork1"><code><strong>destroy</strong></code></span> actions and then restrict access to them using a before filter, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex034">Listing 13.34</a>.</p>
<p class="ex-title" id="ch13ex034"><strong>Listing 13.34:</strong> Adding authorization to the Microposts controller actions. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">app/controllers/microposts_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-34a" id="lis13-34">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">MicropostsController</span></strong> <span class="colork11">&lt; ApplicationController</span>
  before_action <span class="colork8">:logged_in_user</span>, <span class="colork8">only</span>: <span class="colork8">[:create, :destroy]</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">create</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">destroy</span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">At this point, the tests should pass:</p>
<p class="ex-title" id="ch13ex035"><strong>Listing 13.35:</strong> <span class="colork14"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev156">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Why is it a bad idea to leave a copy of <span class="colork1"><code><strong>logged_in_user</strong></code></span> in the Users controller?<span epub:type="pagebreak" id="page_662"></span></p></li>
</ol>
</section>
</section>
<section>
<h4 class="h4" id="sec13_3_2">13.3.2 Creating Microposts</h4>
<p class="noindent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>, we implemented user signup by making an HTML form that issued an HTTP <code>POST</code> request to the <span class="colork1"><code><strong>create</strong></code></span> action in the Users controller. The implementation of micropost creation is similar; the main difference is that, rather than using a separate page at /microposts/new, we will put the form on the Home page itself (i.e., the root path /), as mocked up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig010">Figure 13.10</a>.</p>
<figure id="ch13fig010" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_10.jpg" alt="Image" width="714" height="593" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_10.jpg">
<figcaption><p><strong>Figure 13.10:</strong> A mockup of the Home page with a form for creating microposts.</p></figcaption>
</figure>
<p class="indent">When we last left the Home page, it appeared as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05fig08">Figure 5.8</a>that is, it had a Sign up now! button in the middle. Since a micropost creation form makes sense only in the context of a particular logged-in user, one goal of this section will be to serve different versions of the Home page depending on a visitors login status. Well implement this in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex037">Listing 13.37</a> later in this section.<span epub:type="pagebreak" id="page_663"></span></p>
<p class="indent">Well start with the <span class="colork1"><code><strong>create</strong></code></span> action for microposts, which is similar to its user analogue (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex026">Listing 7.26</a>); the principal difference lies in the use of the user/micropost association to <span class="colork1"><code><strong>build</strong></code></span> the new micropost, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex036">Listing 13.36</a>. Note the use of strong parameters via <span class="colork1"><code><strong>micropost_params</strong></code></span>, which permits only the microposts <span class="colork1"><code><strong>content</strong></code></span> attribute to be modified through the web.</p>
<p class="ex-title" id="ch13ex036"><strong>Listing 13.36:</strong> The Microposts controller <span class="colork1"><code><strong>create</strong></code></span> action.</p>
<pre class="pre2">app/controllers/microposts_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-36a" id="lis13-36">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">MicropostsController</span></strong> <span class="colork11">&lt; ApplicationController</span>
  before_action <span class="colork8">:logged_in_user</span>, <span class="colork8">only</span>: <span class="colork8">[:create</span>, <span class="colork8">:destroy]</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">create</span>
    <span class="colork8">@micropost =</span> current_user<span class="colork9">.</span>microposts<span class="colork9">.</span>build(micropost_params)
    <strong><span class="colork10">if</span></strong> <span class="colork8">@micropost.</span>save
      flash<span class="colork8">[:success] =</span> <span class="colork11">"Micropost created!"</span>
      redirect_to root_url
    <strong><span class="colork10">else</span></strong>
      render <span class="colork11">'static_pages/home'</span>
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">destroy</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">private</span></strong>

    <strong><span class="colork10">def</span></strong> <span class="colork4">micropost_params</span>
      params.require(<span class="colork8">:micropost</span>)<span class="colork9">.</span>permit(<span class="colork8">:content</span>)
    <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">To build a form for creating microposts, we use the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex037">Listing 13.37</a>, which serves up different HTML based on whether the site visitor is logged in or not.</p>
<p class="ex-title" id="ch13ex037"><strong>Listing 13.37:</strong> Adding microposts creation to the Home page (/).</p>
<pre class="pre2">app/views/static_pages/home.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-37a" id="lis13-37">Click here to view code image</a></p>
<div class="example">
<pre><span class="mark"><span class="colork24">&lt;%</span> <strong><span class="colork15">if</span></strong> logged_in? <span class="colork23">%&gt;</span></span>
<span class="mark">  &lt;<strong><span class="colork15">div</span></strong> <span class="colork22">class=</span><span class="colork23">"row"</span>&gt;</span>
<span class="mark">    &lt;<strong><span class="colork15">aside</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-4"</span>&gt;</span>
<span class="mark">      &lt;<strong><span class="colork15">section</span></strong> <span class="colork22">class=</span><span class="colork23">"user_info"</span>&gt;</span>
<span epub:type="pagebreak" id="page_664"></span><span class="mark">        <span class="colork22">&lt;%=</span> render <span class="colork23">'shared/user_info'</span> <span class="colork23">%&gt;</span></span>
<span class="mark">      &lt;/<strong><span class="colork15">section</span></strong>&gt;</span>
<span class="mark">      &lt;<strong><span class="colork15">section</span></strong> <span class="colork22">class=</span><span class="colork23">"micropost_form"</span>&gt;</span>
<span class="mark">        <span class="colork22">&lt;%=</span> render <span class="colork23">'shared/micropost_form'</span> <span class="colork23">%&gt;</span></span>
<span class="mark">      &lt;/<strong><span class="colork15">section</span></strong>&gt;</span>
<span class="mark">    &lt;/<strong><span class="colork15">aside</span></strong>&gt;</span>
<span class="mark">  &lt;/<strong><span class="colork15">div</span></strong>&gt;</span>
<span class="mark"><span class="colork24">&lt;%</span> <strong><span class="colork15">else</span></strong> <span class="colork23">%&gt;</span></span>
  &lt;<strong><span class="colork15">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"center jumbotron"</span>&gt;
    &lt;<strong><span class="colork15">h1</span></strong>&gt;Welcome to the Sample App&lt;/<strong><span class="colork15">h1</span></strong>&gt;

    &lt;<strong><span class="colork15">h2</span></strong>&gt;
      This is the home page for the
      &lt;<strong><span class="colork15">a</span></strong> <span class="colork22">href="https://www.railstutorial.org/"</span>&gt;Ruby on Rails Tutorial&lt;/<strong>a</strong>&gt;
      sample application.
    &lt;/<strong><span class="colork15">h2</span></strong>&gt;

    <span class="colork22">&lt;%=</span> link_to <span class="colork23">"Sign up now!"</span>, signup_path, class: <span class="colork23">"btn btn-lg btn-primary"</span> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork15">div</span></strong>&gt;

  <span class="colork22">&lt;%=</span> link_to image_tag(<span class="colork23">"rails.svg"</span>, alt: <span class="colork23">"Rails logo"</span>, width: <span class="colork23">"200"</span>),
                        <span class="colork23">"https://rubyonrails.org/"</span> <span class="colork22">%&gt;</span>
<span class="mark">&lt;% <strong><span class="colork15">end</span></strong> <span class="colork22">%&gt;</span></span></pre>
</div>
<p class="noindent">(Having so much code in each branch of the <span class="colork1"><code><strong>if</strong></code></span>-<code><strong>else</strong></code> conditional is a bit messy, and cleaning it up using partials is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_2">Section 13.3.2</a>).)</p>
<p class="indent">To get the page defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex037">Listing 13.37</a> working, we need to create and fill in a couple of partials. The first is the new Home page sidebar, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex038">Listing 13.38</a>.</p>
<p class="ex-title" id="ch13ex038"><strong>Listing 13.38:</strong> The partial for the user info sidebar.</p>
<pre class="pre2">app/views/shared/_user_info.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-38a" id="lis13-38">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> link_to gravatar_for(current_user, <span class="colork8">size</span>: <span class="colork8">50</span>), current_user <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork15">h1</span></strong><span class="colork22">&gt;&lt;%=</span> current_user<span class="colork9">.</span>name <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork15">h1</span></strong>&gt;
&lt;<strong><span class="colork10">span</span></strong>&gt;<span class="colork22">&lt;%=</span> link_to "view my profile", current_user %&gt;&lt;/<strong><span class="colork10">span</span></strong>&gt;
&lt;<strong><span class="colork10">span</span></strong>&gt;<span class="colork22">&lt;%=</span> pluralize(current_user.microposts.count, <span class="colork22">"micropost"</span>) <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;</pre>
</div>
<p class="indent">Note that, as in the profile sidebar (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex024">Listing 13.24</a>), the user info in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex038">Listing 13.38</a> displays the total number of microposts for the user. Theres a slight difference in the display, though. In the profile sidebar, Microposts is a label, and showing Microposts (1) makes sense. In the present case, saying 1 microposts is ungrammatical, so <span epub:type="pagebreak" id="page_665"></span>we arrange to display 1 micropost and 2 microposts using the <span class="colork1"><code><strong>pluralize</strong></code></span> method we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_3">Section 7.3.3</a>.</p>
<p class="indent">We next define the form for creating microposts (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex039">Listing 13.39</a>), which is similar to the signup form in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex015">Listing 7.15</a>.</p>
<p class="ex-title" id="ch13ex039"><strong>Listing 13.39:</strong> The form partial for creating microposts.</p>
<pre class="pre2">app/views/shared/_micropost_form.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-39a" id="lis13-39">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> form_with(model: @micropost, local: <strong>true</strong>) <strong>do</strong> |f| <span class="colork22">%&gt;</span>
  <span class="colork22">&lt;%=</span> render 'shared/error_messages', object: f.object <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"field"</span>&gt;
    <span class="colork22">&lt;%=</span> f.text_area :content, placeholder: "Compose new micropost..." <span class="colork22">%&gt;</span>
  &lt;/<strong>div</strong>&gt;
  <span class="colork22">&lt;%=</span> f.submit "Post", class: "btn btn-primary" <span class="colork22">%&gt;</span>
&lt;% <strong>end</strong> <span class="colork9">%&gt;</span></pre>
</div>
<p class="indent">We need to make two changes before the form in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex039">Listing 13.39</a> will work. First, we need to define <span class="colork1"><code><strong>@micropost</strong></code></span>, which (as before) we do through the association:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg665-01a" id="pg665-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork8">@micropost =</span> current_user.microposts.build</pre>
<p class="noindent">The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex040">Listing 13.40</a>.</p>
<p class="ex-title" id="ch13ex040"><strong>Listing 13.40:</strong> Adding a micropost instance variable to the <span class="colork1"><code><strong>home</strong></code></span> action.</p>
<pre class="pre2">app/controllers/static_pages_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-40a" id="lis13-40">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">StaticPagesController</span></strong> <span class="colork11">&lt; ApplicationController</span>

  <strong><span class="colork10">def</span></strong> home
<span class="mark">    <span class="colork8">@micropost =</span> current_user.microposts.build <strong><span class="colork15">if</span></strong> logged_in?</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">help</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">about</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">contact</span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_666"></span>Of course, <span class="colork1"><code><strong>current_user</strong></code></span> exists only if the user is logged in, so the <span class="colork1"><code><strong>@micropost</strong></code></span> variable should be defined only in this case.</p>
<p class="indent">The second change needed to get <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex039">Listing 13.39</a> to work is to redefine the error-messages partial so the following code from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex039">Listing 13.39</a> works:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg666-01a" id="pg666-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork9">&lt;%=</span> render <span class="colork11">'shared/error_messages'</span>, object: f.object <span class="colork9">%&gt;</span></pre>
<p class="noindent">You may recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex020">Listing 7.20</a> that the error-messages partial references the <span class="colork1"><code><strong>@user</strong></code></span> variable explicitly, but in the present case we have an <span class="colork1"><code><strong>@micropost</strong></code></span> variable instead. To unify these cases, we can pass the form variable <span class="colork1"><code><strong>f</strong></code></span> to the partial and access the associated object through <span class="colork1"><code><strong>f.object</strong></code></span>, so that in</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg666-02a" id="pg666-02">Click here to view code image</a></p>
<pre class="pre1">form_with(<span class="colork8">model: @user, local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork9">do</span></strong> <span class="colork9">|</span>f<span class="colork9">|</span></pre>
<p class="noindent"><code><strong>f.object</strong></code> is <span class="colork1"><code><strong>@user</strong></code></span>; in</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg666-03a" id="pg666-03">Click here to view code image</a></p>
<pre class="pre1">form_with(<span class="colork8">model</span>: <span class="colork8">@micropost</span>, <span class="colork8">local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork9">do</span></strong> <span class="colork9">|</span>f<span class="colork9">|</span></pre>
<p class="noindent"><code><strong>f.object</strong></code> is <span class="colork1"><code><strong>@micropost</strong></code></span>; and so on.</p>
<p class="indent">To pass the object to the partial, we use a hash with a value equal to the object and a key equal to the desired name of the variable in the partial, which is what the second line in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex039">Listing 13.39</a> accomplishes. In other words, <span class="colork1"><code><strong>object: f.object</strong></code></span> creates a variable called <span class="colork1"><code><strong>object</strong></code></span> in the <span class="colork1"><code><strong>error_messages</strong></code></span> partial, and we can use it to construct a customized error message, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex041">Listing 13.41</a>.</p>
<p class="ex-title" id="ch13ex041"><strong>Listing 13.41:</strong> Error messages that work with other objects. <span class="redk1"><small>RED</small></span></p>
<pre class="pre2">app/views/shared/_error_messages.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-41a" id="lis13-41">Click here to view code image</a></p>
<div class="example">
<pre><span class="mark"><span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> object.errors.any? <span class="colork22">%&gt;</span></span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">id="error_explanation"</span>&gt;
    &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"alert alert-danger"</span>&gt;
<span class="mark">      The form contains <span class="colork22">&lt;%=</span> pluralize(object.errors.count, <span class="colork23">"error"</span>) <span class="colork23">%&gt;</span>.</span>
    &lt;/<strong><span class="colork10">div</span></strong>&gt;
    &lt;<strong><span class="colork10">ul</span></strong>&gt;
<span class="mark">    <span class="colork23">&lt;%</span> object.errors.full_messages.each <strong><span class="colork10">do</span></strong> |msg| <span class="colork23">%&gt;</span></span>
      &lt;<strong><span class="colork10">li</span></strong>&gt;<span class="colork22">&lt;%=</span> msg %&gt;&lt;/<strong>li</strong>&gt;
    <span class="colork23">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
<span epub:type="pagebreak" id="page_667"></span>    &lt;/<strong><span class="colork10">ul</span></strong>&gt;
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
<span class="colork23">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork23">%&gt;</span></pre>
</div>
<p class="indent">At this point, you should verify that the test suite is <span class="redk1"><small>RED</small></span>:</p>
<p class="ex-title" id="ch13ex042"><strong>Listing 13.42:</strong> <span class="redk1"><small>RED</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">This is a hint that we need to update the other occurrences of the error-messages partial, which we used when signing up users (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex020">Listing 7.20</a>), resetting passwords (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12ex014">Listing 12.14</a>), and editing users (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex02">Listing 10.2</a>). The updated versions are shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex043">Listing 13.43</a>, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex045">Listing 13.45</a>, and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex044">Listing 13.44</a>.</p>
<p class="ex-title" id="ch13ex043"><strong>Listing 13.43:</strong> Updating the rendering of user signup errors. <span class="redk1"><small>RED</small></span></p>
<pre class="pre2">app/views/users/new.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-43a" id="lis13-43">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> provide(<span class="colork8">:title</span>, <span class="colork11">'Sign up'</span>) <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork10">h1</span></strong>&gt;Sign up&lt;/<strong><span class="colork10">h1</span></strong>&gt;

&lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"row"</span>&gt;
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"col-md-6 col-md-offset-3"</span>&gt;
    <span class="colork22">&lt;%=</span> form_with(<span class="colork8">model</span>: <span class="colork8">@user</span>, <span class="colork8">local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> |f| <span class="colork22">%&gt;</span>
<span class="mark">      <span class="colork22">&lt;%=</span> render <span class="colork11">'shared/error_messages'</span>, object: f.object <span class="colork23">%&gt;</span></span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:name</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.text_field <span class="colork8">:name</span>, <span class="colork8">class</span>: <span class="colork23">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:email</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.email_field <span class="colork8">:email</span>, <span class="colork8">class</span>: <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:password</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.password_field <span class="colork8">:password</span>, <span class="colork8">class</span>: <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:password_confirmation</span>, <span class="colork22">"Confirmation"</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.password_field <span class="colork8">:password_confirmation</span>, <span class="colork8">class</span>: <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Create my account"</span>, class: <span class="colork22">"btn btn-primary"</span> <span class="colork22">%&gt;</span>
    <span class="colork22">&lt;%</span> <strong>end</strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
&lt;/<strong><span class="colork10">div</span></strong>&gt;</pre>
</div>
<p class="ex-title" id="ch13ex044"><span epub:type="pagebreak" id="page_668"></span><strong>Listing 13.44:</strong> Updating the errors for password resets. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">app/views/password_resets/edit.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-44a" id="lis13-44">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> provide(<span class="colork8">:title</span>, <span class="colork22">'Reset password'</span>) <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork10">h1</span></strong>&gt;Reset password&lt;/<strong><span class="colork10">h1</span></strong>&gt;

&lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"row"</span>&gt;
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"col-md-6 col-md-offset-3"</span>&gt;
    <span class="colork22">&lt;%=</span> form_with(model: @user, url: password_reset_path(params[:id]),
                  local: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> <span class="colork9"></span>|f<span class="colork9">|</span> <span class="colork22">%&gt;</span>
<span class="mark">      <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/error_messages'</span>, object: f.object <span class="colork23">%&gt;</span></span>

      <span class="colork22">&lt;%=</span> hidden_field_tag <span class="colork8">:email</span>, <span class="colork8">@user.</span>email <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:password</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.password_field <span class="colork8">:password</span>, <span class="colork8">class:</span> <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:password_confirmation</span>, <span class="colork23">"Confirmation"</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.password_field <span class="colork8">:password_confirmation</span>, <span class="colork8">class</span>: <span class="colork23">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.submit <span class="colork23">"Update password"</span>, <span class="colork8">class</span>: <span class="colork23">"btn btn-primary"</span> <span class="colork22">%&gt;</span>
    &lt;% <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
&lt;/<strong><span class="colork10">div</span></strong>&gt;</pre>
</div>
<p class="ex-title" id="ch13ex045"><strong>Listing 13.45:</strong> Updating the errors for editing users. <span class="redk1"><small>RED</small></span></p>
<pre class="pre2">app/views/users/edit.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-45a" id="lis13-45">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> provide(<span class="colork8">:title</span>, <span class="colork22">"Edit user"</span>) <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork10">h1</span></strong>&gt;Update your profile&lt;/<strong><span class="colork10">h1</span></strong>&gt;

&lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"row"</span>&gt;
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"col-md-6 col-md-offset-3"</span>&gt;
    <span class="colork22">&lt;%=</span> form_with(<span class="colork8">model</span>: <span class="colork8">@user</span>, <span class="colork8">local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> <span class="colork9"></span>|f<span class="colork9">|</span> <span class="colork22">%&gt;</span>
<span class="mark">      <span class="colork22">&lt;%=</span> render <span class="colork23">'shared/error_messages'</span>, object: f.object <span class="colork23">%&gt;</span></span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:name</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.text_field <span class="colork8">:name</span>, <span class="colork8">class</span>: <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:email</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.email_field <span class="colork8">:email</span>, <span class="colork8">class</span>: <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:password</span> <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> f.password_field <span class="colork8">:password</span>, <span class="colork8">class</span>: <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.label <span class="colork8">:password_confirmation</span>, <span class="colork22">"Confirmation"</span> <span class="colork22">%&gt;</span>
<span epub:type="pagebreak" id="page_669"></span>      <span class="colork22">&lt;%=</span> f.password_field <span class="colork8">:password_confirmation</span>, <span class="colork8">class</span>: <span class="colork22">'form-control'</span> <span class="colork22">%&gt;</span>

      <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Save changes"</span>, class: <span class="colork22">"btn btn-primary"</span> <span class="colork22">%&gt;</span>
    &lt;% <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>

    &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"gravatar_edit"</span>&gt;
      <span class="colork22">&lt;%=</span> gravatar_for <span class="colork8">@user</span> <span class="colork22">%&gt;</span>
      &lt;<strong>a</strong> <span class="colork22">href="https://gravatar.com/emails"</span>&gt;change&lt;/<strong>a</strong>&gt;
    &lt;/<strong><span class="colork10">div</span></strong>&gt;
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
&lt;/<strong><span class="colork10">div</span></strong>&gt;</pre>
</div>
<p class="indent">At this point, all the tests should be <span class="colork14"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex046"><strong>Listing 13.46:</strong> <span class="colork14"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">Additionally, all the HTML in this section should render properly, showing the form as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig011">Figure 13.11</a>, and a form with a submission error as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig012">Figure 13.12</a>.</p>
<figure id="ch13fig011" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_11.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_11.jpg">
<figcaption><p><strong>Figure 13.11:</strong> The Home page with a new micropost form.<span epub:type="pagebreak" id="page_670"></span></p></figcaption>
</figure>
<figure id="ch13fig012" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_12.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_12.jpg">
<figcaption><p><strong>Figure 13.12:</strong> The Home page with a form error.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev157">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Refactor the Home page to use separate partials for the two branches of the <span class="colork1"><code><strong>if</strong></code></span>-<code><strong>else</strong></code> statement.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_3_3">13.3.3 A Proto-Feed</h4>
<p class="noindent">Although the micropost form is actually now working, users cant immediately see the results of a successful submission because the current Home page doesnt display any microposts. If you like, you can verify that the form shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig011">Figure 13.11</a> is working by submitting a valid entry and then navigating to the profile page to see the post, but thats rather cumbersome. It would be far better to have a <em>feed</em> of microposts that <span epub:type="pagebreak" id="page_671"></span>includes the users own posts, as mocked up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig013">Figure 13.13</a>. (In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">Chapter 14</a>, well generalize this feed to include the microposts of users being <em>followed</em> by the current user,  la Twitter.)</p>
<figure id="ch13fig013" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_13.jpg" alt="Image" width="753" height="646" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_13.jpg">
<figcaption><p><strong>Figure 13.13:</strong> A mockup of the Home page with a proto-feed.</p></figcaption>
</figure>
<p class="indent">Since each user should have a feed, we are led naturally to a <span class="colork1"><code><strong>feed</strong></code></span> method in the User model, which will initially just select all the microposts belonging to the current user. Well accomplish this using the <span class="colork1"><code><strong>where</strong></code></span> method on the <span class="colork1"><code><strong>Micropost</strong></code></span> model (seen briefly before in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_3_3">Section 11.3.3</a>), as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex047">Listing 13.47</a>.<sup><a id="ch13fn14a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn14">14</a></sup></p>
<p class="footnote"><a id="ch13fn14" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn14a">14</a>. See the Rails Guide on the Active Record Query Interface for more on <span class="colork1"><code><strong>where</strong></code></span> and related methods.<span epub:type="pagebreak" id="page_672"></span></p>
<p class="ex-title" id="ch13ex047"><strong>Listing 13.47:</strong> A preliminary implementation for the micropost status feed.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-47a" id="lis13-47">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <span class="colork8"># Defines a proto-feed.</span>
  <span class="colork8"># See "Following users" for the full implementation.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">feed</span>
<span class="mark">    <span class="colork23">Micropost.where</span>(<span class="colork22">"user_id = ?", id</span>)</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">private</span></strong>
    <strong><span class="colork9">.</span></strong>
    <strong><span class="colork9">.</span></strong>
    <strong><span class="colork9">.</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">The question mark in</p>
<pre class="pre1"><span class="colork22">Micropost.</span>where(<span class="colork22">"user_id = ?"</span>, <span class="colork22">id</span>)</pre>
<p class="noindent">ensures that <span class="colork1"><code><strong>id</strong></code></span> is properly <em>escaped</em> before being included in the underlying SQL query, thereby avoiding a serious security hole called <em>SQL injection</em>. The <span class="colork1"><code><strong>id</strong></code></span> attribute here is just an integer (i.e., <span class="colork1"><code><strong>self.id</strong></code></span>, the unique id of the user), so there is no danger of SQL injection in this case. But this practice does no harm, and <em>always</em> escaping variables injected into SQL statements is a good habit to cultivate.</p>
<p class="indent">Alert readers might note at this point that the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex047">Listing 13.47</a> is essentially equivalent to writing</p>
<pre class="pre1"><strong><span class="colork10">def</span></strong> <span class="colork8">feed</span>
  microposts
<strong><span class="colork10"><span class="colork10">end</span></span></strong></pre>
<p class="noindent">Weve used the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex047">Listing 13.47</a> instead because it generalizes much more naturally to the full status feed needed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">Chapter 14</a>.</p>
<p class="indent">To use the feed in the sample application, we add an <span class="colork1"><code><strong>@feed_items</strong></code></span> instance variable for the current users (paginated) feed, as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex048">Listing 13.48</a>, and then add a status <span epub:type="pagebreak" id="page_673"></span>feed partial (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex049">Listing 13.49</a>) to the Home page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex050">Listing 13.50</a>). Note that now two lines need to be run when the user is logged in, so <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex048">Listing 13.48</a> changes</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg673-01a" id="pg673-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork8">@micropost =</span> current_user.microposts.build <strong><span class="colork10">if</span></strong> logged_in?</pre>
<p class="noindent">from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex040">Listing 13.40</a> to</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg673-02a" id="pg673-02">Click here to view code image</a></p>
<pre class="pre1"><strong>if</strong> logged_in?
  <span class="colork8">@micropost  =</span> current_user.microposts.build
  <span class="colork8">@feed_items =</span> current_user.feed.paginate(<span class="colork8">page</span>: params[:<span class="colork8">page</span>])
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">thereby moving the conditional from the end of the line to an if-end statement.</p>
<p class="ex-title" id="ch13ex048"><strong>Listing 13.48:</strong> Adding a feed instance variable to the <span class="colork1"><code><strong>home</strong></code></span> action.</p>
<pre class="pre2">app/controllers/static_pages_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-48a" id="lis13-48">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">StaticPagesController</span></strong> <span class="colork11">&lt; ApplicationController</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">home</span>
<span class="mark">    <strong><span class="colork10">if</span></strong> logged_in?</span>
<span class="mark">      <span class="colork8">@micropost =</span> current_user.microposts.build</span>
<span class="mark">      <span class="colork8">@feed_items =</span> current_user.feed.paginate(<span class="colork8">page</span>: params[:<span class="colork8">page</span>])</span>
<span class="mark">  <strong><span class="colork10">end</span></strong></span>
<strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">help</span>
  <strong><span class="colork10">end</span></strong>

  <strong>def</strong> <span class="colork4">about</span>
  <strong><span class="colork10">end</span></strong>

  <strong>def</strong> <span class="colork4">contact</span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="ex-title" id="ch13ex049"><strong>Listing 13.49:</strong> The status feed partial.</p>
<pre class="pre2">app/views/shared/_feed.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-49a" id="lis13-49">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> <span class="colork8">@feed_items.</span>any? <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">ol</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"microposts"</span>&gt;
    <span class="colork22">&lt;%=</span> render <span class="colork8">@feed_items</span> <span class="colork22">%&gt;</span>
<span epub:type="pagebreak" id="page_674"></span>  &lt;/<strong><span class="colork10">ol</span></strong>&gt;
  <span class="colork22">&lt;%=</span> will_paginate <span class="colork8">@feed_items</span> <span class="colork22">%&gt;</span>
&lt;% <strong><span class="colork10">end</span></strong> <span class="colork9">%&gt;</span></pre>
</div>
<p class="indent">The status feed partial defers the rendering to the micropost partial defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex022">Listing 13.22</a>:</p>
<pre class="pre1"><span class="colork9">&lt;%=</span> render <span class="colork8">@feed_items</span> <span class="colork9">%&gt;</span></pre>
<p class="noindent">Here Rails knows to call the micropost partial because each element of <span class="colork1"><code><strong>@feed_items</strong></code></span> has class <span class="colork1"><code><strong>Micropost</strong></code></span>. This causes Rails to look for a partial with the corresponding name in the views directory of the given resource:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg674-01a" id="pg674-01">Click here to view code image</a></p>
<pre class="pre1">app/views/microposts/_micropost.html.erb</pre>
<p class="indent">We can add the feed to the Home page by rendering the feed partial as usual (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex050">Listing 13.50</a>). The result is a display of the feed on the Home page, as required (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig014">Figure 13.14</a>).</p>
<figure id="ch13fig014" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_14.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_14.jpg">
<figcaption><p><strong>Figure 13.14:</strong> The Home page with a proto-feed.</p></figcaption>
</figure>
<p class="ex-title" id="ch13ex050"><strong>Listing 13.50:</strong> Adding a status feed to the Home page.</p>
<pre class="pre2">app/views/static_pages/home.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-50a" id="lis13-50">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> logged_in? <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"row"</span>&gt;
    &lt;<strong><span class="colork10">aside</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"col-md-4"</span>&gt;
      &lt;<strong>section</strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"user_info"</span>&gt;
        <span class="colork22">&lt;%=</span> render <span class="colork9">'shared/user_info'</span> <span class="colork22">%&gt;</span>
      &lt;/<strong><span class="colork10">section</span></strong>&gt;
      &lt;<strong><span class="colork10">section</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"micropost_form"</span>&gt;
        <span class="colork22">&lt;%=</span> render <span class="colork9">'shared/micropost_form'</span> <span class="colork22">%&gt;</span>
      &lt;/<strong><span class="colork10">section</span></strong>&gt;
    &lt;/<strong><span class="colork10">aside</span></strong>&gt;
<span class="mark">    &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-8"</span>&gt;</span>
<span class="mark">      &lt;<strong><span class="colork10">h3</span></strong>&gt;Micropost Feed&lt;/<strong><span class="colork10">h3</span></strong>&gt;</span>
<span class="mark">      <span class="colork22">&lt;%=</span> render <span class="colork23">'shared/feed'</span> <span class="colork23">%&gt;</span></span>
<span class="mark">    &lt;/<strong><span class="colork10">div</span></strong>&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
<span class="colork22">&lt;%</span> <strong><span class="colork10">else</span></strong> <span class="colork22">%&gt;</span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork9">%&gt;</span></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_675"></span>At this point, creating a new micropost works as expected, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig015">Figure 13.15</a>.</p>
<figure id="ch13fig015" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_15.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_15.jpg">
<figcaption><p><strong>Figure 13.15:</strong> The Home page after creating a new micropost.</p></figcaption>
</figure>
<p class="indent">There is one subtlety, though. On a <em>failed</em> micropost submission, the Home page expects an <span class="colork1"><code><strong>@feed_items</strong></code></span> instance variable, so failed submissions currently break. The solution is to create the necessary feed variable in the branch for failed submissions in the Microposts controller <span class="colork1"><code><strong>create</strong></code></span> action, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex051">Listing 13.51</a>.</p>
<p class="ex-title" id="ch13ex051"><strong>Listing 13.51:</strong> Adding an (empty) <span class="colork1"><code><strong>@feed_items</strong></code></span> instance variable to the <span class="colork1"><code><strong>create</strong></code></span> action.</p>
<pre class="pre2">app/controllers/microposts_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-51a" id="lis13-51">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">MicropostsController</span></strong> <span class="colork9">&lt; ApplicationController</span>
  before_action :<span class="colork8">logged_in_user</span>, <span class="colork8">only</span>: <span class="colork8">[:create</span>, <span class="colork8">:destroy]</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">create</span>
    <span class="colork8">@micropost =</span> current_user.microposts.build(micropost_params)
    <strong><span class="colork10">if</span></strong> <span class="colork8">@micropost.</span>save
      flash<span class="colork8">[:success] =</span> <span class="colork22">"Micropost created!"</span>
      redirect_to root_url
 <strong><span class="colork10">else</span></strong>
<span epub:type="pagebreak" id="page_676"></span><span class="mark">      <span class="colork8">@feed_items</span> current_user.feed.paginate(<span class="colork8">page</span>: params<span class="colork8">[:page]</span>)</span>
      render <span class="colork22">'static_pages/home'</span>
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">destroy</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">private</span></strong>

    <strong><span class="colork10">def</span></strong> <span class="colork4">micropost_params</span>
      params.require(:<span class="colork8">micropost</span>).permit(:<span class="colork8">content</span>)
    <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Unfortunately, pagination still doesnt quite work. We can see why by submitting an invalid micropostsay, one whose length is too long (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig016">Figure 13.16</a>).<span epub:type="pagebreak" id="page_677"></span></p>
<figure id="ch13fig016" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_16.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_16.jpg">
<figcaption><p><strong>Figure 13.16:</strong> An invalid micropost on the Home page.</p></figcaption>
</figure>
<p class="indent">Scrolling down to the pagination links, we see links on both 2 and Next pointing to the next page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig017">Figure 13.17</a>). Because the <span class="colork1"><code><strong>create</strong></code></span> action is in the Microposts controller (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex051">Listing 13.51</a>), the URL is /microposts?page=2, which tries to go to the nonexistent Microposts index action. As a result, clicking on either link gives a routing error (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig018">Figure 13.18</a>).</p>
<figure id="ch13fig017" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_17.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_17.jpg">
<figcaption><p><strong>Figure 13.17:</strong> The Next link on the Home page.</p></figcaption>
</figure>
<figure id="ch13fig018" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_18.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_18.jpg">
<figcaption><p><strong>Figure 13.18:</strong> A routing error on page 2.</p></figcaption>
</figure>
<p class="indent">We can solve this problem by giving <span class="colork1"><code><strong>will_paginate</strong></code></span> explicit <span class="colork1"><code><strong>controller</strong></code></span> and <span class="colork1"><code><strong>action</strong></code></span> parameters corresponding to the Home pagethat is, the <span class="colork1"><code><strong>static_pages</strong></code></span> controller and the <span class="colork1"><code><strong>home</strong></code></span> action.<sup><a id="ch13fn15a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn15">15</a></sup> The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex052">Listing 13.52</a>.</p>
<p class="footnote"><a id="ch13fn15" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn15a">15</a>. Thanks to reader Martin Francl for pointing out this solution.<span epub:type="pagebreak" id="page_678"></span></p>
<p class="ex-title" id="ch13ex052"><strong>Listing 13.52:</strong> Setting an explicit controller and action.</p>
<pre class="pre2">app/views/shared/_feed.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-52a" id="lis13-52">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> <span class="colork8">if @feed_items</span>.any? <span class="colork22">%&gt;</span>
  <span class="colork8">&lt;ol class="microposts"&gt;</span>
    <span class="colork22">&lt;%=</span> render <span class="colork8">@feed_items</span> <span class="colork22">%&gt;</span>
  <span class="colork8">&lt;/ol&gt;</span>
<span class="mark">  <span class="colork22">&lt;%=</span> will_paginate <span class="colork8">@feed_items</span>,</span>
<span class="mark">                    params: { <span class="colork8">controller</span>: :static_pages, action: :<span class="colork8">home</span> } <span class="colork23">%&gt;</span></span>
<span class="colork22">&lt;% end %&gt;</span></pre>
</div>
<p class="indent">Now clicking on either of the pagination links in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig017">Figure 13.17</a> yields the expected second page, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig019">Figure 13.19</a>.</p>
<figure id="ch13fig019" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_19.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_19.jpg">
<figcaption><p><strong>Figure 13.19:</strong> The result of a working pagination link to the second page.<span epub:type="pagebreak" id="page_679"></span></p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev158">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Use the newly created micropost UI to create the first real micropost. What are the contents of the <span class="colork1"><code><strong>INSERT</strong></code></span> command in the server log?</p></li>
<li><p class="num">In the console, set <span class="colork1"><code><strong>user</strong></code></span> to the first user in the database. Confirm that the values of <span class="colork1"><code><strong>Micropost.where("user_id = ?", user.id)</strong></code></span>, <span class="colork1"><code><strong>user.microposts</strong></code></span>, and <span class="colork1"><code><strong>user.feed</strong></code></span> are all the same. <em>Hint</em>: Its probably easiest to compare them directly using <span class="colork1"><code><strong>==</strong></code></span>.<span epub:type="pagebreak" id="page_680"></span></p></li>
</ol>
</section>
</section>
<section>
<h4 class="h4" id="sec13_3_4">13.3.4 Destroying Microposts</h4>
<p class="noindent">The last piece of functionality to add to the Microposts resource is the ability to destroy posts. As with user deletion (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_4_2">Section 10.4.2</a>), we accomplish this with delete links, as mocked up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig020">Figure 13.20</a>. Unlike that case, which restricted user destruction to admin users, the delete links will work only for microposts created by the current user.</p>
<figure id="ch13fig020" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_20.jpg" alt="Image" width="730" height="626" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_20.jpg">
<figcaption><p><strong>Figure 13.20:</strong> A mockup of the proto-feed with micropost delete links.</p></figcaption>
</figure>
<p class="indent">Our first step is to add a delete link to the micropost partial as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex022">Listing 13.22</a>. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex053">Listing 13.53</a>.</p>
<p class="ex-title" id="ch13ex053"><strong>Listing 13.53:</strong> Adding a delete link to the micropost partial.</p>
<pre class="pre2">app/views/microposts/_micropost.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-53a" id="lis13-53">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<strong><span class="colork10">li</span></strong> <span class="colork8">id=</span><span class="colork22">"micropost-</span><span class="colork22">&lt;%=</span> micropost.id %&gt;"&gt;
  <span class="colork22">&lt;%=</span> link_to gravatar_for(micropost.user, <span class="colork8">size</span>: <span class="colork8">50</span>), micropost.user <span class="colork22">%&gt;</span>
<span epub:type="pagebreak" id="page_681"></span>  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class=</span><span class="colork23">"user"</span>&gt;<span class="colork22">&lt;%=</span> link_to micropost.user.name, micropost.user <span class="colork23">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class=</span><span class="colork23">"content"</span>&gt;<span class="colork22">&lt;%=</span> micropost.content <span class="colork23">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"timestamp"</span>&gt;
    Posted <span class="colork22">&lt;%=</span> time_ago_in_words(micropost.created_at) <span class="colork22">%&gt;</span> ago.
    <span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> current_user?(micropost.user) <span class="colork22">%&gt;</span>
<span class="mark">      <span class="colork22">&lt;%=</span> link_to <span class="colork23">"delete"</span>, micropost, <span class="colork23">method</span>: :<span class="colork4">delete</span>,</span>
<span class="mark">                                       data: { <span class="colork8">confirm</span>: <span class="colork23">"You sure?"</span> } <span class="colork23">%&gt;</span></span>
    <span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
&lt;/<strong><span class="colork10">li</span></strong>&gt;</pre>
</div>
<p class="indent">The next step is to define a <span class="colork1"><code><strong>destroy</strong></code></span> action in the Microposts controller, which is analogous to the user case in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex059">Listing 10.59</a>. The main difference is that, rather than using an <span class="colork1"><code><strong>@user</strong></code></span> variable with an <span class="colork1"><code><strong>admin_user</strong></code></span> before filter, well find the micropost <span epub:type="pagebreak" id="page_682"></span>through the association, which will automatically fail if a user tries to delete another users micropost. Well put the resulting <span class="colork1"><code><strong>find</strong></code></span> inside a <span class="colork1"><code><strong>correct_user</strong></code></span> before filter, which checks that the current user actually has a micropost with the given id. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex054">Listing 13.54</a>.</p>
<p class="ex-title" id="ch13ex054"><strong>Listing 13.54:</strong> The Microposts controller <span class="colork1"><code><strong>destroy</strong></code></span> action.</p>
<pre class="pre2">app/controllers/microposts_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-54a" id="lis13-54">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">MicropostsController</span></strong> <span class="colork11">&lt; ApplicationController</span>
  before_action :<span class="colork8">logged_in_user</span>, <span class="colork8">only</span>: <span class="colork8">[:create</span>, <span class="colork8">:destroy]</span>
<span class="mark">  before_action :correct_user, <span class="colork8">only</span>: :destroy</span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
   <strong><span class="colork10">def</span></strong> <span class="colork8">destroy</span>
<span class="mark">    <span class="colork8">@micropost</span>.destroy</span>
<span class="mark">    flash<span class="colork8">[:success] =</span> <span class="colork23">"Micropost deleted"</span></span>
<span class="mark">    redirect_to request.referrer <span class="colork23">||</span> root_url</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">private</span></strong>

    <strong><span class="colork10">def</span></strong> <span class="colork4">micropost_params</span>
      params.require(:<span class="colork8">micropost</span>).permit(:<span class="colork8">content</span>)
    <strong><span class="colork10">end</span></strong>

    <strong><span class="colork10">def</span></strong> <span class="colork4">correct_user</span>
<span class="mark">      <span class="colork8">@micropost =</span> current_user.microposts.find_by(<span class="colork22">id</span>: params[:<span class="colork8">id</span>])</span>
<span class="mark">      redirect_to root_url <strong><span class="colork15">if</span></strong> <span class="colork8">@micropost.nil</span>?</span>
   <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">Note that the <span class="colork1"><code><strong>destroy</strong></code></span> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex054">Listing 13.54</a> redirects to the URL</p>
<pre class="pre1">request.referrer || root_url</pre>
<p class="noindent">This uses the <span class="colork1"><code><strong>request.referrer</strong></code></span> method,<sup><a id="ch13fn16a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn16">16</a></sup> which is related to the <span class="colork1"><code><strong>request. original_url</strong></code></span> variable used in friendly forwarding (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_3">Section 10.2.3</a>), and is just <span epub:type="pagebreak" id="page_683"></span>the previous URL (in this case, the Home page).<sup><a id="ch13fn17a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn17">17</a></sup> This is convenient because microposts appear on both the Home page and the users profile page, so by using <span class="colork1"><code><strong>request.referrer</strong></code></span> we arrange to redirect back to the page issuing the delete request in both cases. If the referring URL is <span class="colork1"><code><strong>nil</strong></code></span> (as is the case inside some tests), <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex05">Listing 13.5</a> sets the <span class="colork1"><code><strong>root_url</strong></code></span> as the default using the <span class="colork1"><code><strong>||</strong></code></span> operator. (Compare this to the default options defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex024">Listing 9.24</a>.)</p>
<p class="footnote"><a id="ch13fn16" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn16a">16</a>. This corresponds to <code>HTTP_REFERER</code>, as defined by the specification for HTTP. Note that referer is not a typothe word is actually misspelled in the spec. Rails corrects this error by writing referrer instead.</p>
<p class="footnote"><a id="ch13fn17" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn17a">17</a>. I didnt remember offhand how to get this URL inside a Rails application, so I Googled rails request previous url and found a Stack Overflow thread with the answer.</p>
<p class="indent">With the code shown in this section, the Home page has working delete links (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig021">Figure 13.21</a>), which you can verify by deleting, for example, the second post (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig022">Figure 13.22</a>).</p>
<figure id="ch13fig021" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_21.jpg" alt="Image" width="891" height="688" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_21.jpg">
<figcaption><p><strong>Figure 13.21:</strong> The Home page with delete links.<span epub:type="pagebreak" id="page_684"></span></p></figcaption>
</figure>
<figure id="ch13fig022" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_22.jpg" alt="Image" width="891" height="688" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_22.jpg">
<figcaption><p><strong>Figure 13.22:</strong> The result of deleting the second post.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev159">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Create a new micropost and then delete it. What are the contents of the <span class="colork1"><code><strong>DELETE</strong></code></span> command in the server log?</p></li>
<li><p class="num">Confirm directly in the browser that the line <span class="colork1"><code><strong>redirect_to request.referrer || root_url</strong></code></span> can be replaced with the line <span class="colork1"><code><strong>redirect_back(fallback_location: root_url)</strong></code></span>. (This method was added in Rails 5.)</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_3_5">13.3.5 Micropost Tests</h4>
<p class="noindent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_4">Section 13.3.4</a>, the Micropost model and interface are complete. All thats left is writing a short Microposts controller test to check authorization and a micropost integration test to tie it all together.<span epub:type="pagebreak" id="page_685"></span></p>
<p class="indent">Well start by adding a few microposts with different owners to the micropost fixtures, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex055">Listing 13.55</a>. (Well be using only one for now, but weve put in the others for future reference.)</p>
<p class="ex-title" id="ch13ex055"><strong>Listing 13.55:</strong> Adding a micropost with a different owner.</p>
<pre class="pre2">test/fixtures/microposts.yml</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-55a" id="lis13-55">Click here to view code image</a></p>
<div class="example">
<pre> <strong><span class="colork9">.</span></strong>
 <strong><span class="colork9">.</span></strong>
 <strong><span class="colork9">.</span></strong>
 ants:
   <span class="colork8">content</span>: <span class="colork11">"Oh, is that what you want? Because that's how you get ants!"</span>
   created_at: <span class="colork22">&lt;%=</span> 2.years.ago <span class="colork22">%&gt;</span>
   user: archer

zone:
  content: <span class="colork23">"Danger zone!"</span>
  created_at: <span class="colork11">&lt;%=</span> 3.days.ago <span class="colork22">%&gt;</span>
  user: archer

tone:
  content: <span class="colork11">"I'm sorry. Your words made sense, but your sarcastic tone did not."</span>
  created_at: <span class="colork22">&lt;%=</span> 10.minutes.ago <span class="colork22">%&gt;</span>
  user: lana

van:
  content: <span class="colork11">"Dude, this van's, like, rolling probable cause."</span>
  created_at: <span class="colork22">&lt;%=</span> 4.hours.ago <span class="colork22">%&gt;</span>
  user: lana</pre>
</div>
<p class="indent">We next write a short test to make sure one user cant delete the microposts of a different user, and we also check for the proper redirect, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex056">Listing 13.56</a>.</p>
<p class="ex-title" id="ch13ex056"><strong>Listing 13.56:</strong> Testing micropost deletion with a user mismatch. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">test/controllers/microposts_controller_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-56a" id="lis13-56">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostsControllerTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@micropost =</span> microposts(<span class="colork8">:orange</span>)
  <strong><span class="colork10">end</span></strong>

<span epub:type="pagebreak" id="page_686"></span>  <span class="colork11">test "should redirect create when not logged in"</span> <strong><span class="colork10">do</span></strong>
    assert_no_difference <span class="colork22">'Micropost.count'</span> <strong><span class="colork10">do</span></strong>
      post microposts_path, <span class="colork8">params</span>: { <span class="colork8">micropost</span>: { <span class="colork8">content</span>: <span class="colork22">"Lorem ipsum"</span> } }
    <strong><span class="colork10">end</span></strong>
    assert_redirected_to login_url
  <strong><span class="colork10">end</span></strong>

  <span class="colork11">test "should redirect destroy when not logged in"</span> <strong><span class="colork10">do</span></strong>
    assert_no_difference <span class="colork22">'Micropost.count'</span> <strong><span class="colork10">do</span></strong>
      delete micropost_path(<span class="colork8">@micropost</span>)
    <strong><span class="colork10">end</span></strong>
    assert_redirected_to login_url
  <strong><span class="colork10">end</span></strong>

<span class="mark"> <span class="colork22">test "should redirect destroy for wrong micropost"</span> <strong><span class="colork10">do</span></strong></span>
<span class="mark">    log_in_as(users(:michael))</span>
<span class="mark">    micropost = microposts(:ants)</span>
<span class="mark">    assert_no_difference <span class="colork22">'Micropost.count' do</span></span>
<span class="mark">      delete micropost_path(micropost)</span>
<span class="mark">   <strong><span class="colork10">end</span></strong></span>
<span class="mark">   assert_redirected_to root_url</span>
<span class="mark">  <strong><span class="colork10">end</span></strong></span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Finally, well write an integration test to log in, check the micropost pagination, make an invalid submission, make a valid submission, delete a post, and then visit a second users page to make sure there are no delete links. We start by generating a test as usual:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg686-01a" id="pg686-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails generate integration_test microposts_interface
      invoke  test_unit
      <span class="colork22">create    test/integration/microposts_interface_test.rb</span></pre>
<p class="noindent">The test appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex057">Listing 13.57</a>. See if you can connect the lines in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex012">Listing 13.12</a> to the steps just mentioned.</p>
<p class="ex-title" id="ch13ex057"><strong>Listing 13.57:</strong> An integration test for the micropost interface. <span class="colork14"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/microposts_interface_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-57a" id="lis13-57">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostsInterfaceTest</span></strong> <span class="colork22">&lt; ActionDispatch::IntegrationTest</span>
  <span epub:type="pagebreak" id="page_687"></span><strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
      <span class="colork8">@user =</span> users(:<span class="colork8">michael</span>)
  <strong><span class="colork10">end</span></strong>

  <span class="colork11">test "micropost interface"</span> <strong><span class="colork10">do</span></strong>
    log_in_as(<span class="colork8">@user</span>)
    get root_path
    assert_select <span class="colork11">'div.pagination'</span>
    <span class="colork10"># Invalid submission</span>
    assert_no_difference <span class="colork11">'Micropost.count'</span> <strong><span class="colork10">do</span></strong>
      post microposts_path, <span class="colork8">params</span>: { <span class="colork8">micropost</span>: { <span class="colork8">content</span>: <span class="colork22">""</span> } }
    <strong><span class="colork10">end</span></strong>
    assert_select <span class="colork10">'div#error_explanation'</span>
    assert_select <span class="colork10">'a[href=?]'</span>, <span class="colork10">'/?page=2</span>' <span class="colork8"># Correct pagination link</span>
    <span class="colork8"># Valid submission</span>
    content <span class="colork11">= "This micropost really ties the room together"</span>
    assert_difference <span class="colork11">'Micropost.count'</span>, <span class="colork11">1</span> <strong><span class="colork10">do</span></strong>
      post microposts_path, <span class="colork8">params</span>: { <span class="colork8">micropost</span>: { <span class="colork8">content</span>: content } }
    <strong><span class="colork10">end</span></strong>
    assert_redirected_to root_url
    follow_redirect!
    assert_match content, response.body
    <span class="colork8"># Delete post</span>
    assert_select <span class="colork22">'a'</span>, text: <span class="colork22">'delete'</span>
    first_micropost = <span class="colork8">@user.</span>microposts.paginate(<span class="colork8">page: 1</span>).first
    assert_difference <span class="colork8">'Micropost.count'</span>, <span class="colork8">-1</span> <strong><span class="colork10">do</span></strong>
      delete micropost_path(first_micropost)
    <strong><span class="colork10">end</span></strong>
    <span class="colork8"># Visit different user (no delete links)</span>
    get user_path(users(:archer))
    assert_select <span class="colork22">'a'</span>, <span class="colork8">text</span>: <span class="colork22">'delete'</span>, <span class="colork8">count</span>: <span class="colork8">0</span>
   <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Because we wrote working application code first, the test suite should be <span class="colork14"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch13ex058"><strong>Listing 13.58:</strong> <span class="colork14"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev160">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_688"></span></p>
<ol class="num">
<li><p class="num">For each of the four scenarios indicated by comments in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex057">Listing 13.57</a> (starting with Invalid submission), comment out application code to get the corresponding test to <span class="redk1"><small>RED</small></span>, then uncomment to get back to <span class="colork14"><small>GREEN</small></span>.</p></li>
<li><p class="num">Add tests for the sidebar micropost count (including proper pluralization). <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex059">Listing 13.59</a> will help get you started.</p></li>
</ol>
<p class="ex-title" id="ch13ex059"><strong>Listing 13.59:</strong> A template for the sidebar micropost count test.</p>
<pre class="pre2">test/integration/microposts_interface_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-59a" id="lis13-59">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostInterfaceTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
  <strong><span class="colork10">end</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <span class="colork8">test</span> <span class="colork22">"micropost sidebar count"</span> <strong><span class="colork10">do</span></strong>
    log_in_as(<span class="colork8">@user</span>)
    get root_path
    assert_match "<strong><span class="colork9">#{</span></strong><span class="colork11">FILL_IN</span><strong><span class="colork9">}</span></strong> <span class="colork22">microposts"</span>, response.body
    <span class="colork8"># User with zero microposts</span>
    other_user = users(:malory)
    log_in_as(other_user)
    get root_path
    assert_match <span class="colork22">"0 microposts"</span>, response.body
    other_user.microposts.create!(<span class="colork8">content</span>: <span class="colork2">"A micropost"</span>)
    get root_path
    assert_match <span class="colork9">FILL_IN</span>, response.body
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec13_4">13.4 Micropost Images</h3>
<p class="noindent">Now that weve added support for all relevant micropost actions, in this section well make it possible for microposts to include images as well as text. Well start with a basic version good enough for development use, and then add a series of enhancements to make image upload production-ready.<span epub:type="pagebreak" id="page_689"></span></p>
<p class="indent">Adding image upload involves two main visible elements: a form field for uploading an image and the micropost images themselves. A mockup of the resulting Upload image button and micropost photo appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig023">Figure 13.23</a>.<sup><a id="ch13fn18a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn18">18</a></sup></p>
<figure id="ch13fig023" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_23.jpg" alt="Image" width="715" height="613" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_23.jpg">
<figcaption><p><strong>Figure 13.23:</strong> A mockup of micropost image upload (with an uploaded image).</p></figcaption>
</figure>
<p class="footnote"><a id="ch13fn18" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn18a">18</a>. Image retrieved from <a href="https://www.flickr.com/photos/grungepunk/14026922186">https://www.flickr.com/photos/grungepunk/14026922186</a> on 2014-09-19. Copyright  2014 by Jussie D. Brito and used unaltered under the terms of the Creative Commons Attribution-ShareAlike 2.0 Generic license.</p>
<section>
<h4 class="h4" id="sec13_4_1">13.4.1 Basic Image Upload</h4>
<p class="noindent">The most convenient way to upload files in Rails is to use a built-in feature called Active Storage.<sup><a id="ch13fn19a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn19">19</a></sup> Active Storage makes it easy to handle an uploaded image and <span epub:type="pagebreak" id="page_690"></span>associate it with a model of our choice (e.g., the Micropost model). Although well be using it only for uploading images, Active Storage is actually quite general, and can handle plain text and multiple kinds of binary files (such as PDF documents or recorded audio).</p>
<p class="footnote"><a id="ch13fn19" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn19a">19</a>. Active Storage was added in Rails 5.2.</p>
<p class="indent">As described in the Active Storage documentation (<a href="http://edgeguides.rubyonrails.org/active_storage_overview.html">edgeguides.rubyonrails.org/active_storage_overview.html</a>), adding Active Storage to our application is as easy as running a single command:</p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails active_storage:install</pre>
<p class="noindent">This command generates a database migration that creates a data model for storing attached files. Youre welcome to take a look at it, but this is an excellent example of applying technical sophistication to know which details matter and which dont. In this case, what matters is the API for interacting with Active Storage, which well start covering in a moment; for our purposes, the implementation details are safe to ignore. All we need to do to set it up is run the migration:</p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails db:migrate</pre>
<p class="indent">The first part of the Active Storage API that we need is the <span class="colork1"><code><strong>has_one_attached</strong></code></span> method, which allows us to associate an uploaded file with a given model. In our case, well call it <span class="colork1"><code><strong>image</strong></code></span> and associate it with the Micropost model, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex060">Listing 13.60</a>.</p>
<p class="ex-title" id="ch13ex060"><strong>Listing 13.60:</strong> Adding an image to the Micropost model.</p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-60a" id="lis13-60">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:user</span>
<span class="mark">  has_one_attached :image</span>
  default_scope -&gt; { order<span class="colork8">(created_at</span>: :<span class="colork8">desc</span>) }
  validates <span class="colork8">:user_id</span>, <span class="colork8">presence</span>: <strong><span class="colork10">true</span></strong>
  validates :<span class="colork8">content</span>, <span class="colork8">presence</span>: <strong><span class="colork10">true</span></strong>, length: { <span class="colork8">maximum</span>: <span class="colork8">140</span> }
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">Well adopt a design of one image per micropost for our application, but Active Storage also offers a second option, <span class="colork1"><code><strong>has_many_attached</strong></code></span>, which enables multiple files to be attached to a single Active Record object.<span epub:type="pagebreak" id="page_691"></span></p>
<p class="indent">To include image upload on the Home page as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig023">Figure 13.23</a>, we need to include a <span class="colork1"><code><strong>file_field</strong></code></span> tag in the micropost form, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex061">Listing 13.61</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig024">Figure 13.24</a>.</p>
<figure id="ch13fig024" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_24.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_24.jpg">
<figcaption><p><strong>Figure 13.24:</strong> Adding an image upload field.</p></figcaption>
</figure>
<p class="ex-title" id="ch13ex061"><strong>Listing 13.61:</strong> Adding image upload to the micropost create form.</p>
<pre class="pre2">app/views/shared/_micropost_form.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-61a" id="lis13-61">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> form_with(<span class="colork8">model</span>: <span class="colork8">@micropost</span>, <span class="colork8">local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> |f| <span class="colork22">%&gt;</span>
  <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/error_messages'</span>, <span class="colork8">object</span>: f.object <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"field"</span>&gt;
    <span class="colork22">&lt;%=</span> f.text_area <span class="colork8">:content</span>, <span class="colork8">placeholder</span>: <span class="colork22">"Compose new micropost..." %&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
  <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Post"</span>, <span class="colork8">class</span>: <span class="colork22">"btn btn-primary" %&gt;</span>
<span class="mark">  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class=</span><span class="colork23">"image"</span>&gt;</span>
<span class="mark">    <span class="colork22">&lt;%=</span> f.file_field :<span class="colork8">image</span> <span class="colork23">%&gt;</span></span>
<span class="mark">  &lt;/<strong><span class="colork10">span</span></strong>&gt;</span>
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork9">%&gt;</span></pre>
</div>
<p class="indent">Finally, we need to update the Microposts controller to add the image to the newly created micropost object. We can do this using the <span class="colork1"><code><strong>attach</strong></code></span> method provided by the Active Storage API, which attaches the uploaded image to the <span class="colork1"><code><strong>@micropost</strong></code></span> object in the Microposts controllers <span class="colork1"><code><strong>create</strong></code></span> action. To allow the upload to go through, we also need to update the <span class="colork1"><code><strong>micropost_params</strong></code></span> method to add <span class="colork1"><code><strong>:image</strong></code></span> to the list of attributes permitted to be modified through the web. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex062">Listing 13.62</a>.</p>
<p class="ex-title" id="ch13ex062"><strong>Listing 13.62:</strong> Adding <span class="colork1"><code><strong>image</strong></code></span> to the list of permitted attributes.</p>
<pre class="pre2">app/controllers/microposts_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-62a" id="lis13-62">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork8">class</span> <span class="colork4">MicropostsController</span></strong> <span class="colork11">&lt; ApplicationController</span>
  before_action <span class="colork8">:logged_in_user</span>, <span class="colork8">only</span>: <span class="colork8">[:create</span>, <span class="colork8">:destroy]</span>
  before_action :<span class="colork8">correct_user</span>, <span class="colork8">only</span>: :<span class="colork8">destroy</span>


  <strong><span class="colork10">def</span></strong> <span class="colork4">create</span>
    <span class="colork8">@micropost =</span> current_user.microposts.build(micropost_params)
<span class="mark">    @micropost.image.attach(params[:micropost][:image])</span>
    <strong><span class="colork10">if</span></strong> <span class="colork8">@micropost</span>.save
      flash<span class="colork8">[:success] =</span> <span class="colork22">"Micropost created!"</span>
      redirect_to root_url
    <strong><span class="colork10">else</span></strong>
<span epub:type="pagebreak" id="page_692"></span>      <span class="colork8"><span class="colork8">@feed_items</span></span> = current_user.feed.paginate(<span class="colork8">page</span>: params[:<span class="colork8">page</span>])
      render <span class="colork11">'static_pages/home'</span>
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">destroy</span>
    <span class="colork8">@micropost.</span>destroy
    flash<span class="colork8">[:success] =</span> <span class="colork22">"Micropost deleted"</span>
    redirect_to request.referrer <span class="colork8">||</span> root_url
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">private</span></strong>

    <strong><span class="colork10">def</span></strong> <span class="colork4">micropost_params</span>
<span class="mark">    params.require(:<span class="colork8">micropost</span>).permit(:<span class="colork8">content</span>, :image)</span>
  <strong><span class="colork10">end</span></strong>

    <span epub:type="pagebreak" id="page_693"></span><strong><span class="colork8">def</span></strong> <span class="colork4">correct_user</span>
      <span class="colork8">@micropost =</span> current_user.microposts.find_by(<span class="colork8">id</span>: params[:<span class="colork8">id</span>])
      redirect_to root_url <strong><span class="colork10">if</span></strong> <span class="colork8">@micropost.</span>nil?
    <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Once the image has been uploaded, we can render the associated <span class="colork1"><code><strong>micropost.image</strong></code></span> using the <span class="colork1"><code><strong>image_tag</strong></code></span> helper in the micropost partial, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex063">Listing 13.63</a>. Notice the use of the <span class="colork1"><code><strong>attached?</strong></code></span> boolean method to prevent the display of an image tag when there isnt an image.</p>
<p class="ex-title" id="ch13ex063"><strong>Listing 13.63:</strong> Adding image display to microposts.</p>
<pre class="pre2">app/views/microposts/_micropost.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-63a" id="lis13-63">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<strong><span class="colork10">li</span></strong> <span class="colork22">id=</span><span class="colork23">"micropost-&lt;%=</span> micropost.id <span class="colork22">%&gt;"</span>&gt;
  <span class="colork22">&lt;%=</span> link_to gravatar_for(micropost.user, <span class="colork8">size</span>: <span class="colork8">50</span>), micropost.user <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class=</span><span class="colork23">"user"</span>&gt;<span class="colork22">&lt;%=</span> link_to micropost.user.name, micropost.user <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"content"</span>&gt;
    <span class="colork22">&lt;%=</span> micropost.content <span class="colork22">%&gt;</span>
<span class="mark">    <span class="colork22">&lt;%=</span> image_tag micropost.image <strong><span class="colork15">if</span></strong> micropost.image.attached? <span class="colork23">%&gt;</span></span>
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"timestamp"</span>&gt;
    Posted <span class="colork22">&lt;%=</span> time_ago_in_words(micropost.created_at) <span class="colork22">%&gt;</span> ago.
    <span class="colork22">&lt;%</span> <strong>if</strong> current_user?(micropost.user) <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> link_to <span class="colork22">"delete"</span>, micropost, <span class="colork8">method</span>: :<span class="colork8">delete</span>,
                                       <span class="colork8">data: { confirm</span>: <span class="colork22">"You sure?"</span> } <span class="colork22">%&gt;</span>
    &lt;% <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
&lt;/<strong><span class="colork10">li</span></strong>&gt;</pre>
</div>
<p class="indent">The result of making a micropost with an image appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig025">Figure 13.25</a>. Im always amazed when things like this actually work, but theres the proof! (Its also a good idea to write at least a basic automated test for image upload, which is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_1">Section 13.4.1</a>).)</p>
<figure id="ch13fig025" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_25.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_25.jpg">
<figcaption><p><strong>Figure 13.25:</strong> The result of submitting a micropost with an image.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev161">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_694"></span></p>
<ol class="num">
<li><p class="num">Upload a micropost with attached image. Does the result look too big? (If so, dont worry; well fix it in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_3">Section 13.4.3</a>.)</p></li>
<li><p class="num">Write a test of the image uploader in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4">Section 13.4</a>. As preparation, you should add an image to the fixtures directory using <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex064">Listing 13.64</a>. The additional assertions in the template in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex065">Listing 13.65</a> check both for a file upload field on the Home page and for a valid image attribute on the micropost resulting from valid submission. Note the use of the special <span class="colork1"><code><strong>fixture_file_upload</strong></code></span> method for uploading files as fixtures inside tests.<sup><a id="ch13fn20a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn20">20</a></sup> <em>Hint</em>: To check for a valid <span class="colork1"><code><strong>image</strong></code></span> attribute, use the <span class="colork1"><code><strong>assigns</strong></code></span> method mentioned in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_3_3">Section 11.3.3</a> to access the micropost in the <span class="colork1"><code><strong>create</strong></code></span> action after valid submission.</p></li>
</ol>
<p class="footnote"><a id="ch13fn20" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn20a">20</a>. Windows users should add a <span class="colork1"><code><strong>:binary</strong></code></span> parameter: <span class="colork1"><code><strong>fixture_file_upload(file, type, :binary)</strong></code></span>.<span epub:type="pagebreak" id="page_695"></span></p>
<p class="ex-title" id="ch13ex064"><strong>Listing 13.64:</strong> Downloading a fixture image for use in the tests.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-64a" id="lis13-64">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork4">$</span></strong> curl -o test/fixtures/kitten.jpg -OL https://cdn.learnenough.com/kitten.jpg</pre>
</div>
<p class="ex-title" id="ch13ex065"><strong>Listing 13.65:</strong> A template for testing image upload.</p>
<pre class="pre2">test/integration/microposts_interface_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-65a" id="lis13-65">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork10">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">MicropostInterfaceTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(:<span class="colork8">michael</span>)
  <strong><span class="colork10">end</span></strong>

  <span class="colork22">test "micropost interface"</span> <strong><span class="colork10">do</span></strong>
    log_in_as(<span class="colork8">@user</span>)
    get root_path
    assert_select <span class="colork22">'div.pagination'</span>
<span class="mark">    assert_select <span class="colork23">'input[type=FILL_IN]'</span></span>
    <span class="colork8"># Invalid submission</span>
    assert_no_difference <span class="colork22">'Micropost.count'</span> <strong><span class="colork10">do</span></strong>
      post microposts_path, <span class="colork8">params</span>: { <span class="colork8">micropost</span>: { <span class="colork8">content</span>: <span class="colork22">""</span> } }
    <strong><span class="colork10">end</span></strong>
    assert_select <span class="colork22">'div#error_explanation'</span>
    assert_select <span class="colork22">'a[href=?]', '/?page=2'</span> <span class="colork8"># Correct pagination link</span>
    <span class="colork8"># Valid submission</span>
    content <span class="colork22">= "This micropost really ties the room together"</span>
<span class="mark">    image = fixture_file_upload<span class="colork23">('test/fixtures/kitten.jpg', 'image/jpeg')</span></span>
    assert_difference <span class="colork22">'Micropost.count'</span>, <span class="colork8">1</span> <strong><span class="colork10">do</span></strong>
<span class="mark">    post microposts_path, params: { <span class="colork8">micropost</span>:</span>
<span class="mark">                                    { <span class="colork8">content</span>: content, <span class="colork8">image</span>: image } }</span>
    <strong><span class="colork10">end</span></strong>
<span class="mark">    assert <span class="redk1">FILL_IN</span>.image.attached?</span>
    follow_redirect!
    assert_match content, response.body
    <span class="colork8"># Delete a post.</span>
    assert_select <span class="colork8">'a'</span>, text: <span class="colork22">'delete'</span>
    first_micropost <span class="colork8">= @user.</span>microposts.paginate(<span class="colork8">page: 1</span>).first
    assert_difference <span class="colork22">'Micropost.count'</span>, <span class="colork22">-1</span> <strong><span class="colork10">do</span></strong>
      delete micropost_path(first_micropost)
    <strong><span class="colork10">end</span></strong>
    <span class="colork8"># Visit a different user.</span>
    get user_path(users(:<span class="colork8">archer</span>))
<span epub:type="pagebreak" id="page_696"></span>      assert_select <span class="colork22">'a'</span>, { text: <span class="colork22">'delete'</span>, <span class="colork8">count</span>: <span class="colork8">0</span> }
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
</section>
</section>
<section>
<h4 class="h4" id="sec13_4_2">13.4.2 Image Validation</h4>
<p class="noindent">The image upload code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_1">Section 13.4.1</a> is a good start, but it has significant limitations. Among other things, it doesnt enforce any constraints on the uploaded file, which can cause problems if users try to upload large files or invalid file types. To remedy this defect, well add validations for the image size and format.</p>
<p class="indent">As of this writing, Active Storage (somewhat surprisingly) doesnt offer native support for things like format and size validations, but as is so often the case there is a gem that adds it for us (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex066">Listing 13.66</a>).</p>
<p class="ex-title" id="ch13ex066"><strong>Listing 13.66:</strong> Adding a gem for Active Storage validations.</p>
<pre class="pre2">Gemfile</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-66a" id="lis13-66">Click here to view code image</a></p>
<div class="example">
<pre>source <span class="colork22">'https://rubygems.org'</span>
git_source(<span class="colork8">:github</span>) { <span class="colork8">|</span>repo<span class="colork8">|</span> <span class="colork22">"https://github.com/</span><strong><span class="grayk1">#{</span></strong>repo<strong><span class="grayk1">}</span></strong><span class="colork8">.git"</span> }

gem <span class="colork11">'rails'</span>,                      <span class="colork11">'6.0.2.1'</span>
<span class="mark">gem <span class="colork23">'active_storage_validations'</span>, <span class="colork23">'0.8.2'</span></span>
gem <span class="colork11">'bcrypt'</span>,                     '<span class="colork11">3.1.13'</span>
<span class="colork9">.</span>
<span class="colork9">.</span>
<span class="colork9">.</span></pre>
</div>
<p class="indent">Then <span class="colork1"><code><strong>bundle install</strong></code></span>:</p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> bundle install</pre>
<p class="indent">Following the gem documentation (<a href="http://github.com/igorkasyanchuk/active_storage_validations">github.com/igorkasyanchuk/active_storage_validations</a>), we see that we can validate the image format by examining the <span class="colork1"><code><strong>content_type</strong></code></span> as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg696-01a" id="pg696-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork8">content_type</span>: { <strong><span class="colork10">in</span></strong>: <span class="colork25">%w[image/jpeg image/gif image/png]</span>,
                <span class="colork4">message</span>: <span class="colork23">"must be a valid image format"</span> }</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_697"></span>This checks that the MIME type of the image corresponds to a supported image format. (Recall the <span class="colork1"><code><strong>%w[]</strong></code></span> array-building syntax from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_4">Section 6.2.4</a>.)</p>
<p class="indent">Similarly, we can validate the file size like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg697-01a" id="pg697-01">Click here to view code image</a></p>
<pre class="pre1">size: { <span class="colork8">less_than</span>: <span class="colork8">5.</span>megabytes,
        <span class="colork8">message</span>:   <span class="colork23">"should be less than 5MB"</span> }</pre>
<p class="noindent">This sets a limit of 5 megabytes using a syntax we saw earlier in the context of time helpers (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#box9_1">Box 9.1</a>).</p>
<p class="indent">Adding these validations to the Micropost model gives the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex067">Listing 13.67</a>.</p>
<p class="ex-title" id="ch13ex067"><strong>Listing 13.67:</strong> Adding validations to images.</p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-67a" id="lis13-67">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:user</span>
  has_one_attached <span class="colork8">:image</span>
  default_scope -&gt; { order(<span class="colork8">created_at</span>: :<span class="colork8">desc</span>) }
  validates <span class="colork8">:user_id</span>, <span class="colork8">presence</span>: <strong><span class="colork10">true</span></strong>
  validates :<span class="colork8">content</span>, <span class="colork8">presence</span>: <strong><span class="colork10">true</span></strong>, <span class="colork8">length</span>: { <span class="colork8">maximum</span>: <span class="colork8">140 }</span>
<span class="mark">  validates :image,   content_type: { <strong><span class="colork15">in</span></strong>: <span class="colork23">%w[image/jpeg image/gif image/png]</span>,</span>
<span class="mark">                                      message: <span class="colork23">"must be a valid image format"</span> },</span>
<span class="mark">                      size:         { <span class="colork8">less_than</span>: <span class="colork8">5.</span>megabytes,</span>
<span class="mark">                                      <span class="colork8">message</span>:   <span class="colork23">"should be less than 5MB"</span> }</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">The result of trying to upload a large, invalid image then appears as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig026">Figure 13.26</a>. (You may have to restart the Rails server first.)</p>
<figure id="ch13fig026" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_26.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_26.jpg">
<figcaption><p><strong>Figure 13.26:</strong> Trying to upload a large, invalid image.</p></figcaption>
</figure>
<p class="indent">To go along with the validations in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex067">Listing 13.67</a>, well add client-side (in-browser) checks on the uploaded image size and format. Well start by including a little Java-Script (or, more specifically, jQuery) to issue an alert if a user tries to upload an image thats too big (which prevents accidental time-consuming uploads and lightens the load on the server). The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex068">Listing 13.68</a>.<sup><a id="ch13fn21a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn21">21</a></sup></p>
<p class="footnote"><a id="ch13fn21" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn21a">21</a>. More advanced users of JavaScript would probably put the size check in its own function, but since this isnt a JavaScript tutorial the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex068">Listing 13.68</a> is fine for our purposes.<span epub:type="pagebreak" id="page_698"></span></p>
<p class="ex-title" id="ch13ex068"><strong>Listing 13.68:</strong> Checking the file size with jQuery.</p>
<pre class="pre2">app/views/shared/_micropost_form.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-68a" id="lis13-68">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> form_with(<span class="colork8">model</span>: <span class="colork8">@micropost</span>, <span class="colork8">local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> |f| <span class="colork22">%&gt;</span>
  <span class="colork22">&lt;%=</span> render <span class="colork11">'shared/error_messages'</span>, <span class="colork8">object</span>: f.object <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"field"</span>&gt;
    <span class="colork22">&lt;%=</span> f.text_area :<span class="colork8">content</span>, <span class="colork8">placeholder</span>: <span class="colork22">"Compose new micropost..." %&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
  <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Post"</span>, <span class="colork8">class</span>: <span class="colork22">"btn btn-primary" %&gt;</span>
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"image"</span>&gt;
    <span class="colork22">&lt;%=</span> f.file_field :image <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>

<span class="mark">&lt;<strong><span class="colork15">script</span></strong> <span class="colork22">type=</span><span class="colork23">"text/javascript"&gt;</span></span>
<span class="mark">  $(<span class="colork23">"#micropost_image"</span>).bind(<span class="colork23">"change"</span>, <strong><span class="colork15">function</span></strong>() {</span>
<span class="mark">    <strong><span class="colork15">const</span></strong> size_in_megabytes = <strong><span class="colork15">this</span></strong>.<span class="colork23">files[0].size/1024/1024;</span></span>
<span epub:type="pagebreak" id="page_699"></span><span class="mark">    <strong><span class="colork15">if</span></strong> (size_in_megabytes <span class="colork22">&gt; 5</span>) {</span>
<span class="mark">      alert(<span class="colork22">"Maximum file size is 5MB. Please choose a smaller file."</span>);</span>
<span class="mark">      $(<span class="colork22">"#micropost_image"</span>).val(<span class="colork22">""</span>);</span>
<span class="mark">    }</span>
<span class="mark">  });</span>
&lt;/<strong><span class="colork10">script</span></strong>&gt;</pre>
</div>
<p class="noindent">Although JavaScript isnt the focus of this book, you might be able to figure out that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex068">Listing 13.68</a> monitors the page element containing the CSS id <span class="colork1"><code><strong>micropost_image</strong></code></span> (as indicated by the hash mark <span class="colork1"><code><strong>#</strong></code></span>), which is the id of the micropost form in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex061">Listing 13.61</a>. (The way to figure this out is to Ctrl-click and use your browsers web inspector.) When the element with that CSS id changes, the jQuery function fires and issues the <span class="colork1"><code><strong>alert</strong></code></span> method if the file is too big, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig027">Figure 13.27</a>.<sup><a id="ch13fn22a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn22">22</a></sup></p>
<figure id="ch13fig027" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_27.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_27.jpg">
<figcaption><p><strong>Figure 13.27:</strong> A JavaScript alert for a large file.</p></figcaption>
</figure>
<p class="footnote"><a id="ch13fn22" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn22a">22</a>. To learn how to do things like this, you can do what I did: Google for things like javascript maximum file size until you find something on Stack Overflow.</p>
<p class="indent">Finally, by using the <span class="colork1"><code><strong>accept</strong></code></span> parameter in the <span class="colork1"><code><strong>file_field</strong></code></span> input tag, we can specify that only valid formats should be allowed (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex069">Listing 13.69</a>).</p>
<p class="ex-title" id="ch13ex069"><strong>Listing 13.69:</strong> Allowing only valid image formats.</p>
<pre class="pre2">app/views/shared/_micropost_form.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-69a" id="lis13-69">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> form_with(<span class="colork8">model</span>: <span class="colork8">@micropost</span>, <span class="colork8">local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> |f| <span class="colork22">%&gt;</span>
  <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/error_messages'</span>, <span class="colork8">object</span>: f.object <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"field"</span>&gt;
    <span class="colork22">&lt;%=</span> f.text_area :content, placeholder: <span class="colork22">"Compose new micropost..." %&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
  <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Post"</span>, <span class="colork8">class</span>: <span class="colork22">"btn btn-primary" %&gt;</span>
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"image"</span>&gt;
<span class="mark">    <span class="colork22">&lt;%=</span> f.file_field :image, <span class="colork8">accept</span>: <span class="colork23">"image/jpeg,image/gif,image/png" %&gt;</span></span>
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>

&lt;<strong><span class="colork10">script</span></strong> <span class="colork22">type="text/javascript"</span>&gt;
  $(<span class="colork22">"#micropost_image"</span>).bind(<span class="colork22">"change"</span>, <strong><span class="colork15">function</span></strong>() {
    <strong><span class="colork10">var</span></strong> size_in_megabytes = <strong><span class="colork10">this</span></strong>.files[0].size<span class="colork8">/1024/1024</span>;
    <strong><span class="colork10">if</span></strong> (size_in_megabytes <span class="colork11">&gt; 5</span>) {
      alert(<span class="colork22">"Maximum file size is 5MB. Please choose a smaller file."</span>);
      $(<span class="colork22">"#micropost_image"</span>).val(<span class="colork22">""</span>);
    }
  });
&lt;/<strong><span class="colork10">script</span></strong>&gt;</pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_700"></span><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex069">Listing 13.69</a> arranges to allow only valid image types to be selected in the first place, graying out any other file types (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig028">Figure 13.28</a>).</p>
<figure id="ch13fig028" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_28.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_28.jpg">
<figcaption><p><strong>Figure 13.28:</strong> Grayed-out invalid file types.</p></figcaption>
</figure>
<p class="indent">Preventing invalid images from being uploaded in a browser is a nice touch, but its important to understand that this sort of code can only make it <em>difficult</em> to upload an invalid format or large file; a user determined to upload an invalid file can always issue a direct <code>POST</code> request using, for example, <span class="colork1"><code><strong>curl</strong></code></span>. It is thus essential to include server-side validations of the type shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex067">Listing 13.67</a>.</p>
<section>
<h5 class="h5" id="lev162">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_701"></span></p>
<ol class="num">
<li><p class="num">What happens if you try uploading an image bigger than 5 megabytes?</p></li>
<li><p class="num">What happens if you try uploading a file with an invalid extension?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_4_3">13.4.3 Image Resizing</h4>
<p class="noindent">The image size validations in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_2">Section 13.4.2</a> are a good start, but they still allow the uploading of images large enough to break our sites layout, sometimes with frightening results (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig029">Figure 13.29</a>). Thus, while its convenient to allow users to select fairly large images from their local disk, its also a good idea to resize the images before displaying them.<sup><a id="ch13fn23a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn23">23</a></sup></p>
<figure id="ch13fig029" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_29.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_29.jpg">
<figcaption><p><strong>Figure 13.29:</strong> A frighteningly large uploaded image.</p></figcaption>
</figure>
<p class="footnote"><a id="ch13fn23" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn23a">23</a>. Its possible to constrain the <em>display</em> size with CSS, but this doesnt change the image size. In particular, large images would still take a while to load. (Youve probably visited websites where small images seemingly take forever to load. This is why.)<span epub:type="pagebreak" id="page_702"></span></p>
<p class="indent">Well be resizing images using the image manipulation program ImageMagick, which we need to install on the development environment. (As well see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_4">Section 13.4.4</a>, when we use Heroku for deployment, ImageMagick comes pre-installed in production.) On the cloud IDE, we can do this as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg702-1a" id="pg702-1">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> sudo apt-get -y install imagemagick</pre>
<p class="noindent">(If youre not using the cloud IDE or an equivalent Linux system, do a Google search for imagemagick &lt;your platform&gt;. On macOS, <span class="colork1"><code><strong>brew install imagemagick</strong></code></span> should work if you have Homebrew installed. Use your technical sophistication (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#box1_2">Box 1.2</a>) if you get stuck.)</p>
<p class="indent">Next, we need to add a couple of gems for image processing, including the aptly named <code>image_processing</code> gem and <code>mini_magick</code>, a Ruby processor for ImageMagick (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex070">Listing 13.70</a>).<span epub:type="pagebreak" id="page_703"></span></p>
<p class="ex-title" id="ch13ex070"><strong>Listing 13.70:</strong> Adding gems for image processing.</p>
<pre class="pre2">Gemfile</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-70a" id="lis13-70">Click here to view code image</a></p>
<div class="example">
<pre>source <span class="colork22">'https://rubygems.org'</span>
git_source(<span class="colork8">:github</span>) { |repo| <span class="colork22">"https://github.com</span>/<strong><span class="grayk1">#{</span></strong>repo<strong><span class="grayk1">}</span></strong><span class="colork22">.git"</span> }

gem <span class="colork22">'rails'</span>,                      <span class="colork22">'6.0.2.1'</span>
<span class="mark">gem <span class="colork22">'image_processing'</span>,           <span class="colork22">'1.9.3'</span></span>
<span class="mark">gem <span class="colork22">'mini_magick'</span>,                <span class="colork22">'4.9.5'</span></span>
gem <span class="colork22">'active_storage_validations'</span>, <span class="colork22">'0.8.2'</span>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong></pre>
</div>
<p class="indent">Then install as usual:</p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> bundle install</pre>
<p class="noindent">You will probably need to restart the Rails server as well.</p>
<p class="indent">With the necessary software installed, were now ready to use the <span class="colork1"><code><strong>variant</strong></code></span> method supplied by Active Storage for creating transformed images. In particular, well use the <span class="colork1"><code><strong>resize_to_limit</strong></code></span> option to ensure that neither the width nor the height of the image is greater than 500 pixels, as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg703-1a" id="pg703-1">Click here to view code image</a></p>
<pre class="pre1">image.variant(<span class="colork25">resize_to_limit</span>: <span class="colork25">[500</span>, <span class="colork25">500]</span>)</pre>
<p class="noindent">For convenience, well put this code in a separate <span class="colork1"><code><strong>display_image</strong></code></span> method, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex071">Listing 13.71</a>.</p>
<p class="ex-title" id="ch13ex071"><strong>Listing 13.71:</strong> Adding a resized display image.</p>
<pre class="pre2">app/models/micropost.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-71a" id="lis13-71">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork5">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:user</span>
  has_one_attached <span class="colork8">:image</span>
  default_scope -&gt; { order(<span class="colork8">created_at</span>: <span class="colork8">:desc</span>) }
  validates <span class="colork8">:user_id</span>, <span class="colork8">presence</span>: <strong><span class="colork10">true</span></strong>
  validates <span class="colork8">:content</span>, <span class="colork8">presence</span>: <strong><span class="colork10">true</span></strong>, <span class="colork8">length</span>: { <span class="colork8">maximum</span>: <span class="colork8">140</span> }
  validates :<span class="colork8">image</span>,   <span class="colork8">content_type</span>: { <strong><span class="colork15">in</span></strong>: <span class="colork25">%w[image/jpeg image/gif image/png]</span>,
                                      <span class="colork8">message</span>: <span class="colork22">"must be a valid image format"</span> },
                      <span class="colork8">size</span>: { <span class="colork8">less_than</span>: <span class="colork8">5</span>.megabytes,
                            <span class="colork8">message</span>:     <span class="colork22">"should be less than 5MB"</span> }
<span epub:type="pagebreak" id="page_704"></span>  <span class="colork8"># Returns a resized image for display.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">display_image</span>
<span class="mark">    image.variant(resize_to_limit: <span class="redk1">[500, 500]</span>)</span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Finally, we can use <span class="colork1"><code><strong>display_image</strong></code></span> in the micropost partial, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex072">Listing 13.72</a>.</p>
<p class="ex-title" id="ch13ex072"><strong>Listing 13.72:</strong> Using the resized <span class="colork1"><code><strong>display_image</strong></code></span>.</p>
<pre class="pre2">app/views/microposts/_micropost.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-72a" id="lis13-72">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<strong><span class="colork10">li</span></strong> <span class="colork22">id=</span><span class="colork23">"micropost-&lt;%=</span> micropost.id <span class="colork22">%&gt;"</span>&gt;
  <span class="colork22">&lt;%=</span> link_to gravatar_for(micropost.user, <span class="colork8">size</span>: <span class="colork8">50</span>), micropost.user <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class=</span><span class="colork23">"user"</span>&gt;<span class="colork22">&lt;%=</span> link_to micropost.user.name, micropost.user <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"content"</span>&gt;
    <span class="colork22">&lt;%=</span> micropost.content <span class="colork22">%&gt;</span>
<span class="mark">    <span class="colork22">&lt;%=</span> image_tag micropost.display_image <strong><span class="colork15">if</span></strong> micropost.image.attached? <span class="colork23">%&gt;</span></span>
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
  &lt;<strong><span class="colork10">span</span></strong> <span class="colork22">class</span><span class="colork9">=</span><span class="colork23">"timestamp"</span>&gt;
    Posted <span class="colork22">&lt;%=</span> time_ago_in_words(micropost.created_at) <span class="colork22">%&gt;</span> ago.
    <span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> current_user?(micropost.user) <span class="colork22">%&gt;</span>
      <span class="colork22">&lt;%=</span> link_to <span class="colork22">"delete"</span>, micropost, <span class="colork8">method</span>: :<span class="colork8">delete</span>,
                                       <span class="colork8">data</span>: { <span class="colork8">confirm</span>: <span class="colork22">"You sure?"</span> } <span class="colork22">%&gt;</span>
    <span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">span</span></strong>&gt;
&lt;/<strong><span class="colork10">li</span></strong>&gt;</pre>
</div>
<p class="noindent">The <span class="colork1"><code><strong>variant</strong></code></span> resizing in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex071">Listing 13.71</a> will happen on demand when the method is first called in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex072">Listing 13.72</a>, and will be cached for efficiency in subsequent uses.<sup><a id="ch13fn24a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn24">24</a></sup> The result is a properly resized display image, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig030">Figure 13.30</a>.</p>
<figure id="ch13fig030" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_30.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_30.jpg">
<figcaption><p><strong>Figure 13.30:</strong> A nicely resized image.</p></figcaption>
</figure>
<p class="footnote"><a id="ch13fn24" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn24a">24</a>. For larger sites, its probably better to defer such processing to a background process. This method is beyond the scope of this tutorial, but investigating Active Job will get you started if you need to go this route.</p>
<section>
<h5 class="h5" id="lev163">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_705"></span></p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Upload a large image and confirm directly that the resizing is working. Does the resizing work even if the image isnt square?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec13_4_4">13.4.4 Image Upload in Production</h4>
<p class="noindent">The image uploading developed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_3">Section 13.4.3</a> is good enough for development, but (as seen later in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex074">Listing 13.74</a>) it uses the local disk for storing the images, which isnt a good practice in production. (Among other things, file storage on Heroku is temporary, so uploaded images will be deleted every time you deploy.) Instead, well use a cloud storage service to store images separately from our application.<span epub:type="pagebreak" id="page_706"></span></p>
<p class="indent">There are many choices for cloud storage, but well use one of the most popular and well supported, Amazon.coms Simple Storage Service (S3), part of Amazon Web Services (AWS).<sup><a id="ch13fn25a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn25">25</a></sup></p>
<p class="footnote"><a id="ch13fn25" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn25a">25</a>. S3 is a paid service, but the storage needed to set up and test the Rails Tutorial sample application costs less than a cent per month.</p>
<p class="indent">To configure our application to use cloud storage in production, well add the <code>aws-sdk-s3</code> gem to the <span class="colork1"><code><strong>:production</strong></code></span> environment, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex073">Listing 13.73</a>.</p>
<p class="ex-title" id="ch13ex073"><strong>Listing 13.73:</strong> Adding a gem for Amazon Web Services (AWS).</p>
<pre class="pre2">Gemfile</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-73a" id="lis13-73">Click here to view code image</a></p>
<div class="example">
<pre>source <span class="colork22">'https://rubygems.org'</span>
git_source(:<span class="colork8">github</span>) { |repo| <span class="colork22">"https://github.com/</span><strong><span class="grayk1">#{</span></strong>repo<strong><span class="grayk1">}</span></strong><span class="colork22">.git"</span> }

gem <span class="colork22">'rails'</span>,                      <span class="colork22">'6.0.2.1'</span>
gem <span class="colork22">'image_processing'</span>,           <span class="colork22">'1.9.3'</span>
gem <span class="colork22">'mini_magick'</span>,                <span class="colork22">'4.9.5'</span>
gem <span class="colork22">'active_storage_validations'</span>, <span class="colork22">'0.8.2'</span>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong>
group :<span class="colork8">production</span> <strong><span class="colork10">do</span></strong>
  gem <span class="colork22">'pg'</span>,         <span class="colork22">'1.1.4'</span>
<span class="mark">  gem <span class="colork23">'aws-sdk-s3'</span>, <span class="colork23">'1.46.0'</span>, <span class="colork23">require</span>: <strong><span class="colork15">false</span></strong></span>
<strong><span class="colork10">end</span></strong>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong></pre>
</div>
<p class="noindent">Then <span class="colork1"><code><strong>bundle</strong></code></span> one more time:</p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> bundle install</pre>
<section>
<h5 class="h5" id="lev164">AWS Configuration</h5>
<p class="noindent">At this point, youll need to configure your AWS system to use S3. Here are the basic steps:<sup><a id="ch13fn26a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn26">26</a></sup></p>
<p class="footnote"><a id="ch13fn26" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn26a">26</a>. The steps are current as of this writing, but services like AWS are constantly evolving, so the user interface may have changed in the interim. Use your technical sophistication to resolve any discrepancies.<span epub:type="pagebreak" id="page_707"></span></p>
<ol class="num">
<li><p class="num">Sign up for an Amazon Web Services account if you dont have one already (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig031">Figure 13.31</a>). (If you signed up for the Cloud9 IDE in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#sec1_1_1">Section 1.1.1</a>, you already have an AWS account and can skip this step.)</p>
<figure id="ch13fig031" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_31.jpg" alt="Image" width="750" height="483" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_31.jpg">
<figcaption><p><strong>Figure 13.31:</strong> Signing up for AWS.</p></figcaption>
</figure></li>
<li><p class="num">Create a user via AWS Identity and Access Management (IAM). This involves using the IAM users interface (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig032">Figure 13.32</a>) to navigate to the Add user page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig033">Figure 13.33</a>), where you should create a user while enabling programmatic access (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig034">Figure 13.34</a>), grant the user administrator access (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig035">Figure 13.35</a>), and then skip the optional user tags (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig036">Figure 13.36</a>).</p>
<figure id="ch13fig032" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_32.jpg" alt="Image" width="751" height="206" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_32.jpg">
<figcaption><p><strong>Figure 13.32:</strong> The AWS IAM interface.<span epub:type="pagebreak" id="page_708"></span></p></figcaption>
</figure>
<figure id="ch13fig033" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_33.jpg" alt="Image" width="613" height="1257" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_33.jpg">
<figcaption><p><strong>Figure 13.33:</strong> Navigating to the Add user page.<span epub:type="pagebreak" id="page_709"></span></p></figcaption>
</figure>
<figure id="ch13fig034" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_34.jpg" alt="Image" width="750" height="351" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_34.jpg">
<figcaption><p><strong>Figure 13.34:</strong> Creating a user with programmatic access.</p></figcaption>
</figure>
<figure id="ch13fig035" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_35.jpg" alt="Image" width="750" height="320" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_35.jpg">
<figcaption><p><strong>Figure 13.35:</strong> Granting the user administrator access.</p></figcaption>
</figure>
<figure id="ch13fig036" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_36.jpg" alt="Image" width="750" height="512" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_36.jpg">
<figcaption><p><strong>Figure 13.36:</strong> Skipping optional user tags.</p></figcaption>
</figure></li>
<li><p class="num">After clicking Create user, you should see the name of the user together with the access key ID and the secret access key (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig037">Figure 13.37</a>). Copy these keys and store them someplace safe.<span epub:type="pagebreak" id="page_710"></span></p>
<figure id="ch13fig037" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_37.jpg" alt="Image" width="751" height="93" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_37.jpg">
<figcaption><p><strong>Figure 13.37:</strong> Displaying the access key ID and the secret access key.</p></figcaption>
</figure></li>
<li><p class="num">Create an S3 bucket using the AWS Console (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig038">Figure 13.38</a>). S3 buckets exist in a global namespace, so the name has to be unique, but otherwise the default bucket settings should be fine.</p>
<figure id="ch13fig038" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_38.jpg" alt="Image" width="751" height="269" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_38.jpg">
<figcaption><p><strong>Figure 13.38:</strong> Creating an AWS bucket.</p></figcaption>
</figure></li>
</ol>
<p class="indent">You may find setting up S3 to be a challenging exercise in technical sophistication (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#box1_2">Box 1.2</a>). For further details on the steps presented here, consult the S3 documentation (<a href="http://aws.amazon.com/documentation/s3">aws.amazon.com/documentation/s3</a>), the article Setting up Rails 5 [or Higher] with Active Storage with Amazon S3 (<a href="http://medium.com/alturasoluciones/setting-up-rails-5-active-storage-with-amazon-s3-3d158cf021ff">medium.com/alturasoluciones/setting-up-rails-5-active-storage-with-amazon-s3-3d158cf021ff</a>), and, if necessary, Google or Stack Overflow.<span epub:type="pagebreak" id="page_711"></span></p>
</section>
<section>
<h5 class="h5" id="lev165">Production AWS</h5>
<p class="noindent">As with production email configuration (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex041">Listing 11.41</a>), well be using Heroku <span class="colork1"><code><strong>ENV</strong></code></span> variables to avoid hard-coding sensitive information like AWS keys. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_4">Section 11.4</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#sec12_4">Section 12.4</a>, these variables were defined automatically via the SendGrid add-on, but in this case we need to define them explicitly. Per the gem configuration documentation (<a href="http://github.com/aws/aws-sdk-ruby#configuration">github.com/aws/aws-sdk-ruby#configuration</a>), these variables should be named using the prefix <span class="colork1"><code><strong>AWS</strong></code></span>, which we can accomplish using <span class="colork1"><code><strong>heroku config:set</strong></code></span> as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg711-1a" id="pg711-1">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> heroku config:set <span class="colork26">AWS_ACCESS_KEY_ID=</span>&lt;access key&gt;
<strong><span class="colork2">$</span></strong> heroku config:set <span class="colork26">AWS_SECRET_ACCESS_KEY=</span>&lt;secret key&gt;
<strong><span class="colork2">$</span></strong> heroku config:set <span class="colork26">AWS_REGION=</span>&lt;region&gt;
<strong><span class="colork2">$</span></strong> heroku config:set <span class="colork26">AWS_BUCKET=</span>&lt;bucket name&gt;</pre>
<p class="noindent">You should paste in the values for your configuration in place of the placeholder values shown here. To get the region, you can inspect the URL on the S3 console page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig039">Figure 13.39</a>).</p>
<figure id="ch13fig039" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_39.jpg" alt="Image" width="751" height="50" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_39.jpg">
<figcaption><p><strong>Figure 13.39:</strong> Getting the AWS region from the S3 console URL.</p></figcaption>
</figure>
<p class="indent">Once the Heroku variables are set, the next step is to use them in a special YAML file for configuring storage options called <span class="colork1"><code><strong>storage.yml</strong></code></span>. We can create a storage option for Amazon using the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex074">Listing 13.74</a>.<span epub:type="pagebreak" id="page_712"></span></p>
<p class="ex-title" id="ch13ex074"><strong>Listing 13.74:</strong> Adding Amazon AWS as a storage option.</p>
<pre class="pre2">config/storage.yml</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-74a" id="lis13-74">Click here to view code image</a></p>
<div class="example">
<pre>test:
  service: Disk
  root: <span class="colork22">&lt;%=</span> Rails.root.join("tmp/storage") <span class="colork22">%&gt;</span>

local:
  service: Disk
  root: <span class="colork22">&lt;%=</span> Rails.root.join("storage") <span class="colork22">%&gt;</span>

<span class="mark">amazon:</span>
<span class="mark">  service: S3</span>
<span class="mark">  access_key_id:     <span class="colork22">&lt;%=</span> ENV['AWS_ACCESS_KEY_ID'] <span class="colork23">%&gt;</span></span>
<span class="mark">  secret_access_key: <span class="colork22">&lt;%=</span> ENV['AWS_SECRET_ACCESS_KEY'] <span class="colork23">%&gt;</span></span>
<span class="mark">  region:            <span class="colork22">&lt;%=</span> ENV['AWS_REGION'] <span class="colork23">%&gt;</span></span>
<span class="mark">  bucket:            <span class="colork22">&lt;%=</span> ENV['AWS_BUCKET'] %&gt;</span></pre>
</div>
<p class="indent">Finally, we can put the option defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex074">Listing 13.74</a> to use in a production environment by adding the Active Storage service configuration parameter in <span class="colork1"><code><strong>production.rb</strong></code></span>. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex075">Listing 13.75</a>.</p>
<p class="ex-title" id="ch13ex075"><strong>Listing 13.75:</strong> Configuring the production environment to use Amazon AWS (S3).</p>
<pre class="pre2">config/environments/production.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-75a" id="lis13-75">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork11">Rails</span>.application.configure <strong><span class="colork10">do</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
<span class="mark">  <span class="colork8"># Store uploaded files on Amazon AWS.</span></span>
<span class="mark">  config.active_storage.service = :amazon</span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">With this configuration, we are ready to commit our changes and deploy:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg712-1a" id="pg712-1">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git add -A
$ git commit -m "Add user microposts"</pre>
<p class="noindent">Because so many things can go wrong with the configuration, well deploy the app directly from our current topic branch, making sure its working before merging into <span epub:type="pagebreak" id="page_713"></span><code><strong>master</strong></code>. We can do this by including the branch name in the push to Heroku as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg713-1a" id="pg713-1">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> git push heroku user-microposts:master</pre>
<p class="noindent">As usual, we then reset the database and reseed the sample data:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg713-2a" id="pg713-2">Click here to view code image</a></p>
<pre class="pre1">$ heroku pg:reset DATABASE
$ heroku run rails db:migrate
$ heroku run rails db:seed</pre>
<p class="noindent">Because Heroku comes with ImageMagick already installed, the result is successful image resizing and upload in production, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig040">Figure 13.40</a>.</p>
<figure id="ch13fig040" class="image-l">
<img src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/fig13_40.jpg" alt="Image" width="750" height="579" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig13_40.jpg">
<figcaption><p><strong>Figure 13.40:</strong> An uploaded image in production.<span epub:type="pagebreak" id="page_714"></span></p></figcaption>
</figure>
</section>
<section>
<h5 class="h5" id="lev166">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Upload a large image and confirm directly that the resizing is working in production. Does the resizing work even if the image isnt square?</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec13_5">13.5 Conclusion</h3>
<p class="noindent">With the addition of the Microposts resource, we are nearly finished with our sample application. All that remains is to add a social layer by letting users follow each other. Well learn how to model such user relationships, and see the implications for the microposts feed, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">Chapter 14</a>.</p>
<p class="indent">If you skipped <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_4">Section 13.4.4</a>, be sure to commit your changes:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg714-1a" id="pg714-1">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git add -A
$ git commit -m "Add user microposts"</pre>
<p class="noindent">Then merge into <span class="colork1"><code><strong>master</strong></code></span>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg714-2a" id="pg714-2">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> git checkout master
<strong><span class="colork2">$</span></strong> git merge user-microposts
<strong><span class="colork2">$</span></strong> git push</pre>
<p class="noindent">And finally deploy to production:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#pg714-3a" id="pg714-3">Click here to view code image</a></p>
<pre class="pre1">$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rails db:migrate
$ heroku run rails db:seed</pre>
<p class="indent">Its worth noting that this chapter saw the last of the necessary gem installations. For reference, the final <span class="colork1"><code><strong>Gemfile</strong></code></span> is shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex076">Listing 13.76</a>.<sup><a id="ch13fn27a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn27">27</a></sup></p>
<p class="footnote"><a id="ch13fn27" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fn27a">27</a>. As always, you should use the version numbers listed at <a href="http://gemfiles-6th-ed.railstutorial.org/">gemfiles-6th-ed.railstutorial.org</a> instead of the ones listed here.<span epub:type="pagebreak" id="page_715"></span></p>
<p class="ex-title" id="ch13ex076"><strong>Listing 13.76:</strong> The final <span class="colork1"><code><strong>Gemfile</strong></code></span> for the sample application.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13_images.xhtml#lis13-76a" id="lis13-76">Click here to view code image</a></p>
<div class="example">
<pre>source <span class="colork22">'https://rubygems.org'</span>
git_source(:github) { |repo| <span class="colork22">"https://github.com/</span><strong><span class="grayk1">#{</span></strong>repo<strong><span class="grayk1">}</span></strong><span class="colork22">.git"</span> }

gem <span class="colork22">'rails'</span>,                      <span class="colork22">'6.0.2.1'</span>
gem <span class="colork22">'image_processing'</span>,           <span class="colork22">'1.9.3'</span>
gem <span class="colork22">'mini_magick'</span>,                <span class="colork22">'4.9.5'</span>
gem <span class="colork22">'active_storage_validations'</span>, <span class="colork22">'0.8.2'</span>
gem <span class="colork22">'bcrypt'</span>,                     <span class="colork22">'3.1.13'</span>
gem <span class="colork22">'faker'</span>,                      <span class="colork22">'2.1.2'</span>
gem <span class="colork22">'will_paginate'</span>,              <span class="colork22">'3.1.8'</span>
gem <span class="colork22">'bootstrap-will_paginate'</span>,    <span class="colork22">'1.0.0'</span>
gem <span class="colork22">'bootstrap-sass'</span>,             <span class="colork22">'3.4.1'</span>
gem <span class="colork22">'puma'</span>,                       <span class="colork22">'3.12.2'</span>
gem <span class="colork22">'sass-rails'</span>,                 <span class="colork22">'5.1.0'</span>
gem <span class="colork22">'webpacker'</span>,                  <span class="colork22">'4.0.7'</span>
gem <span class="colork22">'turbolinks'</span>,                 <span class="colork22">'5.2.0'</span>
gem <span class="colork22">'jbuilder'</span>,                   <span class="colork22">'2.9.1'</span>
gem <span class="colork22">'bootsnap'</span>,                   <span class="colork22">'1.4.5'</span>, <span class="colork22">require</span>: <strong><span class="colork10">false</span></strong>

group :<span class="colork8">development</span>, :<span class="colork8">test</span> <strong><span class="colork10">do</span></strong>
  gem <span class="colork22">'sqlite3'</span>, <span class="colork22">'1.4.1'</span>
  gem <span class="colork22">'byebug'</span>,  <span class="colork22">'11.0.1'</span>, <span class="colork8">platforms</span>: <span class="colork8">[:mri</span>, <span class="colork8">:mingw</span>, <span class="colork8">:x64_mingw]</span>
<strong><span class="colork10">end</span></strong>

group :<span class="colork8">development</span> <strong><span class="colork10">do</span></strong>
  gem <span class="colork22">'web-console'</span>,           <span class="colork22">'4.0.1'</span>
  gem <span class="colork22">'listen'</span>,                <span class="colork22">'3.1.5'</span>
  gem <span class="colork22">'spring'</span>,                <span class="colork22">'2.1.0'</span>
  gem <span class="colork22">'spring-watcher-listen'</span>, <span class="colork22">'2.0.1'</span>
<strong><span class="colork10">end</span></strong>

group :<span class="colork8">test</span> <strong><span class="colork10">do</span></strong>
  gem <span class="colork22">'capybara'</span>,                 <span class="colork22">'3.28.0'</span>
  gem <span class="colork22">'selenium-webdriver'</span>,       <span class="colork22">'3.142.4'</span>
  gem <span class="colork22">'webdrivers'</span>,               <span class="colork22">'4.1.2'</span>
  gem <span class="colork22">'rails-controller-testing'</span>, <span class="colork22">'1.0.4'</span>
  gem <span class="colork22">'minitest'</span>,                 <span class="colork22">'5.11.3'</span>
  gem <span class="colork22">'minitest-reporters'</span>,       <span class="colork22">'1.3.8'</span>
  gem <span class="colork22">'guard'</span>,                    <span class="colork22">'2.15.0'</span>
  gem <span class="colork22">'guard-minitest'</span>,           <span class="colork22">'2.4.6'</span>
<strong><span class="colork10">end</span></strong>

group :<span class="colork8">production</span> <strong><span class="colork10">do</span></strong>
  gem <span class="colork22">'pg'</span>,         <span class="colork22">'1.1.4'</span>
<span epub:type="pagebreak" id="page_716"></span>  gem <span class="colork22">'aws-sdk-s3'</span>, <span class="colork22">'1.46.0'</span>, <span class="colork22">require</span>: <strong><span class="colork10">false</span></strong>
<strong><span class="colork10">end</span></strong>

<span class="colork8"># Windows does not include zoneinfo files, so bundle the tzinfo-data gem</span>
gem <span class="colork22">'tzinfo-data'</span>, <span class="colork8">platforms</span>: <span class="colork8">[:mingw</span>, <span class="colork8">:mswin</span>, <span class="colork8">:x64_mingw</span>, <span class="colork8">:jruby]</span></pre>
</div>
<section>
<h4 class="h4" id="sec13_5_1">13.5.1 What We Learned in this Chapter</h4>
<p class="bullet"> Microposts, like Users, are modeled as a resource backed by an Active Record model.</p>
<p class="bullet"> Rails supports multiple-key indices.</p>
<p class="bullet"> We can model a user having many microposts using the <span class="colork1"><code><strong>has_many</strong></code></span> and <span class="colork1"><code><strong>belongs_to</strong></code></span> methods in the User and Micropost models, respectively.</p>
<p class="bullet"> The <span class="colork1"><code><strong>has_many</strong></code></span>/<code><strong>belongs_to</strong></code> combination gives rise to methods that work through the association.</p>
<p class="bullet"> The code <span class="colork1"><code><strong>user.microposts.build(...)</strong></code></span> returns a new Micropost object automatically associated with the given user.</p>
<p class="bullet"> Rails supports default ordering via <span class="colork1"><code><strong>default_scope</strong></code></span>.</p>
<p class="bullet"> Scopes take anonymous functions as arguments.</p>
<p class="bullet"> The <span class="colork1"><code><strong>dependent: :destroy</strong></code></span> option causes objects to be destroyed at the same time as associated objects.</p>
<p class="bullet"> Pagination and object counts can both be performed through associations, leading to automatically efficient code.</p>
<p class="bullet"> Fixtures support the creation of associations.</p>
<p class="bullet"> It is possible to pass variables to Rails partials.</p>
<p class="bullet"> The <span class="colork1"><code><strong>where</strong></code></span> method can be used to perform Active Record selections.</p>
<p class="bullet"> We can enforce secure operations by always creating and destroying dependent objects through their association.</p>
<p class="bullet"> We can upload images using Active Storage.</p>
</section>
</section>
</section>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-15" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 12. Password Reset</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 14. Following Users</div>
        </a>
    
  
  </div>

</section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed slideUp">
        
        
          <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        

        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
  <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright"> 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(1)" charset="utf-8"></script><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/embed.js.download"></script>
    <script src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(2)" charset="utf-8"></script>
  

<div></div><div></div><div class="selection_bubble_root" style="display: none;"></div><div class="annotator-notice"></div><div class="font-flyout" style="top: 201.006px; left: 1194.34px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#">Reset</a>
</div>
</div><script type="text/javascript" async="" src="./Chapter 13. User Microposts - Ruby on Rails Tutorial, 6th Edition_files/generic1604331345324.js.download" charset="UTF-8"></script><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script><span></span><script type="text/javascript" id="">dataLayer.push({"ld.experiment":void 0,"ld.variation":void 0});</script><div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size2, sans-serif;"></div></div></body></html>