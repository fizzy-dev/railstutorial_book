<!DOCTYPE html>
<!-- saved from url=(0080)https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage no-applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/ruby-on-rails/9780136702726/ch10.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="10224494" data-user-uuid="66943332-5511-462c-876e-5d5b720c7edf" data-username="czjtgu3dkobug4zdmolfga2wembsmu" data-account-type="Trial" data-activated-trial-date="12/02/2020" data-archive="9780136702726" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch10.xhtml" data-epub-title="Ruby on Rails Tutorial, 6th Edition" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780136702726"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/css" rel="stylesheet" type="text/css"><title>Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition</title><link rel="stylesheet" href="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/output.731fc84c4f9a.css" type="text/css"><link rel="stylesheet" type="text/css" href="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/font-awesome.min.css"><style type="text/css" title="ibis-book">@page{margin:1em 2em}#sbo-rt-content div{margin-top:1em;margin-bottom:1em;margin-left:1em;margin-right:1em;text-align:justify}#sbo-rt-content div.cover img{max-width:99%;max-height:99%}#sbo-rt-content .att{text-align:right}#sbo-rt-content .cover{margin-top:.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .h1{margin-top:1.5em;margin-bottom:.5em;font-weight:bold;font-size:210%;page-break-after:avoid;border-bottom:solid .1em;text-align:center}#sbo-rt-content .halftitle{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:210%;page-break-after:avoid;text-align:center}#sbo-rt-content .h2{margin-top:1em;margin-bottom:.1em;font-weight:bold;font-size:180%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2f{margin-top:1em;margin-bottom:2.5em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2t{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .center{text-align:center}#sbo-rt-content .h3{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:160%;page-break-after:avoid;text-align:left}#sbo-rt-content .h4{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:130%;page-break-after:avoid;text-align:left}#sbo-rt-content .h5{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:120%;page-break-after:avoid;text-align:left}#sbo-rt-content ul{margin-top:1em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content ul.sq{list-style-type:square}#sbo-rt-content ul.sq li p,#sbo-rt-content ul.sq li p.noindent{margin-top:.5em;margin-left:1em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .left{text-align:left}#sbo-rt-content .ex-title{margin-top:.8em;margin-bottom:.5em;text-indent:.1em;font-size:100%}#sbo-rt-content code{font-family:Courier,Courier New,monospace;font-size:small}#sbo-rt-content pre{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small}#sbo-rt-content .pre3{font-family:Courier,Courier New,monospace;margin-top:1em;margin-bottom:1em;margin-left:2.9em;background-color:#E6E6E6}#sbo-rt-content .equ{margin-top:.8em;margin-bottom:.5em;text-align:center}#sbo-rt-content .footnum{margin-top:.7em;margin-bottom:.5em;text-indent:-1em;margin-left:3.3em}#sbo-rt-content .footnotep{margin-top:.8em;margin-left:.8em;margin-bottom:.5em;text-indent:.8em}#sbo-rt-content .mark1{background-color:#F4F7F9}#sbo-rt-content .codelink{margin-top:.2em;margin-bottom:.5em}#sbo-rt-content .middle img{vertical-align:middle}#sbo-rt-content .box{margin-top:.6em;margin-bottom:1em;margin-left:.1em;margin-right:.8em;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .box-bq{font-size:.8em;margin-top:.8em;margin-bottom:.5em;margin-left:1.6em;text-indent:.1em;background-color:#E6E6E6}#sbo-rt-content .boxip{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:.8em;background-color:#E6E6E6}#sbo-rt-content ol.num{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p,#sbo-rt-content ol.num li p.number{margin-top:.5em;margin-left:.2em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .num-p{margin-top:.5em;margin-bottom:.5em;margin-left:0}#sbo-rt-content .bullet{margin-top:.7em;margin-bottom:.5em;text-indent:-.8em;margin-left:2em}#sbo-rt-content .credit{margin-top:.1em;margin-bottom:.1em;text-indent:-1.5em;margin-left:2em}#sbo-rt-content .box-caption{margin-top:.1em;margin-bottom:1em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:left}#sbo-rt-content .example{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small;border-top:.02em solid black;border-bottom:.02em solid black}#sbo-rt-content .image-l{margin-top:.8em;margin-left:1em;text-align:center}#sbo-rt-content .topbot{margin-top:.8em;margin-bottom:.5em;border-bottom:solid black .1em;border-top:solid black .1em;text-indent:.1em}#sbo-rt-content .uln{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash1{margin-top:.7em;margin-bottom:.7em;margin-left:3em}#sbo-rt-content .tr{border-bottom:.1em solid black}#sbo-rt-content th{text-align:left}#sbo-rt-content td{padding-left:.1em;padding-top:0;padding-bottom:0;vertical-align:top;text-align:left}#sbo-rt-content .mark{background-color:#E6E6E6}#sbo-rt-content .pre1{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:0;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .pre2{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content .tab-thc{margin-top:.1em;margin-bottom:.1em;border-bottom:solid black .1em;text-align:center}#sbo-rt-content .tab-th{margin-top:.1em;border-bottom:solid black .1em;border-top:solid black .1em;text-align:left}#sbo-rt-content .author{margin-top:2.5em;margin-bottom:5.5em;text-align:center;font-size:120%}#sbo-rt-content .pub{margin-top:1.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .pub1{font-weight:bold;font-size:.9em;margin-top:.1em;margin-bottom:.5em;text-align:center}#sbo-rt-content .copy{margin-top:.9em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .copy1{margin-top:.9em;margin-bottom:.2em;text-indent:.02em}#sbo-rt-content .copy2{margin-top:.2em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .title{margin-top:1em;margin-bottom:.2em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:center}#sbo-rt-content .noindent{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .tab-para{margin-top:.1em;margin-bottom:.1em;margin-left:.1em;text-indent:0}#sbo-rt-content .tab-parai{margin-top:.1em;margin-bottom:.1em;margin-left:1.1em;text-indent:-1.1em}#sbo-rt-content .boxnp{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .toc-intro{margin-top:.1em;margin-bottom:.5em;margin-left:1.5em;text-align:left}#sbo-rt-content .tocchap{margin-top:1.5em;margin-bottom:.4em;margin-left:3.4em;text-indent:-4em}#sbo-rt-content .toclev1{margin-top:.4em;margin-bottom:.4em;margin-left:1em}#sbo-rt-content .toclev2{margin-top:.4em;margin-bottom:.4em;margin-left:2.6em}#sbo-rt-content .toclev1a{margin-top:.4em;margin-bottom:.4em;margin-left:.5em}#sbo-rt-content .toc-index{margin-top:2em;margin-bottom:.4em;margin-left:.7em}#sbo-rt-content .indexmain{margin-top:.4em;margin-bottom:.2em;margin-left:.8em;text-indent:-.8em}#sbo-rt-content .indexsub{margin-top:.4em;margin-bottom:.2em;margin-left:1.7em;text-indent:-.7em}#sbo-rt-content .indexsubsub{margin-top:.4em;margin-bottom:.2em;font-style:italic;margin-left:3em;text-indent:-.9em}#sbo-rt-content figcaption{margin-top:.8em;margin-bottom:.5em;color:black;text-align:left;text-indent:.1em}#sbo-rt-content .subtitle{margin-top:.1em;margin-bottom:1em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .edition{margin-top:2em;margin-bottom:3em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .indent{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:1.5em}#sbo-rt-content .h2a{margin-top:.1em;margin-bottom:2em;font-weight:bold;font-size:190%;page-break-after:avoid;text-align:left}#sbo-rt-content figure>img{max-width:99%;max-height:99%}#sbo-rt-content figure{margin-top:1em;margin-bottom:1em;margin-left:.5em;margin-right:1.5em}#sbo-rt-content none{list-style-type:none}#sbo-rt-content a{text-decoration:none}#sbo-rt-content .footnote{font-size:.8em;margin-top:.1em;margin-bottom:.5em;margin-left:.8em}#sbo-rt-content .none{margin-top:.5em;margin-left:1em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content div.image-p img{width:80%}#sbo-rt-content .image-p{page-break-before:always;text-align:center}#sbo-rt-content table{border-collapse:collapse;border-spacing:0;background:transparent;vertical-align:top;margin-top:.1em;margin-right:.1em;margin-bottom:.9em;margin-left:0;width:100%}#sbo-rt-content .tab-parar{margin-top:.1em;margin-bottom:.1em;text-indent:.1em;text-align:right}#sbo-rt-content .h2i{margin-top:1em;margin-bottom:2.1em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content pre{overflow:auto;-ms-overflow:auto;-moz-overflow:auto;-webkit-overflow:auto;-ms-padding-bottom:5pt;-moz-padding-bottom:5pt;-webkit-padding-bottom:5pt}#sbo-rt-content .maroon{color:#BB2121}#sbo-rt-content .green{color:#005A00}#sbo-rt-content .green1{color:#48785D}#sbo-rt-content .navy{color:#504B72}#sbo-rt-content .ash{color:#666}#sbo-rt-content .blue{color:#408080}#sbo-rt-content .green3{color:#00A100}#sbo-rt-content .blue1{color:#0000B8}#sbo-rt-content .violet{color:#1A177D}#sbo-rt-content .pink{color:#A131A1}#sbo-rt-content .pink1{color:#A131A1}#sbo-rt-content .red{color:#800}#sbo-rt-content .blue3{color:#2E3192}#sbo-rt-content .red2{color:#B80000}#sbo-rt-content .green4{color:#269200}#sbo-rt-content .ash1{color:#666}#sbo-rt-content .ash2{color:#33484A}#sbo-rt-content .red2{color:#640000}#sbo-rt-content .ash3{color:#7D8F29}#sbo-rt-content .red5{color:#BD7B00}#sbo-rt-content .maroon1{color:#B66600}#sbo-rt-content .blue5{color:#1F3BFF}#sbo-rt-content .red6{color:#B68}#sbo-rt-content .green7{color:#14B600}#sbo-rt-content .maroon2{color:#B66600}#sbo-rt-content .pink2{color:#AC21FF}#sbo-rt-content .pink3{color:#AC21FF}#sbo-rt-content .lighgreen{color:#5FA100}#sbo-rt-content .lighblue{color:#269271}#sbo-rt-content .darkmaroon{color:#269271}#sbo-rt-content .maroon5{color:#A10000}#sbo-rt-content .blue6{color:#0000B9}#sbo-rt-content .marko{background-color:#FAF9CE}#sbo-rt-content .green5{color:#1C8B43}#sbo-rt-content .colork1{color:#136433;font-weight:bold}#sbo-rt-content .colork2{color:#504C72}#sbo-rt-content .colork3{color:#51785D}#sbo-rt-content .colork4{color:#303192}#sbo-rt-content .colork5{color:#955744}#sbo-rt-content .colork6{color:#5C70BA}#sbo-rt-content .colork7{color:#487864}#sbo-rt-content .colork8{color:#5C5778}#sbo-rt-content .colork9{color:#666}#sbo-rt-content .colork10{color:#48785D}#sbo-rt-content .colork11{color:#BC654D}#sbo-rt-content .colork12{color:#3E8185}#sbo-rt-content .colork13{color:#C62425}#sbo-rt-content .colork14{color:#1D8C43}#sbo-rt-content .colork15{color:#0D8140}#sbo-rt-content .colork16{color:#BB2425}#sbo-rt-content .colork17{color:#985744}#sbo-rt-content .colork18{color:#6C8896}#sbo-rt-content .colork19{color:#2A2C80}#sbo-rt-content .colork20{color:#BD2425}#sbo-rt-content .redk1{color:#EE1C25}#sbo-rt-content .colork21{color:#2A2C77}#sbo-rt-content .colork22{color:#955744}#sbo-rt-content .colork23{color:#BC6561}#sbo-rt-content .colork24{color:#BE7D2B}#sbo-rt-content .colork25{color:#8E7C5D}#sbo-rt-content .colork26{color:#7C5778}#sbo-rt-content .colork27{color:#9D1C1F}#sbo-rt-content .colork28{color:#AA5744}#sbo-rt-content .colork29{color:#C59861}#sbo-rt-content .grayk1{color:#C0908E}#sbo-rt-content .pd_green{color:#48785d}#sbo-rt-content .dark-green{color:#146333}#sbo-rt-content .mark1{background-color:#faf9ce}#sbo-rt-content .mark{background-color:#faf9ce}#sbo-rt-content .pd_ash{color:#666}#sbo-rt-content .pd_blue7{color:#6c8896}#sbo-rt-content .pd_blue1{color:#504b72}#sbo-rt-content .pd_red{color:#965744}#sbo-rt-content .pd_red2{color:#bb654e}#sbo-rt-content .pd_red5{color:#ed1c24}#sbo-rt-content .pd_blue5{color:#2e3192}#sbo-rt-content .pd_green4{color:#269200}#sbo-rt-content .pd_green5{color:#1c8b43}#sbo-rt-content .pd_blue3{color:#2c2c78}#sbo-rt-content .pd_orange{color:#c49847}</style><script type="text/javascript" async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/cool-2.1.15.min.js.download"></script><script type="text/javascript" async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/ec.js.download"></script><script type="text/javascript" async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/analytics.js.download"></script><script type="text/javascript" async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/f.txt"></script><script type="text/javascript" async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/js"></script><script crossorigin="anonymous" integrity="sha256-NiDMmov61Y536X/eLXLiDGzFVFmNLtPyu4b5aFB54ks=" type="text/javascript" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/appcues.main.11e38ef4746fd64ab30c11794299d10b30bcb704.js.download" async=""></script><script async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/gtm.js.download"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780136702726/chapter/ch10.xhtml",
          "book_id": "9780136702726",
          "chapter_uri": "ch10.xhtml",
          "position": 27.4567491080775,
          "user_uuid": "66943332-5511-462c-876e-5d5b720c7edf",
          "next_chapter_uri": "/library/view/ruby-on-rails/9780136702726/ch11.xhtml"
        
      },
      title: "Ruby on Rails Tutorial, 6th Edition",
      author_list: "Michael Hartl",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: true
    };
    // ]]></script><script src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/modernizr.8e35451ddb64.js.download"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta name="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta property="og:title" content="Chapter 10. Updating, Showing, and Deleting Users"><meta itemprop="isPartOf" content="/library/view/ruby-on-rails/9780136702726/"><meta itemprop="name" content="Chapter 10. Updating, Showing, and Deleting Users"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780136702726/"><meta property="og:description" itemprop="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9780136702726"><meta property="og:book:author" itemprop="author" content="Michael Hartl"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '66943332-5511-462c-876e-5d5b720c7edf';
      dataLayer.push({userIdentifier: '66943332-5511-462c-876e-5d5b720c7edf'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = 'ba5f3401-307d-4b66-90a6-a97047c63525';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/vendor.3eecedff6f59.js.download"></script><script defer="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/reader.772cf1e31d6c.js.download"></script><iframe src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/saved_resource.html"></iframe><iframe src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(3).html"></iframe><iframe src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(4).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-q9sKb2HpA5fJjN1cK9LjLaEXff5ix81Rv1Y3xJFptPE=" crossorigin="anonymous" href="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/container.11e38ef4746fd64ab30c11794299d10b30bcb704.css"><iframe src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(5).html"></iframe><script src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/f(1).txt"></script><script async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/MathJax.js.download"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
</style><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style></head>


<body class="reading sidenav  scalefonts subscribe-panel library nav-collapsed"><div id="MathJax_Message" style="display: none;"></div>

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="working hide" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/66943332-5511-462c-876e-5d5b720c7edf/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Attend</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/live-training/" class="l2 nav-icn"><span>Live Trainings</span></a></li><li><a href="https://learning.oreilly.com/featured/architectural-katas" class="l2 nav-icn"><span>Architectural Katas</span></a></li><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interact</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/?classification=content-scenario" class="l2 nav-icn"><span>Scenarios</span></a></li><li><a href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario" class="l2 nav-icn"><span>Sandboxes</span></a></li><li><a href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li><a href="https://learning.oreilly.com/answers/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"></path></svg><span>Answers</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://learning.oreilly.com/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Ruby on Rails Tutorial, 6th Edition
      
    </h1></span></a><div class="toc-contents" style="max-height: 0px;">
  <div class="sbo-toc">
    <button type="button" class="sbo-toc-thumb close"><div class="visuallyhidden">Close</div></button>
      <section class="ios-app-teaser">
        <ul>
            <li><a class="js-toc-link toc-link" href="https://itunes.apple.com/gb/app/safari-queue-library-over/id881697395?mt=8" role="button">Install App</a></li>
            <li><a class="js-toc-link toc-link" href="safaridetail://9780136702726" role="button">Open in App</a></li>
        </ul>
      </section>
      <div class="sbo-book-meta">
        
        <span class="cover">
         <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">
          <img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/saved_resource" alt="Cover image for Ruby on Rails Tutorial, 6th Edition" height="184" width="141">
        </a>
        </span>
        <span class="title">
          
            
                <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
                  <img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/addison-wesley.png" class="publisher-logo video" alt="publisher logo">
                </a>
            
          

          <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">Ruby on Rails Tutorial, 6th Edition</a>
        </span>
        
        <span class="authors">by Michael Hartl</span>
        

        
        <span class="publishers t-publishers">Published by
          <!-- Show publisher page link if publisher pages switch is on -->
          
            <a class="t-publisher-link toc-link js-toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
              Addison-Wesley Professional</a>, 2020
          
        </span>
        

    

    </div>
  <ol class="tocList">
    
    
    
     

     <li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/cover.xhtml">
        Cover Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref00.xhtml">
        About This eBook <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/halftitle.xhtml">
        Halftitle Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/title.xhtml">
        Title Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/copy.xhtml">
        Copyright Page <span class="minutes">(02:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/toc.xhtml#toc">
        Contents <span class="minutes">(05:45 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref02.xhtml#pref02">
        Foreword <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref03.xhtml#pref03">
        Acknowledgments <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref04.xhtml#pref04">
        About the Author <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#ch01">
        Chapter 1. From Zero to Deploy <span class="minutes">(77:03 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">
        Chapter 2. A Toy App <span class="minutes">(50:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03">
        Chapter 3. Mostly Static Pages <span class="minutes">(63:15 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04">
        Chapter 4. Rails-Flavored Ruby <span class="minutes">(57:30 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">
        Chapter 5. Filling in the Layout <span class="minutes">(60:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">
        Chapter 6. Modeling Users <span class="minutes">(67:51 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">
        Chapter 7. Sign Up <span class="minutes">(79:21 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">
        Chapter 8. Basic Login <span class="minutes">(66:42 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">
        Chapter 9. Advanced Login <span class="minutes">(52:54 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1 currently-reading">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">
        Chapter 10. Updating, Showing, and Deleting Users <span class="minutes">(73:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">
        Chapter 11. Account Activation <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">
        Chapter 12. Password Reset <span class="minutes">(48:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">
        Chapter 13. User Microposts <span class="minutes">(106:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">
        Chapter 14. Following Users <span class="minutes">(78:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml#index">
        Index <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/credits.xhtml#credits">
        Credits <span class="minutes">(19:33 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01_images.xhtml#ch01_images">
        Code Snippets <span class="minutes">(09:12 mins)</span>
       </a>
      
        
      
   </li></ol>
 </div>



</div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780136702726/chapter/ch10.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li class="currently-reading"><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml&amp;text=Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition&amp;via=OReillyMedia"><span>Twitter</span></a></li><li class="currently-reading"><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Facebook</span></a></li><li class="currently-reading"><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Google Plus</span></a></li><li class="currently-reading"><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Chapter%2010.%20Updating%2C%20Showing%2C%20and%20Deleting%20Users&amp;body=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml%0D%0Afrom%20Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document"><script src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/48743.js.download"></script>
<script>
  var userId = "66943332-5511-462c-876e-5d5b720c7edf";

  var userObject = {
    firstName: "Trần",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2020-12-01",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 10. Updating, Showing, and Deleting Users</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 12. Password Reset</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section epub:type="chapter">
<h2 class="h2" id="ch11"><span epub:type="pagebreak" id="page_539"></span>Chapter 11</h2>
<h2 class="h2a">Account Activation</h2>
<p class="noindent">At present, newly registered users immediately have full access to their accounts (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>); in this chapter, we’ll implement an account activation step to verify that the user controls the email address they used to sign up.<sup><a id="ch11fn1a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn1" class="totri-footnote">1</a></sup> This will involve associating an activation token and digest with a user, sending the user an email with a link including the token, and activating the user upon clicking the link. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>, we’ll apply similar ideas to allow users to reset their passwords if they forget them. Each of these two features will involve creating a new resource, thereby giving us a chance to see further examples of controllers, routing, and database migrations. In the process, we’ll also have a chance to learn how to send email in Rails, both in development and in production.</p>
<p class="footnote"><a id="ch11fn1" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn1a" class="totri-footnote">1</a>. This chapter is independent of the others, apart from the mailer generation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex06">Listing 11.6</a>, which is used in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>. Readers can skip to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a> or to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">Chapter 13</a> with minimal discontinuity, although the former will be substantially more challenging due to substantial overlap with this chapter.</p>
<p class="indent">Our strategy for handling account activation parallels user login (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#sec8_2">Section 8.2</a>) and especially remembering users (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_1">Section 9.1</a>). The basic sequence appears as follows:<sup><a id="ch11fn2a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn2" class="totri-footnote">2</a></sup></p>
<p class="footnote"><a id="ch11fn2" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn2a" class="totri-footnote">2</a>. In addition to this basic sequence, another nice feature to have is the ability to resend account activation emails in case the initial confirmation gets lost, marked as spam, and so forth. Adding such a feature should be within your capabilities by the time you finish this tutorial. You might also consider using a solution such as Devise, already includes the ability to resend confirmation emails.</p>
<ol class="num">
<li><p class="num">Start users in an “unactivated” state.</p></li>
<li><p class="num">When a user signs up, generate an activation token and corresponding activation digest.<span epub:type="pagebreak" id="page_540"></span></p></li>
<li><p class="num">Save the activation digest to the database, and then send an email to the user with a link containing the activation token and user’s email address.<sup><a id="ch11fn3a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn3" class="totri-footnote">3</a></sup></p>
<p class="footnote"><a id="ch11fn3" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn3a" class="totri-footnote">3</a>. We could use the user’s id instead, since it’s already exposed in the URLs of our application, but using email addresses is more future-proof in case we want to obfuscate user ids for any reason (e.g., to prevent competitors from knowing how many users our application has).</p></li>
<li><p class="num">When the user clicks the link, find the user by email address, and then authenticate the token by comparing with the activation digest.</p></li>
<li><p class="num">If the user is authenticated, change the status from “unactivated” to “activated.”</p></li>
</ol>
<p class="noindent">Because of the similarity with passwords and remember tokens, we will be able to reuse many of the same ideas for account activation (as well as password reset), including the <span class="dark-green"><strong><code>User.digest</code></strong></span> and <span class="dark-green"><strong><code>User.new_token</code></strong></span> methods and a modified version of the <span class="dark-green"><strong><code>user.authenticated?</code></strong></span> method. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11tab01">Table 11.1</a> illustrates the analogy (including the password reset from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>).</p>
<p class="indent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_1">Section 11.1</a>, we’ll make a resource and data model for account activations and in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2">Section 11.2</a> we’ll add a <em>mailer</em> for sending account activation emails. We’ll implement the actual account activation, including a generalized version of the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11tab01">Table 11.1</a>, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_3">Section 11.3</a>.</p>
<figure id="ch11tab01">
<figcaption><p><strong>Table 11.1:</strong> The analogy between login, remembering, account activation, and password reset.</p></figcaption>
<table class="topbot">
<thead>
<tr>
<th class="tab-th"><p class="tab-para">find by</p></th>
<th class="tab-thc"><p class="tab-para">string</p></th>
<th class="tab-thc"><p class="tab-para">digest</p></th>
<th class="tab-thc"><p class="tab-para">authentication</p></th>
</tr>
</thead>
<tbody>
<tr>
<td><p class="tab-para"><span class="dark-green"><strong><code>email</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>password</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>password_digest</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>authenticate (password)</code></strong></span></p></td>
</tr>
<tr>
<td><p class="tab-para"><span class="dark-green"><strong><code>id</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>remember_token</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>remember_digest</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>authenticated? (:remember, token)</code></strong></span></p></td>
</tr>
<tr>
<td><p class="tab-para"><span class="dark-green"><strong><code>email</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>activation_token</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>activation_digest</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>authenticated? (:activation, token)</code></strong></span></p></td>
</tr>
<tr>
<td><p class="tab-para"><span class="dark-green"><strong><code>email</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>reset_token</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>reset_digest</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>authenticated? (:reset, token)</code></strong></span></p></td>
</tr>
</tbody>
</table>
</figure>
<section>
<h3 class="h3" id="sec11_1"><span epub:type="pagebreak" id="page_541"></span>11.1 Account Activations Resource</h3>
<p class="noindent">As with sessions (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#sec8_1">Section 8.1</a>), we’ll model account activations as a resource even though they won’t be associated with an Active Record model. Instead, we’ll include the relevant data (including the activation token and activation status) in the User model itself.</p>
<p class="indent">Because we’ll be treating account activations as a resource, we’ll interact with them via a standard REST URL. The activation link will be modifying the user’s activation status, and for such modifications the standard REST practice is to issue a <code>PATCH</code> request to the <span class="dark-green"><strong><code>update</code></strong></span> action (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>). The activation link needs to be sent in an email, though, and hence will involve a regular browser click, which issues a <code>GET</code> request instead of <code>PATCH</code>. This design constraint means that we can’t use the <span class="dark-green"><strong><code>update</code></strong></span> action, but we’ll do the next-best thing and use the <span class="dark-green"><strong><code>edit</code></strong></span> action instead, which does respond to <code>GET</code> requests.</p>
<p class="indent">As usual, we’ll make a topic branch for the new feature:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg541-1a" id="pg541-1">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> git checkout -b account-activation</pre>
<section>
<h4 class="h4" id="sec11_1_1">11.1.1 Account Activations Controller</h4>
<p class="noindent">As with Users and Sessions, the actions (or, in this case, the sole action) for the Account Activations resource will live inside an Account Activations controller, which we can generate as follows:<sup><a id="ch11fn4a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn4" class="totri-footnote">4</a></sup></p>
<p class="footnote"><a id="ch11fn4" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn4a" class="totri-footnote">4</a>. Because we’ll be using an <span class="dark-green"><strong><code>edit</code></strong></span> action, we could include <span class="dark-green"><strong><code>edit</code></strong></span> on the command line, but this would also generate both an edit view and a test, neither of which we’ll actually need.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg541-2a" id="pg541-2">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> rails generate controller AccountActivations</pre>
<p class="indent">As we’ll see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2_1">Section 11.2.1</a>, the activation email will involve a URL of the form</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg541-3a" id="pg541-3">Click here to view code image</a></p>
<pre class="pre1">edit_account_activation_url(activation_token, ...)
</pre>
<p class="noindent">which means we’ll need a named route for the <span class="dark-green"><strong><code>edit</code></strong></span> action. We can arrange for this with the <span class="dark-green"><strong><code>resources</code></strong></span> line shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex01">Listing 11.1</a>, which gives the RESTful route shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11tab02">Table 11.2</a>.<span epub:type="pagebreak" id="page_542"></span></p>
<figure id="ch11tab02">
<figcaption><p><strong>Table 11.2:</strong> RESTful route provided by the Account Activations resource in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex01">Listing 11.1</a>.</p></figcaption>
<table class="topbot">
<thead>
<tr>
<th class="tab-th"><p class="tab-para">HTTP request</p></th>
<th class="tab-th"><p class="tab-para">URL</p></th>
<th class="tab-th"><p class="tab-para">Action</p></th>
<th class="tab-th"><p class="tab-para">Named route</p></th>
</tr>
</thead>
<tbody>
<tr>
<td><p class="tab-para"><span class="dark-green"><strong><code>GET</code></strong></span></p></td>
<td><p class="tab-para">/account_activation/&lt;token&gt;/edit</p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>edit</code></strong></span></p></td>
<td><p class="tab-para"><span class="dark-green"><strong><code>edit_account_activation_url(token)</code></strong></span></p></td>
</tr>
</tbody>
</table>
</figure>
<p class="ex-title" id="ch11ex01"><strong>Listing 11.1:</strong> Adding a route for the Account Activations <span class="dark-green"><strong><code>edit</code></strong></span> action.</p>
<pre class="pre2">config/routes.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-1a" id="lis11-1">Click here to view code image</a></p>
<div class="example">
<pre><span class="red">Rails</span><span class="ash">.</span>application<span class="ash">.</span>routes<span class="ash">.</span>draw <b><span class="green">do</span></b>
  root   <span class="maroon">'static_pages#home'</span>
  get    <span class="maroon">'/help'</span>,    <span class="violet">to</span>: <span class="maroon">'static_pages#help'</span>
  get    <span class="maroon">'/about'</span>,   <span class="violet">to</span>: <span class="maroon">'static_pages#about'</span>
  get    <span class="maroon">'/contact'</span>, <span class="violet">to</span>: <span class="maroon">'static_pages#contact'</span>
  get    <span class="maroon">'/signup'</span>,  <span class="violet">to</span>: <span class="maroon">'users#new'</span>
  get    <span class="maroon">'/login'</span>,   <span class="violet">to</span>: <span class="maroon">'sessions#new'</span>
  post   <span class="maroon">'/login'</span>,   <span class="violet">to</span>: <span class="maroon">'sessions#create'</span>
  delete <span class="maroon">'/logout'</span>,  <span class="violet">to</span>: <span class="maroon">'sessions#destroy'</span>
  resources <span class="violet">:users</span>
<span class="marko">  resources <span class="blue1">:account_activations</span>, <span class="blue1">only:</span> [<span class="blue1">:edit</span>]</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">We’ll define the <span class="dark-green"><strong><code>edit</code></strong></span> action itself in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_3_2">Section 11.3.2</a>, after we’ve finished the Account Activations data model and mailers.</p>
<section>
<h5 class="h5" id="lev126">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Verify that the test suite is still <span class="green5"><small>GREEN</small></span>.</p></li>
<li><p class="num">Why does <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11tab02">Table 11.2</a> list the <span class="dark-green"><strong><code>_url</code></strong></span> form of the named route instead of the <span class="dark-green"><strong><code>_path</code></strong></span> form? <em>Hint</em>: We’re going to use it in an email.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec11_1_2">11.1.2 Account Activation Data Model</h4>
<p class="noindent">As discussed in the introduction, we need a unique activation token for use in the activation email. One possibility would be to use a string that’s both stored in the database and included in the activation URL, but this raises security concerns if our <span epub:type="pagebreak" id="page_543"></span>database is compromised. For example, an attacker with access to the database could immediately activate newly created accounts (thereby logging in as the user), and could then change the password to gain control.<sup><a id="ch11fn5a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn5" class="totri-footnote">5</a></sup></p>
<p class="footnote"><a id="ch11fn5" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn5a" class="totri-footnote">5</a>. It’s mainly for this reason that we won’t be using the (perhaps slightly misnamed) <span class="dark-green"><strong><code>has_secure_token</code></strong></span> facility added in Rails 5, which stores the corresponding token in the database as unhashed cleartext.</p>
<p class="indent">To prevent such scenarios, we’ll follow the example of passwords (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">Chapter 6</a>) and remember tokens (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">Chapter 9</a>) by pairing a publicly exposed virtual attribute with a secure hash digest saved to the database. This way we can access the activation token using</p>
<pre class="pre1">user<span class="ash">.</span>activation_token</pre>
<p class="noindent">and authenticate the user with code like</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg543-1a" id="pg543-1">Click here to view code image</a></p>
<pre class="pre1">user<span class="ash">.</span>authenticated?(<span class="violet">:activation</span>, token)</pre>
<p class="noindent">(This will require a modification of the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex06">Listing 9.6</a>.)</p>
<p class="indent">We’ll also add a boolean attribute called <span class="dark-green"><strong><code>activated</code></strong></span> to the User model, which will allow us to test if a user is activated using the same kind of auto-generated boolean method we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_4_1">Section 10.4.1</a>:</p>
<pre class="pre1"><b><span class="green">if</span></b> user<span class="ash">.</span>activated? ...</pre>
<p class="noindent">Finally, although we won’t use it in this tutorial, we’ll record the time and date of the activation in case we want it for future reference. The full data model appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig01">Figure 11.1</a>.</p>
<figure id="ch11fig01" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_01.jpg" alt="Image" width="1142" height="963" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_01.jpg">
<figcaption><p><strong>Figure 11.1:</strong> The User model with added account activation attributes.</p></figcaption>
</figure>
<p class="indent">The migration to add the data model from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig01">Figure 11.1</a> adds all three attributes at the command line:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg543-2a" id="pg543-2">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> rails generate migration add_activation_to_users <b><span class="maroon2">\</span></b>
&gt; activation_digest:string activated:boolean activated_at:datetime</pre>
<p class="noindent">(Here the <span class="dark-green"><strong><code>&gt;</code></strong></span> on the second line is a “line continuation” character inserted automatically by the shell; it should not be typed literally.) As with the <span class="dark-green"><strong><code>admin</code></strong></span> attribute (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex054">Listing 10.54</a>), we’ll add a default boolean value of <span class="dark-green"><strong><code>false</code></strong></span> to the <span class="dark-green"><strong><code>activated</code></strong></span> attribute, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex02">Listing 11.2</a>.<span epub:type="pagebreak" id="page_544"></span></p>
<p class="ex-title" id="ch11ex02"><strong>Listing 11.2:</strong> A migration for account activation (with added index).</p>
<pre class="pre2">db/migrate/[timestamp]_add_activation_to_users.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-2a" id="lis11-2">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">AddActivationToUsers</span></b> <span class="ash">&lt;</span> <span class="red">ActiveRecord</span><span class="ash">::</span><span class="red">Migration</span><span class="ash">[6.0]</span>
  <b><span class="green">def</span></b> <span class="blue3">change</span>
    add_column <span class="violet">:users</span>, <span class="violet">:activation_digest</span>, <span class="violet">:string</span>
<span class="marko">    add_column <span class="blue1">:users</span>, <span class="blue1">:activated</span>, <span class="blue1">:boolean</span>, <span class="blue1">default:</span> <b><span class="green3">false</span></b></span>
    add_column <span class="violet">:users</span>, <span class="violet">:activated_at</span>, <span class="violet">:datetime</span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">We then apply the migration as usual:</p>
<pre class="pre1">$ rails db:migrate</pre>
<section>
<h5 class="h5" id="lev300"><span epub:type="pagebreak" id="page_545"></span>Activation Token Callback</h5>
<p class="noindent">Because every newly signed-up user will require activation, we should assign an activation token and digest to each user object before it’s created. We saw a similar idea in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_5">Section 6.2.5</a>, where we needed to convert an email address to lowercase before saving a user to the database. In that case, we used a <span class="dark-green"><strong><code>before_save</code></strong></span> callback combined with the <span class="dark-green"><strong><code>downcase</code></strong></span> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a>). A <span class="dark-green"><strong><code>before_save</code></strong></span> callback is automatically called before the object is saved, which includes both object creation and updates. In the case of the activation digest, though, we want the callback to fire only when the user is created. This requires a <span class="dark-green"><strong><code>before_create</code></strong></span> callback, which we’ll define as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg545-1a" id="pg545-1">Click here to view code image</a></p>
<pre class="pre1">before_create <span class="violet">:create_activation_digest</span></pre>
<p class="noindent">This code, called a <em>method reference</em>, arranges for Rails to look for a method called <span class="dark-green"><strong><code>create_activation_digest</code></strong></span> and run it before creating the user. (In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a>, we passed <span class="dark-green"><strong><code>before_save</code></strong></span> an explicit block, but the method reference technique is generally preferred.) Because the <span class="dark-green"><strong><code>create_activation_digest</code></strong></span> method itself is only used internally by the User model, there’s no need to expose it to outside users; as we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_2">Section 7.3.2</a>, the Ruby way to accomplish this is to use the <span class="dark-green"><strong><code>private</code></strong></span> keyword:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg545-2a" id="pg545-2">Click here to view code image</a></p>
<pre class="pre1"><b><span class="green">private</span></b>

  <b><span class="green">def</span></b> <span class="blue3">create_activation_digest</span>
    <span class="blue"># Create the token and digest.</span>
  <b><span class="green">end</span></b>
</pre>
<p class="noindent">All methods defined in a class after <span class="dark-green"><strong><code>private</code></strong></span> are automatically hidden, as seen in this console session:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg545-3a" id="pg545-3">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console</span>
<b><span class="navy">&gt;&gt;</span></b> <span class="red">User</span><span class="ash">.</span>first<span class="ash">.</span>create_activation_digest
<span class="green">NoMethodError: private method `create_activation_digest' called for #&lt;User&gt;</span></pre>
<p class="indent">The purpose of the <span class="dark-green"><strong><code>before_create</code></strong></span> callback is to assign the token and corresponding digest, which we can accomplish as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg545-4a" id="pg545-4">Click here to view code image</a></p>
<pre class="pre1"><span class="green1">self</span><span class="ash">.</span>activation_token <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new_token
<span class="green1">self</span><span class="ash">.</span>activation_digest <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>digest(activation_token)</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_546"></span>This code simply reuses the token and digest methods used for the remember token, as we can see by comparing it with the <span class="dark-green"><strong><code>remember</code></strong></span> method from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex03">Listing 9.3</a>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg546-1a" id="pg546-1">Click here to view code image</a></p>
<pre class="pre1"><span class="blue"># Remembers a user in the database for use in persistent sessions.</span>
<b><span class="green">def</span></b> <span class="blue3">remember</span>
  <span class="green1">self</span><span class="ash">.</span>remember_token <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new_token
  update_attribute(<span class="violet">:remember_digest</span>, <span class="red">User</span><span class="ash">.</span>digest(remember_token))
<b><span class="green">end</span></b></pre>
<p class="noindent">The main difference is the use of <span class="dark-green"><strong><code>update_attribute</code></strong></span> in the latter case. The reason for the difference is that remember tokens and digests are created for users that already exist in the database, whereas the <span class="dark-green"><strong><code>before_create</code></strong></span> callback happens <em>before</em> the user has been created, so there’s not yet any attribute to update. As a result of the callback, when a new user is defined with <span class="dark-green"><strong><code>User.new</code></strong></span> (as in user signup, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex019">Listing 7.19</a>), it will automatically get both <span class="dark-green"><strong><code>activation_token</code></strong></span> and <span class="dark-green"><strong><code>activation_digest</code></strong></span> attributes; because the latter is associated with a column in the database (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig01">Figure 11.1</a>), it will be written to the database automatically when the user is saved.</p>
<p class="indent">Putting all this information together yields the User model shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex03">Listing 11.3</a>. As required by the virtual nature of the activation token, we’ve added a second <span class="dark-green"><strong><code>attr_accessor</code></strong></span> to our model. Note that we’ve taken the opportunity to replace the email downcasing callback from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a> with a method reference.</p>
<p class="ex-title" id="ch11ex03"><strong>Listing 11.3:</strong> Adding account activation code to the User model. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-3a" id="lis11-3">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">User</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
<span class="marko">  <b><span class="green3">attr_accessor</span></b> <span class="blue1">:remember_token</span>, <span class="blue1">:activation_token</span></span>
<span class="marko">  before_save   <span class="blue1">:downcase_email</span></span>
<span class="marko">  before_create <span class="blue1">:create_activation_digest</span></span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <b><span class="green">true</span></b>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<span class="marko">  <b><span class="green3">private</span></b></span>

    <span class="blue"># Converts email to all lower-case.</span>
    <b><span class="green">def</span></b> <span class="blue3">downcase_email</span>

<span epub:type="pagebreak" id="page_547"></span><span class="marko">      <span class="green3">self</span><span class="ash1">.</span>email <span class="ash1">=</span> email<span class="ash1">.</span>downcase</span>
    <b><span class="green">end</span></b>

    <span class="blue"># Creates and assigns the activation token and digest.</span>
    <b><span class="green">def</span></b> <span class="blue3">create_activation_digest</span>
<span class="marko">      <span class="green3">self</span><span class="ash1">.</span>activation_token  <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>new_token</span>
<span class="marko">      <span class="green3">self</span><span class="ash1">.</span>activation_digest <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>digest(activation_token)</span>
    <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
</section>
<section>
<h5 class="h5" id="lev127">Seed and Fixture Users</h5>
<p class="noindent">Before moving on, we should also update our seed data and fixtures so that our sample and test users are initially activated, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex04">Listing 11.4</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex05">Listing 11.5</a>. (The <span class="dark-green"><strong><code>Time.zone.now</code></strong></span> method is a built-in Rails helper that returns the current timestamp, taking into account the time zone on the server.)</p>
<p class="ex-title" id="ch11ex04"><strong>Listing 11.4:</strong> Activating seed users by default.</p>
<pre class="pre2">db/seeds.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-4a" id="lis11-4">Click here to view code image</a></p>
<div class="example">
<pre><span epub:type="pagebreak" id="page_548"></span><span class="blue"># Create a main sample user.</span>
<span class="red">User</span><span class="ash">.</span>create!(<span class="green1">name</span>:  <span class="maroon">"Example User"</span>,
             <span class="violet">email</span>: <span class="maroon">"example@railstutorial.org"</span>,
             <span class="violet">password</span>:              <span class="maroon">"foobar"</span>,
             <span class="violet">password_confirmation</span>: <span class="maroon">"foobar"</span>,
             <span class="violet">admin</span>:     <b><span class="green">true</span></b>,
<span class="marko">             <span class="blue1">activated</span>: <b><span class="green3">true</span></b>,</span>
<span class="marko">             <span class="blue1">activated_at</span>: <span class="red2">Time</span><span class="ash1">.</span>zone<span class="ash1">.</span>now)</span>

<span class="blue"># Generate a bunch of additional users.</span>
<span class="ash">99.</span>times <b><span class="green">do</span></b> <span class="ash">|</span>n<span class="ash">|</span>
  <span class="green1">name</span> <span class="ash">=</span> <span class="red">Faker</span><span class="ash">::</span><span class="red">Name</span><span class="ash">.</span>name
  email <span class="ash">=</span> <span class="maroon">"example-</span><b><span class="red6">#{</span></b>n<span class="ash">+1</span><b><span class="pink">}</span></b><span class="maroon">@railstutorial.org"</span>
  password <span class="ash">=</span> <span class="maroon">"password"</span>
  <span class="red">User</span><span class="ash">.</span>create!(<span class="green1">name</span>: <span class="green1">name</span>,
              <span class="violet">email</span>: email,
              <span class="violet">password</span>:              password,
              <span class="violet">password_confirmation</span>: password,
<span class="marko">              <span class="blue1">activated</span>: <b><span class="green3">true</span></b>,</span>
<span class="marko">              <span class="blue1">activated_at</span>: <span class="red2">Time</span><span class="ash1">.</span>zone<span class="ash1">.</span>now)</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="ex-title" id="ch11ex05"><strong>Listing 11.5:</strong> Activating fixture users.</p>
<pre class="pre2">test/fixtures/users.yml</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-5a" id="lis11-5">Click here to view code image</a></p>
<div class="example">
<pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;
  admin: true
<span class="marko">  activated: true</span>
<span class="marko">  activated_at: &lt;%= Time.zone.now %&gt;</span>

archer:
  name: Sterling Archer
  email: duchess@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;
<span class="marko">  activated: true</span>
<span class="marko">  activated_at: &lt;%= Time.zone.now %&gt;</span>

lana:
  name: Lana Kane
  email: hands@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;
<span class="marko">  activated: true</span>
<span class="marko">  activated_at: &lt;%= Time.zone.now %&gt;</span>

malory:
  name: Malory Archer
  email: boss@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;
<span class="marko">  activated: true</span>
<span class="marko">  activated_at: &lt;%= Time.zone.now %&gt;</span>

&lt;% 30.times do |n| %&gt;
user_&lt;%= n %&gt;:
  name:  &lt;%= "User #{n}" %&gt;
  email: &lt;%= "user-#{n}@example.com" %&gt;
  password_digest: &lt;%= User.digest('password') %&gt;
<span class="marko">  activated: true</span>
<span class="marko">  activated_at: &lt;%= Time.zone.now %&gt;</span>
&lt;% end %&gt;</pre>
</div>
<p class="indent">To apply the changes in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex04">Listing 11.4</a>, reset the database to reseed the data as usual:</p>
<pre class="pre1">$ rails db:migrate:reset
$ rails db:seed
</pre>
</section>
<section>
<h5 class="h5" id="lev301"><span epub:type="pagebreak" id="page_549"></span>Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Verify that the test suite is still <span class="green5"><small>GREEN</small></span> after the changes made in this section.</p></li>
<li><p class="num">By instantiating a User object in the console, confirm that calling the <span class="dark-green"><strong><code>create_activation_digest</code></strong></span> method raises a <span class="dark-green"><strong><code>NoMethodError</code></strong></span> due to its being a private method. What is the value of the user’s activation digest?</p></li>
<li><p class="num">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex035">Listing 6.35</a>, we saw that email downcasing can be written more simply as <span class="dark-green"><strong><code>email.downcase!</code></strong></span> (without any assignment). Make this change to the <span class="dark-green"><strong><code>downcase_email</code></strong></span> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex03">Listing 11.3</a> and verify by running the test suite that it works.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec11_2">11.2 Account Activation Emails</h3>
<p class="noindent">With the data modeling complete, we’re now ready to add the code needed to send an account activation email. The method is to add a User <em>mailer</em> using the Action Mailer library, which we’ll use in the Users controller <span class="dark-green"><strong><code>create</code></strong></span> action to send an email with an activation link. Mailers are structured much like controller actions, with email templates defined as views. These templates will include links with the activation token and email address associated with the account to be activated.</p>
<section>
<h4 class="h4" id="sec11_2_1">11.2.1 Mailer Templates</h4>
<p class="noindent">As with models and controllers, we can generate a mailer using <span class="dark-green"><strong><code>rails generate</code></strong></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex06">Listing 11.6</a>.</p>
<p class="ex-title" id="ch11ex06"><strong>Listing 11.6:</strong> Generating the User mailer.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-6a" id="lis11-6">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="navy">$</span></b> rails generate mailer UserMailer account_activation password_reset</pre>
</div>
<p class="noindent">In addition to the necessary <span class="dark-green"><strong><code>account_activation</code></strong></span> method, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex06">Listing 11.6</a> generates the <span class="dark-green"><strong><code>password_reset</code></strong></span> method we’ll need in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>.</p>
<p class="indent">The command in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex06">Listing 11.6</a> also generates two view templates for each mailer, one for plain-text email and one for HTML email. For the account activation mailer <span epub:type="pagebreak" id="page_550"></span>method, they appear as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex07">Listing 11.7</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex08">Listing 11.8</a>. (We’ll take care of the corresponding password reset templates in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>.)</p>
<p class="ex-title" id="ch11ex07"><strong>Listing 11.7:</strong> The generated account activation text view.</p>
<pre class="pre2">app/views/user_mailer/account_activation.text.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-7a" id="lis11-7">Click here to view code image</a></p>
<div class="example">
<pre>UserMailer#account_activation

<span class="red5">&lt;%=</span> <span class="violet">@greeting</span> <span class="red5">%&gt;</span>, find me in app/views/user_mailer/account_activation.text.erb</pre>
</div>
<p class="ex-title" id="ch11ex08"><strong>Listing 11.8:</strong> The generated account activation HTML view.</p>
<pre class="pre2">app/views/user_mailer/account_activation.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-8a" id="lis11-8">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<b><span class="green">h1</span></b>&gt;UserMailer#account_activation&lt;/<b><span class="green">h1</span></b>&gt;

&lt;<b><span class="green">p</span></b>&gt;
  <span class="red5">&lt;%=</span> <span class="violet">@greeting</span> <span class="red5">%&gt;</span>, find me in app/views/user_mailer/account_activation.html.erb
&lt;/<b><span class="green">p</span></b>&gt;</pre>
</div>
<p class="indent">Let’s take a look at the generated mailers to get a sense of how they work (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex09">Listing 11.9</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex010">Listing 11.10</a>). We see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex09">Listing 11.9</a> that there is a default <span class="dark-green"><strong><code>from</code></strong></span> address common to all mailers in the application, and each method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex010">Listing 11.10</a> has a recipient’s address as well. (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex09">Listing 11.9</a> uses a mailer layout corresponding to the email format; although it won’t ever matter in this tutorial, the resulting HTML and plain-text mailer layouts can be found in <span class="dark-green"><strong><code>app/views/layouts</code></strong></span>.) The generated code also includes an instance variable (<span class="dark-green"><strong><code>@greeting</code></strong></span>), which is available in the mailer views in much the same way that instance variables in controllers are available in ordinary views.</p>
<p class="ex-title" id="ch11ex09"><strong>Listing 11.9:</strong> The generated application mailer.</p>
<pre class="pre2">app/mailers/application_mailer.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-9a" id="lis11-9">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">ApplicationMailer</span></b> <span class="ash">&lt;</span> <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">Base</span>
  default <span class="violet">from</span>: <span class="maroon">"from@example.com"</span>
  layout <span class="maroon">'mailer'</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="ex-title" id="ch11ex010"><span epub:type="pagebreak" id="page_551"></span><strong>Listing 11.10:</strong> The generated User mailer.</p>
<pre class="pre2">app/mailers/user_mailer.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-10a" id="lis11-10">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UserMailer</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationMailer</span>

  <span class="blue"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="blue"># with the following lookup:</span>
  <span class="blue">#</span>
  <span class="blue">#   en.user_mailer.account_activation.subject</span>
  <span class="blue">#</span>
  <b><span class="green">def</span></b> <span class="blue3">account_activation</span>
<span class="marko">    <span class="blue1">@greeting</span> <span class="ash1">=</span> <span class="red2">"Hi"</span></span>

<span class="marko">    mail <span class="blue1">to</span>: <span class="red2">"to@example.org"</span></span>
  <b><span class="green">end</span></b>

  <span class="blue"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="blue"># with the following lookup:</span>
  <span class="blue">#</span>
  <span class="blue">#   en.user_mailer.password_reset.subject</span>
  <span class="blue">#</span>
  <b><span class="green">def</span></b> <span class="blue3">password_reset</span>
<span class="marko">    <span class="blue1">@greeting</span> <span class="ash1">=</span> <span class="red2">"Hi"</span></span>

<span class="marko">    mail <span class="blue1">to</span>: <span class="red2">"to@example.org"</span></span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">To make a working activation email, we’ll first customize the generated template as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex011">Listing 11.11</a>. Next, we’ll create an instance variable containing the user (for use in the view), and then mail the result to <span class="dark-green"><strong><code>user.email</code></strong></span> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex012">Listing 11.12</a>). As seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex012">Listing 11.12</a>, the <span class="dark-green"><strong><code>mail</code></strong></span> method also takes a <span class="dark-green"><strong><code>subject</code></strong></span> key, whose value is used as the email’s subject line.</p>
<p class="ex-title" id="ch11ex011"><strong>Listing 11.11:</strong> The application mailer with a new default <span class="dark-green"><strong><code>from</code></strong></span> address.</p>
<pre class="pre2">app/mailers/application_mailer.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-11a" id="lis11-11">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">ApplicationMailer</span></b> <span class="ash">&lt;</span> <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">Base</span>
<span class="marko">  default <span class="blue1">from:</span> <span class="red2">"noreply@example.com"</span></span>
  layout <span class="maroon">'mailer'</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="ex-title" id="ch11ex012"><span epub:type="pagebreak" id="page_552"></span><strong>Listing 11.12:</strong> Mailing the account activation link. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/mailers/user_mailer.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-12a" id="lis11-12">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UserMailer</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationMailer</span>

<span class="marko">  <b><span class="green3">def</span></b> <span class="blue3">account_activation</span>(user)</span>
<span class="marko">    <span class="blue1">@user</span> <span class="ash1">=</span> user</span>
<span class="marko">    mail <span class="blue1">to</span>: user<span class="ash1">.</span>email, <span class="blue1">subject:</span> <span class="red2">"Account activation"</span></span>
<span class="marko">  <b><span class="green3">end</span></b></span>

  <b><span class="green">def</span></b> <span class="blue3">password_reset</span>
    <span class="violet">@greeting</span> <span class="ash">=</span> <span class="maroon">"Hi"</span>

    mail <span class="violet">to</span>: <span class="maroon">"to@example.org"</span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">As indicated in the <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex012">Listing 11.12</a> caption, the tests are currently <span class="red5"><small>RED</small></span> (due to our changing <span class="dark-green"><strong><code>account_activation</code></strong></span> to take an argument); we’ll get them to <span class="green5"><small>GREEN</small></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2_3">Section 11.2.3</a>.</p>
<p class="indent">As with ordinary views, we can use embedded Ruby to customize the template views, in this case greeting the user by name and including a link to a custom activation link. Our plan is to find the user by email address and then authenticate the activation token, so the link needs to include both the email and the token. Because we’re modeling activations using an Account Activations resource, the token itself can appear as the argument of the named route defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex01">Listing 11.1</a>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg552-1a" id="pg552-1">Click here to view code image</a></p>
<pre class="pre1">edit_account_activation_url(<span class="violet">@user</span><span class="ash">.</span>activation_token, <span class="ash">...</span>)</pre>
<p class="noindent">Recalling that</p>
<pre class="pre1">edit_user_url(user)</pre>
<p class="noindent">produces a URL of the form</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg552-2a" id="pg552-2">Click here to view code image</a></p>
<pre class="pre1">http://www.example.com/users/1/edit</pre>
<p class="noindent">the corresponding account activation link’s base URL will look like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg552-3a" id="pg552-3">Click here to view code image</a></p>
<pre class="pre1">http://www.example.com/account_activations/q5lt38hQDc_959PVoo6b7A/edit</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_553"></span>Here <span class="dark-green"><strong><code>q5lt38hQDc_959PVoo6b7A</code></strong></span> is a URL-safe base64 string generated by the <span class="dark-green"><strong><code>new_token</code></strong></span> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex02">Listing 9.2</a>). It plays the same role as the user id in /users/1/edit. In particular, in the Activations controller <span class="dark-green"><strong><code>edit</code></strong></span> action, the token will be available in the <span class="dark-green"><strong><code>params</code></strong></span> hash as <span class="dark-green"><strong><code>params[:id]</code></strong></span>.</p>
<p class="indent">To include the email as well, we need to use a <em>query parameter</em>, which in a URL appears as a key-value pair following a question mark:<sup><a id="ch11fn6a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn6" class="totri-footnote">6</a></sup></p>
<p class="footnote"><a id="ch11fn6" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn6a" class="totri-footnote">6</a>. URLs can contain multiple query parameters, consisting of multiple key-value pairs separated by the ampersand character <span class="dark-green"><strong><code>&amp;</code></strong></span>, as in <span class="dark-green"><strong><code>/edit?name=Foo%20Bar&amp;email=foo%40example.com</code></strong></span>.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg553-1a" id="pg553-1">Click here to view code image</a></p>
<pre class="pre1">account_activations/q5lt38hQDc_959PVoo6b7A/edit?email=foo%40example.com</pre>
<p class="noindent">Notice that the “@” in the email address appears as <span class="dark-green"><strong><code>%40</code></strong></span>, that is, it’s “escaped out” to guarantee a valid URL. The way to set a query parameter in Rails is to include a hash in the named route:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg553-2a" id="pg553-2">Click here to view code image</a></p>
<pre class="pre1">edit_account_activation_url(<span class="violet">@user</span><span class="ash">.</span>activation_token, <span class="violet">email</span>: <span class="violet">@user</span><span class="ash">.</span>email)</pre>
<p class="noindent">When using named routes in this way to define query parameters, Rails automatically escapes out any special characters. The resulting email address will also be unescaped automatically in the controller, and will be available via <span class="dark-green"><strong><code>params[:email]</code></strong></span>.</p>
<p class="indent">With the <span class="dark-green"><strong><code>@user</code></strong></span> instance variable as defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex012">Listing 11.12</a>, we can create the necessary links using the named edit route and embedded Ruby, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex013">Listing 11.13</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex014">Listing 11.14</a>. Note that the HTML template in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex014">Listing 11.14</a> uses the <span class="dark-green"><strong><code>link_to</code></strong></span> method to construct a valid link.</p>
<p class="ex-title" id="ch11ex013"><strong>Listing 11.13:</strong> The account activation text view.</p>
<pre class="pre2">app/views/user_mailer/account_activation.text.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-13a" id="lis11-13">Click here to view code image</a></p>
<div class="example">
<pre>Hi <span class="red5">&lt;%=</span> <span class="violet">@user</span><span class="ash">.</span>name <span class="red5">%&gt;</span>,

Welcome to the Sample App! Click on the link below to activate your account:

<span class="red5">&lt;%=</span> edit_account_activation_url(<span class="violet">@user</span><span class="ash">.</span>activation_token, <span class="violet">email</span>: <span class="violet">@user</span><span class="ash">.</span>email) <span class="red5">%&gt;</span></pre>
</div>
<p class="ex-title" id="ch11ex014"><span epub:type="pagebreak" id="page_554"></span><strong>Listing 11.14:</strong> The account activation HTML view.</p>
<pre class="pre2">app/views/user_mailer/account_activation.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-14a" id="lis11-14">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<b><span class="green">h1</span></b>&gt;Sample App&lt;/<b><span class="green">h1</span></b>&gt;

&lt;<b><span class="green">p</span></b>&gt;Hi <span class="red5">&lt;%=</span> <span class="violet">@user</span><span class="ash">.</span>name <span class="red5">%&gt;</span>,&lt;/<b><span class="green">p</span></b>&gt;

&lt;<b><span class="green">p</span></b>&gt;
Welcome to the Sample App! Click on the link below to activate your account:
&lt;/<b><span class="green">p</span></b>&gt;

<span class="red5">&lt;%=</span> link_to <span class="maroon">"Activate"</span>, edit_account_activation_url(<span class="violet">@user</span><span class="ash">.</span>activation_token,
                                                    <span class="violet">email</span>: <span class="violet">@user</span><span class="ash">.</span>email) <span class="red5">%&gt;</span></pre>
</div>
<section>
<h5 class="h5" id="lev129">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">At the console, verify that the <span class="dark-green"><strong><code>escape</code></strong></span> method in the <span class="dark-green"><strong><code>CGI</code></strong></span> module escapes out the email address as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex015">Listing 11.15</a>. What is the escaped value of the string <span class="dark-green"><strong><code>"Don't panic!"</code></strong></span>?</p></li>
</ol>
<p class="ex-title" id="ch11ex015"><strong>Listing 11.15:</strong> Escaping an email with <span class="dark-green"><strong><code>CGI.escape</code></strong></span>.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-15a" id="lis11-15">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="navy">&gt;&gt;</span></b> <span class="red">CGI</span><span class="ash">.</span>escape(<span class="maroon">'foo@example.com'</span>)
<span class="green">=&gt; "foo%40example.com"</span></pre>
</div>
</section>
</section>
<section>
<h4 class="h4" id="sec11_2_2">11.2.2 Email Previews</h4>
<p class="noindent">To see the results of the templates defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex013">Listing 11.13</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex014">Listing 11.14</a>, we can use <em>email previews</em>, which are special URLs exposed by Rails to let us see what our email messages look like. First, we need to add some configuration to our application’s development environment, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex016">Listing 11.16</a>.<span epub:type="pagebreak" id="page_555"></span></p>
<p class="ex-title" id="ch11ex016"><strong>Listing 11.16:</strong> Email settings in development.</p>
<pre class="pre2">config/environments/development.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-16a" id="lis11-16">Click here to view code image</a></p>
<div class="example">
<pre><span class="red">Rails</span><span class="ash">.</span>application<span class="ash">.</span>configure <b><span class="green">do</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  config<span class="ash">.</span>action_mailer<span class="ash">.</span>raise_delivery_errors <span class="ash">=</span> <b><span class="green">false</span></b>

  host <span class="ash">=</span> <span class="maroon">'example.com'</span> <span class="blue"># Don't use this literally; use your local dev host instead</span>
  <span class="blue"># Use this on the cloud IDE.</span>
  config<span class="ash">.</span>action_mailer<span class="ash">.</span>default_url_options <span class="ash">=</span> { <span class="violet">host</span>: host, <span class="violet">protocol</span>: <span class="maroon">'https'</span> }
  <span class="blue"># Use this if developing on localhost.</span>
  <span class="blue"># config.action_mailer.default_url_options = { host: host, protocol: 'http' }</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex016">Listing 11.16</a> uses a host name of <span class="dark-green"><strong><code>'example.com'</code></strong></span>, but as indicated in the comment you should use the actual host of your development environment. For example, on the cloud IDE you should use</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg555-1a" id="pg555-1">Click here to view code image</a></p>
<pre class="pre1">host <span class="ash">=</span> <span class="maroon">'&lt;hex string&gt;.vfs.cloud9.us-east-2.amazonaws.com'</span>     <span class="blue"># Cloud IDE</span>
config<span class="ash">.</span>action_mailer<span class="ash">.</span>default_url_options <span class="ash">=</span> { <span class="violet">host</span>: host, <span class="violet">protocol</span>: <span class="maroon">'https'</span> }</pre>
<p class="noindent">where the exact URL is based on what you see in your browser (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig02">Figure 11.2</a>).</p>
<figure id="ch11fig02" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_02.jpg" alt="Image" width="677" height="44" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_02.jpg">
<figcaption><p><strong>Figure 11.2:</strong> The host URL for the cloud IDE.</p></figcaption>
</figure>
<p class="indent">On a local system, you should use this instead:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg555-2a" id="pg555-2">Click here to view code image</a></p>
<pre class="pre1">host <span class="ash">=</span> <span class="maroon">'localhost:3000'</span>                     <span class="blue"># Local server</span>
config<span class="ash">.</span>action_mailer<span class="ash">.</span>default_url_options <span class="ash">=</span> { <span class="violet">host</span>: host, <span class="violet">protocol</span>: <span class="maroon">'http'</span> }</pre>
<p class="noindent">Note especially in this second example that <span class="dark-green"><strong><code>https</code></strong></span> has changed to plain <span class="dark-green"><strong><code>http</code></strong></span>.</p>
<p class="indent">After restarting the development server to activate the configuration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex016">Listing 11.16</a>, we next need to update the User mailer <em>preview file</em>. It was automatically generated in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2">Section 11.2</a>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex017">Listing 11.17</a>.<span epub:type="pagebreak" id="page_556"></span></p>
<p class="ex-title" id="ch11ex017"><strong>Listing 11.17:</strong> The generated User mailer previews.</p>
<pre class="pre2">test/mailers/previews/user_mailer_preview.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-17a" id="lis11-17">Click here to view code image</a></p>
<div class="example">
<pre><span class="blue"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<b><span class="green">class</span> <span class="blue3">UserMailerPreview</span></b> <span class="ash">&lt;</span> <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">Preview</span>

  <span class="blue"># Preview this email at</span>
  <span class="blue"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <b><span class="green">def</span></b> <span class="blue3">account_activation</span>
   <span class="red">UserMailer</span><span class="ash">.</span>account_activation
  <b><span class="green">end</span></b>

  <span class="blue"># Preview this email at</span>
  <span class="blue"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <b><span class="green">def</span></b> <span class="blue3">password_reset</span>
    <span class="red">UserMailer</span><span class="ash">.</span>password_reset
  <b><span class="green">end</span></b>

<b><span class="green">end</span></b></pre>
</div>
<p class="indent">Because the <span class="dark-green"><strong><code>account_activation</code></strong></span> method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex012">Listing 11.12</a> requires a valid user object as an argument, the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex017">Listing 11.17</a> won’t work as written. To fix it, we define a <span class="dark-green"><strong><code>user</code></strong></span> variable equal to the first user in the development database, and then pass it as an argument to <span class="dark-green"><strong><code>UserMailer.account_activation</code></strong></span> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex018">Listing 11.18</a>). Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex018">Listing 11.18</a> also assigns a value to <span class="dark-green"><strong><code>user.activation_token</code></strong></span>, which is necessary because the account activation templates in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex013">Listing 11.13</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex014">Listing 11.14</a> need an account activation token. (Because <span class="dark-green"><strong><code>activation_token</code></strong></span> is a virtual attribute (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_1">Section 11.1</a>), the user from the database doesn’t have one.)</p>
<p class="ex-title" id="ch11ex018"><strong>Listing 11.18:</strong> A working preview method for account activation.</p>
<pre class="pre2">test/mailers/previews/user_mailer_preview.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-18a" id="lis11-18">Click here to view code image</a></p>
<div class="example">
<pre><span class="blue"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<b><span class="green">class</span> <span class="blue3">UserMailerPreview</span></b> <span class="ash">&lt;</span> <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">Preview</span>

  <span class="blue"># Preview this email at</span>
  <span class="blue"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <b><span class="green">def</span></b> <span class="blue3">account_activation</span>
<span class="marko">    user <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>first</span>
<span class="marko">    user.activation_token <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>new_token</span>
<span class="marko">    <span class="red2">UserMailer</span><span class="ash1">.</span>account_activation(user)</span>
<span epub:type="pagebreak" id="page_557"></span>  <b><span class="green">end</span></b>

  <span class="blue"># Preview this email at</span>
  <span class="blue"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <b><span class="green">def</span></b> <span class="blue3">password_reset</span>
    <span class="red">UserMailer</span><span class="ash">.</span>password_reset
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">With the preview code as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex018">Listing 11.18</a>, we can visit the suggested URLs to preview the account activation emails. (If you are using the cloud IDE, you should replace <span class="dark-green"><strong><code>localhost:3000</code></strong></span> with the corresponding base URL.) The resulting HTML and text emails appear as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig03">Figure 11.3</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig04">Figure 11.4</a>.</p>
<figure id="ch11fig03" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_03.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_03.jpg">
<figcaption><p><strong>Figure 11.3:</strong> A preview of the HTML version of the account activation email.<span epub:type="pagebreak" id="page_558"></span></p></figcaption>
</figure>
<figure id="ch11fig04" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_04.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_04.jpg">
<figcaption><p><strong>Figure 11.4:</strong> A preview of the text version of the account activation email.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev130">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Preview the email templates in your browser. What do the Date fields read for your previews?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec11_2_3">11.2.3 Email Tests</h4>
<p class="noindent">As a final step, we’ll write a couple of tests to double-check the results shown in the email previews. This isn’t as hard as it sounds, because Rails has generated useful example tests for us (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex019">Listing 11.19</a>).<span epub:type="pagebreak" id="page_559"></span></p>
<p class="ex-title" id="ch11ex019"><strong>Listing 11.19:</strong> The User mailer test generated by Rails. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">test/mailers/user_mailer_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-19a" id="lis11-19">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UserMailerTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">TestCase</span>

  <span class="green1">test</span> <span class="maroon">"account_activation"</span> <b><span class="green">do</span></b>
    mail <span class="ash">=</span> <span class="red">UserMailer</span><span class="ash">.</span>account_activation
    assert_equal <span class="maroon">"Account activation"</span>, mail<span class="ash">.</span>subject
    assert_equal <span class="ash">[</span><span class="maroon">"to@example.org"</span><span class="ash">]</span>, mail<span class="ash">.</span>to
    assert_equal <span class="ash">[</span><span class="maroon">"from@example.com"</span><span class="ash">]</span>, mail<span class="ash">.</span>from
    assert_match <span class="maroon">"Hi"</span>, mail<span class="ash">.</span>body<span class="ash">.</span>encoded
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"password_reset"</span> <b><span class="green">do</span></b>
    mail <span class="ash">=</span> <span class="red">UserMailer</span><span class="ash">.</span>password_reset
    assert_equal <span class="maroon">"Password reset"</span>, mail<span class="ash">.</span>subject
    assert_equal <span class="ash">[</span><span class="maroon">"to@example.org"</span><span class="ash">]</span>, mail<span class="ash">.</span>to
    assert_equal <span class="ash">[</span><span class="maroon">"from@example.com"</span><span class="ash">]</span>, mail<span class="ash">.</span>from
    assert_match <span class="maroon">"Hi"</span>, mail<span class="ash">.</span>body<span class="ash">.</span>encoded
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">As mentioned in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2_1">Section 11.2.1</a>, the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex019">Listing 11.19</a> are currently <span class="red5"><small>RED</small></span>.</p>
<p class="indent">The tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex019">Listing 11.19</a> use the powerful <span class="dark-green"><strong><code>assert_match</code></strong></span> method, which can be used with either a string or a regular expression:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg559a" id="pg559">Click here to view code image</a></p>
<pre class="pre1">assert_match <span class="maroon">'foo'</span>, <span class="maroon">'foobar'</span>      <span class="blue"># true</span>
assert_match <span class="maroon">'baz'</span>, <span class="maroon">'foobar'</span>      <span class="blue"># false</span>
assert_match <span class="red6">/\w+/</span>, <span class="maroon">'foobar'</span>      <span class="blue"># true</span>
assert_match <span class="red6">/\w+/</span>, <span class="maroon">'$#!*+@'</span>      <span class="blue"># false</span></pre>
<p class="noindent">The test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex020">Listing 11.20</a> uses <span class="dark-green"><strong><code>assert_match</code></strong></span> to check that the name, activation token, and escaped email appear in the email’s body. For the last of these, note the use of</p>
<pre class="pre1">CGI.escape(user.email)</pre>
<p class="noindent">to escape the test user’s email, which we encountered briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2_1">Section 11.2.1</a>.<sup><a id="ch11fn7a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn7" class="totri-footnote">7</a></sup></p>
<p class="footnote"><a id="ch11fn7" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn7a" class="totri-footnote">7</a>. When I originally wrote this chapter, I couldn’t recall offhand how to escape URLs in Rails, and figuring it out was pure technical sophistication (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#box1_2">Box 1.2</a>). What I did was Google “ruby rails escape url,” which led me to find two main possibilities, <span class="dark-green"><strong><code>URI.encode(str)</code></strong></span> and <span class="dark-green"><strong><code>CGI.escape(str)</code></strong></span>. Trying them both revealed that the latter works. (It turns out there’s a third possibility. The <span class="dark-green"><strong><code>ERB::Util</code></strong></span> library supplies a url_encode method that has the same effect.)<span epub:type="pagebreak" id="page_560"></span></p>
<p class="ex-title" id="ch11ex020"><strong>Listing 11.20:</strong> A test of the current email implementation. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">test/mailers/user_mailer_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-20a" id="lis11-20">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UserMailerTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">TestCase</span>

  <span class="green1">test</span> <span class="maroon">"account_activation"</span> <b><span class="green">do</span></b>
    user <span class="ash">=</span> users(<span class="violet">:michael</span>)
    user<span class="ash">.</span>activation_token <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new_token
    mail <span class="ash">=</span> <span class="red">UserMailer</span><span class="ash">.</span>account_activation(user)
    assert_equal <span class="maroon">"Account activation"</span>, mail<span class="ash">.</span>subject
    assert_equal <span class="ash">[</span>user<span class="ash">.</span>email<span class="ash">]</span>, mail<span class="ash">.</span>to
    assert_equal <span class="ash">[</span><span class="maroon">"noreply@example.com"</span><span class="ash">]</span>, mail<span class="ash">.</span>from
    assert_match user<span class="ash">.</span>name,               mail<span class="ash">.</span>body<span class="ash">.</span>encoded
    assert_match user<span class="ash">.</span>activation_token,   mail<span class="ash">.</span>body<span class="ash">.</span>encoded
    assert_match <span class="red">CGI</span><span class="ash">.</span>escape(user<span class="ash">.</span>email),  mail<span class="ash">.</span>body<span class="ash">.</span>encoded
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex020">Listing 11.20</a> takes care to add an activation token to the fixture user, which would otherwise be blank. (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex020">Listing 11.20</a> also removes the generated password reset test, which we’ll add back—in modified form—in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#sec12_2_2">Section 12.2.2</a>.)</p>
<p class="indent">To get the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex020">Listing 11.20</a> to pass, we have to configure our test file with the proper domain host, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex021">Listing 11.21</a>.</p>
<p class="ex-title" id="ch11ex021"><strong>Listing 11.21:</strong> Setting the test domain host. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">config/environments/test.rb</pre>
<div class="example">
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-21a" id="lis11-21">Click here to view code image</a></p>
<pre><span class="red">Rails</span><span class="ash">.</span>application<span class="ash">.</span>configure <b><span class="green">do</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  config<span class="ash">.</span>action_mailer<span class="ash">.</span>delivery_method <span class="ash">=</span> <span class="violet">:test</span>
<span class="marko">  config.action_mailer.default_url_options = { <span class="blue1">host</span>: <span class="red2">'example.com'</span> }</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_561"></span>With this code, the mailer test should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch11ex022"><strong>Listing 11.22:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test:mailers</pre>
</div>
<section>
<h5 class="h5" id="lev131">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Verify that the full test suite is still <span class="green5"><small>GREEN</small></span>.</p></li>
<li><p class="num">Confirm that the test goes <span class="red5"><small>RED</small></span> if you remove the call to <span class="dark-green"><strong><code>CGI.escape</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex020">Listing 11.20</a>.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec11_2_4">11.2.4 Updating the Users <code>create</code> Action</h4>
<p class="noindent">To use the mailer in our application, we just need to add a couple of lines to the <span class="dark-green"><strong><code>create</code></strong></span> action that signs users up, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex023">Listing 11.23</a>. Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex023">Listing 11.23</a> has changed the redirect behavior upon signing up. Before, we redirected to the user’s profile page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_4">Section 7.4</a>), but that doesn’t make sense now that we’re requiring account activation. Instead, we now redirect to the root URL.</p>
<p class="ex-title" id="ch11ex023"><strong>Listing 11.23:</strong> Adding account activation to user signup. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-23a" id="lis11-23">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">create</span>
<span epub:type="pagebreak" id="page_562"></span>    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(user_params)
    <b><span class="green">if</span></b> <span class="violet">@user</span><span class="ash">.</span>save
<span class="marko">      <span class="red2">UserMailer</span><span class="ash1">.</span>account_activation(<span class="blue1">@user</span>)<span class="ash1">.</span>deliver_now</span>
<span class="marko">      flash[<span class="blue1">:info</span>] <span class="ash1">=</span> <span class="red2">"Please check your email to activate your account."</span></span>
<span class="marko">      redirect_to root_url</span>
    <b><span class="green">else</span></b>
      render <span class="maroon">'new'</span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">Because <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex023">Listing 11.23</a> redirects to the root URL instead of to the profile page and doesn’t log the user in as before, the test suite is currently <span class="red5"><small>RED</small></span>, even though the application is working as designed. We’ll fix this by temporarily commenting out the failing lines, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex024">Listing 11.24</a>. We’ll uncomment these lines and write passing tests for account activation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_3_3">Section 11.3.3</a>.</p>
<p class="ex-title" id="ch11ex024"><strong>Listing 11.24:</strong> Temporarily commenting out failing tests. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/users_signup_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-24a" id="lis11-24">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersSignupTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <span class="green1">test</span> <span class="maroon">"invalid signup information"</span> <b><span class="green">do</span></b>
    get signup_path
    assert_no_difference <span class="maroon">'User.count'</span> <b><span class="green">do</span></b>
      post users_path, <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="maroon">""</span>,
                                         <span class="violet">email</span>: <span class="maroon">"user@invalid"</span>,
                                         <span class="violet">password</span>:              <span class="maroon">"foo"</span>,
                                         <span class="violet">password_confirmation</span>: <span class="maroon">"bar"</span> } }
    <b><span class="green">end</span></b>
    assert_template <span class="maroon">'users/new'</span>
    assert_select <span class="maroon">'div#error_explanation'</span>
    assert_select <span class="maroon">'div.field_with_errors'</span>
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"valid signup information"</span> <b><span class="green">do</span></b>
    get signup_path
    assert_difference <span class="maroon">'User.count'</span>, <span class="ash">1</span> <b><span class="green">do</span></b>
      post users_path, <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="maroon">"Example User"</span>,
<span epub:type="pagebreak" id="page_563"></span>                                         <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>,
                                         <span class="violet">password</span>:              <span class="maroon">"password"</span>,
                                         <span class="violet">password_confirmation</span>: <span class="maroon">"password"</span> } }
    <b><span class="green">end</span></b>
    follow_redirect!
<span class="marko">    <span class="green3"># assert_template 'users/show'</span></span>
<span class="marko">    <span class="green3"># assert is_logged_in?</span></span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">If you now try signing up as a new user, you should be redirected as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig05">Figure 11.5</a>, and an email like the one shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex025">Listing 11.25</a> should be generated. Note that you will <em>not</em> receive an actual email in a development environment, but it will show up in your server logs. (You may have to scroll up a bit to see it.) <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_4">Section 11.4</a> discusses how to send email for real in a production environment.</p>
<figure id="ch11fig05" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_05.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_05.jpg">
<figcaption><p><strong>Figure 11.5:</strong> The Home page with an activation message after signup.<span epub:type="pagebreak" id="page_564"></span></p></figcaption>
</figure>
<p class="ex-title" id="ch11ex025"><strong>Listing 11.25:</strong> A sample account activation email from the server log.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-25a" id="lis11-25">Click here to view code image</a></p>
<div class="example">
<pre>UserMailer#account_activation: processed outbound mail in 5.1ms
Delivered mail 5d606e97b7a44_28872b106582df988776a@ip-172-31-25-202.mail (3.2ms)
Date: Fri, 23 Aug 2019 22:54:15 +0000
From: noreply@example.com
To: michael@michaelhartl.com
Message-ID: &lt;5d606e97b7a44_28872b106582df988776a@ip-172-31-25-202.mail&gt;
Subject: Account activation
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_5d606e97b6f16_28872b106582df98876dd";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_5d606e97b6f16_28872b106582df98876dd
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

Hi Michael Hartl,

Welcome to the Sample App! Click on the link below to activate your account:

https://0ebe1dc6d40e4a4bb06e0ca7fe138127.vfs.cloud9.us-east-2.
amazonaws.com/account_activations/zdqs6sF7BMiDfXBaC7-6vA/
edit?email=michael%40michaelhartl.com

----==_mimepart_5d606e97b6f16_28872b106582df98876dd
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
    &lt;style&gt;
      /* Email styles need to be inline */
    &lt;/style&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;h1&gt;Sample App&lt;/h1&gt;

&lt;p&gt;Hi Michael Hartl,&lt;/p&gt;
<span epub:type="pagebreak" id="page_565"></span>&lt;p&gt;
Welcome to the Sample App! Click on the link below to activate your account:
&lt;/p&gt;

&lt;a href="https://0ebe1dc6d40e4a4bb06e0ca7fe138127.vfs.cloud9.us-east-2.
amazonaws.com/account_activations/zdqs6sF7BMiDfXBaC7-6vA/
edit?email=michael%40michaelhartl.com"&gt;Activate&lt;/a&gt;
  &lt;/body&gt;
&lt;/html&gt;

----==_mimepart_5d606e97b6f16_28872b106582df98876dd--
</pre>
</div>
<section>
<h5 class="h5" id="lev132">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Sign up as a new user and verify that you’re properly redirected. What is the content of the generated email in the server log? What is the value of the activation token?</p></li>
<li><p class="num">Verify at the console that the new user has been created but is not yet activated.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec11_3">11.3 Activating the Account</h3>
<p class="noindent">Now that we have a correctly generated email as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex025">Listing 11.25</a>, we need to write the <span class="dark-green"><strong><code>edit</code></strong></span> action in the Account Activations controller that actually activates the user. As usual, we’ll write a test for this action, and once the code is tested we’ll refactor it to move some functionality out of the Account Activations controller and into the User model.</p>
<section>
<h4 class="h4" id="sec11_3_1">11.3.1 Generalizing the <code>authenticated?</code> Method</h4>
<p class="noindent">Recall from the discussion in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2_1">Section 11.2.1</a> that the activation token and email are available as <span class="dark-green"><strong><code>params[:id]</code></strong></span> and <span class="dark-green"><strong><code>params[:email]</code></strong></span>, respectively. Following the model of passwords (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex07">Listing 8.7</a>) and remember tokens (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex09">Listing 9.9</a>), we plan to find and authenticate the user with code something like this:<span epub:type="pagebreak" id="page_566"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg566-1a" id="pg566-1">Click here to view code image</a></p>
<pre class="pre1">user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="violet">email</span>: params<span class="ash">[</span><span class="violet">:email</span><span class="ash">]</span>)
<b><span class="green">if</span></b> user <span class="ash">&amp;&amp;</span> user<span class="ash">.</span>authenticated?(<span class="violet">:activation</span>, params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)</pre>
<p class="noindent">(As we’ll see in a moment, there will be one extra boolean in this expression. See if you can guess what it will be.)</p>
<p class="indent">The preceding code uses the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method to test if the account activation digest matches the given token. At present this won’t work because that method is specialized to the remember token (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex06">Listing 9.6</a>):</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg566-2a" id="pg566-2">Click here to view code image</a></p>
<pre class="pre1"><span class="blue"># Returns true if the given token matches the digest.</span>
<b><span class="green">def</span></b> <span class="blue3">authenticated?</span>(remember_token)
  <b><span class="green">return false if</span></b> remember_digest<span class="ash">.</span>nil?
  <span class="red">BCrypt</span><span class="ash">::</span><span class="red">Password</span><span class="ash">.</span>new(remember_digest)<span class="ash">.</span>is_password?(remember_token)
<b><span class="green">end</span></b></pre>
<p class="noindent">Here <span class="dark-green"><strong><code>remember_digest</code></strong></span> is an attribute on the User model, and inside the model we can rewrite it as follows:</p>
<pre class="pre1"><span class="green1">self</span><span class="ash">.</span>remember_digest</pre>
<p class="noindent">Somehow, we want to be able to make this <em>variable</em>, so we can call</p>
<pre class="pre1"><span class="green1">self</span><span class="ash">.</span>activation_digest</pre>
<p class="noindent">instead by passing in the appropriate parameter to the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method.</p>
<p class="indent">The solution involves our first example of <em>metaprogramming</em>, which is essentially a program that writes a program. (Metaprogramming is one of Ruby’s strongest suits, and many of the “magic” features of Rails are due to its use of Ruby metaprogramming.) The key in this case is the powerful <span class="dark-green"><strong><code>send</code></strong></span> method, which lets us call a method with a name of our choice by “sending a message” to a given object. For example, in this console session we use <span class="dark-green"><strong><code>send</code></strong></span> on a native Ruby object to find the length of an array:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg566-3a" id="pg566-3">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console</span>
<b><span class="navy">&gt;&gt;</span></b> a <span class="ash">= [1</span>, <span class="ash">2</span>, <span class="ash">3]</span>
<b><span class="navy">&gt;&gt;</span></b> a<span class="ash">.</span>length
<span class="green">=&gt; 3</span>
<b><span class="navy">&gt;&gt;</span></b> a<span class="ash">.</span>send(<span class="violet">:length</span>)
<span class="green">=&gt; 3</span>
<b><span class="navy">&gt;&gt;</span></b> a<span class="ash">.</span>send(<span class="maroon">"length"</span>)
<span class="green">=&gt; 3</span></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_567"></span>Here we see that passing the symbol <span class="dark-green"><strong><code>:length</code></strong></span> or the string <span class="dark-green"><strong><code>"length"</code></strong></span> to <span class="dark-green"><strong><code>send</code></strong></span> is equivalent to calling the <span class="dark-green"><strong><code>length</code></strong></span> method on the given object. As a second example, we’ll access the <span class="dark-green"><strong><code>activation_digest</code></strong></span> attribute of the first user in the database:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg567-1a" id="pg567-1">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">&gt;&gt;</span></b> user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>first
<b><span class="navy">&gt;&gt;</span></b> user<span class="ash">.</span>activation_digest
<span class="green">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<b><span class="navy">&gt;&gt;</span></b> user<span class="ash">.</span>send(<span class="violet">:activation_digest</span>)
<span class="green">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<b><span class="navy">&gt;&gt;</span></b> user<span class="ash">.</span>send(<span class="maroon">"activation_digest"</span>)
<span class="green">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
&gt;&gt; attribute <span class="ash1">=</span> <span class="blue1">:activation</span>
&gt;&gt; user<span class="ash1">.</span>send(<span class="red2">"</span><span class="pink1">#{</span>attribute<span class="pink1">}</span><span class="red2">_digest"</span>)
<span class="green3">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span></pre>
<p class="noindent">Note that we’ve defined an <span class="dark-green"><strong><code>attribute</code></strong></span> variable equal to the symbol <span class="dark-green"><strong><code>:activation</code></strong></span> and used string interpolation to build up the proper argument to <span class="dark-green"><strong><code>send</code></strong></span>. This also would work with the string <span class="dark-green"><strong><code>'activation'</code></strong></span>, but using a symbol is more conventional. In either case,</p>
<pre class="pre1"><span class="maroon">"</span><b><span class="pink">#{</span></b>attribute<b><span class="pink">}</span></b><span class="maroon">_digest"</span></pre>
<p class="noindent">becomes</p>
<pre class="pre1"><span class="maroon">"activation_digest"</span></pre>
<p class="noindent">once the string is interpolated. (We saw how symbols are interpolated as strings in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_4_2">Section 7.4.2</a>.)</p>
<p class="indent">Based on this discussion of <span class="dark-green"><strong><code>send</code></strong></span>, we can rewrite the current <span class="dark-green"><strong><code>authenticated?</code></strong></span> method as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg567-2a" id="pg567-2">Click here to view code image</a></p>
<pre class="pre1"><span class="green3">def</span> <span class="blue3">authenticated?</span>(remember_token)
  digest <span class="ash1">=</span> <span class="green3">self</span><span class="ash1">.</span>send(<span class="red2">"remember_digest"</span>)
  <b><span class="green">return false if</span></b> digest<span class="ash">.</span>nil?
  <span class="red">BCrypt</span><span class="ash">::</span><span class="red">Password</span><span class="ash">.</span>new(digest)<span class="ash">.</span>is_password?(remember_token)
<b><span class="green">end</span></b></pre>
<p class="noindent">With this template in place, we can generalize the method by adding a function argument with the name of the digest, and then use string interpolation as we did earlier:<span epub:type="pagebreak" id="page_568"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg568-1a" id="pg568-1">Click here to view code image</a></p>
<pre class="pre1"><span class="green3">def</span> <span class="blue3">authenticated?</span>(attribute, token)
  digest <span class="ash1">=</span> <span class="green3">self</span><span class="ash1">.</span>send(<span class="red2">"</span><span class="pink1">#{</span>attribute<span class="pink1">}</span><span class="red2">_digest"</span>)
  <b><span class="green">return false if</span></b> digest<span class="ash">.</span>nil?
  <span class="red">BCrypt</span><span class="ash">::</span><span class="red">Password</span><span class="ash">.</span>new(digest)<span class="ash">.</span>is_password?(token)
<b><span class="green">end</span></b></pre>
<p class="noindent">(Here we have renamed the second argument <span class="dark-green"><strong><code>token</code></strong></span> to emphasize that it’s now generic.) Because we’re inside the user model, we can also omit <span class="dark-green"><strong><code>self</code></strong></span>, yielding the most idiomatically correct version:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg568-2a" id="pg568-2">Click here to view code image</a></p>
<pre class="pre1"><b><span class="green">def</span></b> <span class="blue3">authenticated?</span>(attribute, token)
  digest <span class="ash1">=</span> <span class="green3">send</span>(<span class="red2">"</span><span class="pink1">#{</span>attribute<span class="pink1">}</span><span class="red2">_digest"</span>)
  <b><span class="green">return false if</span></b> digest<span class="ash">.</span>nil?
  <span class="red">BCrypt</span><span class="ash">::</span><span class="red">Password</span><span class="ash">.</span>new(digest)<span class="ash">.</span>is_password?(token)
<b><span class="green">end</span></b></pre>
<p class="noindent">We can now reproduce the previous behavior of <span class="dark-green"><strong><code>authenticated?</code></strong></span> by invoking it like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg568-3a" id="pg568-3">Click here to view code image</a></p>
<pre class="pre1">user<span class="ash">.</span>authenticated?(<span class="violet">:remember</span>, remember_token)</pre>
<p class="indent">Applying this discussion to the User model yields the generalized <span class="dark-green"><strong><code>authenticated?</code></strong></span> method shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex026">Listing 11.26</a>.</p>
<p class="ex-title" id="ch11ex026"><strong>Listing 11.26:</strong> A generalized <span class="dark-green"><strong><code>authenticated?</code></strong></span> method. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-26a" id="lis11-26">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">User</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="blue"># Returns true if the given token matches the digest.</span>
  <b><span class="green">def</span></b> <span class="blue3">authenticated?</span>(attribute, token)
    digest <span class="ash">=</span> <span class="green1">send</span>(<span class="maroon">"</span><b><span class="pink">#{</span></b>attribute<b><span class="pink">}</span></b><span class="maroon">_digest"</span>)
    <b><span class="green">return false if</span></b> digest<span class="ash">.</span>nil?
    <span class="red">BCrypt</span><span class="ash">::</span><span class="red">Password</span><span class="ash">.</span>new(digest)<span class="ash">.</span>is_password?(token)
  <b><span class="green">end</span></b>
<span epub:type="pagebreak" id="page_569"></span>  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">The <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex026">Listing 11.26</a> caption indicates a <span class="red5"><small>RED</small></span> test suite:</p>
<p class="ex-title" id="ch11ex027"><strong>Listing 11.27:</strong> <span class="red5"><small>RED</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">The reason for the failure is that the <span class="dark-green"><strong><code>current_user</code></strong></span> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex09">Listing 9.9</a>) and the test for <span class="dark-green"><strong><code>nil</code></strong></span> digests (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex017">Listing 9.17</a>) both use the old version of <span class="dark-green"><strong><code>authenticated?</code></strong></span>, which expects one argument instead of two. Note that this is exactly the kind of error a test suite is supposed to catch.</p>
<p class="indent">To fix the issue, we simply update the two cases to use the generalized method, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex028">Listing 11.28</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex029">Listing 11.29</a>.</p>
<p class="ex-title" id="ch11ex028"><strong>Listing 11.28:</strong> Using the generalized <span class="dark-green"><strong><code>authenticated?</code></strong></span> method in <span class="dark-green"><strong><code>current_user</code></strong></span>. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/helpers/sessions_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-28a" id="lis11-28">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">module</span> <span class="blue3">SessionsHelper</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="blue"># Returns the current logged-in user (if any).</span>
  <b><span class="green">def</span></b> <span class="blue3">current_user</span>
    <b><span class="green">if</span></b> (user_id <span class="ash">=</span> session<span class="ash">[</span><span class="violet">:user_id</span><span class="ash">]</span>)
      <span class="violet">@current_user</span> <span class="ash">||=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="green1">id</span>: user_id)
    <b><span class="green">elsif</span></b> (user_id <span class="ash">=</span> cookies<span class="ash">.</span>encrypted<span class="ash">[</span><span class="violet">:user_id</span><span class="ash">]</span>)
      user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="green1">id</span>: user_id)
<span class="marko">      <span class="green3">if</span> user <span class="ash1">&amp;&amp;</span> user<span class="ash1">.</span>authenticated?(<span class="blue1">:remember</span>, cookies[<span class="blue1">:remember_token</span>])</span>
        log_in user
        <span class="violet">@current_user</span> <span class="ash">=</span> user
      <b><span class="green">end</span></b>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="ex-title" id="ch11ex029"><span epub:type="pagebreak" id="page_570"></span><strong>Listing 11.29:</strong> Using the generalized <span class="dark-green"><strong><code>authenticated?</code></strong></span> method in the User test. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/models/user_test.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-29a" id="lis11-29">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UserTest</span></b> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>,
                     <span class="violet">password</span>: <span class="maroon">"foobar"</span>, <span class="violet">password_confirmation</span>: <span class="maroon">"foobar"</span>)
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"authenticated? should return false for a user with nil digest"</span> <b><span class="green">do</span></b>
<span class="marko">   assert_not <span class="blue1">@user</span><span class="ash1">.</span>authenticated?(<span class="blue1">:remember</span>, <span class="red2">''</span>)</span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">At this point, the tests should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch11ex030"><strong>Listing 11.30:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">Refactoring the code shown here is incredibly more error-prone without a solid test suite, which is why we went to such trouble to write good tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_1_2">Section 9.1.2</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_3">Section 9.3</a>.</p>
<section>
<h5 class="h5" id="lev133">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Create and remember a new user at the console. What are the user’s remember and activation tokens? What are the corresponding digests?</p></li>
<li><p class="num">Using the generalized <span class="dark-green"><strong><code>authenticated?</code></strong></span> method from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex026">Listing 11.26</a>, verify that the user is authenticated according to both the remember token and the activation token.<span epub:type="pagebreak" id="page_571"></span></p></li>
</ol>
</section>
</section>
<section>
<h4 class="h4" id="sec11_3_2">11.3.2 Activation <code>edit</code> Action</h4>
<p class="noindent">With the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex026">Listing 11.26</a>, we’re now ready to write an <span class="dark-green"><strong><code>edit</code></strong></span> action that authenticates the user corresponding to the email address in the <span class="dark-green"><strong><code>params</code></strong></span> hash. Our test for validity will look like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg571-1a" id="pg571-1">Click here to view code image</a></p>
<pre class="pre1"><b><span class="green">if</span></b> user <span class="ash">&amp;&amp; !</span>user<span class="ash">.</span>activated? <span class="ash">&amp;&amp;</span> user<span class="ash">.</span>authenticated?(<span class="violet">:activation</span>, params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)</pre>
<p class="noindent">Note the presence of <span class="dark-green"><strong><code>!user.activated?</code></strong></span>, which is the extra boolean alluded to earlier in this section. It prevents our code from activating users who have already been activated, which is important because we’ll be logging in users upon confirmation, and we don’t want to allow attackers who manage to obtain the activation link to log in as the user.</p>
<p class="indent">If the user is authenticated according to our booleans, we need to activate the user and update the <span class="dark-green"><strong><code>activated_at</code></strong></span> timestamp:<sup><a id="ch11fn8a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn8" class="totri-footnote">8</a></sup></p>
<p class="footnote"><a id="ch11fn8" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn8a" class="totri-footnote">8</a>. Here we use two calls to <span class="dark-green"><strong><code>update_attribute</code></strong></span> rather than a single call to <span class="dark-green"><strong><code>update_attributes</code></strong></span> because (per <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_5">Section 6.1.5</a>) the latter would run the validations. When missing the user password, as in this case, these validations would fail.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg571-2a" id="pg571-2">Click here to view code image</a></p>
<pre class="pre1">user<span class="ash">.</span>update_attribute(<span class="violet">:activated</span>,    <b><span class="green">true</span></b>)
user<span class="ash">.</span>update_attribute(<span class="violet">:activated_at</span>, <span class="red">Time</span><span class="ash">.</span>zone<span class="ash">.</span>now)</pre>
<p class="noindent">This leads to the <span class="dark-green"><strong><code>edit</code></strong></span> action shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex031">Listing 11.31</a>. Note also that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex031">Listing 11.31</a> handles the case of an invalid activation token; this should rarely happen, but it’s easy enough to redirect in this case to the root URL.</p>
<p class="ex-title" id="ch11ex031"><strong>Listing 11.31:</strong> An <span class="dark-green"><strong><code>edit</code></strong></span> action to activate accounts.</p>
<pre class="pre2">app/controllers/account_activations_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-31a" id="lis11-31">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">AccountActivationsController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>

  <b><span class="green">def</span></b> <span class="blue3">edit</span>
    user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="violet">email</span>: params<span class="ash">[</span><span class="violet">:email</span><span class="ash">]</span>)
    <b><span class="green">if</span></b> user <span class="ash">&amp;&amp; !</span>user<span class="ash">.</span>activated? <span class="ash">&amp;&amp;</span> user<span class="ash">.</span>authenticated?(<span class="violet">:activation</span>, params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
      user<span class="ash">.</span>update_attribute(<span class="violet">:activated</span>, <b><span class="green">true</span></b>)
      user<span class="ash">.</span>update_attribute(<span class="violet">:activated_at</span>, <span class="red">Time</span><span class="ash">.</span>zone<span class="ash">.</span>now)
      log_in user
      flash<span class="ash">[</span><span class="violet">:success</span><span class="ash">] =</span> <span class="maroon">"Account activated!"</span>
      redirect_to user
<span epub:type="pagebreak" id="page_572"></span>    <b><span class="green">else</span></b>
      flash<span class="ash">[</span><span class="violet">:danger</span><span class="ash">] =</span> <span class="maroon">"Invalid activation link"</span>
      redirect_to root_url
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex031">Listing 11.31</a>, you should now be able to paste in the URL from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex025">Listing 11.25</a> to activate the relevant user. For example, on my system I visited the URL</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg572a" id="pg572">Click here to view code image</a></p>
<pre class="pre1">https://0ebe1dc6d40e4a4bb06e0ca7fe138127.vfs.cloud9.us-east-2.
amazonaws.com/account_activations/zdqs6sF7BMiDfXBaC7-6vA/
edit?email=michael%40michaelhartl.com
</pre>
<p class="noindent">and got the result shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig06">Figure 11.6</a>.</p>
<figure id="ch11fig06" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_06.jpg" alt="Image" width="677" height="512" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_06.jpg">
<figcaption><p><strong>Figure 11.6:</strong> The profile page after a successful activation.</p></figcaption>
</figure>
<p class="indent"><span epub:type="pagebreak" id="page_573"></span>Of course, currently user activation doesn’t actually <em>do</em> anything, because we haven’t changed how users log in. To have account activation mean something, we need to allow users to log in only if they are activated. As shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex032">Listing 11.32</a>, the way to do this is to log the user in as usual if <span class="dark-green"><strong><code>user.activated?</code></strong></span> is true; otherwise, we redirect to the root URL with a <span class="dark-green"><strong><code>warning</code></strong></span> message (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig07">Figure 11.7</a>).</p>
<figure id="ch11fig07" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_07.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_07.jpg">
<figcaption><p><strong>Figure 11.7:</strong> The warning message for a not-yet-activated user.</p></figcaption>
</figure>
<p class="ex-title" id="ch11ex032"><strong>Listing 11.32:</strong> Preventing unactivated users from logging in.</p>
<pre class="pre2">app/controllers/sessions_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-32a" id="lis11-32">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">SessionsController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>

  <b><span class="green">def</span></b> <span class="blue3">new</span>
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">create</span>
    user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="violet">email</span>: params<span class="ash">[</span><span class="violet">:session</span><span class="ash">][</span><span class="violet">:email</span><span class="ash">].</span>downcase)
    <b><span class="green">if</span></b> user <span class="ash">&amp;&amp;</span> user<span class="ash">.</span>authenticate(params<span class="ash">[</span><span class="violet">:session</span><span class="ash">][</span><span class="violet">:password</span><span class="ash">]</span>)
<span epub:type="pagebreak" id="page_574"></span><span class="marko">      <b><span class="green3">if</span></b> user<span class="ash1">.</span>activated?</span>
<span class="marko">        log_in user</span>
<span class="marko">        params[<span class="blue1">:session</span>][<span class="blue1">:remember_me</span>] <span class="ash1">==</span> <span class="red2">'1'</span> ? remember(user) : forget(user)</span>
<span class="marko">        redirect_back_or user</span>
<span class="marko">      <b><span class="green3">else</span></b></span>
<span class="marko">        message <span class="ash1">=</span> <span class="red2">"Account not activated. "</span></span>
<span class="marko">        message <span class="ash1">+=</span> <span class="red2">"Check your email for the activation link."</span></span>
<span class="marko">        flash[<span class="blue1">:warning</span>] <span class="ash1">=</span> message</span>
<span class="marko">        redirect_to root_url</span>
<span class="marko">      <b><span class="green3">end</span></b></span>
    <b><span class="green">else</span></b>
      flash<span class="ash">.</span>now<span class="ash">[</span><span class="violet">:danger</span><span class="ash">] =</span> <span class="maroon">'Invalid email/password combination'</span>
      render <span class="maroon">'new'</span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">destroy</span>
    log_out <b><span class="green">if</span></b> logged_in?
    redirect_to root_url
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">With that, apart from one refinement, we’ve finished the basic functionality of user activation. (That refinement is preventing unactivated users from being displayed, which is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_3_3">Section 11.3.3</a>).) In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_3_3">Section 11.3.3</a>, we’ll complete the process by adding some tests and then doing a little refactoring.</p>
<section>
<h5 class="h5" id="lev134">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Paste in the URL from the email generated in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2_4">Section 11.2.4</a>. What is the activation token?</p></li>
<li><p class="num">Verify at the console that the user is authenticated according to the activation token in the URL from the previous exercise. Is the user now activated?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec11_3_3">11.3.3 Activation Test and Refactoring</h4>
<p class="noindent">In this section, we’ll add an integration test for account activation. Because we already have a test for signing up with valid information, we’ll add the steps to the test <span epub:type="pagebreak" id="page_575"></span>developed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_4_4">Section 7.4.4</a> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex031">Listing 7.31</a>). There are quite a few steps, but they are mostly straightforward; see if you can follow along in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex033">Listing 11.33</a>. (The highlights in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex033">Listing 11.33</a> indicate lines that are especially important or easy to miss, but there are other new lines as well, so take care to add them all.)</p>
<p class="ex-title" id="ch11ex033"><strong>Listing 11.33:</strong> Adding account activation to the user signup test. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/users_signup_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-33a" id="lis11-33">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersSignupTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

<span class="marko">  <b><span class="green3">def</span></b> <span class="blue3">setup</span></span>
<span class="marko">    <span class="red2">ActionMailer</span><span class="ash1">::</span><span class="red2">Base</span><span class="ash1">.</span>deliveries<span class="ash1">.</span>clear</span>
<span class="marko">  <b><span class="green3">end</span></b></span>

  <span class="green1">test</span> <span class="maroon">"invalid signup information"</span> <b><span class="green">do</span></b>
    get signup_path
    assert_no_difference <span class="maroon">'User.count'</span> <b><span class="green">do</span></b>
      post users_path, <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="maroon">""</span>,
                                         <span class="violet">email</span>: <span class="maroon">"user@invalid"</span>,
                                         <span class="violet">password</span>: <span class="maroon">"foo"</span>,
                                         <span class="violet">password_confirmation</span>: <span class="maroon">"bar"</span> } }
    <b><span class="green">end</span></b>
    assert_template <span class="maroon">'users/new'</span>
    assert_select <span class="maroon">'div#error_explanation'</span>
    assert_select <span class="maroon">'div.field_with_errors'</span>
  <b><span class="green">end</span></b>

<span class="marko">  <span class="green3">test</span> <span class="red2">"valid signup information with account activation"</span> <b><span class="green3">do</span></b></span>
    get signup_path
    assert_difference <span class="maroon">'User.count'</span>, <span class="ash">1</span> <b><span class="green">do</span></b>
<span class="marko">      post users_path, <span class="blue1">params</span>: { <span class="blue1">user</span>: { <span class="green3">name</span>: <span class="red2">"Example User"</span>,</span>
                                 <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>,
                                 <span class="violet">password</span>:              <span class="maroon">"password"</span>,
                                 <span class="violet">password_confirmation</span>: <span class="maroon">"password"</span> } }
    <b><span class="green">end</span></b>
    assert_equal <span class="ash">1</span>, <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">Base</span><span class="ash">.</span>deliveries<span class="ash">.</span>size
    user <span class="ash">=</span> assigns(<span class="violet">:user</span>)
    assert_not user<span class="ash">.</span>activated?
    <span class="blue"># Try to log in before activation.</span>
    log_in_as(user)
    assert_not is_logged_in?
    <span class="blue"># Invalid activation token</span>
    get edit_account_activation_path(<span class="maroon">"invalid token"</span>, <span class="violet">email</span>: user<span class="ash">.</span>email)
    assert_not is_logged_in?
<span epub:type="pagebreak" id="page_576"></span>    <span class="blue"># Valid token, wrong email</span>
    get edit_account_activation_path(user<span class="ash">.</span>activation_token, <span class="violet">email</span>: <span class="maroon">'wrong'</span>)
    assert_not is_logged_in?
    <span class="blue"># Valid activation token</span>
    get edit_account_activation_path(user<span class="ash">.</span>activation_token, <span class="violet">email</span>: user<span class="ash">.</span>email)
    assert user<span class="ash">.</span>reload<span class="ash">.</span>activated?
    follow_redirect!
<span class="marko">    assert_template <span class="red2">'users/show'</span></span>
<span class="marko">    assert is_logged_in?</span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">There’s a lot of code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex033">Listing 11.33</a>, but the only completely novel code is in the line</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg576a" id="pg576">Click here to view code image</a></p>
<pre class="pre1">assert_equal <span class="ash">1</span>, <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">Base</span><span class="ash">.</span>deliveries<span class="ash">.</span>size</pre>
<p class="noindent">This code verifies that exactly one message was delivered. Because the <span class="dark-green"><strong><code>deliveries</code></strong></span> array is global, we have to reset it in the <span class="dark-green"><strong><code>setup</code></strong></span> method to prevent our code from breaking if any other tests deliver email (as will be the case in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>).</p>
<p class="indent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex033">Listing 11.33</a> also uses the <span class="dark-green"><strong><code>assigns</code></strong></span> method for the first time in the main tutorial. As explained in a <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">Chapter 9</a> exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_3_1">Section 9.3.1</a>), <span class="dark-green"><strong><code>assigns</code></strong></span> lets us access instance variables in the corresponding action. For example, the Users controller’s <span class="dark-green"><strong><code>create</code></strong></span> action defines an <span class="dark-green"><strong><code>@user</code></strong></span> variable (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex023">Listing 11.23</a>), so we can access it in the test using <span class="dark-green"><strong><code>assigns(:user)</code></strong></span>. The <span class="dark-green"><strong><code>assigns</code></strong></span> method is deprecated in default Rails tests as of Rails 5, but I still find it useful in many contexts, and it’s available via the <code>rails-controller-testing</code> gem we included in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03ex02">Listing 3.2</a>.</p>
<p class="indent">Finally, note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex033">Listing 11.33</a> restores the lines we commented out in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex024">Listing 11.24</a>.</p>
<p class="indent">At this point, the test suite should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch11ex034"><strong>Listing 11.34:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">With the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex033">Listing 11.33</a>, we’re ready to refactor a little by moving some of the user manipulation out of the controller and into the model. In particular, we’ll make an <span class="dark-green"><strong><code>activate</code></strong></span> method to update the user’s activation attributes and a <span epub:type="pagebreak" id="page_577"></span><span class="dark-green"><strong><code>send_activation_email</code></strong></span> to send the activation email. The extra methods appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex035">Listing 11.35</a>, and the refactored application code appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex036">Listing 11.36</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex037">Listing 11.37</a>.</p>
<p class="ex-title" id="ch11ex035"><strong>Listing 11.35:</strong> Adding user activation methods to the User model.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-35a" id="lis11-35">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">User</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="blue"># Activates an account.</span>
  <b><span class="green">def</span></b> <span class="blue3">activate</span>
<span class="marko">    update_attribute(<span class="blue1">:activated</span>, <b><span class="green3">true</span></b>)</span>
<span class="marko">    update_attribute(<span class="blue1">:activated_at</span>, <span class="red2">Time</span>.zone.now)</span>
  <b><span class="green">end</span></b>

  <span class="blue"># Sends activation email.</span>
  <b><span class="green">def</span></b> <span class="blue3">send_activation_email</span>
<span class="marko">    <span class="red2">UserMailer</span><span class="ash1">.</span>account_activation(<span class="green3">self</span>)<span class="ash1">.</span>deliver_now</span>
  <b><span class="green">end</span></b>

  <b><span class="green">private</span></b>
    <span class="ash">.</span>
    <span class="ash">.</span>
    <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="ex-title" id="ch11ex036"><strong>Listing 11.36:</strong> Sending email via the user model object.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-36a" id="lis11-36">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">create</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(user_params)
    <b><span class="green">if</span></b> <span class="violet">@user</span><span class="ash">.</span>save
<span class="marko">      <span class="blue1">@user</span><span class="ash1">.</span>send_activation_email</span>
      flash<span class="ash">[</span><span class="violet">:info</span><span class="ash">] =</span> <span class="maroon">"Please check your email to activate your account."</span>
      redirect_to root_url
    <b><span class="green">else</span></b>
      render <span class="maroon">'new'</span>
<span epub:type="pagebreak" id="page_578"></span>    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="ex-title" id="ch11ex037"><strong>Listing 11.37:</strong> Account activation via the user model object.</p>
<pre class="pre2">app/controllers/account_activations_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-37a" id="lis11-37">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">AccountActivationsController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>

  <b><span class="green">def</span></b> <span class="blue3">edit</span>
    user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="violet">email</span>: params<span class="ash">[</span><span class="violet">:email</span><span class="ash">]</span>)
    <b><span class="green">if</span></b> user <span class="ash">&amp;&amp; !</span>user<span class="ash">.</span>activated? <span class="ash">&amp;&amp;</span> user<span class="ash">.</span>authenticated?(<span class="violet">:activation</span>, params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
<span class="marko">      user<span class="ash1">.</span>activate</span>
      log_in user
      flash<span class="ash">[</span><span class="violet">:success</span><span class="ash">] =</span> <span class="maroon">"Account activated!"</span>
      redirect_to user
    <b><span class="green">else</span></b>
      flash<span class="ash">[</span><span class="violet">:danger</span><span class="ash">] =</span> <span class="maroon">"Invalid activation link"</span>
      redirect_to root_url
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex035">Listing 11.35</a> eliminates the use of <span class="dark-green"><strong><code>user.</code></strong></span>, which would break inside the User model because there is no such variable:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg578-1a" id="pg578-1">Click here to view code image</a></p>
<pre class="pre1"><span class="maroon5">-user.update_attribute(:activated,    true)</span>
<span class="maroon5">-user.update_attribute(:activated_at, Time.zone.now)</span>
<span class="green3">+update_attribute(:activated,    true)</span>
<span class="green3">+update_attribute(:activated_at, Time.zone.now)</span></pre>
<p class="noindent">(We could have switched from <span class="dark-green"><strong><code>user</code></strong></span> to <span class="dark-green"><strong><code>self</code></strong></span>, but recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_5">Section 6.2.5</a> that <span class="dark-green"><strong><code>self</code></strong></span> is optional inside the model.) It also changes <span class="dark-green"><strong><code>@user</code></strong></span> to <span class="dark-green"><strong><code>self</code></strong></span> in the call to the User mailer:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg578-2a" id="pg578-2">Click here to view code image</a></p>
<pre class="pre1"><span class="maroon5">-UserMailer.account_activation(@user).deliver_now</span>
<span class="green3">+UserMailer.account_activation(self).deliver_now</span></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_579"></span>These are <em>exactly</em> the kinds of details that are easy to miss during even a simple refactoring but will be caught by a good test suite. Speaking of which, the test suite should still be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch11ex038"><strong>Listing 11.38:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev135">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex035">Listing 11.35</a>, the <span class="dark-green"><strong><code>activate</code></strong></span> method makes two calls to the <span class="dark-green"><strong><code>update_attribute</code></strong></span>, each of which requires a separate database transaction. By filling in the template shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex039">Listing 11.39</a>, replace the two <span class="dark-green"><strong><code>update_attribute</code></strong></span> calls with a single call to <span class="dark-green"><strong><code>update_columns</code></strong></span>, which hits the database only once. (Note that, like <span class="dark-green"><strong><code>update_attribute</code></strong></span>, <span class="dark-green"><strong><code>update_columns</code></strong></span> doesn’t run the model callbacks or validations.) After making the changes, verify that the test suite is still <span class="green5"><small>GREEN</small></span>.</p></li>
<li><p class="num">Right now <em>all</em> users are displayed on the user index page at /users and are visible via the URL /users/:id, but it makes sense to show users only if they are activated. Arrange for this behavior by filling in the template shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex040">Listing 11.40</a>.<sup><a id="ch11fn9a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn9" class="totri-footnote">9</a></sup> (This template uses the Active Record <span class="dark-green"><strong><code>where</code></strong></span> method, which we’ll learn more about in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_3">Section 13.3.3</a>.)</p>
<p class="footnote"><a id="ch11fn9" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fn9a" class="totri-footnote">9</a>. Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex040">Listing 11.40</a> uses <span class="dark-green"><strong><code>and</code></strong></span> in place of <span class="dark-green"><strong><code>&amp;&amp;</code></strong></span>. The two are nearly identical, but the latter operator has a higher <em>precedence</em>, which binds too tightly to <span class="dark-green"><strong><code>root_url</code></strong></span> in this case. We could fix the problem by putting <span class="dark-green"><strong><code>root_url</code></strong></span> in parentheses, but the idiomatically correct way to do it is to use <span class="dark-green"><strong><code>and</code></strong></span> instead.</p></li>
<li><p class="num">To test the code in the previous exercise, write integration tests for both /users and /users/:id.<span epub:type="pagebreak" id="page_580"></span></p></li>
</ol>
<p class="ex-title" id="ch11ex039"><strong>Listing 11.39:</strong> A template for using <span class="dark-green"><strong><code>update_columns</code></strong></span>.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-39a" id="lis11-39">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">User</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  <b><span class="green">attr_accessor</span></b> <span class="violet">:remember_token</span>, <span class="violet">:activation_token</span>
  before_save   <span class="violet">:downcase_email</span>
  before_create <span class="violet">:create_activation_digest</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="blue"># Activates an account.</span>
  <b><span class="green">def</span></b> <span class="blue3">activate</span>
<span class="marko">    update_columns(<span class="blue1">activated</span>: <span class="red2">FILL_IN</span>, <span class="blue1">activated_at</span>: <span class="red2">FILL_IN</span>)</span>
  <b><span class="green">end</span></b>

  <span class="blue"># Sends activation email.</span>
  <b><span class="green">def</span></b> <span class="blue3">send_activation_email</span>
    <span class="red">UserMailer</span><span class="ash">.</span>account_activation(<span class="green">self</span>)<span class="ash">.</span>deliver_now
  <b><span class="green">end</span></b>

  <b><span class="green">private</span></b>

    <span class="blue"># Converts email to all lowercase.</span>
    <b><span class="green">def</span></b> <span class="blue3">downcase_email</span>
      <span class="green1">self</span><span class="ash">.</span>email <span class="ash">=</span> email<span class="ash">.</span>downcase
    <b><span class="green">end</span></b>

    <span class="blue"># Creates and assigns the activation token and digest.</span>
    <b><span class="green">def</span></b> <span class="blue3">create_activation_digest</span>
      <span class="green1">self</span><span class="ash">.</span>activation_token <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new_token
      <span class="green1">self</span><span class="ash">.</span>activation_digest <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>digest(activation_token)
    <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="ex-title" id="ch11ex040"><strong>Listing 11.40:</strong> A template for code to show only active users.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-40a" id="lis11-40">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">index</span>
<span class="marko">    <span class="blue1">@users</span> <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>where(<span class="blue1">activated</span>: <span class="red2">FILL_IN</span>)<span class="ash1">.</span>paginate(<span class="blue1">page</span>: params<span class="ash1">[</span><span class="blue1">:page</span><span class="ash1">]</span>)</span>
<span epub:type="pagebreak" id="page_581"></span>  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">show</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
<span class="marko">    redirect_to root_url <span class="pink2">and</span> <span class="green3">return unless</span> <span class="red2">FILL_IN</span></span>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec11_4">11.4 Email in Production</h3>
<p class="noindent">Now that we’ve got account activations working in development, in this section we’ll configure our application so that it can actually send email in production. We’ll first get set up with a free service to send email, and then configure and deploy our application.</p>
<p class="indent">To send email in production, we’ll use SendGrid, which is available as an add-on at Heroku for verified accounts. (Using SendGrid requires adding credit card information to your Heroku account, but there is no charge when verifying an account.) For our purposes, the “starter” tier (which as of this writing is limited to 400 emails a day but costs nothing) is the best fit. We can add it to our app as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg581a" id="pg581">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> heroku addons:create sendgrid:starter</pre>
<p class="noindent">(This might fail on systems with an older version of Heroku’s command-line interface. In this case, either upgrade to the latest Heroku toolbelt or try the older syntax <span class="dark-green"><strong><code>heroku addons:add sendgrid:starter</code></strong></span>.)</p>
<p class="indent">To configure our application to use SendGrid, we need to fill out the SMTP settings for our production environment. As shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex041">Listing 11.41</a>, you will also have to define a <span class="dark-green"><strong><code>host</code></strong></span> variable with the address of your production website.</p>
<p class="ex-title" id="ch11ex041"><strong>Listing 11.41:</strong> Configuring Rails to use SendGrid in production.</p>
<pre class="pre2">config/environments/production.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#lis11-41a" id="lis11-41">Click here to view code image</a></p>
<div class="example">
<pre><span class="red">Rails</span><span class="ash">.</span>application<span class="ash">.</span>configure <b><span class="green">do</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<span epub:type="pagebreak" id="page_582"></span>  config<span class="ash">.</span>action_mailer<span class="ash">.</span>raise_delivery_errors <span class="ash">=</span> <b><span class="green">true</span></b>
  config<span class="ash">.</span>action_mailer<span class="ash">.</span>delivery_method <span class="ash">=</span> <span class="violet">:smtp</span>
<span class="marko">  <span class="green3">host</span> <span class="ash1">=</span> <span class="red2">'&lt;your heroku app&gt;.herokuapp.com'</span></span>
  config<span class="ash">.</span>action_mailer<span class="ash">.</span>default_url_options <span class="ash">=</span> { <span class="violet">host</span>: host }
  <span class="red">ActionMailer</span><span class="ash">::</span><span class="red">Base</span><span class="ash">.</span>smtp_settings <span class="ash">=</span> {
    <span class="violet">:address</span>        <span class="ash">=&gt;</span> <span class="maroon">'smtp.sendgrid.net'</span>,
    <span class="violet">:port</span>           <span class="ash">=&gt;</span> <span class="maroon">'587'</span>,
    <span class="violet">:authentication</span> <span class="ash">=&gt;</span> <span class="violet">:plain</span>,
    <span class="violet">:user_name</span>      <span class="ash">=&gt;</span> <span class="red">ENV</span><span class="ash">[</span><span class="maroon">'SENDGRID_USERNAME'</span><span class="ash">]</span>,
    <span class="violet">:password</span>       <span class="ash">=&gt;</span> <span class="red">ENV</span><span class="ash">[</span><span class="maroon">'SENDGRID_PASSWORD'</span><span class="ash">]</span>,
    <span class="violet">:domain</span>         <span class="ash">=&gt;</span> <span class="maroon">'heroku.com'</span>,
    <span class="violet">:enable_starttls_auto</span> <span class="ash">=&gt;</span> <b><span class="green">true</span></b>
  }
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">The email configuration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex041">Listing 11.41</a> includes the <span class="dark-green"><strong><code>user_name</code></strong></span> and <span class="dark-green"><strong><code>password</code></strong></span> of the SendGrid account, but note that they are accessed via the <span class="dark-green"><strong><code>ENV</code></strong></span> environment variable instead of being hard-coded. This is a best practice for production applications, which for security reasons should never expose sensitive information such as raw passwords in source code. In the present case, these variables are configured automatically via the SendGrid add-on, but we’ll see an example in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_4">Section 13.4.4</a> where we’ll have to define them ourselves. In case you’re curious, you can view the environment variables used in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11ex041">Listing 11.41</a> as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg582-1a" id="pg582-1">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> heroku config:get SENDGRID_USERNAME
<b><span class="navy">$</span></b> heroku config:get SENDGRID_PASSWORD</pre>
<p class="indent">At this point, you should merge the topic branch into master:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg582-2a" id="pg582-2">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git add -A
$ git commit -m "Add account activation"
$ git checkout master
$ git merge account-activation</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_583"></span>Then push up to the remote repository and deploy to Heroku:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11_images.xhtml#pg583a" id="pg583">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git push &amp;&amp; git push heroku
$ heroku run rails db:migrate
</pre>
<p class="indent">Once the Heroku deploy has finished, try signing up for the sample application in production using an email address you control. You should get an activation email as implemented in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2">Section 11.2</a>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig08">Figure 11.8</a>. Clicking on the link should activate the account as promised, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11fig09">Figure 11.9</a>.</p>
<figure id="ch11fig08" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_08.jpg" alt="Image" width="678" height="297" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_08.jpg">
<figcaption><p><strong>Figure 11.8:</strong> An account activation email sent in production.</p></figcaption>
</figure>
<figure id="ch11fig09" class="image-l">
<img src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/fig11_09.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig11_09.jpg">
<figcaption><p><strong>Figure 11.9:</strong> Successful account activation in production.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev136">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Sign up for a new account in production. Did you get the email?</p></li>
<li><p class="num">Click on the link in the activation email to confirm that it works. What is the corresponding entry in the server log? <em>Hint</em>: Run <span class="dark-green"><strong><code>heroku logs</code></strong></span> at the command line.<span epub:type="pagebreak" id="page_584"></span></p></li>
</ol>
</section>
</section>
<section>
<h3 class="h3" id="sec11_5">11.5 Conclusion</h3>
<p class="noindent">With the added account activation, our sample application’s signup, login, and logout machinery is nearly complete. The only significant feature left is allowing users to reset their passwords if they forget them. As we’ll see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>, password reset shares many features with account activation, which means that we’ll be able to put the knowledge we’ve gained in this chapter to good use.</p>
<section>
<h4 class="h4" id="sec11_5_1">11.5.1 What We Learned in this Chapter</h4>
<p class="bullet">• Like sessions, account activations can be modeled as a resource despite not being Active Record objects.</p>
<p class="bullet">• Rails can generate Action Mailer actions and views to send email.</p>
<p class="bullet">• Action Mailer supports both plain-text and HTML mail.<span epub:type="pagebreak" id="page_585"></span></p>
<p class="bullet">• As with ordinary actions and views, instance variables defined in mailer actions are available in mailer views.</p>
<p class="bullet">• Account activations use a generated token to create a unique URL for activating users.</p>
<p class="bullet">• Account activations use a hashed activation digest to securely identify valid activation requests.</p>
<p class="bullet">• Both mailer tests and integration tests are useful for verifying the behavior of the User mailer.</p>
<p class="bullet">• We can send email in production using SendGrid.<span epub:type="pagebreak" id="page_586"></span></p>
</section>
</section>
</section>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-13" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 10. Updating, Showing, and Deleting Users</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 12. Password Reset</div>
        </a>
    
  
  </div>

</section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed slideUp">
        
        
          <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        

        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
  <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">© 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(1)" charset="utf-8"></script><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/embed.js.download"></script>
    <script src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(2)" charset="utf-8"></script>
  

<div></div><div></div><div class="selection_bubble_root" style="display: none;"></div><div class="annotator-notice"></div><div class="font-flyout" style="top: 201.006px; left: 1194.34px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#">Reset</a>
</div>
</div><script type="text/javascript" async="" src="./Chapter 11. Account Activation - Ruby on Rails Tutorial, 6th Edition_files/generic1604331345324.js.download" charset="UTF-8"></script><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script><span></span><script type="text/javascript" id="">dataLayer.push({"ld.experiment":void 0,"ld.variation":void 0});</script></body></html>