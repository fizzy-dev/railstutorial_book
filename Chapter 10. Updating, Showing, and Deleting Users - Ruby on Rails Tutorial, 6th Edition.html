<!DOCTYPE html>
<!-- saved from url=(0080)https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage no-applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/ruby-on-rails/9780136702726/ch10.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="10224494" data-user-uuid="66943332-5511-462c-876e-5d5b720c7edf" data-username="czjtgu3dkobug4zdmolfga2wembsmu" data-account-type="Trial" data-activated-trial-date="12/02/2020" data-archive="9780136702726" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch10.xhtml" data-epub-title="Ruby on Rails Tutorial, 6th Edition" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780136702726"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/css" rel="stylesheet" type="text/css"><title>Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition</title><link rel="stylesheet" href="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/output.731fc84c4f9a.css" type="text/css"><link rel="stylesheet" type="text/css" href="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/font-awesome.min.css"><style type="text/css" title="ibis-book">@page{margin:1em 2em}#sbo-rt-content div{margin-top:1em;margin-bottom:1em;margin-left:1em;margin-right:1em;text-align:justify}#sbo-rt-content div.cover img{max-width:99%;max-height:99%}#sbo-rt-content .att{text-align:right}#sbo-rt-content .cover{margin-top:.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .h1{margin-top:1.5em;margin-bottom:.5em;font-weight:bold;font-size:210%;page-break-after:avoid;border-bottom:solid .1em;text-align:center}#sbo-rt-content .halftitle{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:210%;page-break-after:avoid;text-align:center}#sbo-rt-content .h2{margin-top:1em;margin-bottom:.1em;font-weight:bold;font-size:180%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2f{margin-top:1em;margin-bottom:2.5em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2t{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .center{text-align:center}#sbo-rt-content .h3{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:160%;page-break-after:avoid;text-align:left}#sbo-rt-content .h4{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:130%;page-break-after:avoid;text-align:left}#sbo-rt-content .h5{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:120%;page-break-after:avoid;text-align:left}#sbo-rt-content ul{margin-top:1em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content ul.sq{list-style-type:square}#sbo-rt-content ul.sq li p,#sbo-rt-content ul.sq li p.noindent{margin-top:.5em;margin-left:1em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .left{text-align:left}#sbo-rt-content .ex-title{margin-top:.8em;margin-bottom:.5em;text-indent:.1em;font-size:100%}#sbo-rt-content code{font-family:Courier,Courier New,monospace;font-size:small}#sbo-rt-content pre{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small}#sbo-rt-content .pre3{font-family:Courier,Courier New,monospace;margin-top:1em;margin-bottom:1em;margin-left:2.9em;background-color:#E6E6E6}#sbo-rt-content .equ{margin-top:.8em;margin-bottom:.5em;text-align:center}#sbo-rt-content .footnum{margin-top:.7em;margin-bottom:.5em;text-indent:-1em;margin-left:3.3em}#sbo-rt-content .footnotep{margin-top:.8em;margin-left:.8em;margin-bottom:.5em;text-indent:.8em}#sbo-rt-content .mark1{background-color:#F4F7F9}#sbo-rt-content .codelink{margin-top:.2em;margin-bottom:.5em}#sbo-rt-content .middle img{vertical-align:middle}#sbo-rt-content .box{margin-top:.6em;margin-bottom:1em;margin-left:.1em;margin-right:.8em;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .box-bq{font-size:.8em;margin-top:.8em;margin-bottom:.5em;margin-left:1.6em;text-indent:.1em;background-color:#E6E6E6}#sbo-rt-content .boxip{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:.8em;background-color:#E6E6E6}#sbo-rt-content ol.num{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p,#sbo-rt-content ol.num li p.number{margin-top:.5em;margin-left:.2em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .num-p{margin-top:.5em;margin-bottom:.5em;margin-left:0}#sbo-rt-content .bullet{margin-top:.7em;margin-bottom:.5em;text-indent:-.8em;margin-left:2em}#sbo-rt-content .credit{margin-top:.1em;margin-bottom:.1em;text-indent:-1.5em;margin-left:2em}#sbo-rt-content .box-caption{margin-top:.1em;margin-bottom:1em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:left}#sbo-rt-content .example{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small;border-top:.02em solid black;border-bottom:.02em solid black}#sbo-rt-content .image-l{margin-top:.8em;margin-left:1em;text-align:center}#sbo-rt-content .topbot{margin-top:.8em;margin-bottom:.5em;border-bottom:solid black .1em;border-top:solid black .1em;text-indent:.1em}#sbo-rt-content .uln{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash1{margin-top:.7em;margin-bottom:.7em;margin-left:3em}#sbo-rt-content .tr{border-bottom:.1em solid black}#sbo-rt-content th{text-align:left}#sbo-rt-content td{padding-left:.1em;padding-top:0;padding-bottom:0;vertical-align:top;text-align:left}#sbo-rt-content .mark{background-color:#E6E6E6}#sbo-rt-content .pre1{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:0;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .pre2{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content .tab-thc{margin-top:.1em;margin-bottom:.1em;border-bottom:solid black .1em;text-align:center}#sbo-rt-content .tab-th{margin-top:.1em;border-bottom:solid black .1em;border-top:solid black .1em;text-align:left}#sbo-rt-content .author{margin-top:2.5em;margin-bottom:5.5em;text-align:center;font-size:120%}#sbo-rt-content .pub{margin-top:1.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .pub1{font-weight:bold;font-size:.9em;margin-top:.1em;margin-bottom:.5em;text-align:center}#sbo-rt-content .copy{margin-top:.9em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .copy1{margin-top:.9em;margin-bottom:.2em;text-indent:.02em}#sbo-rt-content .copy2{margin-top:.2em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .title{margin-top:1em;margin-bottom:.2em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:center}#sbo-rt-content .noindent{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .tab-para{margin-top:.1em;margin-bottom:.1em;margin-left:.1em;text-indent:0}#sbo-rt-content .tab-parai{margin-top:.1em;margin-bottom:.1em;margin-left:1.1em;text-indent:-1.1em}#sbo-rt-content .boxnp{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .toc-intro{margin-top:.1em;margin-bottom:.5em;margin-left:1.5em;text-align:left}#sbo-rt-content .tocchap{margin-top:1.5em;margin-bottom:.4em;margin-left:3.4em;text-indent:-4em}#sbo-rt-content .toclev1{margin-top:.4em;margin-bottom:.4em;margin-left:1em}#sbo-rt-content .toclev2{margin-top:.4em;margin-bottom:.4em;margin-left:2.6em}#sbo-rt-content .toclev1a{margin-top:.4em;margin-bottom:.4em;margin-left:.5em}#sbo-rt-content .toc-index{margin-top:2em;margin-bottom:.4em;margin-left:.7em}#sbo-rt-content .indexmain{margin-top:.4em;margin-bottom:.2em;margin-left:.8em;text-indent:-.8em}#sbo-rt-content .indexsub{margin-top:.4em;margin-bottom:.2em;margin-left:1.7em;text-indent:-.7em}#sbo-rt-content .indexsubsub{margin-top:.4em;margin-bottom:.2em;font-style:italic;margin-left:3em;text-indent:-.9em}#sbo-rt-content figcaption{margin-top:.8em;margin-bottom:.5em;color:black;text-align:left;text-indent:.1em}#sbo-rt-content .subtitle{margin-top:.1em;margin-bottom:1em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .edition{margin-top:2em;margin-bottom:3em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .indent{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:1.5em}#sbo-rt-content .h2a{margin-top:.1em;margin-bottom:2em;font-weight:bold;font-size:190%;page-break-after:avoid;text-align:left}#sbo-rt-content figure>img{max-width:99%;max-height:99%}#sbo-rt-content figure{margin-top:1em;margin-bottom:1em;margin-left:.5em;margin-right:1.5em}#sbo-rt-content none{list-style-type:none}#sbo-rt-content a{text-decoration:none}#sbo-rt-content .footnote{font-size:.8em;margin-top:.1em;margin-bottom:.5em;margin-left:.8em}#sbo-rt-content .none{margin-top:.5em;margin-left:1em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content div.image-p img{width:80%}#sbo-rt-content .image-p{page-break-before:always;text-align:center}#sbo-rt-content table{border-collapse:collapse;border-spacing:0;background:transparent;vertical-align:top;margin-top:.1em;margin-right:.1em;margin-bottom:.9em;margin-left:0;width:100%}#sbo-rt-content .tab-parar{margin-top:.1em;margin-bottom:.1em;text-indent:.1em;text-align:right}#sbo-rt-content .h2i{margin-top:1em;margin-bottom:2.1em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content pre{overflow:auto;-ms-overflow:auto;-moz-overflow:auto;-webkit-overflow:auto;-ms-padding-bottom:5pt;-moz-padding-bottom:5pt;-webkit-padding-bottom:5pt}#sbo-rt-content .maroon{color:#BB2121}#sbo-rt-content .green{color:#005A00}#sbo-rt-content .green1{color:#48785D}#sbo-rt-content .navy{color:#504B72}#sbo-rt-content .ash{color:#666}#sbo-rt-content .blue{color:#408080}#sbo-rt-content .green3{color:#00A100}#sbo-rt-content .blue1{color:#0000B8}#sbo-rt-content .violet{color:#1A177D}#sbo-rt-content .pink{color:#A131A1}#sbo-rt-content .pink1{color:#A131A1}#sbo-rt-content .red{color:#800}#sbo-rt-content .blue3{color:#2E3192}#sbo-rt-content .red2{color:#B80000}#sbo-rt-content .green4{color:#269200}#sbo-rt-content .ash1{color:#666}#sbo-rt-content .ash2{color:#33484A}#sbo-rt-content .red2{color:#640000}#sbo-rt-content .ash3{color:#7D8F29}#sbo-rt-content .red5{color:#BD7B00}#sbo-rt-content .maroon1{color:#B66600}#sbo-rt-content .blue5{color:#1F3BFF}#sbo-rt-content .red6{color:#B68}#sbo-rt-content .green7{color:#14B600}#sbo-rt-content .maroon2{color:#B66600}#sbo-rt-content .pink2{color:#AC21FF}#sbo-rt-content .pink3{color:#AC21FF}#sbo-rt-content .lighgreen{color:#5FA100}#sbo-rt-content .lighblue{color:#269271}#sbo-rt-content .darkmaroon{color:#269271}#sbo-rt-content .maroon5{color:#A10000}#sbo-rt-content .blue6{color:#0000B9}#sbo-rt-content .marko{background-color:#FAF9CE}#sbo-rt-content .green5{color:#1C8B43}#sbo-rt-content .colork1{color:#136433;font-weight:bold}#sbo-rt-content .colork2{color:#504C72}#sbo-rt-content .colork3{color:#51785D}#sbo-rt-content .colork4{color:#303192}#sbo-rt-content .colork5{color:#955744}#sbo-rt-content .colork6{color:#5C70BA}#sbo-rt-content .colork7{color:#487864}#sbo-rt-content .colork8{color:#5C5778}#sbo-rt-content .colork9{color:#666}#sbo-rt-content .colork10{color:#48785D}#sbo-rt-content .colork11{color:#BC654D}#sbo-rt-content .colork12{color:#3E8185}#sbo-rt-content .colork13{color:#C62425}#sbo-rt-content .colork14{color:#1D8C43}#sbo-rt-content .colork15{color:#0D8140}#sbo-rt-content .colork16{color:#BB2425}#sbo-rt-content .colork17{color:#985744}#sbo-rt-content .colork18{color:#6C8896}#sbo-rt-content .colork19{color:#2A2C80}#sbo-rt-content .colork20{color:#BD2425}#sbo-rt-content .redk1{color:#EE1C25}#sbo-rt-content .colork21{color:#2A2C77}#sbo-rt-content .colork22{color:#955744}#sbo-rt-content .colork23{color:#BC6561}#sbo-rt-content .colork24{color:#BE7D2B}#sbo-rt-content .colork25{color:#8E7C5D}#sbo-rt-content .colork26{color:#7C5778}#sbo-rt-content .colork27{color:#9D1C1F}#sbo-rt-content .colork28{color:#AA5744}#sbo-rt-content .colork29{color:#C59861}#sbo-rt-content .grayk1{color:#C0908E}#sbo-rt-content .pd_green{color:#48785d}#sbo-rt-content .dark-green{color:#146333}#sbo-rt-content .mark1{background-color:#faf9ce}#sbo-rt-content .mark{background-color:#faf9ce}#sbo-rt-content .pd_ash{color:#666}#sbo-rt-content .pd_blue7{color:#6c8896}#sbo-rt-content .pd_blue1{color:#504b72}#sbo-rt-content .pd_red{color:#965744}#sbo-rt-content .pd_red2{color:#bb654e}#sbo-rt-content .pd_red5{color:#ed1c24}#sbo-rt-content .pd_blue5{color:#2e3192}#sbo-rt-content .pd_green4{color:#269200}#sbo-rt-content .pd_green5{color:#1c8b43}#sbo-rt-content .pd_blue3{color:#2c2c78}#sbo-rt-content .pd_orange{color:#c49847}</style><script type="text/javascript" async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/cool-2.1.15.min.js.download"></script><script type="text/javascript" async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/ec.js.download"></script><script type="text/javascript" async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/analytics.js.download"></script><script type="text/javascript" async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/f.txt"></script><script type="text/javascript" async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/js"></script><script crossorigin="anonymous" integrity="sha256-NiDMmov61Y536X/eLXLiDGzFVFmNLtPyu4b5aFB54ks=" type="text/javascript" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/appcues.main.11e38ef4746fd64ab30c11794299d10b30bcb704.js.download" async=""></script><script async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/gtm.js.download"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780136702726/chapter/ch10.xhtml",
          "book_id": "9780136702726",
          "chapter_uri": "ch10.xhtml",
          "position": 27.4567491080775,
          "user_uuid": "66943332-5511-462c-876e-5d5b720c7edf",
          "next_chapter_uri": "/library/view/ruby-on-rails/9780136702726/ch11.xhtml"
        
      },
      title: "Ruby on Rails Tutorial, 6th Edition",
      author_list: "Michael Hartl",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: true
    };
    // ]]></script><script src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/modernizr.8e35451ddb64.js.download"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta name="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta property="og:title" content="Chapter 10. Updating, Showing, and Deleting Users"><meta itemprop="isPartOf" content="/library/view/ruby-on-rails/9780136702726/"><meta itemprop="name" content="Chapter 10. Updating, Showing, and Deleting Users"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780136702726/"><meta property="og:description" itemprop="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9780136702726"><meta property="og:book:author" itemprop="author" content="Michael Hartl"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '66943332-5511-462c-876e-5d5b720c7edf';
      dataLayer.push({userIdentifier: '66943332-5511-462c-876e-5d5b720c7edf'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = 'ba5f3401-307d-4b66-90a6-a97047c63525';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/vendor.3eecedff6f59.js.download"></script><script defer="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/reader.772cf1e31d6c.js.download"></script><iframe src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource.html"></iframe><iframe src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(3).html"></iframe><iframe src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(4).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-q9sKb2HpA5fJjN1cK9LjLaEXff5ix81Rv1Y3xJFptPE=" crossorigin="anonymous" href="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/container.11e38ef4746fd64ab30c11794299d10b30bcb704.css"><iframe src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(5).html"></iframe><script src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/f(1).txt"></script><script async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/MathJax.js.download"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
</style><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style></head>


<body class="reading sidenav  scalefonts subscribe-panel library nav-collapsed"><div id="MathJax_Message" style="display: none;"></div>

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="working hide" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/66943332-5511-462c-876e-5d5b720c7edf/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Attend</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/live-training/" class="l2 nav-icn"><span>Live Trainings</span></a></li><li><a href="https://learning.oreilly.com/featured/architectural-katas" class="l2 nav-icn"><span>Architectural Katas</span></a></li><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interact</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/?classification=content-scenario" class="l2 nav-icn"><span>Scenarios</span></a></li><li><a href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario" class="l2 nav-icn"><span>Sandboxes</span></a></li><li><a href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li><a href="https://learning.oreilly.com/answers/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"></path></svg><span>Answers</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://learning.oreilly.com/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Ruby on Rails Tutorial, 6th Edition
      
    </h1></span></a><div class="toc-contents" style="max-height: 0px;">
  <div class="sbo-toc">
    <button type="button" class="sbo-toc-thumb close"><div class="visuallyhidden">Close</div></button>
      <section class="ios-app-teaser">
        <ul>
            <li><a class="js-toc-link toc-link" href="https://itunes.apple.com/gb/app/safari-queue-library-over/id881697395?mt=8" role="button">Install App</a></li>
            <li><a class="js-toc-link toc-link" href="safaridetail://9780136702726" role="button">Open in App</a></li>
        </ul>
      </section>
      <div class="sbo-book-meta">
        
        <span class="cover">
         <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">
          <img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource" alt="Cover image for Ruby on Rails Tutorial, 6th Edition" height="184" width="141">
        </a>
        </span>
        <span class="title">
          
            
                <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
                  <img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/addison-wesley.png" class="publisher-logo video" alt="publisher logo">
                </a>
            
          

          <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">Ruby on Rails Tutorial, 6th Edition</a>
        </span>
        
        <span class="authors">by Michael Hartl</span>
        

        
        <span class="publishers t-publishers">Published by
          <!-- Show publisher page link if publisher pages switch is on -->
          
            <a class="t-publisher-link toc-link js-toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
              Addison-Wesley Professional</a>, 2020
          
        </span>
        

    

    </div>
  <ol class="tocList">
    
    
    
     

     <li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/cover.xhtml">
        Cover Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref00.xhtml">
        About This eBook <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/halftitle.xhtml">
        Halftitle Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/title.xhtml">
        Title Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/copy.xhtml">
        Copyright Page <span class="minutes">(02:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/toc.xhtml#toc">
        Contents <span class="minutes">(05:45 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref02.xhtml#pref02">
        Foreword <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref03.xhtml#pref03">
        Acknowledgments <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref04.xhtml#pref04">
        About the Author <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#ch01">
        Chapter 1. From Zero to Deploy <span class="minutes">(77:03 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">
        Chapter 2. A Toy App <span class="minutes">(50:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03">
        Chapter 3. Mostly Static Pages <span class="minutes">(63:15 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04">
        Chapter 4. Rails-Flavored Ruby <span class="minutes">(57:30 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">
        Chapter 5. Filling in the Layout <span class="minutes">(60:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">
        Chapter 6. Modeling Users <span class="minutes">(67:51 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">
        Chapter 7. Sign Up <span class="minutes">(79:21 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">
        Chapter 8. Basic Login <span class="minutes">(66:42 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">
        Chapter 9. Advanced Login <span class="minutes">(52:54 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1 currently-reading">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">
        Chapter 10. Updating, Showing, and Deleting Users <span class="minutes">(73:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">
        Chapter 11. Account Activation <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">
        Chapter 12. Password Reset <span class="minutes">(48:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">
        Chapter 13. User Microposts <span class="minutes">(106:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">
        Chapter 14. Following Users <span class="minutes">(78:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml#index">
        Index <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/credits.xhtml#credits">
        Credits <span class="minutes">(19:33 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01_images.xhtml#ch01_images">
        Code Snippets <span class="minutes">(09:12 mins)</span>
       </a>
      
        
      
   </li></ol>
 </div>



</div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780136702726/chapter/ch10.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li class="currently-reading"><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml&amp;text=Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition&amp;via=OReillyMedia"><span>Twitter</span></a></li><li class="currently-reading"><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Facebook</span></a></li><li class="currently-reading"><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Google Plus</span></a></li><li class="currently-reading"><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Chapter%2010.%20Updating%2C%20Showing%2C%20and%20Deleting%20Users&amp;body=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml%0D%0Afrom%20Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document"><script src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/48743.js.download"></script>
<script>
  var userId = "66943332-5511-462c-876e-5d5b720c7edf";

  var userObject = {
    firstName: "Trần",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2020-12-01",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 9. Advanced Login</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 11. Account Activation</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section epub:type="chapter">
<h2 class="h2" id="ch10"><span epub:type="pagebreak" id="page_475"></span>Chapter 10</h2>
<h2 class="h2a">Updating, Showing, and Deleting Users</h2>
<p class="noindent">In this chapter, we complete the REST actions for the Users resource (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>) by adding <span class="green"><strong><code>edit</code></strong></span>, <span class="green"><strong><code>update</code></strong></span>, <span class="green"><strong><code>index</code></strong></span>, and <span class="green"><strong><code>destroy</code></strong></span> actions. We’ll start by giving users the ability to update their profiles, which will also provide a natural opportunity to enforce an authorization model (made possible by the authentication code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a>). Then we’ll make a listing of all users (also requiring authentication), which will motivate the introduction of sample data and pagination. Finally, we’ll add the ability to destroy users, wiping them clear from the database. Since we can’t allow just any user to have such dangerous powers, we’ll take care to create a privileged class of administrative users authorized to delete other users.</p>
<section>
<h3 class="h3" id="sec10_1">10.1 Updating Users</h3>
<p class="noindent">The pattern for editing user information closely parallels that for creating new users (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>). Instead of a <span class="green"><strong><code>new</code></strong></span> action rendering a view for new users, we have an <span class="green"><strong><code>edit</code></strong></span> action rendering a view to edit users; instead of <span class="green"><strong><code>create</code></strong></span> responding to a <code>POST</code> request, we have an <span class="green"><strong><code>update</code></strong></span> action responding to a <code>PATCH</code> request (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#box3_2">Box 3.2</a>). The biggest difference is that, while anyone can sign up, only the current user should be able to update their information. The authentication machinery from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a> will allow us to use a <em>before filter</em> to ensure that this is the case.</p>
<p class="indent">To get started, let’s start work on an <span class="green"><strong><code>updating-users</code></strong></span> topic branch:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg475-1a" id="pg475-1">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> git checkout -b updating-users</pre>
<section>
<h4 class="h4" id="sec10_1_1"><span epub:type="pagebreak" id="page_476"></span>10.1.1 Edit Form</h4>
<p class="noindent">We start with the edit form, whose mockup appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig01">Figure 10.1</a>.<sup><a id="ch10fn1a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn1" class="totri-footnote">1</a></sup> To turn the mockup in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig01">Figure 10.1</a> into a working page, we need to fill in both the Users controller <span class="green"><strong><code>edit</code></strong></span> action and the user edit view. We start with the <span class="green"><strong><code>edit</code></strong></span> action, which requires pulling the relevant user out of the database. Note from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a> that the proper URL for a user’s edit page is /users/1/edit (assuming the user’s id is <code>1</code>). Recall that <span epub:type="pagebreak" id="page_477"></span>the id of the user is available in the <span class="green"><strong><code>params[:id]</code></strong></span> variable, which means that we can find the user with the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex01">Listing 10.1</a>.</p>
<p class="footnote"><a id="ch10fn1" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn1a" class="totri-footnote">1</a>. Image retrieved from <a href="https://www.flickr.com/photos/sashawolff/4598355045/">https://www.flickr.com/photos/sashawolff/4598355045/</a> on 2014-08-25. Copyright © 2010 by Sasha Wolff and used unaltered under the terms of the Creative Commons Attribution 2.0 Generic license.</p>
<figure id="ch10fig01" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_01.jpg" alt="Image" width="714" height="593" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_01.jpg">
<figcaption><p><strong>Figure 10.1:</strong> A mockup of the user edit page.</p></figcaption>
</figure>
<p class="ex-title" id="ch10ex01"><strong>Listing 10.1:</strong> The user <span class="green"><strong><code>edit</code></strong></span> action.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-1a" id="lis10-1">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span> <span class="blue3">UsersController</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>

  <b><span class="green">def</span></b> <span class="blue3">show</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">new</span>
    <span class="violet">@user</span>  <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="green">create</span>
    <span class="violet">@user</span>  <span class="ash">=</span>  <span class="red">User</span><span class="ash">.</span>new(user_params)
    <strong><span class="green">if</span></strong> <span class="violet">@user</span><span class="ash">.</span>save
      log_in <span class="violet">@user</span>
      flash<span class="ash">[</span><span class="violet">:success</span><span class="ash">]</span> = <span class="maroon">"Welcome to the Sample App!"</span>
      redirect_to <span class="violet">@user</span>
    <strong><span class="green">else</span></strong>
      render <span class="maroon">'new'</span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">edit</span>
<span class="marko">    <span class="blue1">@user</span> <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>find(params<span class="ash1">[</span><span class="blue1">:id</span><span class="ash1">]</span>)</span>
  <b><span class="green">end</span></b>

  <strong><span class="green">private</span></strong>

    <b><span class="green">def</span></b> <span class="blue3">user_params</span>
      params<span class="ash">.</span>require(<span class="violet">:user</span>)<span class="ash">.</span>permit(<span class="violet">:name</span>, <span class="violet">:email</span>, <span class="violet">:password</span>,
                                   <span class="violet">:password_confirmation</span>)
    <b><span class="green">end</span></b>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">The corresponding user edit view (which you will have to create by hand) is shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex02">Listing 10.2</a>. Note how closely it resembles the new user view from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex015">Listing 7.15</a>; the large overlap suggests factoring the repeated code into a partial, which is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_1_1">Section 10.1.1</a>).<span epub:type="pagebreak" id="page_478"></span></p>
<p class="ex-title" id="ch10ex02"><strong>Listing 10.2:</strong> The user edit view.</p>
<pre class="pre2">app/views/users/edit.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-2a" id="lis10-2">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%</span> provide(<span class="violet">:title</span>, <span class="maroon">"Edit user"</span>) <span class="red5">%&gt;</span>
&lt;<strong><span class="green">h1</span></strong>&gt;Update your profile&lt;/<strong><span class="green">h1</span></strong>&gt;

&lt;<strong><span class="green">div</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"row"</span>&gt;
  &lt;<strong><span class="green">div</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"col-md-6 col-md-offset-3"</span>&gt;
    <span class="red5">&lt;%=</span> form_with(<span class="violet">model</span>: <span class="violet">@user</span>, <span class="violet">local</span>: <strong><span class="green">true</span></strong>) <b><span class="green">do</span></b> <span class="ash">|</span>f<span class="ash">|</span> <span class="red5">%&gt;</span>
      <span class="red5">&lt;%=</span> render <span class="maroon">'shared/error_messages'</span> <span class="red5">%&gt;</span>

      <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:name</span> <span class="red5">%&gt;</span>
      <span class="red5">&lt;%=</span> f<span class="ash">.</span>text_field <span class="violet">:name</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

      <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:email</span> <span class="red5">%&gt;</span>
      <span class="red5">&lt;%=</span> f<span class="ash">.</span>email_field <span class="violet">:email</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

      <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:password</span> <span class="red5">%&gt;</span>
      <span class="red5">&lt;%=</span> f<span class="ash">.</span>password_field <span class="violet">:password</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

      <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:password_confirmation</span>, <span class="maroon">"Confirmation"</span> <span class="red5">%&gt;</span>
      <span class="red5">&lt;%=</span> f<span class="ash">.</span>password_field <span class="violet">:password_confirmation</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

      <span class="red5">&lt;%=</span> f<span class="ash">.</span>submit <span class="maroon">"Save changes"</span>, <span class="violet">class</span>: <span class="maroon">"btn btn-primary"</span> <span class="red5">%&gt;</span>
    <span class="red5">&lt;%</span> <b><span class="green">end</span></b> <span class="red5">%&gt;</span>

    &lt;<strong><span class="green">div</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"gravatar_edit"</span>&gt;
      <span class="red5">&lt;%=</span> gravatar_for <span class="violet">@user</span> <span class="red5">%&gt;</span>
      &lt;<strong><span class="green">a</span></strong> <span class="ash3">href</span><span class="ash">=</span><span class="maroon">"https://gravatar.com/emails"</span> <span class="ash3">target</span><span class="ash">=</span><span class="maroon">"_blank"</span>&gt;change&lt;/<strong><span class="green">a</span></strong>&gt;
    &lt;/<strong><span class="green">div</span></strong>&gt;
  &lt;/<strong><span class="green">div</span></strong>&gt;
&lt;/<strong><span class="green">div</span></strong>&gt;</pre>
</div>
<p class="noindent">Here we have reused the shared <span class="green"><strong><code>error_messages</code></strong></span> partial introduced in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_3">Section 7.3.3</a>. By the way, the use of <span class="green"><strong><code>target="_blank"</code></strong></span> in the Gravatar link is a neat trick to get the browser to open the page in a new window or tab, which is sometimes convenient behavior when linking to third-party sites. (There’s a minor security issue associated with <span class="green"><strong><code>target="_blank"</code></strong></span>; dealing with this detail is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_1_1">Section 10.1.1</a>).)</p>
<p class="indent">With the <span class="green"><strong><code>@user</code></strong></span> instance variable from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex01">Listing 10.1</a>, the edit page should render properly, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig02">Figure 10.2</a>. The “Name” and “Email” fields in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig02">Figure 10.2</a> also show how Rails automatically prefills the Name and Email fields using the attributes of the existing <span class="green"><strong><code>@user</code></strong></span> variable.<span epub:type="pagebreak" id="page_479"></span></p>
<figure id="ch10fig02" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_02.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_02.jpg">
<figcaption><p><strong>Figure 10.2:</strong> The initial user edit page with pre-filled name and email.</p></figcaption>
</figure>
<p class="indent">Looking at the HTML source for <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig02">Figure 10.2</a>, we see a form tag as expected, as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex03">Listing 10.3</a> (slight details may differ).</p>
<p class="ex-title" id="ch10ex03"><strong>Listing 10.3:</strong> HTML for the edit form defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex02">Listing 10.2</a> and shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig02">Figure 10.2</a>.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-3a" id="lis10-3">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<strong><span class="green">form</span></strong> <span class="ash3">accept-charset</span><span class="ash">=</span><span class="maroon">"UTF-8"</span> <span class="ash3">action</span><span class="ash">=</span><span class="maroon">"/users/1"</span> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"edit_user"</span>
      <span class="ash3">id</span><span class="ash">=</span><span class="maroon">"edit_user_1"</span> <span class="ash3">method</span><span class="ash">=</span><span class="maroon">"post"</span>&gt;
  &lt;<strong><span class="green">input</span></strong> <span class="ash3">name</span><span class="ash">=</span><span class="maroon">"_method"</span> <span class="ash3">type</span><span class="ash">=</span><span class="maroon">"hidden"</span> <span class="ash3">value</span><span class="ash">=</span><span class="maroon">"patch"</span> /&gt;
  .
  .
  .
&lt;/<strong><span class="green">form</span></strong>&gt;</pre>
</div>
<p class="noindent">Note here the hidden input field:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg479a" id="pg479">Click here to view code image</a></p>
<pre class="pre1">&lt;<strong><span class="green">input</span></strong> <span class="ash3">name</span><span class="ash">=</span><span class="maroon">"_method"</span> <span class="ash3">type</span><span class="ash">=</span><span class="maroon">"hidden"</span> <span class="ash3">value</span><span class="ash">=</span><span class="maroon">"patch"</span> /&gt;</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_480"></span>Since web browsers can’t natively send <code>PATCH</code> requests (as required by the REST conventions from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>), Rails fakes it with a <code>POST</code> request and a hidden <span class="green"><strong><code>input</code></strong></span> field.<sup><a id="ch10fn2a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn2" class="totri-footnote">2</a></sup></p>
<p class="footnote"><a id="ch10fn2" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn2a" class="totri-footnote">2</a>. Don’t worry about how this works; the details are of interest to developers of the Rails framework itself, and by design are not important for Rails application developers.</p>
<p class="indent">There’s another subtlety to address here: The code <span class="green"><strong><code>form_with(@user)</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex02">Listing 10.2</a> is <em>exactly</em> the same as the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex015">Listing 7.15</a>—so how does Rails know to use a <code>POST</code> request for new users and a <code>PATCH</code> for editing users? The answer is that it is possible to tell whether a user is new or already exists in the database via Active Record’s <span class="green"><strong><code>new_record?</code></strong></span> boolean method:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg480-1a" id="pg480-1">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console</span>
<strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>new<span class="ash">.</span>new_record?
<span class="green">=&gt; true</span>
<strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>first<span class="ash">.</span>new_record?
<span class="green">=&gt; false</span></pre>
<p class="noindent">When constructing a form using <span class="green"><strong><code>form_with(@user)</code></strong></span>, Rails uses <code>POST</code> if <span class="green"><strong><code>@user.new_record?</code></strong></span> is <span class="green"><strong><code>true</code></strong></span> and <code>PATCH</code> if it is <span class="green"><strong><code>false</code></strong></span>.</p>
<p class="indent">As a final touch, we’ll fill in the URL of the settings link in the site navigation. This is easy using the named route <span class="green"><strong><code>edit_user_path</code></strong></span> from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>, together with the handy <span class="green"><strong><code>current_user</code></strong></span> helper method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex09">Listing 9.9</a>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg480-2a" id="pg480-2">Click here to view code image</a></p>
<pre class="pre1"><span class="red5">&lt;%=</span> link_to <span class="maroon">"Settings"</span>, edit_user_path(current_user) <span class="red5">%&gt;</span></pre>
<p class="noindent">The full application code appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex04">Listing 10.4</a>.</p>
<p class="ex-title" id="ch10ex04"><strong>Listing 10.4:</strong> Adding a URL to the “Settings” link in the site layout.</p>
<pre class="pre2">app/views/layouts/_header.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-4a" id="lis10-4">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<strong><span class="green">header</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="green">"navbar navbar-fixed-top navbar-inverse"</span>&gt;
  &lt;<strong><span class="green">div</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"container"</span>&gt;
    <span class="red5">&lt;%=</span> link_to <span class="maroon">"sample app"</span>, root_path, <span class="green1">id</span>: <span class="maroon">"logo"</span> <span class="red5">%&gt;</span>
    &lt;<strong><span class="green">nav</span></strong>&gt;
      &lt;<strong><span class="green">ul</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="green">"nav navbar-nav navbar-right"</span>&gt;
        &lt;<strong><span class="green">li</span></strong>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Home"</span>, root_path <span class="green">%&gt;</span>&lt;/<strong><span class="green">li</span></strong>&gt;
        &lt;<strong><span class="green">li</span></strong>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Help"</span>, help_path <span class="red5">%&gt;</span>&lt;/<strong><span class="green">li</span></strong>&gt;
        <span class="red5">&lt;%</span> <strong><span class="green">if</span></strong> logged_in? <span class="red5">%&gt;</span>
          &lt;<strong><span class="green">li</span></strong>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Users"</span>, <span class="maroon">'#'</span> <span class="red5">%&gt;</span>&lt;/<strong><span class="green">li</span></strong>&gt;
          &lt;<strong><span class="green">li</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"dropdown"</span>&gt;
<span epub:type="pagebreak" id="page_481"></span>      &lt;<strong><span class="green">a</span></strong> <span class="ash3">href</span><span class="ash">=</span><span class="maroon">"#"</span> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"dropdown-toggle"</span> <span class="ash3">data-toggle</span><span class="ash">=</span><span class="maroon">"dropdown"</span>&gt;
        Account &lt;<strong><span class="green">b</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"caret"</span>&gt;&lt;/<strong><span class="green">b</span></strong>&gt;
      &lt;/<strong><span class="green">a</span></strong>&gt;
      &lt;<strong><span class="green">ul</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"dropdown-menu"</span>&gt;
        &lt;<strong><span class="green">li</span></strong>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Profile"</span>, current_user <span class="red5">%&gt;</span>&lt;/<strong><span class="green">li</span></strong>&gt;
<span class="marko">        <span class="green3">&lt;</span><strong><span class="green3">li</span></strong><span class="green3">&gt;</span><span class="maroon1">&lt;%=</span> link_to <span class="red2">"Settings"</span>, edit_user_path(current_user) <span class="maroon1">%&gt;</span><span class="green3">&lt;/</span><strong><span class="green3">li</span></strong><span class="green3">&gt;</span></span>
        &lt;<strong><span class="green">li</span></strong> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"divider"</span>&gt;&lt;/<strong><span class="green">li</span></strong>&gt;
        &lt;<strong><span class="green">li</span></strong>&gt;
          <span class="red5">&lt;%=</span> link_to <span class="maroon">"Log out"</span>, logout_path, <span class="green1">method</span>: <span class="violet">:delete</span> <span class="red5">%&gt;</span>
        &lt;/<strong><span class="green">li</span></strong>&gt;
      &lt;/<strong><span class="green">ul</span></strong>&gt;
    &lt;/<strong><span class="green">li</span></strong>&gt;
   <span class="red5">&lt;%</span> <strong><span class="green">else</span></strong> <span class="red5">%&gt;</span>
      &lt;<strong><span class="green">li</span></strong>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Log in"</span>, login_path <span class="red5">%&gt;</span>&lt;/<strong><span class="green">li</span></strong>&gt;
   <span class="red5">&lt;%</span> <b><span class="green">end</span></b> <span class="green">%&gt;</span>
   &lt;/<strong><span class="green">ul</span></strong>&gt;
  &lt;/<strong><span class="green">nav</span></strong>&gt;
 &lt;/<strong><span class="green">div</span></strong>&gt;
&lt;/<strong><span class="green">header</span></strong>&gt;</pre>
</div>
<section>
<h5 class="h5" id="lev106">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">As noted earlier, there’s a minor security issue associated with using <span class="green"><strong><code>target="_blank"</code></strong></span> to open URLs—namely, the target site gains control of the “<span class="green"><strong><code>window</code></strong></span> object” associated with the HTML document. As a result, the target site could potentially introduce malicious content, such as a phishing page. This is extremely unlikely to happen when linking to a reputable site like Gravatar, but it turns out that we can eliminate the risk entirely by setting the <span class="green"><strong><code>rel</code></strong></span> attribute (“relationship”) to <span class="green"><strong><code>"noopener"</code></strong></span> in the origin link. Add this attribute to the Gravatar edit link in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex02">Listing 10.2</a>.</p></li>
<li><p class="num">Remove the duplicated form code by refactoring the <span class="green"><strong><code>new.html.erb</code></strong></span> and <span class="green"><strong><code>edit.html.erb</code></strong></span> views to use the partial in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex05">Listing 10.5</a>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex06">Listing 10.6</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex07">Listing 10.7</a>. Note the use of the <span class="green"><strong><code>provide</code></strong></span> method, which we used in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#sec3_4_3">Section 3.4.3</a> to eliminate duplication in the layout.<sup><a id="ch10fn3a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn3" class="totri-footnote">3</a></sup></p></li>
</ol>
<p class="footnote"><a id="ch10fn3" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn3a" class="totri-footnote">3</a>. Thanks to Jose Carlos Montero Gómez for a suggestion that further reduced duplication in the <span class="green"><strong><code>new</code></strong></span> and <span class="green"><strong><code>edit</code></strong></span> partials.<span epub:type="pagebreak" id="page_482"></span></p>
<p class="ex-title" id="ch10ex05"><strong>Listing 10.5:</strong> A partial for the <span class="green"><strong><code>new</code></strong></span> and <span class="green"><strong><code>edit</code></strong></span> form.</p>
<pre class="pre2">app/views/users/_form.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-5a" id="lis10-5">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%=</span> form_with(<span class="violet">model</span>: <span class="violet">@user</span>, <span class="violet">local</span>: <strong><span class="green">true</span></strong>) <b><span class="green">do</span></b> <span class="ash">|</span>f<span class="ash">|</span> <span class="red5">%&gt;</span>
  <span class="red5">&lt;%=</span> render <span class="maroon">'shared/error_messages'</span>, <span class="violet">object</span>: <span class="violet">@user</span> <span class="red5">%&gt;</span>

  <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:name</span> <span class="red5">%&gt;</span>
  <span class="red5">&lt;%=</span> f<span class="ash">.</span>text_field <span class="violet">:name</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

  <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:email</span> <span class="red5">%&gt;</span>
  <span class="red5">&lt;%=</span> f<span class="ash">.</span>email_field <span class="violet">:email</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

  <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:password</span> <span class="red5">%&gt;</span>
  <span class="red5">&lt;%=</span> f<span class="ash">.</span>password_field <span class="violet">:password</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

  <span class="red5">&lt;%=</span> f<span class="ash">.</span>label <span class="violet">:password_confirmation</span> <span class="red5">%&gt;</span>
  <span class="red5">&lt;%=</span> f<span class="ash">.</span>password_field <span class="violet">:password_confirmation</span>, <span class="violet">class</span>: <span class="maroon">'form-control'</span> <span class="red5">%&gt;</span>

  <span class="red5">&lt;%=</span> f<span class="ash">.</span>submit <b><span class="green">yield</span></b>(<span class="violet">:button_text</span>), <span class="violet">class</span>: <span class="maroon">"btn btn-primary"</span> <span class="red5">%&gt;</span>
<span class="red5">&lt;%</span> <b><span class="green">end</span></b> <span class="red5">%&gt;</span>
</pre>
</div>

<p class="ex-title" id="ch10ex06"><strong>Listing 10.6:</strong> The signup view with partial.</p>
<pre class="pre2">app/views/users/new.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-6a" id="lis10-6">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%</span> provide(<span class="violet">:title</span>, <span class="maroon">'Sign up'</span>) <span class="red5">%&gt;</span>
<span class="red5">&lt;%</span> provide(<span class="violet">:button_text</span>, <span class="maroon">'Create my account'</span>) <span class="red5">%&gt;</span>
&lt;<b><span class="green">h1</span></b>&gt;Sign up&lt;/<b><span class="green">h1</span></b>&gt;
&lt;<b><span class="green">div</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"row"</span>&gt;
  &lt;<b><span class="green">div</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"col-md-6 col-md-offset-3"</span>&gt;
    <span class="red5">&lt;%=</span> render <span class="maroon">'form'</span> <span class="red5">%&gt;</span>
  &lt;/<b><span class="green">div</span></b>&gt;
&lt;/<b><span class="green">div</span></b>&gt;</pre>
</div>
<p class="ex-title" id="ch10ex07"><strong>Listing 10.7:</strong> The edit view with partial.</p>
<pre class="pre2">app/views/users/edit.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-7a" id="lis10-7">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%</span> provide(<span class="violet">:title</span>, <span class="maroon">'Edit user'</span>) <span class="red5">%&gt;</span>
<span class="red5">&lt;%</span> provide(<span class="violet">:button_text</span>, <span class="maroon">'Save changes'</span>) <span class="red5">%&gt;</span>
&lt;<b><span class="green">h1</span></b>&gt;Update your profile&lt;/<b><span class="green">h1</span></b>&gt;
&lt;<b><span class="green">div</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"row"</span>&gt;
  &lt;<b><span class="green">div</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"col-md-6 col-md-offset-3"</span>&gt;
<span epub:type="pagebreak" id="page_483"></span>  <span class="red5">&lt;%=</span> render <span class="maroon">'form'</span> <span class="red5">%&gt;</span>
  &lt;<b><span class="green">div</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"gravatar_edit"</span>&gt;
    <span class="red5">&lt;%=</span> gravatar_for <span class="violet">@user</span> <span class="red5">%&gt;</span>
    &lt;<b><span class="green">a</span></b> <span class="ash3">href</span><span class="ash">=</span><span class="maroon">"https://gravatar.com/emails"</span> <span class="ash3">target</span><span class="ash">=</span><span class="maroon">"_blank"</span>&gt;Change&lt;/<b><span class="green">a</span></b>&gt;
  &lt;/<b><span class="green">div</span></b>&gt;
 &lt;/<b><span class="green">div</span></b>&gt;
&lt;/<b><span class="green">div</span></b>&gt;</pre>
</div>
</section>
</section>
<section>
<h4 class="h4" id="sec10_1_2">10.1.2 Unsuccessful Edits</h4>
<p class="noindent">In this section we’ll handle unsuccessful edits, following ideas similar to what we applied to unsuccessful signups (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3">Section 7.3</a>). We start by creating an <span class="green"><strong><code>update</code></strong></span> action, which uses <span class="green"><strong><code>update</code></strong></span> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_5">Section 6.1.5</a>) to update the user based on the submitted <span class="green"><strong><code>params</code></strong></span> hash, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex08">Listing 10.8</a>. With invalid information, the update attempt returns <span class="green"><strong><code>false</code></strong></span>, so the <span class="green"><strong><code>else</code></strong></span> branch renders the edit page. We’ve seen this pattern before: The structure closely parallels the first version of the <span class="green"><strong><code>create</code></strong></span> action (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex018">Listing 7.18</a>).</p>
<p class="ex-title" id="ch10ex08"><strong>Listing 10.8:</strong> The initial user <span class="green"><strong><code>update</code></strong></span> action.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-8a" id="lis10-8">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>

  <b><span class="green">def</span></b> <span class="blue3">show</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">new</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">create</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(user_params)
<span class="marko">    <b><span class="green3">if</span></b> <span class="blue1">@user</span><span class="ash1">.</span>save</span>
      log_in <span class="violet">@user</span>
      flash<span class="ash">[</span><span class="violet">:success</span><span class="ash">] =</span> <span class="maroon">"Welcome to the Sample App!"</span>
      redirect_to <span class="violet">@user</span>
    <b><span class="green">else</span></b>
<span class="marko">      render <span class="red2">'new'</span></span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">edit</span>
<span epub:type="pagebreak" id="page_484"></span>    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">update</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
<span class="marko">    <b><span class="green3">if</span></b> <span class="blue1">@user</span><span class="ash1">.</span>update(user_params)</span>
      <span class="blue"># Handle a successful update.</span>
    <b><span class="green">else</span></b>
<span class="marko">      render <span class="red2">'edit'</span></span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>

  <b><span class="green">private</span></b>

    <b><span class="green">def</span></b> <span class="blue3">user_params</span>
      params<span class="ash">.</span>require(<span class="violet">:user</span>)<span class="ash">.</span>permit(<span class="violet">:name</span>, <span class="violet">:email</span>, <span class="violet">:password</span>,
                                   <span class="violet">:password_confirmation</span>)
    <b><span class="green">end</span></b>
<b><span class="green">end</span></b>
</pre>
</div>
<p class="noindent">Note the use of <span class="green"><strong><code>user_params</code></strong></span> in the call to <span class="green"><strong><code>update</code></strong></span>, which uses strong parameters to prevent mass assignment vulnerability (as described in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_2">Section 7.3.2</a>).</p>
<p class="indent">Because of the existing User model validations and the error-messages partial in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex02">Listing 10.2</a>, submission of invalid information results in helpful error messages (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig03">Figure 10.3</a>).</p>
<figure id="ch10fig03" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_03.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_03.jpg">
<figcaption><p><strong>Figure 10.3:</strong> Error messages from submitting the update form.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev107">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Confirm by submitting various invalid combinations of username, email, and password that the edit form won’t accept invalid submissions.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_1_3">10.1.3 Testing Unsuccessful Edits</h4>
<p class="noindent">We left <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_1_2">Section 10.1.2</a> with a working edit form. Following the testing guidelines from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#box3_3">Box 3.3</a>, we’ll now write an integration test to catch any regressions. Our first step is to generate an integration test as usual:<span epub:type="pagebreak" id="page_485"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg485a" id="pg485">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> rails generate integration_test users_edit
      <span class="green">invoke test_unit</span>
      <span class="green">create test/integration/users_edit_test.rb</span></pre>
<p class="noindent">Then we’ll write a simple test of an unsuccessful edit, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex09">Listing 10.9</a>. The test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex09">Listing 10.9</a> checks for the correct behavior by verifying that the edit template is rendered after getting the edit page and re-rendered upon submission of invalid information. Note the use of the <span class="green"><strong><code>patch</code></strong></span> method to issue a <code>PATCH</code> request, which follows the same pattern as <span class="green"><strong><code>get</code></strong></span>, <span class="green"><strong><code>post</code></strong></span>, and <span class="green"><strong><code>delete</code></strong></span>.</p>
<p class="ex-title" id="ch10ex09"><strong>Listing 10.9:</strong> A test for an unsuccessful edit. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/users_edit_test.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-9a" id="lis10-9">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersEditTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>
<span epub:type="pagebreak" id="page_486"></span>  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> users(<span class="violet">:michael</span>)
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"unsuccessful edit"</span> <b><span class="green">do</span></b>
    get edit_user_path(<span class="violet">@user</span>)
    assert_template <span class="maroon">'users/edit'</span>
    patch user_path(<span class="violet">@user</span>), <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="maroon">""</span>,
                                              <span class="violet">email</span>:                 <span class="maroon">"foo@invalid"</span>,
                                              <span class="violet">password</span>:              <span class="maroon">"foo"</span>,
                                              <span class="violet">password_confirmation</span>: <span class="maroon">"bar"</span> } }
    assert_template <span class="maroon">'users/edit'</span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">At this point, the test suite should still be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch10ex010"><strong>Listing 10.10:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev108">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Add a line in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex09">Listing 10.9</a> to test for the correct <em>number</em> of error messages. <em>Hint</em>: Use an <span class="green"><strong><code>assert_select</code></strong></span> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05tab02">Table 5.2</a>) that tests for a <span class="green"><strong><code>div</code></strong></span> with class <span class="green"><strong><code>alert</code></strong></span> containing the text “The form contains 4 errors.”</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_1_4">10.1.4 Successful Edits (with TDD)</h4>
<p class="noindent">Now it’s time to get the edit form to work. Editing the profile images is already functional since we’ve outsourced image upload to the Gravatar website: We can edit a Gravatar by clicking on the “change” link in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig02">Figure 10.2</a>, which opens the Gravatar site in a new tab (due to <span class="green"><strong><code>target="_blank"</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex02">Listing 10.2</a>), as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig04">Figure 10.4</a>. Let’s get the rest of the user edit functionality working as well.<span epub:type="pagebreak" id="page_487"></span></p>
<figure id="ch10fig04" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_04.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_04.jpg">
<figcaption><p><strong>Figure 10.4:</strong> The Gravatar image-editing interface.</p></figcaption>
</figure>
<p class="indent">As you become more comfortable with testing, you might find that it’s useful to write integration tests before you write the application code, instead of after. Such tests are sometimes known as <em>acceptance tests</em>, since they determine when a particular feature should be accepted as complete. To see how this works, we’ll complete the user edit feature using test-driven development.</p>
<p class="indent">We’ll test for the correct behavior of updating users by writing a test similar to the one shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex09">Listing 10.9</a>, except this time we’ll submit valid information. Then we’ll check for a non-empty flash message and a successful redirect to the profile page, while also verifying that the user’s information correctly changed in the database. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex011">Listing 10.11</a>. Note that the password and confirmation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex011">Listing 10.11</a> are blank, which is convenient for users who don’t want to update their passwords every time they update their names or email addresses. Note also the use of <span class="green"><strong><code>@user.reload</code></strong></span> (first seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_5">Section 6.1.5</a>) to reload the user’s values from the database and confirm that they were successfully updated. (This is the kind of detail you could easily forget <span epub:type="pagebreak" id="page_488"></span>initially, which is why acceptance testing—and TDD generally—require a certain level of experience to be effective.)</p>
<p class="ex-title" id="ch10ex011"><strong>Listing 10.11:</strong> A test of a successful edit. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">test/integration/users_edit_test.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-11a" id="lis10-11">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersEditTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> users(<span class="violet">:michael</span>)
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"successful edit"</span> <b><span class="green">do</span></b>
    get edit_user_path(<span class="violet">@user</span>)
    assert_template <span class="maroon">'users/edit'</span>
    <span class="green1">name</span> <span class="ash">=</span> <span class="maroon">"Foo Bar"</span>
    email <span class="ash">=</span> <span class="maroon">"foo@bar.com"</span>
    patch user_path(<span class="violet">@user</span>), <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="green1">name</span>,
                                              <span class="violet">email</span>: email,
                                              <span class="violet">password</span>:              <span class="maroon">""</span>,
                                              <span class="violet">password_confirmation</span>: <span class="maroon">""</span> } }
    assert_not flash<span class="ash">.</span>empty?
    assert_redirected_to <span class="violet">@user</span>
    <span class="violet">@user</span><span class="ash">.</span>reload
    assert_equal <span class="green1">name</span>, <span class="violet">@user</span><span class="ash">.</span>name
    assert_equal email, <span class="violet">@user</span><span class="ash">.</span>email
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">The <span class="green"><strong><code>update</code></strong></span> action needed to get the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex011">Listing 10.11</a> to pass is similar to the final form of the <span class="green"><strong><code>create</code></strong></span> action (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex032">Listing 8.32</a>), as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex012">Listing 10.12</a>.</p>
<p class="ex-title" id="ch10ex012"><strong>Listing 10.12:</strong> The user <span class="green"><strong><code>update</code></strong></span> action. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-12a" id="lis10-12">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">update</span>
<span epub:type="pagebreak" id="page_489"></span>    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
    <b><span class="green">if</span></b> <span class="violet">@user</span><span class="ash">.</span>update(user_params)
<span class="marko">      flash<span class="ash1">[</span><span class="blue1">:success</span><span class="ash1">] =</span> <span class="red2">"Profile updated"</span></span>
<span class="marko">      redirect_to <span class="blue1">@user</span></span>
    <b><span class="green">else</span></b>
      render <span class="maroon">'edit'</span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">As indicated in the <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex012">Listing 10.12</a> caption, the test suite is still <span class="red5"><small>RED</small></span> because the password length validation (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex043">Listing 6.43</a>) fails due to the empty password and confirmation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex011">Listing 10.11</a>. To get the tests to <span class="green5"><small>GREEN</small></span>, we need to make an exception to the password validation if the password is empty. We can do this by passing the <span class="green"><strong><code>allow_nil: true</code></strong></span> option to <span class="green"><strong><code>validates</code></strong></span>, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex013">Listing 10.13</a>.</p>
<p class="ex-title" id="ch10ex013"><strong>Listing 10.13:</strong> Allowing empty passwords on update. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/models/user.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-13a" id="lis10-13">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">User</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  <b><span class="green">attr_accessor</span></b> <span class="violet">:remember_token</span>
  before_save { <span class="green">self</span><span class="ash">.</span>email <span class="ash">=</span> email<span class="ash">.</span>downcase }
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <b><span class="green">true</span></b>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <b><span class="green">true</span></b>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> },
                    <span class="violet">uniqueness</span>: <b><span class="green">true</span></b>
  has_secure_password
<span class="marko">  validates <span class="blue1">:password</span>, <span class="blue1">presence</span>: <b><span class="green3">true</span></b>, <span class="blue1">length</span>: { <span class="blue1">minimum</span>: <span class="ash1">6</span> }, <span class="blue1">allow_nil</span>: <b><span class="green3">true</span></b></span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">In case you’re worried that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex013">Listing 10.13</a> might allow new users to sign up with empty passwords, recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3_3">Section 6.3.3</a> that <span class="green"><strong><code>has_secure_password</code></strong></span> includes a separate presence validation that specifically catches <span class="green"><strong><code>nil</code></strong></span> passwords. (Because <span class="green"><strong><code>nil</code></strong></span> passwords now bypass the main presence validation but are still caught by <span epub:type="pagebreak" id="page_490"></span><span class="green"><strong><code>has_secure_password</code></strong></span>, this also fixes the duplicate error message mentioned in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_3">Section 7.3.3</a>.)</p>
<p class="indent">With the code in this section, the user edit page should be working (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig05">Figure 10.5</a>). You can double-check this by rerunning the test suite, which should now be <span class="green5"><small>GREEN</small></span>:</p>
<figure id="ch10fig05" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_05.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_05.jpg">
<figcaption><p><strong>Figure 10.5:</strong> The result of a successful edit.</p></figcaption>
</figure>
<p class="ex-title" id="ch10ex014"><strong>Listing 10.14:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test
</pre>
</div>
<section>
<h5 class="h5" id="lev109">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_491"></span></p>
<ol class="num">
<li><p class="num">Double-check that you can now make edits by making a few changes on the development version of the application.</p></li>
<li><p class="num">What happens when you change the email address to one without an associated Gravatar?</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec10_2">10.2 Authorization</h3>
<p class="noindent">In the context of web applications, <em>authentication</em> allows us to identify users of our site, while <em>authorization</em> lets us control what they can do. One nice effect of building the authentication machinery in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a> is that we are now in a position to implement authorization as well.</p>
<p class="indent">Although the edit and update actions from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_1">Section 10.1</a> are functionally complete, they suffer from a ridiculous security flaw: They allow anyone (even non-logged-in users) to access either action and update the information for any user. In this section, we’ll implement a security model that requires users to be logged in and prevents them from updating any information other than their own.</p>
<p class="indent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_1">Section 10.2.1</a>, we’ll handle the case of non-logged-in users who try to access a protected page to which they might normally have access. Because this could easily happen in the normal course of using the application, such users will be forwarded to the login page with a helpful message, as mocked up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig06">Figure 10.6</a>. In contrast, users who try to access a page for which they would never be authorized (such as a logged-in user trying to access a different user’s edit page) will be redirected to the root URL (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_2">Section 10.2.2</a>).</p>
<figure id="ch10fig06" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_06.jpg" alt="Image" width="714" height="593" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_06.jpg">
<figcaption><p><strong>Figure 10.6:</strong> A mockup of the result of visiting a protected page.</p></figcaption>
</figure>
<section>
<h4 class="h4" id="sec10_2_1">10.2.1 Requiring Logged-in Users</h4>
<p class="noindent">To implement the forwarding behavior shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig06">Figure 10.6</a>, we’ll use a <em>before filter</em> in the Users controller. Before filters use the <span class="green"><strong><code>before_action</code></strong></span> command to arrange for a particular method to be called before the given actions.<sup><a id="ch10fn4a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn4" class="totri-footnote">4</a></sup> To require users to be logged in, we define a <span class="green"><strong><code>logged_in_user</code></strong></span> method and invoke it using <span class="green"><strong><code>before_action :logged_in_user</code></strong></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex015">Listing 10.15</a>.</p>
<p class="footnote"><a id="ch10fn4" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn4a" class="totri-footnote">4</a>. The command for before filters used to be called <span class="green"><strong><code>before_filter</code></strong></span>, but the Rails core team decided to rename it to emphasize that the filter takes place before particular controller actions.<span epub:type="pagebreak" id="page_492"></span></p>
<p class="ex-title" id="ch10ex015"><strong>Listing 10.15:</strong> Adding a <span class="green"><strong><code>logged_in_user</code></strong></span> before filter. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-15a" id="lis10-15">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
<span class="marko">  before_action <span class="blue1">:logged_in_user</span>, <span class="blue1">only</span>: <span class="ash1">[</span>:<span class="blue1">edit</span>, <span class="blue1">:update</span><span class="ash1">]</span></span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">private</span></b>

    <b><span class="green">def</span></b> <span class="blue3">user_params</span>
      params<span class="ash">.</span>require(<span class="violet">:user</span>)<span class="ash">.</span>permit(<span class="violet">:name</span>, <span class="violet">:email</span>, <span class="violet">:password</span>,
                                   <span class="violet">:password_confirmation</span>)
    <b><span class="green">end</span></b>
<span epub:type="pagebreak" id="page_493"></span>    <span class="blue"># Before filters</span>

    <span class="blue"># Confirms a logged-in user.</span>
    <b><span class="green">def</span></b> <span class="blue3">logged_in_user</span>
<span class="marko">      <b><span class="green3">unless</span></b> logged_in?</span>
<span class="marko">        flash<span class="ash1">[</span><span class="blue1">:danger</span><span class="ash1">] =</span> <span class="red2">"Please log in."</span></span>
<span class="marko">        redirect_to login_url</span>
<span class="marko">      <b><span class="green3">end</span></b></span>
    <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">By default, before filters apply to <em>every</em> action in a controller, so here we restrict the filter to act only on the <span class="green"><strong><code>:edit</code></strong></span> and <span class="green"><strong><code>:update</code></strong></span> actions by passing the appropriate <span class="green"><strong><code>only:</code></strong></span> options hash.</p>
<p class="indent">We can see the result of the before filter in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex015">Listing 10.15</a> by logging out and attempting to access the user edit page /users/1/edit, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig07">Figure 10.7</a>.</p>
<figure id="ch10fig07" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_07.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_07.jpg">
<figcaption><p><strong>Figure 10.7:</strong> The login form after trying to access a protected page.</p></figcaption>
</figure>
<p class="indent"><span epub:type="pagebreak" id="page_494"></span>As indicated in the caption of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex015">Listing 10.15</a>, our test suite is currently <span class="red5"><small>RED</small></span>:</p>
<p class="ex-title" id="ch10ex016"><strong>Listing 10.16:</strong> <span class="red5"><small>RED</small></span></p>
<div class="example">
<pre>$ rails test
</pre>
</div>
<p class="noindent">The reason is that the edit and update actions now require a logged-in user, but no user is logged in inside the corresponding tests.</p>
<p class="indent">We’ll fix our test suite by logging the user in before hitting the edit or update actions. This is easy using the <span class="green"><strong><code>log_in_as</code></strong></span> helper developed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_3">Section 9.3</a> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex024">Listing 9.24</a>), as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex017">Listing 10.17</a>.</p>
<p class="ex-title" id="ch10ex017"><strong>Listing 10.17:</strong> Logging in a test user. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/users_edit_test.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-17a" id="lis10-17">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersEditTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> users(<span class="violet">:michael</span>)
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"unsuccessful edit"</span> <b><span class="green">do</span></b>
<span class="marko">    log_in_as(<span class="blue1">@user</span>)</span>
    get edit_user_path(<span class="violet">@user</span>)
    <span class="ash">.</span>
    <span class="ash">.</span>
    <span class="ash">.</span>
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"successful edit"</span> <b><span class="green">do</span></b>
<span class="marko">    log_in_as(<span class="blue1">@user</span>)</span>
    get edit_user_path(<span class="violet">@user</span>)
    <span class="ash">.</span>
    <span class="ash">.</span>
    <span class="ash">.</span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">(We could eliminate some duplication by putting the test login in the <span class="green"><strong><code>setup</code></strong></span> method of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex017">Listing 10.17</a>, but in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_3">Section 10.2.3</a> we’ll change one of the tests to visit the edit <span epub:type="pagebreak" id="page_495"></span>page <em>before</em> logging in, which isn’t possible if the login step happens during the test setup.)</p>
<p class="indent">At this point, our test suite should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch10ex018"><strong>Listing 10.18:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test
</pre>
</div>
<p class="noindent">Even though our test suite is now passing, we’re not finished with the before filter, because the suite is still <span class="green5"><small>GREEN</small></span> even if we remove our security model, as you can verify by commenting it out (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex019">Listing 10.19</a>). This is a Bad Thing—of all the regressions we’d like our test suite to catch, a massive security hole is probably 1, so the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex019">Listing 10.19</a> should definitely be <span class="red5"><small>RED</small></span>. Let’s write tests to arrange that.</p>
<p class="ex-title" id="ch10ex019"><strong>Listing 10.19:</strong> Commenting out the before filter to test our security model. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-19a" id="lis10-19">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  <span class="blue"># before_action :logged_in_user, only: [:edit, :update]</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b>
</pre>
</div>
<p class="indent">Because the before filter operates on a per-action basis, we’ll put the corresponding tests in the Users controller test. The plan is to hit the <span class="green"><strong><code>edit</code></strong></span> and <span class="green"><strong><code>update</code></strong></span> actions with the right kinds of requests and verify that the flash is set and that the user is redirected to the login path. From <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>, we see that the proper requests are <code>GET</code> and <code>PATCH</code>, respectively, which means using the <span class="green"><strong><code>get</code></strong></span> and <span class="green"><strong><code>patch</code></strong></span> methods inside the tests. The results (which include adding a <span class="green"><strong><code>setup</code></strong></span> method to define an <span class="green"><strong><code>@user</code></strong></span> variable) appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex020">Listing 10.20</a>.</p>
<p class="ex-title" id="ch10ex020"><strong>Listing 10.20:</strong> Testing that <span class="green"><strong><code>edit</code></strong></span> and <span class="green"><strong><code>update</code></strong></span> are protected. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">test/controllers/users_controller_test.rb
</pre>
<div class="example">
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-20a" id="lis10-20">Click here to view code image</a></p>
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersControllerTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>
<span epub:type="pagebreak" id="page_496"></span>  <b><span class="green">def</span></b> <span class="blue3">setup</span>
<span class="marko">    <span class="blue1">@user</span> <span class="ash1">=</span> users(<span class="blue1">:michael</span>)</span>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<span class="marko">  <span class="green3">test</span> <span class="red2">"should redirect edit when not logged in"</span> <b><span class="green3">do</span></b></span>
    get edit_user_path(<span class="violet">@user</span>)
    assert_not flash<span class="ash">.</span>empty?
    assert_redirected_to login_url
  <b><span class="green">end</span></b>

<span class="marko">  <span class="green3">test</span> <span class="red2">"should redirect update when not logged in"</span> <b><span class="green3">do</span></b></span>
    patch user_path(<span class="violet">@user</span>), <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="violet">@user</span><span class="ash">.</span>name,
                                              <span class="violet">email</span>: <span class="violet">@user</span><span class="ash">.</span>email } }
    assert_not flash<span class="ash">.</span>empty?
    assert_redirected_to login_url
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Note that the second test shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex020">Listing 10.20</a> involves using the <span class="green"><strong><code>patch</code></strong></span> method to send a <code>PATCH</code> request to <span class="green"><strong><code>user_path(@user)</code></strong></span>. According to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>, such a request gets routed to the <span class="green"><strong><code>update</code></strong></span> action in the Users controller, as required.</p>
<p class="indent">The test suite should now be <span class="red5"><small>RED</small></span>, as required. To get it to <span class="green5"><small>GREEN</small></span>, just uncomment the before filter (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex021">Listing 10.21</a>).</p>
<p class="ex-title" id="ch10ex021"><strong>Listing 10.21:</strong> Uncommenting the before filter. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-21a" id="lis10-21">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
<span class="marko">  before_action <span class="blue1">:logged_in_user</span>, <span class="blue1">only</span>: <span class="ash1">[</span><span class="blue1">:edit</span>, <span class="blue1">:update</span><span class="ash1">]</span></span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">With that, our test suite should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch10ex022"><strong>Listing 10.22:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test
</pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_497"></span>Any accidental exposure of the edit methods to unauthorized users will now be caught immediately by our test suite.</p>
<section>
<h5 class="h5" id="lev110">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">By default before filters apply to every action in a controller, which in our cases is an error (requiring, for example, that users log in to hit the signup page, which is absurd). By commenting out the <span class="green"><strong><code>only:</code></strong></span> hash in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex015">Listing 10.15</a>, confirm that the test suite catches this error.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_2_2">10.2.2 Requiring the Right User</h4>
<p class="noindent">Of course, requiring users to log in isn’t quite enough; users should be allowed to edit only their <em>own</em> information. As we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_1">Section 10.2.1</a>, it’s easy to have a test suite that misses an essential security flaw, so we’ll proceed using test-driven development to ensure our code implements the security model correctly. To do this, we’ll add tests to the Users controller test to complement the ones shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex020">Listing 10.20</a>.</p>
<p class="indent">To make sure users can’t edit other users’ information, we need to be able to log in as a second user. This means adding a second user to our users fixture file, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex023">Listing 10.23</a>.</p>
<p class="ex-title" id="ch10ex023"><strong>Listing 10.23:</strong> Adding a second user to the fixture file.</p>
<pre class="pre2">test/fixtures/users.yml
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-23a" id="lis10-23">Click here to view code image</a></p>
<div class="example">
<pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;

<span class="marko">archer:</span>
<span class="marko">  name: Sterling Archer</span>
<span class="marko">  email: duchess@example.gov</span>
<span class="marko">  password_digest: &lt;%= User.digest('password') %&gt;</span>
</pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_498"></span>By using the <span class="green"><strong><code>log_in_as</code></strong></span> method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex024">Listing 9.24</a>, we can test the <span class="green"><strong><code>edit</code></strong></span> and <span class="green"><strong><code>update</code></strong></span> actions as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex024">Listing 10.24</a>. Note that we expect to redirect users to the root path instead of the login path because a user trying to edit a different user would already be logged in.</p>
<p class="ex-title" id="ch10ex024"><strong>Listing 10.24:</strong> Tests for trying to edit as the wrong user. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">test/controllers/users_controller_test.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-24a" id="lis10-24">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersControllerTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span>       <span class="ash">=</span> users(<span class="violet">:michael</span>)
<span class="marko">    <span class="blue1">@other_user</span> <span class="ash1">=</span> users(<span class="blue1">:archer</span>)</span>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<span class="marko">  <span class="green3">test</span> <span class="red2">"should redirect edit when logged in as wrong user"</span> <b><span class="green3">do</span></b></span>
    log_in_as(<span class="violet">@other_user</span>)
    get edit_user_path(<span class="violet">@user</span>)
    assert flash<span class="ash">.</span>empty?
    assert_redirected_to root_url
  <b><span class="green">end</span></b>

<span class="marko">  <span class="green3">test</span> <span class="red2">"should redirect update when logged in as wrong user"</span> <b><span class="green3">do</span></b></span>
    log_in_as(<span class="violet">@other_user</span>)
    patch user_path(<span class="violet">@user</span>), <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="violet">@user</span><span class="ash">.</span>name,
                                              <span class="violet">email</span>: <span class="violet">@user</span><span class="ash">.</span>email } }
    assert flash<span class="ash">.</span>empty?
    assert_redirected_to root_url
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">To redirect users trying to edit another user’s profile, we’ll add a second method called <span class="green"><strong><code>correct_user</code></strong></span>, together with a before filter to call it (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex025">Listing 10.25</a>). Note that the <span class="green"><strong><code>correct_user</code></strong></span> before filter defines the <span class="green"><strong><code>@user</code></strong></span> variable, so <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex025">Listing 10.25</a> also shows that we can eliminate the <span class="green"><strong><code>@user</code></strong></span> assignments in the <span class="green"><strong><code>edit</code></strong></span> and <span class="green"><strong><code>update</code></strong></span> actions.<span epub:type="pagebreak" id="page_499"></span></p>
<p class="ex-title" id="ch10ex025"><strong>Listing 10.25:</strong> A before filter to protect the edit/update pages. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-25a" id="lis10-25">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  before_action <span class="violet">:logged_in_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  before_action <span class="blue1">:correct_user</span>, <span class="blue1">only</span>: <span class="ash1">[</span><span class="blue1">:edit</span>, <span class="blue1">:update</span><span class="ash1">]</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">edit</span>
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">update</span>
    <b><span class="green">if</span></b> <span class="violet">@user</span><span class="ash">.</span>update(user_params)
      flash<span class="ash">[</span><span class="violet">:success</span><span class="ash">] =</span> <span class="maroon">"Profile updated"</span>
      redirect_to <span class="violet">@user</span>
    <b><span class="green">else</span></b>
      render <span class="maroon">'edit'</span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">private</span></b>

    <b><span class="green">def</span></b> <span class="blue3">user_params</span>
      params<span class="ash">.</span>require(<span class="violet">:user</span>)<span class="ash">.</span>permit(<span class="violet">:name</span>, <span class="violet">:email</span>, <span class="violet">:password</span>,
                                   <span class="violet">:password_confirmation</span>)
    <b><span class="green">end</span></b>

    <span class="blue"># Before filters</span>

    <span class="blue"># Confirms a logged-in user.</span>
    <b><span class="green">def</span></b> <span class="blue3">logged_in_user</span>
      <b><span class="green">unless</span></b> logged_in?
        flash<span class="ash">[</span><span class="violet">:danger</span><span class="ash">] =</span> <span class="maroon">"Please log in."</span>
        redirect_to login_url
      <b><span class="green">end</span></b>
    <b><span class="green">end</span></b>

    <span class="blue"># Confirms the correct user.</span>
    <b><span class="green">def</span></b> <span class="blue3">correct_user</span>
<span class="marko">      <span class="blue1">@user</span> <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>find(params<span class="ash1">[</span><span class="blue1">:id</span><span class="ash1">]</span>)</span>
<span class="marko">      redirect_to(root_url) <span class="green3">unless</span> <span class="blue1">@user</span> <span class="ash1">==</span> current_user</span>
    <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_500"></span>At this point, our test suite should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch10ex026"><strong>Listing 10.26:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">As a final refactoring, we’ll adopt a common convention and define a <span class="green"><strong><code>current_user?</code></strong></span> boolean method for use in the <span class="green"><strong><code>correct_user</code></strong></span> before filter. We’ll use this method to replace code like</p>
<pre class="pre1"><b><span class="green">unless</span></b> <span class="violet">@user</span> <span class="ash">==</span> current_user</pre>
<p class="noindent">with the more expressive</p>
<pre class="pre1"><b><span class="green">unless</span></b> current_user?(<span class="violet">@user</span>)</pre>
<p class="noindent">The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex027">Listing 10.27</a>. Note that by writing <span class="green"><strong><code>user &amp;&amp; user == current_user</code></strong></span>, we also catch the edge case where <span class="green"><strong><code>user</code></strong></span> is <span class="green"><strong><code>nil</code></strong></span>.<sup><a id="ch10fn5a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn5" class="totri-footnote">5</a></sup></p>
<p class="footnote"><a id="ch10fn5" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn5a" class="totri-footnote">5</a>. Thanks to reader Andrew Moor for pointing this out. Andrew also noted that we can use the safe navigation operator introduced in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#sec8_2_4">Section 8.2.4</a> to write this as <span class="green"><strong><code>user&amp;. == current_user</code></strong></span>.</p>
<p class="ex-title" id="ch10ex027"><strong>Listing 10.27:</strong> The <span class="green"><strong><code>current_user?</code></strong></span> method.</p>
<pre class="pre2">app/helpers/sessions_helper.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-27a" id="lis10-27">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">module</span> <span class="blue3">SessionsHelper</span></b>

  <span class="blue"># Logs in the given user.</span>
  <b><span class="green">def</span></b> <span class="blue3">log_in</span>(user)
    session<span class="ash">[</span><span class="violet">:user_id</span><span class="ash">] =</span> user<span class="ash">.</span>id
  <b><span class="green">end</span></b>

  <span class="blue"># Remembers a user in a persistent session.</span>
  <b><span class="green">def</span></b> <span class="blue3">remember</span>(user)
    user<span class="ash">.</span>remember
    cookies<span class="ash">.</span>permanent<span class="ash">.</span>encrypted<span class="ash">[</span><span class="violet">:user_id</span><span class="ash">] =</span> user<span class="ash">.</span>id
    cookies<span class="ash">.</span>permanent<span class="ash">[</span><span class="violet">:remember_token</span><span class="ash">] =</span> user<span class="ash">.</span>remember_token
  <b><span class="green">end</span></b>

  <span class="blue"># Returns the user corresponding to the remember token cookie.</span>
<span epub:type="pagebreak" id="page_501"></span>  <b><span class="green">def</span></b> <span class="blue3">current_user</span>
    <b><span class="green">if</span></b> (user_id <span class="ash">=</span> session<span class="ash">[</span><span class="violet">:user_id</span><span class="ash">]</span>)
      <span class="violet">@current_user</span> <span class="ash">||=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="green1">id</span>: user_id)
    <b><span class="green">elsif</span></b> (user_id <span class="ash">=</span> cookies<span class="ash">.</span>encrypted<span class="ash">[</span><span class="violet">:user_id</span><span class="ash">]</span>)
      user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="green1">id</span>: user_id)
      <b><span class="green">if</span></b> user <span class="ash">&amp;&amp;</span> user<span class="ash">.</span>authenticated?(cookies<span class="ash">[</span><span class="violet">:remember_token</span><span class="ash">]</span>)
        log_in user
        <span class="violet">@current_user</span> <span class="ash">=</span> user
      <b><span class="green">end</span></b>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>

<span class="marko">  <span class="lighblue"># Returns true if the given user is the current user.</span></span>
<span class="marko">  <b><span class="green3">def</span></b> <span class="blue3">current_user?</span>(user)</span>
<span class="marko">    user <span class="ash1">&amp;&amp;</span> user <span class="ash1">==</span> current_user</span>
<span class="marko">  <b><span class="green3">end</span></b></span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Replacing the direct comparison with the boolean method yields the code shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex028">Listing 10.28</a>.</p>
<p class="ex-title" id="ch10ex028"><strong>Listing 10.28:</strong> The final <span class="green"><strong><code>correct_user</code></strong></span> before filter. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-28a" id="lis10-28">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  before_action <span class="violet">:logged_in_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  before_action <span class="violet">:correct_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">edit</span>
  <b><span class="green">end</span></b>

  <b><span class="green">def</span></b> <span class="blue3">update</span>
    <b><span class="green">if</span></b> <span class="violet">@user</span><span class="ash">.</span>update(user_params)
      flash<span class="ash">[</span><span class="violet">:success</span><span class="ash">] =</span> <span class="maroon">"Profile updated"</span>
      redirect_to <span class="violet">@user</span>
    <b><span class="green">else</span></b>
      render <span class="maroon">'edit'</span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
<span epub:type="pagebreak" id="page_502"></span>  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">private</span></b>

    <b><span class="green">def</span></b> <span class="blue3">user_params</span>
      params<span class="ash">.</span>require(<span class="violet">:user</span>)<span class="ash">.</span>permit(<span class="violet">:name</span>, <span class="violet">:email</span>, <span class="violet">:password</span>,
                                   <span class="violet">:password_confirmation</span>)
    <b><span class="green">end</span></b>

    <span class="blue"># Before filters</span>

    <span class="blue"># Confirms a logged-in user.</span>
    <b><span class="green">def</span></b> <span class="blue3">logged_in_user</span>
      <b><span class="green">unless</span></b> logged_in?
        flash<span class="ash">[</span><span class="violet">:danger</span><span class="ash">] =</span> <span class="maroon">"Please log in."</span>
        redirect_to login_url
      <b><span class="green">end</span></b>
    <b><span class="green">end</span></b>

    <span class="blue"># Confirms the correct user.</span>
    <b><span class="green">def</span></b> <span class="blue3">correct_user</span>
      <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
<span class="marko">      redirect_to(root_url) <b><span class="green3">unless</span></b> current_user?(<span class="blue1">@user</span>)</span>
    <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<section>
<h5 class="h5" id="lev111">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Why is it important to protect both the <span class="green"><strong><code>edit</code></strong></span> and <span class="green"><strong><code>update</code></strong></span> actions?</p></li>
<li><p class="num">Which action could you more easily test in a browser?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_2_3">10.2.3 Friendly Forwarding</h4>
<p class="noindent">Our site authorization is complete as written, but it has one minor blemish: When users try to access a protected page, they are redirected to their profile pages regardless of where they were trying to go. In other words, if a non-logged-in user tries to visit the edit page, after logging in the user will be redirected to /users/1 instead of /users/1/edit. It would be much friendlier to redirect users to their intended destination instead.<span epub:type="pagebreak" id="page_503"></span></p>
<p class="indent">The application code will turn out to be relatively complicated, but we can write a ridiculously simple test for friendly forwarding just by reversing the order of logging in and visiting the edit page in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex017">Listing 10.17</a>. As seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex029">Listing 10.29</a>, the resulting test tries to visit the edit page, then logs in, and then checks that the user is redirected to the <em>edit</em> page instead of the default profile page. (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex029">Listing 10.29</a> also removes the test for rendering the edit template since that’s no longer the expected behavior.)</p>
<p class="ex-title" id="ch10ex029"><strong>Listing 10.29:</strong> A test for friendly forwarding. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">test/integration/users_edit_test.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-29a" id="lis10-29">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersEditTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> users(<span class="violet">:michael</span>)
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<span class="marko">  <span class="green3">test</span> <span class="red2">"successful edit with friendly forwarding"</span> <b><span class="green3">do</span></b></span>
<span class="marko">    get edit_user_path(<span class="blue1">@user</span>)</span>
<span class="marko">    log_in_as(<span class="blue1">@user</span>)</span>
<span class="marko">    assert_redirected_to edit_user_path(<span class="blue1">@user</span>)</span>
    <span class="green1">name</span> <span class="ash">=</span> <span class="maroon">"Foo Bar"</span>
    email <span class="ash">=</span> <span class="maroon">"foo@bar.com"</span>
    patch user_path(<span class="violet">@user</span>), <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="green1">name</span>,
                                              <span class="violet">email</span>: email,
                                              <span class="violet">password</span>:              <span class="maroon">""</span>,
                                              <span class="violet">password_confirmation</span>: <span class="maroon">""</span> } }
    assert_not flash<span class="ash">.</span>empty?
    assert_redirected_to <span class="violet">@user</span>
    <span class="violet">@user</span><span class="ash">.</span>reload
    assert_equal <span class="green1">name</span>,  <span class="violet">@user</span><span class="ash">.</span>name
    assert_equal email, <span class="violet">@user</span><span class="ash">.</span>email
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">Now that we have a failing test, we’re ready to implement friendly forwarding.<sup><a id="ch10fn6a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn6" class="totri-footnote">6</a></sup> To forward users to their intended destination, we need to store the location of <span epub:type="pagebreak" id="page_504"></span>the requested page somewhere, and then redirect to that location instead of to the default. We accomplish this with a pair of methods, <span class="green"><strong><code>store_location</code></strong></span> and <span class="green"><strong><code>redirect_back_or</code></strong></span>, both defined in the Sessions helper (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex030">Listing 10.30</a>).</p>
<p class="footnote"><a id="ch10fn6" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn6a" class="totri-footnote">6</a>. The code in this section is adapted from the Clearance gem (<a href="http://github.com/thoughtbot/clearance">github.com/thoughtbot/clearance</a>) by thoughtbot (<a href="http://thoughtbot.com/">thoughtbot.com</a>).</p>
<p class="ex-title" id="ch10ex030"><strong>Listing 10.30:</strong> Code to implement friendly forwarding. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/helpers/sessions_helper.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-30a" id="lis10-30">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">module</span> <span class="blue3">SessionsHelper</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="blue">#</span> <span class="blue">Redirects to stored location (or to the default).</span>
  <b><span class="green">def</span></b> <span class="blue3">redirect_back_or</span>(default)
    redirect_to(session<span class="ash">[</span><span class="violet">:forwarding_url</span><span class="ash">] ||</span> default)
    session<span class="ash">.</span>delete(<span class="violet">:forwarding_url</span>)
  <b><span class="green">end</span></b>

  <span class="blue"># Stores the URL trying to be accessed.</span>
  <b><span class="green">def</span></b> <span class="blue3">store_location</span>
    session<span class="ash">[</span><span class="violet">:forwarding_url</span><span class="ash">] =</span> request<span class="ash">.</span>original_url <b><span class="green">if</span></b> request<span class="ash">.</span>get?
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Here the storage mechanism for the forwarding URL is the same <span class="green"><strong><code>session</code></strong></span> facility we used in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#sec8_2_1">Section 8.2.1</a> to log the user in. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex030">Listing 10.30</a> also uses the <span class="green"><strong><code>request</code></strong></span> object (via <span class="green"><strong><code>request.original_url</code></strong></span>) to get the URL of the requested page.</p>
<p class="indent">The <span class="green"><strong><code>store_location</code></strong></span> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex030">Listing 10.30</a> puts the requested URL in the <span class="green"><strong><code>session</code></strong></span> variable under the key <span class="green"><strong><code>:forwarding_url</code></strong></span>, but only for a <span class="green"><strong><code>GET</code></strong></span> request. This prevents storing the forwarding URL if a user, say, submits a form when not logged in (which is an edge case but could happen if, for example, a user deleted the session cookies by hand before submitting the form). In such a case, the resulting redirect would issue a <span class="green"><strong><code>GET</code></strong></span> request to a URL expecting <span class="green"><strong><code>POST</code></strong></span>, <span class="green"><strong><code>PATCH</code></strong></span>, or <span class="green"><strong><code>DELETE</code></strong></span>, thereby causing an error. Including <span class="green"><strong><code>if request.get?</code></strong></span> prevents this from happening.<sup><a id="ch10fn7a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn7" class="totri-footnote">7</a></sup></p>
<p class="footnote"><a id="ch10fn7" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn7a" class="totri-footnote">7</a>. Thanks to reader Yoel Adler for pointing out this subtle issue, and for discovering the solution.</p>
<p class="indent">To make use of <span class="green"><strong><code>store_location</code></strong></span>, we need to add it to the <span class="green"><strong><code>logged_in_user</code></strong></span> before filter, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex031">Listing 10.31</a>.<span epub:type="pagebreak" id="page_505"></span></p>
<p class="ex-title" id="ch10ex031"><strong>Listing 10.31:</strong> Adding <span class="green"><strong><code>store_location</code></strong></span> to the logged-in user before filter. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-31a" id="lis10-31">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  before_action <span class="violet">:logged_in_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  before_action <span class="violet">:correct_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">edit</span>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">private</span></b>

    <b><span class="green">def</span></b> <span class="blue3">user_params</span>
      params<span class="ash">.</span>require(<span class="violet">:user</span>)<span class="ash">.</span>permit(<span class="violet">:name</span>, <span class="violet">:email</span>, <span class="violet">:password</span>,
                                   <span class="violet">:password_confirmation</span>)
    <b><span class="green">end</span></b>

    <span class="blue"># Before filters</span>

    <span class="blue"># Confirms a logged-in user.</span>
    <b><span class="green">def</span></b> <span class="blue3">logged_in_user</span>
      <b><span class="green">unless</span></b> logged_in?
<span class="marko">        store_location</span>
        flash<span class="ash">[</span><span class="violet">:danger</span><span class="ash">] =</span> <span class="maroon">"Please log in."</span>
        redirect_to login_url
      <b><span class="green">end</span></b>
    <b><span class="green">end</span></b>

    <span class="blue"># Confirms the correct user.</span>
    <b><span class="green">def</span></b> <span class="blue3">correct_user</span>
      <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
      redirect_to(root_url) <b><span class="green">unless</span></b> current_user?(<span class="violet">@user</span>)
   <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">To implement the forwarding itself, we use the <span class="green"><strong><code>redirect_back_or</code></strong></span> method to redirect to the requested URL if it exists, or to some default URL otherwise. We add to this default URL the Sessions controller <span class="green"><strong><code>create</code></strong></span> action to redirect after successful login (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex032">Listing 10.32</a>). The <span class="green"><strong><code>redirect_back_or</code></strong></span> method uses the or operator <span class="green"><strong><code>||</code></strong></span> through<span epub:type="pagebreak" id="page_506"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg506a" id="pg506">Click here to view code image</a></p>
<pre class="pre1">session[:forwarding_url] || default</pre>
<p class="noindent">This evaluates to <span class="green"><strong><code>session[:forwarding_url]</code></strong></span> unless it’s <span class="green"><strong><code>nil</code></strong></span>, in which case it evaluates to the given default URL. Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex030">Listing 10.30</a> is careful to remove the forwarding URL (via <span class="green"><strong><code>session.delete(:forwarding_url)</code></strong></span>); otherwise, subsequent login attempts would forward the user to the protected page until the user closed the browser. (Testing for this case is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_3">Section 10.2.3</a>).) Also note that the session deletion occurs even though the line with the redirect appears first; redirects don’t happen until an explicit <span class="green"><strong><code>return</code></strong></span> or the end of the method, so any code appearing after the redirect is still executed.</p>
<p class="ex-title" id="ch10ex032"><strong>Listing 10.32:</strong> The Sessions <span class="green"><strong><code>create</code></strong></span> action with friendly forwarding. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/controllers/sessions_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-32a" id="lis10-32">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">SessionsController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">create</span>
    user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="violet">email</span>: params<span class="ash">[</span><span class="violet">:session</span><span class="ash">][</span><span class="violet">:email</span><span class="ash">].</span>downcase)
    <b><span class="green">if</span></b> user <span class="ash">&amp;&amp;</span> user<span class="ash">.</span>authenticate(params<span class="ash">[</span><span class="violet">:session</span><span class="ash">][</span><span class="violet">:password</span><span class="ash">]</span>)
      log_in user
      params<span class="ash">[</span><span class="violet">:session</span><span class="ash">][</span><span class="violet">:remember_me</span><span class="ash">] ==</span> <span class="maroon">'1'</span> ? remember(user) : forget(user)
<span class="marko">      redirect_back_or user</span>
    <b><span class="green">else</span></b>
      flash<span class="ash">.</span>now<span class="ash">[</span><span class="violet">:danger</span><span class="ash">] =</span> <span class="maroon">'Invalid email/password combination'</span>
      render <span class="maroon">'new'</span>
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">With that, the friendly forwarding integration test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex029">Listing 10.29</a> should pass, and the basic user authentication and page protection implementation is complete. As usual, it’s a good idea to verify that the test suite is <span class="green5"><small>GREEN</small></span> before proceeding:</p>
<p class="ex-title" id="ch10ex033"><strong>Listing 10.33:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev112"><span epub:type="pagebreak" id="page_507"></span>Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Write a test to confirm that friendly forwarding forwards to the given URL only the first time. On subsequent login attempts, the forwarding URL should revert to the default (i.e., the profile page). <em>Hint</em>: Add to the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex029">Listing 10.29</a> by checking for the right value of <span class="green"><strong><code>session[:forwarding_url]</code></strong></span>.</p></li>
<li><p class="num">Put a <span class="green"><strong><code>debugger</code></strong></span> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_1_3">Section 7.1.3</a>) in the Sessions controller’s <span class="green"><strong><code>new</code></strong></span> action, then log out and try to visit /users/1/edit. Confirm in the debugger that the value of <span class="green"><strong><code>session[:forwarding_url]</code></strong></span> is correct. What is the value of <span class="green"><strong><code>request.get?</code></strong></span> for the <span class="green"><strong><code>new</code></strong></span> action? (Sometimes the terminal can freeze up or act strangely when you’re using the debugger; use your technical sophistication (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#box1_2">Box 1.2</a>) to resolve any issues.)</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec10_3">10.3 Showing All Users</h3>
<p class="noindent">In this section, we’ll add the penultimate user action, the <span class="green"><strong><code>index</code></strong></span> action, which is designed to display <em>all</em> the users instead of just one. Along the way, we’ll learn how to seed the database with sample users and how to <em>paginate</em> the user output so that the index page can scale up to display a potentially large number of users. A mockup of the result—users, pagination links, and a “Users” navigation link—appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig08">Figure 10.8</a>.<sup><a id="ch10fn8a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn8" class="totri-footnote">8</a></sup> In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_4">Section 10.4</a>, we’ll add an administrative interface to the users index so that users can also be destroyed.</p>
<p class="footnote"><a id="ch10fn8" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn8a" class="totri-footnote">8</a>. Image retrieved from <a href="https://www.flickr.com/photos/glasgows/338937124/">https://www.flickr.com/photos/glasgows/338937124/</a> on 2014-08-25. Copyright © 2008 by M&amp;R Glasgow and used unaltered under the terms of the Creative Commons Attribution 2.0 Generic license.</p>
<figure id="ch10fig08" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_08.jpg" alt="Image" width="714" height="593" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_08.jpg">
<figcaption><p><strong>Figure 10.8:</strong> A mockup of the users index page.</p></figcaption>
</figure>
<section>
<h4 class="h4" id="sec10_3_1">10.3.1 Users Index</h4>
<p class="noindent">To get started with the users index, we’ll first implement a security model. Although we’ll keep individual user <span class="green"><strong><code>show</code></strong></span> pages visible to all site visitors, the user <span class="green"><strong><code>index</code></strong></span> will be restricted to logged-in users so that there’s a limit to how much unregistered users can see by default.<sup><a id="ch10fn9a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn9" class="totri-footnote">9</a></sup></p>
<p class="footnote"><a id="ch10fn9" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn9a" class="totri-footnote">9</a>. This is the same authorization model used by Twitter.<span epub:type="pagebreak" id="page_508"></span></p>
<p class="indent">To protect the <span class="green"><strong><code>index</code></strong></span> page from unauthorized access, we’ll first add a short test to verify that the <span class="green"><strong><code>index</code></strong></span> action is redirected properly (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex034">Listing 10.34</a>).</p>
<p class="ex-title" id="ch10ex034"><strong>Listing 10.34:</strong> Testing the <span class="green"><strong><code>index</code></strong></span> action redirect. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">test/controllers/users_controller_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-34a" id="lis10-34">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersControllerTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> users(<span class="violet">:michael</span>)
    <span class="violet">@other_user</span> <span class="ash">=</span> users(<span class="violet">:archer</span>)
<span epub:type="pagebreak" id="page_509"></span>  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"should get new"</span> <b><span class="green">do</span></b>
    get signup_path
    assert_response <span class="violet">:success</span>
  <b><span class="green">end</span></b>

<span class="marko">  <span class="green3">test</span> <span class="red2">"should redirect index when not logged in"</span> <b><span class="green3">do</span></b></span>
<span class="marko">    get users_path</span>
<span class="marko">    assert_redirected_to login_url</span>
<span class="marko">  <b><span class="green3">end</span></b></span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Then we just need to add an <span class="green"><strong><code>index</code></strong></span> action and include it in the list of actions protected by the <span class="green"><strong><code>logged_in_user</code></strong></span> before filter (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex035">Listing 10.35</a>).</p>
<p class="ex-title" id="ch10ex035"><strong>Listing 10.35:</strong> Requiring a logged-in user for the <span class="green"><strong><code>index</code></strong></span> action. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-35a" id="lis10-35">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
<span class="marko">  before_action <span class="blue1">:logged_in_user</span>, <span class="blue1">only</span>: <span class="ash1">[</span><span class="blue1">:index</span>, <span class="blue1">:edit</span>, <span class="blue1">:update</span><span class="ash1">]</span></span>
  before_action <span class="violet">:correct_user</span>,   <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>

<span class="marko">  <b><span class="green3">def</span></b> <span class="blue3">index</span></span>
<span class="marko">  <b><span class="green3">end</span></b></span>

  <b><span class="green">def</span></b> <span class="blue3">show</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find(params<span class="ash">[</span><span class="violet">:id</span><span class="ash">]</span>)
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">To display the users themselves, we need to make a variable containing all the site’s users and then render each one by iterating through them in the index view. As you may recall from the corresponding action in the toy app (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02ex09">Listing 2.9</a>), we can use <span class="green"><strong><code>User.all</code></strong></span> to pull all the users out of the database, assigning them to an <span class="green"><strong><code>@users</code></strong></span> instance variable for use in the view, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex036">Listing 10.36</a>. (If displaying <span epub:type="pagebreak" id="page_510"></span>all the users at once seems like a bad idea, you’re right—we’ll remove this blemish in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_3">Section 10.3.3</a>.)</p>
<p class="ex-title" id="ch10ex036"><strong>Listing 10.36:</strong> The user <span class="green"><strong><code>index</code></strong></span> action.</p>
<pre class="pre2">app/controllers/users_controller.rb
</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-36a" id="lis10-36">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  before_action <span class="violet">:logged_in_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:index</span>, <span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">index</span>
<span class="marko">    <span class="blue1">@users</span> <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>all</span>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">To make the actual index page, we’ll make a view (which you’ll have to create) that iterates through the users and wraps each one in an <span class="green"><strong><code>li</code></strong></span> tag. We do this with the <span class="green"><strong><code>each</code></strong></span> method, displaying each user’s Gravatar and name, while wrapping the whole thing in a <span class="green"><strong><code>ul</code></strong></span> tag (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex037">Listing 10.37</a>).</p>
<p class="ex-title" id="ch10ex037"><strong>Listing 10.37:</strong> The users index view.</p>
<pre class="pre2">app/views/users/index.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-37a" id="lis10-37">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%</span> provide(<span class="violet">:title</span>, <span class="maroon">'All users'</span>) <span class="red5">%&gt;</span>
&lt;<b><span class="green">h1</span></b>&gt;All users&lt;/<b><span class="green">h1</span></b>&gt;

&lt;<b><span class="green">ul</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"users"</span>&gt;
  <span class="red5">&lt;%</span> <span class="violet">@users</span><span class="ash">.</span>each <b><span class="green">do</span></b> <span class="ash">|</span>user<span class="ash">|</span> <span class="red5">%&gt;</span>
   &lt;<b><span class="green">li</span></b>&gt;
     <span class="red5">&lt;%=</span> gravatar_for user, <span class="violet">size</span>: <span class="ash">50</span> <span class="red5">%&gt;</span>
     <span class="red5">&lt;%=</span> link_to user<span class="ash">.</span>name, user <span class="red5">%&gt;</span>
   &lt;/<b><span class="green">li</span></b>&gt;
  <span class="red5">&lt;%</span> <b><span class="green">end</span></b> <span class="red5">%&gt;</span>
&lt;/<b><span class="green">ul</span></b>&gt;</pre>
</div>
<p class="noindent">The code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex037">Listing 10.37</a> uses the result from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_1_4">Section 7.1.4</a>, which allows us to pass an option to the Gravatar helper specifying a size other than the default. If you didn’t do <span epub:type="pagebreak" id="page_511"></span>that exercise, update your Users helper file with the contents of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex038">Listing 10.38</a> before proceeding. (You are also welcome to use the Ruby 2.0–style version from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex013">Listing 7.13</a> instead.)</p>
<p class="ex-title" id="ch10ex038"><strong>Listing 10.38:</strong> Adding an options hash in the <span class="green"><strong><code>gravatar_for</code></strong></span> helper.</p>
<pre class="pre2">app/helpers/users_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-38a" id="lis10-38">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">module</span> <span class="blue3">UsersHelper</span></b>

  <span class="blue"># Returns the Gravatar for the given user.</span>
  <b><span class="green">def</span></b> <span class="blue3">gravatar_for</span>(user, options <span class="ash">=</span> { <span class="violet">size</span>: <span class="ash">80</span> })
    size         <span class="ash">=</span> options<span class="ash">[</span><span class="violet">:size</span><span class="ash">]</span>
    gravatar_id  <span class="ash">=</span> <span class="red">Digest</span><span class="ash">::</span><span class="red">MD5</span><span class="ash">::</span>hexdigest(user<span class="ash">.</span>email<span class="ash">.</span>downcase)
    gravatar_url <span class="ash">=</span> <span class="maroon">"https://secure.gravatar.com/avatar/</span><b><span class="pink">#{</span></b>gravatar_id<b><span class="pink">}</span></b><span class="maroon">?s=</span><b><span class="pink">#{</span></b>size<b><span class="pink">}</span></b><span class="maroon">"</span>
    image_tag(gravatar_url, <span class="violet">alt</span>: user<span class="ash">.</span>name, <span class="violet">class</span>: <span class="maroon">"gravatar"</span>)
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">Let’s also add a little CSS (or, rather, SCSS) for style (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex039">Listing 10.39</a>).</p>
<p class="ex-title" id="ch10ex039"><strong>Listing 10.39:</strong> CSS for the users index.</p>
<pre class="pre2">app/assets/stylesheets/custom.scss</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-39a" id="lis10-39">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="blue3">.</span></b>
<b><span class="blue3">.</span></b>
<b><span class="blue3">.</span></b>
<span class="ash">/*</span> <b><span class="green">Users index</span></b> <span class="ash">*/</span>

<b><span class="blue3">.users</span></b> {
  <b><span class="green">list-style</span></b><span class="pink2">:</span> <b><span class="green">none</span></b><span class="ash">;</span>
  <b><span class="green">margin</span></b><span class="pink2">:</span> <b><span class="green">0</span></b><span class="ash">;</span>
  <b><span class="green">li</span></b> {
    <b><span class="green">overflow</span></b><span class="pink2">:</span> <b><span class="green">auto</span></b><span class="ash">;</span>
    <b><span class="green">padding</span></b><span class="pink2">:</span> <b><span class="green">10px 0</span></b><span class="ash">;</span>
    <b><span class="green">border-bottom</span></b><span class="pink2">:</span> <b><span class="green">1px solid</span></b> $<b><span class="green">gray-lighter</span></b><span class="ash">;</span>
  }
}
</pre>
</div>
<p class="indent">Finally, we’ll add the URL to the users link in the site’s navigation header using <span class="green"><strong><code>users_path</code></strong></span>, thereby using the last of the unused named routes in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex040">Listing 10.40</a>.<span epub:type="pagebreak" id="page_512"></span></p>
<p class="ex-title" id="ch10ex040"><strong>Listing 10.40:</strong> Adding the URL to the users link.</p>
<pre class="pre2">app/views/layouts/_header.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-40a" id="lis10-40">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<b><span class="green">header</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"navbar navbar-fixed-top navbar-inverse"</span>&gt;
  &lt;<b><span class="green">div</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"container"</span>&gt;
    <span class="red5">&lt;%=</span> link_to <span class="maroon">"sample app"</span>, root_path, <span class="green1">id</span>: <span class="maroon">"logo"</span> <span class="red5">%&gt;</span>
    &lt;<b><span class="green">nav</span></b>&gt;
      &lt;<b><span class="green">ul</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"nav navbar-nav navbar-right"</span>&gt;
        &lt;<b><span class="green">li</span></b>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Home"</span>, root_path <span class="red5">%&gt;</span>&lt;/<b><span class="green">li</span></b>&gt;
        &lt;<b><span class="green">li</span></b>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Help"</span>, help_path <span class="red5">%&gt;</span>&lt;/<b><span class="green">li</span></b>&gt;
        <span class="red5">&lt;%</span> <b><span class="green">if</span></b> logged_in? <span class="red5">%&gt;</span>
<span class="marko">          <span class="green3">&lt;</span><b><span class="green3">li</span></b><span class="green3">&gt;</span><span class="maroon1">&lt;%=</span> link_to <span class="red2">"Users"</span>, users_path <span class="maroon1">%&gt;</span><span class="green3">&lt;/</span><b><span class="green3">li</span></b><span class="green3">&gt;</span></span>
          &lt;<b><span class="green">li</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"dropdown"</span>&gt;
            &lt;<b><span class="green">a</span></b> <span class="ash3">href</span><span class="ash">=</span><span class="maroon">"#"</span> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"dropdown-toggle"</span> <span class="ash3">data-toggle</span><span class="ash">=</span><span class="maroon">"dropdown"</span>&gt;
              Account &lt;<b><span class="green">b</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"caret"</span>&gt;&lt;/<b><span class="green">b</span></b>&gt;
            &lt;/<b><span class="green">a</span></b>&gt;
            &lt;<b><span class="green">ul</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"dropdown-menu"</span>&gt;
              &lt;<b><span class="green">li</span></b>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Profile"</span>, current_user <span class="red5">%&gt;</span>&lt;/<b><span class="green">li</span></b>&gt;
              &lt;<b><span class="green">li</span></b>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Settings"</span>, edit_user_path(current_user) <span class="red5">%&gt;</span>&lt;/<b><span class="green">li</span></b>&gt;
              &lt;<b><span class="green">li</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"divider"</span>&gt;&lt;/<b><span class="green">li</span></b>&gt;
              &lt;<b><span class="green">li</span></b>&gt;
                <span class="red5">&lt;%=</span> link_to <span class="maroon">"Log out"</span>, logout_path, <span class="green1">method</span>: <span class="violet">:delete</span> <span class="red5">%&gt;</span>
              &lt;/<b><span class="green">li</span></b>&gt;
            &lt;/<b><span class="green">ul</span></b>&gt;
        &lt;/<b><span class="green">li</span></b>&gt;
      <span class="red5">&lt;%</span> <b><span class="green">else</span></b> <span class="red5">%&gt;</span>
        &lt;<b><span class="green">li</span></b>&gt;<span class="red5">&lt;%=</span> link_to <span class="maroon">"Log in"</span>, login_path <span class="red5">%&gt;</span>&lt;/<b><span class="green">li</span></b>&gt;
      <span class="red5">&lt;%</span> <b><span class="green">end</span></b> <span class="red5">%&gt;</span>
    &lt;/<b><span class="green">ul</span></b>&gt;
   &lt;/<b><span class="green">nav</span></b>&gt;
  &lt;/<b><span class="green">div</span></b>&gt;
&lt;/<b><span class="green">header</span></b>&gt;
</pre>
</div>
<p class="indent">With that, the users index is fully functional, with all tests <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch10ex041"><strong>Listing 10.41:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">On the other hand, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig09">Figure 10.9</a>, it is a bit ... lonely. We’ll remedy this sad situation in the next edition.<span epub:type="pagebreak" id="page_513"></span></p>
<figure id="ch10fig09" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_09.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_09.jpg">
<figcaption><p><strong>Figure 10.9:</strong> The users index page with only one user.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev114">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">We’ve now filled in all the links in the site layout. Write an integration test for all the layout links, including the proper behavior for logged-in and non-logged-in users. <em>Hint</em>: Use the <span class="green"><strong><code>log_in_as</code></strong></span> helper and add to the steps shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05ex032">Listing 5.32</a>.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_3_2">10.3.2 Sample Users</h4>
<p class="noindent">In this section, we’ll give our lonely sample user some company. Of course, to create enough users to make a decent users index, we <em>could</em> use our web browser to visit the signup page and make the new users one by one, but a far better solution is to use Ruby to make the users for us.<span epub:type="pagebreak" id="page_514"></span></p>
<p class="indent">First, we’ll add the <code>Faker</code> gem to the <span class="green"><strong><code>Gemfile</code></strong></span>, which will allow us to make sample users with semi-realistic names and email addresses (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex042">Listing 10.42</a>).<sup><a id="ch10fn10a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn10">10</a></sup> (Ordinarily, you’d probably want to restrict the <code>faker</code> gem to a development environment, but in the case of the sample app we’ll be using it on our production site as well (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_5">Section 10.5</a>).)</p>
<p class="footnote"><a id="ch10fn10" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn10a">10</a>. As always, you should use the version numbers listed at <a href="http://gemfiles-6th-ed.railstutorial.org/">gemfiles-6th-ed.railstutorial.org</a> instead of the ones listed here.</p>
<p class="ex-title" id="ch10ex042"><strong>Listing 10.42:</strong> Adding the Faker gem to the <span class="green"><strong><code>Gemfile</code></strong></span>.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-42a" id="lis10-42">Click here to view code image</a></p>
<div class="example">
<pre>source <span class="maroon">'https://rubygems.org'</span>

gem <span class="maroon">'rails'</span>,          <span class="maroon">'6.0.2.1'</span>
gem <span class="maroon">'bcrypt'</span>,         <span class="maroon">'3.1.13'</span>
gem <span class="red2">'faker'</span>,          <span class="red2">'2.1.2'</span>
gem <span class="maroon">'bootstrap-sass'</span>, <span class="maroon">'3.4.1'</span>
<span class="ash">.</span>
<span class="ash">.</span>
<span class="ash">.</span>
</pre>
</div>
<p class="indent">Then install as usual:</p>
<pre class="pre1"><b><span class="blue1">$</span></b> bundle install</pre>
<p class="indent">Next, we’ll add a Ruby program to seed the database with sample users, for which Rails uses the standard file <span class="green"><strong><code>db/seeds.rb</code></strong></span>. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex043">Listing 10.43</a>. (The code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex043">Listing 10.43</a> is a bit advanced, so don’t worry too much about the details.)</p>
<p class="ex-title" id="ch10ex043"><strong>Listing 10.43:</strong> A program for seeding the database with sample users.</p>
<pre class="pre2">db/seeds.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-43a" id="lis10-43">Click here to view code image</a></p>
<div class="example">
<pre><span class="blue"># Create a main sample user.</span>
<span class="red">User</span><span class="ash">.</span>create!(<span class="green1">name</span>: <span class="maroon">"Example User"</span>,
             <span class="violet">email</span>: <span class="maroon">"example@railstutorial.org"</span>,
             <span class="violet">password</span>:              <span class="maroon">"foobar"</span>,
             <span class="violet">password_confirmation</span>: <span class="maroon">"foobar"</span>)

<span class="blue"># Generate a bunch of additional users.</span>
<span class="ash">99.</span>times <b><span class="green">do</span></b> <span class="ash">|</span>n<span class="ash">|</span>
  <span class="green1">name</span> <span class="ash">=</span> <span class="red">Faker</span><span class="ash">::</span><span class="red">Name</span><span class="ash">.</span>name
  email <span class="ash">=</span> <span class="maroon">"example-</span><b><span class="red6">#{</span></b>n<span class="ash">+1</span><b><span class="pink">}</span></b><span class="maroon">@railstutorial.org"</span>
<span epub:type="pagebreak" id="page_515"></span>  password <span class="ash">=</span> <span class="maroon">"password"</span>
  <span class="red">User</span><span class="ash">.</span>create!(<span class="green1">name</span>: <span class="green1">name</span>,
               <span class="violet">email</span>: email,
               <span class="violet">password</span>:              password,
               <span class="violet">password_confirmation</span>: password)
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">The code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex043">Listing 10.43</a> creates an example user with a name and an email address replicating the information for our previous user, and then makes 99 more. The <span class="green"><strong><code>create!</code></strong></span> method is just like the <span class="green"><strong><code>create</code></strong></span> method, except it raises an exception (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_4">Section 6.1.4</a>) for an invalid user rather than returning <span class="green"><strong><code>false</code></strong></span>. This behavior makes debugging easier by avoiding silent errors.</p>
<p class="indent">With the code as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex043">Listing 10.43</a>, we can reset the database and then invoke the Rake task using <span class="green"><strong><code>db:seed</code></strong></span>:<sup><a id="ch10fn11a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn11">11</a></sup></p>
<p class="footnote"><a id="ch10fn11" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn11a">11</a>. In principle, these two tasks can be combined in <span class="green"><strong><code>rails db:reset</code></strong></span>, but as of this writing this command doesn’t work with the latest version of Rails.</p>
<pre class="pre1">$ rails db:migrate:reset
$ rails db:seed</pre>
<p class="noindent">Seeding the database can be slow, and on some systems could take a few minutes. Also, some readers have reported that they are unable to run the reset command if the Rails server is running, so you may have to stop the server first before proceeding (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#box1_2">Box 1.2</a>).</p>
<p class="indent">After running the <span class="green"><strong><code>db:seed</code></strong></span> Rake task, our application should have 100 sample users. As seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig010">Figure 10.10</a>, I’ve taken the liberty of associating the first few sample addresses with Gravatars so that they’re not all the default Gravatar image.</p>
<figure id="ch10fig010" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_10.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_10.jpg">
<figcaption><p><strong>Figure 10.10:</strong> The users index page with 100 sample users.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev115">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Verify that trying to visit the edit page of another user results in a redirect as required by <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_2">Section 10.2.2</a>.<span epub:type="pagebreak" id="page_516"></span></p></li>
</ol>
</section>
</section>
<section>
<h4 class="h4" id="sec10_3_3">10.3.3 Pagination</h4>
<p class="noindent">Our original user doesn’t suffer from loneliness any more, but now we have the opposite problem: Our user has <em>too many</em> companions, and they all appear on the same page. Right now there are a hundred users, which is already a reasonably large number, and on a real site there could be thousands. The solution is to <em>paginate</em> the users, so that (for example) only 30 show up on a page at any one time.</p>
<p class="indent">Several pagination methods are available in Rails; we’ll use one of the simplest and most robust, called will_paginate. To use it, we need to include both the <code>will_paginate</code> gem and <code>bootstrap-will_paginate</code>, which configures <code>will_paginate</code> to use Bootstrap’s pagination styles. The updated <span class="green"><strong><code>Gemfile</code></strong></span> appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex044">Listing 10.44</a>.<sup><a id="ch10fn12a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn12">12</a></sup></p>
<p class="footnote"><a id="ch10fn12" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn12a">12</a>. As always, you should use the version numbers listed at <a href="http://gemfiles-6th-ed.railstutorial.org/">gemfiles-6th-ed.railstutorial.org</a> instead of the ones listed here.<span epub:type="pagebreak" id="page_517"></span></p>
<p class="ex-title" id="ch10ex044"><strong>Listing 10.44:</strong> Including <code>will_paginate</code> in the <span class="green"><strong><code>Gemfile</code></strong></span>.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-44a" id="lis10-44">Click here to view code image</a></p>
<div class="example">
<pre>source <span class="maroon">'https://rubygems.org'</span>

gem <span class="maroon">'rails'</span>,                   <span class="maroon">'6.0.2.1'</span>
gem <span class="maroon">'bcrypt'</span>,                  <span class="maroon">'3.1.13'</span>
gem <span class="maroon">'faker'</span>,                   <span class="maroon">'2.1.2'</span>
<span class="marko">gem <span class="red2">'will_paginate'</span>,           <span class="red2">'3.1.8'</span></span>
<span class="marko">gem <span class="red2">'bootstrap-will_paginate'</span>, <span class="red2">'1.0.0'</span></span>
<span class="ash">.</span>
<span class="ash">.</span>
<span class="ash">.</span></pre>
</div>
<p class="noindent">Then run <span class="green"><strong><code>bundle install</code></strong></span>:</p>
<pre class="pre1"><b><span class="navy">$</span></b> bundle install</pre>
<p class="noindent">You should also restart the webserver to ensure that the new gems are loaded properly.</p>
<p class="indent">To get pagination working, we need to add some code to the index view telling Rails to paginate the users, and we need to replace <span class="green"><strong><code>User.all</code></strong></span> in the <span class="green"><strong><code>index</code></strong></span> action with an object that knows about pagination. We’ll start by adding the special <span class="green"><strong><code>will_paginate</code></strong></span> method in the view (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex045">Listing 10.45</a>); we’ll see in a moment why the code appears both above and below the user list.</p>
<p class="ex-title" id="ch10ex045"><strong>Listing 10.45:</strong> The users index with pagination.</p>
<pre class="pre2">app/views/users/index.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-45a" id="lis10-45">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%</span> provide(<span class="violet">:title</span>, <span class="maroon">'All users'</span>) <span class="red5">%&gt;</span>
&lt;<b><span class="green">h1</span></b>&gt;All users&lt;/<b><span class="green">h1</span></b>&gt;

<span class="maroon1">&lt;%=</span> will_paginate <span class="maroon1">%&gt;</span>

&lt;<b><span class="green">ul</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"users"</span>&gt;
  <span class="red5">&lt;%</span> <span class="violet">@users</span><span class="ash">.</span>each <b><span class="green">do</span></b> <span class="ash">|</span>user<span class="ash">|</span> <span class="red5">%&gt;</span>
   &lt;<b><span class="green">li</span></b>&gt;
     <span class="red5">&lt;%=</span> gravatar_for user, <span class="violet">size</span>: <span class="ash">50</span> <span class="red5">%&gt;</span>
     <span class="red5">&lt;%=</span> link_to user<span class="ash">.</span>name, user <span class="red5">%&gt;</span>
   &lt;/<b><span class="green">li</span></b>&gt;
  <span class="red5">&lt;%</span> <b><span class="green">end</span></b> <span class="red5">%&gt;</span>
&lt;/<b><span class="green">ul</span></b>&gt;

<span class="marko"><span class="maroon1">&lt;%=</span> will_paginate <span class="maroon1">%&gt;</span></span></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_518"></span>The <span class="green"><strong><code>will_paginate</code></strong></span> method is a little magical: Inside a <span class="green"><strong><code>users</code></strong></span> view, it automatically looks for an <span class="green"><strong><code>@users</code></strong></span> object, and then displays pagination links to access other pages. The view in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex045">Listing 10.45</a> doesn’t work yet, though, because currently <span class="green"><strong><code>@users</code></strong></span> contains the results of <span class="green"><strong><code>User.all</code></strong></span> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex036">Listing 10.36</a>), whereas <span class="green"><strong><code>will_paginate</code></strong></span> requires that we paginate the results explicitly using the <span class="green"><strong><code>paginate</code></strong></span> method:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg518a" id="pg518">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console</span>
<b><span class="navy">&gt;&gt;</span></b> <span class="red">User</span><span class="ash">.</span>paginate(<span class="violet">page</span>: <span class="ash">1</span>)
  <span class="green">User Load (1.5ms) SELECT "users".* FROM "users" LIMIT 11 OFFSET 0</span>
   <span class="green">(1.7ms) SELECT COUNT(*) FROM "users"</span>
<span class="green">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1,...</span>
<b><span class="navy">&gt;&gt;</span></b> <span class="red">User</span><span class="ash">.</span>paginate(<span class="violet">page</span>: <span class="ash">1</span>)<span class="ash">.</span>length
  <span class="green">User Load (3.0ms) SELECT "users".* FROM "users" LIMIT ? OFFSET ?</span>
   <span class="green">[["LIMIT", 30], ["OFFSET", 0]]</span>
<span class="green">=&gt; 30</span></pre>
<p class="noindent">Note that <span class="green"><strong><code>paginate</code></strong></span> takes a hash argument with key <span class="green"><strong><code>:page</code></strong></span> and value equal to the page requested. <span class="green"><strong><code>User.paginate</code></strong></span> pulls the users out of the database one chunk at a time (30 by default), based on the <span class="green"><strong><code>:page</code></strong></span> parameter. So, for example, page 1 is users 1–30, page 2 is users 31–60, and so forth. If <span class="green"><strong><code>page</code></strong></span> is <span class="green"><strong><code>nil</code></strong></span>, <span class="green"><strong><code>paginate</code></strong></span> simply returns the first page. (The console result just shown presents 11 results rather than 30 due to a console limit in Active Record itself, but calling the <span class="green"><strong><code>length</code></strong></span> method bypasses this restriction.)</p>
<p class="indent">Using the <span class="green"><strong><code>paginate</code></strong></span> method, we can paginate the users in the sample application by using <span class="green"><strong><code>paginate</code></strong></span> in place of <span class="green"><strong><code>all</code></strong></span> in the <span class="green"><strong><code>index</code></strong></span> action (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex046">Listing 10.46</a>). Here the <span class="green"><strong><code>page</code></strong></span> parameter comes from <span class="green"><strong><code>params[:page]</code></strong></span>, which is generated automatically by <span class="green"><strong><code>will_paginate</code></strong></span>.</p>
<p class="ex-title" id="ch10ex046"><strong>Listing 10.46:</strong> Paginating the users in the <span class="green"><strong><code>index</code></strong></span> action.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-46a" id="lis10-46">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  before_action <span class="violet">:logged_in_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:index</span>, <span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">index</span>
<span class="marko">    <span class="blue1">@users</span> <span class="ash1">=</span> <span class="red2">User</span><span class="ash1">.</span>paginate(<span class="blue1">page</span>: params<span class="ash1">[</span><span class="blue1">:page</span><span class="ash1">]</span>)</span>
<span epub:type="pagebreak" id="page_519"></span>  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">The users index page should now be working, appearing as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig011">Figure 10.11</a>. (On some systems, you may have to restart the Rails server at this point.) Because we included <strong>will_paginate</strong> both above and below the user list, the pagination links appear in both places.</p>
<figure id="ch10fig011" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_11.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_11.jpg">
<figcaption><p><strong>Figure 10.11:</strong> The users index page with pagination.</p></figcaption>
</figure>
<p class="indent">If you now click on either the 2 link or Next link, you’ll get the second page of results, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig012">Figure 10.12</a>.</p>
<figure id="ch10fig012" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_12.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_12.jpg">
<figcaption><p><strong>Figure 10.12:</strong> Page 2 of the users index.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev116">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_520"></span></p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Confirm at the console that setting the page to <span class="green"><strong><code>nil</code></strong></span> pulls out the first page of users.</p></li>
<li><p class="num">What is the Ruby class of the pagination object? How does it compare to the class of <span class="green"><strong><code>User.all</code></strong></span>?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_3_4">10.3.4 Users Index Test</h4>
<p class="noindent">Now that our users index page is working, we’ll write a lightweight test for it, including a minimal test for the pagination from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_3">Section 10.3.3</a>. The idea is to log in, visit the index path, verify the first page of users is present, and then confirm that pagination is present on the page. For these last two steps to work, we need to have enough users in the test database to invoke pagination, that is, more than 30.<span epub:type="pagebreak" id="page_521"></span></p>
<p class="indent">We created a second user in the fixtures in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex023">Listing 10.23</a>, but 30 or so more users is a lot to create by hand. Luckily, as we’ve seen with the user fixture’s <span class="green"><strong><code>password_digest</code></strong></span> attribute, fixture files support embedded Ruby. Thus, we can create 30 additional users as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex047">Listing 10.47</a>. (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex047">Listing 10.47</a> also creates a couple of other named users for future reference.)</p>
<p class="ex-title" id="ch10ex047"><strong>Listing 10.47:</strong> Adding 30 extra users to the fixture.</p>
<pre class="pre2">test/fixtures/users.yml</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-47a" id="lis10-47">Click here to view code image</a></p>
<div class="example">
<pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;

archer:
  name: Sterling Archer
  email: duchess@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

lana:
  name: Lana Kane
  email: hands@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

malory:
  name: Malory Archer
  email: boss@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

&lt;% 30.times do |n| %&gt;
user_&lt;%= n %&gt;:
  name: &lt;%= "User #{n}" %&gt;
  email: &lt;%= "user-#{n}@example.com" %&gt;
  password_digest: &lt;%= User.digest('password') %&gt;
&lt;% end %&gt;
</pre>
</div>
<p class="indent">With the fixtures defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex047">Listing 10.47</a>, we’re ready to write a test of the users index. First we generate the relevant test:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg521a" id="pg521">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> rails generate integration_test users_index
      <span class="green">invoke test_unit</span>
      <span class="green">create test/integration/users_index_test.rb</span></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_522"></span>The test itself involves checking for a <span class="green"><strong><code>div</code></strong></span> with the required <span class="green"><strong><code>pagination</code></strong></span> class and verifying that the first page of users is present. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex048">Listing 10.48</a>.</p>
<p class="ex-title" id="ch10ex048"><strong>Listing 10.48:</strong> A test of the users index, including pagination. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/users_index_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-48a" id="lis10-48">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersIndexTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> users(<span class="violet">:michael</span>)
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"index including pagination"</span> <b><span class="green">do</span></b>
    log_in_as(<span class="violet">@user</span>)
    get users_path
    assert_template <span class="maroon">'users/index'</span>
    assert_select <span class="maroon">'div.pagination'</span>
    <span class="red">User</span><span class="ash">.</span>paginate(<span class="violet">page</span>: <span class="ash">1</span>)<span class="ash">.</span>each <b><span class="green">do</span></b> <span class="ash">|</span>user<span class="ash">|</span>
      assert_select <span class="maroon">'a[href=?]'</span>, user_path(user), <span class="violet">text</span>: user<span class="ash">.</span>name
    <b><span class="green">end</span></b>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b>
</pre>
</div>
<p class="noindent">The result should be a <span class="green5"><small>GREEN</small></span> test suite:</p>
<p class="ex-title" id="ch10ex049"><strong>Listing 10.49:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev117">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">By commenting out the pagination links in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex045">Listing 10.45</a>, confirm that the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex048">Listing 10.48</a> goes <span class="red5"><small>RED</small></span>.<span epub:type="pagebreak" id="page_523"></span></p></li>
<li><p class="num">Confirm that commenting out only <em>one</em> of the calls to <code>will_paginate</code> leaves the tests <span class="green5"><small>GREEN</small></span>. How would you test for the presence of both sets of <code>will_paginate</code> links? <em>Hint</em>: Use a count from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05tab02">Table 5.2</a>.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_3_5">10.3.5 Partial Refactoring</h4>
<p class="noindent">The paginated users index is now complete, but there’s one improvement I can’t resist including: Rails has some incredibly slick tools for making compact views, and in this section we’ll refactor the index page to use them. Because our code is well tested, we can refactor with confidence, assured that we are unlikely to break our site’s functionality.</p>
<p class="indent">The first step in our refactoring is to replace the user <span class="green"><strong><code>li</code></strong></span> from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex045">Listing 10.45</a> with a <span class="green"><strong><code>render</code></strong></span> call (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex050">Listing 10.50</a>).</p>
<p class="ex-title" id="ch10ex050"><strong>Listing 10.50:</strong> The first refactoring attempt in the index view. <span class="red5"><small>RED</small></span></p>
<pre class="pre2">app/views/users/index.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-50a" id="lis10-50">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%</span> provide(<span class="violet">:title</span>, <span class="maroon">'All users'</span>) <span class="red5">%&gt;</span>
&lt;<b><span class="green">h1</span></b>&gt;All users&lt;/<b><span class="green">h1</span></b>&gt;

<span class="red5">&lt;%=</span> will_paginate <span class="red5">%&gt;</span>

&lt;<b><span class="green">ul</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"users"</span>&gt;
  <span class="red5">&lt;%</span> <span class="violet">@users</span><span class="ash">.</span>each <b><span class="green">do</span></b> <span class="ash">|</span>user<span class="ash">|</span> <span class="red5">%&gt;</span>
<span class="marko">    <span class="maroon1">&lt;%=</span> render user <span class="maroon1">%&gt;</span></span>
  <span class="red5">&lt;%</span> <b><span class="green">end</span></b> <span class="red5">%&gt;</span>
&lt;/<b><span class="green">ul</span></b>&gt;

<span class="red5">&lt;%=</span> will_paginate <span class="red5">%&gt;</span></pre>
</div>
<p class="noindent">Here we call <span class="green"><strong><code>render</code></strong></span> not on a string with the name of a partial, but rather on a <span class="green"><strong><code>user</code></strong></span> variable of class <span class="green"><strong><code>User</code></strong></span>.<sup><a id="ch10fn13a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn13">13</a></sup> In this context, Rails automatically looks for a partial called <span class="green"><strong><code>_user.html.erb</code></strong></span>, which we must create (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex051">Listing 10.51</a>).</p>
<p class="footnote"><a id="ch10fn13" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn13a">13</a>. The name <span class="green"><strong><code>user</code></strong></span> is immaterial—we could have written <span class="green"><strong><code>@users.each do |foobar|</code></strong></span> and then used <span class="green"><strong><code>render foobar</code></strong></span>. The key is the <em>class</em> of the object—in this case, <span class="green"><strong><code>User</code></strong></span>.<span epub:type="pagebreak" id="page_524"></span></p>
<p class="ex-title" id="ch10ex051"><strong>Listing 10.51:</strong> A partial to render a single user. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/views/users/_user.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-51a" id="lis10-51">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<b><span class="green">li</span></b>&gt;
  <span class="red5">&lt;%=</span> gravatar_for user, <span class="violet">size</span>: <span class="ash">50</span> <span class="red5">%&gt;</span>
  <span class="red5">&lt;%=</span> link_to user<span class="ash">.</span>name, user <span class="red5">%&gt;</span>
&lt;/<b><span class="green">li</span></b>&gt;
</pre>
</div>
<p class="indent">This is a definite improvement, but we can do even better: We can call <span class="green"><strong><code>render</code></strong></span> <em>directly</em> on the <span class="green"><strong><code>@users</code></strong></span> variable (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex052">Listing 10.52</a>).</p>
<p class="ex-title" id="ch10ex052"><strong>Listing 10.52:</strong> The fully refactored users index. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">app/views/users/index.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-52a" id="lis10-52">Click here to view code image</a></p>
<div class="example">
<pre><span class="red5">&lt;%</span> provide(<span class="violet">:title</span>, <span class="maroon">'All users'</span>) <span class="red5">%&gt;</span>
&lt;<b><span class="green">h1</span></b>&gt;All users&lt;/<b><span class="green">h1</span></b>&gt;

<span class="red5">&lt;%=</span> will_paginate <span class="red5">%&gt;</span>

&lt;<b><span class="green">ul</span></b> <span class="ash3">class</span><span class="ash">=</span><span class="maroon">"users"</span>&gt;
<span class="marko">  <span class="maroon1">&lt;%=</span> render <span class="blue1">@users</span> <span class="maroon1">%&gt;</span></span>
&lt;/<b><span class="green">ul</span></b>&gt;

<span class="red5">&lt;%=</span> will_paginate <span class="red5">%&gt;</span>
</pre>
</div>
<p class="noindent">Here Rails infers that <span class="green"><strong><code>@users</code></strong></span> is a list of <span class="green"><strong><code>User</code></strong></span> objects; moreover, when called with a collection of users, Rails automatically iterates through them and renders each one with the <span class="green"><strong><code>_user.html.erb</code></strong></span> partial (inferring the name of the partial from the name of the class). The result is the impressively compact code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex052">Listing 10.52</a>.</p>
<p class="indent">As with any refactoring, you should verify that the test suite is still <span class="green5"><small>GREEN</small></span> after changing the application code:</p>
<p class="ex-title" id="ch10ex053"><strong>Listing 10.53:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev118">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_525"></span></p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Comment out the <span class="green"><strong><code>render</code></strong></span> line in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex052">Listing 10.52</a> and confirm that the resulting tests are <span class="red5"><small>RED</small></span>.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec10_4">10.4 Deleting Users</h3>
<p class="noindent">Now that the users index is complete, there’s only one canonical REST action left: <span class="green"><strong><code>destroy</code></strong></span>. In this section, we’ll add links to delete users, as mocked up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig013">Figure 10.13</a>, <span epub:type="pagebreak" id="page_526"></span>and define the <span class="green"><strong><code>destroy</code></strong></span> action necessary to accomplish the deletion. But first, we’ll create the class of administrative users, or <em>admins</em>, authorized to do so. In the context of authorization, such a set of special privileges is known as a <em>role</em>.</p>
<figure id="ch10fig013" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_13.jpg" alt="Image" width="714" height="593" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_13.jpg">
<figcaption><p><strong>Figure 10.13:</strong> A mockup of the users index with delete links.</p></figcaption>
</figure>
<section>
<h4 class="h4" id="sec10_4_1">10.4.1 Administrative Users</h4>
<p class="noindent">We will identify privileged administrative users with a boolean <span class="green"><strong><code>admin</code></strong></span> attribute in the User model, which will lead automatically to an <span class="green"><strong><code>admin?</code></strong></span> boolean method to test for admin status. The resulting data model appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig014">Figure 10.14</a>.</p>
<figure id="ch10fig014" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_14.jpg" alt="Image" width="579" height="401" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_14.jpg">
<figcaption><p><strong>Figure 10.14:</strong> The User model with an added <span class="green"><strong><code>admin</code></strong></span> boolean attribute.</p></figcaption>
</figure>
<p class="indent">As usual, we add the <span class="green"><strong><code>admin</code></strong></span> attribute with a migration, indicating the <span class="green"><strong><code>boolean</code></strong></span> type on the command line:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg526a" id="pg526">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> rails generate migration add_admin_to_users admin:boolean</pre>
<p class="indent">The migration adds the <span class="green"><strong><code>admin</code></strong></span> column to the <span class="green"><strong><code>users</code></strong></span> table, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex054">Listing 10.54</a>. Note that we’ve added the argument <span class="green"><strong><code>default: false</code></strong></span> to <span class="green"><strong><code>add_column</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex054">Listing 10.54</a>, which means that users will <em>not</em> be administrators by default. (Without the <span class="green"><strong><code>default: false</code></strong></span> argument, <span class="green"><strong><code>admin</code></strong></span> will be <span class="green"><strong><code>nil</code></strong></span> by default, which is still <span class="green"><strong><code>false</code></strong></span>, <span epub:type="pagebreak" id="page_527"></span>so this step is not strictly necessary. It is more explicit, though, and communicates our intentions more clearly both to Rails and to readers of our code.)</p>
<p class="ex-title" id="ch10ex054"><strong>Listing 10.54:</strong> The migration to add a boolean <span class="green"><strong><code>admin</code></strong></span> attribute to users.</p>
<pre class="pre2">db/migrate/[timestamp]_add_admin_to_users.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-54a" id="lis10-54">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">AddAdminToUsers</span></b> <span class="ash">&lt;</span> <span class="red">ActiveRecord</span><span class="ash">::</span><span class="red">Migration</span><span class="ash">[6.0]</span>
  <b><span class="green">def</span></b> <span class="blue3">change</span>
<span class="marko">    add_column <span class="blue1">:users</span>, <span class="blue1">:admin</span>, <span class="blue1">:boolean</span>, <span class="blue1">default</span>: <b><span class="green3">false</span></b></span>
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">Next, we migrate as usual:</p>
<pre class="pre1">$ rails db:migrate</pre>
<p class="noindent">As expected, Rails figures out the boolean nature of the <span class="green"><strong><code>admin</code></strong></span> attribute and automatically adds the question-mark method <span class="green"><strong><code>admin?</code></strong></span>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg527a" id="pg527">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console --sandbox</span>
<b><span class="navy">&gt;&gt;</span></b> user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>first
<b><span class="navy">&gt;&gt;</span></b> user<span class="ash">.</span>admin?
<span class="green">=&gt; false</span>
<b><span class="navy">&gt;&gt;</span></b> user<span class="ash">.</span>toggle!(<span class="violet">:admin</span>)
<span class="green">=&gt; true</span>
<b><span class="navy">&gt;&gt;</span></b> user<span class="ash">.</span>admin?
<span class="green">=&gt; true</span></pre>
<p class="noindent">Here we’ve used the <span class="green"><strong><code>toggle!</code></strong></span> method to flip the <span class="green"><strong><code>admin</code></strong></span> attribute from <span class="green"><strong><code>false</code></strong></span> to <span class="green"><strong><code>true</code></strong></span>.</p>
<p class="indent">As a final step, let’s update our seed data to make the first user an admin by default (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex055">Listing 10.55</a>).</p>
<p class="ex-title" id="ch10ex055"><strong>Listing 10.55:</strong> The seed data code with an admin user.</p>
<pre class="pre2">db/seeds.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-55a" id="lis10-55">Click here to view code image</a></p>
<div class="example">
<pre><span class="blue"># Create a main sample user.</span>
<span class="red">User</span><span class="ash">.</span>create!(<span class="green1">name</span>: <span class="maroon">"Example User"</span>,
             <span class="violet">email</span>: <span class="maroon">"example@railstutorial.org"</span>,
             <span class="violet">password</span>:              <span class="maroon">"foobar"</span>,
<span class="marko">             <span class="blue1">password_confirmation</span>: <span class="red2">"foobar"</span>,</span>
             <span class="violet">admin</span>: <b><span class="green">true</span></b>)
<span epub:type="pagebreak" id="page_528"></span><span class="blue"># Generate a bunch of additional users.</span>
<span class="ash">99.</span>times <b><span class="green">do</span></b> <span class="ash">|</span>n<span class="ash">|</span>
  <span class="green1">name</span> <span class="ash">=</span> <span class="red">Faker</span><span class="ash">::</span><span class="red">Name</span><span class="ash">.</span>name
  email <span class="ash">=</span> <span class="maroon">"example-</span><b><span class="red6">#{</span></b>n<span class="ash">+1</span><b><span class="pink">}</span></b><span class="maroon">@railstutorial.org"</span>
  password <span class="ash">=</span> <span class="maroon">"password"</span>
  <span class="red">User</span><span class="ash">.</span>create!(<span class="green1">name</span>: <span class="green1">name</span>,
               <span class="violet">email</span>: email,
               <span class="violet">password</span>:              password,
               <span class="violet">password_confirmation</span>: password)
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Then reset and reseed the database:</p>
<pre class="pre1">$ rails db:migrate:reset
$ rails db:seed</pre>
<section>
<h5 class="h5" id="lev119">Revisiting Strong Parameters</h5>
<p class="noindent">You might have noticed that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex055">Listing 10.55</a> makes the user an admin by including <span class="green"><strong><code>admin: true</code></strong></span> in the initialization hash. This underscores the danger of exposing our objects to the wild web—if we simply passed an initialization hash in from an arbitrary web request, a malicious user could send a <code>PATCH</code> request as follows:<sup><a id="ch10fn14a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn14">14</a></sup></p>
<p class="footnote"><a id="ch10fn14" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn14a">14</a>. Command-line tools such as <code>curl</code> can issue <code>PATCH</code> requests of this form.</p>
<pre class="pre1">patch /users/17?admin=1</pre>
<p class="noindent">This request would make user 17 an admin, which would be a potentially serious security breach.</p>
<p class="indent">Because of this danger, it is essential that we update only attributes that are safe to edit through the web. As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_2">Section 7.3.2</a>, this is accomplished using <em>strong parameters</em> by calling <span class="green"><strong><code>require</code></strong></span> and <span class="green"><strong><code>permit</code></strong></span> on the <span class="green"><strong><code>params</code></strong></span> hash:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg528-2a" id="pg528-2">Click here to view code image</a></p>
<pre class="pre1"><b><span class="green">def</span></b> <span class="blue3">user_params</span>
  params<span class="ash">.</span>require(<span class="violet">:user</span>)<span class="ash">.</span>permit(<span class="violet">:name</span>, <span class="violet">:email</span>, <span class="violet">:password</span>,
                               <span class="violet">:password_confirmation</span>)
<b><span class="green">end</span></b></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_529"></span>Note that <span class="green"><strong><code>admin</code></strong></span> is <em>not</em> in the list of permitted attributes. This prevents arbitrary users from granting themselves administrative access to our application. Because of its importance, it’s a good idea to write a test for any attribute that isn’t editable, and writing such a test for the <span class="green"><strong><code>admin</code></strong></span> attribute is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_4_1">Section 10.4.1</a>).</p>
</section>
<section>
<h5 class="h5" id="lev120">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">By issuing a <code>PATCH</code> request directly to the user path as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex056">Listing 10.56</a>, verify that the <span class="green"><strong><code>admin</code></strong></span> attribute isn’t editable through the web. To be sure your test is covering the right thing, your first step should be to <em>add</em> <span class="green"><strong><code>admin</code></strong></span> to the list of permitted parameters in <span class="green"><strong><code>user_params</code></strong></span> so that the initial test is <span class="red5"><small>RED</small></span>. For the final line, make sure to load the updated user information from the database (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_5">Section 6.1.5</a>).</p></li>
</ol>
<p class="ex-title" id="ch10ex056"><strong>Listing 10.56:</strong> Testing that the <span class="green"><strong><code>admin</code></strong></span> attribute is forbidden.</p>
<pre class="pre2">test/controllers/users_controller_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-56a" id="lis10-56">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersControllerTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span>       <span class="ash">=</span> users(<span class="violet">:michael</span>)
    <span class="violet">@other_user</span> <span class="ash">=</span> users(<span class="violet">:archer</span>)
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"should redirect update when not logged in"</span> <b><span class="green">do</span></b>
    patch user_path(<span class="violet">@user</span>), <span class="violet">params</span>: { <span class="violet">user</span>: { <span class="green1">name</span>: <span class="violet">@user</span><span class="ash">.</span>name,
                                              <span class="violet">email</span>: <span class="violet">@user</span><span class="ash">.</span>email } }
    assert_not flash<span class="ash">.</span>empty?
    assert_redirected_to login_url
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"should not allow the admin attribute to be edited via the web"</span> <b><span class="green">do</span></b>
    log_in_as(<span class="violet">@other_user</span>)
    assert_not <span class="violet">@other_user</span><span class="ash">.</span>admin?
<span epub:type="pagebreak" id="page_530"></span>    patch user_path(<span class="violet">@other_user</span>), <span class="violet">params</span>: {
                                    <span class="violet">user</span>: { <span class="violet">password</span>:              <span class="maroon">"password"</span>,
                                            <span class="violet">password_confirmation</span>: <span class="maroon">"password"</span>,
<span class="marko">                                            <span class="blue1">admin</span>: <span class="pink1">FILL_IN</span> } }</span>
<span class="marko">    assert_not <span class="blue1">@other_user</span><span class="ash1">.</span>FILL_IN<span class="ash1">.</span>admin?</span>
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<h4 class="h4" id="sec10_4_2">10.4.2 The <code>destroy</code> Action</h4>
<p class="noindent">The final step needed to complete the Users resource is to add delete links and a <span class="green"><strong><code>destroy</code></strong></span> action. We’ll start by adding a delete link for each user on the users index page, restricting access to administrative users. The resulting <span class="green"><strong><code>"delete"</code></strong></span> links will be displayed only if the current user is an admin (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex057">Listing 10.57</a>).</p>
<p class="ex-title" id="ch10ex057"><strong>Listing 10.57:</strong> User delete links (viewable only by admins).</p>
<pre class="pre2">app/views/users/_user.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-57a" id="lis10-57">Click here to view code image</a></p>
<div class="example">
<pre>&lt;<b><span class="green">li</span></b>&gt;
  <span class="red5">&lt;%=</span> gravatar_for user, <span class="violet">size</span>: <span class="ash">50</span> <span class="red5">%&gt;</span>
  <span class="red5">&lt;%=</span> link_to user<span class="ash">.</span>name, user <span class="red5">%&gt;</span>
<span class="marko">  <span class="maroon1">&lt;%</span> <b><span class="green3">if</span></b> current_user<span class="ash1">.</span>admin? <span class="ash1">&amp;&amp; !</span>current_user?(user) <span class="maroon1">%&gt;</span></span>
<span class="marko">    | <span class="maroon1">&lt;%=</span> link_to <span class="red2">"delete"</span>, user, <span class="green3">method</span>: <span class="blue1">:delete</span>,</span>
<span class="marko">                                  <span class="blue1">data</span>: { <span class="blue1">confirm</span>: <span class="red2">"You sure?"</span> } <span class="maroon1">%&gt;</span></span>
  <span class="maroon1">&lt;%</span> <b><span class="green3">end</span></b> <span class="maroon1">%&gt;</span>
&lt;/<b><span class="green">li</span></b>&gt;</pre>
</div>
<p class="noindent">Note the <span class="green"><strong><code>method: :delete</code></strong></span> argument, which arranges for the link to issue the necessary <code>DELETE</code> request. We’ve also wrapped each link inside an <span class="green"><strong><code>if</code></strong></span> statement so that only admins can see them. The result for our admin user appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig015">Figure 10.15</a>.</p>
<p class="indent">Web browsers can’t send <code>DELETE</code> requests natively, so Rails fakes them with Java-Script. As a consequence, the delete links won’t work if the user has JavaScript disabled. If you must support non-JavaScript-enabled browsers, you can fake a <code>DELETE</code> request using a form and a <code>POST</code> request, which works even without JavaScript.<sup><a id="ch10fn15a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn15">15</a></sup></p>
<p class="footnote"><a id="ch10fn15" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fn15a">15</a>. See the RailsCast on “Destroy Without JavaScript” (<a href="http://railscasts.com/episodes/77-destroy-without-javascript">railscasts.com/episodes/77-destroy-without-javascript</a>) for details.<span epub:type="pagebreak" id="page_531"></span></p>
<figure id="ch10fig015" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_15.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_15.jpg">
<figcaption><p><strong>Figure 10.15:</strong> The users index with delete links.</p></figcaption>
</figure>
<p class="indent">To get the delete links to work, we need to add a <span class="green"><strong><code>destroy</code></strong></span> action (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07tab01">Table 7.1</a>), which finds the corresponding user and destroys it with the Active Record <span class="green"><strong><code>destroy</code></strong></span> method, then redirects to the users index, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex058">Listing 10.58</a>. Because users have to be logged in to delete users, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex058">Listing 10.58</a> also adds <span class="green"><strong><code>:destroy</code></strong></span> to the <span class="green"><strong><code>logged_in_user</code></strong></span> before filter.</p>
<p class="ex-title" id="ch10ex058"><strong>Listing 10.58:</strong> Adding a working <span class="green"><strong><code>destroy</code></strong></span> action.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-58a" id="lis10-58">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
<span class="marko">  before_action <span class="blue1">:logged_in_user</span>, <span class="blue1">only</span>: <span class="ash1">[</span><span class="blue1">:index</span>, <span class="blue1">:edit</span>, <span class="blue1">:update</span>, <span class="blue1">:destroy</span><span class="ash1">]</span></span>
  before_action <span class="violet">:correct_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">def</span></b> <span class="blue3">destroy</span>
<span class="marko">    <span class="red2">User</span><span class="ash1">.</span>find(params<span class="ash1">[</span><span class="blue1">:id</span><span class="ash1">]</span>)<span class="ash1">.</span>destroy</span>
<span epub:type="pagebreak" id="page_532"></span><span class="marko">    flash<span class="ash1">[</span><span class="blue1">:success</span><span class="ash1">] =</span> <span class="red2">"User deleted"</span></span>
<span class="marko">    redirect_to users_url</span>
  <b><span class="green">end</span></b>

  <b><span class="green">private</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<b><span class="green">end</span></b></pre>
</div>
<p class="indent">As constructed, only admins can destroy users through the web since only they can see the delete links, but there’s still a terrible security hole: Any sufficiently sophisticated attacker could simply issue a <code>DELETE</code> request directly from the command line to delete any user on the site. To secure the site properly, we also need access control on the <span class="green"><strong><code>destroy</code></strong></span> action, so that <em>only</em> admins can delete users.</p>
<p class="indent">As in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_1">Section 10.2.1</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_2">Section 10.2.2</a>, we’ll enforce access control using a before filter, this time to restrict access to the <span class="green"><strong><code>destroy</code></strong></span> action to admins. The resulting <span class="green"><strong><code>admin_user</code></strong></span> before filter appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex059">Listing 10.59</a>.</p>
<p class="ex-title" id="ch10ex059"><strong>Listing 10.59:</strong> A before filter restricting the <span class="green"><strong><code>destroy</code></strong></span> action to admins.</p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-59a" id="lis10-59">Click here to view code image</a></p>
<div class="example">
<pre><b><span class="green">class</span> <span class="blue3">UsersController</span></b> <span class="ash">&lt;</span> <span class="red">ApplicationController</span>
  before_action <span class="violet">:logged_in_user</span>, <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:index</span>, <span class="violet">:edit</span>, <span class="violet">:update</span>, <span class="violet">:destroy</span><span class="ash">]</span>
  before_action <span class="violet">:correct_user</span>,   <span class="violet">only</span>: <span class="ash">[</span><span class="violet">:edit</span>, <span class="violet">:update</span><span class="ash">]</span>
<span class="marko">  before_action <span class="blue1">:admin_user</span>,     <span class="blue1">only</span>: <span class="blue1">:destroy</span></span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <b><span class="green">private</span></b>
    <span class="ash">.</span>
    <span class="ash">.</span>
    <span class="ash">.</span>
    <span class="blue"># Confirms an admin user.</span>
    <b><span class="green">def</span></b> <span class="blue3">admin_user</span>
<span class="marko">      redirect_to(root_url) <b><span class="green3">unless</span></b> current_user<span class="ash1">.</span>admin?</span>
    <b><span class="green">end</span></b>
<b><span class="green">end</span></b>
</pre>
</div>
</section>
<section>
<h5 class="h5" id="lev121">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_533"></span></p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">As the admin user, destroy a few sample users through the web interface. What are the corresponding entries in the server log?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec10_4_3">10.4.3 User Destroy Tests</h4>
<p class="noindent">With something as dangerous as destroying users, it’s important to have good tests for the expected behavior. We start by arranging for one of our fixture users to be an admin, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex060">Listing 10.60</a>.</p>
<p class="ex-title" id="ch10ex060"><strong>Listing 10.60:</strong> Making one of the fixture users an admin.</p>
<pre class="pre2">test/fixtures/users.yml</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-60a" id="lis10-60">Click here to view code image</a></p>
<div class="example">
<pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;
<span class="marko">  admin: true</span>

archer:
  name: Sterling Archer
  email: duchess@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

lana:
  name: Lana Kane
  email: hands@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

malory:
  name: Malory Archer
  email: boss@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

&lt;% 30.times do |n| %&gt;
user_&lt;%= n %&gt;:
  name:  &lt;%= "User #{n}" %&gt;
  email: &lt;%= "user-#{n}@example.com" %&gt;
  password_digest: &lt;%= User.digest('password') %&gt;
&lt;% end %&gt;</pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_534"></span>Following the practice from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_1">Section 10.2.1</a>, we’ll put action-level tests of access control in the Users controller test file. As with the logout test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex038">Listing 8.38</a>, we’ll use <span class="green"><strong><code>delete</code></strong></span> to issue a <code>DELETE</code> request directly to the <span class="green"><strong><code>destroy</code></strong></span> action. We need to check two cases: (1) users who aren’t logged in should be redirected to the login page and (2) users who are logged in but who aren’t admins should be redirected to the Home page. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex061">Listing 10.61</a>.</p>
<p class="ex-title" id="ch10ex061"><strong>Listing 10.61:</strong> Action-level tests for admin access control. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/controllers/users_controller_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-61a" id="lis10-61">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersControllerTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@user</span>       <span class="ash">=</span> users(<span class="violet">:michael</span>)
    <span class="violet">@other_user</span> <span class="ash">=</span> users(<span class="violet">:archer</span>)
  <b><span class="green">end</span></b>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"should redirect destroy when not logged in"</span> <b><span class="green">do</span></b>
    assert_no_difference <span class="maroon">'User.count'</span> <b><span class="green">do</span></b>
      delete user_path(<span class="violet">@user</span>)
    <b><span class="green">end</span></b>
    assert_redirected_to login_url
  <b><span class="green">end</span></b>

  <span class="green1">test</span> <span class="maroon">"should redirect destroy when logged in as a non-admin"</span> <b><span class="green">do</span></b>
    log_in_as(<span class="violet">@other_user</span>)
    assert_no_difference <span class="maroon">'User.count'</span> <b><span class="green">do</span></b>
      delete user_path(<span class="violet">@user</span>)
   <b><span class="green">end</span></b>
   assert_redirected_to root_url
  <b><span class="green">end</span></b>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex061">Listing 10.61</a> also makes sure that the user count doesn’t change using the <span class="green"><strong><code>assert_no_difference</code></strong></span> method (seen earlier in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex023">Listing 7.23</a>).</p>
<p class="indent">The tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex061">Listing 10.61</a> verify the behavior in the case of an unauthorized (non-admin) user, but we also want to check that an admin can use a delete link to successfully destroy a user. Since the delete links appear on the users index, we’ll add <span epub:type="pagebreak" id="page_535"></span>these tests to the users index test from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex048">Listing 10.48</a>. The only really tricky part is verifying that a user gets deleted when an admin clicks on a delete link, which we’ll accomplish as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg535a" id="pg535">Click here to view code image</a></p>
<pre class="pre1">assert_difference <span class="maroon">'User.count'</span>, <span class="ash">-1</span> <b><span class="green">do</span></b>
  delete user_path(<span class="violet">@other_user</span>)
<b><span class="green">end</span></b></pre>
<p class="noindent">This uses the <span class="green"><strong><code>assert_difference</code></strong></span> method first seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex031">Listing 7.31</a> when creating a user, this time verifying that a user is <em>destroyed</em> by checking that <span class="green"><strong><code>User.count</code></strong></span> changes by –1 when issuing a <span class="green"><strong><code>delete</code></strong></span> request to the corresponding user path.</p>
<p class="indent">Putting everything together gives the pagination and delete test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex062">Listing 10.62</a>, which includes tests for both admins and non-admins.</p>
<p class="ex-title" id="ch10ex062"><strong>Listing 10.62:</strong> An integration test for delete links and destroying users. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2">test/integration/users_index_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#lis10-62a" id="lis10-62">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<b><span class="green">class</span> <span class="blue3">UsersIndexTest</span></b> <span class="ash">&lt;</span> <span class="red">ActionDispatch</span><span class="ash">::</span><span class="red">IntegrationTest</span>

  <b><span class="green">def</span></b> <span class="blue3">setup</span>
    <span class="violet">@admin</span>     <span class="ash">=</span> users(<span class="violet">:michael</span>)
<span class="marko">    <span class="blue1">@non_admin</span> <span class="ash1">=</span> users(<span class="blue1">:archer</span>)</span>
  <b><span class="green">end</span></b>

<span class="marko">  <span class="green3">test</span> <span class="red2">"index as admin including pagination and delete links"</span> <b><span class="green3">do</span></b></span>
    log_in_as(<span class="violet">@admin</span>)
    get users_path
    assert_template <span class="maroon">'users/index'</span>
    assert_select <span class="maroon">'div.pagination'</span>
<span class="marko">    first_page_of_users <span class="ash1">=</span> <span class="pink1">User</span><span class="ash1">.</span>paginate(<span class="blue1">page</span>: <span class="ash1">1</span>)</span>
<span class="marko">    first_page_of_users<span class="ash1">.</span>each <b><span class="green3">do</span></b> <span class="ash1">|</span>user<span class="ash1">|</span></span>
<span class="marko">      assert_select <span class="red2">'a[href=?]'</span>, user_path(user), <span class="blue1">text</span>: user<span class="ash1">.</span>name</span>
<span class="marko">      <b><span class="green3">unless</span></b> user <span class="ash1">==</span> <span class="blue1">@admin</span></span>
<span class="marko">        assert_select <span class="red2">'a[href=?]'</span>, user_path(user), <span class="blue1">text</span>: <span class="red2">'delete'</span></span>
<span class="marko">      <b><span class="green3">end</span></b></span>
<span class="marko">  <b><span class="green3">end</span></b></span>
<span class="marko">  assert_difference <span class="red2">'User.count'</span>, <span class="ash1">-1</span> <b><span class="green3">do</span></b></span>
<span class="marko">    delete user_path(<span class="blue1">@non_admin</span>)</span>
<span class="marko">  <b><span class="green3">end</span></b></span>
<b><span class="green">end</span></b>
<span epub:type="pagebreak" id="page_536"></span><span class="marko">  <span class="green3">test</span> <span class="red2">"index as non-admin"</span> <b><span class="green3">do</span></b></span>
<span class="marko">    log_in_as(<span class="blue1">@non_admin</span>)</span>
<span class="marko">    get users_path</span>
<span class="marko">    assert_select <span class="red2">'a'</span>, <span class="blue1">text</span>: <span class="red2">'delete'</span>, <span class="blue1">count</span>: <span class="ash1">0</span></span>
<span class="marko">  <b><span class="green3">end</span></b></span>
<b><span class="green">end</span></b></pre>
</div>
<p class="noindent">Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex062">Listing 10.62</a> checks for the right delete links, including skipping the test if the user happens to be the admin (which lacks a delete link due to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex057">Listing 10.57</a>).</p>
<p class="indent">At this point, our deletion code is well tested, and the test suite should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch10ex063"><strong>Listing 10.63:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev122">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">By commenting out the admin user before filter in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex059">Listing 10.59</a>, confirm that the tests go <span class="red5"><small>RED</small></span>.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec10_5">10.5 Conclusion</h3>
<p class="noindent">We’ve come a long way since we introduced the Users controller way back in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#sec5_4">Section 5.4</a>. Those users couldn’t even sign up; now users can sign up, log in, log out, view their profiles, edit their settings, and see an index of all users—and some can even destroy other users.</p>
<p class="indent">As it presently stands, the sample application forms a solid foundation for any website requiring users with authentication and authorization. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">Chapter 11</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>, we’ll add two additional refinements: an account activation link for newly registered users (verifying a valid email address in the process) and password resets to help users who forget their passwords.<span epub:type="pagebreak" id="page_537"></span></p>
<p class="indent">Before moving on, be sure to merge all the changes into the master branch:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg537-1a" id="pg537-1">Click here to view code image</a></p>
<pre class="pre1"><b><span class="navy">$</span></b> git add -A
<b><span class="navy">$</span></b> git commit -m <span class="maroon">"Finish user edit, update, index, and destroy actions"</span>
<b><span class="navy">$</span></b> git checkout master
<b><span class="navy">$</span></b> git merge updating-users
<b><span class="navy">$</span></b> git push</pre>
<p class="noindent">You can also deploy the application and even populate the production database with sample users (using the <span class="green"><strong><code>pg:reset</code></strong></span> task to reset the production database):</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10_images.xhtml#pg537-2a" id="pg537-2">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rails db:migrate
$ heroku run rails db:seed</pre>
<p class="noindent">Of course, you probably wouldn’t want to seed a real site with sample data, but I include this step here for purposes of illustration (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig016">Figure 10.16</a>). Incidentally, the order of the sample users in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig016">Figure 10.16</a> may vary, and on my system it doesn’t match the local version from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10fig011">Figure 10.11</a>; because we haven’t specified a default ordering for users when retrieved from the database, the current order is database-dependent. This doesn’t matter much for users, but it will for microposts, and we’ll address this issue further in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_4">Section 13.1.4</a>.</p>
<figure id="ch10fig016" class="image-l">
<img src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/fig10_16.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig10_16.jpg">
<figcaption><p><strong>Figure 10.16:</strong> The sample users in production.</p></figcaption>
</figure>
<section>
<h4 class="h4" id="sec10_5_1">10.5.1 What We Learned in this Chapter</h4>
<p class="bullet">• Users can be updated using an edit form, which sends a <code>PATCH</code> request to the <span class="green"><strong><code>update</code></strong></span> action.</p>
<p class="bullet">• Safe updating through the web is enforced using strong parameters.</p>
<p class="bullet">• Before filters give a standard way to run methods before particular controller actions.</p>
<p class="bullet">• We implement an authorization using before filters.</p>
<p class="bullet">• Authorization tests use both low-level commands to submit particular HTTP requests directly to controller actions and high-level integration tests.</p>
<p class="bullet">• Friendly forwarding redirects users where they wanted to go after logging in.<span epub:type="pagebreak" id="page_538"></span></p>
<p class="bullet">• The users index page shows all users, one page at a time.</p>
<p class="bullet">• Rails uses the standard file <span class="green"><strong><code>db/seeds.rb</code></strong></span> to seed the database with sample data using <span class="green"><strong><code>rails db:seed</code></strong></span>.</p>
<p class="bullet">• Running <span class="green"><strong><code>render @users</code></strong></span> automatically calls the <span class="green"><strong><code>_user.html.erb</code></strong></span> partial on each user in the collection.</p>
<p class="bullet">• A boolean attribute called <span class="green"><strong><code>admin</code></strong></span> on the User model automatically creates an <span class="green"><strong><code>admin?</code></strong></span> boolean method on user objects.</p>
<p class="bullet">• Admins can delete users through the web by clicking on delete links that issue <code>DELETE</code> requests to the Users controller <span class="green"><strong><code>destroy</code></strong></span> action.</p>
<p class="bullet">• We can create a large number of test users by using embedded Ruby inside fixtures.</p>
</section>
</section>
</section>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-12" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 9. Advanced Login</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 11. Account Activation</div>
        </a>
    
  
  </div>

</section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed slideUp">
        
        
          <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        

        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
  <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">© 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(1)" charset="utf-8"></script><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/embed.js.download"></script>
    <script src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(2)" charset="utf-8"></script>
  

<div></div><div></div><div class="selection_bubble_root" style="display: none;"></div><div class="annotator-notice"></div><div class="font-flyout" style="top: 201.006px; left: 1194.34px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#">Reset</a>
</div>
</div><script type="text/javascript" async="" src="./Chapter 10. Updating, Showing, and Deleting Users - Ruby on Rails Tutorial, 6th Edition_files/generic1604331345324.js.download" charset="UTF-8"></script><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script><span></span><script type="text/javascript" id="">dataLayer.push({"ld.experiment":void 0,"ld.variation":void 0});</script></body></html>