<!DOCTYPE html>
<!-- saved from url=(0080)https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage no-applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/ruby-on-rails/9780136702726/ch10.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="10224494" data-user-uuid="66943332-5511-462c-876e-5d5b720c7edf" data-username="czjtgu3dkobug4zdmolfga2wembsmu" data-account-type="Trial" data-activated-trial-date="12/02/2020" data-archive="9780136702726" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch10.xhtml" data-epub-title="Ruby on Rails Tutorial, 6th Edition" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780136702726"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/css" rel="stylesheet" type="text/css"><title>Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition</title><link rel="stylesheet" href="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/output.731fc84c4f9a.css" type="text/css"><link rel="stylesheet" type="text/css" href="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/font-awesome.min.css"><style type="text/css" title="ibis-book">@page{margin:1em 2em}#sbo-rt-content div{margin-top:1em;margin-bottom:1em;margin-left:1em;margin-right:1em;text-align:justify}#sbo-rt-content div.cover img{max-width:99%;max-height:99%}#sbo-rt-content .att{text-align:right}#sbo-rt-content .cover{margin-top:.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .h1{margin-top:1.5em;margin-bottom:.5em;font-weight:bold;font-size:210%;page-break-after:avoid;border-bottom:solid .1em;text-align:center}#sbo-rt-content .halftitle{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:210%;page-break-after:avoid;text-align:center}#sbo-rt-content .h2{margin-top:1em;margin-bottom:.1em;font-weight:bold;font-size:180%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2f{margin-top:1em;margin-bottom:2.5em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2t{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .center{text-align:center}#sbo-rt-content .h3{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:160%;page-break-after:avoid;text-align:left}#sbo-rt-content .h4{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:130%;page-break-after:avoid;text-align:left}#sbo-rt-content .h5{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:120%;page-break-after:avoid;text-align:left}#sbo-rt-content ul{margin-top:1em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content ul.sq{list-style-type:square}#sbo-rt-content ul.sq li p,#sbo-rt-content ul.sq li p.noindent{margin-top:.5em;margin-left:1em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .left{text-align:left}#sbo-rt-content .ex-title{margin-top:.8em;margin-bottom:.5em;text-indent:.1em;font-size:100%}#sbo-rt-content code{font-family:Courier,Courier New,monospace;font-size:small}#sbo-rt-content pre{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small}#sbo-rt-content .pre3{font-family:Courier,Courier New,monospace;margin-top:1em;margin-bottom:1em;margin-left:2.9em;background-color:#E6E6E6}#sbo-rt-content .equ{margin-top:.8em;margin-bottom:.5em;text-align:center}#sbo-rt-content .footnum{margin-top:.7em;margin-bottom:.5em;text-indent:-1em;margin-left:3.3em}#sbo-rt-content .footnotep{margin-top:.8em;margin-left:.8em;margin-bottom:.5em;text-indent:.8em}#sbo-rt-content .mark1{background-color:#F4F7F9}#sbo-rt-content .codelink{margin-top:.2em;margin-bottom:.5em}#sbo-rt-content .middle img{vertical-align:middle}#sbo-rt-content .box{margin-top:.6em;margin-bottom:1em;margin-left:.1em;margin-right:.8em;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .box-bq{font-size:.8em;margin-top:.8em;margin-bottom:.5em;margin-left:1.6em;text-indent:.1em;background-color:#E6E6E6}#sbo-rt-content .boxip{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:.8em;background-color:#E6E6E6}#sbo-rt-content ol.num{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p,#sbo-rt-content ol.num li p.number{margin-top:.5em;margin-left:.2em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .num-p{margin-top:.5em;margin-bottom:.5em;margin-left:0}#sbo-rt-content .bullet{margin-top:.7em;margin-bottom:.5em;text-indent:-.8em;margin-left:2em}#sbo-rt-content .credit{margin-top:.1em;margin-bottom:.1em;text-indent:-1.5em;margin-left:2em}#sbo-rt-content .box-caption{margin-top:.1em;margin-bottom:1em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:left}#sbo-rt-content .example{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small;border-top:.02em solid black;border-bottom:.02em solid black}#sbo-rt-content .image-l{margin-top:.8em;margin-left:1em;text-align:center}#sbo-rt-content .topbot{margin-top:.8em;margin-bottom:.5em;border-bottom:solid black .1em;border-top:solid black .1em;text-indent:.1em}#sbo-rt-content .uln{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash1{margin-top:.7em;margin-bottom:.7em;margin-left:3em}#sbo-rt-content .tr{border-bottom:.1em solid black}#sbo-rt-content th{text-align:left}#sbo-rt-content td{padding-left:.1em;padding-top:0;padding-bottom:0;vertical-align:top;text-align:left}#sbo-rt-content .mark{background-color:#E6E6E6}#sbo-rt-content .pre1{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:0;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .pre2{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content .tab-thc{margin-top:.1em;margin-bottom:.1em;border-bottom:solid black .1em;text-align:center}#sbo-rt-content .tab-th{margin-top:.1em;border-bottom:solid black .1em;border-top:solid black .1em;text-align:left}#sbo-rt-content .author{margin-top:2.5em;margin-bottom:5.5em;text-align:center;font-size:120%}#sbo-rt-content .pub{margin-top:1.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .pub1{font-weight:bold;font-size:.9em;margin-top:.1em;margin-bottom:.5em;text-align:center}#sbo-rt-content .copy{margin-top:.9em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .copy1{margin-top:.9em;margin-bottom:.2em;text-indent:.02em}#sbo-rt-content .copy2{margin-top:.2em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .title{margin-top:1em;margin-bottom:.2em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:center}#sbo-rt-content .noindent{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .tab-para{margin-top:.1em;margin-bottom:.1em;margin-left:.1em;text-indent:0}#sbo-rt-content .tab-parai{margin-top:.1em;margin-bottom:.1em;margin-left:1.1em;text-indent:-1.1em}#sbo-rt-content .boxnp{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .toc-intro{margin-top:.1em;margin-bottom:.5em;margin-left:1.5em;text-align:left}#sbo-rt-content .tocchap{margin-top:1.5em;margin-bottom:.4em;margin-left:3.4em;text-indent:-4em}#sbo-rt-content .toclev1{margin-top:.4em;margin-bottom:.4em;margin-left:1em}#sbo-rt-content .toclev2{margin-top:.4em;margin-bottom:.4em;margin-left:2.6em}#sbo-rt-content .toclev1a{margin-top:.4em;margin-bottom:.4em;margin-left:.5em}#sbo-rt-content .toc-index{margin-top:2em;margin-bottom:.4em;margin-left:.7em}#sbo-rt-content .indexmain{margin-top:.4em;margin-bottom:.2em;margin-left:.8em;text-indent:-.8em}#sbo-rt-content .indexsub{margin-top:.4em;margin-bottom:.2em;margin-left:1.7em;text-indent:-.7em}#sbo-rt-content .indexsubsub{margin-top:.4em;margin-bottom:.2em;font-style:italic;margin-left:3em;text-indent:-.9em}#sbo-rt-content figcaption{margin-top:.8em;margin-bottom:.5em;color:black;text-align:left;text-indent:.1em}#sbo-rt-content .subtitle{margin-top:.1em;margin-bottom:1em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .edition{margin-top:2em;margin-bottom:3em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .indent{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:1.5em}#sbo-rt-content .h2a{margin-top:.1em;margin-bottom:2em;font-weight:bold;font-size:190%;page-break-after:avoid;text-align:left}#sbo-rt-content figure>img{max-width:99%;max-height:99%}#sbo-rt-content figure{margin-top:1em;margin-bottom:1em;margin-left:.5em;margin-right:1.5em}#sbo-rt-content none{list-style-type:none}#sbo-rt-content a{text-decoration:none}#sbo-rt-content .footnote{font-size:.8em;margin-top:.1em;margin-bottom:.5em;margin-left:.8em}#sbo-rt-content .none{margin-top:.5em;margin-left:1em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content div.image-p img{width:80%}#sbo-rt-content .image-p{page-break-before:always;text-align:center}#sbo-rt-content table{border-collapse:collapse;border-spacing:0;background:transparent;vertical-align:top;margin-top:.1em;margin-right:.1em;margin-bottom:.9em;margin-left:0;width:100%}#sbo-rt-content .tab-parar{margin-top:.1em;margin-bottom:.1em;text-indent:.1em;text-align:right}#sbo-rt-content .h2i{margin-top:1em;margin-bottom:2.1em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content pre{overflow:auto;-ms-overflow:auto;-moz-overflow:auto;-webkit-overflow:auto;-ms-padding-bottom:5pt;-moz-padding-bottom:5pt;-webkit-padding-bottom:5pt}#sbo-rt-content .maroon{color:#BB2121}#sbo-rt-content .green{color:#005A00}#sbo-rt-content .green1{color:#48785D}#sbo-rt-content .navy{color:#504B72}#sbo-rt-content .ash{color:#666}#sbo-rt-content .blue{color:#408080}#sbo-rt-content .green3{color:#00A100}#sbo-rt-content .blue1{color:#0000B8}#sbo-rt-content .violet{color:#1A177D}#sbo-rt-content .pink{color:#A131A1}#sbo-rt-content .pink1{color:#A131A1}#sbo-rt-content .red{color:#800}#sbo-rt-content .blue3{color:#2E3192}#sbo-rt-content .red2{color:#B80000}#sbo-rt-content .green4{color:#269200}#sbo-rt-content .ash1{color:#666}#sbo-rt-content .ash2{color:#33484A}#sbo-rt-content .red2{color:#640000}#sbo-rt-content .ash3{color:#7D8F29}#sbo-rt-content .red5{color:#BD7B00}#sbo-rt-content .maroon1{color:#B66600}#sbo-rt-content .blue5{color:#1F3BFF}#sbo-rt-content .red6{color:#B68}#sbo-rt-content .green7{color:#14B600}#sbo-rt-content .maroon2{color:#B66600}#sbo-rt-content .pink2{color:#AC21FF}#sbo-rt-content .pink3{color:#AC21FF}#sbo-rt-content .lighgreen{color:#5FA100}#sbo-rt-content .lighblue{color:#269271}#sbo-rt-content .darkmaroon{color:#269271}#sbo-rt-content .maroon5{color:#A10000}#sbo-rt-content .blue6{color:#0000B9}#sbo-rt-content .marko{background-color:#FAF9CE}#sbo-rt-content .green5{color:#1C8B43}#sbo-rt-content .colork1{color:#136433;font-weight:bold}#sbo-rt-content .colork2{color:#504C72}#sbo-rt-content .colork3{color:#51785D}#sbo-rt-content .colork4{color:#303192}#sbo-rt-content .colork5{color:#955744}#sbo-rt-content .colork6{color:#5C70BA}#sbo-rt-content .colork7{color:#487864}#sbo-rt-content .colork8{color:#5C5778}#sbo-rt-content .colork9{color:#666}#sbo-rt-content .colork10{color:#48785D}#sbo-rt-content .colork11{color:#BC654D}#sbo-rt-content .colork12{color:#3E8185}#sbo-rt-content .colork13{color:#C62425}#sbo-rt-content .colork14{color:#1D8C43}#sbo-rt-content .colork15{color:#0D8140}#sbo-rt-content .colork16{color:#BB2425}#sbo-rt-content .colork17{color:#985744}#sbo-rt-content .colork18{color:#6C8896}#sbo-rt-content .colork19{color:#2A2C80}#sbo-rt-content .colork20{color:#BD2425}#sbo-rt-content .redk1{color:#EE1C25}#sbo-rt-content .colork21{color:#2A2C77}#sbo-rt-content .colork22{color:#955744}#sbo-rt-content .colork23{color:#BC6561}#sbo-rt-content .colork24{color:#BE7D2B}#sbo-rt-content .colork25{color:#8E7C5D}#sbo-rt-content .colork26{color:#7C5778}#sbo-rt-content .colork27{color:#9D1C1F}#sbo-rt-content .colork28{color:#AA5744}#sbo-rt-content .colork29{color:#C59861}#sbo-rt-content .grayk1{color:#C0908E}#sbo-rt-content .pd_green{color:#48785d}#sbo-rt-content .dark-green{color:#146333}#sbo-rt-content .mark1{background-color:#faf9ce}#sbo-rt-content .mark{background-color:#faf9ce}#sbo-rt-content .pd_ash{color:#666}#sbo-rt-content .pd_blue7{color:#6c8896}#sbo-rt-content .pd_blue1{color:#504b72}#sbo-rt-content .pd_red{color:#965744}#sbo-rt-content .pd_red2{color:#bb654e}#sbo-rt-content .pd_red5{color:#ed1c24}#sbo-rt-content .pd_blue5{color:#2e3192}#sbo-rt-content .pd_green4{color:#269200}#sbo-rt-content .pd_green5{color:#1c8b43}#sbo-rt-content .pd_blue3{color:#2c2c78}#sbo-rt-content .pd_orange{color:#c49847}</style><script type="text/javascript" async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/cool-2.1.15.min.js.download"></script><script type="text/javascript" async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/ec.js.download"></script><script type="text/javascript" async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/analytics.js.download"></script><script type="text/javascript" async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/f.txt"></script><script type="text/javascript" async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/js"></script><script crossorigin="anonymous" integrity="sha256-NiDMmov61Y536X/eLXLiDGzFVFmNLtPyu4b5aFB54ks=" type="text/javascript" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/appcues.main.11e38ef4746fd64ab30c11794299d10b30bcb704.js.download" async=""></script><script async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/gtm.js.download"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780136702726/chapter/ch10.xhtml",
          "book_id": "9780136702726",
          "chapter_uri": "ch10.xhtml",
          "position": 27.4567491080775,
          "user_uuid": "66943332-5511-462c-876e-5d5b720c7edf",
          "next_chapter_uri": "/library/view/ruby-on-rails/9780136702726/ch11.xhtml"
        
      },
      title: "Ruby on Rails Tutorial, 6th Edition",
      author_list: "Michael Hartl",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: true
    };
    // ]]></script><script src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/modernizr.8e35451ddb64.js.download"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta name="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta property="og:title" content="Chapter 10. Updating, Showing, and Deleting Users"><meta itemprop="isPartOf" content="/library/view/ruby-on-rails/9780136702726/"><meta itemprop="name" content="Chapter 10. Updating, Showing, and Deleting Users"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780136702726/"><meta property="og:description" itemprop="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9780136702726"><meta property="og:book:author" itemprop="author" content="Michael Hartl"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '66943332-5511-462c-876e-5d5b720c7edf';
      dataLayer.push({userIdentifier: '66943332-5511-462c-876e-5d5b720c7edf'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = 'ba5f3401-307d-4b66-90a6-a97047c63525';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/vendor.3eecedff6f59.js.download"></script><script defer="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/reader.772cf1e31d6c.js.download"></script><iframe src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource.html"></iframe><iframe src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(3).html"></iframe><iframe src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(4).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-q9sKb2HpA5fJjN1cK9LjLaEXff5ix81Rv1Y3xJFptPE=" crossorigin="anonymous" href="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/container.11e38ef4746fd64ab30c11794299d10b30bcb704.css"><iframe src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(5).html"></iframe><script src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/f(1).txt"></script><script async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/MathJax.js.download"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
</style><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style></head>


<body class="reading sidenav  scalefonts subscribe-panel library nav-collapsed"><div id="MathJax_Message" style="display: none;"></div>

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="working hide" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/66943332-5511-462c-876e-5d5b720c7edf/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Attend</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/live-training/" class="l2 nav-icn"><span>Live Trainings</span></a></li><li><a href="https://learning.oreilly.com/featured/architectural-katas" class="l2 nav-icn"><span>Architectural Katas</span></a></li><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interact</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/?classification=content-scenario" class="l2 nav-icn"><span>Scenarios</span></a></li><li><a href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario" class="l2 nav-icn"><span>Sandboxes</span></a></li><li><a href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li><a href="https://learning.oreilly.com/answers/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"></path></svg><span>Answers</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://learning.oreilly.com/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Ruby on Rails Tutorial, 6th Edition
      
    </h1></span></a><div class="toc-contents" style="max-height: 0px;">
  <div class="sbo-toc">
    <button type="button" class="sbo-toc-thumb close"><div class="visuallyhidden">Close</div></button>
      <section class="ios-app-teaser">
        <ul>
            <li><a class="js-toc-link toc-link" href="https://itunes.apple.com/gb/app/safari-queue-library-over/id881697395?mt=8" role="button">Install App</a></li>
            <li><a class="js-toc-link toc-link" href="safaridetail://9780136702726" role="button">Open in App</a></li>
        </ul>
      </section>
      <div class="sbo-book-meta">
        
        <span class="cover">
         <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">
          <img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource" alt="Cover image for Ruby on Rails Tutorial, 6th Edition" height="184" width="141">
        </a>
        </span>
        <span class="title">
          
            
                <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
                  <img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/addison-wesley.png" class="publisher-logo video" alt="publisher logo">
                </a>
            
          

          <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">Ruby on Rails Tutorial, 6th Edition</a>
        </span>
        
        <span class="authors">by Michael Hartl</span>
        

        
        <span class="publishers t-publishers">Published by
          <!-- Show publisher page link if publisher pages switch is on -->
          
            <a class="t-publisher-link toc-link js-toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
              Addison-Wesley Professional</a>, 2020
          
        </span>
        

    

    </div>
  <ol class="tocList">
    
    
    
     

     <li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/cover.xhtml">
        Cover Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref00.xhtml">
        About This eBook <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/halftitle.xhtml">
        Halftitle Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/title.xhtml">
        Title Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/copy.xhtml">
        Copyright Page <span class="minutes">(02:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/toc.xhtml#toc">
        Contents <span class="minutes">(05:45 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref02.xhtml#pref02">
        Foreword <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref03.xhtml#pref03">
        Acknowledgments <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref04.xhtml#pref04">
        About the Author <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#ch01">
        Chapter 1. From Zero to Deploy <span class="minutes">(77:03 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">
        Chapter 2. A Toy App <span class="minutes">(50:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03">
        Chapter 3. Mostly Static Pages <span class="minutes">(63:15 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04">
        Chapter 4. Rails-Flavored Ruby <span class="minutes">(57:30 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">
        Chapter 5. Filling in the Layout <span class="minutes">(60:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">
        Chapter 6. Modeling Users <span class="minutes">(67:51 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">
        Chapter 7. Sign Up <span class="minutes">(79:21 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">
        Chapter 8. Basic Login <span class="minutes">(66:42 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">
        Chapter 9. Advanced Login <span class="minutes">(52:54 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1 currently-reading">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">
        Chapter 10. Updating, Showing, and Deleting Users <span class="minutes">(73:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">
        Chapter 11. Account Activation <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">
        Chapter 12. Password Reset <span class="minutes">(48:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">
        Chapter 13. User Microposts <span class="minutes">(106:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">
        Chapter 14. Following Users <span class="minutes">(78:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml#index">
        Index <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/credits.xhtml#credits">
        Credits <span class="minutes">(19:33 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01_images.xhtml#ch01_images">
        Code Snippets <span class="minutes">(09:12 mins)</span>
       </a>
      
        
      
   </li></ol>
 </div>



</div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780136702726/chapter/ch10.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li class="currently-reading"><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml&amp;text=Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition&amp;via=OReillyMedia"><span>Twitter</span></a></li><li class="currently-reading"><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Facebook</span></a></li><li class="currently-reading"><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Google Plus</span></a></li><li class="currently-reading"><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Chapter%2010.%20Updating%2C%20Showing%2C%20and%20Deleting%20Users&amp;body=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml%0D%0Afrom%20Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document"><script src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/48743.js.download"></script>
<script>
  var userId = "66943332-5511-462c-876e-5d5b720c7edf";

  var userObject = {
    firstName: "Trn",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2020-12-01",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 5. Filling in the Layout</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 7. Sign Up</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section epub:type="chapter">
<h2 class="h2" id="ch06"><span epub:type="pagebreak" id="page_255"></span>Chapter 6</h2>
<h2 class="h2a">Modeling Users</h2>
<p class="noindent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">Chapter 5</a>, we ended with a stub page for creating new users (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#sec5_4">Section 5.4</a>). Over the course of the next six chapters, well fulfill the promise implicit in this incipient signup page. In this chapter, well take the first critical step by creating a <em>data model</em> for users of our site, together with a way to store that data. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>, well give users the ability to sign up for our site and create a user profile page. Once users can sign up, well let them log in and log out as well (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">Chapter 9</a>), and in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">Chapter 10</a> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_2_1">Section 10.2.1</a>) well learn how to protect pages from improper access. Finally, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">Chapter 11</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a> well add account activations (thereby confirming a valid email address) and password resets. Taken together, the material in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">Chapter 6</a> through <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a> develops a full Rails login and authentication system. As you may know, various pre-built authentication solutions are available for Rails; <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#box6_1">Box 6.1</a> explains why, at least at first, its probably a better idea to roll your own.</p>
<div class="box">
<p class="box-caption" id="box6_1">Box 6.1: Rolling Your Own Authentication System</p>
<p class="boxnp">Virtually all web applications require a login and authentication system of some sort. As a result, most web frameworks end up with one or more standardized libraries for doing so, and Rails is no exception. In particular, the Devise gem has emerged as a robust solution for a wide variety of uses, and represents a strong choice for professional-grade applications.</p>
<p class="boxip">Nevertheless, I believe it is a mistake to use a pre-built system like Devise in a tutorial like this one. Off-the-shelf systems can be black boxes with potentially mysterious innards, and the complicated data models used by such systems would <span epub:type="pagebreak" id="page_256"></span>be utterly overwhelming for beginners (or even for experienced developers not familiar with data modeling). For learning purposes, its essential to introduce the subject more gradually.</p>
<p class="boxip">Happily, Rails makes it possible to take such a gradual approach while still developing an industrial-strength login and authentication system suitable for production applications. This way, even if you <em>do</em> end up using a third-party system later on, youll be in a much better position to understand and modify it to meet your particular needs.</p>
</div>
<section>
<h3 class="h3" id="sec6_1">6.1 User Model</h3>
<p class="noindent">Although the ultimate goal of the next three chapters is to make a signup page for our site (as mocked up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig01">Figure 6.1</a>), it would do little good now to accept information <span epub:type="pagebreak" id="page_257"></span>for new users: We dont currently have any place to put it. Thus, the first step in signing up users is to make a data structure to capture and store their information.</p>
<figure id="ch06fig01" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_01.jpg" alt="Image" width="714" height="593" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_01.jpg">
<figcaption><p><strong>Figure 6.1:</strong> A mockup of the user signup page.</p></figcaption>
</figure>
<p class="indent">In Rails, the default data structure for a data model is called, naturally enough, a <em>model</em> (the M in MVC from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#sec1_2_3">Section 1.2.3</a>). The default Rails solution to the problem of persistence is to use a <em>database</em> for long-term data storage, and the default library for interacting with the database is called <em>Active Record</em>.<sup><a id="ch06fn1a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn1" class="totri-footnote">1</a></sup> Active Record comes with a host of methods for creating, saving, and finding data objects, all without having to use the structured query language (SQL)<sup><a id="ch06fn2a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn2" class="totri-footnote">2</a></sup> used by relational databases. Moreover, Rails has a feature called <em>migrations</em> to allow data definitions to be written in pure Ruby, without having to learn an SQL data definition language (DDL). The effect is that Rails insulates you almost entirely from the details of the database. In this book, by using SQLite for development and PostgreSQL (via Heroku) for deployment (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#sec1_4">Section 1.4</a>), we have developed this theme even further, to the point where we barely ever have to think about how Rails stores data, even for production applications.</p>
<p class="footnote"><a id="ch06fn1" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn1a" class="totri-footnote">1</a>. The name comes from the active record pattern, identified and named in <em>Patterns of Enterprise Application Architecture</em> by Martin Fowler.</p>
<p class="footnote"><a id="ch06fn2" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn2a" class="totri-footnote">2</a>. Officially pronounced ess-cue-ell, though the alternate pronunciation sequel is also common. You can differentiate an individual authors preference by the choice of indefinite article: Those who write a SQL database prefer sequel, whereas those who write an SQL database prefer ess-cue-ell. As youll soon see, I prefer the latter.</p>
<p class="indent">As usual, if youre following along using Git for version control, now would be a good time to make a topic branch for modeling users:</p>
<pre class="pre1"><strong><span class="navy">$</span></strong> git checkout -b modeling-users</pre>
<section>
<h4 class="h4" id="sec6_1_1">6.1.1 Database Migrations</h4>
<p class="noindent">You may recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_5">Section 4.4.5</a> that we have already encountered, via a custom-built <strong><span class="dark-green"><code>User</code></span></strong> class, user objects with <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong> attributes. That class served as a useful example, but it lacked the critical property of <em>persistence</em>: When we created a User object at the Rails console, it disappeared as soon as we exited. Our goal in this section is to create a model for users that wont disappear quite so easily.</p>
<p class="indent">As with the User class in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_5">Section 4.4.5</a>, well start by modeling a user with two attributes, a <strong><span class="dark-green"><code>name</code></span></strong> and an <strong><span class="dark-green"><code>email</code></span></strong> address, the latter of which well use as a unique <span epub:type="pagebreak" id="page_258"></span>username.<sup><a id="ch06fn3a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn3" class="totri-footnote">3</a></sup> (Well add an attribute for passwords in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3">Section 6.3</a>.) In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04ex017">Listing 4.17</a>, we did this with Rubys <strong><span class="dark-green"><code>attr_accessor</code></span></strong> method:</p>
<p class="footnote"><a id="ch06fn3" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn3a" class="totri-footnote">3</a>. By using an email address as the username, we open the possibility of communicating with our users at a future date (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">Chapter 11</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>).</p>
<p class="codelink"><a id="pf0258-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0258-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong>
  <strong><span class="green">attr_accessor</span></strong> <span class="violet">:name</span>, <span class="violet">:email</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<strong><span class="green">end</span></strong></pre>
<p class="indent">In contrast, when using Rails to model users, we dont need to identify the attributes explicitly. As noted briefly earlier, to store data Rails uses a relational database by default, which consists of <em>tables</em> composed of data <em>rows</em>, where each row has <em>columns</em> of data attributes. For example, to store users with names and email addresses, well create a <strong><span class="dark-green"><code>users</code></span></strong> table with <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong> columns (with each row corresponding to one user). An example of such a table appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig02">Figure 6.2</a>, corresponding to the data model shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig03">Figure 6.3</a>. (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig03">Figure 6.3</a> is just a sketch; the full data model appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig04">Figure 6.4</a>.) By naming the columns <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong>, we can let Active Record figure out the User object attributes for us.</p>
<figure id="ch06fig02" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_02.jpg" alt="Image" width="876" height="260" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_02.jpg">
<figcaption><p><strong>Figure 6.2:</strong> A diagram of sample data in a <strong><span class="dark-green"><code>users</code></span></strong> table.</p></figcaption>
</figure>
<figure id="ch06fig03" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_03.jpg" alt="Image" width="339" height="182" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_03.jpg">
<figcaption><p><strong>Figure 6.3:</strong> A sketch of the User data model.</p></figcaption>
</figure>
<p class="indent">You may recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05ex038">Listing 5.38</a> that we created a Users controller (along with a <strong><span class="dark-green"><code>new</code></span></strong> action) using the command</p>
<p class="codelink"><a id="pf0258-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0258-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">$</span></strong> rails generate controller Users new</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_259"></span>The analogous command for making a model is <strong><span class="dark-green"><code>generate model</code></span></strong>, which we can use to generate a User model with <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong> attributes, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a>.</p>
<p class="ex-title" id="ch06ex01"><strong>Listing 6.1:</strong> Generating a User model.</p>
<p class="codelink"><a id="pf0259-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0259-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="navy">$</span></strong> rails generate model User name:string email:string
     <span class="green">invoke  active_record</span>
     <span class="green">create    db/migrate/&lt;timestamp&gt;_create_users.rb</span>
     <span class="green">create    app/models/user.rb</span>
     <span class="green">invoke    test_unit</span>
     <span class="green">create      test/models/user_test.rb</span>
     <span class="green">create      test/fixtures/users.yml</span></pre>
</div>
<p class="noindent">(Note that, in contrast to the plural convention for controller names, model names are singular: a <em>Users</em> controller, but a <em>User</em> model.) By passing the optional parameters <strong><span class="dark-green"><code>name:string</code></span></strong> and <strong><span class="dark-green"><code>email:string</code></span></strong>, we tell Rails about the two attributes we want, along with which types those attributes should be (in this case, <strong><span class="dark-green"><code>string</code></span></strong>). Compare this with how we included the action names in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03ex06">Listing 3.6</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05ex038">Listing 5.38</a>.</p>
<p class="indent">One of the results of the <strong><span class="dark-green"><code>generate</code></span></strong> command in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a> is a new file called a <em>migration</em>. Migrations provide a way to alter the structure of the database incrementally, so that our data model can adapt to changing requirements. In the case of the User model, the migration is created automatically by the model generation script; it creates a <strong><span class="dark-green"><code>users</code></span></strong> table with two columns, <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>. (Well see starting in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_5">Section 6.2.5</a> how to make a migration from scratch.)<span epub:type="pagebreak" id="page_260"></span></p>
<p class="ex-title" id="ch06ex02"><strong>Listing 6.2:</strong> Migration for the User model (to create a <strong><span class="dark-green"><code>users</code></span></strong> table).</p>
<pre class="pre2"><code>db/migrate/[timestamp]_create_users.rb</code></pre>
<p class="codelink"><a id="pf0260-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0260-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">CreateUsers</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveRecord</span><span class="ash">::</span><span class="red">Migration</span><span class="ash">[6.0]</span>
  <strong><span class="green">def</span></strong> <span class="blue3">change</span>
    create_table <span class="violet">:users</span> <strong><span class="green">do</span></strong> <span class="ash">|</span>t<span class="ash">|</span>
      t<span class="ash">.</span>string <span class="violet">:name</span>
      t<span class="ash">.</span>string <span class="violet">:email</span>

      t<span class="ash">.</span>timestamps
    <strong><span class="green">end</span></strong>
   <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">Note that the name of the migration file is prefixed by a <em>timestamp</em> based on when the migration was generated. In the early days of migrations, the filenames were prefixed with incrementing integers, which caused conflicts for collaborating teams if multiple programmers had migrations with the same number. Barring the improbable scenario of migrations generated the same second, using timestamps conveniently avoids such collisions.</p>
<p class="indent">The migration itself consists of a <strong><span class="dark-green"><code>change</code></span></strong> method that determines the change to be made to the database. In the case of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>, <strong><span class="dark-green"><code>change</code></span></strong> uses a Rails method called <strong><span class="dark-green"><code>create_table</code></span></strong> to create a table in the database for storing users. The <strong><span class="dark-green"><code>create_table</code></span></strong> method accepts a block (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_2">Section 4.3.2</a>) with one block variable, in this case called <strong><span class="dark-green"><code>t</code></span></strong> (for table). Inside the block, the <strong><span class="dark-green"><code>create_table</code></span></strong> method uses the <strong><span class="dark-green"><code>t</code></span></strong> object to create <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong> columns in the database, both of type <strong><span class="dark-green"><code>string</code></span></strong>.<sup><a id="ch06fn4a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn4" class="totri-footnote">4</a></sup> Here the table name is plural (<strong><span class="dark-green"><code>users</code></span></strong>) even though the model name is singular (User), which reflects a linguistic convention followed by Rails: A model represents a single user, whereas a database table consists of many users. The final line in the block, <strong><span class="dark-green"><code>t.timestamps</code></span></strong>, is a special command that creates two <em>magic columns</em> called <strong><span class="dark-green"><code>created_at</code></span></strong> and <strong><span class="dark-green"><code>updated_at</code></span></strong>, which are timestamps that automatically record when a given user is created and updated. (Well see concrete examples of the magic columns starting in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_3">Section 6.1.3</a>.) The full data model represented by the migration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a> is shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig04">Figure 6.4</a>. (Note the addition of the magic columns, which werent present in the sketch shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig03">Figure 6.3</a>.)</p>
<p class="footnote"><a id="ch06fn4" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn4a" class="totri-footnote">4</a>. Dont worry about exactly how the <strong><span class="dark-green"><code>t</code></span></strong> object manages to do this; the beauty of <em>abstraction layers</em> is that we dont have to know. We can just trust the <strong><span class="dark-green"><code>t</code></span></strong> object to do its job.<span epub:type="pagebreak" id="page_261"></span></p>
<figure id="ch06fig04" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_04.jpg" alt="Image" width="461" height="270" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_04.jpg">
<figcaption><p><strong>Figure 6.4:</strong> The User data model produced by <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>.</p></figcaption>
</figure>
<p class="indent">We can run the migration, known as migrating up, using the <strong><span class="dark-green"><code>db:migrate</code></span></strong> command as follows:</p>
<pre class="pre1">$ rails db:migrate</pre>
<p class="noindent">(You may recall that we ran this command in a similar context in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#sec2_2">Section 2.2</a>.) The first time <strong><span class="dark-green"><code>db:migrate</code></span></strong> is run, it creates a file called <strong><span class="dark-green"><code>db/development.sqlite3</code></span></strong>, which is an SQLite<sup><a id="ch06fn5a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn5" class="totri-footnote">5</a></sup> database. We can see the structure of the database by opening <strong><span class="dark-green"><code>development.sqlite3</code></span></strong> with DB Browser for SQLite. (If youre using the cloud IDE, you should first download the database file to the local disk, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig05">Figure 6.5</a>.) The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig06">Figure 6.6</a>; compare it with the diagram in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig04">Figure 6.4</a>. You might note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig06">Figure 6.6</a> includes one column not accounted for in the migration: the <strong><span class="dark-green"><code>id</code></span></strong> column. As noted briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#sec2_2">Section 2.2</a>, this column is created automatically, and is used by Rails to identify each row uniquely.</p>
<p class="footnote"><a id="ch06fn5" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn5a" class="totri-footnote">5</a>. Officially pronounced ess-cue-ell-ite, although the (mis)pronunciation sequel-ite is also common.</p>
<figure id="ch06fig05" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_05.jpg" alt="Image" width="677" height="519" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_05.jpg">
<figcaption><p><strong>Figure 6.5:</strong> Downloading a file from the cloud IDE.</p></figcaption>
</figure>
<figure id="ch06fig06" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_06.jpg" alt="Image" width="677" height="425" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_06.jpg">
<figcaption><p><strong>Figure 6.6:</strong> DB Browser with our new <strong><span class="dark-green"><code>users</code></span></strong> table.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev56">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_262"></span><span epub:type="pagebreak" id="page_263"></span></p>
<ol class="num">
<li><p class="num">Rails uses a file called <strong><span class="dark-green"><code>schema.rb</code></span></strong> in the <strong><span class="dark-green"><code>db/</code></span></strong> directory to keep track of the structure of the database (called the <em>schema</em>, hence the filename). Examine your local copy of <strong><span class="dark-green"><code>db/schema.rb</code></span></strong> and compare its contents to the migration code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>.</p></li>
<li><p class="num">Most migrations (including all the ones in this tutorial) are <em>reversible</em>, which means we can migrate down and undo them with a single command, called <strong><span class="dark-green"><code>db:rollback</code></span></strong>:</p>
<pre class="pre3">$ rails db:rollback</pre>
<p class="num-p">After running this command, examine <strong><span class="dark-green"><code>db/schema.rb</code></span></strong> to confirm that the rollback was successful. (See <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#box3_1">Box 3.1</a> for another technique useful for reversing migrations.) Under the hood, this command executes the <strong><span class="dark-green"><code>drop_table</code></span></strong> command to remove the users table from the database. The reason this works is that the <strong><span class="dark-green"><code>change</code></span></strong> method knows that <strong><span class="dark-green"><code>drop_table</code></span></strong> is the inverse of <strong><span class="dark-green"><code>create_table</code></span></strong>, which means that the rollback migration can be easily inferred. In the case of an irreversible migration, such as one to remove a database column, it is necessary to define separate <strong><span class="dark-green"><code>up</code></span></strong> and <strong><span class="dark-green"><code>down</code></span></strong> methods in place of the single <strong><span class="dark-green"><code>change</code></span></strong> method. Read about migrations in the Rails Guides (<a href="http://guides.rubyonrails.org/migrations.html">guides.rubyonrails.org/migrations.html</a>) for more information.</p></li>
<li><p class="num">Rerun the migration by executing <strong><span class="dark-green"><code>rails db:migrate</code></span></strong> again. Confirm that the contents of <strong><span class="dark-green"><code>db/schema.rb</code></span></strong> have been restored.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec6_1_2">6.1.2 The Model File</h4>
<p class="noindent">Weve seen how the User model generation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a> generated a migration file (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>), and we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig06">Figure 6.6</a> the results of running this migration: It updated a file called <strong><span class="dark-green"><code>development.sqlite3</code></span></strong> by creating a table <strong><span class="dark-green"><code>users</code></span></strong> with columns <strong><span class="dark-green"><code>id</code></span></strong>, <strong><span class="dark-green"><code>name</code></span></strong>, <strong><span class="dark-green"><code>email</code></span></strong>, <strong><span class="dark-green"><code>created_at</code></span></strong>, and <strong><span class="dark-green"><code>updated_at</code></span></strong>. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a> also created the model itself. The rest of this section is dedicated to understanding it.</p>
<p class="indent">We begin by looking at the code for the User model, which lives in the file <strong><span class="dark-green"><code>user.rb</code></span></strong> inside the <strong><span class="dark-green"><code>app/models/</code></span></strong> directory. It is, to put it mildly, very compact (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex03">Listing 6.3</a>).<span epub:type="pagebreak" id="page_264"></span></p>
<p class="ex-title" id="ch06ex03"><strong>Listing 6.3:</strong> The brand-new User model.</p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0264-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0264-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_2">Section 4.4.2</a> that the syntax <strong><span class="dark-green"><code>class User <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span></code></span></strong> means that the <strong><span class="dark-green"><code>User</code></span></strong> class <em>inherits</em> from the <strong><span class="dark-green"><code>ApplicationRecord</code></span></strong> class, which in turn inherits from <strong><span class="dark-green"><code>ActiveRecord::Base</code></span></strong> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02fig019">Figure 2.19</a>), so that the User model automatically has all the functionality of the <strong><span class="dark-green"><code>ActiveRecord::Base</code></span></strong> class. Of course, this knowledge doesnt do us any good unless we know what <strong><span class="dark-green"><code>ActiveRecord::Base</code></span></strong> contains, so lets get started with some concrete examples.</p>
<section>
<h5 class="h5" id="lev57">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">In a Rails console, use the technique from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_4">Section 4.4.4</a> to confirm that <strong><span class="dark-green"><code>User.new</code></span></strong> is of class <strong><span class="dark-green"><code>User</code></span></strong> and inherits from <strong><span class="dark-green"><code>ApplicationRecord</code></span></strong>.</p></li>
<li><p class="num">Confirm that <strong><span class="dark-green"><code>ApplicationRecord</code></span></strong> inherits from <strong><span class="dark-green"><code>ActiveRecord::Base</code></span></strong>.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec6_1_3">6.1.3 Creating User Objects</h4>
<p class="noindent">As in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04">Chapter 4</a>, our tool of choice for exploring data models is the Rails console. Since we dont (yet) want to make any changes to our database, well start the console in a <em>sandbox</em>:</p>
<p class="codelink"><a id="pf0264-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0264-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">$</span></strong> rails console --sandbox
<span class="green">Loading development environment in sandbox</span>
<span class="green">Any modifications you make will be rolled back on exit</span>
<strong><span class="navy">&gt;&gt;</span></strong></pre>
<p class="noindent">As indicated by the helpful message Any modifications you make will be rolled back on exit, when started in a sandbox the console will roll back (i.e., undo) any database changes introduced during the session.<span epub:type="pagebreak" id="page_265"></span></p>
<p class="indent"><span epub:type="pagebreak" id="page_266"></span>In the console session in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_5">Section 4.4.5</a>, we created a new user object with <strong><span class="dark-green"><code>User.new</code></span></strong>, which we had access to only after requiring the example user file in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04ex017">Listing 4.17</a>. With models, the situation is different: As you may recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_4">Section 4.4.4</a>, the Rails console automatically loads the Rails environment, which includes the models. This means that we can make a new user object without any further work:</p>
<p class="codelink"><a id="pf0265-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0265-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>new
<span class="green">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span></pre>
<p class="noindent">We see here the default console representation of a user object.</p>
<p class="indent">When called with no arguments, <strong><span class="dark-green"><code>User.new</code></span></strong> returns an object with all <strong><span class="dark-green"><code>nil</code></span></strong> attributes. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_5">Section 4.4.5</a>, we designed the example User class to take an <em>initialization hash</em> to set the object attributes; that design choice was motivated by Active Record, which allows objects to be initialized in the same way:</p>
<p class="codelink"><a id="pf0265-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0265-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Michael Hartl"</span>, <span class="violet">email</span>: <span class="maroon">"michael@example.com"</span>)
<span class="green">=&gt; #&lt;User id: nil, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: nil, updated_at: nil&gt;</span></pre>
<p class="noindent">Here we see that the name and email attributes have been set as expected.</p>
<p class="indent">The notion of <em>validity</em> is important for understanding Active Record model objects. Well explore this subject in more depth in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2">Section 6.2</a>, but for now its worth noting that our initial <strong><span class="dark-green"><code>user</code></span></strong> object is valid, which we can verify by calling the boolean <strong><span class="dark-green"><code>valid?</code></span></strong> method on it:</p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>valid?
<span class="green">true</span></pre>
<p class="indent">So far, we havent touched the database: <strong><span class="dark-green"><code>User.new</code></span></strong> only creates an object <em>in memory</em>, while <strong><span class="dark-green"><code>user.valid?</code></span></strong> merely checks to see if the object is valid. To save the User object to the database, we need to call the <strong><span class="dark-green"><code>save</code></span></strong> method on the <strong><span class="dark-green"><code>user</code></span></strong> variable:</p>
<p class="codelink"><a id="pf0265-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0265-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>save
  <span class="green">(0.1ms) SAVEPOINT active_record_1</span>
 <span class="green">SQL (0.8ms) INSERT INTO "users" ("name", "email", "created_at",</span>
 <span class="green">"updated_at") VALUES (?, ?, ?, ?) [["name", "Michael Hartl"],</span>
 <span class="green">["email", "michael@example.com"], ["created_at", "2019-08-22 01:51:03.453035"],</span>
 <span class="green">["updated_at", "2019-08-22 01:51:03.453035"]]</span>
  <span class="green">(0.1ms) RELEASE SAVEPOINT active_record_1</span>
<span class="green">=&gt; true</span></pre>
<p class="noindent">The <strong><span class="dark-green"><code>save</code></span></strong> method returns <strong><span class="dark-green"><code>true</code></span></strong> if it succeeds and <strong><span class="dark-green"><code>false</code></span></strong> otherwise. (Currently, all saves should succeed because there are as yet no validations; well see cases in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2">Section 6.2</a> when some will fail.) For reference, the Rails console also shows the SQL command corresponding to <strong><span class="dark-green"><code>user.save</code></span></strong> (namely, <strong><span class="dark-green"><code>INSERT INTO "users"</code></span></strong>...). Well hardly ever need raw SQL in this book,<sup><a id="ch06fn6a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn6" class="totri-footnote">6</a></sup> and Ill omit discussion of the SQL commands from now on, but you can learn a lot by reading the SQL corresponding to Active Record commands.</p>
<p class="footnote"><a id="ch06fn6" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn6a" class="totri-footnote">6</a>. The only exception is in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_3_3">Section 14.3.3</a>.</p>
<p class="indent">You may have noticed that the new user object had <strong><span class="dark-green"><code>nil</code></span></strong> values for the <strong><span class="dark-green"><code>id</code></span></strong> and the magic columns <strong><span class="dark-green"><code>created_at</code></span></strong> and <strong><span class="dark-green"><code>updated_at</code></span></strong> attributes. Lets see if our <strong><span class="dark-green"><code>save</code></span></strong> changed anything:</p>
<p class="codelink"><a id="pf0266-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0266-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 01:51:03", updated_at: "2019-08-22 01:51:03"&gt;</span></pre>
<p class="noindent">We see that the <strong><span class="dark-green"><code>id</code></span></strong> has been assigned a value of <strong><span class="dark-green"><code>1</code></span></strong>, while the magic columns have been assigned the current time and date.<sup><a id="ch06fn7a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn7" class="totri-footnote">7</a></sup> Currently, the created and updated timestamps are identical; well see them differ in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_5">Section 6.1.5</a>.</p>
<p class="footnote"><a id="ch06fn7" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn7a" class="totri-footnote">7</a>. The timestamps are recorded in Coordinated Universal Time (UTC), which for most practical purposes is the same as Greenwich Mean Time. But why call it UTC? From the NIST Time and Frequency FAQ: <strong>Q:</strong> Why is UTC used as the acronym for Coordinated Universal Time instead of CUT? <strong>A:</strong> In 1970 the Coordinated Universal Time system was devised by an international advisory group of technical experts within the International Telecommunication Union (ITU). The ITU felt it was best to designate a single abbreviation for use in all languages in order to minimize confusion. Since unanimous agreement could not be achieved on using either the English word order, CUT, or the French word order, TUC, the acronym UTC was chosen as a compromise.</p>
<p class="indent">As with the User class in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_5">Section 4.4.5</a>, instances of the User model allow access to their attributes using a dot notation:</p>
<p class="codelink"><a id="pf0266-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0266-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>name
<span class="green">=&gt; "Michael Hartl"</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>email
<span class="green">=&gt; "michael@example.com"</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>updated_at
<span class="green">=&gt; Thu, 22 Aug 2019 01:51:03 UTC +00:00</span></pre>
<p class="indent">As well see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>, its often convenient to make and save a model in two steps as we have done here, but Active Record also lets you combine them into one step with <strong><span class="dark-green"><code>User.create</code></span></strong>:</p>
<p class="codelink"><a id="pf0267-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0267-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>create(<span class="green1">name</span>: <span class="maroon">"A Nother"</span>, <span class="violet">email</span>: <span class="maroon">"another@example.org"</span>)
<span class="green">#&lt;User id: 2, name: "A Nother", email: "another@example.org", created_at:</span>
<span class="green">"2019-08-22 01:53:22", updated_at: "2019-08-22 01:53:22"&gt;</span>
<strong><span class="navy">&gt;&gt;</span></strong> foo <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>create(<span class="green1">name</span>: <span class="maroon">"Foo"</span>, <span class="violet">email</span>: <span class="maroon">"foo@bar.com"</span>)
<span class="green">#&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2019-08-22</span>
<span class="green">01:54:03", updated_at: "2019-08-22 01:54:03"&gt;</span></pre>
<p class="noindent">Note that <strong><span class="dark-green"><code>User.create</code></span></strong>, rather than returning <strong><span class="dark-green"><code>true</code></span></strong> or <strong><span class="dark-green"><code>false</code></span></strong>, returns the User object itself, which we can optionally assign to a variable (such as <strong><span class="dark-green"><code>foo</code></span></strong> in the second command above).</p>
<p class="indent">The inverse of <strong><span class="dark-green"><code>create</code></span></strong> is <strong><span class="dark-green"><code>destroy</code></span></strong>:</p>
<p class="codelink"><a id="pf0267-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0267-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> foo<span class="ash">.</span>destroy
   <span class="green">(0.1ms) SAVEPOINT active_record_1</span>
  <span class="green">SQL (0.2ms) DELETE FROM "users" WHERE "users"."id" = ? [["id", 3]]</span>
   <span class="green">(0.1ms) RELEASE SAVEPOINT active_record_1</span>
<span class="green">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2019-08-22</span>
<span class="green">01:54:03", updated_at: "2019-08-22 01:54:03"&gt;</span></pre>
<p class="noindent">Like <strong><span class="dark-green"><code>create</code></span></strong>, <strong><span class="dark-green"><code>destroy</code></span></strong> returns the object in question, though I cant recall ever having used the return value of <strong><span class="dark-green"><code>destroy</code></span></strong>. In addition, the destroyed object still exists in memory:</p>
<p class="codelink"><a id="pf0267-04" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0267-04a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> foo
<span class="green">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2019-08-22</span>
<span class="green">01:54:03", updated_at: "2019-08-22 01:54:03"&gt;</span></pre>
<p class="noindent">So how do we know if we really destroyed an object? And for saved and non-destroyed objects, how can we retrieve users from the database? To answer these questions, we need to learn how to use Active Record to find user objects.<span epub:type="pagebreak" id="page_267"></span></p>
<section>
<h5 class="h5" id="lev58">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_268"></span></p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Confirm that <strong><span class="dark-green"><code>user.name</code></span></strong> and <strong><span class="dark-green"><code>user.email</code></span></strong> are of class <strong><span class="dark-green"><code>String</code></span></strong>.</p></li>
<li><p class="num">Of what class are the <strong><span class="dark-green"><code>created_at</code></span></strong> and <strong><span class="dark-green"><code>updated_at</code></span></strong> attributes?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec6_1_4">6.1.4 Finding User Objects</h4>
<p class="noindent">Active Record provides several options for finding objects. Lets use them to find the first user we created while verifying that the third user (<strong><span class="dark-green"><code>foo</code></span></strong>) has been destroyed. Well start with the existing user:</p>
<p class="codelink"><a id="pf0268-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0268-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>find(<span class="ash">1</span>)
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 01:51:03", updated_at: "2019-08-22 01:51:03"&gt;</span></pre>
<p class="noindent">Here weve passed the id of the user to <strong><span class="dark-green"><code>User.find</code></span></strong>; Active Record returns the user with that id.</p>
<p class="noindent">Lets see if the user with an <strong><span class="dark-green"><code>id</code></span></strong> of <strong><span class="dark-green"><code>3</code></span></strong> still exists in the database:</p>
<p class="codelink"><a id="pf0268-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0268-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>find(<span class="ash">3</span>)
<span class="green">ActiveRecord::RecordNotFound: Couldn't find User with ID=3</span></pre>
<p class="noindent">Since we destroyed our third user in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_3">Section 6.1.3</a>, Active Record cant find it in the database. Instead, <strong><span class="dark-green"><code>find</code></span></strong> raises an <em>exception</em>, which is a way of indicating an exceptional event in the execution of a programin this case, a nonexistent Active Record id, leading <strong><span class="dark-green"><code>find</code></span></strong> to raise an <strong><span class="dark-green"><code>ActiveRecord::RecordNotFound</code></span></strong> exception.<sup><a id="ch06fn8a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn8" class="totri-footnote">8</a></sup></p>
<p class="footnote"><a id="ch06fn8" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn8a" class="totri-footnote">8</a>. Exceptions and exception handling are somewhat advanced Ruby subjects, and we wont need them much in this book. They are important, though, and I suggest learning about them using one of the Ruby books recommended in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_4_1">Section 14.4.1</a>.</p>
<p class="indent">In addition to the generic <strong><span class="dark-green"><code>find</code></span></strong>, Active Record enables us to find users by specific attributes:</p>
<p class="codelink"><a id="pf0268-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0268-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>find_by(<span class="violet">email</span>: <span class="maroon">"michael@example.com"</span>)
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 01:51:03", updated_at: "2019-08-22 01:51:03"&gt;</span></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_269"></span>Since we will be using email addresses as usernames, this sort of <strong><span class="dark-green"><code>find</code></span></strong> will be useful when we learn how to let users log in to our site (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>). If youre worried that <strong><span class="dark-green"><code>find_by</code></span></strong> will be inefficient if there are a large number of users, youre ahead of the game; well cover this issue, and its solution via database indices, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_5">Section 6.2.5</a>.</p>
<p class="indent">Well end with a couple of more general ways of finding users. First, theres <strong><span class="dark-green"><code>first</code></span></strong>:</p>
<p class="codelink"><a id="pf0269-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0269-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>first
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 01:51:03", updated_at: "2019-08-22 01:51:03"&gt;</span></pre>
<p class="noindent">Naturally, <strong><span class="dark-green"><code>first</code></span></strong> just returns the first user in the database. Theres also <strong><span class="dark-green"><code>all</code></span></strong>:</p>
<p class="codelink"><a id="pf0269-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0269-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>all
<span class="green">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1, name: "Michael Hartl", email:</span>
<span class="green">"michael@example.com", created_at: "2019-08-22 01:51:03", updated_at:</span>
<span class="green">"2019-08-22 01:51:03"&gt;, #&lt;User id: 2, name: "A Nother", email:</span>
<span class="green">"another@example.org", created_at: "2019-08-22 01:53:22", updated_at:</span>
<span class="green">"2019-08-22 01:53:22"&gt;]&gt;</span></pre>
<p class="noindent">As you can see from the console output, <strong><span class="dark-green"><code>User.all</code></span></strong> returns all the users in the database as an object of class <strong><span class="dark-green"><code>ActiveRecord::Relation</code></span></strong>, which is effectively an array (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_1">Section 4.3.1</a>).</p>
<section>
<h5 class="h5" id="lev59">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Find the user by <strong><span class="dark-green"><code>name</code></span></strong>. Confirm that <strong><span class="dark-green"><code>find_by_name</code></span></strong> works as well. (You will often encounter this older style of <strong><span class="dark-green"><code>find_by</code></span></strong> in legacy Rails applications.)</p></li>
<li><p class="num">For most practical purposes, <strong><span class="dark-green"><code>User.all</code></span></strong> acts like an array, but confirm that in fact its of class <strong><span class="dark-green"><code>User::ActiveRecord_Relation</code></span></strong>.</p></li>
<li><p class="num">Confirm that you can find the length of <strong><span class="dark-green"><code>User.all</code></span></strong> by passing it the <strong><span class="dark-green"><code>length</code></span></strong> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_2_2">Section 4.2.2</a>). Rubys ability to manipulate objects based on how they act rather than on their formal class type is called <em>duck typing</em>, based on the aphorism that If it looks like a duck, and it quacks like a duck, its probably a duck.<span epub:type="pagebreak" id="page_270"></span></p></li>
</ol>
</section>
</section>
<section>
<h4 class="h4" id="sec6_1_5">6.1.5 Updating User Objects</h4>
<p class="noindent">Once weve created objects, we often want to update them. There are two basic ways to do this. First, we can assign attributes individually, as we did in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_5">Section 4.4.5</a>:</p>
<p class="codelink"><a id="pf0270-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0270-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user          <span class="blue"># Just a reminder about our user's attributes</span>
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 01:51:03", updated_at: "2019-08-22 01:51:03"&gt;</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>email <span class="ash">=</span> <span class="maroon">"mhartl@example.net"</span>
<span class="green">=&gt; "mhartl@example.net"</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>save
<span class="green">=&gt; true</span></pre>
<p class="noindent">Note that the final step is necessary to write the changes to the database. We can see what happens without a save by using <strong><span class="dark-green"><code>reload</code></span></strong>, which reloads the object based on the database information:</p>
<p class="codelink"><a id="pf0270-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0270-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>email
<span class="green">=&gt; "mhartl@example.net"</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>email <span class="ash">=</span> <span class="maroon">"foo@bar.com"</span>
<span class="green">=&gt; "foo@bar.com"</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>reload<span class="ash">.</span>email
<span class="green">=&gt; "mhartl@example.net"</span></pre>
<p class="indent">Now that weve updated the user by running <strong><span class="dark-green"><code>user.save</code></span></strong>, the magic columns differ, as promised in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_3">Section 6.1.3</a>:</p>
<p class="codelink"><a id="pf0270-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0270-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>created_at
<span class="green">=&gt; Thu, 22 Aug 2019 01:51:03 UTC +00:00</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>updated_at
<span class="green">=&gt; Thu, 22 Aug 2019 01:58:08 UTC +00:00</span></pre>
<p class="indent">The second main way to update multiple attributes is to use <strong><span class="dark-green"><code>update</code></span></strong>:<sup><a id="ch06fn9a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn9" class="totri-footnote">9</a></sup></p>
<p class="footnote"><a id="ch06fn9" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn9a" class="totri-footnote">9</a>. Formerly <strong><span class="dark-green"><code>update_attributes</code></span></strong>.</p>
<p class="codelink"><a id="pf0270-04" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0270-04a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>update(<span class="green1">name</span>: <span class="maroon">"The Dude"</span>, <span class="violet">email</span>: <span class="maroon">"dude@abides.org"</span>)
<span class="green">=&gt; true</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>name
<span class="green">=&gt; "The Dude"</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>email
<span class="green">=&gt; "dude@abides.org"</span></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_271"></span>The <strong><span class="dark-green"><code>update</code></span></strong> method accepts a hash of attributes, and on success performs both the update and the save in one step (returning <strong><span class="dark-green"><code>true</code></span></strong> to indicate that the save went through). Note that if any of the validations fail, such as when a password is required to save a record (as implemented in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3">Section 6.3</a>), the call to <strong><span class="dark-green"><code>update</code></span></strong> will fail. If we need to update only a single attribute, using the singular <strong><span class="dark-green"><code>update_attribute</code></span></strong> bypasses this restriction by skipping the validations:</p>
<p class="codelink"><a id="pf0271-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0271-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>update_attribute(<span class="violet">:name</span>, <span class="maroon">"El Duderino"</span>)
<span class="green">=&gt; true</span>
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>name
<span class="green">=&gt; "El Duderino"</span></pre>
<section>
<h5 class="h5" id="lev60">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Update the users name using assignment and a call to <strong><span class="dark-green"><code>save</code></span></strong>.</p></li>
<li><p class="num">Update the users email address using a call to <strong><span class="dark-green"><code>update</code></span></strong>.</p></li>
<li><p class="num">Confirm that you can change the magic columns directly by updating the <strong><span class="dark-green"><code>created_at</code></span></strong> column using assignment and a save. Use the value <strong><span class="dark-green"><code>1.year.ago</code></span></strong>, which is a Rails way to create a timestamp one year before the present time.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec6_2">6.2 User Validations</h3>
<p class="noindent">The User model we created in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1">Section 6.1</a> now has working <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong> attributes, but they are completely generic: Any string (including an empty one) is currently valid in either case. And yet, names and email addresses are more specific than this. For example, <strong><span class="dark-green"><code>name</code></span></strong> should be non-blank, and <strong><span class="dark-green"><code>email</code></span></strong> should match the specific format characteristic of email addresses. Moreover, since well be using email addresses as unique usernames when users log in, we shouldnt allow email duplicates in the database.</p>
<p class="indent">In short, we shouldnt allow <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong> to be just any strings; we should enforce certain constraints on their values. Active Record allows us to impose such constraints using <em>validations</em> (seen briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#sec2_3_2">Section 2.3.2</a>). In this section, well cover <span epub:type="pagebreak" id="page_272"></span>several of the most common cases, validating <em>presence</em>, <em>length</em>, <em>format</em>, and <em>uniqueness</em>. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3_2">Section 6.3.2</a> well add a final common validation, <em>confirmation</em>. And well see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3">Section 7.3</a> how validations give us convenient error messages when users make submissions that violate them.</p>
<section>
<h4 class="h4" id="sec6_2_1">6.2.1 A Validity Test</h4>
<p class="noindent">As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#box3_3">Box 3.3</a>, test-driven development isnt always the right tool for the job, but model validations are exactly the kind of features for which TDD is a perfect fit. Its difficult to be confident that a given validation is doing exactly what we expect it to without writing a failing test and then getting it to pass.</p>
<p class="indent">Our method will be to start with a <em>valid</em> model object, set one of its attributes to something we want to be invalid, and then test that it in fact is invalid. As a safety net, well first write a test to make sure the initial model object is valid. This way, when the validation tests fail well know its for the right reason (and not because the initial object was invalid in the first place).</p>
<p class="indent">In what follows, and when doing TDD generally, its convenenient to work with your editor split into two <em>panes</em>, with the test code on the left and the application code on the right. My preferred setup with the cloud IDE is shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig07">Figure 6.7</a>.</p>
<figure id="ch06fig07" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_07.jpg" alt="Image" width="677" height="421" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_07.jpg">
<figcaption><p><strong>Figure 6.7:</strong> TDD with a split pane.</p></figcaption>
</figure>
<p class="indent">To get us started, the command in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a> produced an initial test for testing users, though in this case its practically blank (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex04">Listing 6.4</a>).</p>
<p class="ex-title" id="ch06ex04"><strong>Listing 6.4:</strong> The practically blank default User test.</p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0272-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0272-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>
  <span class="blue"># test "the truth" do</span>
  <span class="blue">#   assert true</span>
  <span class="blue"># end</span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">To write a test for a valid object, well create an initially valid User model object <strong><span class="dark-green"><code>@user</code></span></strong> using the special <strong><span class="dark-green"><code>setup</code></span></strong> method (discussed briefly in the <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03">Chapter 3</a> exercises), which automatically gets run before each test. Because <strong><span class="dark-green"><code>@user</code></span></strong> is an instance variable, <span epub:type="pagebreak" id="page_273"></span>its automatically available in all the tests, and we can test its validity using the <strong><span class="dark-green"><code>valid?</code></span></strong> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_3">Section 6.1.3</a>). The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex05">Listing 6.5</a>.</p>
<p class="ex-title" id="ch06ex05"><strong>Listing 6.5:</strong> A test for an initially valid user. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0273-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0273-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>

  <span class="green1">test</span> <span class="maroon">"should be valid"</span> <strong><span class="green">do</span></strong>
    assert <span class="violet">@user</span><span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex05">Listing 6.5</a> uses the plain <strong><span class="dark-green"><code>assert</code></span></strong> method, which in this case succeeds if <strong><span class="dark-green"><code>@user.valid?</code></span></strong> returns <strong><span class="dark-green"><code>true</code></span></strong> and fails if it returns <strong><span class="dark-green"><code>false</code></span></strong>.<span epub:type="pagebreak" id="page_274"></span></p>
<p class="indent">Because our User model doesnt currently have any validations, the initial test should pass:</p>
<p class="ex-title" id="ch06ex06"><strong>Listing 6.6:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test:models</pre>
</div>
<p class="noindent">Here weve used <strong><span class="dark-green"><code>rails test:models</code></span></strong> to run just the model tests (compare it to <strong><span class="dark-green"><code>rails test:integration</code></span></strong> from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#sec5_3_4">Section 5.3.4</a>).</p>
<section>
<h5 class="h5" id="lev61">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">In the console, confirm that a new user is currently valid.</p></li>
<li><p class="num">Confirm that the user created in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_3">Section 6.1.3</a> is also valid.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec6_2_2">6.2.2 Validating Presence</h4>
<p class="noindent">Perhaps the most elementary validation is <em>presence</em>, which simply verifies that a given attribute is present. For example, in this section well ensure that both the name and email fields are present before a user gets saved to the database. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_3_3">Section 7.3.3</a>, well see how to propagate this requirement up to the signup form for creating new users.</p>
<p class="indent">Well start with a test for the presence of a <strong><span class="dark-green"><code>name</code></span></strong> attribute by building on the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex05">Listing 6.5</a>. As seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex07">Listing 6.7</a>, all we need to do is set the <strong><span class="dark-green"><code>@user</code></span></strong> variables <strong><span class="dark-green"><code>name</code></span></strong> attribute to a blank string (in this case, a string of spaces) and then check (using the <strong><span class="dark-green"><code>assert_not</code></span></strong> method) that the resulting User object is not valid.</p>
<p class="ex-title" id="ch06ex07"><strong>Listing 6.7:</strong> A test for validation of the <strong><span class="dark-green"><code>name</code></span></strong> attribute. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0274-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0274-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
<span epub:type="pagebreak" id="page_275"></span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>

  <span class="green1">test</span> <span class="maroon">"should be valid"</span> <strong><span class="green">do</span></strong>
    assert <span class="violet">@user</span><span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>

<span class="mark"><span class="green3">  test</span> <span class="red2">"name should be present"</span> <strong><span class="green3">do</span></strong></span>
<span class="mark"><span class="blue1">    @user</span><span class="ash1">.</span>name <span class="ash1">=</span> <span class="red2">" "</span></span>
<span class="mark">    assert_not <span class="blue1">@user</span><span class="ash1">.</span>valid?</span>
<span class="mark">  <strong><span class="green3">end</span></strong></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">At this point, the model tests should be <span class="red5"><small>RED</small></span>:</p>
<p class="ex-title" id="ch06ex08"><strong>Listing 6.8:</strong> <span class="red5"><small>RED</small></span></p>
<div class="example">
<pre>$ rails test:models</pre>
</div>
<p class="indent">As we saw briefly in the <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">Chapter 2</a> exercises, the way to validate the presence of the name attribute is to use the <strong><span class="dark-green"><code>validates</code></span></strong> method with argument <strong><span class="dark-green"><code>presence: true</code></span></strong>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex09">Listing 6.9</a>. The <strong><span class="dark-green"><code>presence: true</code></span></strong> argument is a one-element <em>options hash</em>; recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_4">Section 4.3.4</a> that curly braces are optional when passing hashes as the final argument in a method. (As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#sec5_1_1">Section 5.1.1</a>, the use of options hashes is a recurring theme in Rails.)</p>
<p class="ex-title" id="ch06ex09"><strong>Listing 6.9:</strong> Validating the presence of a <strong><span class="dark-green"><code>name</code></span></strong> attribute. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0275-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0275-02a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
<span class="mark">  validates <span class="blue1">:name</span>, <span class="blue1">presence:</span> <strong><span class="green3">true</span></strong></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex09">Listing 6.9</a> may look like magic, but <strong><span class="dark-green"><code>validates</code></span></strong> is just a method. An equivalent formulation of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex09">Listing 6.9</a> using parentheses is as follows:</p>
<p class="codelink"><a id="pf0275-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0275-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  validates(<span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>)
<strong><span class="green">end</span></strong></pre>
<p class="indent"><span epub:type="pagebreak" id="page_276"></span>Lets drop into the console to see the effects of adding a validation to our User model:<sup><a id="ch06fn10a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn10">10</a></sup></p>
<p class="footnote"><a id="ch06fn10" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn10a">10</a>. Ill omit the output of console commands when they are not particularly instructivefor example, the results of <strong><span class="dark-green"><code>User.new</code></span></strong>.</p>
<p class="codelink"><a id="pf0276-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0276-01a">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console --sandbox</span>
<strong><span class="navy">&gt;&gt;</span></strong> user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">""</span>, <span class="violet">email</span>: <span class="maroon">"michael@example.com"</span>)
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>valid?
<span class="green">=&gt; false</span></pre>
<p class="noindent">Here we check the validity of the <strong><span class="dark-green"><code>user</code></span></strong> variable using the <strong><span class="dark-green"><code>valid?</code></span></strong> method, which returns <strong><span class="dark-green"><code>false</code></span></strong> when the object fails one or more validations, and <strong><span class="dark-green"><code>true</code></span></strong> when all validations pass. In this case, we have only one validation, so we know which one failed, but it can still be helpful to check using the <strong><span class="dark-green"><code>errors</code></span></strong> object generated on failure:</p>
<p class="codelink"><a id="pf0276-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0276-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>errors<span class="ash">.</span>full_messages
<span class="green">=&gt; ["Name can't be blank"]</span></pre>
<p class="noindent">(The error message is a hint that Rails validates the presence of an attribute using the <strong><span class="dark-green"><code>blank?</code></span></strong> method, which we saw at the end of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_3">Section 4.4.3</a>.)</p>
<p class="indent">Because the user isnt valid, an attempt to save the user to the database automatically fails:</p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>save
<span class="green">=&gt; false</span></pre>
<p class="noindent">As a result, the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex07">Listing 6.7</a> should now be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch06ex010"><strong>Listing 6.10:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test:models</pre>
</div>
<p class="indent">By following the model in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex07">Listing 6.7</a>, writing a test for <strong><span class="dark-green"><code>email</code></span></strong> attribute presence is easy (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex011">Listing 6.11</a>), as is the application code to get it to pass (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex012">Listing 6.12</a>).</p>
<p class="ex-title" id="ch06ex011"><span epub:type="pagebreak" id="page_277"></span><strong>Listing 6.11:</strong> A test for validation of the <strong><span class="dark-green"><code>email</code></span></strong> attribute. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0277-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0277-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>

  <span class="green1">test</span> <span class="maroon">"should be valid"</span> <strong><span class="green">do</span></strong>
    assert <span class="violet">@user</span><span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>

  <span class="green1">test</span> <span class="maroon">"name should be present"</span> <strong><span class="green">do</span></strong>
    <span class="violet">@user</span><span class="ash">.</span>name <span class="ash">=</span> <span class="maroon">""</span>
    assert_not <span class="violet">@user</span><span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>

  <span class="mark"><span class="green3">test</span> <span class="red2">"email should be present"</span> <strong><span class="green3">do</span></strong></span>
    <span class="mark"><span class="blue1">@user</span><span class="ash1">.</span>email <span class="ash1">=</span> <span class="red2">" "</span></span>
    <span class="mark">assert_not <span class="blue1">@user</span><span class="ash1">.</span>valid?</span>
<span class="mark">  <strong><span class="green3">end</span></strong></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="ex-title" id="ch06ex012"><strong>Listing 6.12:</strong> Validating the presence of an <strong><span class="dark-green"><code>email</code></span></strong> attribute. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0277-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0277-02a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>
  <span class="mark">validates <span class="blue1">:email</span>, <span class="blue1">presence</span>: <strong><span class="green3">true</span></strong></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">At this point, the presence validations are complete, and the test suite should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch06ex013"><strong>Listing 6.13:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev62">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_278"></span></p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Make a new user called <strong><span class="dark-green"><code>u</code></span></strong> and confirm that its initially invalid. What are the full error messages?</p></li>
<li><p class="num">Confirm that <strong><span class="dark-green"><code>u.errors.messages</code></span></strong> is a hash of errors. How would you access just the email errors?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec6_2_3">6.2.3 Length Validation</h4>
<p class="noindent">Weve constrained our User model to require a name for each user, but we should go further: The users names will be displayed on the sample site, so we should enforce some limit on their length. With all the work we did in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_2">Section 6.2.2</a>, this step is easy.</p>
<p class="indent">Theres no science to picking a maximum length; well just pull <strong><span class="dark-green"><code>50</code></span></strong> out of thin air as a reasonable upper bound, which means verifying that names of <strong><span class="dark-green"><code>51</code></span></strong> characters are too long. In addition, although its unlikely ever to be a problem, theres a chance that a users email address could overrun the maximum length of strings, which for many databases is 255. Because the format validation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_4">Section 6.2.4</a> wont enforce such a constraint, well add one in this section for completeness. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex014">Listing 6.14</a> shows the resulting tests.</p>
<p class="ex-title" id="ch06ex014"><strong>Listing 6.14:</strong> Tests for <strong><span class="dark-green"><code>name</code></span></strong> and <strong><span class="dark-green"><code>email</code></span></strong> length validations. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0278-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0278-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"name should not be too long"</span> <strong><span class="green">do</span></strong>
    <span class="violet">@user</span><span class="ash">.</span>name <span class="ash">=</span> <span class="maroon">"a"</span> <span class="ash">* 51</span>
    assert_not <span class="violet">@user</span><span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>

  <span class="green1">test</span> <span class="maroon">"email should not be too long"</span> <strong><span class="green">do</span></strong>
    <span epub:type="pagebreak" id="page_279"></span><span class="violet">@user</span><span class="ash">.</span>email <span class="ash">=</span> <span class="maroon">"a"</span> <span class="ash">* 244 +</span> <span class="maroon">"@example.com"</span>
    assert_not <span class="violet">@user</span><span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">For convenience, weve used string multiplication in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex014">Listing 6.14</a> to make a string 51 characters long. We can see how this works using the console:</p>
<p class="codelink"><a id="pf0279-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0279-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="maroon">"a"</span> <span class="ash">* 51</span>
<span class="green">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
<strong><span class="navy">&gt;&gt;</span></strong> (<span class="maroon">"a"</span> <span class="ash">* 51</span>)<span class="ash">.</span>length
<span class="green">=&gt; 51</span></pre>
<p class="noindent">The email length validation arranges to make a valid email address thats one character too long:</p>
<p class="codelink"><a id="pf0279-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0279-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="maroon">"a"</span> <span class="ash">* 244 +</span> <span class="maroon">"@example.com"</span>
<span class="green">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="green">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="green">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="green">aaaaaaaaaaa@example.com"</span>
<strong><span class="navy">&gt;&gt;</span></strong> (<span class="maroon">"a"</span> <span class="ash">* 244 +</span> <span class="maroon">"@example.com"</span>)<span class="ash">.</span>length
<span class="green">=&gt; 256</span></pre>
<p class="indent">At this point, the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex014">Listing 6.14</a> should be <span class="red5"><small>RED</small></span>:</p>
<p class="ex-title" id="ch06ex015"><strong>Listing 6.15:</strong> <span class="red5"><small>RED</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">To get them to pass, we need to use the validation argument to constrain length, which is just <strong><span class="dark-green"><code>length</code></span></strong>, along with the <strong><span class="dark-green"><code>maximum</code></span></strong> parameter to enforce the upper bound (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex016">Listing 6.16</a>).</p>
<p class="ex-title" id="ch06ex016"><strong>Listing 6.16:</strong> Adding a length validation for the <strong><span class="dark-green"><code>name</code></span></strong> attribute. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0279-04" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0279-04a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  <span class="mark">validates <span class="blue1">:name</span>, <span class="blue1">presence</span>: <strong><span class="green3">true</span></strong>, <span class="blue1">length</span>: { <span class="blue1">maximum</span>: <span class="ash1">50</span> }</span>
  <span class="mark">validates <span class="blue1">:email</span>, <span class="blue1">presence</span>: <strong><span class="green3">true</span></strong>, <span class="blue1">length</span>: { <span class="blue1">maximum</span>: <span class="ash1">255</span> }</span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_280"></span>Now the tests should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch06ex017"><strong>Listing 6.17:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">With our test suite passing again, we can move on to a more challenging validation: email format.</p>
<section>
<h5 class="h5" id="lev63">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Make a new user with a too-long name and email and confirm that its not valid.</p></li>
<li><p class="num">What are the error messages generated by the length validation?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec6_2_4">6.2.4 Format Validation</h4>
<p class="noindent">Our validations for the <strong><span class="dark-green"><code>name</code></span></strong> attribute enforce only minimal constraintsany non-blank name with fewer than 51 characters will dobut of course the <strong><span class="dark-green"><code>email</code></span></strong> attribute must satisfy the more stringent requirement of being a valid email address. So far weve rejected only blank email addresses; in this section, well require email addresses to conform to the familiar pattern <strong><span class="dark-green"><code>user@example.com</code></span></strong>.</p>
<p class="indent">Neither the tests nor the validation will be exhaustive, just good enough to accept most valid email addresses and reject most invalid ones. Well start with a couple of tests involving collections of valid and invalid addresses. To make these collections, its worth knowing about the useful <strong><span class="dark-green"><code>%w[]</code></span></strong> technique for making arrays of strings, as seen in this console session:</p>
<p class="codelink"><a id="pf0281-01-z" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0281-01-za">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="green1">%w[foo bar baz]</span>
<span class="green">=&gt; ["foo", "bar", "baz"]</span>
<strong><span class="navy">&gt;&gt;</span></strong> addresses <span class="ash">=</span> <span class="green1">%w[USER@foo.COM THE_US-ER@foo.bar.org first.last@foo.jp]</span>
<span class="green">=&gt; ["USER@foo.COM",  "THE_US-ER@foo.bar.org",  "first.last@foo.jp"]</span>
<strong><span class="navy">&gt;&gt;</span></strong> addresses<span class="ash">.</span>each <strong><span class="green">do</span></strong> <span class="ash">|</span>address<span class="ash">|</span>
<strong><span class="navy">?&gt;</span></strong>   <span class="green1">puts</span> address
<strong><span class="navy">&gt;&gt;</span></strong> <strong><span class="green">end</span></strong>
<span class="green">USER@foo.COM</span>
<span class="green"><span epub:type="pagebreak" id="page_281"></span>THE_US-ER@foo.bar.org</span>
<span class="green">first.last@foo.jp</span></pre>
<p class="noindent">Here weve iterated over the elements of the <strong><span class="dark-green"><code>addresses</code></span></strong> array using the <strong><span class="dark-green"><code>each</code></span></strong> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_2">Section 4.3.2</a>). With this technique in hand, were ready to write some basic email format validation tests.</p>
<p class="indent">Because email format validation is tricky and error-prone, well start with some passing tests for <em>valid</em> email addresses to catch any errors in the validation. In other words, we want to make sure not just that invalid email addresses like <em>user@example,com</em> are rejected, but also that valid addresses like <em>user@example.com</em> are accepted, even after we impose the validation constraint. (Right now theyll be accepted because all non-blank email addresses are currently valid.) The result for a representative sample of valid email addresses appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex018">Listing 6.18</a>.</p>
<p class="ex-title" id="ch06ex018"><strong>Listing 6.18:</strong> Tests for valid email formats. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0281-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0281-02a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>
<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"email validation should accept valid addresses"</span> <strong><span class="green">do</span></strong>
    valid_addresses <span class="ash">=</span> <span class="green1">%w[user@example.com USER@foo.COM A_US-ER@foo.bar.org</span>
                         <span class="green1">first.last@foo.jp alice+bob@baz.cn]</span>
    valid_addresses<span class="ash">.</span>each <strong><span class="green">do</span></strong> <span class="ash">|</span>valid_address<span class="ash">|</span>
      <span class="violet">@user</span><span class="ash">.</span>email <span class="ash">=</span> valid_address
      assert <span class="violet">@user</span><span class="ash">.</span>valid?, <span class="maroon">"</span><strong><span class="pink">#{</span></strong>valid_address<span class="ash">.</span>inspect<strong><span class="pink">}</span></strong> <span class="maroon">should be valid"</span>
   <strong><span class="green">end</span></strong>
 <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">Note that weve included an optional second argument to the assertion with a custom error message, which in this case identifies the address causing the test to fail:</p>
<p class="codelink"><a id="pf0281-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0281-03a">Click here to view code image</a></p>
<pre class="pre1">assert <span class="violet">@user</span><span class="ash">.</span>valid?, <span class="maroon">"</span><strong><span class="pink">#{</span></strong>valid_address<span class="ash">.</span>inspect<strong><span class="pink">}</span></strong> <span class="maroon">should be valid"</span></pre>
<span epub:type="pagebreak" id="page_282"></span><p class="noindent">(This uses the interpolated <strong><span class="dark-green"><code>inspect</code></span></strong> method mentioned in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_3">Section 4.3.3</a>.) Including the specific address that causes any failure is especially useful in a test with an <strong><span class="dark-green"><code>each</code></span></strong> loop like <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex018">Listing 6.18</a>; otherwise, any failure would merely identify the line number, which is the same for all the email addresses, and which wouldnt be sufficient to identify the source of the problem.</p>
<p class="indent">Next well add tests for the <em>invalidity</em> of a variety of invalid email addresses, such as <em>user@example,com</em> (comma in place of dot) and <em>user_at_foo.org</em> (missing the @ sign). As in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex018">Listing 6.18</a>, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex019">Listing 6.19</a> includes a custom error message to identify the exact address causing any failure.</p>
<p class="ex-title" id="ch06ex019"><strong>Listing 6.19:</strong> Tests for email format validation. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0282-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0282-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"email validation should reject invalid addresses"</span> <strong><span class="green">do</span></strong>
    invalid_addresses <span class="ash">=</span> <span class="green1">%w[user@example,com user_at_foo.org user.name@example.</span>
                           <span class="green1">foo@bar_baz.com foo@bar+baz.com]</span>
    invalid_addresses<span class="ash">.</span>each <strong><span class="green">do</span></strong> <span class="ash">|</span>invalid_address<span class="ash">|</span>
      <span class="violet">@user</span><span class="ash">.</span>email <span class="ash">=</span> invalid_address
      assert_not <span class="violet">@user</span><span class="ash">.</span>valid?, <span class="maroon">"</span><strong><span class="pink">#{</span></strong>invalid_address<span class="ash">.</span>inspect<strong><span class="pink">}</span></strong> <span class="maroon">should be invalid"</span>
   <strong><span class="green">end</span></strong>
 <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">At this point, the tests should be <span class="red5"><small>RED</small></span>:</p>
<p class="ex-title" id="ch06ex020"><strong>Listing 6.20:</strong> <span class="red5"><small>RED</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">The application code for email format validation uses the <strong><span class="dark-green"><code>format</code></span></strong> validation, which works like this:<span epub:type="pagebreak" id="page_283"></span></p>
<p class="codelink"><a id="pf0283-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0283-01a">Click here to view code image</a></p>
<pre class="pre1">validates <span class="violet">:email</span>, <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red6">/&lt;regular expression&gt;/</span> }</pre>
<p class="noindent">This validates the attribute with the given <em>regular expression</em> (or <em>regex</em>), which is a powerful (and often cryptic) language for matching patterns in strings. It means we need to construct a regular expression to match valid email addresses while <em>not</em> matching invalid ones.</p>
<p class="indent">There actually exists a full regex for matching email addresses according to the official email standard, but its enormous, obscure, and quite possibly counterproductive.<sup><a id="ch06fn11a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn11">11</a></sup> In this tutorial, well adopt a more pragmatic regex that has proven to be robust in practice. Heres what it looks like:</p>
<p class="footnote"><a id="ch06fn11" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn11a">11</a>. For example, did you know that <strong><span class="dark-green"><code>"Michael Hartl"@example.com</code></span></strong>, with quotation marks and a space in the middle, is a valid email address according to the standard? Incredibly, it isbut its absurd.</p>
<p class="codelink"><a id="pf0283-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0283-02a">Click here to view code image</a></p>
<pre class="pre1"><span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></pre>
<p class="noindent">To help understand where this comes from, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06tab01">Table 6.1</a> breaks it into bite-sized pieces.<sup><a id="ch06fn12a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn12">12</a></sup></p>
<p class="footnote"><a id="ch06fn12" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn12a">12</a>. Note that, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06tab01">Table 6.1</a>, letter really means lowercase letter, but the <strong><span class="dark-green"><code>i</code></span></strong> at the end of the regex enforces case-insensitive matching.</p>
<figure id="ch06tab01">
<figcaption><p><strong>Table 6.1:</strong> Breaking down the valid email regex.</p></figcaption>
<table class="topbot">
<thead>
<tr>
<th class="tab-th"><p class="tab-para">Expression</p></th>
<th class="tab-th"><p class="tab-para">Meaning</p></th>
</tr>
</thead>
<tbody>
<tr>
<td><p class="tab-para"><code>/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</code></p></td>
<td><p class="tab-para">full regex</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>/</code></p></td>
<td><p class="tab-para">start of regex</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>\A</code></p></td>
<td><p class="tab-para">match start of a string</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>[\w+\-.]+</code></p></td>
<td><p class="tab-para">at least one word character, plus, hyphen, or dot</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>@</code></p></td>
<td><p class="tab-para">literal at sign</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>[a-z\d\-.]+</code></p></td>
<td><p class="tab-para">at least one letter, digit, hyphen, or dot</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>\.</code></p></td>
<td><p class="tab-para">literal dot</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>[a-z]+</code></p></td>
<td><p class="tab-para">at least one letter</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>\z</code></p></td>
<td><p class="tab-para">match end of a string</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>/</code></p></td>
<td><p class="tab-para">end of regex</p></td>
</tr>
<tr>
<td><p class="tab-para"><code>i</code></p></td>
<td><p class="tab-para">case-insensitive</p></td>
</tr>
</tbody>
</table>
</figure>
<p class="indent"><span epub:type="pagebreak" id="page_284"></span>Although you can learn a lot by studying <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06tab01">Table 6.1</a>, to really understand regular expressions I consider using an interactive regular expression matcher like Rubular to be essential (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig08">Figure 6.8</a>).<sup><a id="ch06fn13a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn13">13</a></sup> The Rubular website has a beautiful interactive interface for making regular expressions, along with a handy regex quick reference. I encourage you to study <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06tab01">Table 6.1</a> with a browser window open to Rubularno amount of reading about regular expressions can replace playing with them interactively. (<em>Note</em>: If you use the regex from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06tab01">Table 6.1</a> in Rubular, I recommend leaving off the <code>\A</code> and <code>\z</code> characters so that you can match more than one email address at a time in the given test string. Also note that the regex consists of the characters <em>inside</em> the slashes <strong><span class="dark-green"><code>/.../</code></span></strong>, so you should omit those when using Rubular.)</p>
<p class="footnote"><a id="ch06fn13" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn13a">13</a>. If you find it as useful as I do, I encourage you to donate to Rubular to reward developer Michael Lovitt for his wonderful work.</p>
<figure id="ch06fig08" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_08.jpg" alt="Image" width="905" height="610" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_08.jpg">
<figcaption><p><strong>Figure 6.8:</strong> The awesome Rubular regular expression editor.</p></figcaption>
</figure>
<p class="indent">Applying the regular expression from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06tab01">Table 6.1</a> to the <strong><span class="dark-green"><code>email</code></span></strong> format validation yields the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex021">Listing 6.21</a>.<span epub:type="pagebreak" id="page_285"></span></p>
<p class="ex-title" id="ch06ex021"><strong>Listing 6.21:</strong> Validating the email format with a regular expression. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0285-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0285-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="mark"><span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
<span class="mark">                 <span class="green3">format</span>: { <span class="blue1">with</span>: <span class="red2">VALID_EMAIL_REGEX</span> }</span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">Here the regex <strong><span class="dark-green"><code>VALID_EMAIL_REGEX</code></span></strong> is a <em>constant</em>, indicated in Ruby by a name starting with a capital letter. The code</p>
<p class="codelink"><a id="pf0285-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0285-02a">Click here to view code image</a></p>
<pre class="pre1"><span class="red">  VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> }</pre>
<p class="noindent">ensures that only email addresses that match the pattern will be considered valid. (This expression has one minor weakness: It allows invalid addresses that contain consecutive dots, such as <strong><span class="dark-green"><code>foo@bar..com</code></span></strong>. Updating the regex in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex021">Listing 6.21</a> to fix this blemish is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_4">Section 6.2.4</a>).)</p>
<p class="indent">At this point, the tests should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch06ex022"><strong>Listing 6.22:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test:models</pre>
</div>
<p class="noindent">This means that theres only one constraint left: enforcing email uniqueness.</p>
<section>
<h5 class="h5" id="lev64">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">By pasting in the valid addresses from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex018">Listing 6.18</a> and invalid addresses from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex019">Listing 6.19</a> into the test string area at Rubular, confirm that the regex from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex021">Listing 6.21</a> matches all of the valid addresses and none of the invalid ones.<span epub:type="pagebreak" id="page_286"></span></p></li>
<li><p class="num">As noted earlier, the email regex in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex021">Listing 6.21</a> allows invalid email addresses with consecutive dots in the domain namethat is, addresses of the form <em>foo@bar..com</em>. Add this address to the list of invalid addresses in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex019">Listing 6.19</a> to get a failing test, and then use the more complicated regex shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex023">Listing 6.23</a> to get the test to pass.</p></li>
<li><p class="num">Add <em>foo@bar..com</em> to the list of addresses at Rubular, and confirm that the regex shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex023">Listing 6.23</a> matches all the valid addresses and none of the invalid ones.</p></li>
</ol>
<p class="ex-title" id="ch06ex023"><strong>Listing 6.23:</strong> Disallowing double dots in email domain names. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0286-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0286-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="mark"><span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-]+(\.[a-z\d\-]+)*\.[a-z]+\z/i</span></span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>:   { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> }
<strong><span class="green">end</span></strong></pre>
</div>
</section>
</section>
<section>
<h4 class="h4" id="sec6_2_5">6.2.5 Uniqueness Validation</h4>
<p class="noindent">To enforce uniqueness of email addresses (so that we can use them as usernames), well be using the <strong><span class="dark-green"><code>:uniqueness</code></span></strong> option to the <strong><span class="dark-green"><code>validates</code></span></strong> method. But be warned: Theres a <em>major</em> caveat, so dont just skim this sectionread it carefully.</p>
<p class="indent">Well start with some short tests. In our previous model tests, weve mainly used <strong><span class="dark-green"><code>User.new</code></span></strong>, which just creates a Ruby object in memory, but for uniqueness tests we actually need to put a record into the database.<sup><a id="ch06fn14a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn14">14</a></sup> The initial duplicate email test appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex024">Listing 6.24</a>.</p>
<p class="footnote"><a id="ch06fn14" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn14a">14</a>. As noted briefly in the introduction to this section, there is a dedicated test database, <strong><span class="dark-green"><code>db/test.sqlite3</code></span></strong>, for this purpose.</p>
<p class="ex-title" id="ch06ex024"><strong>Listing 6.24:</strong> A test for the rejection of duplicate email addresses. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0286-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0286-02a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="red">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>
<span epub:type="pagebreak" id="page_287"></span>  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"email addresses should be unique"</span> <strong><span class="green">do</span></strong>
    duplicate_user <span class="ash">=</span> <span class="violet">@user</span><span class="ash">.</span>dup
    <span class="violet">@user</span><span class="ash">.</span>save
    assert_not duplicate_user<span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">The method here is to make a user with the same email address as <strong><span class="dark-green"><code>@user</code></span></strong> using <strong><span class="dark-green"><code>@user.dup</code></span></strong>, which creates a duplicate user with the same attributes. Since we then save <strong><span class="dark-green"><code>@user</code></span></strong>, the duplicate user has an email address that already exists in the database, and hence should not be valid.</p>
<p class="indent">We can get the new test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex024">Listing 6.24</a> to pass by adding <strong><span class="dark-green"><code>uniqueness: true</code></span></strong> to the <strong><span class="dark-green"><code>email</code></span></strong> validation, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex025">Listing 6.25</a>.</p>
<p class="ex-title" id="ch06ex025"><strong>Listing 6.25:</strong> Validating the uniqueness of email addresses. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0287-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0287-02a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> },
<span class="mark">                    <span class="blue1">uniqueness</span>: <strong><span class="green3">true</span></strong></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">Were not quite done, though. Email addresses are typically processed as if they were case-insensitivethat is, <strong><span class="dark-green"><code>foo@bar.com</code></span></strong> is treated the same as <strong><span class="dark-green"><code>FOO@BAR.COM</code></span></strong> or <strong><span class="dark-green"><code>FoO@BAr.coM</code></span></strong>so our validation should incorporate this as well.<sup><a id="ch06fn15a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn15">15</a></sup> Its thus important to test for case-insensitivity, which we do with the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex026">Listing 6.26</a>.</p>
<p class="footnote"><a id="ch06fn15" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn15a">15</a>. Technically, only the domain part of the email address is case-insensitive: <em>foo@bar.com</em> is actually different from <em>Foo@bar.com</em>. In practice, though, it is a bad idea to rely on this fact; as noted at about.com, Since the case sensitivity of email addresses can create a lot of confusion, interoperability problems and widespread headaches, it would be foolish to require email addresses to be typed with the correct case. Hardly any email service or ISP does enforce case sensitive email addresses, returning messages whose recipients email address was not typed correctly (in all upper case, for example). Thanks to reader Riley Moses for pointing this out.<span epub:type="pagebreak" id="page_288"></span></p>
<p class="ex-title" id="ch06ex026"><strong>Listing 6.26:</strong> Testing case-insensitive email uniqueness. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0288-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0288-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"email addresses should be unique"</span> <strong><span class="green">do</span></strong>
    duplicate_user <span class="ash">=</span> <span class="violet">@user</span><span class="ash">.</span>dup
    <span class="mark">duplicate_user<span class="ash1">.</span>email <span class="ash1">=</span> <span class="blue1">@user</span><span class="ash1">.</span>email.upcase</span>
    <span class="violet">@user</span><span class="ash">.</span>save
    assert_not duplicate_user<span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">Here we are using the <strong><span class="dark-green"><code>upcase</code></span></strong> method on strings (seen briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_2">Section 4.3.2</a>). This test does the same thing as the initial duplicate email test, but with an uppercase email address instead. If this test feels a little abstract, go ahead and fire up the console:</p>
<p class="codelink"><a id="pf0288-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0288-02a">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console --sandbox</span>
<strong><span class="navy">&gt;&gt;</span></strong> user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>create(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>email<span class="ash">.</span>upcase
<span class="green">=&gt; "USER@EXAMPLE.COM"</span>
<strong><span class="navy">&gt;&gt;</span></strong> duplicate_user <span class="ash">=</span> user<span class="ash">.</span>dup
<strong><span class="navy">&gt;&gt;</span></strong> duplicate_user<span class="ash">.</span>email <span class="ash">=</span> user<span class="ash">.</span>email<span class="ash">.</span>upcase
<strong><span class="navy">&gt;&gt;</span></strong> duplicate_user<span class="ash">.</span>valid?
<span class="green">=&gt; true</span></pre>
<p class="indent">Of course, <strong><span class="dark-green"><code>duplicate_user.valid?</code></span></strong> is currently <strong><span class="dark-green"><code>true</code></span></strong> because the uniqueness validation is case-sensitive, but we want it to be <strong><span class="dark-green"><code>false</code></span></strong>. Fortunately, <strong><span class="dark-green"><code>:uniqueness</code></span></strong> accepts an option, <strong><span class="dark-green"><code>:case_sensitive</code></span></strong>, for just this purpose (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex027">Listing 6.27</a>).<span epub:type="pagebreak" id="page_289"></span></p>
<p class="ex-title" id="ch06ex027"><strong>Listing 6.27:</strong> Validating the uniqueness of email addresses, ignoring case. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0289-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0289-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> },
<span class="mark">                    <span class="blue1">uniqueness</span>: <span class="blue1">case_sensitive</span>: <strong><span class="green3">false</span></strong></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">Note that we have simply replaced <strong><span class="dark-green"><code>true</code></span></strong> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex025">Listing 6.25</a> with <strong><span class="dark-green"><code>case_sensitive: false</code></span></strong> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex027">Listing 6.27</a>. (Rails infers that <strong><span class="dark-green"><code>uniqueness</code></span></strong> should be <strong><span class="dark-green"><code>true</code></span></strong> as well.)</p>
<p class="indent">At this point, our applicationwith an important caveatenforces email uniqueness, and our test suite should pass:</p>
<p class="ex-title" id="ch06ex028"><strong>Listing 6.28:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">Theres just one small problem, which is that <em>the Active Record uniqueness validation does not guarantee uniqueness at the database level</em>. Heres a scenario that explains why:</p>
<ol class="num">
<li><p class="num">Alice signs up for the sample app, with address <a href="mailto:alice@wonderland.com">alice@wonderland.com</a>.</p></li>
<li><p class="num">Alice accidentally clicks on Submit <em>twice</em>, sending two requests in quick succession.</p></li>
<li><p class="num">The following sequence occurs: Request 1 creates a user in memory that passes validation, request 2 does the same, request 1s user gets saved, request 2s user gets saved.</p></li>
<li><p class="num">Result: two user records with the exact same email address, despite the uniqueness validation.</p></li>
</ol>
<p class="noindent">If this sequence seems implausible, believe me, it isnt: It can happen on any Rails website with significant traffic (which I once learned the hard way). Luckily, the solution is straightforward to implement: We just need to enforce uniqueness at the database <span epub:type="pagebreak" id="page_290"></span>level as well as at the model level. Our method is to create a database <em>index</em> on the email column (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#box6_2">Box 6.2</a>), and then require that the index be unique.</p>
<div class="box">
<p class="box-caption" id="box6_2">Box 6.2: Database Indices</p>
<p class="boxnp">When creating a column in a database, it is important to consider whether we will need to <em>find</em> records by that column. Consider, for example, the <code>email</code> attribute created by the migration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>. When we allow users to log in to the sample app starting in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>, we will need to find the user record corresponding to the submitted email address. Unfortunately, based on the nave data model, the only way to find a user by email address is to look through <em>each</em> user row in the database and compare its email attribute to the given emailwhich means we might have to examine <em>every</em> row (since the user could be the last one in the database). This is known in the database business as a <em>full-table scan</em>, and for a real site with thousands of users it is a Bad Thing.</p>
<p class="boxip">Putting an index on the email column fixes the problem. To understand a database index, its helpful to consider the analogy of a book index. In a book, to find all the occurrences of a given string, say foobar, you would have to scan each page for foobarthe paper version of a full-table scan. With a book index, on the other hand, you can just look up foobar in the index to see all the pages containing foobar. A database index works essentially the same way.</p>
</div>
<p class="indent">The email index represents an update to our data modeling requirements, which (as discussed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_1">Section 6.1.1</a>) is handled in Rails using migrations. We saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_1">Section 6.1.1</a> that generating the User model automatically created a new migration (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>); in the present case, we are adding structure to an existing model, so we need to create a migration directly using the <strong><span class="dark-green"><code>migration</code></span></strong> generator:</p>
<p class="codelink"><a id="pf0290-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0290-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">$</span></strong> rails generate migration add_index_to_users_email</pre>
<p class="indent">Unlike the migration for users, the email uniqueness migration is not pre-defined, so we need to fill in its contents with <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex029">Listing 6.29</a>.<sup><a id="ch06fn16a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn16">16</a></sup></p>
<p class="footnote"><a id="ch06fn16" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn16a">16</a>. Of course, we could just edit the migration file for the <strong><span class="dark-green"><code>users</code></span></strong> table in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex02">Listing 6.2</a>, but that would require rolling back and then migrating back up. The Rails Way is to use migrations every time we discover that our data model needs to change.<span epub:type="pagebreak" id="page_291"></span></p>
<p class="ex-title" id="ch06ex029"><strong>Listing 6.29:</strong> The migration for enforcing email uniqueness.</p>
<pre class="pre2"><code>db/migrate/[timestamp]_add_index_to_users_email.rb</code></pre>
<p class="codelink"><a id="pf0291-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0291-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">AddIndexToUsersEmail</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveRecord</span><span class="ash">::</span><span class="red">Migration</span><span class="ash">[6.0]</span>
  <strong><span class="green">def</span></strong> <span class="blue3">change</span>
    <span class="mark">add_index <span class="blue1">:users</span>, <span class="blue1">:email</span>, <span class="blue1">unique:</span> <strong><span class="green3">true</span></strong></span>
  <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">This uses a Rails method called <strong><span class="dark-green"><code>add_index</code></span></strong> to add an index on the <strong><span class="dark-green"><code>email</code></span></strong> column of the <strong><span class="dark-green"><code>users</code></span></strong> table. The index by itself doesnt enforce uniqueness, but the option <strong><span class="dark-green"><code>unique: true</code></span></strong> does.</p>
<p class="indent">The final step is to migrate the database:</p>
<pre class="pre1">$ rails db:migrate</pre>
<p class="noindent">(If the migration fails, make sure to exit any running sandbox console sessions, which can lock the database and prevent migrations.)</p>
<p class="indent">At this point, the test suite should be <span class="red5"><small>RED</small></span> due to a violation of the uniqueness constraint in the <em>fixtures</em>, which contain sample data for the test database. User fixtures were generated automatically in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a>, and as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex030">Listing 6.30</a> the email addresses are not unique. (Theyre not <em>valid</em> either, but fixture data doesnt get run through the validations.)</p>
<p class="ex-title" id="ch06ex030"><strong>Listing 6.30:</strong> The default user fixtures. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/fixtures/users.yml</code></pre>
<p class="codelink"><a id="pf0291-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0291-02a">Click here to view code image</a></p>
<div class="example">
<pre><span class="blue"># Read about fixtures at https://api.rubyonrails.org/classes/ActiveRecord/</span>
<span class="blue"># FixtureSet.html</span>

<strong><span class="green">one</span></strong>:
  <strong><span class="green">name</span></strong>: MyString
  <strong><span class="green">email</span></strong>: MyString

<strong><span class="green">two</span></strong>:
  <strong><span class="green">name</span></strong>: MyString
  <strong><span class="green">email</span></strong>: MyString</pre>
</div>
<p class="noindent">Because we wont need fixtures until <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a>, for now well just remove them, leaving an empty fixtures file (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex031">Listing 6.31</a>).<span epub:type="pagebreak" id="page_292"></span></p>
<p class="ex-title" id="ch06ex031"><strong>Listing 6.31:</strong> An empty fixtures file. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>test/fixtures/users.yml</code></pre>
<div class="example">
<pre><span class="blue"># empty</span></pre>
</div>
<p class="indent">Having addressed the uniqueness caveat, theres one more change we need to make to be assured of email uniqueness. Some database adapters use case-sensitive indices, considering the strings Foo@ExAMPle.CoM and foo@example.com to be distinct, but our application treats those addresses as the same. To avoid this incompatibility, well standardize on all lower-case addresses, converting Foo@ExAMPle.CoM to foo@example.com before saving it to the database. The way to do this is with a <em>callback</em>, which is a method that gets invoked at a particular point in the life cycle of an Active Record object.</p>
<p class="indent">In the present case, that point is before the object is saved, so well use a <strong><span class="dark-green"><code>before_save</code></span></strong> callback to downcase the email attribute before saving the user.<sup><a id="ch06fn17a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn17">17</a></sup> The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a>. (This is just a first implementation; well discuss this subject again in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_1">Section 11.1</a>, where well use the preferred <em>method reference</em> convention for defining callbacks.)</p>
<p class="footnote"><a id="ch06fn17" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn17a">17</a>. See the Rails API entry on callbacks for more information on which callbacks Rails supports.</p>
<p class="ex-title" id="ch06ex032"><strong>Listing 6.32:</strong> Ensuring email uniqueness by downcasing the email attribute. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0292-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0292-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
<span class="mark">  before_save { <span class="green3">self</span><span class="ash1">.</span>email <span class="ash1">=</span> email<span class="ash1">.</span>downcase }</span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> },
<span class="mark">                    <span class="blue1">uniqueness</span>: <span class="green3">true</span></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">The code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a> passes a block to the <strong><span class="dark-green"><code>before_save</code></span></strong> callback and sets the users email address to a lowercase version of its current value using the <strong><span class="dark-green"><code>downcase</code></span></strong> string method. Note also that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a> reverts the <strong><span class="dark-green"><code>uniqueness</code></span></strong> constraint back to <strong><span class="dark-green"><code>true</code></span></strong>, <span epub:type="pagebreak" id="page_293"></span>since case-sensitive matching works fine if all of the email addresses are lowercase. Indeed, this practice prevents problems applying the database index from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex029">Listing 6.29</a>, since many databases have difficulty using an index when combined with a case-insensitive match.<sup><a id="ch06fn18a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn18">18</a></sup></p>
<p class="footnote"><a id="ch06fn18" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn18a">18</a>. Thanks to reader Alex Friedman for pointing this out.</p>
<p class="indent">Restoring the original constraint does break the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex026">Listing 6.26</a>, but thats easy to fix by reverting the test to its previous form from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex024">Listing 6.24</a>, as shown again in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex033">Listing 6.33</a>.</p>
<p class="ex-title" id="ch06ex033"><strong>Listing 6.33:</strong> Restoring the original email uniqueness test. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0293-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0293-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"email addresses should be unique"</span> <strong><span class="green">do</span></strong>
    duplicate_user <span class="ash">=</span> <span class="violet">@user</span><span class="ash">.</span>dup
    <span class="violet">@user</span><span class="ash">.</span>save
    assert_not duplicate_user<span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">By the way, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a> we could have written the assignment as</p>
<pre class="pre1"><span class="green1">self</span><span class="ash">.</span>email <span class="ash">=</span> <span class="green1">self</span><span class="ash">.</span>email<span class="ash">.</span>downcase</pre>
<p class="noindent">(where <strong><span class="dark-green"><code>self</code></span></strong> refers to the current user), but inside the User model the <strong><span class="dark-green"><code>self</code></span></strong> keyword is optional on the right-hand side:</p>
<pre class="pre1"><span class="green1">self</span><span class="ash">.</span>email <span class="ash">=</span> email<span class="ash">.</span>downcase</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_294"></span>We encountered this idea briefly in the context of <strong><span class="dark-green"><code>reverse</code></span></strong> in the <strong><span class="dark-green"><code>palindrome</code></span></strong> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_2">Section 4.4.2</a>), which also noted that <strong><span class="dark-green"><code>self</code></span></strong> is <em>not</em> optional in an assignment, so</p>
<pre class="pre1">email <span class="ash">=</span> email<span class="ash">.</span>downcase</pre>
<p class="noindent">wouldnt work. (Well discuss this subject in more depth in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_1">Section 9.1</a>.)</p>
<p class="indent">At this point, the Alice scenario described earlier will work fine: The database will save a user record based on the first request, and it will reject the second save because the duplicate email address violates the uniqueness constraint. (An error will appear in the Rails log, but that doesnt do any harm.) Moreover, adding this index on the email attribute accomplishes a second goal, alluded to briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_4">Section 6.1.4</a>: As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#box6_2">Box 6.2</a>, the index on the <strong><span class="dark-green"><code>email</code></span></strong> attribute fixes a potential efficiency problem by preventing a full-table scan when finding users by email address.</p>
<section>
<h5 class="h5" id="lev65">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Add a test for the email downcasing from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex034">Listing 6.34</a>. This test uses the <strong><span class="dark-green"><code>reload</code></span></strong> method for reloading a value from the database and the <strong><span class="dark-green"><code>assert_equal</code></span></strong> method for testing equality. To verify that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex034">Listing 6.34</a> tests the right thing, comment out the <strong><span class="dark-green"><code>before_save</code></span></strong> line to get to <span class="red5"><small>RED</small></span>, then uncomment it to get to <span class="green5"><small>GREEN</small></span>.</p></li>
<li><p class="num">By running the test suite, verify that the <strong><span class="dark-green"><code>before_save</code></span></strong> callback can be written using the bang method <strong><span class="dark-green"><code>email.downcase!</code></span></strong> to modify the <strong><span class="dark-green"><code>email</code></span></strong> attribute directly, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex035">Listing 6.35</a>.</p></li>
</ol>
<p class="ex-title" id="ch06ex034"><strong>Listing 6.34:</strong> A test for the email downcasing from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a>.</p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0294-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0294-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="green1">test</span> <span class="maroon">"email addresses should be unique"</span> <strong><span class="green">do</span></strong>
    duplicate_user <span class="ash">=</span> <span class="violet">@user</span><span class="ash">.</span>dup
    <span class="violet">@user</span><span class="ash">.</span>save
    assert_not duplicate_user<span class="ash">.</span>valid?
  <strong><span class="green">end</span></strong>

<span class="mark">  <span class="green3">test</span> <span class="red2">"email addresses should be saved as lowercase"</span> <strong><span class="green3">do</span></strong></span>
<span class="mark">    mixed_case_email <span class="ash1">=</span> <span class="red2">"Foo@ExAMPle.CoM"</span></span>
<span class="mark">    <span class="blue1">@user</span><span class="ash1">.</span>email <span class="ash1">=</span> mixed_case_email</span>
<span class="mark">    <span class="blue1">@user</span><span class="ash1">.</span>save</span>
<span class="mark">    assert_equal mixed_case_email<span class="ash1">.</span>downcase, <span class="blue1">@user</span><span class="ash1">.</span>reload<span class="ash1">.</span>email</span>
  <strong><span class="green3">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="ex-title" id="ch06ex035"><strong>Listing 6.35:</strong> An alternative callback implementation. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0295-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0295-02a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
<span class="mark">  before_save { email<span class="ash1">.</span>downcase! }</span>
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> },
                    <span class="violet">uniqueness</span>: <strong><span class="green">true</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec6_3"><span epub:type="pagebreak" id="page_295"></span>6.3 Adding a Secure Password</h3>
<p class="noindent">Now that weve defined validations for the name and email fields, were ready to add the last of the basic User attributes: a secure password. The method is to require each user to have a password (with a password confirmation), and then store a <em>hashed</em> version of the password in the database. (There is some potential for confusion here. In the present context, a <em>hash</em> refers not to the Ruby data structure from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_3">Section 4.3.3</a> but rather to the result of applying an irreversible hash function to input data.) Well also add a way to <em>authenticate</em> a user based on a given password, a method well use in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a> to allow users to log in to the site.<span epub:type="pagebreak" id="page_296"></span></p>
<p class="indent">The method for authenticating users will be to take a submitted password, hash it, and compare the result to the hashed value stored in the database. If the two match, then the submitted password is correct and the user is authenticated. By comparing hashed values instead of raw passwords, we will be able to authenticate users without storing the passwords themselves. This means that, even if our database is compromised, our users passwords will still be secure.</p>
<section>
<h4 class="h4" id="sec6_3_1">6.3.1 A Hashed Password</h4>
<p class="noindent">Most of the secure password machinery will be implemented using a single Rails method called <strong><span class="dark-green"><code>has_secure_password</code></span></strong>, which well include in the User model as follows:</p>
<p class="codelink"><a id="pf0296-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0296-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
  has_secure_password
<strong><span class="green">end</span></strong></pre>
<p class="noindent">When included in a model as shown here, this one method adds the following functionality:</p>
<p class="bullet"> The ability to save a securely hashed <strong><span class="dark-green"><code>password_digest</code></span></strong> attribute to the database</p>
<p class="bullet"> A pair of virtual attributes<sup><a id="ch06fn19a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn19">19</a></sup> (<strong><span class="dark-green"><code>password</code></span></strong> and <strong><span class="dark-green"><code>password_confirmation</code></span></strong>), including presence validations upon object creation and a validation requiring that they match</p>
<p class="footnote"><a id="ch06fn19" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn19a">19</a>. In this context, <em>virtual</em> means that the attributes exist on the model object but do not correspond to columns in the database.</p>
<p class="bullet"> An <strong><span class="dark-green"><code>authenticate</code></span></strong> method that returns the user when the password is correct (and <strong><span class="dark-green"><code>false</code></span></strong> otherwise)</p>
<p class="indent">The only requirement for <strong><span class="dark-green"><code>has_secure_password</code></span></strong> to work its magic is for the corresponding model to have an attribute called <strong><span class="dark-green"><code>password_digest</code></span></strong>. (The name <em>digest</em> <span epub:type="pagebreak" id="page_297"></span>comes from the terminology of cryptographic hash functions. In this context, <em>hashed password</em> and <em>password digest</em> are synonyms.)<sup><a id="ch06fn20a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn20">20</a></sup> In the case of the User model, this leads to the data model shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig09">Figure 6.9</a>.</p>
<p class="footnote"><a id="ch06fn20" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn20a">20</a>. Hashed password digests are often erroneously referred to as <em>encrypted passwords</em>. For example, the source code of <strong><span class="dark-green"><code>has_secure_password</code></span></strong> makes this mistake, as did the first two editions of this tutorial. This terminology is wrong because by design encryption is <em>reversible</em>the ability to encrypt implies the ability to <em>decrypt</em> as well. In contrast, the whole point of calculating a passwords hash digest is to be <em>irreversible</em>, so that it is computationally intractable to infer the original password from the digest. (Thanks to reader Andy Philips for pointing out this issue and for encouraging me to fix the broken terminology.)</p>
<figure id="ch06fig09" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_09.jpg" alt="Image" width="559" height="314" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_09.jpg">
<figcaption><p><strong>Figure 6.9:</strong> The User data model with an added <strong><span class="dark-green"><code>password_digest</code></span></strong> attribute.</p></figcaption>
</figure>
<p class="indent">To implement the data model in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig09">Figure 6.9</a>, we first generate an appropriate migration for the <strong><span class="dark-green"><code>password_digest</code></span></strong> column. We can choose any migration name we want, but its convenient to end the name with <strong><span class="dark-green"><code>to_users</code></span></strong>, since in this case Rails automatically constructs a migration to add columns to the <strong><span class="dark-green"><code>users</code></span></strong> table. The result, with migration name <strong><span class="dark-green"><code>add_password_digest_to_users</code></span></strong>, appears as follows:</p>
<p class="codelink"><a id="pf0297-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0297-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">$</span></strong> rails generate migration add_password_digest_to_users password_digest:string</pre>
<p class="noindent">Here weve also supplied the argument <strong><span class="dark-green"><code>password_digest:string</code></span></strong> with the name and type of attribute we want to create. (Compare this to the original <span epub:type="pagebreak" id="page_298"></span>generation of the <strong><span class="dark-green"><code>users</code></span></strong> table in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex01">Listing 6.1</a>, which included the arguments <strong><span class="dark-green"><code>name: string</code></span></strong> and <strong><span class="dark-green"><code>email:string</code></span></strong>.) By including <strong><span class="dark-green"><code>password_digest:string</code></span></strong>, weve given Rails enough information to construct the entire migration for us, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex036">Listing 6.36</a>.</p>
<p class="ex-title" id="ch06ex036"><strong>Listing 6.36:</strong> The migration to add a <strong><span class="dark-green"><code>password_digest</code></span></strong> column.</p>
<pre class="pre2"><code>db/migrate/[timestamp]_add_password_digest_to_users.rb</code></pre>
<p class="codelink"><a id="pf0298-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0298-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">AddPasswordDigestToUsers</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveRecord</span><span class="ash">::</span><span class="red">Migration</span><span class="ash">[6.0]</span>
  <strong><span class="green">def</span></strong> <span class="blue3">change</span>
    add_column <span class="violet">:users</span>, <span class="violet">:password_digest</span>, <span class="violet">:string</span>
  <strong><span class="green">end</span></strong>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex036">Listing 6.36</a> uses the <strong><span class="dark-green"><code>add_column</code></span></strong> method to add a <strong><span class="dark-green"><code>password_digest</code></span></strong> column to the <strong><span class="dark-green"><code>users</code></span></strong> table. To apply it, we just migrate the database:</p>
<pre class="pre1">$ rails db:migrate</pre>
<p class="indent">To make the password digest, <strong><span class="dark-green"><code>has_secure_password</code></span></strong> uses a state-of-the-art hash function called bcrypt. By hashing the password with bcrypt, we ensure that attackers wont be able to log in to the site even if they manage to obtain a copy of the database. To use bcrypt in the sample application, we need to add the <code>bcrypt</code> gem to our <strong><span class="dark-green"><code>Gemfile</code></span></strong> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex037">Listing 6.37</a>).<sup><a id="ch06fn21a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn21">21</a></sup></p>
<p class="footnote"><a id="ch06fn21" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn21a">21</a>. As always, you should use the version numbers listed at <a href="http://gemfiles-6th-ed.railstutorial.org/">gemfiles-6th-ed.railstutorial.org</a> instead of the ones listed here.</p>
<p class="ex-title" id="ch06ex037"><strong>Listing 6.37:</strong> Adding <strong><span class="dark-green"><code>bcrypt</code></span></strong> to the <strong><span class="dark-green"><code>Gemfile</code></span></strong>.</p>
<p class="codelink"><a id="pf0298-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0298-02a">Click here to view code image</a></p>
<div class="example">
<pre>source <span class="maroon">'https://rubygems.org'</span>

gem <span class="maroon">'rails'</span>,          <span class="maroon">'6.0.2.1'</span>
<span class="mark">gem <span class="red2">'bcrypt',         '3.1.13'</span></span>
gem <span class="maroon">'bootstrap-sass'</span>, <span class="maroon">'3.4.1'</span>
<span class="ash">.</span>
<span class="ash">.</span>
<span class="ash">.</span></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_299"></span>Then run <strong><span class="dark-green"><code>bundle install</code></span></strong> as usual:</p>
<pre class="pre1"><strong><span class="navy">$</span></strong> bundle install</pre>
</section>
<section>
<h4 class="h4" id="sec6_3_2">6.3.2 User Has Secure Password</h4>
<p class="noindent">Now that weve supplied the User model with the required <strong><span class="dark-green"><code>password_digest</code></span></strong> attribute and installed bcrypt, were ready to add <strong><span class="dark-green"><code>has_secure_password</code></span></strong> to the User model, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex038">Listing 6.38</a>.</p>
<p class="ex-title" id="ch06ex038"><strong>Listing 6.38:</strong> Adding <strong><span class="dark-green"><code>has_secure_password</code></span></strong> to the User model. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0299-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0299-01a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  before_save { <span class="green">self</span><span class="ash">.</span>email <span class="ash">=</span> email<span class="ash">.</span>downcase }
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> },
                    <span class="violet">uniqueness</span>: <strong><span class="green">true</span></strong>
<span class="mark">  has_secure_password</span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">As indicated by the <span class="red5"><small>RED</small></span> indicator in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex038">Listing 6.38</a>, the tests are now failing, as you can confirm at the command line:</p>
<p class="ex-title" id="ch06ex039"><strong>Listing 6.39:</strong> <span class="red5"><small>RED</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">The reason is that, as noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3_1">Section 6.3.1</a>, <strong><span class="dark-green"><code>has_secure_password</code></span></strong> enforces validations on the virtual <strong><span class="dark-green"><code>password</code></span></strong> and <strong><span class="dark-green"><code>password_confirmation</code></span></strong> attributes, but the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex026">Listing 6.26</a> create an <strong><span class="dark-green"><code>@user</code></span></strong> variable without these attributes:</p>
<p class="codelink"><a id="pf0299-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0299-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="green">def</span></strong> <span class="blue3">setup</span>
  <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>)
<strong><span class="green">end</span></strong></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_300"></span>So, to get the test suite passing again, we just need to add a password and its confirmation, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex040">Listing 6.40</a>.</p>
<p class="ex-title" id="ch06ex040"><strong>Listing 6.40:</strong> Adding a password and its confirmation. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0300-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0300-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>,
<span class="mark">                     <span class="blue1">password:</span> <span class="red2">"foobar"</span>, <span class="blue1">password_confirmation:</span> <span class="red2">"foobar"</span>)</span>
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<strong><span class="green">end</span></strong>
</pre>
</div>
<p class="noindent">Note that the first line inside the <strong><span class="dark-green"><code>setup</code></span></strong> method includes an additional comma at the end, as required by Rubys hash syntax (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_3">Section 4.3.3</a>). Leaving this comma off will produce a syntax error, and you should use your technical sophistication (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#box1_2">Box 1.2</a>) to identify and resolve such errors if (or, more realistically, when) they occur.</p>
<p class="indent">At this point the tests should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch06ex041"><strong>Listing 6.41:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">In just a moment well see the benefits of adding <strong><span class="dark-green"><code>has_secure_password</code></span></strong> to the User model (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3_4">Section 6.3.4</a>), but first well add a minimal requirement on password security.</p>
<section>
<h5 class="h5" id="lev66">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Confirm that a user with a valid name and email still isnt valid overall.</p></li>
<li><p class="num">What are the error messages for a user with no password?<span epub:type="pagebreak" id="page_301"></span></p></li>
</ol>
</section>
</section>
<section>
<h4 class="h4" id="sec6_3_3">6.3.3 Minimum Password Standards</h4>
<p class="noindent">Its good practice in general to enforce some minimum standards on passwords to make them harder to guess. There are many options for enforcing password strength in Rails, but for simplicity well just enforce a minimum length and the requirement that the password not be blank. Picking a length of 6 as a reasonable minimum leads to the validation test shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex042">Listing 6.42</a>.</p>
<p class="ex-title" id="ch06ex042"><strong>Listing 6.42:</strong> Testing for a minimum password length. <span class="red5"><small>RED</small></span></p>
<pre class="pre2"><code>test/models/user_test.rb</code></pre>
<p class="codelink"><a id="pf0301-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0301-01a">Click here to view code image</a></p>
<div class="example">
<pre><span class="green1">require</span> <span class="maroon">'test_helper'</span>

<strong><span class="green">class</span></strong> <strong><span class="blue3">UserTest</span></strong> <span class="ash">&lt;</span> <span class="red">ActiveSupport</span><span class="ash">::</span><span class="red">TestCase</span>

  <strong><span class="green">def</span></strong> <span class="blue3">setup</span>
    <span class="violet">@user</span> <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>new(<span class="green1">name</span>: <span class="maroon">"Example User"</span>, <span class="violet">email</span>: <span class="maroon">"user@example.com"</span>,
                     <span class="violet">password</span>: <span class="maroon">"foobar"</span>, <span class="violet">password_confirmation</span>: <span class="maroon">"foobar"</span>)
  <strong><span class="green">end</span></strong>
  <span class="ash">.</span>
  <span class="ash">.</span>
  <span class="ash">.</span>
<span class="mark">  <span class="green3">test</span> <span class="red2">"password should be present (nonblank)"</span> <strong><span class="green3">do</span></strong></span>
<span class="mark">    <span class="blue1">@user</span><span class="ash1">.</span>password <span class="ash1">=</span> <span class="blue1">@user</span><span class="ash1">.</span>password_confirmation <span class="ash1">=</span> <span class="red2">" "</span> <span class="ash1">* 6</span></span>
<span class="mark">    assert_not <span class="blue1">@user</span><span class="ash1">.</span>valid?</span>
<span class="mark">  <strong><span class="green3">end</span></strong></span>

<span class="mark">  <span class="green3">test</span> <span class="red2">"password should have a minimum length"</span> <strong><span class="green3">do</span></strong></span>
<span class="mark">    <span class="blue1">@user</span><span class="ash1">.</span>password <span class="ash1">=</span> <span class="blue1">@user</span><span class="ash1">.</span>password_confirmation <span class="ash1">=</span> <span class="red2">"a"</span> <span class="ash1">* 5</span></span>
<span class="mark">    assert_not <span class="blue1">@user</span><span class="ash1">.</span>valid?</span>
<span class="mark">  <strong><span class="green3">end</span></strong></span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="noindent">Note the use of the compact multiple assignment</p>
<p class="codelink"><a id="pf0301-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0301-02a">Click here to view code image</a></p>
<pre class="pre1"><span class="violet">@user</span><span class="ash">.</span>password <span class="ash">=</span> <span class="violet">@user</span><span class="ash">.</span>password_confirmation <span class="ash">=</span> <span class="maroon">"a"</span> <span class="ash">* 5</span></pre>
<p class="noindent">in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex042">Listing 6.42</a>. This arranges to assign a particular value to the password and its confirmation at the same time (in this case, a string of length 5, constructed using string multiplication as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex014">Listing 6.14</a>).<span epub:type="pagebreak" id="page_302"></span></p>
<p class="indent">You may be able to guess the code for enforcing a <strong><span class="dark-green"><code>minimum</code></span></strong> length constraint by referring to the corresponding <strong><span class="dark-green"><code>maximum</code></span></strong> validation for the users name (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex016">Listing 6.16</a>):</p>
<p class="codelink"><a id="pf0302-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0302-01a">Click here to view code image</a></p>
<pre class="pre1">validates <span class="violet">:password</span>, <span class="violet">length</span>: { <span class="violet">minimum</span>: <span class="ash">6</span> }</pre>
<p class="noindent">Combining this with a <strong><span class="dark-green"><code>presence</code></span></strong> validation (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_2_2">Section 6.2.2</a>) to ensure non-blank passwords, this leads to the User model shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex043">Listing 6.43</a>. (It turns out the <strong><span class="dark-green"><code>has_ secure_password</code></span></strong> method includes a presence validation, but unfortunately it applies only to records with <em>empty</em> passwords, which allows users to create invalid passwords like <strong><span class="dark-green"><code>'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'</code></span></strong> (six spaces).)</p>
<p class="ex-title" id="ch06ex043"><strong>Listing 6.43:</strong> The complete implementation for secure passwords. <span class="green5"><small>GREEN</small></span></p>
<pre class="pre2"><code>app/models/user.rb</code></pre>
<p class="codelink"><a id="pf0302-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0302-02a">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="green">class</span></strong> <strong><span class="blue3">User</span></strong> <span class="ash">&lt;</span> <span class="red">ApplicationRecord</span>
  before_save { <span class="green">self</span><span class="ash">.</span>email <span class="ash">=</span> email<span class="ash">.</span>downcase }
  validates <span class="violet">:name</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">50</span> }
  <span class="red">VALID_EMAIL_REGEX</span> <span class="ash">=</span> <span class="red6">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="violet">:email</span>, <span class="violet">presence</span>: <strong><span class="green">true</span></strong>, <span class="violet">length</span>: { <span class="violet">maximum</span>: <span class="ash">255</span> },
                    <span class="green1">format</span>: { <span class="violet">with</span>: <span class="red">VALID_EMAIL_REGEX</span> },
                    <span class="violet">uniqueness</span>: <strong><span class="green">true</span></strong>
  has_secure_password
<span class="mark">  validates <span class="blue1">:password</span>, <span class="blue1">presence</span>: <strong><span class="green3">true</span></strong>, <span class="blue1">length</span>: { <span class="blue1">minimum</span>: <span class="ash1">6</span> }</span>
<strong><span class="green">end</span></strong></pre>
</div>
<p class="indent">At this point, the tests should be <span class="green5"><small>GREEN</small></span>:</p>
<p class="ex-title" id="ch06ex044"><strong>Listing 6.44:</strong> <span class="green5"><small>GREEN</small></span></p>
<div class="example">
<pre>$ rails test:models</pre>
</div>
<section>
<h5 class="h5" id="lev67">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Confirm that a user with a valid name and email but a too-short password isnt valid.</p></li>
<li><p class="num">What are the associated error messages?<span epub:type="pagebreak" id="page_303"></span></p></li>
</ol>
</section>
</section>
<section>
<h4 class="h4" id="sec6_3_4">6.3.4 Creating and Authenticating a User</h4>
<p class="noindent">Now that the basic User model is complete, well create a user in the database as preparation for making a page to show the users information in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_1">Section 7.1</a>. Well also take a more concrete look at the effects of adding <strong><span class="dark-green"><code>has_secure_password</code></span></strong> to the User model, including an examination of the important <strong><span class="dark-green"><code>authenticate</code></span></strong> method.</p>
<p class="indent">Since users cant yet sign up for the sample application through the webthats the goal of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>well use the Rails console to create a new user by hand. For convenience, well use the <strong><span class="dark-green"><code>create</code></span></strong> method discussed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_3">Section 6.1.3</a>, but in the present case well take care <em>not</em> to start in a sandbox so that the resulting user will be saved to the database. This means starting an ordinary <strong><span class="dark-green"><code>rails console</code></span></strong> session and then creating a user with a valid name and email address together with a valid password and matching confirmation:</p>
<p class="codelink"><a id="pf0303-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0303-01a">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ rails console</span>
<strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>create(<span class="green1">name</span>: <span class="maroon">"Michael Hartl"</span>, <span class="violet">email</span>: <span class="maroon">"michael@example.com"</span>,
<strong><span class="navy">?&gt;</span></strong>             <span class="violet">password</span>: <span class="maroon">"foobar"</span>, <span class="violet">password_confirmation</span>: <span class="maroon">"foobar"</span>)
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 03:15:38", updated_at: "2019-08-22 03:15:38",</span>
<span class="green">password_digest: [FILTERED]&gt;</span></pre>
<p class="noindent">To check that this worked, lets look at the resulting <strong><span class="dark-green"><code>users</code></span></strong> table in the development database using DB Browser for SQLite, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig010">Figure 6.10</a>.<sup><a id="ch06fn22a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn22">22</a></sup> (If youre using the cloud IDE, you should download the database file as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig05">Figure 6.5</a>.) Note that the columns correspond to the attributes of the data model defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fig09">Figure 6.9</a>.</p>
<p class="footnote"><a id="ch06fn22" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn22a">22</a>. If for any reason something went wrong, you can always reset the database as follows:</p>
<ol class="num">
<li><p class="num">Quit the console.</p></li>
<li><p class="num">Run <strong><span class="dark-green"><code>$ rm -f development.sqlite3</code></span></strong> at the command line to remove the database. (Well learn a more elegant method for doing this in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>.)</p></li>
<li><p class="num">Rerun the migrations using <strong><span class="dark-green"><code>$ rails db:migrate</code></span></strong>.</p></li>
<li><p class="num">Restart the console.</p></li>
</ol>
<figure id="ch06fig010" class="image-l">
<img src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/fig06_10.jpg" alt="Image" width="677" height="422" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig06_10.jpg">
<figcaption><p><strong>Figure 6.10:</strong> A user row in the SQLite database <strong><span class="dark-green"><code>db/development.sqlite3</code></span></strong>.</p></figcaption>
</figure>
<p class="indent">Returning to the console, we can see the effect of <strong><span class="dark-green"><code>has_secure_password</code></span></strong> from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex043">Listing 6.43</a> by looking at the <strong><span class="dark-green"><code>password_digest</code></span></strong> attribute:<span epub:type="pagebreak" id="page_304"></span></p>
<p class="codelink"><a id="pf0304-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0304-01a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user <span class="ash">=</span> <span class="red">User</span><span class="ash">.</span>find_by(<span class="violet">email</span>: <span class="maroon">"michael@example.com"</span>)
<strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>password_digest
<span class="green">=&gt; "$2a$12$WgjER5ovLFjC2hmCItmbTe6nAXzT3bO66GiAQ83Ev03eVp32zyNYG"</span></pre>
<p class="noindent">This is the hashed version of the password (<strong><span class="dark-green"><code>"foobar"</code></span></strong>) used to initialize the user object. Because its constructed using bcrypt, it is computationally impractical to use the digest to discover the original password.<sup><a id="ch06fn23a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn23">23</a></sup></p>
<p class="footnote"><a id="ch06fn23" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06fn23a">23</a>. By design, the bcrypt algorithm produces a <em>salted hash</em>, which protects against two important classes of attacks (dictionary attacks and rainbow table attacks).</p>
<p class="indent">As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3_1">Section 6.3.1</a>, <strong><span class="dark-green"><code>has_secure_password</code></span></strong> automatically adds an <strong><span class="dark-green"><code>authenticate</code></span></strong> method to the corresponding model objects. This method determines if a given password is valid for a particular user by computing its digest and comparing the result to <strong><span class="dark-green"><code>password_digest</code></span></strong> in the database. In the case of the user we just created, we can try a couple of invalid passwords as follows:</p>
<p class="codelink"><a id="pf0305-01-z" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0305-01-za">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>authenticate(<span class="maroon">"not_the_right_password"</span>)
<span class="green">false</span>
<span epub:type="pagebreak" id="page_305"></span><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>authenticate(<span class="maroon">"foobaz"</span>)
<span class="green">false</span></pre>
<p class="noindent">Here <strong><span class="dark-green"><code>user.authenticate</code></span></strong> returns <strong><span class="dark-green"><code>false</code></span></strong> for an invalid password. If we instead authenticate with the correct password, <strong><span class="dark-green"><code>authenticate</code></span></strong> returns the user itself:</p>
<p class="codelink"><a id="pf0305-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0305-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> user<span class="ash">.</span>authenticate(<span class="maroon">"foobar"</span>)
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 03:15:38", updated_at: "2019-08-22 03:15:38",</span>
<span class="green">password_digest: [FILTERED]&gt;</span></pre>
<p class="noindent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a>, well use the <strong><span class="dark-green"><code>authenticate</code></span></strong> method to sign registered users into our site. In fact, it will turn out not to be important to us that <strong><span class="dark-green"><code>authenticate</code></span></strong> returns the user itself; all that will matter is that it returns a value that is <strong><span class="dark-green"><code>true</code></span></strong> in a boolean context. Recalling from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_2_2">Section 4.2.2</a> that <strong><span class="dark-green"><code>!!</code></span></strong> converts an object to its corresponding boolean value, we can see that <strong><span class="dark-green"><code>user.authenticate</code></span></strong> does the job nicely:</p>
<p class="codelink"><a id="pf0305-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0305-03a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">&gt;&gt;</span></strong> <span class="ash">!!</span>user<span class="ash">.</span>authenticate(<span class="maroon">"foobar"</span>)
<span class="green">=&gt; true</span>
</pre>
<section>
<h5 class="h5" id="lev68">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Quit and restart the console, and then find the user created in this section.</p></li>
<li><p class="num">Try changing the name by assigning a new name and calling <strong><span class="dark-green"><code>save</code></span></strong>. Why didnt it work?</p></li>
<li><p class="num">Update <strong><span class="dark-green"><code>user</code></span></strong>s name to use your name. <em>Hint</em>: The necessary technique is covered in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_5">Section 6.1.5</a>.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec6_4">6.4 Conclusion</h3>
<p class="noindent">Starting from scratch, in this chapter we created a working User model with name, email, and password attributes, together with validations enforcing several important constraints on their values. In addition, we have the ability to securely authenticate <span epub:type="pagebreak" id="page_306"></span>users using a given password. This is a remarkable amount of functionality for only 12 lines of code.</p>
<p class="indent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">Chapter 7</a>, well make a working signup form to create new users, together with a page to display each users information. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a>, well then use the authentication machinery from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3">Section 6.3</a> to let users log into the site.</p>
<p class="indent">If youre using Git, now would be a good time to commit if you havent done so in a while:</p>
<p class="codelink"><a id="pf0306-01" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0306-01a">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git add -A
$ git commit -m "Make a basic User model (including secure passwords)"</pre>
<p class="noindent">Then merge back into the master branch and push to the remote repository:</p>
<p class="codelink"><a id="pf0306-02" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0306-02a">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="navy">$</span></strong> git checkout master
<strong><span class="navy">$</span></strong> git merge modeling-users
<strong><span class="navy">$</span></strong> git push</pre>
<p class="indent">To get the User model working in production, we need to run the migrations at Heroku, which we can do with <strong><span class="dark-green"><code>heroku run</code></span></strong>:</p>
<p class="codelink"><a id="pf0306-03" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0306-03a">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git push heroku
$ heroku run rails db:migrate</pre>
<p class="noindent">We can verify that this worked by running a console in production:</p>
<p class="codelink"><a id="pf0306-04" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06_images.xhtml#pf0306-04a">Click here to view code image</a></p>
<pre class="pre1"><span class="green">$ heroku run rails console --sandbox</span>
<strong><span class="navy">&gt;&gt;</span></strong> <span class="red">User</span><span class="ash">.</span>create(<span class="green1">name</span>: <span class="maroon">"Michael Hartl"</span>, <span class="violet">email</span>: <span class="maroon">"michael@example.com"</span>,
<strong><span class="navy">?&gt;</span></strong>             <span class="violet">password</span>: <span class="maroon">"foobar"</span>, <span class="violet">password_confirmation</span>: <span class="maroon">"foobar"</span>)
<span class="green">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="green">created_at: "2019-08-22 03:20:06", updated_at: "2019-08-22 03:20:06",</span>
<span class="green">password_digest: [FILTERED]&gt;</span></pre>
<section>
<h4 class="h4" id="sec6_4_1">6.4.1 What We Learned in this Chapter</h4>
<p class="bullet"> Migrations allow us to modify our applications data model.</p>
<p class="bullet"> Active Record comes with a large number of methods for creating and manipulating data models.<span epub:type="pagebreak" id="page_307"></span></p>
<p class="bullet"> Active Record validations allow us to place constraints on the data in our models.</p>
<p class="bullet"> Common validations include presence, length, and format.</p>
<p class="bullet"> Regular expressions are cryptic but powerful.</p>
<p class="bullet"> Defining a database index improves lookup efficiency while allowing enforcement of uniqueness at the database level.</p>
<p class="bullet"> We can add a secure password to a model using the built-in <strong><span class="dark-green"><code>has_secure_password</code></span></strong> method.<span epub:type="pagebreak" id="page_308"></span></p>
</section>
</section>
</section>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-8" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 5. Filling in the Layout</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 7. Sign Up</div>
        </a>
    
  
  </div>

</section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed slideUp">
        
        
          <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        

        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
  <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)" style="display: block;"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright"> 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(1)" charset="utf-8"></script><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/embed.js.download"></script>
    <script src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(2)" charset="utf-8"></script>
  

<div></div><div></div><div class="selection_bubble_root" style="display: none;"></div><div class="annotator-notice"></div><div class="font-flyout" style="top: 201.006px; left: 1194.34px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#">Reset</a>
</div>
</div><script type="text/javascript" async="" src="./Chapter 6. Modeling Users - Ruby on Rails Tutorial, 6th Edition_files/generic1604331345324.js.download" charset="UTF-8"></script><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script><span></span><script type="text/javascript" id="">dataLayer.push({"ld.experiment":void 0,"ld.variation":void 0});</script></body></html>