<!DOCTYPE html>
<!-- saved from url=(0080)https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage no-applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/ruby-on-rails/9780136702726/ch10.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="10224494" data-user-uuid="66943332-5511-462c-876e-5d5b720c7edf" data-username="czjtgu3dkobug4zdmolfga2wembsmu" data-account-type="Trial" data-activated-trial-date="12/02/2020" data-archive="9780136702726" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch10.xhtml" data-epub-title="Ruby on Rails Tutorial, 6th Edition" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780136702726"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/css" rel="stylesheet" type="text/css"><title>Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition</title><link rel="stylesheet" href="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/output.731fc84c4f9a.css" type="text/css"><link rel="stylesheet" type="text/css" href="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/font-awesome.min.css"><style type="text/css" title="ibis-book">@page{margin:1em 2em}#sbo-rt-content div{margin-top:1em;margin-bottom:1em;margin-left:1em;margin-right:1em;text-align:justify}#sbo-rt-content div.cover img{max-width:99%;max-height:99%}#sbo-rt-content .att{text-align:right}#sbo-rt-content .cover{margin-top:.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .h1{margin-top:1.5em;margin-bottom:.5em;font-weight:bold;font-size:210%;page-break-after:avoid;border-bottom:solid .1em;text-align:center}#sbo-rt-content .halftitle{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:210%;page-break-after:avoid;text-align:center}#sbo-rt-content .h2{margin-top:1em;margin-bottom:.1em;font-weight:bold;font-size:180%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2f{margin-top:1em;margin-bottom:2.5em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2t{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .center{text-align:center}#sbo-rt-content .h3{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:160%;page-break-after:avoid;text-align:left}#sbo-rt-content .h4{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:130%;page-break-after:avoid;text-align:left}#sbo-rt-content .h5{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:120%;page-break-after:avoid;text-align:left}#sbo-rt-content ul{margin-top:1em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content ul.sq{list-style-type:square}#sbo-rt-content ul.sq li p,#sbo-rt-content ul.sq li p.noindent{margin-top:.5em;margin-left:1em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .left{text-align:left}#sbo-rt-content .ex-title{margin-top:.8em;margin-bottom:.5em;text-indent:.1em;font-size:100%}#sbo-rt-content code{font-family:Courier,Courier New,monospace;font-size:small}#sbo-rt-content pre{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small}#sbo-rt-content .pre3{font-family:Courier,Courier New,monospace;margin-top:1em;margin-bottom:1em;margin-left:2.9em;background-color:#E6E6E6}#sbo-rt-content .equ{margin-top:.8em;margin-bottom:.5em;text-align:center}#sbo-rt-content .footnum{margin-top:.7em;margin-bottom:.5em;text-indent:-1em;margin-left:3.3em}#sbo-rt-content .footnotep{margin-top:.8em;margin-left:.8em;margin-bottom:.5em;text-indent:.8em}#sbo-rt-content .mark1{background-color:#F4F7F9}#sbo-rt-content .codelink{margin-top:.2em;margin-bottom:.5em}#sbo-rt-content .middle img{vertical-align:middle}#sbo-rt-content .box{margin-top:.6em;margin-bottom:1em;margin-left:.1em;margin-right:.8em;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .box-bq{font-size:.8em;margin-top:.8em;margin-bottom:.5em;margin-left:1.6em;text-indent:.1em;background-color:#E6E6E6}#sbo-rt-content .boxip{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:.8em;background-color:#E6E6E6}#sbo-rt-content ol.num{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p,#sbo-rt-content ol.num li p.number{margin-top:.5em;margin-left:.2em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .num-p{margin-top:.5em;margin-bottom:.5em;margin-left:0}#sbo-rt-content .bullet{margin-top:.7em;margin-bottom:.5em;text-indent:-.8em;margin-left:2em}#sbo-rt-content .credit{margin-top:.1em;margin-bottom:.1em;text-indent:-1.5em;margin-left:2em}#sbo-rt-content .box-caption{margin-top:.1em;margin-bottom:1em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:left}#sbo-rt-content .example{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small;border-top:.02em solid black;border-bottom:.02em solid black}#sbo-rt-content .image-l{margin-top:.8em;margin-left:1em;text-align:center}#sbo-rt-content .topbot{margin-top:.8em;margin-bottom:.5em;border-bottom:solid black .1em;border-top:solid black .1em;text-indent:.1em}#sbo-rt-content .uln{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash1{margin-top:.7em;margin-bottom:.7em;margin-left:3em}#sbo-rt-content .tr{border-bottom:.1em solid black}#sbo-rt-content th{text-align:left}#sbo-rt-content td{padding-left:.1em;padding-top:0;padding-bottom:0;vertical-align:top;text-align:left}#sbo-rt-content .mark{background-color:#E6E6E6}#sbo-rt-content .pre1{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:0;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .pre2{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content .tab-thc{margin-top:.1em;margin-bottom:.1em;border-bottom:solid black .1em;text-align:center}#sbo-rt-content .tab-th{margin-top:.1em;border-bottom:solid black .1em;border-top:solid black .1em;text-align:left}#sbo-rt-content .author{margin-top:2.5em;margin-bottom:5.5em;text-align:center;font-size:120%}#sbo-rt-content .pub{margin-top:1.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .pub1{font-weight:bold;font-size:.9em;margin-top:.1em;margin-bottom:.5em;text-align:center}#sbo-rt-content .copy{margin-top:.9em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .copy1{margin-top:.9em;margin-bottom:.2em;text-indent:.02em}#sbo-rt-content .copy2{margin-top:.2em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .title{margin-top:1em;margin-bottom:.2em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:center}#sbo-rt-content .noindent{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .tab-para{margin-top:.1em;margin-bottom:.1em;margin-left:.1em;text-indent:0}#sbo-rt-content .tab-parai{margin-top:.1em;margin-bottom:.1em;margin-left:1.1em;text-indent:-1.1em}#sbo-rt-content .boxnp{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .toc-intro{margin-top:.1em;margin-bottom:.5em;margin-left:1.5em;text-align:left}#sbo-rt-content .tocchap{margin-top:1.5em;margin-bottom:.4em;margin-left:3.4em;text-indent:-4em}#sbo-rt-content .toclev1{margin-top:.4em;margin-bottom:.4em;margin-left:1em}#sbo-rt-content .toclev2{margin-top:.4em;margin-bottom:.4em;margin-left:2.6em}#sbo-rt-content .toclev1a{margin-top:.4em;margin-bottom:.4em;margin-left:.5em}#sbo-rt-content .toc-index{margin-top:2em;margin-bottom:.4em;margin-left:.7em}#sbo-rt-content .indexmain{margin-top:.4em;margin-bottom:.2em;margin-left:.8em;text-indent:-.8em}#sbo-rt-content .indexsub{margin-top:.4em;margin-bottom:.2em;margin-left:1.7em;text-indent:-.7em}#sbo-rt-content .indexsubsub{margin-top:.4em;margin-bottom:.2em;font-style:italic;margin-left:3em;text-indent:-.9em}#sbo-rt-content figcaption{margin-top:.8em;margin-bottom:.5em;color:black;text-align:left;text-indent:.1em}#sbo-rt-content .subtitle{margin-top:.1em;margin-bottom:1em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .edition{margin-top:2em;margin-bottom:3em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .indent{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:1.5em}#sbo-rt-content .h2a{margin-top:.1em;margin-bottom:2em;font-weight:bold;font-size:190%;page-break-after:avoid;text-align:left}#sbo-rt-content figure>img{max-width:99%;max-height:99%}#sbo-rt-content figure{margin-top:1em;margin-bottom:1em;margin-left:.5em;margin-right:1.5em}#sbo-rt-content none{list-style-type:none}#sbo-rt-content a{text-decoration:none}#sbo-rt-content .footnote{font-size:.8em;margin-top:.1em;margin-bottom:.5em;margin-left:.8em}#sbo-rt-content .none{margin-top:.5em;margin-left:1em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content div.image-p img{width:80%}#sbo-rt-content .image-p{page-break-before:always;text-align:center}#sbo-rt-content table{border-collapse:collapse;border-spacing:0;background:transparent;vertical-align:top;margin-top:.1em;margin-right:.1em;margin-bottom:.9em;margin-left:0;width:100%}#sbo-rt-content .tab-parar{margin-top:.1em;margin-bottom:.1em;text-indent:.1em;text-align:right}#sbo-rt-content .h2i{margin-top:1em;margin-bottom:2.1em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content pre{overflow:auto;-ms-overflow:auto;-moz-overflow:auto;-webkit-overflow:auto;-ms-padding-bottom:5pt;-moz-padding-bottom:5pt;-webkit-padding-bottom:5pt}#sbo-rt-content .maroon{color:#BB2121}#sbo-rt-content .green{color:#005A00}#sbo-rt-content .green1{color:#48785D}#sbo-rt-content .navy{color:#504B72}#sbo-rt-content .ash{color:#666}#sbo-rt-content .blue{color:#408080}#sbo-rt-content .green3{color:#00A100}#sbo-rt-content .blue1{color:#0000B8}#sbo-rt-content .violet{color:#1A177D}#sbo-rt-content .pink{color:#A131A1}#sbo-rt-content .pink1{color:#A131A1}#sbo-rt-content .red{color:#800}#sbo-rt-content .blue3{color:#2E3192}#sbo-rt-content .red2{color:#B80000}#sbo-rt-content .green4{color:#269200}#sbo-rt-content .ash1{color:#666}#sbo-rt-content .ash2{color:#33484A}#sbo-rt-content .red2{color:#640000}#sbo-rt-content .ash3{color:#7D8F29}#sbo-rt-content .red5{color:#BD7B00}#sbo-rt-content .maroon1{color:#B66600}#sbo-rt-content .blue5{color:#1F3BFF}#sbo-rt-content .red6{color:#B68}#sbo-rt-content .green7{color:#14B600}#sbo-rt-content .maroon2{color:#B66600}#sbo-rt-content .pink2{color:#AC21FF}#sbo-rt-content .pink3{color:#AC21FF}#sbo-rt-content .lighgreen{color:#5FA100}#sbo-rt-content .lighblue{color:#269271}#sbo-rt-content .darkmaroon{color:#269271}#sbo-rt-content .maroon5{color:#A10000}#sbo-rt-content .blue6{color:#0000B9}#sbo-rt-content .marko{background-color:#FAF9CE}#sbo-rt-content .green5{color:#1C8B43}#sbo-rt-content .colork1{color:#136433;font-weight:bold}#sbo-rt-content .colork2{color:#504C72}#sbo-rt-content .colork3{color:#51785D}#sbo-rt-content .colork4{color:#303192}#sbo-rt-content .colork5{color:#955744}#sbo-rt-content .colork6{color:#5C70BA}#sbo-rt-content .colork7{color:#487864}#sbo-rt-content .colork8{color:#5C5778}#sbo-rt-content .colork9{color:#666}#sbo-rt-content .colork10{color:#48785D}#sbo-rt-content .colork11{color:#BC654D}#sbo-rt-content .colork12{color:#3E8185}#sbo-rt-content .colork13{color:#C62425}#sbo-rt-content .colork14{color:#1D8C43}#sbo-rt-content .colork15{color:#0D8140}#sbo-rt-content .colork16{color:#BB2425}#sbo-rt-content .colork17{color:#985744}#sbo-rt-content .colork18{color:#6C8896}#sbo-rt-content .colork19{color:#2A2C80}#sbo-rt-content .colork20{color:#BD2425}#sbo-rt-content .redk1{color:#EE1C25}#sbo-rt-content .colork21{color:#2A2C77}#sbo-rt-content .colork22{color:#955744}#sbo-rt-content .colork23{color:#BC6561}#sbo-rt-content .colork24{color:#BE7D2B}#sbo-rt-content .colork25{color:#8E7C5D}#sbo-rt-content .colork26{color:#7C5778}#sbo-rt-content .colork27{color:#9D1C1F}#sbo-rt-content .colork28{color:#AA5744}#sbo-rt-content .colork29{color:#C59861}#sbo-rt-content .grayk1{color:#C0908E}#sbo-rt-content .pd_green{color:#48785d}#sbo-rt-content .dark-green{color:#146333}#sbo-rt-content .mark1{background-color:#faf9ce}#sbo-rt-content .mark{background-color:#faf9ce}#sbo-rt-content .pd_ash{color:#666}#sbo-rt-content .pd_blue7{color:#6c8896}#sbo-rt-content .pd_blue1{color:#504b72}#sbo-rt-content .pd_red{color:#965744}#sbo-rt-content .pd_red2{color:#bb654e}#sbo-rt-content .pd_red5{color:#ed1c24}#sbo-rt-content .pd_blue5{color:#2e3192}#sbo-rt-content .pd_green4{color:#269200}#sbo-rt-content .pd_green5{color:#1c8b43}#sbo-rt-content .pd_blue3{color:#2c2c78}#sbo-rt-content .pd_orange{color:#c49847}</style><script type="text/javascript" async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/cool-2.1.15.min.js.download"></script><script type="text/javascript" async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/ec.js.download"></script><script type="text/javascript" async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/analytics.js.download"></script><script type="text/javascript" async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/f.txt"></script><script type="text/javascript" async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/js"></script><script crossorigin="anonymous" integrity="sha256-NiDMmov61Y536X/eLXLiDGzFVFmNLtPyu4b5aFB54ks=" type="text/javascript" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/appcues.main.11e38ef4746fd64ab30c11794299d10b30bcb704.js.download" async=""></script><script async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/gtm.js.download"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780136702726/chapter/ch10.xhtml",
          "book_id": "9780136702726",
          "chapter_uri": "ch10.xhtml",
          "position": 27.4567491080775,
          "user_uuid": "66943332-5511-462c-876e-5d5b720c7edf",
          "next_chapter_uri": "/library/view/ruby-on-rails/9780136702726/ch11.xhtml"
        
      },
      title: "Ruby on Rails Tutorial, 6th Edition",
      author_list: "Michael Hartl",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: true
    };
    // ]]></script><script src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/modernizr.8e35451ddb64.js.download"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta name="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta property="og:title" content="Chapter 10. Updating, Showing, and Deleting Users"><meta itemprop="isPartOf" content="/library/view/ruby-on-rails/9780136702726/"><meta itemprop="name" content="Chapter 10. Updating, Showing, and Deleting Users"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780136702726/"><meta property="og:description" itemprop="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9780136702726"><meta property="og:book:author" itemprop="author" content="Michael Hartl"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '66943332-5511-462c-876e-5d5b720c7edf';
      dataLayer.push({userIdentifier: '66943332-5511-462c-876e-5d5b720c7edf'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = 'ba5f3401-307d-4b66-90a6-a97047c63525';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/vendor.3eecedff6f59.js.download"></script><script defer="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/reader.772cf1e31d6c.js.download"></script><iframe src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/saved_resource.html"></iframe><iframe src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(3).html"></iframe><iframe src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(4).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-q9sKb2HpA5fJjN1cK9LjLaEXff5ix81Rv1Y3xJFptPE=" crossorigin="anonymous" href="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/container.11e38ef4746fd64ab30c11794299d10b30bcb704.css"><iframe src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(5).html"></iframe><script src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/f(1).txt"></script><script async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/MathJax.js.download"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
</style><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style></head>


<body class="reading sidenav  scalefonts subscribe-panel library nav-collapsed"><div id="MathJax_Message" style="display: none;"></div>

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="working hide" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/66943332-5511-462c-876e-5d5b720c7edf/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Attend</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/live-training/" class="l2 nav-icn"><span>Live Trainings</span></a></li><li><a href="https://learning.oreilly.com/featured/architectural-katas" class="l2 nav-icn"><span>Architectural Katas</span></a></li><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interact</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/?classification=content-scenario" class="l2 nav-icn"><span>Scenarios</span></a></li><li><a href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario" class="l2 nav-icn"><span>Sandboxes</span></a></li><li><a href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li><a href="https://learning.oreilly.com/answers/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"></path></svg><span>Answers</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://learning.oreilly.com/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Ruby on Rails Tutorial, 6th Edition
      
    </h1></span></a><div class="toc-contents" style="max-height: 0px;">
  <div class="sbo-toc">
    <button type="button" class="sbo-toc-thumb close"><div class="visuallyhidden">Close</div></button>
      <section class="ios-app-teaser">
        <ul>
            <li><a class="js-toc-link toc-link" href="https://itunes.apple.com/gb/app/safari-queue-library-over/id881697395?mt=8" role="button">Install App</a></li>
            <li><a class="js-toc-link toc-link" href="safaridetail://9780136702726" role="button">Open in App</a></li>
        </ul>
      </section>
      <div class="sbo-book-meta">
        
        <span class="cover">
         <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">
          <img src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/saved_resource" alt="Cover image for Ruby on Rails Tutorial, 6th Edition" height="184" width="141">
        </a>
        </span>
        <span class="title">
          
            
                <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
                  <img src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/addison-wesley.png" class="publisher-logo video" alt="publisher logo">
                </a>
            
          

          <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">Ruby on Rails Tutorial, 6th Edition</a>
        </span>
        
        <span class="authors">by Michael Hartl</span>
        

        
        <span class="publishers t-publishers">Published by
          <!-- Show publisher page link if publisher pages switch is on -->
          
            <a class="t-publisher-link toc-link js-toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
              Addison-Wesley Professional</a>, 2020
          
        </span>
        

    

    </div>
  <ol class="tocList">
    
    
    
     

     <li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/cover.xhtml">
        Cover Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref00.xhtml">
        About This eBook <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/halftitle.xhtml">
        Halftitle Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/title.xhtml">
        Title Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/copy.xhtml">
        Copyright Page <span class="minutes">(02:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/toc.xhtml#toc">
        Contents <span class="minutes">(05:45 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref02.xhtml#pref02">
        Foreword <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref03.xhtml#pref03">
        Acknowledgments <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref04.xhtml#pref04">
        About the Author <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#ch01">
        Chapter 1. From Zero to Deploy <span class="minutes">(77:03 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">
        Chapter 2. A Toy App <span class="minutes">(50:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03">
        Chapter 3. Mostly Static Pages <span class="minutes">(63:15 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04">
        Chapter 4. Rails-Flavored Ruby <span class="minutes">(57:30 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">
        Chapter 5. Filling in the Layout <span class="minutes">(60:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">
        Chapter 6. Modeling Users <span class="minutes">(67:51 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">
        Chapter 7. Sign Up <span class="minutes">(79:21 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">
        Chapter 8. Basic Login <span class="minutes">(66:42 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">
        Chapter 9. Advanced Login <span class="minutes">(52:54 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1 currently-reading">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">
        Chapter 10. Updating, Showing, and Deleting Users <span class="minutes">(73:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">
        Chapter 11. Account Activation <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">
        Chapter 12. Password Reset <span class="minutes">(48:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">
        Chapter 13. User Microposts <span class="minutes">(106:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">
        Chapter 14. Following Users <span class="minutes">(78:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml#index">
        Index <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/credits.xhtml#credits">
        Credits <span class="minutes">(19:33 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01_images.xhtml#ch01_images">
        Code Snippets <span class="minutes">(09:12 mins)</span>
       </a>
      
        
      
   </li></ol>
 </div>



</div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780136702726/chapter/ch10.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li class="currently-reading"><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml&amp;text=Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition&amp;via=OReillyMedia"><span>Twitter</span></a></li><li class="currently-reading"><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Facebook</span></a></li><li class="currently-reading"><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Google Plus</span></a></li><li class="currently-reading"><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Chapter%2010.%20Updating%2C%20Showing%2C%20and%20Deleting%20Users&amp;body=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml%0D%0Afrom%20Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document"><script src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/48743.js.download"></script>
<script>
  var userId = "66943332-5511-462c-876e-5d5b720c7edf";

  var userObject = {
    firstName: "Trn",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2020-12-01",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 8. Basic Login</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 10. Updating, Showing, and Deleting Users</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section epub:type="chapter">
<h2 class="h2" id="ch09"><span epub:type="pagebreak" id="page_431"></span>Chapter 9</h2>
<h2 class="h2a">Advanced Login</h2>
<p class="noindent">The basic login system developed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a> is fully functional, but most modern websites include the ability to remember users when they visit the site again even if theyve closed their browsers in the interim. In this chapter, we use <em>permanent cookies</em> to implement this behavior. Well start by automatically remembering users when they log in (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_1">Section 9.1</a>), a common model used by sites such as Bitbucket and GitHub. Well then add the ability to <em>optionally</em> remember users using a remember me checkbox, a model used by sites such as Twitter and Facebook.</p>
<p class="indent">Because the <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">Chapter 8</a> login system is complete by itself, the core of the sample application will work fine without it, and if desired you can skip right to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">Chapter 10</a> (and from there to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">Chapter 13</a>). On the other hand, learning how to implement the remember me feature is both highly instructive by itself and lays an essential foundation for account activation (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">Chapter 11</a>) and password reset (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>). Moreover, the result is an outstanding example of computer magic: Youve seen a billion of these remember me login forms on the Web, and nows your chance to learn how to make one.</p>
<section>
<h3 class="h3" id="sec9_1">9.1 Remember Me</h3>
<p class="noindent">In this section, well add the ability to remember our users login state even after they close and reopen their browsers. This remember me behavior will happen automatically, and users will automatically stay logged in until they explicitly log out. As well see, the resulting machinery will make it easy to add an optional remember me checkbox as well (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_2">Section 9.2</a>).<span epub:type="pagebreak" id="page_432"></span></p>
<p class="indent">As usual, I suggest switching to a topic branch before proceeding:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg432a" id="pg432">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_blue1">$</span></strong> git checkout -b advanced-login</pre>
<section>
<h4 class="h4" id="sec9_1_1">9.1.1 Remember Token and Digest</h4>
<p class="noindent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#sec8_2">Section 8.2</a>, we used the Rails <span class="dark-green"><strong><code>session</code></strong></span> method to store the users id, but this information disappears when the user closes the browser. In this section, well take the first step toward persistent sessions by generating a <em>remember token</em> appropriate for creating permanent cookies using the <span class="dark-green"><strong><code>cookies</code></strong></span> method, together with a secure <em>remember digest</em> for authenticating those tokens.</p>
<p class="indent">As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#sec8_2_1">Section 8.2.1</a>, information stored using <span class="dark-green"><strong><code>session</code></strong></span> is automatically secure, but this is not the case with information stored using <span class="dark-green"><strong><code>cookies</code></strong></span>. In particular, persistent cookies are vulnerable to session hijacking, in which an attacker uses a stolen remember token to log in as a particular user. There are four main ways to steal cookies: (1) using a packet sniffer to detect cookies being passed over insecure networks,<sup><a id="ch09fn1a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn1" class="totri-footnote">1</a></sup> (2) compromising a database containing remember tokens, (3) using cross-site scripting (XSS), and (4) gaining physical access to a machine with a logged-in user.</p>
<p class="footnote"><a id="ch09fn1" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn1a" class="totri-footnote">1</a>. Session hijacking was widely publicized by the Firesheep application, which showed that remember tokens at many high-profile sites were visible from devices connected to public Wi-Fi networks.</p>
<p class="indent">We prevented the first problem in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_5">Section 7.5</a> by using Secure Sockets Layer (SSL) site-wide, which protects network data from packet sniffers. Well prevent the second problem by storing a hash digest of the remember tokens instead of the token itself, in much the same way that we stored password digests instead of raw passwords in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3">Section 6.3</a>.<sup><a id="ch09fn2a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn2" class="totri-footnote">2</a></sup> Rails automatically prevents the third problem by escaping any content inserted into view templates. Finally, although theres no iron-clad way to stop attackers who have physical access to a logged-in computer, well minimize the fourth problem by changing tokens every time a user logs out and by taking care to <em>cryptographically sign</em> any potentially sensitive information we place on the browser.</p>
<p class="footnote"><a id="ch09fn2" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn2a" class="totri-footnote">2</a>. Rails 5 introduced a <span class="dark-green"><strong><code>has_secure_token</code></strong></span> method that automatically generates random tokens, but it stores the <em>unhashed</em> values in the database, and hence is unsuitable for our present purposes.</p>
<p class="indent">With these design and security considerations in mind, our plan for creating persistent sessions appears as follows:<span epub:type="pagebreak" id="page_433"></span></p>
<ol class="num">
<li><p class="num">Create a random string of digits for use as a remember token.</p></li>
<li><p class="num">Place the token in the browser cookies with an expiration date far in the future.</p></li>
<li><p class="num">Save the hash digest of the token to the database.</p></li>
<li><p class="num">Place an encrypted version of the users id in the browser cookies.</p></li>
<li><p class="num">When presented with a cookie containing a persistent user id, find the user in the database using the given id, and verify that the remember token cookie matches the associated hash digest from the database.</p></li>
</ol>
<p class="noindent">Note how similar the final step is to logging a user in, where we retrieve the user by email address and then verify (using the <span class="dark-green"><strong><code>authenticate</code></strong></span> method) that the submitted password matches the password digest (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex07">Listing 8.7</a>). As a result, our implementation will parallel aspects of <span class="dark-green"><strong><code>has_secure_password</code></strong></span>.</p>
<p class="indent">Well start by adding the required <span class="dark-green"><strong><code>remember_digest</code></strong></span> attribute to the User model, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fig01">Figure 9.1</a>. To add the data model from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fig01">Figure 9.1</a> to our application, well generate a migration:</p>
<figure id="ch09fig01" class="image-l">
<img src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/fig09_01.jpg" alt="Image" width="551" height="357" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig09_01.jpg">
<figcaption><p><strong>Figure 9.1:</strong> The User model with an added <span class="dark-green"><strong><code>remember_digest</code></strong></span> attribute.</p></figcaption>
</figure>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg433a" id="pg433">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_blue1">$</span></strong> rails generate migration add_remember_digest_to_users remember_digest:string</pre>
<p class="noindent">(Compare this to the password digest migration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3_1">Section 6.3.1</a>.) As in previous migrations, weve used a migration name that ends in <span class="dark-green"><strong><code>_to_users</code></strong></span> to tell Rails that <span epub:type="pagebreak" id="page_434"></span>the migration is designed to alter the <span class="dark-green"><strong><code>users</code></strong></span> table in the database. Because we also included the attribute (<span class="dark-green"><strong><code>remember_digest</code></strong></span>) and type (<span class="dark-green"><strong><code>string</code></strong></span>), Rails generates a default migration for us, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex01">Listing 9.1</a>.</p>
<p class="ex-title" id="ch09ex01"><strong>Listing 9.1:</strong> The generated migration for the remember digest.</p>
<pre class="pre2">db/migrate/[timestamp]_add_remember_digest_to_users.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-1a" id="lis9-1">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue5">AddRememberDigestToUsers</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ActiveRecord</span><span class="pd_ash">::</span><span class="pd_red">Migration</span><span class="pd_ash">[6.0]</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">change</span>
    add_column <span class="pd_blue1">:users</span>, <span class="pd_blue1">:remember_digest</span>, <span class="pd_blue1">:string</span>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">Because we dont expect to retrieve users by remember digest, theres no need to put an index on the <span class="dark-green"><strong><code>remember_digest</code></strong></span> column, and we can use the default migration:</p>
<pre class="pre1">$ rails db:migrate</pre>
<p class="indent">Now we have to decide what to use as a remember token. There are many mostly equivalent possibilitiesessentially, any long random string will do. The <span class="dark-green"><strong><code>urlsafe_base64</code></strong></span> method from the <span class="dark-green"><strong><code>SecureRandom</code></strong></span> module in the Ruby standard library fits the bill:<sup><a id="ch09fn3a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn3" class="totri-footnote">3</a></sup> It returns a random string of length 22 composed of the characters AZ, az, 09, -, and _ (for a total of 64 possibilities, thus base64). A typical base64 string appears as follows:</p>
<p class="footnote"><a id="ch09fn3" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn3a" class="totri-footnote">3</a>. This choice is based on the RailsCast on remember me.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg434a" id="pg434">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_blue1">$</span></strong> rails console
<strong><span class="pd_blue1">&gt;</span></strong>&gt; SecureRandom.urlsafe_base64
<span class="pd_green">=&gt; "brl_446-8bqHv87AQzUj_Q"</span></pre>
<p class="indent">Just as its perfectly fine if two users have the same password,<sup><a id="ch09fn4a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn4" class="totri-footnote">4</a></sup> theres no need for remember tokens to be uniquebut its more secure if they are.<sup><a id="ch09fn5a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn5" class="totri-footnote">5</a></sup> In the case of our base64 string, each of the 22 characters has 64 possibilities, so the probability of two <span epub:type="pagebreak" id="page_435"></span>remember tokens colliding is a negligibly small 1/64<sup>22</sup> = 2<sup>132</sup>  10<sup>40</sup>.<sup><a id="ch09fn6a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn6" class="totri-footnote">6</a></sup> As a bonus, by using base64 strings specifically designed to be safe in URLs (as indicated by the name <span class="dark-green"><strong><code>urlsafe_base64</code></strong></span>), well be able to use the same token generator to make account activation and password reset links in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">Chapter 12</a>.</p>
<p class="footnote"><a id="ch09fn4" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn4a" class="totri-footnote">4</a>. In any case, with bcrypts salted hashes theres no way for us to tell if two users passwords match.</p>
<p class="footnote"><a id="ch09fn5" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn5a" class="totri-footnote">5</a>. With unique remember tokens, an attacker always needs <em>both</em> the user id and the remember token cookies to hijack the session.</p>
<p class="footnote"><a id="ch09fn6" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn6a" class="totri-footnote">6</a>. This hasnt stopped some developers from adding a check to verify that no collision has occurred, but such efforts result from failing to grasp just how small 10<sup>40</sup> is. For example, if we generated a billion tokens a second for the entire age of the universe (4.4  10<sup>7</sup> s), the expected number of collisions would still be on the order of 2  10<sup>23</sup>, which is zero in any operational sense of the word.</p>
<p class="indent">Remembering users involves creating a remember token and saving the digest of the token to the database. Weve already defined a <span class="dark-green"><strong><code>digest</code></strong></span> method for use in the test fixtures (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex025">Listing 8.25</a>), and we can use the results of the preceding discussion to create a <span class="dark-green"><strong><code>new_token</code></strong></span> method to create a new token. As with <span class="dark-green"><strong><code>digest</code></strong></span>, the new token method doesnt need a user object, so well make it a class method.<sup><a id="ch09fn7a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn7" class="totri-footnote">7</a></sup> The result is the User model shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex02">Listing 9.2</a>.</p>
<p class="footnote"><a id="ch09fn7" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn7a" class="totri-footnote">7</a>. As a general rule, if a method doesnt need an instance of an object, it should be a class method. Indeed, this decision will prove to be wise in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2">Section 11.2</a>.</p>
<p class="ex-title" id="ch09ex02"><strong>Listing 9.2:</strong> Adding a method for generating tokens.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-2a" id="lis9-2">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue5">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
  before_save { <span class="pd_green">self</span><span class="pd_ash">.</span>email <span class="pd_ash">=</span> email<span class="pd_ash">.</span>downcase }
  validates <span class="pd_blue1">:name</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">50</span> }
  <span class="pd_red">VALID_EMAIL_REGEX</span> <span class="pd_ash">=</span> <span class="pd_red2">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="pd_blue1">:email</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">255</span> },
                    <span class="pd_green">format</span>: { <span class="pd_blue1">with</span>: <span class="pd_red">VALID_EMAIL_REGEX</span> },
                    <span class="pd_blue1">uniqueness</span>: <strong><span class="pd_green">true</span></strong>
  has_secure_password
  validates <span class="pd_blue1">:password</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">minimum</span>: <span class="pd_ash">6</span> }

  <span class="pd_blue7"># Returns the hash digest of the given string.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue5">User</span></strong><span class="pd_ash">.</span><span class="pd_blue5">digest</span>(string)
    cost <span class="pd_ash">=</span> <span class="pd_red">ActiveModel</span><span class="pd_ash">::</span><span class="pd_red">SecurePassword</span><span class="pd_ash">.</span>min_cost ? <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">::</span><span class="pd_red">MIN_COST</span> :
                                                  <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">.</span>cost
    <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>create(string, <span class="pd_blue1">cost</span>: cost)
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns a random token.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue5">User</span></strong><span class="pd_ash">.</span><span class="pd_blue5">new_token</span>
<span class="mark">    <span class="pd_red5">SecureRandom</span><span class="pd_ash">.</span>urlsafe_base64</span>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_436"></span>Our plan for the implementation is to make a <span class="dark-green"><strong><code>user.remember</code></strong></span> method that associates a remember token with the user and saves the corresponding remember digest to the database. Because of the migration in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex01">Listing 9.1</a>, the User model already has a <span class="dark-green"><strong><code>remember_digest</code></strong></span> attribute, but it doesnt yet have a <span class="dark-green"><strong><code>remember_token</code></strong></span> attribute. We need a way to make a token available via <span class="dark-green"><strong><code>user.remember_token</code></strong></span> (for storage in the cookies) <em>without</em> storing it in the database. We solved a similar issue with secure passwords in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3">Section 6.3</a>, which paired a virtual <span class="dark-green"><strong><code>password</code></strong></span> attribute with a secure <span class="dark-green"><strong><code>password_digest</code></strong></span> attribute in the database. In that case, the virtual <span class="dark-green"><strong><code>password</code></strong></span> attribute was created automatically by <span class="dark-green"><strong><code>has_secure_password</code></strong></span>, but well have to write the code for a <span class="dark-green"><strong><code>remember_token</code></strong></span> ourselves. The way to do this is to use <span class="dark-green"><strong><code>attr_accessor</code></strong></span> to create an accessible attribute, as we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_5">Section 4.4.5</a>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg436a" id="pg436">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">class</span> <span class="pd_blue5">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
<span class="mark1">  <strong><span class="pd_green4">attr_accessor</span></strong> <span class="pd_blue5">:remember_token</span></span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <strong><span class="pd_green">def</span></strong> remember
<span class="mark1">    <span class="pd_green4">self</span><span class="pd_ash">.</span>remember_token = <span class="pd_ash">...</span></span>
<span class="mark1">    update_attribute(<span class="pd_blue5">:remember_digest</span>, <span class="pd_ash">...</span>)</span>
  <strong><span class="dark-green">end</span></strong>
<strong><span class="dark-green">end</span></strong></pre>
<p class="noindent">Note the form of the assignment in the first line of the <span class="dark-green"><strong><code>remember</code></strong></span> method. Because of the way Ruby handles assignments inside objects, without <span class="dark-green"><strong><code>self</code></strong></span> the assignment would create a <em>local</em> variable called <span class="dark-green"><strong><code>remember_token</code></strong></span>, which isnt what we want. Using <span class="dark-green"><strong><code>self</code></strong></span> ensures that assignment sets the users <span class="dark-green"><strong><code>remember_token</code></strong></span> attribute. (Now you know why the <span class="dark-green"><strong><code>before_save</code></strong></span> callback from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex032">Listing 6.32</a> uses <span class="dark-green"><strong><code>self.email</code></strong></span> instead of just <span class="dark-green"><strong><code>email</code></strong></span>.) Meanwhile, the second line of <span class="dark-green"><strong><code>remember</code></strong></span> uses the <span class="dark-green"><strong><code>update_attribute</code></strong></span> method to update the remember digest. (As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_1_5">Section 6.1.5</a>, this method bypasses the validations, which is necessary in this case because we dont have access to the users password or confirmation.)</p>
<p class="indent">With these considerations in mind, we can create a valid token and associated digest by first making a new remember token using <span class="dark-green"><strong><code>User.new_token</code></strong></span>, and then updating the remember digest with the result of applying <span class="dark-green"><strong><code>User.digest</code></strong></span>. This procedure gives the <span class="dark-green"><strong><code>remember</code></strong></span> method shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex03">Listing 9.3</a>.<span epub:type="pagebreak" id="page_437"></span></p>
<p class="ex-title" id="ch09ex03"><strong>Listing 9.3:</strong> Adding a <span class="dark-green"><strong><code>remember</code></strong></span> method to the User model. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-3a" id="lis9-3">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue3">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
<span class="mark">  <strong><span class="pd_green4">attr_accessor</span></strong> <span class="pd_blue5">:remember_token</span></span>
  before_save { <span class="pd_green">self</span><span class="pd_ash">.</span>email <span class="pd_ash">=</span> email<span class="pd_ash">.</span>downcase }
  validates <span class="pd_blue1">:name</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">50</span> }
  <span class="pd_red">VALID_EMAIL_REGEX</span> <span class="pd_ash">=</span> <span class="pd_red">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="pd_blue1">:email</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">255</span> },
                    <span class="pd_green">format</span>: { <span class="pd_blue1">with</span>: <span class="pd_red">VALID_EMAIL_REGEX</span> },
                    <span class="pd_blue1">uniqueness</span>: <strong><span class="pd_green">true</span></strong>
  has_secure_password
  validates <span class="pd_blue1">:password</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">minimum</span>: <span class="pd_ash">6</span> }

  <span class="pd_blue7"># Returns the hash digest of the given string.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue5">User</span></strong><span class="pd_ash">.</span><span class="pd_blue5">digest</span>(string)
    cost <span class="pd_ash">=</span> <span class="pd_red">ActiveModel</span><span class="pd_ash">::</span><span class="pd_red">SecurePassword</span><span class="pd_ash">.</span>min_cost ? <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">::</span><span class="pd_red">MIN_COST</span> :
                                                  <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">.</span>cost
    <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>create(string, <span class="pd_blue1">cost</span>: cost)
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns a random token.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue5">User</span></strong><span class="pd_ash">.</span><span class="pd_blue5">new_token</span>
    <span class="pd_red">SecureRandom</span><span class="pd_ash">.</span>urlsafe_base64
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Remembers a user in the database for use in persistent sessions.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">remember</span>
<span class="mark">    <span class="pd_green">self</span><span class="pd_ash">.</span>remember_token = <span class="pd_red5">User</span><span class="pd_ash">.</span>new_token</span>
<span class="mark">    update_attribute(<span class="pd_blue5">:remember_digest</span>, <span class="pd_red5">User</span><span class="pd_ash">.</span>digest(remember_token))</span>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<section>
<h5 class="h5" id="lev98">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">In the console, assign <span class="dark-green"><strong><code>User</code></strong></span> to the first user in the database, and verify by calling it directly that the <span class="dark-green"><strong><code>remember</code></strong></span> method works. How do <span class="dark-green"><strong><code>remember_token</code></strong></span> and <span class="dark-green"><strong><code>remember_digest</code></strong></span> compare?</p></li>
<li><p class="num">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex03">Listing 9.3</a>, we defined the new token and digest class methods by explicitly prefixing them with <span class="dark-green"><strong><code>User</code></strong></span>. This works fine and, because they are actually <span epub:type="pagebreak" id="page_438"></span><em>called</em> using <span class="dark-green"><strong><code>User.new_token</code></strong></span> and <span class="dark-green"><strong><code>User.digest</code></strong></span>, it is probably the clearest way to define them. But there are two perhaps more idiomatically correct ways to define class methods, one slightly confusing and one extremely confusing. By running the test suite, verify that the implementations in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex04">Listing 9.4</a> (slightly confusing) and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex05">Listing 9.5</a> (extremely confusing) are correct. (Note that, in the context of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex04">Listing 9.4</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex05">Listing 9.5</a>, <span class="dark-green"><strong><code>self</code></strong></span> is the <span class="dark-green"><strong><code>User</code></strong></span> class, whereas the other uses of <span class="dark-green"><strong><code>self</code></strong></span> in the User model refer to a user object <em>instance</em>. This is part of what makes them confusing.)</p></li>
</ol>
<p class="ex-title" id="ch09ex04"><strong>Listing 9.4:</strong> Defining the new token and digest methods using <span class="dark-green"><strong><code>self.</code></strong></span> <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-4a" id="lis9-4">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue3">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_blue7"># Returns the hash digest of the given string.</span>
<span class="mark">  <strong><span class="pd_green5">def</span> <span class="pd_blue3">self</span></strong><span class="pd_ash">.</span><span class="pd_blue5">digest</span>(string)</span>
      cost <span class="pd_ash">=</span> <span class="pd_red">ActiveModel</span><span class="pd_ash">::</span><span class="pd_red">SecurePassword</span><span class="pd_ash">.</span>min_cost ? <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">::</span><span class="pd_red">MIN_COST</span> :
                                                    <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">.</span>cost
      <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>create(string, <span class="pd_blue1">cost</span>: cost)
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns a random token.</span>
<span class="mark">  <strong><span class="pd_green5">def</span> <span class="pd_blue3">self</span></strong><span class="pd_ash">.</span><span class="pd_blue3">new_token</span></span>
    <span class="pd_red">SecureRandom</span><span class="pd_ash">.</span>urlsafe_base64
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="ex-title" id="ch09ex05"><strong>Listing 9.5:</strong> Defining the new token and digest methods using <span class="dark-green"><strong><code>class &lt;&lt; self</code></strong></span>. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-5a" id="lis9-5">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue3">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
<span class="mark">  <strong><span class="pd_green5">class</span></strong> <span class="pd_green5">&lt;&lt; self</span></span>
    <span class="pd_blue7"># Returns the hash digest of the given string.</span>
<span class="mark">    <strong><span class="pd_green5">def</span></strong> <span class="pd_blue5">digest</span>(string)</span>
<span epub:type="pagebreak" id="page_439"></span>        cost <span class="pd_ash">=</span> <span class="pd_red">ActiveModel</span><span class="pd_ash">::</span><span class="pd_red">SecurePassword</span><span class="pd_ash">.</span>min_cost ? <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">::</span><span class="pd_red">MIN_COST</span> :
                                                      <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">.</span>cost
        <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>create(string, <span class="pd_blue1">cost</span>: cost)
    <strong><span class="pd_green">end</span></strong>

    <span class="pd_blue7"># Returns a random token.</span>
<span class="mark">    <strong><span class="pd_green5">def</span></strong> <span class="pd_blue5">new_token</span></span>
      <span class="pd_red">SecureRandom</span><span class="pd_ash">.</span>urlsafe_base64
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong>
<span class="pd_ash">.</span>
<span class="pd_ash">.</span>
<span class="pd_ash">.</span></pre>
</div>
</section>
</section>
<section>
<h4 class="h4" id="sec9_1_2">9.1.2 Login with Remembering</h4>
<p class="noindent">Having created a working <span class="dark-green"><strong><code>user.remember</code></strong></span> method, we can now create a persistent session by storing a users (encrypted) id and remember token as permanent cookies on the browser. We do this with the <span class="dark-green"><strong><code>cookies</code></strong></span> method, which (as with <span class="dark-green"><strong><code>session</code></strong></span>) we can treat as a hash. A cookie consists of two pieces of information, a <span class="dark-green"><strong><code>value</code></strong></span> and an optional <span class="dark-green"><strong><code>expires</code></strong></span> date. For example, we could make a persistent session by creating a cookie with a value equal to the remember token that expires 20 years from now:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg439-1a" id="pg439-1">Click here to view code image</a></p>
<pre class="pre1">cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> { <span class="pd_blue1">value</span>:   remember_token,
                             <span class="pd_blue1">expires</span>: <span class="pd_ash">20.</span>years<span class="pd_ash">.</span>from_now<span class="pd_ash">.</span>utc }</pre>
<p class="noindent">(This uses one of the convenient Rails time helpers, as discussed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#box9_1">Box 9.1</a>.) This pattern of setting a cookie that expires 20 years in the future is so common that Rails has a special <span class="dark-green"><strong><code>permanent</code></strong></span> method to implement it, so that we can simply write</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg439-2a" id="pg439-2">Click here to view code image</a></p>
<pre class="pre1">cookies<span class="pd_ash">.</span>permanent<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> remember_token</pre>
<p class="indent">This causes Rails to set the expiration to <span class="dark-green"><strong><code>20.years.from_now</code></strong></span> automatically.</p>
<div class="box">
<p class="box-caption" id="box9_1">Box 9.1: Cookies Expire <code>20.years.from_now</code></p>
<p class="boxip">You may recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_4_2">Section 4.4.2</a> that Ruby lets you add methods to <em>any</em> class, even built-in ones. In that section, we added a <code>palindrome?</code> method to the <span epub:type="pagebreak" id="page_440"></span><code>String</code> class (and discovered as a result that <code>"deified"</code> is a palindrome), and we also saw how Rails adds a <code>blank?</code> method to class <code>Object</code> (so that <code>"".blank?</code>, <code>" ".blank?</code>, and <code>nil.blank?</code> are all <code>true</code>). The <code>cookies.permanent</code> method, which creates permanent cookies with an expiration <code>20.years.from_now</code>, provides yet another example of this practice through one of Rails <em>time helpers</em>, which are methods added to <code>Fixnum</code> (the base class for integers):</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg440-1a" id="pg440-1">Click here to view code image</a></p>
<pre class="pre1">$ rails console
&gt;&gt; 1.year.from_now
=&gt; Wed, 21 Jun 2017 19:36:29 UTC +00:00
&gt;&gt; 10.weeks.ago
=&gt; Tue, 12 Apr 2016 19:36:44 UTC +00:00</pre>
<p class="boxip">Rails adds other helpers, too:</p>
<pre class="pre1">&gt;&gt; 1.kilobyte
=&gt; 1024
&gt;&gt; 5.megabytes
=&gt; 5242880</pre>
<p class="boxnp">These are useful for upload validations, making it easy to restrict, say, image uploads to <code>5.megabytes</code>.</p>
<p class="boxip">Although this flexibility should be used with caution, adding methods to built-in classes enables extraordinarily natural extensions to plain Ruby. Indeed, much of the elegance of Rails ultimately derives from the malleability of the underlying Ruby language.</p>
</div>
<p class="indent">To store the users id in the cookies, we could follow the pattern used with the <span class="dark-green"><strong><code>session</code></strong></span> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex014">Listing 8.14</a>) using something like</p>
<pre class="pre1">cookies<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> user<span class="pd_ash">.</span>id</pre>
<p class="noindent">Because it places the id as plain text, this method exposes the form of the applications cookies and makes it easier for an attacker to compromise user accounts. To avoid this problem, well use an <em>encrypted</em> cookie, which securely encrypts the cookie before placing it on the browser:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg440-3a" id="pg440-3">Click here to view code image</a></p>
<pre class="pre1">cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> user<span class="pd_ash">.</span>id</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_441"></span>Because we want the user id to be paired with the permanent remember token, we should make it permanent as well, which we can do by chaining the <span class="dark-green"><strong><code>encrypted</code></strong></span> and <span class="dark-green"><strong><code>permanent</code></strong></span> methods:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg441-1a" id="pg441-1">Click here to view code image</a></p>
<pre class="pre1">cookies<span class="pd_ash">.</span>permanent<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> user<span class="pd_ash">.</span>id</pre>
<p class="indent">After the cookies are set, on subsequent page views we can retrieve the user with code like</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg441-2a" id="pg441-2">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)</pre>
<p class="noindent">where <span class="dark-green"><strong><code>cookies.encrypted[:user_id]</code></strong></span> automatically decrypts the user id cookie. We can then use bcrypt to verify that <span class="dark-green"><strong><code>cookies[:remember_token]</code></strong></span> matches the <span class="dark-green"><strong><code>remember_digest</code></strong></span> generated in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex03">Listing 9.3</a>. (In case youre wondering why we dont just use the encrypted user id, without the remember token, this would allow an attacker with possession of the encrypted id to log in as the user in perpetuity. In the present design, an attacker with both cookies can log in as the user only until the user logs out.)</p>
<p class="indent">The final piece of the puzzle is to verify that a given remember token matches the users remember digest. In this context there are a couple of equivalent ways to use bcrypt to verify a match. If you look at the secure password source code, youll find a comparison like this:<sup><a id="ch09fn8a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn8" class="totri-footnote">8</a></sup></p>
<p class="footnote"><a id="ch09fn8" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn8a" class="totri-footnote">8</a>. As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#sec6_3_1">Section 6.3.1</a>, unencrypted password is a misnomer, as the secure password is <em>hashed</em>, not encrypted.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg441-3a" id="pg441-3">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>new(password_digest) <span class="pd_ash">==</span> unencrypted_password</pre>
<p class="indent">In our case, the analogous code would look like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg441-4a" id="pg441-4">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>new(remember_digest) <span class="pd_ash">==</span> remember_token</pre>
<p class="noindent">If you think about it, this code is really strange: It appears to be comparing a bcrypt password digest directly with a token, which would imply <em>decrypting</em> the digest in order to compare it using <span class="dark-green"><strong><code>==</code></strong></span>. But the whole point of using bcrypt is for hashing to be irreversible, so this cant be right. Indeed, digging into the source code of the bcrypt <span epub:type="pagebreak" id="page_442"></span>gem verifies that the comparison operator <span class="dark-green"><strong><code>==</code></strong></span> is being <em>redefined</em>, and under the hood the preceding comparison is equivalent to the following:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg442a" id="pg442">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>new(remember_digest)<span class="pd_ash">.</span>is_password?(remember_token)</pre>
<p class="noindent">Instead of <span class="dark-green"><strong><code>==</code></strong></span>, this uses the boolean method <span class="dark-green"><strong><code>is_password?</code></strong></span> to perform the comparison. Because its meaning is a little clearer, well prefer this second comparison form in the application code.</p>
<p class="indent">This discussion suggests that we should put the digesttoken comparison into an <span class="dark-green"><strong><code>authenticated?</code></strong></span> method in the User model, which plays a role similar to that of the <span class="dark-green"><strong><code>authenticate</code></strong></span> method provided by <span class="dark-green"><strong><code>has_secure_password</code></strong></span> for authenticating a user (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex015">Listing 8.15</a>). The implementation appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex06">Listing 9.6</a>. (Although the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex06">Listing 9.6</a> is tied specifically to the remember digest, it will turn out to be useful in other contexts as well, and well generalize it in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">Chapter 11</a>.)</p>
<p class="ex-title" id="ch09ex06"><strong>Listing 9.6:</strong> Adding an <span class="dark-green"><strong><code>authenticated?</code></strong></span> method to the User model.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-6a" id="lis9-6">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue3">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
  <strong><span class="pd_green">attr_accessor</span></strong> <span class="pd_blue1">:remember_token</span>
  before_save { <span class="pd_green">self</span><span class="pd_ash">.</span>email <span class="pd_ash">=</span> email<span class="pd_ash">.</span>downcase }
  validates <span class="pd_blue1">:name</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">50</span> }
  <span class="pd_red">VALID_EMAIL_REGEX</span> <span class="pd_ash">=</span> <span class="pd_red">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="pd_blue1">:email</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">255</span> },
                    <span class="pd_green">format</span>: { <span class="pd_blue1">with</span>: <span class="pd_red">VALID_EMAIL_REGEX</span> },
                    <span class="pd_blue1">uniqueness</span>: <strong><span class="pd_green">true</span></strong>
  has_secure_password
  validates <span class="pd_blue1">:password</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">minimum</span>: <span class="pd_ash">6</span> }

  <span class="pd_blue7"># Returns the hash digest of the given string.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue5">User</span></strong><span class="pd_ash">.</span><span class="pd_blue1">digest</span>(string)
    cost <span class="pd_ash">=</span> <span class="pd_red">ActiveModel</span><span class="pd_ash">::</span><span class="pd_red">SecurePassword</span><span class="pd_ash">.</span>min_cost ? <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">::</span><span class="pd_red">MIN_COST</span> :
                                                  <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">.</span>cost
    <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>create(string, <span class="pd_blue1">cost</span>: cost)
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns a random token.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue5">User</span></strong><span class="pd_ash">.</span><span class="pd_blue1">new_token</span>
    <span class="pd_red">SecureRandom</span><span class="pd_ash">.</span>urlsafe_base64
  <strong><span class="pd_green">end</span></strong>

<span epub:type="pagebreak" id="page_443"></span>  <span class="pd_blue7"># Remembers a user in the database for use in persistent sessions.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">remember</span>
    <span class="pd_green">self</span><span class="pd_ash">.</span>remember_token = <span class="pd_red">User</span><span class="pd_ash">.</span>new_token
    update_attribute(<span class="pd_blue1">:remember_digest</span>, <span class="pd_red">User</span><span class="pd_ash">.</span>digest(remember_token))
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns true if the given token matches the digest.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">authenticated?</span>(remember_token)
<span class="mark">    <span class="pd_red5">BCrypt</span><span class="pd_ash">::</span><span class="pd_red5">Password</span><span class="pd_ash">.</span>new(remember_digest)<span class="pd_ash">.</span>is_password?(remember_token)</span>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">Note that the <span class="dark-green"><strong><code>remember_token</code></strong></span> argument in the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex06">Listing 9.6</a> is not the same as the accessor that we defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex03">Listing 9.3</a> using <span class="dark-green"><strong><code>attr_accessor :remember_token</code></strong></span>; instead, it is a variable local to the method. (Because the argument refers to the remember token, it is not uncommon to use a method argument that has the same name.) Also note the use of the <span class="dark-green"><strong><code>remember_digest</code></strong></span> attribute, which is the same as <span class="dark-green"><strong><code>self.remember_digest</code></strong></span> and, like <span class="dark-green"><strong><code>name</code></strong></span> and <span class="dark-green"><strong><code>email</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">Chapter 6</a>, is created automatically by Active Record based on the name of the corresponding database column (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex01">Listing 9.1</a>).</p>
<p class="indent">Were now in a position to remember a logged-in user, which well do by adding a <span class="dark-green"><strong><code>remember</code></strong></span> helper to go along with <span class="dark-green"><strong><code>log_in</code></strong></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex07">Listing 9.7</a>.</p>
<p class="ex-title" id="ch09ex07"><strong>Listing 9.7:</strong> Logging in and remembering a user. <span class="pd_red5"><code>RED</code></span></p>
<pre class="pre2">app/controllers/sessions_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-7a" id="lis9-7">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue5">SessionsController</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationController</span>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">new</span>
  <strong><span class="pd_green">end</span></strong>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">create</span>
    user = <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_blue1">email</span>: params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:email</span><span class="pd_ash">]</span><span class="pd_ash">.</span>downcase)
    <strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticate(params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:password</span><span class="pd_ash">]</span>)
      log_in user
<span class="mark">      remember user</span>
      redirect_to user
    <strong><span class="pd_green">else</span></strong>
      flash<span class="pd_ash">.</span>now<span class="pd_ash">[</span><span class="pd_blue1">:danger</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> <span class="pd_red">'Invalid email/password combination'</span>
      render <span class="pd_red">'new'</span>
    <strong><span class="pd_green">end</span></strong>
  <strong><span class="pd_green">end</span></strong>
<span epub:type="pagebreak" id="page_444"></span>  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">destroy</span>
    log_out
    redirect_to root_url
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent">As with <span class="dark-green"><strong><code>log_in</code></strong></span>, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex07">Listing 9.7</a> defers the real work to the Sessions helper, where we define a <span class="dark-green"><strong><code>remember</code></strong></span> method that calls <span class="dark-green"><strong><code>user.remember</code></strong></span>, thereby generating a remember token and saving its digest to the database. It then uses <span class="dark-green"><strong><code>cookies</code></strong></span> to create permanent cookies for the user id and remember token as described above. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex08">Listing 9.8</a>.</p>
<p class="ex-title" id="ch09ex08"><strong>Listing 9.8:</strong> Remembering the user. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/helpers/sessions_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-8a" id="lis9-8">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">module</span> <span class="pd_blue5">SessionsHelper</span></strong>

  <span class="pd_blue7"># Logs in the given User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_in</span>(user)
    session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> user<span class="pd_ash">.</span>id
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Remembers a user in a persistent session.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">remember</span>(user)
<span class="mark">    User.remember</span>
<span class="mark">    cookies<span class="pd_ash">.</span>permanent<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue5">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>id</span>
<span class="mark">    cookies<span class="pd_ash">.</span>permanent<span class="pd_ash">[</span><span class="pd_blue5">:remember_token</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>remember_token</span>
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns the current logged-in user (if any).</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">current_user</span>
    <strong><span class="pd_green">if</span></strong> session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>
      <span class="pd_blue1">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)
    <strong><span class="pd_green">end</span></strong>
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns true if the user is logged in, false otherwise.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">logged_in?</span>
    !current_User<span class="pd_ash">.</span>nil?
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Logs out the current User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_out</span>
<span epub:type="pagebreak" id="page_445"></span>    session<span class="pd_ash">.</span>delete(<span class="pd_blue1">:user_id</span>)
    <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> <strong><span class="pd_green">nil</span></strong>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex08">Listing 9.8</a>, a user logging in will be remembered in the sense that their browser will get a valid remember token, but it doesnt do us any good just yet because the <span class="dark-green"><strong><code>current_user</code></strong></span> method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex016">Listing 8.16</a> knows only about the temporary session:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg445-1a" id="pg445-1">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_blue1">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)</pre>
<p class="noindent">In the case of persistent sessions, we want to retrieve the user from the temporary session if <span class="dark-green"><strong><code>session[:user_id]</code></strong></span> exists, but otherwise we should look for <span class="dark-green"><strong><code>cookies[:user_id]</code></strong></span> to retrieve (and log in) the user corresponding to the persistent session. We can accomplish this as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg445-2a" id="pg445-2">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">if</span></strong> session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>
  <span class="pd_blue1">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)
<strong><span class="pd_green">elsif</span></strong> cookies.encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>
  user <span class="pd_ash">=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)
  <strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>)
    log_in user
    <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> user
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent">(This follows the same <span class="dark-green"><strong><code>user <span class="pd_ash">&amp;&amp;</span> user.authenticated</code></strong></span> pattern we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex07">Listing 8.7</a>.) This code will work, but note the repeated use of both <span class="dark-green"><strong><code>session</code></strong></span> and <span class="dark-green"><strong><code>cookies</code></strong></span>. We can eliminate this duplication as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg445-3a" id="pg445-3">Click here to view code image</a></p>
<pre class="pre1"><span class="mark1"><strong><span class="pd_green4">if</span></strong> (user_id <span class="pd_ash">=</span> session<span class="pd_ash">[</span><span class="pd_blue5">:user_id</span><span class="pd_ash">]</span>)</span>
  <span class="pd_blue1">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
<span class="mark1"><strong><span class="pd_green4">elsif</span></strong> (user_id = cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)</span>
  user = <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
  <strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>)
    log_in user
    <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> user
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_446"></span>This uses the common but potentially confusing construction</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg446a" id="pg446">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">if</span></strong> (user_id <span class="pd_ash">=</span> session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)</pre>
<p class="noindent">Despite appearances, this is <em>not</em> a comparison (which would use double-equals <span class="dark-green"><strong><code>==</code></strong></span>) but rather an <em>assignment</em>. If you were to read it in words, you wouldnt say, If user id equals session of user id..., but rather something like If session of user id exists (while setting user id to session of user id)....<sup><a id="ch09fn9a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn9" class="totri-footnote">9</a></sup></p>
<p class="footnote"><a id="ch09fn9" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn9a" class="totri-footnote">9</a>. I generally use the convention of putting such assignments in parentheses, which is a visual reminder that its not a comparison.</p>
<p class="indent">Defining the <span class="dark-green"><strong><code>current_user</code></strong></span> helper as just discussed leads to the implementation shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex09">Listing 9.9</a>.</p>
<p class="ex-title" id="ch09ex09"><strong>Listing 9.9:</strong> Updating <span class="dark-green"><strong><code>current_user</code></strong></span> for persistent sessions. <span class="pd_red5"><code>RED</code></span></p>
<pre class="pre2">app/helpers/sessions_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-9a" id="lis9-9">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">module</span> <span class="pd_blue5">SessionsHelper</span></strong>

  <span class="pd_blue7"># Logs in the given User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_in</span>(user)
    session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>id
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Remembers a user in a persistent session.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">remember</span>(user)
    User<span class="pd_ash">.</span>remember
    cookies<span class="pd_ash">.</span>permanent<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue5">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>id
    cookies<span class="pd_ash">.</span>permanent<span class="pd_ash">[</span><span class="pd_blue5">:remember_token</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>remember_token
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns the user corresponding to the remember token cookie.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">current_user</span>
<span class="mark">    <strong><span class="pd_green4">if</span></strong> (user_id <span class="pd_ash">=</span> session<span class="pd_ash">[</span><span class="pd_blue5">:user_id</span><span class="pd_ash">]</span>)</span>
<span class="mark">      <span class="pd_blue5">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red5">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green4">id</span>: user_id)</span>
<span class="mark">    <strong><span class="pd_green4">elsif</span></strong> (user_id = cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue5">:user_id</span><span class="pd_ash">]</span>)</span>
<span class="mark">      user <span class="pd_ash">=</span> <span class="pd_red5">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green4">id</span>: user_id)</span>
<span class="mark">      <strong><span class="pd_green4">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> <span class="pd_red5">User</span><span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue5">:remember_token</span><span class="pd_ash">]</span>)</span>
<span class="mark">        log_in user</span>
<span class="mark">        <span class="pd_blue5">@current_user</span> <span class="pd_ash">=</span> user</span>
<span class="mark">      <strong><span class="pd_green4">end</span></strong></span>
<span class="mark">  <strong><span class="pd_green4">end</span></strong></span>
<strong><span class="pd_green">end</span></strong>
<span epub:type="pagebreak" id="page_447"></span>
  <span class="pd_blue7"># Returns true if the user is logged in, false otherwise.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">logged_in?</span>
    <span class="pd_ash">!</span>current_User<span class="pd_ash">.</span>nil?
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Logs out the current User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_out</span>
    session<span class="pd_ash">.</span>delete(<span class="pd_blue1">:user_id</span>)
    <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> <strong><span class="pd_green">nil</span></strong>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">With the code as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex09">Listing 9.9</a>, newly logged in users are correctly remembered, as you can verify by logging in, closing the browser, and checking that youre still logged in when you restart the sample application and revisit the sample application.<sup><a id="ch09fn10a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn10">10</a></sup> If you want, you can even inspect the browser cookies to see the result directly (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fig02">Figure 9.2</a>).<sup><a id="ch09fn11a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn11">11</a></sup></p>
<p class="footnote"><a id="ch09fn10" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn10a">10</a>. Alert reader Jack Fahnestock has noted an edge case that isnt covered by the current design:</p>
<p class="footnum">1. Log in with remember me checked in browser A (saving hashed remember token A to <span class="dark-green"><strong><code>remember_digest</code></strong></span>).</p>
<p class="footnum">2. Log in with remember me checked in browser B (saving hashed <span class="dark-green"><strong><code>remember_token</code></strong></span> B to <span class="dark-green"><strong><code>remember_digest</code></strong></span>, overwriting remember token A saved in browser A).</p>
<p class="footnum">3. Close browser A (now relying on permanent cookies for loginsecond conditional in <span class="dark-green"><strong><code>current_user</code></strong></span> method).</p>
<p class="footnum">4. Reopen browser A (<span class="dark-green"><strong><code>logged_in?</code></strong></span> returns false, even though permanent cookies are on the browser).</p>
<p class="footnotep">Although this is arguably a more secure design than remembering the user in multiple places, it violates the expectation that users can be permanently remembered on more than one browser. The solution, which is substantially more complicated than the present design, is to factor the remember digest into a separate table, where each row has a user id and a digest. Checking for the current user would then look through the table for a digest corresponding to a particular remember token. Furthermore, the <span class="dark-green"><strong><code>forget</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex011">Listing 9.11</a> method would delete only the row corresponding to the digest of the current browser. For security purposes, logging out would remove all digests for that user.</p>
<p class="footnote"><a id="ch09fn11" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn11a">11</a>. Google &lt;your browser name&gt; inspect cookies to learn how to inspect the cookies on your system.</p>
<figure id="ch09fig02" class="image-l">
<img src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/fig09_02.jpg" alt="Image" width="677" height="256" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig09_02.jpg">
<figcaption><p><strong>Figure 9.2:</strong> The remember token cookie in the local browser.</p></figcaption>
</figure>
<p class="indent">Theres only one problem with our application as it stands: Short of clearing their browser cookies (or waiting 20 years), theres no way for users to log out. This is exactly the sort of thing our test suite should catch, and indeed the tests should currently be <span class="pd_red5"><code>RED</code></span>:<span epub:type="pagebreak" id="page_448"></span></p>
<p class="ex-title" id="ch09ex010"><strong>Listing 9.10:</strong> <span class="pd_red5"><code>RED</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev99">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">By finding the cookie in your local browser, verify that a remember token and encrypted user id are present after logging in.</p></li>
<li><p class="num">At the console, verify directly that the <span class="dark-green"><strong><code>authenticated?</code></strong></span> method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex06">Listing 9.6</a> works correctly.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec9_1_3">9.1.3 Forgetting Users</h4>
<p class="noindent">To allow users to log out, well define methods to forget users in analogy with the methods to remember them. The resulting <span class="dark-green"><strong><code>user.forget</code></strong></span> method just undoes <span class="dark-green"><strong><code>user.remember</code></strong></span> by updating the remember digest with <span class="dark-green"><strong><code>nil</code></strong></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex011">Listing 9.11</a>.<span epub:type="pagebreak" id="page_449"></span></p>
<p class="ex-title" id="ch09ex011"><strong>Listing 9.11:</strong> Adding a <span class="dark-green"><strong><code>forget</code></strong></span> method to the User model. <span class="pd_red5"><code>RED</code></span></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-11a" id="lis9-11">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue3">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
  <strong><span class="pd_green">attr_accessor</span></strong> <span class="pd_blue1">:remember_token</span>
  before_save { <span class="pd_green">self</span><span class="pd_ash">.</span>email <span class="pd_ash">=</span> email<span class="pd_ash">.</span>downcase }
  validates <span class="pd_blue1">:name</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">50</span> }
  <span class="pd_red">VALID_EMAIL_REGEX</span> <span class="pd_ash">=</span> <span class="pd_red">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  validates <span class="pd_blue1">:email</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">maximum</span>: <span class="pd_ash">255</span> },
                    <span class="pd_green">format</span>: { <span class="pd_blue1">with</span>: <span class="pd_red">VALID_EMAIL_REGEX</span> },
                    <span class="pd_blue1">uniqueness</span>: <strong><span class="pd_green">true</span></strong>
  has_secure_password
  validates <span class="pd_blue1">:password</span>, <span class="pd_blue1">presence</span>: <strong><span class="pd_green">true</span></strong>, <span class="pd_blue1">length</span>: { <span class="pd_blue1">minimum</span>: <span class="pd_ash">6</span> }

  <span class="pd_blue7"># Returns the hash digest of the given string.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue1">User</span></strong><span class="pd_ash">.</span><span class="pd_blue1">digest</span>(string)
    cost <span class="pd_ash">=</span> <span class="pd_red">ActiveModel</span><span class="pd_ash">::</span><span class="pd_red">SecurePassword</span><span class="pd_ash">.</span>min_cost ? <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">::</span><span class="pd_red">MIN_COST</span> :
                                                  <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Engine</span><span class="pd_ash">.</span>cost
    <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>create(string, <span class="pd_blue1">cost</span>: cost)
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns a random token.</span>
  <strong><span class="pd_green">def</span> <span class="pd_blue1">User</span></strong><span class="pd_ash">.</span><span class="pd_blue1">new_token</span>
    <span class="pd_red">SecureRandom</span><span class="pd_ash">.</span>urlsafe_base64
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Remembers a user in the database for use in persistent sessions.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">remember</span>
    <span class="pd_green">self</span><span class="pd_ash">.</span>remember_token <span class="pd_ash">=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>new_token
    update_attribute(<span class="pd_blue1">:remember_digest</span>, <span class="pd_red">User</span><span class="pd_ash">.</span>digest(remember_token))
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Returns true if the given token matches the digest.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">authenticated?</span>(remember_token)
    <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>new(remember_digest).is_password?(remember_token)
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Forgets a User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">forget</span>
<span class="mark">    update_attribute(<span class="pd_blue5">:remember_digest</span>, <strong><span class="pd_green4">nil</span></strong>)</span>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex011">Listing 9.11</a>, were now ready to forget a permanent session by adding a <span class="dark-green"><strong><code>forget</code></strong></span> helper and calling it from the <span class="dark-green"><strong><code>log_out</code></strong></span> helper (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex012">Listing 9.12</a>). As seen <span epub:type="pagebreak" id="page_450"></span>in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex012">Listing 9.12</a>, the <span class="dark-green"><strong><code>forget</code></strong></span> helper calls <span class="dark-green"><strong><code>User<span class="pd_ash">.</span>forget</code></strong></span> and then deletes the <span class="dark-green"><strong><code>user_id</code></strong></span> and <span class="dark-green"><strong><code>remember_token</code></strong></span> cookies.</p>
<p class="ex-title" id="ch09ex012"><strong>Listing 9.12:</strong> Logging out from a persistent session. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/helpers/sessions_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-12a" id="lis9-12">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">module</span> <span class="pd_blue5">SessionsHelper</span></strong>

  <span class="pd_blue7"># Logs in the given User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_in</span>(user)
    session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>id
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_blue7"># Forgets a persistent session.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">forget</span>(user)
<span class="mark">    User<span class="pd_ash">.</span>forget</span>
<span class="mark">    cookies<span class="pd_ash">.</span>delete(<span class="pd_blue5">:user_id</span>)</span>
<span class="mark">    cookies<span class="pd_ash">.</span>delete(<span class="pd_blue5">:remember_token</span>)</span>
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Logs out the current User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_out</span>
<span class="mark">    forget(current_user)</span>
    session<span class="pd_ash">.</span>delete(<span class="pd_blue1">:user_id</span>)
    <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> <strong><span class="pd_green">nil</span></strong>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">At this point, the tests suite should be <span class="pd_green5"><code>GREEN</code></span>:</p>
<p class="ex-title" id="ch09ex013"><strong>Listing 9.13:</strong> <span class="pd_green5"><code>GREEN</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev100">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_451"></span></p>
<ol class="num">
<li><p class="num">After logging out, verify that the corresponding cookies have been removed from your browser.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec9_1_4">9.1.4 Two Subtle Bugs</h4>
<p class="noindent">There are two closely related subtleties left to address. The first subtlety is that, even though the Log out link appears only when logged-in, a user could potentially have multiple browser windows open to the site. If the user logged out in one window, thereby setting <span class="dark-green"><strong><code>current_user</code></strong></span> to <span class="dark-green"><strong><code>nil</code></strong></span>, clicking the Log out link in a second window would result in an error because of <span class="dark-green"><strong><code>forget(current_user)</code></strong></span> in the <span class="dark-green"><strong><code>log_out</code></strong></span> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex012">Listing 9.12</a>).<sup><a id="ch09fn12a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn12">12</a></sup> We can avoid this by logging out only if the user is logged in.</p>
<p class="footnote"><a id="ch09fn12" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn12a">12</a>. Thanks to reader Paulo Clio Jnior for pointing this out.</p>
<p class="indent">The second subtlety is that a user could be logged in (and remembered) in multiple browsers, such as Chrome and Firefox, which causes a problem if the user logs out in the first browser but not the second, and then closes and re-opens the second one.<sup><a id="ch09fn13a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn13">13</a></sup> For example, suppose that the user logs out in Firefox, thereby setting the remember digest to <span class="dark-green"><strong><code>nil</code></strong></span> (via <span class="dark-green"><strong><code>user.forget</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex011">Listing 9.11</a>). The application will still work in Firefox; because the <span class="dark-green"><strong><code>log_out</code></strong></span> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex012">Listing 9.12</a> deletes the users id, both highlighted conditionals are <span class="dark-green"><strong><code>false</code></strong></span>:</p>
<p class="footnote"><a id="ch09fn13" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn13a">13</a>. Thanks to reader Niels de Ron for pointing this out.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg451a" id="pg451">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_blue7"># Returns the user corresponding to the remember token cookie.</span>
<strong><span class="pd_green">def</span></strong> <span class="pd_blue5">current_user</span>
<span class="mark1">  <strong><span class="pd_green4">if</span></strong> (user_id <span class="pd_ash">=</span> session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)</span>
    <span class="pd_blue1">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
<span class="mark1">  <strong><span class="pd_green4">elsif</span></strong> (user_id = cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)</span>
    user <span class="pd_ash">=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
    <strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> <span class="pd_red">User</span><span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>)
      log_in user
      <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> user
    <strong><span class="pd_green">end</span></strong>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent">As a result, evaluation falls off the end of the <span class="dark-green"><strong><code>current_user</code></strong></span> method, thereby returning <span class="dark-green"><strong><code>nil</code></strong></span> as required.<span epub:type="pagebreak" id="page_452"></span></p>
<p class="indent">In contrast, if we close Chrome, we set <span class="dark-green"><strong><code>session[:user_id]</code></strong></span> to <span class="dark-green"><strong><code>nil</code></strong></span> (because all <span class="dark-green"><strong><code>session</code></strong></span> variables expire automatically on browser close), but the <span class="dark-green"><strong><code>user_id</code></strong></span> <em>cookie</em> will still be present. This means that the corresponding user will still be pulled out of the database when Chrome is relaunched:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg452-1a" id="pg452-1">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_blue7"># Returns the user corresponding to the remember token cookie.</span>
<strong><span class="pd_green">def</span></strong> <span class="pd_blue5">current_user</span>
  <strong><span class="pd_green">if</span></strong> (user_id <span class="pd_ash">=</span> session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)
    @current_user ||= <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
<span class="mark1">  <strong><span class="pd_green4">elsif</span></strong> (user_id = cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue5">:user_id</span><span class="pd_ash">]</span>)</span>
<span class="mark1">   user <span class="pd_ash">=</span> <span class="pd_red5">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)</span>
<span class="mark1">   <strong><span class="pd_green4">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue5">:remember_token</span><span class="pd_ash">]</span>)</span>
     log_in user
     <span class="pd_blue5">@current_user</span> <span class="pd_ash">=</span> user
   <strong><span class="pd_green">end</span></strong>
 <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent">Consequently, the inner <span class="dark-green"><strong><code>if</code></strong></span> conditional will be evaluated:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg452-2a" id="pg452-2">Click here to view code image</a></p>
<pre class="pre1">user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>)</pre>
<p class="noindent">In particular, because <span class="dark-green"><strong><code>user</code></strong></span> isnt <span class="dark-green"><strong><code>nil</code></strong></span>, the <em>second</em> expression will be evaluated, which raises an error. This is because the users remember digest was deleted as part of logging out (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex011">Listing 9.11</a>) in Firefox. So when we access the application in Chrome, we end up calling</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg452-3a" id="pg452-3">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>new(remember_digest)<span class="pd_ash">.</span>is_password?(remember_token)</pre>
<p class="noindent">with a <span class="dark-green"><strong><code>nil</code></strong></span> remember digest, thereby raising an exception inside the bcrypt library. To fix this, we want <span class="dark-green"><strong><code>authenticated?</code></strong></span> to return <span class="dark-green"><strong><code>false</code></strong></span> instead.</p>
<p class="indent">These are exactly the sorts of subtleties that benefit from test-driven development, so well write tests to catch the two errors before correcting them. We first get the integration test from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex038">Listing 8.38</a> to <span class="pd_red5"><code>RED</code></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex014">Listing 9.14</a>.</p>
<p class="ex-title" id="ch09ex014"><strong>Listing 9.14:</strong> A test for logging out in a second window. <span class="pd_red5"><code>RED</code></span></p>
<pre class="pre2">test/integration/users_login_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-14a" id="lis9-14">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_green">require</span> <span class="pd_red">'test_helper'</span>

<strong><span class="pd_green">class</span> <span class="pd_blue5">UsersLoginTest</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ActionDispatch</span><span class="pd_ash">::</span><span class="pd_red">IntegrationTest</span>
<span epub:type="pagebreak" id="page_453"></span>  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_green">test</span> <span class="pd_red">"login with valid information followed by logout"</span> <strong><span class="pd_green">do</span></strong>
    get login_path
    post login_path, <span class="pd_blue1">params</span>: { <span class="pd_blue1">session</span>: { <span class="pd_blue1">email</span>:    <span class="pd_blue1">@User</span><span class="pd_ash">.</span>email,
                                          <span class="pd_blue1">password</span>: <span class="pd_red">'password'</span> } }
    assert is_logged_in?
    assert_redirected_to <span class="pd_blue1">@user</span>
    follow_redirect!
    assert_template <span class="pd_red">'users/show'</span>
    assert_select <span class="pd_red">"a[href=?]"</span>, login_path, <span class="pd_blue1">count</span>: <span class="pd_ash">0</span>
    assert_select <span class="pd_red">"a[href=?]"</span>, logout_path
    assert_select <span class="pd_red">"a[href=?]"</span>, user_path(<span class="pd_blue1">@user</span>)
    delete logout_path
    assert_not is_logged_in?
    assert_redirected_to root_url
<span class="mark">    <span class="pd_green4"># Simulate a user clicking logout in a second window.</span></span>
<span class="mark">    delete logout_path</span>
    follow_redirect!
    assert_select <span class="pd_red">"a[href=?]"</span>, login_path
    assert_select <span class="pd_red">"a[href=?]"</span>, logout_path,      <span class="pd_blue1">count</span>: <span class="pd_ash">0</span>
    assert_select <span class="pd_red">"a[href=?]"</span>, user_path(<span class="pd_blue1">@user</span>), <span class="pd_blue1">count</span>: <span class="pd_ash">0</span>
 <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent">The second call to <span class="dark-green"><strong><code>delete logout_path</code></strong></span> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex014">Listing 9.14</a> should raise an error due to the missing <span class="dark-green"><strong><code>current_user</code></strong></span>, leading to a <span class="pd_red5"><code>RED</code></span> test suite:</p>
<p class="ex-title" id="ch09ex015"><strong>Listing 9.15:</strong> <span class="pd_red5"><code>RED</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">The application code simply involves calling <span class="dark-green"><strong><code>log_out</code></strong></span> only if <span class="dark-green"><strong><code>logged_in?</code></strong></span> is true, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex016">Listing 9.16</a>.</p>
<p class="ex-title" id="ch09ex016"><strong>Listing 9.16:</strong> Only logging out if logged in. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/controllers/sessions_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-16a" id="lis9-16">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue5">SessionsController</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationController</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">destroy</span>
<span epub:type="pagebreak" id="page_454"></span><span class="mark">    log_out <strong><span class="pd_green4">if</span></strong> logged_in?</span>
    redirect_to root_url
 <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">The second case, involving a scenario with two different browsers, is harder to simulate with an integration test, but its easy to check in the User model test directly. All we need is to start with a user that has no remember digest (which is true for the <span class="dark-green"><strong><code>@user</code></strong></span> variable defined in the <span class="dark-green"><strong><code>setup</code></strong></span> method) and then call <span class="dark-green"><strong><code>authenticated?</code></strong></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex017">Listing 9.17</a>. (Note that weve left the remember token blank; it doesnt matter what its value is, because the error occurs before it ever gets used.)</p>
<p class="ex-title" id="ch09ex017"><strong>Listing 9.17:</strong> A test of <span class="dark-green"><strong><code>authenticated?</code></strong></span> with a nonexistent digest. <span class="pd_red5"><code>RED</code></span></p>
<pre class="pre2">test/models/user_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-17a" id="lis9-17">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_green">require</span> <span class="pd_red">'test_helper'</span>

<strong><span class="pd_green">class</span> <span class="pd_blue5">UserTest</span></strong> &lt; <span class="pd_red">ActiveSupport</span><span class="pd_ash">::</span><span class="pd_red">TestCase</span>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">setup</span>
    <span class="pd_blue1">@user</span> <span class="pd_ash">=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>new(<span class="pd_green">name</span>: <span class="pd_red">"Example User"</span>, <span class="pd_blue1">email</span>: <span class="pd_red">"user@example.com"</span>,
                     <span class="pd_blue1">password</span>: <span class="pd_red">"foobar"</span>, <span class="pd_blue1">password_confirmation</span>: <span class="pd_red">"foobar"</span>)
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
<span class="mark">  <span class="pd_green">test</span> <span class="pd_red5">"authenticated? should return false for a user with nil digest"</span> <strong><span class="pd_green4">do</span></strong></span>
<span class="mark">    assert_not <span class="pd_blue5">@User</span><span class="pd_ash">.</span>authenticated?(<span class="pd_red5">''</span>)</span>
<span class="mark"> <strong><span class="pd_green5">end</span></strong></span>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="indent">Because <span class="dark-green"><strong><code>BCrypt::Password.new(nil)</code></strong></span> raises an error, the test suite should now be <span class="pd_red5"><code>RED</code></span>:</p>
<p class="ex-title" id="ch09ex018"><strong>Listing 9.18:</strong> <span class="pd_red5"><code>RED</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_455"></span>To fix the error and get to <span class="pd_green5"><code>GREEN</code></span>, all we need to do is return <span class="dark-green"><strong><code>false</code></strong></span> if the remember digest is <span class="dark-green"><strong><code>nil</code></strong></span>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex019">Listing 9.19</a>.</p>
<p class="ex-title" id="ch09ex019"><strong>Listing 9.19:</strong> Updating <span class="dark-green"><strong><code>authenticated?</code></strong></span> to handle a nonexistent digest. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/models/<span class="pd_red5">User</span><span class="pd_ash">.</span>rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-19a" id="lis9-19">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue3">User</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationRecord</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_blue7"># Returns true if the given token matches the digest.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">authenticated?</span>(remember_token)
<span class="mark">    <strong><span class="pd_green4">return false if</span></strong> remember_digest<span class="pd_ash">.</span>nil?</span>
    <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>new(remember_digest).is_password?(remember_token)
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Forgets a User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">forget</span>
    update_attribute(<span class="pd_blue1">:remember_digest</span>, <strong><span class="pd_green">nil</span></strong>)
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent">This uses the <span class="dark-green"><strong><code>return</code></strong></span> keyword to return immediately if the remember digest is <span class="dark-green"><strong><code>nil</code></strong></span>, which is a common way to emphasize that the rest of the method gets ignored in that case. The equivalent code</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg455a" id="pg455">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">if</span></strong> remember_digest<span class="pd_ash">.</span>nil?
  <strong><span class="pd_green">false</span></strong>
<strong><span class="pd_green">else</span></strong>
  <span class="pd_red">BCrypt</span><span class="pd_ash">::</span><span class="pd_red">Password</span><span class="pd_ash">.</span>new(remember_digest)<span class="pd_ash">.</span>is_password?(remember_token)
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent">would also work fine, but I prefer the explicitness of the version in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex019">Listing 9.19</a> (which also happens to be slightly shorter).</p>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex019">Listing 9.19</a>, our full test suite should be <span class="pd_green5"><code>GREEN</code></span>, and both subtleties should now be addressed:</p>
<p class="ex-title" id="ch09ex020"><strong>Listing 9.20:</strong> <span class="pd_green5"><code>GREEN</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev101"><span epub:type="pagebreak" id="page_456"></span>Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Comment out the fix in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex016">Listing 9.16</a> and then verify that the first subtle bug is present by opening two logged-in tabs, logging out in one, and then clicking Log out link in the other.</p></li>
<li><p class="num">Comment out the fix in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex019">Listing 9.19</a> and verify that the second subtle bug is present by logging out in one browser and closing and opening the second browser.</p></li>
<li><p class="num">Uncomment the fixes and confirm that the test suite goes from <span class="pd_red5"><code>RED</code></span> to <span class="pd_green5"><code>GREEN</code></span>.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec9_2">9.2 Remember Me Checkbox</h3>
<p class="noindent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_1_3">Section 9.1.3</a>, our application has a complete, professional-grade authentication system. As a final step, well see how to make staying logged in optional using a remember me checkbox. A mockup of the login form with such a checkbox appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fig03">Figure 9.3</a>.</p>
<figure id="ch09fig03" class="image-l">
<img src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/fig09_03.jpg" alt="Image" width="677" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig09_03.jpg">
<figcaption><p><strong>Figure 9.3:</strong> A mockup of a remember me checkbox.</p></figcaption>
</figure>
<p class="indent">To write the implementation, we start by adding a checkbox to the login form from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex04">Listing 8.4</a>. As with labels, text fields, password fields, and submit buttons, check-boxes can be created with a Rails helper method. In order to get the styling right, though, we have to <em>nest</em> the checkbox inside the label, as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg456a" id="pg456">Click here to view code image</a></p>
<pre class="pre1"><span class="pd_orange">&lt;%=</span> f<span class="pd_ash">.</span>label <span class="pd_blue1">:remember_me</span>, <span class="pd_blue1">class:</span> <span class="pd_red">"checkbox inline"</span> <strong><span class="pd_green">do</span></strong> <span class="pd_orange">%&gt;</span>
  <span class="pd_orange">&lt;%=</span> f<span class="pd_ash">.</span>check_box <span class="pd_blue1">:remember_me</span> <span class="pd_orange">%&gt;</span>
  &lt;<strong><span class="pd_green">span</span></strong>&gt;Remember me on this computer&lt;/<strong><span class="pd_green">span</span></strong>&gt;
<span class="pd_orange">&lt;%</span> <strong><span class="pd_green">end</span></strong> <span class="pd_orange">%&gt;</span></pre>
<p class="noindent">Putting this into the login form gives the code shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex021">Listing 9.21</a>.</p>
<p class="ex-title" id="ch09ex021"><strong>Listing 9.21:</strong> Adding a remember me checkbox to the login form.</p>
<pre class="pre2">app/views/sessions/new.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-21a" id="lis9-21">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_orange">&lt;%</span> provide(<span class="pd_blue1">:title</span>, <span class="pd_red">"Log in"</span>) <span class="pd_orange">%&gt;</span>
&lt;<strong><span class="pd_green">h1</span></strong>&gt;Log in&lt;/<strong><span class="pd_green">h1</span></strong>&gt;

&lt;<strong><span class="pd_green">div</span></strong> <span class="pd_green4">class</span>=<span class="pd_red">"row"</span>&gt;
<span epub:type="pagebreak" id="page_457"></span>&lt;<strong><span class="pd_green">div</span></strong> <span class="pd_green4">class</span>=<span class="pd_red">"col-md-6 col-md-offset-3"</span>&gt;
  <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> form_with(<span class="pd_blue1">url</span>: login_path, <span class="pd_blue1">scope</span>: <span class="pd_blue1">:session</span>, <span class="pd_blue1">local</span>: <strong><span class="pd_green">true</span></strong>) <strong><span class="pd_green">do</span></strong> <span class="pd_ash">|</span>f<span class="pd_ash">|</span> <span class="pd_orange">%&gt;</span>

    <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> f<span class="pd_ash">.</span>label <span class="pd_blue1">:email</span> <span class="pd_orange">%&gt;</span>
    <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> f<span class="pd_ash">.</span>email_field <span class="pd_blue1">:email</span>, <span class="pd_blue1">class</span>: <span class="pd_red">'form-control'</span> <span class="pd_orange">%&gt;</span>

    <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> f<span class="pd_ash">.</span>label <span class="pd_blue1">:password</span> <span class="pd_orange">%&gt;</span>
    <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> f<span class="pd_ash">.</span>password_field <span class="pd_blue1">:password</span>, <span class="pd_blue1">class</span>: <span class="pd_red">'form-control'</span> <span class="pd_orange">%&gt;</span>

<span class="mark">    <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> f<span class="pd_ash">.</span>label <span class="pd_blue5">:remember_me</span>, <span class="pd_blue5">class</span>: <span class="pd_red5">"checkbox inline"</span> <strong><span class="pd_green4">do</span></strong> <span class="pd_orange">%&gt;</span></span>
<span class="mark">     <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> f<span class="pd_ash">.</span>check_box <span class="pd_blue5">:remember_me</span> <span class="pd_orange">%&gt;</span></span>
<span class="mark">     <span class="pd_green4">&lt;<strong>span</strong>&gt;</span>Remember me on this computer<span class="pd_green4">&lt;/<strong>span</strong>&gt;</span></span>
<span class="mark">    <span class="pd_orange">&lt;%</span> <strong><span class="pd_green4">end</span></strong> <span class="pd_orange">%&gt;</span> </span>

    <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> f<span class="pd_ash">.</span>submit <span class="pd_red">"Log in"</span>, <span class="pd_blue1">class</span>: <span class="pd_red">"btn btn-primary"</span> <span class="pd_orange">%&gt;</span>
  <span class="pd_orange">&lt;%</span> <strong><span class="pd_green">end</span></strong> <span class="pd_orange">%&gt;</span>
<span epub:type="pagebreak" id="page_458"></span>
   &lt;<strong><span class="pd_green">p</span></strong>&gt;New user? <span class="pd_orange"><span class="pd_orange">&lt;%</span>=</span> link_to <span class="pd_red">"Sign up now!"</span>, signup_path <span class="pd_orange">%&gt;</span>&lt;/<strong><span class="pd_green">p</span></strong>&gt;
 &lt;/<strong><span class="pd_green">div</span></strong>&gt;
&lt;/<strong><span class="pd_green">div</span></strong>&gt;</pre>
</div>
<p class="indent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex021">Listing 9.21</a>, weve included the CSS classes <span class="dark-green"><strong><code>checkbox</code></strong></span> and <span class="dark-green"><strong><code>inline</code></strong></span>, which Bootstrap uses to put the checkbox and the text (Remember me on this computer) in the same line. To complete the styling, we need just a few more CSS rules, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex022">Listing 9.22</a>. The resulting login form appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fig04">Figure 9.4</a>.</p>
<figure id="ch09fig04" class="image-l">
<img src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/fig09_04.jpg" alt="Image" width="677" height="520" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig09_04.jpg">
<figcaption><p><strong>Figure 9.4:</strong> The login form with an added remember me checkbox.</p></figcaption>
</figure>
<p class="ex-title" id="ch09ex022"><strong>Listing 9.22:</strong> CSS for the remember me checkbox.</p>
<pre class="pre2">app/assets/stylesheets/custom.scss</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-22a" id="lis9-22">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_blue5">.</span>
<span class="pd_blue5">.</span>
<span class="pd_blue5">.</span>
/* <strong><span class="pd_green">forms</span></strong> */
<span class="pd_blue5">.</span>
<span class="pd_blue5">.</span>
<span class="pd_blue5">.</span>
<span class="pd_blue5">.<strong>checkbox</strong></span> {
  <strong><span class="pd_green">margin-top</span></strong><span class="pd_red">:</span> <strong><span class="pd_green">-10px</span></strong><span class="pd_ash">;</span>
  <strong><span class="pd_green">margin-bottom</span></strong><span class="pd_red">:</span> <strong><span class="pd_green">10px</span></strong><span class="pd_ash">;</span>
  <strong><span class="pd_green">span</span></strong> {
    <strong><span class="pd_green">margin-left</span></strong><span class="pd_red">:</span> <strong><span class="pd_green">20px</span></strong><span class="pd_ash">;</span>
    <strong><span class="pd_green">font-weight</span></strong><span class="pd_red">:</span> <strong><span class="pd_green">normal</span></strong><span class="pd_ash">;</span>
  }
}

<strong><span class="pd_blue5">#session_remember_me</span></strong> {
  <strong><span class="pd_green">width</span></strong><span class="pd_red">:</span> <strong><span class="pd_green">auto</span></strong><span class="pd_ash">;</span>
  <strong><span class="pd_green">margin-left</span></strong><span class="pd_red">:</span> <strong><span class="pd_green">0</span></strong><span class="pd_ash">;</span>
}</pre>
</div>
<p class="indent">Having edited the login form, were now ready to remember users if they check the checkbox and forget them otherwise. Incredibly, because of all our work in the previous sections, the implementation can be reduced to one line. We start by noting that the <span class="dark-green"><strong><code>params</code></strong></span> hash for submitted login forms now includes a value based on the checkbox (as you can verify by submitting the form in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex021">Listing 9.21</a> with invalid information and inspecting the values in the debug section of the page). In particular, the value of<span epub:type="pagebreak" id="page_459"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#apg459a" id="apg459">Click here to view code image</a></p>
<pre class="pre1">params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:remember_me</span><span class="pd_ash">]</span></pre>
<p class="noindent">is <span class="dark-green"><strong><code>'1'</code></strong></span> if the box is checked and <span class="dark-green"><strong><code>'0'</code></strong></span> if it isnt.</p>
<p class="indent">By testing the relevant value of the <span class="dark-green"><strong><code>params</code></strong></span> hash, we can now remember or forget the user based on the value of the submission:<sup><a id="ch09fn14a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn14">14</a></sup></p>
<p class="footnote"><a id="ch09fn14" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn14a">14</a>. This means unchecking the box will log out the user on all browsers on all computers. The alternative design of remembering user login sessions on each browser independently is potentially more convenient for users, but less secure as well as more complicated to implement. Ambitious readers are invited to try their hand at implementing it.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg459a" id="pg459">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">if</span></strong> params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:remember_me</span><span class="pd_ash">]</span> <span class="pd_ash">==</span> <span class="pd_red">'1'</span>
  remember(user)
<strong><span class="pd_green">else</span></strong>
  forget(user)
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent"><span epub:type="pagebreak" id="page_460"></span>As explained in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#box9_2">Box 9.2</a>, this sort of <span class="dark-green"><strong><code>if</code></strong></span>-<span class="dark-green"><strong><code>then</code></strong></span> branching structure can be converted to one line using the <em>ternary operator</em> as follows:<sup><a id="ch09fn15a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn15">15</a></sup></p>
<p class="footnote"><a id="ch09fn15" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fn15a">15</a>. Earlier we wrote <span class="dark-green"><strong><code>remember user</code></strong></span> without parentheses, but when used with the ternary operator, omitting them results in a syntax error.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg460a" id="pg460">Click here to view code image</a></p>
<pre class="pre1">params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:remember_me</span><span class="pd_ash">]</span> <span class="pd_ash">==</span> <span class="pd_red">'1'</span> ? remember(user) : forget(user)</pre>
<p class="noindent">Using this to replace <span class="dark-green"><strong><code>remember user</code></strong></span> in the Sessions controllers <span class="dark-green"><strong><code>create</code></strong></span> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex07">Listing 9.7</a>) leads to the amazingly compact code shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex023">Listing 9.23</a>. (Now youre in a position to understand the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex025">Listing 8.25</a>, which uses the ternary operator to define the bcrypt <span class="dark-green"><strong><code>cost</code></strong></span> variable.)</p>
<p class="ex-title" id="ch09ex023"><strong>Listing 9.23:</strong> Handling the submission of the remember me checkbox.</p>
<pre class="pre2">app/controllers/sessions_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-23a" id="lis9-23">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue5">SessionsController</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationController</span>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">new</span>
  <strong><span class="pd_green">end</span></strong>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">create</span>
    user <span class="pd_ash">=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_blue1">email</span>: params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:email</span><span class="pd_ash">]</span><span class="pd_ash">.</span>downcase)
    <strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticate(params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:password</span><span class="pd_ash">]</span>)
      log_in user
<span class="mark">      params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:remember_me</span><span class="pd_ash">]</span> <span class="pd_ash">==</span> <span class="pd_red">'1'</span> ? remember(user) : forget(user)</span>
      redirect_to user
    <strong><span class="pd_green">else</span></strong>
      flash<span class="pd_ash">.</span>now<span class="pd_ash">[</span><span class="pd_blue1">:danger</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> <span class="pd_red">'Invalid email/password combination'</span>
      render <span class="pd_red">'new'</span>
    <strong><span class="pd_green">end</span></strong>
  <strong><span class="pd_green">end</span></strong>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">destroy</span>
    log_out <strong><span class="pd_green">if</span></strong> logged_in?
    redirect_to root_url
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent">With the implementation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex023">Listing 9.23</a>, our login system is complete, as you can verify by checking or unchecking the box in your browser.<span epub:type="pagebreak" id="page_461"></span></p>
<div class="box">
<p class="box-caption" id="box9_2">Box 9.2: 10 Types of People</p>
<p class="boxnp">Theres an old joke that there are 10 kinds of people in the world: those who understand binary and those who dont (10, of course, being 2 in binary). In this spirit, we can say that there are 10 kinds of people in the world: those who like the ternary operator, those who dont, and those who dont yet know about it. (If you happen to be in the third category, soon you wont be any longer.)</p>
<p class="boxip">When you do a lot of programming, you quickly learn that one of the most common bits of control flow goes something like this:</p>
<pre>if boolean?
  do_one_thing
else
  do_something_else
end</pre>
<p class="boxnp">Ruby, like many other languages (including C/C++, Perl, PHP, and Java), allows you to replace this with a much more compact expression using the <em>ternary operator</em> (so called because it consists of three parts):</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg461-2a" id="pg461-2">Click here to view code image</a></p>
<pre>boolean? ? do_one_thing : do_something_else</pre>
<p class="boxnp">You can also use the ternary operator to replace assignment, so that</p>
<pre>if boolean?
  var = foo
else
  var = bar
end</pre>
<p class="boxnp">becomes</p>
<pre>var = boolean? ? foo : bar</pre>
<p class="boxnp">Finally, its often convenient to use the ternary operator in a functions return value:</p>
<pre>def foo
  do_stuff
  boolean? ? "bar" : "baz"
end</pre>
<p class="boxnp">Since Ruby implicitly returns the value of the last expression in a function, here the <code>foo</code> method returns <code>"bar"</code> or <code>"baz"</code> depending on whether <code>boolean?</code> is <code>true</code> or <code>false</code>.<span epub:type="pagebreak" id="page_462"></span></p>
</div>
<section>
<h5 class="h5" id="lev102">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">By inspecting your browsers cookies directly, verify that the remember me checkbox is having its intended effect.</p></li>
<li><p class="num">At the console, invent examples showing both possible behaviors of the ternary operator (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#box9_2">Box 9.2</a>).</p></li>
</ol>
</section>
</section>
<section>
<h3 class="h3" id="sec9_3">9.3 Remember Tests</h3>
<p class="noindent">Although our remember me functionality is now working, its important to write some tests to verify its behavior. One reason is to catch implementation errors, as discussed in a moment. Even more important, though, is that the core user persistence code is completely untested at present. Fixing these issues will require some trickery, but the result will be a far more powerful test suite.</p>
<section>
<h4 class="h4" id="sec9_3_1">9.3.1 Testing the Remember Me Checkbox</h4>
<p class="noindent">When I originally implemented the checkbox handling in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex023">Listing 9.23</a>, instead of the correct</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg462-1a" id="pg462-1">Click here to view code image</a></p>
<pre class="pre1">params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:remember_me</span><span class="pd_ash">]</span> <span class="pd_ash">==</span> <span class="pd_red">'1'</span> ? remember(user) : forget(user)</pre>
<p class="noindent">I actually used</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg462-2a" id="pg462-2">Click here to view code image</a></p>
<pre class="pre1">params<span class="pd_ash">[</span><span class="pd_blue1">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue1">:remember_me</span><span class="pd_ash">]</span> ? remember(user) : forget(user)</pre>
<p class="noindent">In this context, <span class="dark-green"><strong><code>params[:session][:remember_me]</code></strong></span> is either <span class="dark-green"><strong><code>'0'</code></strong></span> or <span class="dark-green"><strong><code>'1'</code></strong></span>, both of which are <span class="dark-green"><strong><code>true</code></strong></span> in a boolean context, so the resulting expression is <em>always true</em>, and the application acts as if the checkbox is always checked. This is exactly the kind of error a test should catch.</p>
<p class="indent">Because remembering users requires that they be logged in, our first step is to define a helper to log users in inside tests. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex027">Listing 8.27</a>, we logged a user in using the <span class="dark-green"><strong><code>post</code></strong></span> method and a valid <span class="dark-green"><strong><code>session</code></strong></span> hash, but its cumbersome to do this every <span epub:type="pagebreak" id="page_463"></span>time. To avoid needless repetition, well write a helper method called <span class="dark-green"><strong><code>log_in_as</code></strong></span> to log in for us.</p>
<p class="indent">Our method for logging a user in depends on the type of test. Inside controller tests, we can manipulate the <span class="dark-green"><strong><code>session</code></strong></span> method directly, assigning <span class="dark-green"><strong><code>user<span class="pd_ash">.</span>id</code></strong></span> to the <span class="dark-green"><strong><code>:user_id</code></strong></span> key (as first seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex014">Listing 8.14</a>):</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#apg463-2a" id="apg463-2">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_in_as</span>(user)
  session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> user<span class="pd_ash">.</span>id
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent">We call the method <span class="dark-green"><strong><code>log_in_as</code></strong></span> to avoid any confusion with the application codes <span class="dark-green"><strong><code>log_in</code></strong></span> method as defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex014">Listing 8.14</a>. Its location is in the <span class="dark-green"><strong><code>ActiveSupport::-TestCase</code></strong></span> class inside the <span class="dark-green"><strong><code>test_helper</code></strong></span> file, the same location as the <span class="dark-green"><strong><code>is_logged_in?</code></strong></span> helper from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex033">Listing 8.33</a>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg463-2a" id="pg463-2">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">class</span> <span class="pd_blue5">ActiveSupport</span></strong><span class="pd_ash">::</span><span class="pd_red">TestCase</span>
  fixtures <span class="pd_blue1">:all</span>

  <span class="pd_blue7"># Returns true if a test user is logged in.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">is_logged_in?</span>
    <span class="pd_ash">!</span>session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">].</span>nil?
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Log in as a particular User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_in_as</span>(user)
    session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>id
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent">We wont actually need this version of the method in this chapter, but well put it to use in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">Chapter 10</a>.</p>
<p class="indent">Inside integration tests, we cant manipulate <span class="dark-green"><strong><code>session</code></strong></span> directly, but we can <span class="dark-green"><strong><code>post</code></strong></span> to the sessions path as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex027">Listing 8.27</a>, which leads to the <span class="dark-green"><strong><code>log_in_as</code></strong></span> method shown here:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg463-3a" id="pg463-3">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">class</span> <span class="pd_blue5">ActionDispatch</span></strong><span class="pd_ash">::</span><span class="pd_red">IntegrationTest</span>

  <span class="pd_blue7"># Log in as a particular User.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_in_as</span>(user, <span class="pd_blue1">password</span>: <span class="pd_red">'password'</span>, <span class="pd_blue1">remember_me</span>: <span class="pd_red">'1'</span>)
    post login_path, <span class="pd_blue1">params</span>: { <span class="pd_blue1">session</span>: { <span class="pd_blue1">email</span>: User<span class="pd_ash">.</span>email,
<span epub:type="pagebreak" id="page_464"></span>                                          <span class="pd_blue1">password</span>: password,
                                          <span class="pd_blue1">remember_me</span>: remember_me } }
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
<p class="noindent">Because its located inside the <span class="dark-green"><strong><code><span class="pd_red">ActionDispatch</span><span class="pd_ash">::</span><span class="pd_red">IntegrationTest</span></code></strong></span> class, this version of <span class="dark-green"><strong><code>log_in_as</code></strong></span> will be called inside integration tests. We use the same method name in both cases because it lets us do things like use code from a controller test in an integration without making any changes to the login method.</p>
<p class="indent">Putting these two methods together yields the parallel <span class="dark-green"><strong><code>log_in_as</code></strong></span> helpers shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex024">Listing 9.24</a>.</p>
<p class="ex-title" id="ch09ex024"><strong>Listing 9.24:</strong> Adding a <span class="dark-green"><strong><code>log_in_as</code></strong></span> helper.</p>
<pre class="pre2">test/test_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-24a" id="lis9-24">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_red">ENV</span><span class="pd_ash">[</span><span class="pd_red">'RAILS_ENV'</span><span class="pd_ash">] ||</span><span class="pd_ash">=</span> <span class="pd_red"><span class="pd_red">'test'</span></span>
<span class="pd_ash">.</span>
<span class="pd_ash">.</span>
<span class="pd_ash">.</span>
<strong><span class="pd_green">class</span> <span class="pd_blue5">ActiveSupport</span></strong><span class="pd_ash">::</span><span class="pd_red">TestCase</span>
  fixtures <span class="pd_blue1">:all</span>

  <span class="pd_blue7"># Returns true if a test user is logged in.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">is_logged_in?</span>
    <span class="pd_ash">!</span>session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>.nil?
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_blue7"># Log in as a particular User.</span>
<span class="mark">  <strong><span class="pd_green4">def</span></strong> <span class="pd_blue5">log_in_as</span>(user)</span>
    session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> User<span class="pd_ash">.</span>id
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong>

<strong><span class="pd_green">class</span> <span class="pd_blue5">ActionDispatch</span></strong><span class="pd_ash">::</span><span class="pd_red">IntegrationTest</span>

  <span class="pd_blue7"># Log in as a particular User.</span>
<span class="mark">  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">log_in_as</span>(user, <span class="pd_blue5">password</span>: <span class="pd_red5">'password'</span>, <span class="pd_blue5">remember_me</span>: <span class="pd_red5">'1'</span>)</span>
    post login_path, <span class="pd_blue1">params</span>: { <span class="pd_blue1">session</span>: { <span class="pd_blue1">email</span>: User<span class="pd_ash">.</span>email,
                                          <span class="pd_blue1">password</span>: password,
                                          <span class="pd_blue1">remember_me</span>: remember_me } }
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_465"></span>Note that, for maximum flexibility, the second <span class="dark-green"><strong><code>log_in_as</code></strong></span> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex024">Listing 9.24</a> accepts keyword arguments (as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07ex013">Listing 7.13</a>), with default values for the password and for the remember me checkbox set to <span class="dark-green"><strong><code>'password'</code></strong></span> and <span class="dark-green"><strong><code>'1'</code></strong></span>, respectively.</p>
<p class="indent">To verify the behavior of the remember me checkbox, well write two tests, one each for submitting user information with and without the checkbox checked. This is easy using the login helper defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex024">Listing 9.24</a>, with the two cases appearing as</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg465-1a" id="pg465-1">Click here to view code image</a></p>
<pre class="pre1">log_in_as(<span class="pd_blue1">@user</span>, <span class="pd_blue1">remember_me</span>: <span class="pd_red">'1'</span>)</pre>
<p class="noindent">and</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg465-2a" id="pg465-2">Click here to view code image</a></p>
<pre class="pre1">log_in_as(<span class="pd_blue1">@user</span>, <span class="pd_blue1">remember_me</span>: <span class="pd_red">'0'</span>)</pre>
<p class="noindent">(Because <span class="dark-green"><strong><code>'1'</code></strong></span> is the default value of <span class="dark-green"><strong><code>remember_me</code></strong></span>, we could omit the corresponding option in the first case here, but Ive included it to make the parallel structure more apparent.)</p>
<p class="indent">After logging in, we can check if the user has been remembered by looking for the <span class="dark-green"><strong><code>remember_token</code></strong></span> key in the <span class="dark-green"><strong><code>cookies</code></strong></span>. Ideally, we would check that the cookies value is equal to the users remember token, but as currently designed theres no way for the test to get access to it: The <span class="dark-green"><strong><code>user</code></strong></span> variable in the controller has a remember token attribute, but (because <span class="dark-green"><strong><code>remember_token</code></strong></span> is virtual) the <span class="dark-green"><strong><code>@user</code></strong></span> variable in the test doesnt. Fixing this minor blemish is left as an exercise (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_3_1">Section 9.3.1</a>), but for now we can just test to see whether the relevant cookie is <span class="dark-green"><strong><code>nil</code></strong></span>. The results appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex025">Listing 9.25</a>. (Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex027">Listing 8.27</a> that <span class="dark-green"><strong><code>users(:michael)</code></strong></span> references the fixture user from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08ex026">Listing 8.26</a>.)</p>
<p class="ex-title" id="ch09ex025"><strong>Listing 9.25:</strong> A test of the remember me checkbox. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">test/integration/users_login_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-25a" id="lis9-25">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_green">require</span> <span class="pd_red">'test_helper'</span>

<strong><span class="pd_green">class</span> <span class="pd_blue5">UsersLoginTest</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ActionDispatch</span><span class="pd_ash">::</span><span class="pd_red">IntegrationTest</span>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">setup</span>
    <span class="pd_blue1">@user</span> <span class="pd_ash">=</span> users(<span class="pd_blue1">:michael</span>)
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_green">test</span> <span class="pd_red">"login with remembering"</span> <strong><span class="pd_green">do</span></strong>
<span epub:type="pagebreak" id="page_466"></span><span class="mark">    log_in_as(<span class="pd_blue5">@user</span>, <span class="pd_blue5">remember_me</span>: <span class="pd_red5">'1'</span>)</span>
<span class="mark">    assert_not_nil cookies[<span class="pd_red5">'remember_token'</span>]</span>
  <strong><span class="pd_green">end</span></strong>


  test <span class="pd_red">"login without remembering"</span> <strong><span class="pd_green">do</span></strong>
<span class="mark">    <span class="pd_green"># Log in to set the cookie.</span></span>
<span class="mark">    log_in_as(<span class="pd_blue5">@user</span>, <span class="pd_blue5">remember_me</span>: <span class="pd_red5">'1'</span>)</span>
<span class="mark">    <span class="pd_green"># Log in again and verify that the cookie is deleted.</span></span>
<span class="mark">    log_in_as(<span class="pd_blue5">@user</span>, <span class="pd_blue5">remember_me</span>: <span class="pd_red5">'0'</span>)</span>
<span class="mark">    assert_nil cookies[<span class="pd_red5">'remember_token'</span>]</span>
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent">Assuming you didnt make the same implementation mistake I did, the tests should be <span class="pd_green5"><code>GREEN</code></span>:</p>
<p class="ex-title" id="ch09ex026"><strong>Listing 9.26:</strong> <span class="pd_green5"><code>GREEN</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev103">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">As mentioned in this section, the application currently doesnt have any way to access the virtual <span class="dark-green"><strong><code>remember_token</code></strong></span> attribute in the integration test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex025">Listing 9.25</a>. It is possible, though, using a special test method called <span class="dark-green"><strong><code>assigns</code></strong></span>. Inside a test, you can access <em>instance</em> variables defined in the controller by using <span class="dark-green"><strong><code>assigns</code></strong></span> with the corresponding symbol. For example, if the <span class="dark-green"><strong><code>create</code></strong></span> action defines an <span class="dark-green"><strong><code>@user</code></strong></span> variable, we can access it in the test using <span class="dark-green"><strong><code>assigns(:user)</code></strong></span>. Right now, the Sessions controller <span class="dark-green"><strong><code>create</code></strong></span> action defines a normal (non-instance) variable called <span class="dark-green"><strong><code>user</code></strong></span>, but if we change it to an instance variable we can test that <span class="dark-green"><strong><code>cookies</code></strong></span> correctly contains the users remember token. By filling in the missing elements in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex027">Listing 9.27</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex028">Listing 9.28</a> (indicated with question marks <span class="dark-green"><strong><code>?</code></strong></span> and <span class="dark-green"><strong><code>FILL_IN</code></strong></span>), complete this improved test of the remember me checkbox.<span epub:type="pagebreak" id="page_467"></span></p></li>
</ol>
<p class="ex-title" id="ch09ex027"><strong>Listing 9.27:</strong> A template for using an instance variable in the <span class="dark-green"><strong><code>create</code></strong></span> action.</p>
<pre class="pre2">app/controllers/sessions_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-27a" id="lis9-27">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">class</span> <span class="pd_blue5">SessionsController</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ApplicationController</span>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">new</span>
  <strong><span class="pd_green">end</span></strong>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">create</span>
<span class="mark">    ?user <span class="pd_ash">=</span> <span class="pd_red5">User</span><span class="pd_ash">.</span>find_by(<span class="pd_blue5">email</span>: params<span class="pd_ash">[</span><span class="pd_blue5">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue5">:email</span><span class="pd_ash">]</span><span class="pd_ash">.</span>downcase)</span>
<span class="mark">    <strong><span class="pd_green">if</span></strong> ?user <span class="pd_ash">&amp;&amp;</span> ?User<span class="pd_ash">.</span>authenticate(params<span class="pd_ash">[</span><span class="pd_blue5">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue5">:password</span><span class="pd_ash">]</span>)</span>
<span class="mark">      log_in ?user</span>
<span class="mark">      params<span class="pd_ash">[</span><span class="pd_blue5">:session</span><span class="pd_ash">]</span><span class="pd_ash">[</span><span class="pd_blue5">:remember_me</span><span class="pd_ash">]</span> <span class="pd_ash">==</span> <span class="pd_red5">'1'</span> ? remember(?user) : forget(?user)</span>
<span class="mark">      redirect_to ?user</span>
    <strong><span class="pd_green">else</span></strong>
      flash<span class="pd_ash">.</span>now<span class="pd_ash">[</span><span class="pd_blue1">:danger</span><span class="pd_ash">]</span> <span class="pd_ash">=</span> <span class="pd_red">'Invalid email/password combination'</span>
      render <span class="pd_red">'new'</span>
    <strong><span class="pd_green">end</span></strong>
  <strong><span class="pd_green">end</span></strong>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">destroy</span>
    log_out <strong><span class="pd_green">if</span></strong> logged_in?
    redirect_to root_url
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="ex-title" id="ch09ex028"><strong>Listing 9.28:</strong> A template for an improved remember me test. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">test/integration/users_login_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-28a" id="lis9-28">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_green">require</span> <span class="pd_red">'test_helper'</span>

<strong><span class="pd_green">class</span> <span class="pd_blue5">UsersLoginTest</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ActionDispatch</span><span class="pd_ash">::</span><span class="pd_red">IntegrationTest</span>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">setup</span>
    <span class="pd_blue1">@user</span> = users(<span class="pd_blue1">:michael</span>)
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  test <span class="pd_red">"login with remembering"</span> <strong><span class="pd_green">do</span></strong>
    log_in_as(<span class="pd_blue1">@user</span>, <span class="pd_blue1">remember_me</span>: <span class="pd_red">'1'</span>)
<span class="mark">    assert_equal <span class="pd_red5">FILL_IN</span>, assigns(<span class="pd_blue5">:user</span>)<span class="pd_ash">.</span>FILL_IN</span>
  <strong><span class="pd_green">end</span></strong>

  test <span class="pd_red">"login without remembering"</span> <strong><span class="pd_green">do</span></strong>
    <span class="pd_blue7"># Log in to set the cookie.</span>
    log_in_as(<span class="pd_blue1">@user</span>, <span class="pd_blue1">remember_me</span>: <span class="pd_red">'1'</span>)
<span epub:type="pagebreak" id="page_468"></span>    <span class="pd_blue7"># Log in again and verify that the cookie is deleted.</span>
    log_in_as(<span class="pd_blue1">@user</span>, <span class="pd_blue1">remember_me</span>: <span class="pd_red">'0'</span>)
    assert_empty cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
<strong><span class="pd_green">end</span></strong></pre>
</div>
</section>
</section>
<section>
<h4 class="h4" id="sec9_3_2">9.3.2 Testing the Remember Branch</h4>
<p class="noindent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#sec9_1_2">Section 9.1.2</a>, we verified by hand that the persistent session implemented in the preceding sections is working, but in fact the relevant branch in the <span class="dark-green"><strong><code>current_user</code></strong></span> method is currently completely untested. My favorite way to handle this kind of situation is to raise an exception in the suspected untested block of code: If the code isnt covered, the tests will still pass; if it is covered, the resulting error will identify the relevant test. The result in the present case appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex029">Listing 9.29</a>.</p>
<p class="ex-title" id="ch09ex029"><strong>Listing 9.29:</strong> Raising an exception in an untested branch. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/helpers/sessions_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-29a" id="lis9-29">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">module</span> <span class="pd_blue5">SessionsHelper</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_blue7"># Returns the user corresponding to the remember token cookie.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">current_user</span>
    <strong><span class="pd_green">if</span></strong> (user_id <span class="pd_ash">=</span> session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)
      <span class="pd_blue1">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
    <strong><span class="pd_green">elsif</span></strong> (user_id = cookies.encrypted<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)
<span class="mark">      <strong><span class="pd_green4">raise</span></strong>       <span class="pd_green"># The tests still pass, so this branch is currently untested.</span></span>
      user <span class="pd_ash">=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
      <strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>)
        log_in user
        <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> user
      <strong><span class="pd_green">end</span></strong>
    <strong><span class="pd_green">end</span></strong>
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_469"></span>At this point, the tests are <span class="pd_green5"><code>GREEN</code></span>:</p>
<p class="ex-title" id="ch09ex030"><strong>Listing 9.30:</strong> <span class="pd_green5"><code>GREEN</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">This is a problem, of course, because the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex029">Listing 9.29</a> is broken. Moreover, persistent sessions are cumbersome to check by hand, so if we ever want to refactor the <span class="dark-green"><strong><code>current_user</code></strong></span> method (as we will in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">Chapter 11</a>) its important to test it.</p>
<p class="indent">Because both versions of the <span class="dark-green"><strong><code>log_in_as</code></strong></span> helper method defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex024">Listing 9.24</a> automatically set <span class="dark-green"><strong><code>session[:user_id]</code></strong></span> (either explicitly or by posting to the login path), testing the remember branch of the <span class="dark-green"><strong><code>current_user</code></strong></span> method is difficult in an integration test. Luckily, we can bypass this restriction by testing the <span class="dark-green"><strong><code>current_user</code></strong></span> method directly in a Sessions helper test, whose file we have to create:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg469a" id="pg469">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_blue1">$</span></strong> touch test/helpers/sessions_helper_test.rb</pre>
<p class="noindent">The test sequence is simple:</p>
<ol class="num">
<li><p class="num">Define a <span class="dark-green"><strong><code>user</code></strong></span> variable using the fixtures.</p></li>
<li><p class="num">Call the <span class="dark-green"><strong><code>remember</code></strong></span> method to remember the given user.</p></li>
<li><p class="num">Verify that <span class="dark-green"><strong><code>current_user</code></strong></span> is equal to the given user.</p></li>
</ol>
<p class="noindent">Because the <span class="dark-green"><strong><code>remember</code></strong></span> method doesnt set <span class="dark-green"><strong><code>session[:user_id]</code></strong></span>, this procedure will test the desired remember branch. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex031">Listing 9.31</a>.</p>
<p class="ex-title" id="ch09ex031"><strong>Listing 9.31:</strong> A test for persistent sessions. <span class="pd_red5"><code>RED</code></span></p>
<pre class="pre2">test/helpers/sessions_helper_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-31a" id="lis9-31">Click here to view code image</a></p>
<div class="example">
<pre><span class="pd_green">require</span> <span class="pd_red">'test_helper'</span>

<strong><span class="pd_green">class</span> <span class="pd_blue5">SessionsHelperTest</span></strong> <span class="pd_ash">&lt;</span> <span class="pd_red">ActionView</span><span class="pd_ash">::</span><span class="pd_red">TestCase</span>

  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">setup</span>
    <span class="pd_blue1">@user</span> = users(<span class="pd_blue1">:michael</span>)
    remember(<span class="pd_blue1">@user</span>)
  <strong><span class="pd_green">end</span></strong>

<span epub:type="pagebreak" id="page_470"></span>  <span class="pd_green">test</span> <span class="pd_red">"current_user returns right user when session is nil"</span> <strong><span class="pd_green">do</span></strong>
    assert_equal <span class="pd_blue1">@user</span>, current_user
    assert is_logged_in?
  <strong><span class="pd_green">end</span></strong>

  <span class="pd_green">test</span> <span class="pd_red">"current_user returns nil when remember digest is wrong"</span> <strong><span class="pd_green">do</span></strong>
    <span class="pd_blue1">@User</span><span class="pd_ash">.</span>update_attribute(<span class="pd_blue1">:remember_digest</span>, <span class="pd_red">User</span><span class="pd_ash">.</span>digest(<span class="pd_red">User</span><span class="pd_ash">.</span>new_token))
    assert_nil current_user
  <strong><span class="pd_green">end</span></strong>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent">Note that weve added a second test, which checks that the current user is <span class="dark-green"><strong><code>nil</code></strong></span> if the users remember digest doesnt correspond correctly to the remember token, thereby testing the <span class="dark-green"><strong><code>authenticated?</code></strong></span> expression in the nested <span class="dark-green"><strong><code>if</code></strong></span> statement:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg470-1a" id="pg470-1">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> user<span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>)</pre>
<p class="indent">Incidentally, in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex031">Listing 9.31</a> we could write</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg470-2a" id="pg470-2">Click here to view code image</a></p>
<pre class="pre1">assert_equal current_user, <span class="pd_blue1">@user</span></pre>
<p class="noindent">instead, and it would work just the same. As mentioned briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#sec5_3_4">Section 5.3.4</a>, though, the conventional order for the arguments to <span class="dark-green"><strong><code>assert_equal</code></strong></span> is <em>expected</em>, <em>actual</em>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg470-3a" id="pg470-3">Click here to view code image</a></p>
<pre class="pre1">assert_equal <span class="pd_ash">&lt;</span>expected<span class="pd_ash">&gt;</span>, <span class="pd_ash">&lt;</span>actual<span class="pd_ash">&gt;</span></pre>
<p class="noindent">which in the case of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex031">Listing 9.31</a> gives</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg470-4a" id="pg470-4">Click here to view code image</a></p>
<pre class="pre1">assert_equal <span class="pd_blue1">@user</span>, current_user</pre>
<p class="indent">With the code as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex031">Listing 9.31</a>, the test is <span class="pd_red5"><code>RED</code></span> as required:</p>
<p class="ex-title" id="ch09ex032"><strong>Listing 9.32:</strong> <span class="pd_red5"><code>RED</code></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-32a" id="lis9-32">Click here to view code image</a></p>
<div class="example">
<pre>$ rails test test/helpers/sessions_helper_test.rb</pre>
</div>
<p class="indent">We can get the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex031">Listing 9.31</a> to pass by removing the <span class="dark-green"><strong><code>raise</code></strong></span> and restoring the original <span class="dark-green"><strong><code>current_user</code></strong></span> method, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex033">Listing 9.33</a>.<span epub:type="pagebreak" id="page_471"></span></p>
<p class="ex-title" id="ch09ex033"><strong>Listing 9.33:</strong> Removing the raised exception. <span class="pd_green5"><code>GREEN</code></span></p>
<pre class="pre2">app/helpers/sessions_helper.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#lis9-33a" id="lis9-33">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="pd_green">module</span> <span class="pd_blue5">SessionsHelper</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_blue7"># Returns the user corresponding to the remember token cookie.</span>
  <strong><span class="pd_green">def</span></strong> <span class="pd_blue5">current_user</span>
    <strong><span class="pd_green">if</span></strong> (user_id <span class="pd_ash">=</span> session<span class="pd_ash">[</span><span class="pd_blue1">:user_id</span><span class="pd_ash">]</span>)
      <span class="pd_blue1">@current_user</span> <span class="pd_ash">||=</span> <span class="pd_red">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
<span class="mark">    <strong><span class="pd_green4">elsif</span></strong> (user_id = cookies<span class="pd_ash">.</span>encrypted<span class="pd_ash">[</span><span class="pd_blue5">:user_id</span><span class="pd_ash">]</span>)</span>
      user <span class="pd_ash">=</span> <span class="pd_red5">User</span><span class="pd_ash">.</span>find_by(<span class="pd_green">id</span>: user_id)
      <strong><span class="pd_green">if</span></strong> user <span class="pd_ash">&amp;&amp;</span> User<span class="pd_ash">.</span>authenticated?(cookies<span class="pd_ash">[</span><span class="pd_blue1">:remember_token</span><span class="pd_ash">]</span>)
        log_in user
        <span class="pd_blue1">@current_user</span> <span class="pd_ash">=</span> user
      <strong><span class="pd_green">end</span></strong>
    <strong><span class="pd_green">end</span></strong>
  <strong><span class="pd_green">end</span></strong>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
  <span class="pd_ash">.</span>
<strong><span class="pd_green">end</span></strong></pre>
</div>
<p class="noindent">At this point, the test suite should be <span class="pd_green5"><code>GREEN</code></span>:</p>
<p class="ex-title" id="ch09ex034"><strong>Listing 9.34:</strong> <span class="pd_green5"><code>GREEN</code></span></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="noindent">Now that the remember branch of <span class="dark-green"><strong><code>current_user</code></strong></span> is tested, we can be confident of catching regressions without having to check by hand.</p>
<section>
<h5 class="h5" id="lev104">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other peoples answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Verify by removing the <span class="dark-green"><strong><code>authenticated?</code></strong></span> expression in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex033">Listing 9.33</a> that the second test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09ex031">Listing 9.31</a> fails, thereby confirming that it tests the right thing.<span epub:type="pagebreak" id="page_472"></span></p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec9_4">9.4 Conclusion</h3>
<p class="noindent">Weve covered a lot of ground in the last three chapters, transforming our promising but unformed application into a site capable of the full suite of signup and login behaviors. All that is needed to complete the authentication functionality is to restrict access to pages based on login status and user identity. Well accomplish this task en route to giving users the ability to edit their information, which is the main goal of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">Chapter 10</a>.</p>
<p class="indent">Before moving on, merge your changes back into the master branch:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg472-1a" id="pg472-1">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git add -A
$ git commit -m "Implement advanced login"
$ git checkout master
$ git merge advanced-login
$ git push</pre>
<p class="indent">Before deploying to Heroku, its worth noting that the application will briefly be in an invalid state after pushing but before the migration is finished. On a production site with significant traffic, its a good idea to turn on <em>maintenance mode</em> before making the changes:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09_images.xhtml#pg472-2a" id="pg472-2">Click here to view code image</a></p>
<pre class="pre1">$ heroku maintenance:on
$ git push heroku
$ heroku run rails db:migrate
$ heroku maintenance:off</pre>
<p class="noindent">This arranges to show a standard error page during the deployment and migration (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09fig05">Figure 9.5</a>). (We wont bother with this step again, but its good to see it at least once.) For more information, see the Heroku documentation on error pages.</p>
<figure id="ch09fig05" class="image-l">
<img src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/fig09_05.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig09_05.jpg">
<figcaption><p><strong>Figure 9.5:</strong> The production app in maintenance mode.</p></figcaption>
</figure>
<section>
<h4 class="h4" id="sec9_4_1">9.4.1 What We Learned in this Chapter</h4>
<p class="bullet"> Rails can maintain state from one page to the next using persistent cookies via the <span class="dark-green"><strong><code>cookies</code></strong></span> method.</p>
<p class="bullet"> We associate to each user a remember token and a corresponding remember digest for use in persistent sessions.<span epub:type="pagebreak" id="page_473"></span></p>
<p class="bullet"> Using the <span class="dark-green"><strong><code>cookies</code></strong></span> method, we create a persistent session by placing a permanent remember token cookie on the browser.</p>
<p class="bullet"> Login status is determined by the presence of a current user based on the temporary sessions user id or the permanent sessions unique remember token.</p>
<p class="bullet"> The application signs users out by deleting the sessions user id and removing the permanent cookie from the browser.</p>
<p class="bullet"> The ternary operator is a compact way to write simple if-then statements.<span epub:type="pagebreak" id="page_474"></span></p>
</section>
</section>
</section>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-11" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 8. Basic Login</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Chapter 10. Updating, Showing, and Deleting Users</div>
        </a>
    
  
  </div>

</section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed slideUp">
        
        
          <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        

        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
  <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright"> 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(1)" charset="utf-8"></script><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/embed.js.download"></script>
    <script src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(2)" charset="utf-8"></script>
  

<div></div><div></div><div class="selection_bubble_root" style="display: none;"></div><div class="annotator-notice"></div><div class="font-flyout" style="top: 201.006px; left: 1194.34px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#">Reset</a>
</div>
</div><script type="text/javascript" async="" src="./Chapter 9. Advanced Login - Ruby on Rails Tutorial, 6th Edition_files/generic1604331345324.js.download" charset="UTF-8"></script><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script><span></span><script type="text/javascript" id="">dataLayer.push({"ld.experiment":void 0,"ld.variation":void 0});</script></body></html>