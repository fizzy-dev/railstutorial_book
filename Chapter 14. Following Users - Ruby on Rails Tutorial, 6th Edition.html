<!DOCTYPE html>
<!-- saved from url=(0080)https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage no-applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/ruby-on-rails/9780136702726/ch10.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="10224494" data-user-uuid="66943332-5511-462c-876e-5d5b720c7edf" data-username="czjtgu3dkobug4zdmolfga2wembsmu" data-account-type="Trial" data-activated-trial-date="12/02/2020" data-archive="9780136702726" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch10.xhtml" data-epub-title="Ruby on Rails Tutorial, 6th Edition" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9780136702726"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/css" rel="stylesheet" type="text/css"><title>Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition</title><link rel="stylesheet" href="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/output.731fc84c4f9a.css" type="text/css"><link rel="stylesheet" type="text/css" href="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/font-awesome.min.css"><style type="text/css" title="ibis-book">@page{margin:1em 2em}#sbo-rt-content div{margin-top:1em;margin-bottom:1em;margin-left:1em;margin-right:1em;text-align:justify}#sbo-rt-content div.cover img{max-width:99%;max-height:99%}#sbo-rt-content .att{text-align:right}#sbo-rt-content .cover{margin-top:.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .h1{margin-top:1.5em;margin-bottom:.5em;font-weight:bold;font-size:210%;page-break-after:avoid;border-bottom:solid .1em;text-align:center}#sbo-rt-content .halftitle{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:210%;page-break-after:avoid;text-align:center}#sbo-rt-content .h2{margin-top:1em;margin-bottom:.1em;font-weight:bold;font-size:180%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2f{margin-top:1em;margin-bottom:2.5em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .h2t{margin-top:1em;margin-bottom:2em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content .center{text-align:center}#sbo-rt-content .h3{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:160%;page-break-after:avoid;text-align:left}#sbo-rt-content .h4{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:130%;page-break-after:avoid;text-align:left}#sbo-rt-content .h5{margin-top:.5em;margin-bottom:.001em;font-weight:bold;font-size:120%;page-break-after:avoid;text-align:left}#sbo-rt-content ul{margin-top:1em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content ul.sq{list-style-type:square}#sbo-rt-content ul.sq li p,#sbo-rt-content ul.sq li p.noindent{margin-top:.5em;margin-left:1em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .left{text-align:left}#sbo-rt-content .ex-title{margin-top:.8em;margin-bottom:.5em;text-indent:.1em;font-size:100%}#sbo-rt-content code{font-family:Courier,Courier New,monospace;font-size:small}#sbo-rt-content pre{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small}#sbo-rt-content .pre3{font-family:Courier,Courier New,monospace;margin-top:1em;margin-bottom:1em;margin-left:2.9em;background-color:#E6E6E6}#sbo-rt-content .equ{margin-top:.8em;margin-bottom:.5em;text-align:center}#sbo-rt-content .footnum{margin-top:.7em;margin-bottom:.5em;text-indent:-1em;margin-left:3.3em}#sbo-rt-content .footnotep{margin-top:.8em;margin-left:.8em;margin-bottom:.5em;text-indent:.8em}#sbo-rt-content .mark1{background-color:#F4F7F9}#sbo-rt-content .codelink{margin-top:.2em;margin-bottom:.5em}#sbo-rt-content .middle img{vertical-align:middle}#sbo-rt-content .box{margin-top:.6em;margin-bottom:1em;margin-left:.1em;margin-right:.8em;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .box-bq{font-size:.8em;margin-top:.8em;margin-bottom:.5em;margin-left:1.6em;text-indent:.1em;background-color:#E6E6E6}#sbo-rt-content .boxip{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:.8em;background-color:#E6E6E6}#sbo-rt-content ol.num{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p{list-style-type:number;font-weight:normal}#sbo-rt-content ol.num li p,#sbo-rt-content ol.num li p.number{margin-top:.5em;margin-left:.2em;margin-bottom:.5em;text-indent:.002em}#sbo-rt-content .num-p{margin-top:.5em;margin-bottom:.5em;margin-left:0}#sbo-rt-content .bullet{margin-top:.7em;margin-bottom:.5em;text-indent:-.8em;margin-left:2em}#sbo-rt-content .credit{margin-top:.1em;margin-bottom:.1em;text-indent:-1.5em;margin-left:2em}#sbo-rt-content .box-caption{margin-top:.1em;margin-bottom:1em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:left}#sbo-rt-content .example{font-family:Courier,Courier New,monospace;margin-top:.6em;margin-bottom:1em;margin-left:.1em;line-height:1.3em;font-size:small;border-top:.02em solid black;border-bottom:.02em solid black}#sbo-rt-content .image-l{margin-top:.8em;margin-left:1em;text-align:center}#sbo-rt-content .topbot{margin-top:.8em;margin-bottom:.5em;border-bottom:solid black .1em;border-top:solid black .1em;text-indent:.1em}#sbo-rt-content .uln{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash{margin-top:.7em;margin-bottom:.7em;margin-left:2em}#sbo-rt-content .fdash1{margin-top:.7em;margin-bottom:.7em;margin-left:3em}#sbo-rt-content .tr{border-bottom:.1em solid black}#sbo-rt-content th{text-align:left}#sbo-rt-content td{padding-left:.1em;padding-top:0;padding-bottom:0;vertical-align:top;text-align:left}#sbo-rt-content .mark{background-color:#E6E6E6}#sbo-rt-content .pre1{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:0;padding:.8em;background-color:#E6E6E6}#sbo-rt-content .pre2{font-family:Courier,Courier New,monospace;margin-top:.2em;margin-bottom:1em;margin-left:.2em}#sbo-rt-content .tab-thc{margin-top:.1em;margin-bottom:.1em;border-bottom:solid black .1em;text-align:center}#sbo-rt-content .tab-th{margin-top:.1em;border-bottom:solid black .1em;border-top:solid black .1em;text-align:left}#sbo-rt-content .author{margin-top:2.5em;margin-bottom:5.5em;text-align:center;font-size:120%}#sbo-rt-content .pub{margin-top:1.5em;margin-bottom:.5em;text-align:center}#sbo-rt-content .pub1{font-weight:bold;font-size:.9em;margin-top:.1em;margin-bottom:.5em;text-align:center}#sbo-rt-content .copy{margin-top:.9em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .copy1{margin-top:.9em;margin-bottom:.2em;text-indent:.02em}#sbo-rt-content .copy2{margin-top:.2em;margin-bottom:.5em;text-indent:.02em}#sbo-rt-content .title{margin-top:1em;margin-bottom:.2em;font-size:125%;font-weight:bold;text-indent:.02em;text-align:center}#sbo-rt-content .noindent{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .tab-para{margin-top:.1em;margin-bottom:.1em;margin-left:.1em;text-indent:0}#sbo-rt-content .tab-parai{margin-top:.1em;margin-bottom:.1em;margin-left:1.1em;text-indent:-1.1em}#sbo-rt-content .boxnp{margin-top:.5em;margin-bottom:.5em;text-indent:.1em}#sbo-rt-content .toc-intro{margin-top:.1em;margin-bottom:.5em;margin-left:1.5em;text-align:left}#sbo-rt-content .tocchap{margin-top:1.5em;margin-bottom:.4em;margin-left:3.4em;text-indent:-4em}#sbo-rt-content .toclev1{margin-top:.4em;margin-bottom:.4em;margin-left:1em}#sbo-rt-content .toclev2{margin-top:.4em;margin-bottom:.4em;margin-left:2.6em}#sbo-rt-content .toclev1a{margin-top:.4em;margin-bottom:.4em;margin-left:.5em}#sbo-rt-content .toc-index{margin-top:2em;margin-bottom:.4em;margin-left:.7em}#sbo-rt-content .indexmain{margin-top:.4em;margin-bottom:.2em;margin-left:.8em;text-indent:-.8em}#sbo-rt-content .indexsub{margin-top:.4em;margin-bottom:.2em;margin-left:1.7em;text-indent:-.7em}#sbo-rt-content .indexsubsub{margin-top:.4em;margin-bottom:.2em;font-style:italic;margin-left:3em;text-indent:-.9em}#sbo-rt-content figcaption{margin-top:.8em;margin-bottom:.5em;color:black;text-align:left;text-indent:.1em}#sbo-rt-content .subtitle{margin-top:.1em;margin-bottom:1em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .edition{margin-top:2em;margin-bottom:3em;font-weight:bold;font-size:150%;page-break-after:avoid;text-align:center}#sbo-rt-content .indent{margin-top:.5em;margin-left:.1em;margin-bottom:.5em;text-indent:1.5em}#sbo-rt-content .h2a{margin-top:.1em;margin-bottom:2em;font-weight:bold;font-size:190%;page-break-after:avoid;text-align:left}#sbo-rt-content figure>img{max-width:99%;max-height:99%}#sbo-rt-content figure{margin-top:1em;margin-bottom:1em;margin-left:.5em;margin-right:1.5em}#sbo-rt-content none{list-style-type:none}#sbo-rt-content a{text-decoration:none}#sbo-rt-content .footnote{font-size:.8em;margin-top:.1em;margin-bottom:.5em;margin-left:.8em}#sbo-rt-content .none{margin-top:.5em;margin-left:1em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content div.image-p img{width:80%}#sbo-rt-content .image-p{page-break-before:always;text-align:center}#sbo-rt-content table{border-collapse:collapse;border-spacing:0;background:transparent;vertical-align:top;margin-top:.1em;margin-right:.1em;margin-bottom:.9em;margin-left:0;width:100%}#sbo-rt-content .tab-parar{margin-top:.1em;margin-bottom:.1em;text-indent:.1em;text-align:right}#sbo-rt-content .h2i{margin-top:1em;margin-bottom:2.1em;font-weight:bold;font-size:190%;border-bottom:solid .1em;page-break-after:avoid;text-align:left}#sbo-rt-content pre{overflow:auto;-ms-overflow:auto;-moz-overflow:auto;-webkit-overflow:auto;-ms-padding-bottom:5pt;-moz-padding-bottom:5pt;-webkit-padding-bottom:5pt}#sbo-rt-content .maroon{color:#BB2121}#sbo-rt-content .green{color:#005A00}#sbo-rt-content .green1{color:#48785D}#sbo-rt-content .navy{color:#504B72}#sbo-rt-content .ash{color:#666}#sbo-rt-content .blue{color:#408080}#sbo-rt-content .green3{color:#00A100}#sbo-rt-content .blue1{color:#0000B8}#sbo-rt-content .violet{color:#1A177D}#sbo-rt-content .pink{color:#A131A1}#sbo-rt-content .pink1{color:#A131A1}#sbo-rt-content .red{color:#800}#sbo-rt-content .blue3{color:#2E3192}#sbo-rt-content .red2{color:#B80000}#sbo-rt-content .green4{color:#269200}#sbo-rt-content .ash1{color:#666}#sbo-rt-content .ash2{color:#33484A}#sbo-rt-content .red2{color:#640000}#sbo-rt-content .ash3{color:#7D8F29}#sbo-rt-content .red5{color:#BD7B00}#sbo-rt-content .maroon1{color:#B66600}#sbo-rt-content .blue5{color:#1F3BFF}#sbo-rt-content .red6{color:#B68}#sbo-rt-content .green7{color:#14B600}#sbo-rt-content .maroon2{color:#B66600}#sbo-rt-content .pink2{color:#AC21FF}#sbo-rt-content .pink3{color:#AC21FF}#sbo-rt-content .lighgreen{color:#5FA100}#sbo-rt-content .lighblue{color:#269271}#sbo-rt-content .darkmaroon{color:#269271}#sbo-rt-content .maroon5{color:#A10000}#sbo-rt-content .blue6{color:#0000B9}#sbo-rt-content .marko{background-color:#FAF9CE}#sbo-rt-content .green5{color:#1C8B43}#sbo-rt-content .colork1{color:#136433;font-weight:bold}#sbo-rt-content .colork2{color:#504C72}#sbo-rt-content .colork3{color:#51785D}#sbo-rt-content .colork4{color:#303192}#sbo-rt-content .colork5{color:#955744}#sbo-rt-content .colork6{color:#5C70BA}#sbo-rt-content .colork7{color:#487864}#sbo-rt-content .colork8{color:#5C5778}#sbo-rt-content .colork9{color:#666}#sbo-rt-content .colork10{color:#48785D}#sbo-rt-content .colork11{color:#BC654D}#sbo-rt-content .colork12{color:#3E8185}#sbo-rt-content .colork13{color:#C62425}#sbo-rt-content .colork14{color:#1D8C43}#sbo-rt-content .colork15{color:#0D8140}#sbo-rt-content .colork16{color:#BB2425}#sbo-rt-content .colork17{color:#985744}#sbo-rt-content .colork18{color:#6C8896}#sbo-rt-content .colork19{color:#2A2C80}#sbo-rt-content .colork20{color:#BD2425}#sbo-rt-content .redk1{color:#EE1C25}#sbo-rt-content .colork21{color:#2A2C77}#sbo-rt-content .colork22{color:#955744}#sbo-rt-content .colork23{color:#BC6561}#sbo-rt-content .colork24{color:#BE7D2B}#sbo-rt-content .colork25{color:#8E7C5D}#sbo-rt-content .colork26{color:#7C5778}#sbo-rt-content .colork27{color:#9D1C1F}#sbo-rt-content .colork28{color:#AA5744}#sbo-rt-content .colork29{color:#C59861}#sbo-rt-content .grayk1{color:#C0908E}#sbo-rt-content .pd_green{color:#48785d}#sbo-rt-content .dark-green{color:#146333}#sbo-rt-content .mark1{background-color:#faf9ce}#sbo-rt-content .mark{background-color:#faf9ce}#sbo-rt-content .pd_ash{color:#666}#sbo-rt-content .pd_blue7{color:#6c8896}#sbo-rt-content .pd_blue1{color:#504b72}#sbo-rt-content .pd_red{color:#965744}#sbo-rt-content .pd_red2{color:#bb654e}#sbo-rt-content .pd_red5{color:#ed1c24}#sbo-rt-content .pd_blue5{color:#2e3192}#sbo-rt-content .pd_green4{color:#269200}#sbo-rt-content .pd_green5{color:#1c8b43}#sbo-rt-content .pd_blue3{color:#2c2c78}#sbo-rt-content .pd_orange{color:#c49847}</style><script type="text/javascript" async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/cool-2.1.15.min.js.download"></script><script type="text/javascript" async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/ec.js.download"></script><script type="text/javascript" async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/analytics.js.download"></script><script type="text/javascript" async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/f.txt"></script><script type="text/javascript" async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/js"></script><script crossorigin="anonymous" integrity="sha256-NiDMmov61Y536X/eLXLiDGzFVFmNLtPyu4b5aFB54ks=" type="text/javascript" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/appcues.main.11e38ef4746fd64ab30c11794299d10b30bcb704.js.download" async=""></script><script async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/gtm.js.download"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9780136702726/chapter/ch10.xhtml",
          "book_id": "9780136702726",
          "chapter_uri": "ch10.xhtml",
          "position": 27.4567491080775,
          "user_uuid": "66943332-5511-462c-876e-5d5b720c7edf",
          "next_chapter_uri": "/library/view/ruby-on-rails/9780136702726/ch11.xhtml"
        
      },
      title: "Ruby on Rails Tutorial, 6th Edition",
      author_list: "Michael Hartl",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: true
    };
    // ]]></script><script src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/modernizr.8e35451ddb64.js.download"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta name="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta property="og:title" content="Chapter 10. Updating, Showing, and Deleting Users"><meta itemprop="isPartOf" content="/library/view/ruby-on-rails/9780136702726/"><meta itemprop="name" content="Chapter 10. Updating, Showing, and Deleting Users"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9780136702726/"><meta property="og:description" itemprop="description" content=" Chapter 10 Updating, Showing, and Deleting Users In this chapter, we complete the REST actions for the Users resource (Table 7.1) by adding edit, update, index ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9780136702726"><meta property="og:book:author" itemprop="author" content="Michael Hartl"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '66943332-5511-462c-876e-5d5b720c7edf';
      dataLayer.push({userIdentifier: '66943332-5511-462c-876e-5d5b720c7edf'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = 'ba5f3401-307d-4b66-90a6-a97047c63525';
        

        window.medalliaVsgIsIndividual = true;
        
          
          dataLayer.push({learningAccountType: 'free trial'});
          
        

        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/vendor.3eecedff6f59.js.download"></script><script defer="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/reader.772cf1e31d6c.js.download"></script><iframe src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource.html"></iframe><iframe src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(3).html"></iframe><iframe src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(4).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-q9sKb2HpA5fJjN1cK9LjLaEXff5ix81Rv1Y3xJFptPE=" crossorigin="anonymous" href="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/container.11e38ef4746fd64ab30c11794299d10b30bcb704.css"><iframe src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(5).html"></iframe><script src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/f(1).txt"></script><script async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/MathJax.js.download"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
</style><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax.MathJax_FullWidth {text-align: center; display: table-cell!important; width: 10000em!important}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax_LineBox {display: table!important}
.MathJax_LineBox span {display: table-cell!important; width: 10000em!important; min-width: 0; max-width: none; padding: 0; border: 0; margin: 0}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?V=2.7.1') format('opentype')}
</style><style type="text/css">@font-face {font-family: MathJax_AMS; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_AMS-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_AMS-Regular.otf?V=2.7.1') format('opentype')}
</style></head>


<body class="reading sidenav  scalefonts subscribe-panel library nav-collapsed"><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="working hide" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/66943332-5511-462c-876e-5d5b720c7edf/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Attend</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/live-training/" class="l2 nav-icn"><span>Live Trainings</span></a></li><li><a href="https://learning.oreilly.com/featured/architectural-katas" class="l2 nav-icn"><span>Architectural Katas</span></a></li><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Interact</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/?classification=content-scenario" class="l2 nav-icn"><span>Scenarios</span></a></li><li><a href="https://learning.oreilly.com/scenarios/?classification=sandbox-scenario" class="l2 nav-icn"><span>Sandboxes</span></a></li><li><a href="https://learning.oreilly.com/interactive/?classification=jupyter-notebook" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li><a href="https://learning.oreilly.com/answers/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M2.31032699,3.75609006 C4.65421571,1.41371359 8.45302454,1.41472092 10.7955702,3.75860838 C13.1381158,6.10249583 13.1369405,9.90130261 10.7930518,12.243847 C8.44916311,14.5863913 4.65018639,14.5852161 2.30780867,12.2413286 C-0.0346204845,9.89749489 -0.0334929936,6.09853298 2.31032699,3.75609006 Z M8.8198605,4.98016308 C7.34193969,3.86924672 5.23410194,3.98609692 3.88914868,5.33104946 C3.12814393,6.09032122 2.72818176,7.13880077 2.79015179,8.21201133 C2.79115912,8.23064692 2.79233434,8.24928252 2.79350956,8.26791811 L2.79350956,8.26791811 C2.83179539,8.8307976 2.9944077,9.37404287 3.26947292,9.86201677 L3.26947292,9.86201677 L2.77621706,11.7027432 C2.7699968,11.7259241 2.77662063,11.7506624 2.79359185,11.7676337 C2.8105631,11.7846049 2.83530144,11.7912287 2.85848233,11.7850085 L2.85848233,11.7850085 L4.69400524,11.2922565 C5.26306363,11.6167344 5.90703177,11.786885 6.56209849,11.7858479 C8.64827865,11.7858479 10.3395879,10.094542 10.3395879,8.00836292 C10.3405204,6.84135608 9.80105674,5.73967784 8.87862141,5.02482134 L8.87862141,5.02482134 L8.82825492,4.98654283 Z M13.7933062,2 C14.7073496,2.00009863 15.4482759,2.74110484 15.4482759,3.65514822 C15.4482759,4.32460943 15.0449926,4.92814782 14.4264842,5.18432286 C13.8079757,5.44049789 13.096053,5.29885769 12.6226979,4.82545158 C12.1493429,4.35204547 12.0077795,3.64010743 12.2640213,3.02162665 C12.5202631,2.40314587 13.123845,1.99992776 13.7933062,2 Z"></path></svg><span>Answers</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://learning.oreilly.com/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Ruby on Rails Tutorial, 6th Edition
      
    </h1></span></a><div class="toc-contents" style="max-height: 0px;">
  <div class="sbo-toc">
    <button type="button" class="sbo-toc-thumb close"><div class="visuallyhidden">Close</div></button>
      <section class="ios-app-teaser">
        <ul>
            <li><a class="js-toc-link toc-link" href="https://itunes.apple.com/gb/app/safari-queue-library-over/id881697395?mt=8" role="button">Install App</a></li>
            <li><a class="js-toc-link toc-link" href="safaridetail://9780136702726" role="button">Open in App</a></li>
        </ul>
      </section>
      <div class="sbo-book-meta">
        
        <span class="cover">
         <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">
          <img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource" alt="Cover image for Ruby on Rails Tutorial, 6th Edition" height="184" width="141">
        </a>
        </span>
        <span class="title">
          
            
                <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
                  <img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/addison-wesley.png" class="publisher-logo video" alt="publisher logo">
                </a>
            
          

          <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/">Ruby on Rails Tutorial, 6th Edition</a>
        </span>
        
        <span class="authors">by Michael Hartl</span>
        

        
        <span class="publishers t-publishers">Published by
          <!-- Show publisher page link if publisher pages switch is on -->
          
            <a class="t-publisher-link toc-link js-toc-link" href="https://learning.oreilly.com/library/publisher/addison-wesley-professional/">
              Addison-Wesley Professional</a>, 2020
          
        </span>
        

    

    </div>
  <ol class="tocList">
    
    
    
     

     <li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/cover.xhtml">
        Cover Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref00.xhtml">
        About This eBook <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/halftitle.xhtml">
        Halftitle Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/title.xhtml">
        Title Page <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/copy.xhtml">
        Copyright Page <span class="minutes">(02:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/toc.xhtml#toc">
        Contents <span class="minutes">(05:45 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref02.xhtml#pref02">
        Foreword <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref03.xhtml#pref03">
        Acknowledgments <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/pref04.xhtml#pref04">
        About the Author <span class="minutes">(01:09 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01.xhtml#ch01">
        Chapter 1. From Zero to Deploy <span class="minutes">(77:03 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch02.xhtml#ch02">
        Chapter 2. A Toy App <span class="minutes">(50:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#ch03">
        Chapter 3. Mostly Static Pages <span class="minutes">(63:15 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#ch04">
        Chapter 4. Rails-Flavored Ruby <span class="minutes">(57:30 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">
        Chapter 5. Filling in the Layout <span class="minutes">(60:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06">
        Chapter 6. Modeling Users <span class="minutes">(67:51 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#ch07">
        Chapter 7. Sign Up <span class="minutes">(79:21 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#ch08">
        Chapter 8. Basic Login <span class="minutes">(66:42 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch09.xhtml#ch09">
        Chapter 9. Advanced Login <span class="minutes">(52:54 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1 currently-reading">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10">
        Chapter 10. Updating, Showing, and Deleting Users <span class="minutes">(73:36 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#ch11">
        Chapter 11. Account Activation <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12">
        Chapter 12. Password Reset <span class="minutes">(48:18 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">
        Chapter 13. User Microposts <span class="minutes">(106:57 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14">
        Chapter 14. Following Users <span class="minutes">(78:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml#index">
        Index <span class="minutes">(55:12 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/credits.xhtml#credits">
        Credits <span class="minutes">(19:33 mins)</span>
       </a>
      
        
      
    
    
     

     </li><li class="toc-level1">
        
        <a class="js-toc-link toc-link" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch01_images.xhtml#ch01_images">
        Code Snippets <span class="minutes">(09:12 mins)</span>
       </a>
      
        
      
   </li></ol>
 </div>



</div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9780136702726/chapter/ch10.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li class="currently-reading"><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml&amp;text=Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition&amp;via=OReillyMedia"><span>Twitter</span></a></li><li class="currently-reading"><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Facebook</span></a></li><li class="currently-reading"><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml"><span>Google Plus</span></a></li><li class="currently-reading"><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Chapter%2010.%20Updating%2C%20Showing%2C%20and%20Deleting%20Users&amp;body=https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml%0D%0Afrom%20Ruby%20on%20Rails%20Tutorial%2C%206th%20Edition%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document"><script src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/48743.js.download"></script>
<script>
  var userId = "66943332-5511-462c-876e-5d5b720c7edf";

  var userObject = {
    firstName: "Trần",
    segment: "Trial",
    admin: "False",
    profileCreatedOn: "2020-12-01",
    academic: ""
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 13. User Microposts</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Index</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section epub:type="chapter">
<h2 class="h2" id="ch14"><span epub:type="pagebreak" id="page_717"></span>Chapter 14</h2>
<h2 class="h2a">Following Users</h2>
<p class="noindent">In this chapter, we will complete the Rails Tutorial sample application by adding a social layer that allows users to follow (and unfollow) other users, resulting in each user’s Home page displaying a status feed of the followed users’ microposts. We’ll start by learning how to model relationships between users in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1">Section 14.1</a>, and we’ll build the corresponding web interface in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2">Section 14.2</a> (including an introduction to Ajax). We’ll end by developing a fully functional status feed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_3">Section 14.3</a>.</p>
<p class="indent">This final chapter contains some of the most challenging material in the tutorial, including some Ruby/SQL trickery to make the status feed. Through these examples, you will see how Rails can handle even rather intricate data models, which should serve you well as you go on to develop your own applications with their own specific requirements. To help with the transition from tutorial to independent development, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_4">Section 14.4</a> offers some pointers to more advanced resources.</p>
<p class="indent">Because the material in this chapter is particularly challenging, before writing any code we’ll pause for a moment and take a tour of the interface. As in previous chapters, at this early stage we’ll represent pages using mockups.<sup><a id="ch14fn1a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn1" class="totri-footnote">1</a></sup> The full page flow runs as follows: A user (John Calvin) starts at his profile page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig01">Figure 14.1</a>) and navigates to the Users page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig02">Figure 14.2</a>) to select a user to follow. Calvin navigates to the profile of a second user, Thomas Hobbes (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig03">Figure 14.3</a>), clicking on the “Follow” button to follow <span epub:type="pagebreak" id="page_718"></span>that user. This changes the “Follow” button to “Unfollow” and increments Hobbes’s “followers” count by one (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig04">Figure 14.4</a>). Navigating to his home page, Calvin now sees an incremented “following” count and finds Hobbes’s microposts in his status feed (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig05">Figure 14.5</a>). The rest of this chapter is dedicated to making this page flow actually work.</p>
<p class="footnote"><a id="ch14fn1" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn1a" class="totri-footnote">1</a>. Image of child retrieved from <a href="https://www.flickr.com/photos/john_lustig/2518452221/">https://www.flickr.com/photos/john_lustig/2518452221/</a> on 2013-12-16. Copyright © 2008 by John Lustig and used unaltered under the terms of the Creative Commons Attribution 2.0 Generic license. Image of tiger retrieved from <a href="https://www.flickr.com/photos/renemensen/9187111340">https://www.flickr.com/photos/renemensen/9187111340</a> on 2014-08-15. Copyright © 2013 by Rene Mesen and used unaltered under the terms of the Creative Commons Attribution 2.0 Generic license.</p>
<figure id="ch14fig01" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_01.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_01.jpg">
<figcaption><p><strong>Figure 14.1:</strong> A current user’s profile.</p></figcaption>
</figure>
<figure id="ch14fig02" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_02.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_02.jpg">
<figcaption><p><strong>Figure 14.2:</strong> Finding a user to follow.</p></figcaption>
</figure>
<figure id="ch14fig03" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_03.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_03.jpg">
<figcaption><p><strong>Figure 14.3:</strong> The profile of a user to follow, with a Follow button.</p></figcaption>
</figure>
<figure id="ch14fig04" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_04.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_04.jpg">
<figcaption><p><strong>Figure 14.4:</strong> A profile with an Unfollow button and incremented followers count.</p></figcaption>
</figure>
<figure id="ch14fig05" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_05.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_05.jpg">
<figcaption><p><strong>Figure 14.5:</strong> The Home page with status feed and incremented following count.</p></figcaption>
</figure>
<section>
<h3 class="h3" id="sec14_1">14.1 The Relationship Model</h3>
<p class="noindent">Our first step in implementing following users is to construct a data model, which is not as straightforward as it seems. Naïvely, it seems that a <code><strong><span class="colork1">has_many</span></strong></code> relationship would do: A user <code><strong><span class="colork1">has_many</span></strong></code> followed users and <code><strong><span class="colork1">has_many</span></strong></code> followers. As we will see, there is a problem with this approach, and we’ll learn how to fix it using <code><strong><span class="colork1">has_many :through</span></strong></code>.<span epub:type="pagebreak" id="page_719"></span></p>
<p class="indent">As usual, Git users should create a new topic branch:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg719-01a" id="pg719-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> git checkout -b following-users</pre>
<section>
<h4 class="h4" id="sec14_1_1">14.1.1 A Problem with the Data Model (and a Solution)</h4>
<p class="noindent">As a first step toward constructing a data model for following users, let’s examine a typical case. For instance, consider a user who follows a second user: We could say that, for example, Calvin is following Hobbes, and Hobbes is followed by Calvin, so that Calvin is the <em>follower</em> and Hobbes is <em>followed</em>. Using Rails’ default pluralization convention, the set of all users following a given user is that user’s <em>followers</em>, and <code><strong><span class="colork1">hobbes.followers</span></strong></code> is an array of those users. Unfortunately, the reverse doesn’t <span epub:type="pagebreak" id="page_720"></span>work: By default, the set of all followed users would be called the <em>followeds</em>, which is ungrammatical and clumsy. We’ll adopt Twitter’s convention and call them <em>following</em> (as in “50 following, 75 followers”), with a corresponding <code><strong><span class="colork1">calvin.following</span></strong></code> array.</p>
<p class="indent">This discussion suggests modeling the followed users as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig06">Figure 14.6</a>, with a <code><strong><span class="colork1">following</span></strong></code> table and a <code><strong><span class="colork1">has_many</span></strong></code> association. Since <code><strong><span class="colork1">user.following</span></strong></code> should be a collection of users, each row of the <code><strong><span class="colork1">following</span></strong></code> table would need to be a user, as identified by the <code><strong><span class="colork1">followed_id</span></strong></code>, together with the <code><strong><span class="colork1">follower_id</span></strong></code> to establish the association.<sup><a id="ch14fn2a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn2" class="totri-footnote">2</a></sup> In addition, since each row is a user, we would need to include the user’s other attributes, including the name, email, password, and so forth.</p>
<p class="footnote"><a id="ch14fn2" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn2a" class="totri-footnote">2</a>. For simplicity, <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig06">Figure 14.6</a> omits the <code><strong><span class="colork1">following</span></strong></code> table’s <code><strong><span class="colork1">id</span></strong></code> column.</p>
<figure id="ch14fig06" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_06.jpg" alt="Image" width="677" height="265" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_06.jpg">
<figcaption><p><strong>Figure 14.6:</strong> A naïve implementation of user following.</p></figcaption>
</figure>
<p class="indent"><span epub:type="pagebreak" id="page_721"></span>The problem with the data model in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig06">Figure 14.6</a> is that it is terribly redundant: Each row contains not only each followed user’s id, but all their other information as well—all of which is <em>already</em> in the <code><strong><span class="colork1">users</span></strong></code> table. Even worse, to model user <em>followers</em> we would need a separate, similarly redundant <code><strong><span class="colork1">followers</span></strong></code> table. Finally, this data model is a maintainability nightmare: Each time a user changed (say) their name, we would need to update not just the user’s record in the <code><strong><span class="colork1">users</span></strong></code> table but also <em>every row containing that user</em> in both the <code><strong><span class="colork1">following</span></strong></code> and <code><strong><span class="colork1">followers</span></strong></code> tables.</p>
<p class="indent">The problem here is that we are missing an underlying abstraction. One way to find the proper model is to consider how we might implement the act of <em>following</em> in a web application. Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch07.xhtml#sec7_1_2">Section 7.1.2</a> that the REST architecture involves <em>resources</em> that are created and destroyed. This leads us to ask two questions: When a user follows another user, what is being created? When a user <em>un</em>follows another user, what is being destroyed? Upon reflection, we see that in these cases the application should either create or destroy a <em>relationship</em> between two users. A user then has many relationships, and has many <code><strong><span class="colork1">following</span></strong></code> (or <code><strong><span class="colork1">followers</span></strong></code>) <em>through</em> these relationships.<span epub:type="pagebreak" id="page_722"></span></p>
<p class="indent"><span epub:type="pagebreak" id="page_723"></span>There’s an additional detail we need to address regarding our application’s data model: Unlike symmetric Facebook-style friendships, which are always reciprocal (at least at the data-model level), Twitter-style following relationships are potentially <em>asymmetric</em>—Calvin can follow Hobbes without Hobbes following Calvin. To distinguish between these two cases, we’ll adopt the terminology of <em>active</em> and <em>passive</em> relationships: If Calvin is following Hobbes but not vice versa, Calvin has an active relationship with Hobbes and Hobbes has a passive relationship with Calvin.<sup><a id="ch14fn3a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn3" class="totri-footnote">3</a></sup></p>
<p class="footnote"><a id="ch14fn3" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn3a" class="totri-footnote">3</a>. Thanks to reader Paul Fioravanti for suggesting this terminology.</p>
<p class="indent">We’ll focus now on using active relationships to generate a list of followed users, and consider the passive case in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_5">Section 14.1.5</a>. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig06">Figure 14.6</a> suggests how to implement it: Since each followed user is uniquely identified by <code><strong><span class="colork1">followed_id</span></strong></code>, we could convert <code><strong><span class="colork1">following</span></strong></code> to an <code><strong><span class="colork1">active_relationships</span></strong></code> table, omit the user details, and use <code><strong><span class="colork1">followed_id</span></strong></code> to retrieve the followed user from the <code><strong><span class="colork1">users</span></strong></code> table. A diagram of the data model appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig07">Figure 14.7</a>.</p>
<figure id="ch14fig07" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_07.jpg" alt="Image" width="677" height="334" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_07.jpg">
<figcaption><p><strong>Figure 14.7:</strong> A model of followed users through active relationships.</p></figcaption>
</figure>
<p class="indent">Because we’ll end up using the same database table for both active and passive relationships, we’ll use the generic term <em>relationship</em> for the table name, with a corresponding Relationship model. The result is the Relationship data model shown in <span epub:type="pagebreak" id="page_724"></span><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig08">Figure 14.8</a>. We’ll see starting in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_4">Section 14.1.4</a> how to use the Relationship model to simulate both Active Relationship and Passive Relationship models.</p>
<figure id="ch14fig08" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_08.jpg" alt="Image" width="254" height="153" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_08.jpg">
<figcaption><p><strong>Figure 14.8:</strong> The Relationship data model.</p></figcaption>
</figure>
<p class="indent">To get started with the implementation, we first generate a migration corresponding to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig08">Figure 14.8</a>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg724-01a" id="pg724-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails generate model Relationship follower_id:integer followed_id:integer</pre>
<p class="indent">Because we will be finding relationships by <code><strong><span class="colork1">follower_id</span></strong></code> and by <code><strong><span class="colork1">followed_id</span></strong></code>, we should add an index on each column for efficiency, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex01">Listing 14.1</a>.</p>
<p class="ex-title" id="ch14ex01"><strong>Listing 14.1:</strong> Adding indices for the <code><strong><span class="colork1">relationships</span></strong></code> table.</p>
<pre class="pre2">db/migrate/[timestamp]_create_relationships.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#lis1-1a" id="lis1-1">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">CreateRelationships</span></strong> <span class="colork27">&lt; ActiveRecord::Migration[6.0]</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">change</span>
    create_table <span class="colork4">:relationships</span> <strong><span class="colork10">do</span></strong> <span class="colork8">|</span>t<span class="colork8">|</span>
      t.integer <span class="colork4">:follower_id</span>
      t.integer <span class="colork4">:followed_id</span>

      t.timestamps
    <strong><span class="colork10">end</span></strong>
<span class="mark">    add_index :relationships, <span class="colork8">:follower_id</span></span>
<span class="mark">    add_index :relationships, <span class="colork8">:followed_id</span></span>
<span class="mark">    add_index :relationships, <span class="colork8">[:follower_id, :followed_id]</span>, <span class="colork8">unique</span>: <strong><span class="colork10">true</span></strong></span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex01">Listing 14.1</a> also includes a multiple-key index that enforces uniqueness on (<code><strong><span class="colork1">follower_id</span></strong></code>, <code><strong><span class="colork1">followed_id</span></strong></code>) pairs, so that a user can’t follow another user more than <span epub:type="pagebreak" id="page_725"></span>once. (Compare this to the email uniqueness index from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex029">Listing 6.29</a> and the multiple-key index in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex03">Listing 13.3</a>.) As we’ll see starting in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_4">Section 14.1.4</a>, our user interface won’t allow this to happen, but adding a unique index arranges to raise an error if a user tries to create duplicate relationships anyway (for example, by using a command-line tool such as <code><strong><span class="colork1">curl</span></strong></code>).</p>
<p class="indent">To create the <code><strong><span class="colork1">relationships</span></strong></code> table, we migrate the database as usual:</p>
<pre class="pre1"><span class="colork2">$</span> rails db:migrate</pre>
<section>
<h5 class="h5" id="lev170">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">For the user with id equal to <code><strong><span class="colork1">1</span></strong></code> from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig07">Figure 14.7</a>, what would the value of <code><strong><span class="colork1">user.following.map(&amp;:id)</span></strong></code> be? (Recall the <code><strong><span class="colork1">map(&amp;:method_name)</span></strong></code> pattern from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_2">Section 4.3.2</a>; <code><strong><span class="colork1">user.following.map(&amp;:id)</span></strong></code> just returns the array of ids.)</p></li>
<li><p class="num">By referring again to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig07">Figure 14.7</a>, determine the ids of <code><strong><span class="colork1">user.following</span></strong></code> for the user with id equal to <code><strong><span class="colork1">2</span></strong></code>. What would the value of <code><strong><span class="colork1">user.following.map(&amp;:id)</span></strong></code> be for this user?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_1_2">14.1.2 User/Relationship Associations</h4>
<p class="noindent">Before implementing user following and followers, we first need to establish the association between users and relationships. A user <code><strong><span class="colork1">has_many</span></strong></code> relationships, and—since relationships involve <em>two</em> users—a relationship <code><strong><span class="colork1">belongs_to</span></strong></code> both a follower and a followed user.</p>
<p class="indent">As with the microposts introduced in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_3">Section 13.1.3</a>, we will create new relationships using the user association, with code such as</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg725-01a" id="pg725-01">Click here to view code image</a></p>
<pre class="pre1">user.active_relationships.build(followed_id: ...)</pre>
<p class="noindent">At this point, you might expect application code as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_3">Section 13.1.3</a>. It’s certainly similar, but there are two key differences.</p>
<p class="indent">First, in the case of the user/micropost association we could write<span epub:type="pagebreak" id="page_726"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg726-01a" id="pg726-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  has_many <span class="colork8">:microposts</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">This works because by convention Rails looks for a Micropost model corresponding to the <code><strong><span class="colork1">:microposts</span></strong></code> symbol.<sup><a id="ch14fn4a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn4" class="totri-footnote">4</a></sup> In the present case, though, we want to write</p>
<p class="footnote"><a id="ch14fn4" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn4a" class="totri-footnote">4</a>. Technically, Rails converts the argument of <code><strong><span class="colork1">has_many</span></strong></code> to a class name using the <code><strong><span class="colork1">classify</span></strong></code> method, which converts <code><strong><span class="colork1">"foo_bars"</span></strong></code> to <code><strong><span class="colork1">"FooBar"</span></strong></code>.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg726-02a" id="pg726-02">Click here to view code image</a></p>
<pre class="pre1">has_many <span class="colork8">:active_relationships</span></pre>
<p class="noindent">even though the underlying model is called Relationship. We will thus have to tell Rails the model class name to look for.</p>
<p class="indent">Second, we wrote</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg726-03a" id="pg726-03">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork10">class</span> <span class="colork4">Micropost</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:user</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">in the Micropost model. This works because the <code><strong><span class="colork1">microposts</span></strong></code> table has a <code><strong><span class="colork1">user_id</span></strong></code> attribute to identify the user (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_1">Section 13.1.1</a>). An id used in this manner to connect two database tables is known as a <em>foreign key</em>. When the foreign key for a User model object is <code><strong><span class="colork1">user_id</span></strong></code>, Rails infers the association automatically: By default, Rails expects a foreign key of the form <code><strong><span class="colork1">&lt;class&gt;_id</span></strong></code>, where <code><strong><span class="colork1">&lt;class&gt;</span></strong></code> is the lower-case version of the class name.<sup><a id="ch14fn5a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn5" class="totri-footnote">5</a></sup> In the present case, although we are still dealing with users, the user following another user is now identified with the foreign key <code><strong><span class="colork1">follower_id</span></strong></code>, so we have to tell that to Rails.</p>
<p class="footnote"><a id="ch14fn5" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn5a" class="totri-footnote">5</a>. Technically, Rails uses the <code><strong><span class="colork1">underscore</span></strong></code> method to convert the class name to an id. For example, <code><strong><span class="colork1">"FooBar".underscore</span></strong></code> is <code><strong><span class="colork1">"foo_bar"</span></strong></code>, so the foreign key for a <code><strong><span class="colork1">FooBar</span></strong></code> object would be <code><strong><span class="colork1">foo_bar_id</span></strong></code>.</p>
<p class="indent">The result of this discussion is the user/relationship association shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex02">Listing 14.2</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex03">Listing 14.3</a>. As noted in the captions, the tests are currently <small><span class="redk1">RED</span></small> (Why?);<sup><a id="ch14fn6a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn6" class="totri-footnote">6</a></sup> we’ll fix this issue in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_3">Section 14.1.3</a>.</p>
<p class="footnote"><a id="ch14fn6" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn6a" class="totri-footnote">6</a>. <em>Answer</em>: As in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex030">Listing 6.30</a>, the generated fixtures don’t satisfy the validations, which causes the tests to fail.<span epub:type="pagebreak" id="page_727"></span></p>
<p class="ex-title" id="ch14ex02"><strong>Listing 14.2:</strong> Implementing the active relationships <code><strong><span class="colork1">has_many</span></strong></code> association. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-2a" id="list14-2">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  has_many <span class="colork8">:microposts</span>, <span class="colork8">dependent: :destroy</span>
<span class="mark">  has_many :active_relationships, class_name: <span class="colork23">"Relationship"</span>,</span>
<span class="mark">                                  foreign_key: <span class="colork23">"follower_id"</span>,</span>
<span class="mark">                                  dependent: <span class="colork8">:destroy</span></span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">(Since destroying a user should also destroy that user’s relationships, we’ve added <code><strong><span class="colork1">dependent: :destroy</span></strong></code> to the association.)</p>
<p class="ex-title" id="ch14ex03"><strong>Listing 14.3:</strong> Adding the follower <code><strong><span class="colork1">belongs_to</span></strong></code> association to the Relationship model. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">app/models/relationship.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-3a" id="list14-3">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Relationship</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
<span class="mark">  belongs_to :follower, class_name: <span class="colork23">"User"</span></span>
<span class="mark">  belongs_to :followed, class_name: <span class="colork23">"User"</span></span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">The <code><strong><span class="colork1">followed</span></strong></code> association isn’t actually needed until <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_4">Section 14.1.4</a>, but the parallel follower/followed structure is clearer if we implement them both at the same time.</p>
<p class="indent">The relationships in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex02">Listing 14.2</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex03">Listing 14.3</a> give rise to methods analogous to the ones we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13tab01">Table 13.1</a>, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14tab01">Table 14.1</a>.</p>
<figure id="ch14tab01">
<figcaption><p><strong>Table 14.1:</strong> A summary of user/active relationship association methods.</p></figcaption>
<table class="topbot">
<thead>
<tr>
<th class="tab-th"><p class="tab-para"><strong>Method</strong></p></th>
<th class="tab-th"><p class="tab-para"><strong>Purpose</strong></p></th>
</tr>
</thead>
<tbody>
<tr>
<td><p class="tab-para"><strong><code><strong><span class="colork1">active_relationship.follower</span></strong></code></strong></p></td>
<td><p class="tab-para">Returns the follower</p></td>
</tr>
<tr>
<td><p class="tab-para"><code><strong><span class="colork1">active_relationship.followed</span></strong></code></p></td>
<td><p class="tab-para">Returns the followed user</p></td>
</tr>
<tr>
<td><p class="tab-para"><code><strong><span class="colork1">user.active_relationships.create (followed_id: other_user.id)</span></strong></code></p></td>
<td><p class="tab-parai">Creates an active relationship associated with <code><strong><span class="colork1">user</span></strong></code></p></td>
</tr>
<tr>
<td><p class="tab-para"><code><strong><span class="colork1">user.active_relationships.create! (followed_id: other_user.id)</span></strong></code></p></td>
<td><p class="tab-parai">Creates an active relationship associated with <code><strong><span class="colork1">user</span></strong></code> (exception on failure)</p></td>
</tr>
<tr>
<td><p class="tab-para"><code><strong><span class="colork1">user.active_relationships.build (followed_id: other_user.id)</span></strong></code></p></td>
<td><p class="tab-parai">Returns a new Relationship object associated with <code><strong><span class="colork1">user</span></strong></code></p></td>
</tr>
</tbody>
</table>
</figure>
<section>
<h5 class="h5" id="lev171">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Using the <code><strong><span class="colork1">create</span></strong></code> method from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14tab01">Table 14.1</a> in the console, create an active relationship for the first user in the database where the followed id is the second user.<span epub:type="pagebreak" id="page_728"></span></p></li>
<li><p class="num">Confirm that the values for <code><strong><span class="colork1">active_relationship.followed</span></strong></code> and <code><strong><span class="colork1">active_relationship.follower</span></strong></code> are correct.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_1_3">14.1.3 Relationship Validations</h4>
<p class="noindent">Before moving on, we’ll add a couple of Relationship model validations for completeness. The tests (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex04">Listing 14.4</a>) and application code (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex05">Listing 14.5</a>) are straightforward. As with the generated user fixture from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex030">Listing 6.30</a>, the generated relationship fixture also violates the uniqueness constraint imposed by the corresponding migration (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex01">Listing 14.1</a>). The solution—removing the fixture contents as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch06.xhtml#ch06ex031">Listing 6.31</a>—is also the same, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex06">Listing 14.6</a>.</p>
<p class="ex-title" id="ch14ex04"><strong>Listing 14.4:</strong> Testing the Relationship model validations. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">test/models/relationship_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-4a" id="list14-4">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">RelationshipTest</span></strong> <span class="colork27">&lt; ActiveSupport::TestCase</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@relationship =</span> <span class="colork22">Relationship.</span>new(<span class="colork8">follower_id</span>: users(<span class="colork8">:michael</span>).id,
                                     <span class="colork8">followed_id</span>: users(<span class="colork8">:archer</span>).id)
  <strong><span class="colork10">end</span></strong>

  <span class="colork8">test</span> <span class="colork22">"should be valid"</span> <strong><span class="colork15">do</span></strong>
    assert <span class="colork8">@relationship.</span>valid?
  <strong><span class="colork10">end</span></strong>

  <span epub:type="pagebreak" id="page_729"></span><span class="colork8">test</span> <span class="colork22">"should require a follower_id"</span> <strong><span class="colork10">do</span></strong>
    <span class="colork8">@relationship</span>.follower_id = <strong><span class="colork10">nil</span></strong>
    assert_not <span class="colork8">@relationship</span>.valid?
  <strong><span class="colork10">end</span></strong>

  <span class="colork8">test</span> <span class="colork22">"should require a followed_id"</span> <strong><span class="colork10">do</span></strong>
    <span class="colork8">@relationship.</span>followed_id = <strong><span class="colork10">nil</span></strong>
    assert_not <span class="colork8">@relationship.</span>valid?
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="ex-title" id="ch14ex05"><strong>Listing 14.5:</strong> Adding the Relationship model validations. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">app/models/relationship.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#lis14-5a" id="lis14-5">Click here to view code image</a></p>

<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">Relationship</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  belongs_to <span class="colork8">:follower</span>, <span class="colork8">class_name:</span> <span class="colork22">"User"</span>
  belongs_to <span class="colork8">:followed</span>, <span class="colork8">class_name:</span> <span class="colork22">"User"</span>
<span class="mark">  validates <span class="colork8">:follower_id</span>, <span class="colork8">presence:</span> <strong><span class="colork15">true</span></strong></span>
<span class="mark">  validates <span class="colork8">:followed_id</span>, <span class="colork8">presence:</span> <strong><span class="colork15">true</span></strong></span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="ex-title" id="ch14ex06"><strong>Listing 14.6:</strong> Removing the contents of the relationship fixture. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">test/fixtures/relationships.yml</pre>
<div class="example">
<pre><span class="colork4"># empty</span></pre>
</div>
<p class="indent">At this point, the tests should be <small><span class="colork14">GREEN</span></small>:</p>
<p class="ex-title" id="ch14ex07"><strong>Listing 14.7:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev172">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_730"></span></p>
<ol class="num">
<li><p class="num">Verify by commenting out the validations in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex05">Listing 14.5</a> that the tests still pass. (This is a change as of Rails 5, and in previous versions of Rails the validations are required. We’ll plan to leave them in for completeness, but it’s worth bearing in mind that you may see these validations omitted in other people’s code.)</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_1_4">14.1.4 Followed Users</h4>
<p class="noindent">We come now to the heart of the Relationship associations: <code><strong><span class="colork1">following</span></strong></code> and <code><strong><span class="colork1">followers</span></strong></code>. Here we will use <code><strong><span class="colork1">has_many :through</span></strong></code> for the first time: A user has many following <em>through</em> relationships, as illustrated in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig07">Figure 14.7</a>. By default, in a <code><strong><span class="colork1">has_many :through</span></strong></code> association Rails looks for a foreign key corresponding to the singular version of the association. In other words, with code like</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg730-01a" id="pg730-01">Click here to view code image</a></p>
<pre class="pre1">has_many <span class="colork8">:followeds</span>, <span class="colork8">through</span>: :<span class="colork8">active_relationships</span></pre>
<p class="noindent">Rails would see “followeds” and use the singular “followed,” assembling a collection using the <code><strong><span class="colork1">followed_id</span></strong></code> in the <code><strong><span class="colork1">relationships</span></strong></code> table. But, as noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_1">Section 14.1.1</a>, <code><strong><span class="colork1">user.followeds</span></strong></code> is rather awkward, so we’ll write <code><strong><span class="colork1">user.following</span></strong></code> instead. Naturally, Rails allows us to override the default, in this case using the <code><strong><span class="colork1">source</span></strong></code> parameter (as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex08">Listing 14.8</a>), which explicitly tells Rails that the source of the <code><strong><span class="colork1">following</span></strong></code> array is the set of <code><strong><span class="colork1">followed</span></strong></code> ids.</p>
<p class="ex-title" id="ch14ex08"><strong>Listing 14.8:</strong> Adding the User model <code><strong><span class="colork1">following</span></strong></code> association.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-8a" id="list14-8">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  has_many :<span class="colork8">microposts</span>, <span class="colork8">dependent</span>: :<span class="colork8">destroy</span>
  has_many :<span class="colork8">active_relationships</span>, <span class="colork8">class_name</span>: <span class="colork22">"Relationship"</span>,
                                  <span class="colork8">foreign_key</span>: <span class="colork22">"follower_id"</span>,
                                  <span class="colork8">dependent</span>: :<span class="colork8">destroy</span>
<span class="mark">  has_many :following, through: :active_relationships, source: :followed</span>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
  <strong><span class="colork9">.</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">The association defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex08">Listing 14.8</a> leads to a powerful combination of Active Record and array-like behavior. For example, we can check if the followed users <span epub:type="pagebreak" id="page_731"></span>collection includes another user with the <code><strong><span class="colork1">include?</span></strong></code> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_1">Section 4.3.1</a>), and we can find objects through the association:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg731-01a" id="pg731-01">Click here to view code image</a></p>
<pre class="pre1">user.following.include?(other_user)
user.following.find(other_user)</pre>
<p class="noindent">We can also add and delete elements just as with arrays:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg731-02a" id="pg731-02">Click here to view code image</a></p>
<pre class="pre1">user.following &lt;&lt; other_user
user.following.delete(other_user)</pre>
<p class="noindent">(Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_1">Section 4.3.1</a> that the shovel operator <code><strong><span class="colork1">&lt;&lt;</span></strong></code> appends an element to the end of an array.)</p>
<p class="indent">Although in many contexts we can effectively treat <code><strong><span class="colork1">following</span></strong></code> as an array, Rails is smart about how it handles things under the hood. For example, code like</p>
<pre class="pre1">following.include?(other_user)</pre>
<p class="noindent">looks like it might have to pull all the followed users out of the database to apply the <code><strong><span class="colork1">include?</span></strong></code> method, but in fact for efficiency Rails arranges for the comparison to happen directly in the database. (Compare this behavior to the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_2_1">Section 13.2.1</a>, where we saw that</p>
<pre class="pre1">user.microposts.count</pre>
<p class="noindent">performs the count directly in the database.)</p>
<p class="indent">To manipulate following relationships, we’ll introduce <code><strong><span class="colork1">follow</span></strong></code> and <code><strong><span class="colork1">unfollow</span></strong></code> utility methods so that we can write, for example, <code><strong><span class="colork1">user.follow(other_user)</span></strong></code>. We’ll also add an associated <code><strong><span class="colork1">following?</span></strong></code> boolean method to test if one user is following another.<sup><a id="ch14fn7a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn7" class="totri-footnote">7</a></sup></p>
<p class="footnote"><a id="ch14fn7" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn7a" class="totri-footnote">7</a>. Once you have a lot of experience modeling a particular domain, you can often guess such utility methods in advance, and even when you can’t, you’ll often find yourself writing them to make the tests cleaner. In this case, though, it’s OK if you wouldn’t have guessed them. Software development is usually an iterative process—you write code until it starts getting ugly, and then you refactor it—but for brevity the tutorial presentation is streamlined a bit.</p>
<p class="indent">This is exactly the kind of situation where I like to write some tests first. The reason is that we are quite far from writing a working web interface for following users, <span epub:type="pagebreak" id="page_732"></span>but it’s hard to proceed without some sort of <em>client</em> for the code we’re developing. In this case, it’s easy to write a short test for the User model, in which we use <code><strong><span class="colork1">following?</span></strong></code> to make sure the user isn’t following the other user, use <code><strong><span class="colork1">follow</span></strong></code> to follow another user, use <code><strong><span class="colork1">following?</span></strong></code> to verify that the operation succeeded, and finally <code><strong><span class="colork1">unfollow</span></strong></code> and verify that it worked. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex09">Listing 14.9</a>.</p>
<p class="ex-title" id="ch14ex09"><strong>Listing 14.9:</strong> Tests for some “following” utility methods. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">test/models/user_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-9a" id="list14-9">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork8">class</span> <span class="colork4">UserTest</span></strong> <span class="colork27">&lt; ActiveSupport::TestCase</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork8">test</span> <span class="colork22">"should follow and unfollow a user"</span> <strong><span class="colork10">do</span></strong>
    michael = users(<span class="colork8">:michael</span>)
    archer = users(<span class="colork8">:archer</span>)
    assert_not michael.following?(archer)
    michael.follow(archer)
    assert michael.following?(archer)
    michael.unfollow(archer)
    assert_not michael.following?(archer)
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">By treating the <code><strong><span class="colork1">following</span></strong></code> association as an array, we can write the <code><strong><span class="colork1">follow</span></strong></code>, <code><strong><span class="colork1">un-follow</span></strong></code>, and <code><strong><span class="colork1">following?</span></strong></code> methods as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex010">Listing 14.10</a>. (Note that we have omitted the user <code><strong><span class="colork1">self</span></strong></code> variable whenever possible.)</p>
<p class="ex-title" id="ch14ex010"><strong>Listing 14.10:</strong> Utility methods for following. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-10a" id="list14-10">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">feed</span>
    <span class="colork9">.</span>
    <span class="colork9">.</span>
    <span class="colork9">.</span>
  <strong><span class="colork10">end</span></strong>
<span epub:type="pagebreak" id="page_733"></span>  <span class="colork18"># Follows a user.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">follow</span>(other_user)
<span class="mark">    following &lt;&lt; other_user</span>
  <strong><span class="colork10">end</span></strong>

  <span class="colork18"># Unfollows a user.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">unfollow</span>(other_user)
<span class="mark">    following.delete(other_user)</span>
  <strong><span class="colork10">end</span></strong>

  <span class="colork18"># Returns true if the current user is following the other user.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">following?</span>(other_user)
<span class="mark">    following.include?(other_user)</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">private</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex010">Listing 14.10</a>, the tests should be <small><span class="colork14">GREEN</span></small>:</p>
<p class="ex-title" id="ch14ex011"><strong>Listing 14.11:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev173">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">At the console, replicate the steps shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex09">Listing 14.9</a>.</p></li>
<li><p class="num">What is the SQL for each of the commands in the previous exercise?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_1_5">14.1.5 Followers</h4>
<p class="noindent">The final piece of the relationships puzzle is to add a <code><strong><span class="colork1">user.followers</span></strong></code> method to go with <code><strong><span class="colork1">user.following</span></strong></code>. You may have noticed from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig07">Figure 14.7</a> that all the information needed to extract an array of followers is already present in the <span epub:type="pagebreak" id="page_734"></span><code><strong><span class="colork1">relationships</span></strong></code> table (which we are treating as the <code><strong><span class="colork1">active_relationships</span></strong></code> table via the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex02">Listing 14.2</a>). Indeed, the technique is exactly the same as that for followed users, with the roles of <code><strong><span class="colork1">follower_id</span></strong></code> and <code><strong><span class="colork1">followed_id</span></strong></code> reversed, and with <code><strong><span class="colork1">passive_relationships</span></strong></code> in place of <code><strong><span class="colork1">active_relationships</span></strong></code>. The data model then appears as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig09">Figure 14.9</a>.</p>
<figure id="ch14fig09" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_09.jpg" alt="Image" width="677" height="292" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_09.jpg">
<figcaption><p><strong>Figure 14.9:</strong> A model for user followers through passive relationships.</p></figcaption>
</figure>
<p class="indent">The implementation of the data model in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig09">Figure 14.9</a> parallels <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex08">Listing 14.8</a> exactly, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex012">Listing 14.12</a>.</p>
<p class="ex-title" id="ch14ex012"><strong>Listing 14.12:</strong> Implementing <code><strong><span class="colork1">user.followers</span></strong></code> using passive relationships.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-12a" id="list14-12">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  has_many <span class="colork8">:microposts</span>, <span class="colork8">dependent</span>: :<span class="colork8">destroy</span>
  has_many :<span class="colork8">active_relationships</span>,  <span class="colork8">class_name</span>:  <span class="colork22">"Relationship"</span>,
                                   <span class="colork8">foreign_key</span>: <span class="colork22">"follower_id"</span>,
                                   <span class="colork8">dependent</span>:   <span class="colork8">:destroy</span>
<span class="mark">  has_many :passive_relationships, class_name:  <span class="colork22">"Relationship"</span>,</span>
<span class="mark">                                   foreign_key: <span class="colork22">"followed_id"</span>,</span>
<span class="mark">                                   dependent:   :destroy</span>
  has_many :<span class="colork8">following</span>, <span class="colork8">through</span>: :<span class="colork8">active_relationships</span>,  <span class="colork8">source</span>: :<span class="colork8">followed</span>
<span class="mark">  has_many :followers, through: :passive_relationships, source: :follower</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_735"></span>It’s worth noting that we could actually omit the <code><strong><span class="colork1">:source</span></strong></code> key for <code><strong><span class="colork1">followers</span></strong></code> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex012">Listing 14.12</a>, using simply</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg735-01a" id="pg735-01">Click here to view code image</a></p>
<pre class="pre1">has_many <span class="colork26">:followers, through: :passive_relationships</span></pre>
<p class="noindent">This is because, in the case of a <code><strong><span class="colork1">:followers</span></strong></code> attribute, Rails will singularize “followers” and automatically look for the foreign key <code><strong><span class="colork1">follower_id</span></strong></code> in this case. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex012">Listing 14.12</a> keeps the <code><strong><span class="colork1">:source</span></strong></code> key to emphasize the parallel structure with the <code><strong><span class="colork1">has_many :following</span></strong></code> association.</p>
<p class="indent">We can conveniently test our data model using the <code><strong><span class="colork1">followers.include?</span></strong></code> method, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex013">Listing 14.13</a>. (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex013">Listing 14.13</a> might have used a <code><strong><span class="colork1">followed_by?</span></strong></code> method to complement the <code><strong><span class="colork1">following?</span></strong></code> method, but it turns out we won’t need it in our application.)</p>
<p class="ex-title" id="ch14ex013"><strong>Listing 14.13:</strong> A test for <code><strong><span class="colork1">followers</span></strong></code>. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">test/models/user_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-13a" id="list14-13">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork8">class</span> <span class="colork4">UserTest</span></strong> <span class="colork27">&lt; ActiveSupport::TestCase</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork8">test</span> <span class="colork22">"should follow and unfollow a user"</span> <strong><span class="colork10">do</span></strong>
    michael = users(<span class="colork8">:michael</span>)
    archer = users(<span class="colork8">:archer</span>)
    assert_not michael.following?(archer)
    michael.follow(archer)
    assert michael.following?(archer)
    assert archer.followers.include?(michael)
<span class="mark">    michael.unfollow(archer)</span>
    assert_not michael.following?(archer)
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex013">Listing 14.13</a> adds only one line to the test from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex09">Listing 14.9</a>, but so many things have to go right to get it to pass that it’s a very sensitive test of the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex012">Listing 14.12</a>.</p>
<p class="indent">At this point, the full test suite should be <small><span class="colork14">GREEN</span></small>:</p>
<p class="ex-title" id="ch14ex014"><strong>Listing 14.14:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev174"><span epub:type="pagebreak" id="page_736"></span>Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">At the console, create several followers for the first user in the database (which you should call <code><strong><span class="colork1">user</span></strong></code>). What is the value of <code><strong><span class="colork1">user.followers.map(&amp;:id)</span></strong></code>?</p></li>
<li><p class="num">Confirm that <code><strong><span class="colork1">user.followers.count</span></strong></code> matches the number of followers you created in the previous exercise.</p></li>
<li><p class="num">What is the SQL used by <code><strong><span class="colork1">user.followers.count</span></strong></code>? How is this different from <code><strong><span class="colork1">user.followers.to_a.count</span></strong></code>? <em>Hint</em>: Suppose that the user had a million followers.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec14_2">14.2 A Web Interface for Following Users</h3>
<p class="noindent"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1">Section 14.1</a> placed some rather heavy demands on our data modeling skills, and it’s fine if that information takes a while to soak in. In fact, one of the best ways to understand the associations is to use them in the web interface.</p>
<p class="indent">In the introduction to this chapter, we saw a preview of the page flow for user following. In this section, we will implement the basic interface and following/un-following functionality shown in those mockups. We will also make separate pages to show the user following and followers arrays. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_3">Section 14.3</a>, we’ll complete our sample application by adding the user’s status feed.</p>
<section>
<h4 class="h4" id="sec14_2_1">14.2.1 Sample Following Data</h4>
<p class="noindent">As in previous chapters, we will find it convenient to use <code><strong><span class="colork1">rails db:seed</span></strong></code> to fill the database with sample relationships. This will allow us to design the look and feel of the web pages first, deferring the back-end functionality until later in this section.</p>
<p class="indent">Code to seed the following relationships appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex015">Listing 14.15</a>. Here we somewhat arbitrarily arrange for the first user to follow users 3 through 51, and then have users 4 through 41 follow that user back. The resulting relationships will be sufficient for developing the application interface.<span epub:type="pagebreak" id="page_737"></span></p>
<p class="ex-title" id="ch14ex015"><strong>Listing 14.15:</strong> Adding following/follower relationships to the sample data.</p>
<pre class="pre2">db/seeds.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-15a" id="list14-15">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork27"># Users</span>
<span class="colork5">User.</span>create!(<span class="colork5">name</span>:  <span class="colork5">"Example User"</span>,
             email: <span class="colork5">"example@railstutorial.org"</span>,
             <span class="colork8">password</span>:               <span class="colork5">"foobar"</span>,
             <span class="colork8">password_confirmation</span>:  <span class="colork5">"foobar"</span>,
             <span class="colork8">admin</span>:     <strong><span class="colork10">true</span></strong>,
             <span class="colork8">activated</span>: <strong><span class="colork10">true</span></strong>,
             <span class="colork8">activated_at</span>: <span class="colork8">Time</span>.zone.now)
<span class="colork8">99</span>.times <strong><span class="colork10">do</span></strong> <span class="colork9">|</span>n<span class="colork9">|</span>
  <span class="colork8">name</span> = Faker::Name.name
  email = <span class="colork22">"example-</span><strong><span class="grayk1">#{</span></strong>n+1<strong><span class="grayk1">}</span></strong><span class="colork22">@railstutorial.org"</span>
  password <span class="colork22">= "password"</span>
  <span class="colork22">User</span>.create!(<span class="colork22">name</span>:  <span class="colork22">name</span>,
               <span class="colork8">email</span>: email,
               <span class="colork8">password</span>:              password,
               <span class="colork8">password_confirmation</span>: password,
               <span class="colork8">activated</span>: <strong><span class="colork10">true</span></strong>,
               <span class="colork8">activated_at</span>: <span class="colork8">Time</span>.zone.now)
<strong><span class="colork10">end</span></strong>

<span class="colork26"># Microposts</span>
users = <span class="colork22">User</span>.order(<span class="colork8">:created_at</span>).take(<span class="colork8">6</span>)
<span class="colork22">50</span>.times <strong><span class="colork10">do</span></strong>
  content <span class="colork8">= Faker::Lorem</span>.sentence(<span class="colork8">5</span>)
  users.each { |user| user.microposts.create!(<span class="colork8">content</span>: content) }
<strong><span class="colork10">end</span></strong>

<span class="mark"><span class="colork22"># Create following relationships.</span></span>
<span class="mark">users = <span class="colork22">User</span>.all</span>
<span class="mark">user = users.first</span>
<span class="mark">following = users<span class="colork8">[2</span>..<span class="colork8">50]</span></span>
<span class="mark">followers = users<span class="colork8">[3</span>..<span class="colork8">40]</span></span>
<span class="mark">following.each { |followed| user.follow(followed) }</span>
<span class="mark">followers.each { |follower| follower.follow(user) }</span></pre>
</div>
<p class="indent">To execute the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex015">Listing 14.15</a>, we reset and reseed the database as usual:</p>
<pre class="pre1">$ rails db:migrate:reset
$ rails db:seed</pre>
<section>
<h5 class="h5" id="lev175"><span epub:type="pagebreak" id="page_738"></span>Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Using the console, confirm that <code><strong><span class="colork1">User.first.followers.count</span></strong></code> matches the value expected from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex015">Listing 14.15</a>.</p></li>
<li><p class="num">Confirm that <code><strong><span class="colork1">User.first.following.count</span></strong></code> is correct as well.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_2_2">14.2.2 Stats and a Follow Form</h4>
<p class="noindent">Now that our sample users have both followed users and followers, we need to update the profile page and Home page to reflect this. We’ll start by making a partial to display the following and follower statistics on the profile and home pages. We’ll next add a follow/unfollow form, and then make dedicated pages for showing “following” (followed users) and “followers”.</p>
<p class="indent">As noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_1_1">Section 14.1.1</a>, we’ll adopt Twitter’s convention of using “following” as a label for followed users, as in “50 following”. This usage is reflected in the mockup sequence starting in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig01">Figure 14.1</a> and shown in close-up in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig010">Figure 14.10</a>.</p>
<figure id="ch14fig010" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_10.jpg" alt="Image" width="186" height="65" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_10.jpg">
<figcaption><p><strong>Figure 14.10:</strong> A mockup of the stats partial.</p></figcaption>
</figure>
<p class="indent">The stats in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig010">Figure 14.10</a> consist of the number of users the current user is following and the number of followers, each of which should be a link to its respective dedicated display page. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#ch05">Chapter 5</a>, we stubbed out such links with the dummy text <code><strong><span class="colork1">'#'</span></strong></code>, but that was before we had much experience with routes. This time, although we’ll defer the creation of actual pages to <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2_3">Section 14.2.3</a>, we’ll make the routes now, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex016">Listing 14.16</a>. This code uses the <code><strong><span class="colork1">:member</span></strong></code> method inside a <code><strong><span class="colork1">resources</span></strong></code> <em>block</em>, which we haven’t seen before. Can you guess what it does?<span epub:type="pagebreak" id="page_739"></span></p>
<p class="ex-title" id="ch14ex016"><strong>Listing 14.16:</strong> Adding <code><strong><span class="colork1">following</span></strong></code> and <code><strong><span class="colork1">followers</span></strong></code> actions to the Users controller.</p>
<pre class="pre2">config/routes.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-16a" id="list14-16">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">Rails</span>.application.routes.draw <strong><span class="colork10">do</span></strong>
  root   <span class="colork22">'static_pages#home'</span>
  get    <span class="colork22">'/help'</span>,    to: <span class="colork22">'static_pages#help'</span>
  get    <span class="colork22">'/about'</span>,   to: <span class="colork22">'static_pages#about'</span>
  get    <span class="colork22">'/contact'</span>, to: <span class="colork22">'static_pages#contact'</span>
  get    <span class="colork22">'/signup'</span>,  to: <span class="colork22">'users#new'</span>
  get    <span class="colork22">'/login'</span>,   to: <span class="colork22">'sessions#new'</span>
  post   <span class="colork22">'/login'</span>,   to: <span class="colork22">'sessions#create'</span>
  delete <span class="colork22">'/logout'</span>,  to: <span class="colork22">'sessions#destroy'</span>
<span class="mark">  resources :users <strong><span class="colork10">do</span></strong></span>
<span class="mark">    member <strong><span class="colork10">do</span></strong></span>
<span class="mark">      get :following, :followers</span>
<span class="mark">    <strong><span class="colork10">end</span></strong></span>
<span class="mark">  <strong><span class="colork10">end</span></strong></span>
  resources <span class="colork8">:account_activations</span>, <span class="colork8">only</span>: <span class="colork8">[:edit]</span>
  resources <span class="colork8">:password_resets</span>,     <span class="colork8">only</span>: <span class="colork8">[:new</span>, <span class="colork8">:create</span>, <span class="colork8">:edit</span>, <span class="colork8">:update]</span>
  resources <span class="colork8">:microposts</span>,          <span class="colork8">only</span>: <span class="colork8">[:create</span>, <span class="colork8">:destroy]</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">You might suspect that the URLs for following and followers will look like /users/1/following and /users/1/followers, and that is exactly what the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex016">Listing 14.16</a> arranges. Since both pages will be <em>showing</em> data, the proper HTTP verb is a <code>GET</code> request, so we use the <code><strong><span class="colork1">get</span></strong></code> method to arrange for the URLs to respond appropriately. Meanwhile, the <code><strong><span class="colork1">member</span></strong></code> method arranges for the routes to respond to URLs containing the user id. The other possibility, <code><strong><span class="colork1">collection</span></strong></code>, works without the id, so that</p>
<pre class="pre1">resources :<span class="colork8">users</span><strong><span class="colork10">do</span></strong>
  collection <strong><span class="colork10">do</span></strong>
    get :<span class="colork8">tigers</span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">would respond to the URL /users/tigers (presumably to display all the tigers in our application).<sup><a id="ch14fn8a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn8" class="totri-footnote">8</a></sup></p>
<p class="footnote"><a id="ch14fn8" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn8a" class="totri-footnote">8</a>. For more details on such routing options, see the Rails Guides article on “Rails Routing from the Outside In” (<a href="http://guides.rubyonrails.org/routing.html">guides.rubyonrails.org/routing.html</a>).</p>
<p class="indent">The routes generated by <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex016">Listing 14.16</a> appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14tab02">Table 14.2</a>. Note the named routes for the followed user and followers pages, which we’ll put to use shortly.</p>
<p class="indent">With the routes defined, we are now in a position to define the stats partial, which involves a couple of links inside a div, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex017">Listing 14.17</a>.<span epub:type="pagebreak" id="page_740"></span></p>
<figure id="ch14tab02">
<figcaption><p><strong>Table 14.2:</strong> RESTful routes provided by the custom rules in the resource in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex016">Listing 14.16</a>.</p></figcaption>
<table class="topbot">
<thead>
<tr>
<th class="tab-th"><p class="tab-para">HTTP request</p></th>
<th class="tab-th"><p class="tab-para">URL</p></th>
<th class="tab-th"><p class="tab-para">Action</p></th>
<th class="tab-th"><p class="tab-para">Named route</p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="table"><p><code>GET</code></p></td>
<td class="table"><p>/users/1/following</p></td>
<td class="table"><p><code><strong><span class="colork1">following</span></strong></code></p></td>
<td class="table"><p><code><strong><span class="colork1">following_user_path(1)</span></strong></code></p></td>
</tr>
<tr>
<td class="table"><p><code>GET</code></p></td>
<td class="table"><p>/users/1/followers</p></td>
<td class="table"><p><code><strong><span class="colork1">followers</span></strong></code></p></td>
<td class="table"><p><code><strong><span class="colork1">followers_user_path(1)</span></strong></code></p></td>
</tr>
</tbody>
</table>
</figure>
<p class="ex-title" id="ch14ex017"><strong>Listing 14.17:</strong> A partial for displaying follower stats.</p>
<pre class="pre2">app/views/shared/_stats.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-17a" id="list14-17">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> <span class="colork8">@user ||=</span> current_user <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"stats"</span>&gt;
  &lt;<strong><span class="colork10">a</span></strong> <span class="colork22">href="&lt;%=</span> following_user_path(<span class="colork8">@user</span>) <span class="colork22">%&gt;"</span>&gt;
    &lt;<strong><span class="colork10">strong</span></strong> <span class="colork22">id="following" class="stat"</span>&gt;
      <span class="colork22">&lt;%=</span> <span class="colork8">@user</span>.following.count <span class="colork22">%&gt;</span>
    &lt;/<strong><span class="colork10">strong</span></strong>&gt;
    following
  &lt;/<strong><span class="colork10">a</span></strong>&gt;
  &lt;<strong><span class="colork10">a</span></strong> <span class="colork22">href="&lt;%=</span> followers_user_path(@user) <span class="colork22">%&gt;"</span>&gt;
    &lt;<strong><span class="colork10">strong</span></strong> <span class="colork22">id="followers" class="stat"</span>&gt;
      <span class="colork22">&lt;%=</span> <span class="colork8">@user.</span>followers.count <span class="colork22">%&gt;</span>
    &lt;/<strong><span class="colork10">strong</span></strong>&gt;
    followers
  &lt;/<strong><span class="colork10">a</span></strong>&gt;
&lt;/<strong><span class="colork10">div</span></strong>&gt;</pre>
</div>
<p class="indent">Since we will be including the stats on both the user show pages and the Home page, the first line of <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex017">Listing 14.17</a> picks the right one using</p>
<pre class="pre1"><span class="colork22">&lt;%</span> <span class="colork8">@user ||=</span> current_user <span class="colork22">%&gt;</span></pre>
<p class="noindent">As discussed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch08.xhtml#box8_1">Box 8.1</a>, this does nothing when <code><strong><span class="colork1">@user</span></strong></code> is not <code><strong><span class="colork1">nil</span></strong></code>, as on a profile page. When it is <code><strong><span class="colork1">nil</span></strong></code>, though, as on the Home page, it sets <code><strong><span class="colork1">@user</span></strong></code> to the current user. Note also that the following/follower counts are calculated through the associations using</p>
<pre class="pre1"><span class="colork8">@user.</span>following.count</pre>
<p class="noindent">and</p>
<pre class="pre1"><span class="colork8">@user.</span>followers.count</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_741"></span>Compare these to the microposts count from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex024">Listing 13.24</a>, where we wrote</p>
<pre class="pre1"><span class="colork8">@user.</span>microposts.count</pre>
<p class="noindent">to count the microposts. As in that case, Rails calculates the count directly in the database for efficiency.</p>
<p class="indent">One final detail worth noting is the presence of CSS ids on some elements, as in</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg741-01a" id="pg741-01">Click here to view code image</a></p>
<pre class="pre1">&lt;<strong><span class="colork10">strong</span></strong> <span class="colork22">id="following" class="stat"</span>&gt;
...
&lt;/<strong><span class="colork10">strong</span></strong>&gt;</pre>
<p class="noindent">They are included for the benefit of the Ajax implementation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2_5">Section 14.2.5</a>, which accesses elements on the page using their unique ids.</p>
<p class="indent">With the partial in hand, including the stats on the Home page is easy, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex018">Listing 14.18</a>.</p>
<p class="ex-title" id="ch14ex018"><strong>Listing 14.18:</strong> Adding follower stats to the Home page.</p>
<pre class="pre2">app/views/static_pages/home.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-18a" id="list14-18">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> <strong>if</strong> logged_in? <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"row"</span>&gt;
   &lt;<strong><span class="colork10">aside</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-4"</span>&gt;
     &lt;<strong><span class="colork10">section</span></strong> <span class="colork22">class=</span><span class="colork23">"user_info"</span>&gt;
       <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/user_info' %&gt;</span>
     &lt;/<strong><span class="colork10">section</span></strong>&gt;
<span class="mark">     &lt;<strong><span class="colork10">section</span></strong> <span class="colork22">class=</span><span class="colork23">"stats"</span>&gt;</span>
<span class="mark">      <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/stats' %&gt;</span></span>
<span class="mark">     &lt;/<strong><span class="colork10">section</span></strong>&gt;</span>
     &lt;<strong><span class="colork10">section</span></strong> <span class="colork22">class=</span><span class="colork23">"micropost_form"</span>&gt;
       <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/micropost_form' %&gt;</span>
     &lt;/<strong><span class="colork10">section</span></strong>&gt;
   &lt;/<strong><span class="colork10">aside</span></strong>&gt;
   &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-8"</span>&gt;
     &lt;<strong><span class="colork10">h3</span></strong>&gt;Micropost Feed&lt;/<strong><span class="colork10">h3</span></strong>&gt;
     <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/feed' %&gt;</span>
   &lt;/<strong><span class="colork10">div</span></strong>&gt;
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
<span class="colork22">&lt;%</span> <strong><span class="colork10">else</span></strong> <span class="colork22">%&gt;</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
&lt;% <strong>end</strong> %&gt;</pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_742"></span>To style the stats, we’ll add some SCSS, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex019">Listing 14.19</a> (which contains all the stylesheet code needed in this chapter). The resulting Home page appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig011">Figure 14.11</a>.</p>
<figure id="ch14fig011" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_11.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_11.jpg">
<figcaption><p><strong>Figure 14.11:</strong> The Home page with follow stats.</p></figcaption>
</figure>
<p class="ex-title" id="ch14ex019"><strong>Listing 14.19:</strong> SCSS for the Home page sidebar.</p>
<pre class="pre2">app/assets/stylesheets/custom.scss</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-19a" id="list14-19">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork9">.</span>
<span class="colork9">.</span>
<span class="colork9">.</span>
<span class="colork22">/*</span> <strong><span class="colork10">sidebar</span></strong> <span class="colork22">*/</span>
<span class="colork9">.</span>
<span class="colork9">.</span>
<span class="colork9">.</span>
<strong><span class="colork4">.gravatar</span></strong> {
  <strong><span class="colork10">float</span></strong>: <strong><span class="colork10">left</span></strong><span class="colork10">;</span>
  <strong><span class="colork10">margin-right</span></strong><span class="colork10">:</span> <strong><span class="colork10">10px</span></strong><span class="colork10">;</span>
}

<strong><span class="colork4">.gravatar_edit</span></strong> {
<span epub:type="pagebreak" id="page_743"></span>  <strong><span class="colork10">margin-top</span></strong><span class="colork10">:</span> <strong><span class="colork10">15px</span></strong><span class="colork10">;</span>
}
<span class="mark"><strong><span class="colork4">.stats</span></strong> {</span>
  <span class="colork10"><strong>overflow</strong>: <strong>auto</strong>;</span>
  <span class="colork10"><strong>margin-top</strong>: <strong>0</strong>;</span>
  <span class="colork10"><strong>padding</strong>: <strong>0</strong>;</span>
  <strong><span class="colork10">a</span></strong> {
    <span class="colork10"><strong>float</strong>: <strong>left</strong>;</span>
    <span class="colork10"><strong>padding</strong>: <strong>0 10px</strong>;</span>
    <span class="colork10"><strong>border-left</strong>: <strong>1px solid</strong> $<strong>gray-lighter</strong>;</span>
    <span class="colork10"><strong>color</strong>: <strong>gray</strong>;</span>
    <strong><span class="colork10">&amp;</span></strong>:<span class="colork8">first-child</span> {
      <span class="colork10"><strong>padding-left</strong>: <strong>0</strong>;</span>
      <span class="colork10"><strong>border</strong>: <strong>0</strong>;</span>
    }
    <strong><span class="colork10">&amp;</span></strong><span class="colork8">:hover</span> {
      <span class="colork10"><strong>text-decoration</strong>: <strong>none</strong>;</span>
      <span class="colork10"><strong>color</strong>: <strong>blue</strong>;</span>
    }
  }
  <strong><span class="colork10">strong</span></strong> {
    <span class="colork10"><strong>display</strong>: <strong>block</strong></span>;
  }
}

<span class="mark"><strong><span class="colork4">.user_avatars</span></strong> {</span>
  <span class="colork10"><strong>overflow</strong>: <strong>auto</strong>;</span>
  <span class="colork10"><strong>margin-top</strong>: <strong>10px</strong>;</span>
  <strong><span class="colork4">.gravatar</span></strong> {
    <span class="colork10"><strong>margin</strong>: <strong>1px 1px</strong>;</span>
  }
  <strong><span class="colork10">a</span></strong> {
    <span class="colork10"><strong>padding</strong>: <strong>0</strong>;</span>
  }
}

<strong><span class="colork4">.users.follow</span></strong> {
  <span class="colork10"><strong>padding</strong>: <strong>0</strong>;</span>
}

<span class="colork22">/* forms */</span>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong>
<strong><span class="colork9">.</span></strong></pre>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_744"></span>We’ll render the stats partial on the profile page in a moment, but first let’s make a partial for the follow/unfollow button, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex020">Listing 14.20</a>.</p>
<p class="ex-title" id="ch14ex020"><strong>Listing 14.20:</strong> A partial for a follow/unfollow form.</p>
<pre class="pre2">app/views/users/_follow_form.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-20a" id="list14-20">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> <strong><span class="colork10">unless</span></strong> current_user?(<span class="colork8">@user</span>) <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">id=</span><span class="colork23">"follow_form"</span>&gt;
  <span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> current_user.following?(<span class="colork8">@user</span>) <span class="colork22">%&gt;</span>
    <span class="colork22">&lt;%=</span> render <span class="colork22">'unfollow'</span> <span class="colork22">%&gt;</span>
  <span class="colork22">&lt;%</span> <strong><span class="colork10">else</span></strong> <span class="colork22">%&gt;</span>
    <span class="colork22">&lt;%=</span> render <span class="colork22">'follow' %&gt;</span>
  <span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span></pre>
</div>
<p class="noindent">This does nothing but defer the real work to the <code><strong><span class="colork1">follow</span></strong></code> and <code><strong><span class="colork1">unfollow</span></strong></code> partials. They need new routes for the Relationships resource, which follows the Microposts resource example (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex030">Listing 13.30</a>), as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex021">Listing 14.21</a>.</p>
<p class="ex-title" id="ch14ex021"><strong>Listing 14.21:</strong> Adding the routes for user relationships.</p>
<pre class="pre2">config/routes.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-21a" id="list14-21">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">Rails</span>.application.routes.draw <strong><span class="colork10">do</span></strong>
  root                <span class="colork22">'static_pages#home'</span>
  get    <span class="colork22">'help'</span>    <span class="colork8">=&gt;</span> <span class="colork22">'static_pages#help'</span>
  get    <span class="colork22">'about'</span>   <span class="colork8">=&gt;</span> <span class="colork22">'static_pages#about'</span>
  get    <span class="colork22">'contact'</span> <span class="colork8">=&gt;</span> <span class="colork22">'static_pages#contact'</span>
  get    <span class="colork22">'signup'</span>  <span class="colork8">=&gt;</span> <span class="colork22">'users#new'</span>
  get    <span class="colork22">'login'</span>   <span class="colork8">=&gt;</span> <span class="colork22">'sessions#new'</span>
  post   <span class="colork22">'login'</span>   <span class="colork8">=&gt;</span> <span class="colork22">'sessions#create'</span>
  delete <span class="colork22">'logout'</span>  <span class="colork8">=&gt;</span> <span class="colork22">'sessions#destroy'</span>
  resources <span class="colork8">:users</span> <strong><span class="colork10">do</span></strong>
    member <strong><span class="colork10">do</span></strong>
      get <span class="colork8">:following</span>, <span class="colork8">:followers</span>
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>
  resources <span class="colork8">:account_activations</span>, <span class="colork8">only</span>: <span class="colork8">[:edit]</span>
  resources :<span class="colork8">password_resets</span>,     <span class="colork8">only</span>: <span class="colork8">[:new</span>, <span class="colork8">:create</span>, <span class="colork8">:edit</span>, <span class="colork8">:update]</span>
  resources <span class="colork8">:microposts</span>,          <span class="colork8">only</span>: <span class="colork8">[:create</span>, <span class="colork8">:destroy]</span>
<span class="mark">  resources :relationships,       only: [:create, :destroy]</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_745"></span>The follow and unfollow partials themselves are shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex022">Listing 14.22</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex023">Listing 14.23</a>, respectively.</p>
<p class="ex-title" id="ch14ex022"><strong>Listing 14.22:</strong> A form for following a user.</p>
<pre class="pre2">app/views/users/_follow.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-22a" id="list14-22">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> form_with(model: current_user.active_relationships.build, <span class="colork8">local:</span> <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> |f| <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">div</span></strong><span class="colork22">&gt;&lt;%=</span> hidden_field_tag <span class="colork8">:followed_id</span>,<span class="colork8"> @user.</span>id <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">div</span></strong>&gt;
  <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Follow"</span>, <span class="colork8">class</span>: <span class="colork22">"btn btn-primary"</span> <span class="colork22">%&gt;</span>
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span></pre>
</div>
<p class="ex-title" id="ch14ex023"><strong>Listing 14.23:</strong> A form for unfollowing a user.</p>
<pre class="pre2">app/views/users/_unfollow.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-23a" id="list14-23">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> form_with(<span class="colork8">model</span>: current_user.active_relationships.find_by(<span class="colork8">followed_id</span>: <span class="colork8">@user</span>.id),
             html: { <span class="colork22">method</span>: :<span class="colork8">delete</span> }, <span class="colork8">local</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> <span class="colork22">|</span>f<span class="colork22">| %&gt;</span>
  <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Unfollow"</span>, <span class="colork8">class</span>: <span class="colork22">"btn" %&gt;</span>
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span></pre>
</div>
<p class="indent">Both of these forms use <code><strong><span class="colork1">form_with</span></strong></code> to manipulate a Relationship model object; the main difference between the two is that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex022">Listing 14.22</a> builds a <em>new</em> relationship, whereas <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex023">Listing 14.23</a> finds the existing relationship. Naturally, the former sends a <code>POST</code> request to the Relationships controller to <code><strong><span class="colork1">create</span></strong></code> a relationship, while the latter sends a <code>DELETE</code> request to <code><strong><span class="colork1">destroy</span></strong></code> a relationship. (We’ll discuss these actions in more depty in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2_4">Section 14.2.4</a>.) Finally, note that the follow form doesn’t have any content other than the button, but it still needs to send the <code><strong><span class="colork1">followed_id</span></strong></code> to the controller. We accomplish this with the <code><strong><span class="colork1">hidden_field_tag</span></strong></code> method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex022">Listing 14.22</a>, which produces HTML of the form</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg745-01a" id="pg745-01">Click here to view code image</a></p>
<pre class="pre1">&lt;<strong><span class="colork10">input</span></strong> <span class="colork22">id=</span><span class="colork23">"followed_id"</span> <span class="colork22">name=</span><span class="colork23">"followed_id"</span> <span class="colork22">type=</span><span class="colork23">"hidden"</span> <span class="colork22">value=</span><span class="colork23">"3"</span> /&gt;</pre>
<p class="noindent">As we saw in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#sec12_3">Section 12.3</a> (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch12.xhtml#ch12ex014">Listing 12.14</a>), the hidden <code><strong><span class="colork1">input</span></strong></code> tag puts the relevant information on the page without displaying it in the browser.</p>
<p class="indent">We can now include the follow form and the following statistics on the user profile page simply by rendering the partials, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex024">Listing 14.24</a>. Profiles with ”Follow” and ”Unfollow” buttons, respectively, appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig012">Figure 14.12</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig013">Figure 14.13</a>.<span epub:type="pagebreak" id="page_746"></span></p>
<figure id="ch14fig012" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_12.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_12.jpg">
<figcaption><p><strong>Figure 14.12:</strong> A user profile with a ”Follow” button (/users/2).</p></figcaption>
</figure>
<figure id="ch14fig013" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_13.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_13.jpg">
<figcaption><p><strong>Figure 14.13:</strong> A user profile with an ”Unfollow” button (/users/5).</p></figcaption>
</figure>
<p class="ex-title" id="ch14ex024"><strong>Listing 14.24:</strong> Adding the follow form and follower stats to the user profile page.</p>
<pre class="pre2">app/views/users/show.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-24a" id="list14-24">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> provide(:<span class="colork8">title</span>, <span class="colork8">@user.</span>name) <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"row"</span>&gt;
  &lt;<strong><span class="colork10">aside</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-4"</span>&gt;
   &lt;<strong><span class="colork10">section</span></strong>&gt;
     &lt;<strong><span class="colork10">h1</span></strong>&gt;
       <span class="colork22">&lt;%=</span> gravatar_for @<span class="colork8">user</span> <span class="colork22">%&gt;</span>
       <span class="colork22">&lt;%=</span> <span class="colork8">@user.</span>name <span class="colork22">%&gt;</span>
     &lt;/<strong><span class="colork10">h1</span></strong>&gt;
   &lt;/<strong><span class="colork10">section</span></strong>&gt;
<span class="mark">   &lt;<strong><span class="colork22">section</span></strong> <span class="colork22">class=</span><span class="colork23">"stats"</span>&gt;</span>
<span class="mark">     <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/stats' %&gt;</span></span>
<span class="mark">   &lt;/<strong><span class="colork22">section</span></strong>&gt;</span>
  &lt;/<strong><span class="colork10">aside</span></strong>&gt;
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-8"</span>&gt;
<span class="mark">    <span class="colork22">&lt;%=</span> render <span class="colork22">'follow_form'</span> <strong><span class="colork10">if</span></strong> logged_in? <span class="colork22">%&gt;</span></span>
<span epub:type="pagebreak" id="page_747"></span><span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> <span class="colork8">@user.</span>microposts.any? <span class="colork22">%&gt;</span>
  &lt;<strong><span class="colork10">h3</span></strong>&gt;Microposts (<span class="colork22">&lt;%=</span> <span class="colork8">@user.</span>microposts.count <span class="colork22">%&gt;</span>)&lt;/<strong><span class="colork10">h3</span></strong>&gt;
  &lt;<strong><span class="colork10">ol</span></strong> <span class="colork22">class=</span><span class="colork23">"microposts"</span>&gt;
      <span class="colork22">&lt;%=</span> render <span class="colork8">@microposts</span> <span class="colork22">%&gt;</span>
    &lt;/<strong><span class="colork10">ol</span></strong>&gt;
    <span class="colork22">&lt;%=</span> will_paginate <span class="colork8">@microposts</span> <span class="colork22">%&gt;</span>
   <span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
&lt;/<strong><span class="colork10">div</span></strong>&gt;</pre>
</div>
<p class="indent">We’ll get these buttons working soon enough—in fact, we’ll do it two ways, the standard way (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2_4">Section 14.2.4</a>) and using Ajax (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2_5">Section 14.2.5</a>). First, though, we’ll finish the HTML interface by making the following and followers pages.</p>
<section>
<h5 class="h5" id="lev176">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_748"></span></p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Verify that /users/2 has a follow form and that /users/5 has an unfollow form. Is there a follow form on /users/1?</p></li>
<li><p class="num">Confirm in the browser that the stats appear correctly on the Home page and on the profile page.</p></li>
<li><p class="num">Write tests for the stats on the Home page. <em>Hint</em>: Add to the test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex028">Listing 13.28</a>. Why don’t we also have to test the stats on the profile page?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_2_3">14.2.3 Following and Followers Pages</h4>
<p class="noindent">Pages to display followed users and followers will resemble a hybrid of the user profile page and the user index page (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#sec10_3_1">Section 10.3.1</a>), with a sidebar of user information (including the following stats) and a list of users. In addition, we’ll include a raster of smaller user profile image links in the sidebar. Mockups matching these requirements appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig014">Figure 14.14</a> (following) and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig015">Figure 14.15</a> (followers).</p>
<figure id="ch14fig014" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_14.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_14.jpg">
<figcaption><p><strong>Figure 14.14:</strong> A mockup of the user following page.</p></figcaption>
</figure>
<figure id="ch14fig015" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_15.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_15.jpg">
<figcaption><p><strong>Figure 14.15:</strong> A mockup of the user followers page.</p></figcaption>
</figure>
<p class="indent">Our first step is to get the following and followers links to work. We’ll follow Twitter’s lead and have both pages require user login. As with most previous examples of access control, we’ll write the tests first, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex025">Listing 14.25</a>. Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex025">Listing 14.25</a> uses the named routes from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14tab02">Table 14.2</a>.</p>
<p class="ex-title" id="ch14ex025"><strong>Listing 14.25:</strong> Tests for the authorization of the following and followers pages. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">test/controllers/users_controller_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-25a" id="list14-25">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork8">class</span> <span class="colork4">UsersControllerTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(:<span class="colork8">michael</span>)
    <span class="colork8">@other_user =</span> users(<span class="colork8">:archer</span>)
  <strong><span class="colork10">end</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork22">test "should redirect following when not logged in"</span> <strong><span class="colork10">do</span></strong>
    get following_user_path(<span class="colork8">@user</span>)
    assert_redirected_to login_url
<span epub:type="pagebreak" id="page_749"></span> <strong><span class="colork10">end</span></strong>

  <span class="colork22">test "should redirect followers when not logged in"</span> <strong><span class="colork10">do</span></strong>
    get followers_user_path(<span class="colork8">@user</span>)
    assert_redirected_to login_url
 <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">The only tricky part of the implementation is realizing that we need to add two new actions to the Users controller. Based on the routes defined in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex016">Listing 14.16</a>, we need to call them <code><strong><span class="colork1">following</span></strong></code> and <code><strong><span class="colork1">followers</span></strong></code>. Each action needs to set a title, find the user, retrieve either <code><strong><span class="colork1">@user.following</span></strong></code> or <code><strong><span class="colork1">@user.followers</span></strong></code> (in paginated form), and then render the page. The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex026">Listing 14.26</a>.<span epub:type="pagebreak" id="page_750"></span></p>
<p class="ex-title" id="ch14ex026"><strong>Listing 14.26:</strong> The <code><strong><span class="colork1">following</span></strong></code> and <code><strong><span class="colork1">followers</span></strong></code> actions. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">app/controllers/users_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-26a" id="list14-26">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork8">class</span> <span class="colork4">UsersController</span></strong> <span class="colork11">&lt; ApplicationController</span>

  before_action <span class="colork8">:logged_in_user</span>, <span class="colork8">only</span>: <span class="colork8">[:index</span>, <span class="colork8">:edit</span>, <span class="colork8">:update</span>, <span class="colork8">:destroy</span>,
                                        <span class="colork8">:following</span>, <span class="colork8">:followers]</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork8">following</span>
    <span class="colork8">@title =</span> <span class="colork22">"Following"</span>
    <span class="colork8">@user =</span> User.find(params<span class="colork8">[:id]</span>)
    <span class="colork8">@users = @user</span>.following.paginate(<span class="colork8">page</span>: params<span class="colork8">[:page]</span>)
    render <span class="colork22">'show_follow'</span>
  <strong><span class="colork10">end</span></strong>
<span epub:type="pagebreak" id="page_751"></span>  <strong><span class="colork10">def</span></strong> <span class="colork4">followers</span>
    <span class="colork4">@title =</span> <span class="colork22">"Followers"</span>
    <span class="colork8">@user =</span> <span class="colork8">User.</span>find(params<span class="colork8">[:id]</span>)
    <span class="colork8">@users = @user</span>.followers.paginate(page: params<span class="colork8">[:page]</span>)
    render <span class="colork22">'show_follow'</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">private</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">As we’ve seen throughout this tutorial, the usual Rails convention is to implicitly render the template corresponding to an action, such as rendering <code><strong><span class="colork1">show.html.erb</span></strong></code> at the end of the <code><strong><span class="colork1">show</span></strong></code> action. In contrast, both actions in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex026">Listing 14.26</a> make an <em>explicit</em> call to <code><strong><span class="colork1">render</span></strong></code>, in this case rendering a view called <code><strong><span class="colork1">show_follow</span></strong></code>, which we must create. The reason for the common view is that the ERb is nearly identical for the two cases, and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex027">Listing 14.27</a> covers them both.</p>
<p class="ex-title" id="ch14ex027"><strong>Listing 14.27:</strong> The <code><strong><span class="colork1">show_follow</span></strong></code> view used to render following and followers. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">app/views/users/show_follow.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-27a" id="list14-27">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%</span> provide(<span class="colork8">:title</span>, <span class="colork8">@title</span>) <span class="colork22">%&gt;</span>
&lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"row"</span>&gt;
  &lt;<strong><span class="colork10">aside</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-4"</span>&gt;
    &lt;<strong><span class="colork10">section</span></strong> <span class="colork22">class=</span><span class="colork23">"user_info"</span>&gt;
      <span class="colork22">&lt;%=</span> gravatar_for <span class="colork8">@user</span> <span class="colork22">%&gt;</span>
      &lt;<strong><span class="colork10">h1</span></strong>&gt;<span class="colork22">&lt;%=</span> <span class="colork8">@user.</span>name <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">h1</span></strong>&gt;
      &lt;<strong><span class="colork10">span</span></strong>&gt;<span class="colork22">&lt;%=</span> link_to <span class="colork22">"view my profile"</span>, <span class="colork8">@user</span> <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
      &lt;<strong><span class="colork10">span</span></strong>&gt;&lt;<strong><span class="colork10">b</span></strong>&gt;Microposts:&lt;/<strong><span class="colork10">b</span></strong>&gt; <span class="colork22">&lt;%=</span> <span class="colork8">@user.</span>microposts.count <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">span</span></strong>&gt;
    &lt;/<strong><span class="colork10">section</span></strong>&gt;
    &lt;<strong><span class="colork10">section</span></strong> <span class="colork22">class=</span><span class="colork23">"stats"</span>&gt;
      <span class="colork22">&lt;%=</span> render <span class="colork22">'shared/stats' %&gt;</span>
      <span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> <span class="colork8">@users.</span>any? <span class="colork22">%&gt;</span>
        &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"user_avatars"</span>&gt;
          <span class="colork22">&lt;%</span> <span class="colork8">@users.</span>each <strong><span class="colork10">do</span></strong> |user| <span class="colork22">%&gt;</span>
            <span class="colork22">&lt;%=</span> link_to gravatar_for(user, <span class="colork8">size</span>: <span class="colork8">30</span>), user <span class="colork22">%&gt;</span>
          <span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
        &lt;/<strong><span class="colork10">div</span></strong>&gt;
      <span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
    &lt;/<strong><span class="colork10">section</span></strong>&gt;
  &lt;/<strong><span class="colork10">aside</span></strong>&gt;
  &lt;<strong><span class="colork10">div</span></strong> <span class="colork22">class=</span><span class="colork23">"col-md-8"</span>&gt;
<span epub:type="pagebreak" id="page_752"></span>    &lt;<strong><span class="colork10">h3</span></strong>&gt;<span class="colork22">&lt;%=</span> <span class="colork8">@title</span> <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">h3</span></strong>&gt;
    <span class="colork22">&lt;%</span> <strong><span class="colork10">if</span></strong> <span class="colork8">@users.</span>any? <span class="colork22">%&gt;</span>
      &lt;<strong><span class="colork10">ul</span></strong> <span class="colork22">class=</span><span class="colork23">"users follow"</span>&gt;
        <span class="colork22">&lt;%=</span> render <span class="colork8">@users</span> <span class="colork22">%&gt;</span>
      &lt;/<strong><span class="colork10">ul</span></strong>&gt;
      <span class="colork22">&lt;%=</span> will_paginate <span class="colork22">%&gt;</span>
    <span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span>
  &lt;/<strong><span class="colork10">div</span></strong>&gt;
&lt;/<strong><span class="colork10">div</span></strong>&gt;</pre>
</div>
<p class="noindent">The actions in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex026">Listing 14.26</a> render the view from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex027">Listing 14.27</a> in two contexts, “following” and “followers,” with the results shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig016">Figure 14.16</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig017">Figure 14.17</a>, respectively Note that nothing in this code uses the current user, so the same links work for other users, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig018">Figure 14.18</a>.</p>
<figure id="ch14fig016" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_16.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_16.jpg">
<figcaption><p><strong>Figure 14.16:</strong> Showing the users the given user is following.<span epub:type="pagebreak" id="page_753"></span></p></figcaption>
</figure>
<figure id="ch14fig017" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_17.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_17.jpg">
<figcaption><p><strong>Figure 14.17:</strong> Showing the given user’s followers.</p></figcaption>
</figure>
<figure id="ch14fig018" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_18.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_18.jpg">
<figcaption><p><strong>Figure 14.18:</strong> Showing a different user’s followers.</p></figcaption>
</figure>
<p class="indent">At this point, the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex025">Listing 14.25</a> should be <small><span class="colork14">GREEN</span></small> due to the before filter in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex026">Listing 14.26</a>:</p>
<p class="ex-title" id="ch14ex028"><strong>Listing 14.28:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">To test the <code><strong><span class="colork1">show_follow</span></strong></code> rendering, we’ll write a couple of short integration tests that verify the presence of working following and followers pages. They are designed to be a reality check, not to be comprehensive; indeed, as noted in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch05.xhtml#sec5_3_4">Section 5.3.4</a>, comprehensive tests of things like HTML structure are likely to be brittle and thus counter-productive. Our plan in the case of following/followers pages is to check that the number is correctly displayed and that links with the right URLs appear on the page.<span epub:type="pagebreak" id="page_754"></span></p>
<p class="indent">To get started, we’ll generate an integration test as usual:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg754-01a" id="pg754-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails generate integration_test following
      <span class="colork1">invoke  test_unit</span>
      <span class="colork1">create    test/integration/following_test.rb</span></pre>
<p class="indent">Next, we need to assemble some test data, which we can do by adding some relationships fixtures to create following/follower relationships. Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_2_3">Section 13.2.3</a> that we can use code like</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg754-02a" id="pg754-02">Click here to view code image</a></p>
<pre class="pre1">orange:
  content: <span class="colork1">"I just ate an orange!"</span>
  created_at: &lt;%= 10.minutes.ago %&gt;
  user: michael</pre>
<p class="noindent">to associate a micropost with a given user. In particular, we can write<span epub:type="pagebreak" id="page_755"></span></p>
<pre class="pre1">user: michael</pre>
<p class="noindent">instead of</p>
<pre class="pre1">user_id: 1</pre>
<p class="noindent">Applying this idea to the relationships fixtures gives the associations in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex029">Listing 14.29</a>.</p>
<p class="ex-title" id="ch14ex029"><strong>Listing 14.29:</strong> Relationships fixtures for use in following/follower tests.</p>
<pre class="pre2">test/fixtures/relationships.yml</pre>
<div class="example">
<pre>one:
  follower: michael
  followed: lana

two:
  follower: michael
  followed: malory

three:
  follower: lana
  followed: michael

four:
  follower: archer
  followed: michael</pre>
</div>
<p class="indent">The fixtures in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex029">Listing 14.29</a> first arrange for Michael to follow Lana and Malory, and then arrange for Michael to be followed by Lana and Archer. To test for the right count, we can use the same <code><strong><span class="colork1">assert_match</span></strong></code> method we used in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex028">Listing 13.28</a> to test for the display of the number of microposts on the user profile page. Adding in assertions for the right links yields the tests shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex030">Listing 14.30</a>.</p>
<p class="ex-title" id="ch14ex030"><strong>Listing 14.30:</strong> Tests for following/follower pages. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">test/integration/following_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-30a" id="list14-30">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">FollowingTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(:<span class="colork8">michael</span>)
<span epub:type="pagebreak" id="page_756"></span>    log_in_as(<span class="colork8">@user</span>)
  <strong><span class="colork10">end</span></strong>

  <span class="colork22">test "following page"</span> <strong><span class="colork10">do</span></strong>
    get following_user_path(<span class="colork8">@user</span>)
    assert_not <span class="colork8">@user.</span>following.empty?
    assert_match <span class="colork8">@user.</span>following.count.to_s, response.body
    <span class="colork8">@user.</span>following.each <strong><span class="colork10">do</span></strong> <span class="colork8">|</span>user<span class="colork8">|</span>
      assert_select <span class="colork22">"a[href=?]"</span>, user_path(user)
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>

  <span class="colork22">test "followers page"</span> <strong><span class="colork10">do</span></strong>
    get followers_user_path(<span class="colork8">@user</span>)
    assert_not <span class="colork8">@user.</span>followers.empty?
    assert_match <span class="colork8">@user.</span>followers.count.to_s, response.body
    <span class="colork8">@user.</span>followers.each <strong><span class="colork10">do</span></strong> <span class="colork8">|</span>user<span class="colork8">|</span>
      assert_select <span class="colork22">"a[href=?]"</span>, user_path(user)
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex030">Listing 14.30</a>, note that we include the assertion</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg756-01a" id="pg756-01">Click here to view code image</a></p>
<pre class="pre1">assert_not <span class="colork8">@user.</span>following.empty?</pre>
<p class="noindent">which is included to make sure that</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg756-02a" id="pg756-02">Click here to view code image</a></p>
<pre class="pre1"><span class="colork8">@user.</span>following.each <strong><span class="colork10">do</span></strong> <span class="colork8">|</span>user<span class="colork8">|</span>
  assert_select <span class="colork22">"a[href=?]"</span>, user_path(user)
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">isn’t vacuously true (and similarly for <code><strong><span class="colork1">followers</span></strong></code>). In other words, if <code><strong><span class="colork1">@user. following.empty?</span></strong></code> were true, not a single <code><strong><span class="colork1">assert_select</span></strong></code> would execute in the loop, leading the tests to pass and thereby giving us a false sense of security.</p>
<p class="indent">The test suite should now be <small><span class="colork14">GREEN</span></small>:</p>
<p class="ex-title" id="ch14ex031"><strong>Listing 14.31:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev177"><span epub:type="pagebreak" id="page_757"></span>Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Verify in a browser that /users/1/followers and /users/1/following work. Do the image links in the sidebar work as well?</p></li>
<li><p class="num">Comment out the application code needed to turn the <code><strong><span class="colork1">assert_select</span></strong></code> tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex030">Listing 14.30</a> <small><span class="redk1">RED</span></small> to confirm they’re testing the right thing.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_2_4">14.2.4 A Working Follow Button the Standard Way</h4>
<p class="noindent">Now that our views are in order, it’s time to get the follow/unfollow buttons working. Because following and unfollowing involve creating and destroying relationships, we need a Relationships controller, which we generate as usual:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg757-01a" id="pg757-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork2">$</span></strong> rails generate controller Relationships</pre>
<p class="indent">As we’ll see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex033">Listing 14.33</a>, enforcing access control on the Relationships controller actions won’t much matter, but we’ll still continue our previous practice of enforcing the security model as early as possible. In particular, we’ll check that attempts to access actions in the Relationships controller require a logged-in user (and thus get redirected to the login page), while also not changing the Relationship count, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex032">Listing 14.32</a>.</p>
<p class="ex-title" id="ch14ex032"><strong>Listing 14.32:</strong> Basic access control tests for relationships. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">test/controllers/relationships_controller_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-32a" id="list14-32">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork8">class</span> <span class="colork4">RelationshipsControllerTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  test <span class="colork22">"create should require logged-in user"</span> <strong><span class="colork10">do</span></strong>
    assert_no_difference <span class="colork22">'Relationship.count'</span> <strong><span class="colork10">do</span></strong>
      post relationships_path
    <strong><span class="colork10">end</span></strong>
    assert_redirected_to login_url
  <strong><span class="colork10">end</span></strong>
<span epub:type="pagebreak" id="page_758"></span>  <span class="colork22">test "destroy should require logged-in user"</span> <strong><span class="colork10">do</span></strong>
    assert_no_difference <span class="colork22">'Relationship.count'</span> <strong><span class="colork10">do</span></strong>
      delete relationship_path(relationships(:one))
    <strong><span class="colork10">end</span></strong>
    assert_redirected_to login_url
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">We can get the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex032">Listing 14.32</a> to pass by adding the <code><strong><span class="colork1">logged_in_user</span></strong></code> before filter (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex033">Listing 14.33</a>).</p>
<p class="ex-title" id="ch14ex033"><strong>Listing 14.33:</strong> Access control for relationships. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">app/controllers/relationships_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-33a" id="list14-33">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork8">class</span> <span class="colork4">RelationshipsController</span></strong> <span class="colork11">&lt; ApplicationController</span>
  before_action <span class="colork8">:logged_in_user</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">create</span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">destroy</span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">To get the ”Follow” and ”Unfollow” buttons to work, all we need to do is find the user associated with the <code><strong><span class="colork1">followed_id</span></strong></code> in the corresponding form (i.e., <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex022">Listing 14.22</a> or <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex023">Listing 14.23</a>), and then use the appropriate <code><strong><span class="colork1">follow</span></strong></code> or <code><strong><span class="colork1">unfollow</span></strong></code> method from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex010">Listing 14.10</a>. The full implementation appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex034">Listing 14.34</a>.</p>
<p class="ex-title" id="ch14ex034"><strong>Listing 14.34:</strong> The Relationships controller. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">app/controllers/relationships_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-34a" id="list14-34">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork8">class</span> <span class="colork4">RelationshipsController</span></strong> <span class="colork11">&lt; ApplicationController</span>
  before_action <span class="colork8">:logged_in_user</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">create</span>
<span class="mark">    user = User.find(params[:<span class="colork8">followed_id</span>])</span>
<span class="mark">    current_user.follow(user)</span>
<span class="mark">    redirect_to user</span>
<span epub:type="pagebreak" id="page_759"></span>  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">destroy</span>
<span class="mark">    user <span class="colork22">= Relationship</span>.find(params[:id]).followed</span>
<span class="mark">    current_user.unfollow(user)</span>
<span class="mark">    redirect_to user</span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">We can see from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex034">Listing 14.34</a> why the security issue mentioned earlier is minor: If an unlogged-in user were to hit either action directly (e.g., using a command-line tool like <code><strong><span class="colork1">curl</span></strong></code>), <code><strong><span class="colork1">current_user</span></strong></code> would be <code><strong><span class="colork1">nil</span></strong></code>, and in both cases the action’s second line would raise an exception, resulting in an error but no harm to the application or its data. It’s best not to rely on that behavior, though, so we’ve taken the extra step and added another layer of security.</p>
<p class="indent">With that, the core follow/unfollow functionality is complete, and any user can follow or unfollow any other user, as you can verify by clicking the corresponding buttons in your browser. (We’ll write integration tests to verify this behavior in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2_6">Section 14.2.6</a>.) The result of following user #2 is shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig019">Figure 14.19</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig020">Figure 14.20</a>.</p>
<figure id="ch14fig019" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_19.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_19.jpg">
<figcaption><p><strong>Figure 14.19:</strong> An unfollowed user.</p></figcaption>
</figure>
<figure id="ch14fig020" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_20.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_20.jpg">
<figcaption><p><strong>Figure 14.20:</strong> The result of following an unfollowed user.</p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev178">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Follow and unfollow /users/2 through the web. Did it work?</p></li>
<li><p class="num">According to the server log, which templates are rendered in each case?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_2_5">14.2.5 A Working Follow Button with Ajax</h4>
<p class="noindent">Although our user following implementation is complete as it stands, we have one bit of polish left to add before starting work on the status feed. You may have noticed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_2_4">Section 14.2.4</a> that both the <code><strong><span class="colork1">create</span></strong></code> and <code><strong><span class="colork1">destroy</span></strong></code> actions in the Relationships controller simply redirect <em>back</em> to the original profile. In other words, a user starts on another user’s profile page, follows the other user, and is immediately redirected back to the original page. It is reasonable to ask why the user needs to leave that page at all.<span epub:type="pagebreak" id="page_760"></span></p>
<p class="indent">This is exactly the problem solved by Ajax, which allows web pages to send requests asynchronously to the server without leaving the page.<sup><a id="ch14fn9a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn9" class="totri-footnote">9</a></sup> Because adding Ajax to web forms is a common practice, Rails makes Ajax easy to implement. Indeed, updating the follow/unfollow form partials is trivial: Just change</p>
<p class="footnote"><a id="ch14fn9" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn9a" class="totri-footnote">9</a>. Because it is nominally an acronym for <em>asynchronous JavaScript and XML</em>, Ajax is sometimes misspelled “AJAX,” even though the original Ajax article spells it as “Ajax” throughout.</p>
<pre class="pre1">form_with(<span class="colork8">model</span>: ..., <span class="colork4">local</span>: <strong><span class="colork10">true</span></strong>)</pre>
<p class="noindent">to</p>
<pre class="pre1">form_with(<span class="colork8">model</span>: ..., <span class="colork4">remote</span>: <strong><span class="colork10">true</span></strong>)</pre>
<p class="noindent"><span epub:type="pagebreak" id="page_761"></span>and Rails automagically uses Ajax.<sup><a id="ch14fn10a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn10">10</a></sup> The updated partials appear in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex035">Listing 14.35</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex036">Listing 14.36</a>.</p>
<p class="footnote"><a id="ch14fn10" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn10a">10</a>. In fact, the default behavior for <code><strong><span class="colork1">form_with</span></strong></code> is to make remote submissions, but at least when starting out I prefer to be explicit.</p>
<p class="ex-title" id="ch14ex035"><strong>Listing 14.35:</strong> A form for following a user using Ajax.</p>
<pre class="pre2">app/views/users/_follow.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-35a" id="list14-35">Click here to view code image</a></p>
<div class="example">
<pre><span class="mark"><span class="colork22">&lt;%=</span> form_for(model: current_user.active_relationships.build, <span class="colork8">remote</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> <span class="colork8">|</span>f<span class="colork8">|</span> <span class="colork22">%&gt;</span></span>
  &lt;<strong><span class="colork10">div</span></strong>&gt;<span class="colork22">&lt;%=</span> hidden_field_tag :<span class="colork8">followed_id</span>, <span class="colork8">@user.id</span> <span class="colork22">%&gt;</span>&lt;/<strong><span class="colork10">div</span></strong>&gt;
  <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Follow"</span>, class: <span class="colork22">"btn btn-primary" %&gt;</span>
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span></pre>
</div>
<p class="ex-title" id="ch14ex036"><span epub:type="pagebreak" id="page_762"></span><strong>Listing 14.36:</strong> A form for unfollowing a user using Ajax.</p>
<pre class="pre2">app/views/users/_unfollow.html.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-36a" id="list14-36">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork22">&lt;%=</span> form_with(model: current_user.active_relationships.find_by(<span class="colork8">followed_id</span>: <span class="colork8">@user.id</span>),
<span class="mark">             html: { method: <span class="colork8">:delete</span> }, <span class="colork8">remote</span>: <strong><span class="colork10">true</span></strong>) <strong><span class="colork10">do</span></strong> |f| <span class="colork22">%&gt;</span></span>
  <span class="colork22">&lt;%=</span> f.submit <span class="colork22">"Unfollow"</span>, <span class="colork8">class</span>: <span class="colork22">"btn" %&gt;</span>
<span class="colork22">&lt;%</span> <strong><span class="colork10">end</span></strong> <span class="colork22">%&gt;</span></pre>
</div>
<p class="indent">The actual HTML generated by this ERb isn’t particularly relevant, but you might be curious, so here’s a peek at a schematic view (details may differ):</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg762-01a" id="pg762-01">Click here to view code image</a></p>
<pre class="pre1">&lt;<strong><span class="colork10">form</span></strong> <span class="colork27">action="/relationships/117" class="edit_relationship" data-remote="true"</span>
      <span class="colork27">id="edit_relationship_117" method="post"</span>&gt;
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
&lt;/<strong><span class="colork10">form</span></strong>&gt;</pre>
<p class="noindent">This sets the variable <code><strong><span class="colork1">data-remote="true"</span></strong></code> inside the form tag, which tells Rails to allow the form to be handled by JavaScript. By using a simple HTML property instead of inserting the full JavaScript code (as in previous versions of Rails), Rails follows the philosophy of <em>unobtrusive JavaScript</em>.</p>
<p class="indent">Having updated the form, we now need to arrange for the Relationships controller to respond to Ajax requests. We can do this using the <code><strong><span class="colork1">respond_to</span></strong></code> method, responding appropriately depending on the type of request. The general pattern looks like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg762-02a" id="pg762-02">Click here to view code image</a></p>
<pre class="pre1">respond_to <strong><span class="colork10">do</span></strong> <span class="colork27">|format|</span>
  <span class="colork27">format.</span>html { redirect_to user }
  <span class="colork27">format.</span>js
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">This syntax is potentially confusing, and it’s important to understand that only <em>one</em> of the lines gets executed. (In this sense, <code><strong><span class="colork1">respond_to</span></strong></code> is more like an if-then-else statement than a series of sequential lines.) Adapting the Relationships controller to respond to Ajax involves adding <code><strong><span class="colork1">respond_to</span></strong></code> as in the preceding code to the <code><strong><span class="colork1">create</span></strong></code> and <code><strong><span class="colork1">destroy</span></strong></code> actions from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex034">Listing 14.34</a>. The result appears as in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex037">Listing 14.37</a>. Note the change from the local variable <code><strong><span class="colork1">user</span></strong></code> to the instance variable <code><strong><span class="colork1">@user</span></strong></code>; in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex034">Listing 14.34</a> <span epub:type="pagebreak" id="page_763"></span>there was no need for an instance variable, but now such a variable is necessary in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex035">Listing 14.35</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex036">Listing 14.36</a>.</p>
<p class="ex-title" id="ch14ex037"><strong>Listing 14.37:</strong> Responding to Ajax requests in the Relationships controller.</p>
<pre class="pre2">app/controllers/relationships_controller.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-37a" id="list14-37">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">RelationshipsController</span></strong> <span class="colork11">&lt; ApplicationController</span>
  before_action <span class="colork8">:logged_in_user</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">create</span>
    <span class="colork8">@user = User.</span>find(params<span class="colork8">[:followed_id]</span>)
    current_user.follow(<span class="colork8">@user</span>)
<span class="mark">    respond_to <strong><span class="colork10">do</span></strong> <span class="colork23">|format|</span></span>
<span class="mark">      <span class="colork23">format</span>.html { redirect_to <span class="colork8">@user</span> }</span>
<span class="mark">      <span class="colork23">format</span>.js</span>
<span class="mark">    <strong><span class="colork10">end</span></strong></span>
  <strong><span class="colork10">end</span></strong>

  <strong><span class="colork10">def</span></strong> <span class="colork4">destroy</span>
    <span class="colork8">@user</span> <span class="colork22">= Relationship</span>.find(params[:<span class="colork8">id</span>]).followed
    current_user.unfollow(<span class="colork8">@user</span>)
<span class="mark">    respond_to <strong><span class="colork10">do</span></strong> <span class="colork23">|format|</span></span>
<span class="mark">      <span class="colork22">format</span>.html { redirect_to <span class="colork8">@user</span> }</span>
<span class="mark">      <span class="colork22">format</span>.js</span>
<span class="mark">    <strong><span class="colork10">end</span></strong></span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">The actions in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex037">Listing 14.37</a> degrade gracefully, which means that they work fine in browsers that have JavaScript disabled (although a small amount of configuration is necessary, as shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex038">Listing 14.38</a>).</p>
<p class="ex-title" id="ch14ex038"><strong>Listing 14.38:</strong> Configuration needed for graceful degradation of form submission.</p>
<pre class="pre2">config/application.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-38a" id="list14-38">Click here to view code image</a></p>
<div class="example">
<pre>require_relative <span class="colork22">'boot'</span>
<span class="colork9">.</span>
<span class="colork9">.</span>
<span class="colork9">.</span>
<strong><span class="colork10">module</span> <span class="colork4">SampleApp</span></strong>
  <strong><span class="colork10">class</span> <span class="colork4">Application</span></strong> <span class="colork11">&lt; Rails::Application</span>
    <span class="colork9">.</span>
<span epub:type="pagebreak" id="page_764"></span>    <span class="colork9">.</span>
    <span class="colork9">.</span>
<span class="mark">    <span class="grayk1"># Include the authenticity token in remote forms.</span></span>
<span class="mark">    config.action_view.embed_authenticity_token_in_remote_forms = <strong><span class="colork15">true</span></strong></span>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">We have yet to respond properly when JavaScript is enabled, though. In the case of an Ajax request, Rails automatically calls a <em>JavaScript embedded Ruby</em> (<code><strong><span class="colork1">.js.erb</span></strong></code>) file with the same name as the action—that is, <code><strong><span class="colork1">create.js.erb</span></strong></code> or <code><strong><span class="colork1">destroy.js.erb</span></strong></code>. As you might guess, such files allow us to mix JavaScript and embedded Ruby to perform actions on the current page. It is these files that we need to create and edit to update the user profile page upon being followed or unfollowed.</p>
<p class="indent">Inside a JS-ERb file, Rails automatically provides the jQuery JavaScript helpers needed to manipulate the page using the Document Object Model (DOM). The jQuery library (which we saw briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_4_2">Section 13.4.2</a>) provides a large number of methods for manipulating the DOM, but here we will need only two. First, we will need to know about the dollar-sign syntax to access a DOM element based on its unique CSS id. For example, to manipulate the <code><strong><span class="colork1">follow_form</span></strong></code> element, we will use the syntax</p>
<pre class="pre1">$(<span class="colork22">"#follow_form"</span>)</pre>
<p class="noindent">(Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex020">Listing 14.20</a> that this is a <code><strong><span class="colork1">div</span></strong></code> that wraps the form, not the form itself.) This syntax, inspired by CSS, uses the <code><strong><span class="colork1">#</span></strong></code> symbol to indicate a CSS id. As you might guess, jQuery, like CSS, uses a dot <code><strong><span class="colork1">.</span></strong></code> to manipulate CSS classes.</p>
<p class="indent">The second method we’ll need is <code><strong><span class="colork1">html</span></strong></code>, which updates the HTML inside the relevant element with the contents of its argument. For example, to replace the entire follow form with the string <code><strong><span class="colork1">"foobar"</span></strong></code>, we would write</p>
<pre class="pre1">$(<span class="colork22">"#follow_form"</span>).html(<span class="colork22">"foobar"</span>)</pre>
<p class="indent">Unlike plain JavaScript files, JS-ERb files also allow the use of embedded Ruby, which we apply in the <code><strong><span class="colork1">create.js.erb</span></strong></code> file to update the follow form with the <code><strong><span class="colork1">unfollow</span></strong></code> partial (which is what should be displayed after a successful following) and update the follower count. The result is shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex039">Listing 14.39</a>. This uses the <span epub:type="pagebreak" id="page_765"></span><code><strong><span class="colork1">escape_javascript</span></strong></code> method, which is needed to escape out the result when inserting HTML in a JavaScript file.</p>
<p class="ex-title" id="ch14ex039"><strong>Listing 14.39:</strong> The JavaScript embedded Ruby to create a following relationship.</p>
<pre class="pre2">app/views/relationships/create.js.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#lis14-39a" id="lis14-39">Click here to view code image</a></p>
<div class="example">
<pre>$(<span class="colork22">"#follow_form"</span>).html(<span class="colork22">"&lt;%= escape_javascript(render('users/unfollow')) %&gt;"</span>);
$(<span class="colork22">"#followers"</span>).html(<span class="colork22">'&lt;%= @user.followers.count %&gt;'</span>);</pre>
</div>
<p class="noindent">Note the presence of line-ending semicolons, which are characteristic of languages with syntax descended from ALGOL.</p>
<p class="indent">The <code><strong><span class="colork1">destroy.js.erb</span></strong></code> file is analogous (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex040">Listing 14.40</a>).</p>
<p class="ex-title" id="ch14ex040"><strong>Listing 14.40:</strong> The Ruby JavaScript (RJS) to destroy a following relationship.</p>
<pre class="pre2">app/views/relationships/destroy.js.erb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#lis14-40a" id="lis14-40">Click here to view code image</a></p>
<div class="example">
<pre>$(<span class="colork22">"#follow_form"</span>).html(<span class="colork22">"&lt;%= escape_javascript(render('users/follow')) %&gt;"</span>);
$(<span class="colork22">"#followers"</span>).html(<span class="colork22">'&lt;%= @user.followers.count %&gt;'</span>);</pre>
</div>
<p class="noindent">With that, you should navigate to a user profile page and verify that you can follow and unfollow without a page refresh.</p>
<section>
<h5 class="h5" id="lev179">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Unfollow and refollow /users/2 through the web. Did it work?</p></li>
<li><p class="num">According to the server log, which templates are rendered in each case?</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_2_6">14.2.6 Following Tests</h4>
<p class="noindent">Now that the follow buttons are working, we’ll write some simple tests to prevent regressions. To follow a user, we post to the relationships path and verify that the number of followed users increases by 1:<span epub:type="pagebreak" id="page_766"></span></p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg766-01a" id="pg766-01">Click here to view code image</a></p>
<pre class="pre1">assert_difference <span class="colork22">'@user.following.count'</span>, 1 <strong>do</strong>
  post relationships_path, params: { <span class="colork8">followed_id</span>: <span class="colork8">@other.</span>id }
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">This tests the standard implementation, but testing the Ajax version is almost exactly the same; the only difference is the addition of the option <code><strong><span class="colork1">xhr: true</span></strong></code>:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg766-02a" id="pg766-02">Click here to view code image</a></p>
<pre class="pre1">assert_difference <span class="colork22">'@user.following.count'</span>, 1 <strong>do</strong>
  post relationships_path, <span class="colork8">params</span>: { <span class="colork8">followed_id</span>: <span class="colork8">@other.</span>id }, <span class="colork8">xhr</span>: <strong><span class="colork10">true</span></strong>
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">Here <code><strong><span class="colork1">xhr</span></strong></code> stands for XmlHttpRequest; setting the <code><strong><span class="colork1">xhr</span></strong></code> option to <code><strong><span class="colork1">true</span></strong></code> issues an Ajax request in the test, which causes the <code><strong><span class="colork1">respond_to</span></strong></code> block in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex037">Listing 14.37</a> to execute the proper JavaScript method.</p>
<p class="indent">A parallel structure applies to deleting users, with <code><strong><span class="colork1">delete</span></strong></code> instead of <code><strong><span class="colork1">post</span></strong></code>. Here we check that the followed user count goes down by 1 and include the relationship and followed user’s id:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg766-03a" id="pg766-03">Click here to view code image</a></p>
<pre class="pre1">assert_difference <span class="colork22">'@user.following.count'</span>, <span class="colork22">-1</span> <strong><span class="colork10">do</span></strong>
  delete relationship_path(relationship)
<strong><span class="colork10">end</span></strong></pre>
<p class="noindent">and</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg766-04a" id="pg766-04">Click here to view code image</a></p>
<pre class="pre1">assert_difference <span class="colork22">'@user.following.count'</span>, <span class="colork22">-1</span> <strong><span class="colork10">do</span></strong>
  delete relationship_path(relationship), <span class="colork8">xhr</span>: <strong><span class="colork10">true</span></strong>
<strong><span class="colork10">end</span></strong></pre>
<p class="indent">Putting the two cases together gives the tests in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex041">Listing 14.41</a>.</p>
<p class="ex-title" id="ch14ex041"><strong>Listing 14.41:</strong> Tests for the follow/unfollow buttons. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">test/integration/following_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-41a" id="list14-41">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">FollowingTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
<span class="mark">    @other = users(:archer)</span>
<span epub:type="pagebreak" id="page_767"></span>    log_in_as(<span class="colork8">@user</span>)
  <strong><span class="colork10">end</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  test <span class="colork22">"should follow a user the standard way"</span> <strong><span class="colork10">do</span></strong>
    assert_difference <span class="colork22">'@user.following.count'</span>, 1 <strong><span class="colork10">do</span></strong>
      post relationships_path, params: { <span class="colork8">followed_id</span>: <span class="colork8">@other</span>.id }
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>

  test <span class="colork22">"should follow a user with Ajax"</span> <strong><span class="colork10">do</span></strong>
    assert_difference <span class="colork22">'@user.following.count'</span>, 1 <strong><span class="colork10">do</span></strong>
      post relationships_path, xhr: <strong><span class="colork10">true</span></strong>, <span class="colork8">params</span>: { <span class="colork8">followed_id</span>: <span class="colork8">@other.</span>id }
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>

  <span class="colork8">test</span> <span class="colork22">"should unfollow a user the standard way"</span> <strong><span class="colork10">do</span></strong>
    <span class="colork8">@user</span>.follow(<span class="colork8">@other</span>)
    relationship = <span class="colork8">@user</span>.active_relationships.find_by(<span class="colork8">followed_id</span>: <span class="colork8">@other</span>.id)
    assert_difference <span class="colork22">'@user.following.count'</span>, <span class="colork8">-1</span> <strong><span class="colork10">do</span></strong>
      delete relationship_path(relationship)
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>

  <span class="colork8">test</span> <span class="colork22">"should unfollow a user with Ajax"</span> <strong>do</strong>
    <span class="colork8">@user</span>.follow(<span class="colork8">@other</span>)
    relationship <span class="colork8">= @user.</span>active_relationships<span class="colork8">.</span>find_by(<span class="colork8">followed_id</span>: <span class="colork8">@other</span>.id)
    assert_difference <span class="colork22">'@user.following.count'</span>, <span class="colork8">-1</span> <strong><span class="colork10">do</span></strong>
      delete relationship_path(relationship), <span class="colork8">xhr</span>: <strong><span class="colork10">true</span></strong>
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">At this point, the tests should be <small><span class="colork14">GREEN</span></small>:</p>
<p class="ex-title" id="ch14ex042"><strong>Listing 14.42:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev180">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.<span epub:type="pagebreak" id="page_768"></span></p>
<ol class="num">
<li><p class="num">By commenting and uncommenting each of the lines in the <code><strong><span class="colork1">respond_to</span></strong></code> blocks (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex037">Listing 14.37</a>), verify that the tests are testing the right things. Which test fails in each case?</p></li>
<li><p class="num">What happens if you delete one of the occurrences of <code><strong><span class="colork1">xhr: true</span></strong></code> in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex041">Listing 14.41</a>? Explain why this is a problem, and why the procedure in the previous exercise would catch it.</p></li>
</ol>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec14_3">14.3 The Status Feed</h3>
<p class="noindent">We come now to the pinnacle of our sample application: the status feed of microposts. Appropriately, this section contains some of the most advanced material in the entire tutorial. The full status feed builds on the proto-feed from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_3">Section 13.3.3</a> by assembling an array of the microposts from the users being followed by the current user, along with the current user’s own microposts. Throughout this section, we’ll proceed through a series of feed implementations of increasing sophistication. To accomplish this, we will need some fairly advanced Rails, Ruby, and even SQL programming techniques.</p>
<p class="indent">Because of the heavy lifting ahead, it’s especially important to review where we’re going. A recap of the final status feed, shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig05">Figure 14.5</a>, appears again in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig021">Figure 14.21</a>.</p>
<figure id="ch14fig021" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_21.jpg" alt="Image" width="678" height="582" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_21.jpg">
<figcaption><p><strong>Figure 14.21:</strong> A mockup of a user’s Home page with a status feed.</p></figcaption>
</figure>
<section>
<h4 class="h4" id="sec14_3_1">14.3.1 Motivation and Strategy</h4>
<p class="noindent">The basic idea behind the feed is simple. <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig022">Figure 14.22</a> shows a sample <code><strong><span class="colork1">microposts</span></strong></code> database table and the resulting feed. The purpose of a feed is to pull out the microposts whose user ids correspond to the users being followed by the current user (and the current user itself), as indicated by the arrows in the diagram.</p>
<figure id="ch14fig022" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_22.jpg" alt="Image" width="677" height="318" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_22.jpg">
<figcaption><p><strong>Figure 14.22:</strong> The feed for a user (id 1) following users with ids 2, 7, 8, and 10.</p></figcaption>
</figure>
<p class="indent">Although we don’t yet know how to implement the feed, the tests are relatively straightforward, so (following the guidelines in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch03.xhtml#box3_3">Box 3.3</a>) we’ll write them first. The key is to check all three requirements for the feed: Microposts for both followed users and the user itself should be included in the feed, but a post from an <em>unfollowed</em> user should not be included.</p>
<p class="indent">As we’ll see in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex029">Listing 14.29</a>, we’ll be arranging for Michael to follow Lana but not Archer. Based on the fixtures in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch10.xhtml#ch10ex047">Listing 10.47</a> and <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex055">Listing 13.55</a>, this means that Michael should see Lana’s posts and his own posts, but not Archer’s posts. Converting these requirements to assertions and recalling that the <code><strong><span class="colork1">feed</span></strong></code> is in the User model (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex047">Listing 13.47</a>) gives the updated User model test shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex043">Listing 14.43</a>.<span epub:type="pagebreak" id="page_769"></span><span epub:type="pagebreak" id="page_770"></span></p>
<p class="ex-title" id="ch14ex043"><strong>Listing 14.43:</strong> A test for the status feed. <small><span class="redk1">RED</span></small></p>
<pre class="pre2">test/models/user_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-43a" id="list14-43">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork8">class</span> <span class="colork4">UserTest</span></strong> <span class="colork27">&lt; ActiveSupport::TestCase</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork8">test</span> <span class="colork22">"feed should have the right posts"</span> <strong><span class="colork10">do</span></strong>
    michael = users(<span class="colork8">:michael</span>)
    archer = users(<span class="colork8">:archer</span>)
    lana = users(<span class="colork8">:lana</span>)
    <span class="colork18"># Posts from followed user</span>
    lana.microposts.each <strong><span class="colork10">do</span></strong> <span class="colork9">|</span>post_following<span class="colork9">|</span>
      assert michael<span class="colork9">.</span>feed<span class="colork9">.</span>include?(post_following)
    <strong><span class="colork10">end</span></strong>
    <span class="colork18"># Posts from self</span>
    michael.microposts.each <strong><span class="colork10">do</span></strong> <span class="colork9">|</span>post_self<span class="colork9">|</span>
      assert michael<span class="colork9">.</span>feed<span class="colork9">.</span>include?(post_self)
    <strong><span class="colork10">end</span></strong>
    <span class="colork18"># Posts from unfollowed user</span>
    archer.microposts.each <strong><span class="colork10">do</span></strong> <span class="colork9">|</span>post_unfollowed<span class="colork9">|</span>
      assert_not michael<span class="colork9">.</span>feed<span class="colork9">.</span>include?(post_unfollowed)
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">Of course, the current implementation is just a proto-feed, so the new test is initially <small><span class="redk1">RED</span></small>:</p>
<p class="ex-title" id="ch14ex044"><strong>Listing 14.44:</strong> <small><span class="redk1">RED</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<section>
<h5 class="h5" id="lev181">Exercise</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.<span epub:type="pagebreak" id="page_771"></span></p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Assuming the micropost’s ids are numbered sequentially, with larger numbers being more recent, what would <code><strong><span class="colork1">user.feed.map(&amp;:id)</span></strong></code> return for the feed shown in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig022">Figure 14.22</a>? <em>Hint</em>: Recall the default scope from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_1_4">Section 13.1.4</a>.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_3_2">14.3.2 A First Feed Implementation</h4>
<p class="noindent">With the status feed design requirements captured in the test from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex043">Listing 14.43</a>, we’re ready to start writing the feed. Since the final feed implementation is rather intricate, we’ll build up to it by introducing one piece at a time. The first step is to think of the kind of query we’ll need. We need to select all the microposts from the <code><strong><span class="colork1">microposts</span></strong></code> table with ids corresponding to the users being followed by a given user (or the user itself). We might write this schematically as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg771-01a" id="pg771-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork10">SELECT</span></strong> * <strong><span class="colork10">FROM</span></strong> microposts
<strong><span class="colork10">WHERE</span></strong> user_id <strong><span class="colork10">IN</span></strong> (&lt;list <strong><span class="colork10">of</span></strong> ids&gt;) <strong><span class="colork10">OR</span></strong> user_id = &lt;<strong><span class="colork10">user</span></strong> id&gt;</pre>
<p class="noindent">In writing this code, we’ve guessed that SQL supports an <code><strong><span class="colork1">IN</span></strong></code> keyword that allows us to test for set inclusion. (Happily, it does.)</p>
<p class="indent">Recall from the proto-feed in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_3">Section 13.3.3</a> that Active Record uses the <code><strong><span class="colork1">where</span></strong></code> method to accomplish the kind of select shown here, as illustrated in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13ex047">Listing 13.47</a>. In that listing, our select was very simple—we just picked out all the microposts with a user id corresponding to the current user:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg771-02a" id="pg771-02">Click here to view code image</a></p>
<pre class="pre1"><span class="colork22">Micropost</span>.where(<span class="colork22">"user_id = ?"</span>, <span class="colork22">id</span>)</pre>
<p class="noindent">Here, we expect the select to be more complicated, something like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg771-03a" id="pg771-03">Click here to view code image</a></p>
<pre class="pre1"><span class="colork22">Micropost</span>.where(<span class="colork22">"user_id IN (?) OR user_id = ?"</span>, following_ids, <span class="colork8">id</span>)</pre>
<p class="indent">We see from these conditions that we’ll need an array of ids corresponding to the users being followed. One way to do this is to use Ruby’s <code><strong><span class="colork1">map</span></strong></code> method, available on any “enumerable” object—that is, any object (such as an array or a hash) that consists <span epub:type="pagebreak" id="page_772"></span>of a collection of elements.<sup><a id="ch14fn11a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn11">11</a></sup> We saw an example of this method in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_2">Section 4.3.2</a>; as another example, we’ll use <code><strong><span class="colork1">map</span></strong></code> to convert an array of integers to an array of strings:</p>
<p class="footnote"><a id="ch14fn11" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn11a">11</a>. The main requirement is that enumerable objects must implement an <code><strong><span class="colork1">each</span></strong></code> method to iterate through the collection.</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg772-01a" id="pg772-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork1">$ rails console</span>
<strong><span class="colork4">&gt;&gt;</span></strong> <span class="colork9">[1</span>, <span class="colork9">2</span>, <span class="colork9">3</span>, <span class="colork9">4</span>].map { <span class="colork9">|</span>i<span class="colork9">|</span> i<span class="colork9">.</span>to_s }
<span class="colork1">=&gt; ["1", "2", "3", "4"]</span></pre>
<p class="noindent">Situations like the one illustrated here, in which the same method gets called on each element in the collection, are common enough that there’s a shorthand notation for it (seen briefly in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_2">Section 4.3.2</a>). This uses an <em>ampersand</em> <code><strong><span class="colork1">&amp;</span></strong></code> and a symbol corresponding to the method:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg772-02a" id="pg772-02">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork4">&gt;&gt;</span></strong> <span class="colork9">[1</span>, <span class="colork9">2</span>, <span class="colork9">3</span>, <span class="colork9">4</span>].map(<span class="colork9">&amp;:to_s</span>)
<span class="colork1">=&gt; ["1", "2", "3", "4"]</span></pre>
<p class="noindent">Using the <code><strong><span class="colork1">join</span></strong></code> method (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch04.xhtml#sec4_3_1">Section 4.3.1</a>), we can create a string composed of the ids by joining them on comma-space:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg772-03a" id="pg772-03">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork4">&gt;&gt;</span></strong> <span class="colork9">[1</span>, <span class="colork9">2</span>, <span class="colork9">3</span>, <span class="colork9">4].</span>map(<span class="colork9">&amp;:to_s</span>).join(<span class="colork9">', '</span>)
<span class="colork1">=&gt; "1, 2, 3, 4"</span></pre>
<p class="indent">We can use this method to construct the necessary array of followed user ids by calling <code><strong><span class="colork1">id</span></strong></code> on each element in <code><strong><span class="colork1">user.following</span></strong></code>. For example, for the first user in the database this array appears as follows:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg772-04a" id="pg772-04">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork4">&gt;&gt;</span></strong> <span class="colork1">User</span>.first.following.map(<span class="colork1">&amp;:id</span>)
<span class="colork1">=&gt; [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,</span>
<span class="colork1">23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,</span>
<span class="colork1">42, 43, 44, 45, 46, 47, 48, 49, 50, 51]</span></pre>
<p class="noindent">In fact, because this sort of construction is so useful, Active Record provides it by default:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg772-05a" id="pg772-05">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork4">&gt;&gt;</span></strong> <span class="colork1">User</span><span class="colork9">.</span>first<span class="colork9">.</span>following_ids
<span class="colork1">=&gt; [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,</span>
<span class="colork9"><span epub:type="pagebreak" id="page_773"></span>23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,</span>
<span class="colork1">42, 43, 44, 45, 46, 47, 48, 49, 50, 51]</span></pre>
<p class="noindent">Here the <code><strong><span class="colork1">following_ids</span></strong></code> method is synthesized by Active Record based on the <code><strong><span class="colork1">has_many :following</span></strong></code> association (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex08">Listing 14.8</a>); the result is that we need to just append <code><strong><span class="colork1">_ids</span></strong></code> to the association name to get the ids corresponding to the <code><strong><span class="colork1">user.following</span></strong></code> collection. A string of followed user ids then appears as shown here:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg773-01a" id="pg773-01">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork4">&gt;&gt;</span></strong> <span class="colork1">User</span><span class="colork9">.</span>first<span class="colork9">.</span>following_ids<span class="colork9">.</span>join(<span class="colork1">', '</span>)
<span class="colork1">=&gt; "3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,</span>
<span class="colork1">23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,</span>
<span class="colork1">42, 43, 44, 45, 46, 47, 48, 49, 50, 51"</span></pre>
<p class="indent">When inserting into an SQL string, though, you don’t need to do this; the <code><strong><span class="colork1">?</span></strong></code> interpolation takes care of it for you (and in fact eliminates some database-dependent incompatibilities). This means we can use <code><strong><span class="colork1">following_ids</span></strong></code> by itself. As a result, the initial guess of</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg773-02a" id="pg773-02">Click here to view code image</a></p>
<pre class="pre1"><span class="colork1">Micropost</span>.where(<span class="colork1">"user_id IN (?) OR user_id = ?"</span>, following_ids, <span class="colork1">id</span>)</pre>
<p class="noindent">actually works! The result appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex045">Listing 14.45</a>.</p>
<p class="ex-title" id="ch14ex045"><strong>Listing 14.45:</strong> The initial working feed. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-45a" id="list14-45">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork18"># Returns true if a password reset has expired.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">password_reset_expired?</span>
    reset_sent_at &lt; 2<span class="colork9">.</span>hours<span class="colork9">.</span>ago
  <strong><span class="colork10">end</span></strong>

  <span class="colork18"># Returns a user's status feed.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">feed</span>
<span class="mark">    <span class="colork22">Micropost</span>.where(<span class="colork22">"user_id IN (?) OR user_id = ?"</span>, following_ids, <span class="colork1">id</span>)</span>
  <strong><span class="colork10">end</span></strong>

  <span class="colork18"># Follows a user.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">follow</span>(other_user)
<span epub:type="pagebreak" id="page_774"></span>    following <span class="colork8">&lt;&lt;</span> other_user
  <strong><span class="colork10">end</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="indent">The test suite should be <small><span class="colork14">GREEN</span></small>:</p>
<p class="ex-title" id="ch14ex046"><strong>Listing 14.46:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">In some applications, this initial implementation might be good enough for most practical purposes, but <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex045">Listing 14.45</a> isn’t the final implementation. See if you can make a guess about why not before moving on to the next section. (<em>Hint</em>: What if a user is following 5,000 other users?)</p>
<section>
<h5 class="h5" id="lev182">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex045">Listing 14.45</a>, remove the part of the query that finds the user’s own posts. Which test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex043">Listing 14.43</a> breaks?</p></li>
<li><p class="num">In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex045">Listing 14.45</a>, remove the part of the query that finds the followed users’ posts. Which test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex043">Listing 14.43</a> breaks?</p></li>
<li><p class="num">How could you change the query in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex045">Listing 14.45</a> to have the feed erroneously return microposts of unfollowed users, thereby breaking the third test in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex043">Listing 14.43</a>? <em>Hint</em>: Returning all the microposts would do the trick.</p></li>
</ol></section>
</section>
<section>
<h4 class="h4" id="sec14_3_3">14.3.3 Subselects</h4>
<p class="noindent">As hinted at in the last section, the feed implementation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_3_2">Section 14.3.2</a> doesn’t scale well when the number of microposts in the feed is large, as would likely happen if a user were following, say, 5,000 other users. In this section, we’ll reimplement the status feed in a way that scales better with the number of followed users.<span epub:type="pagebreak" id="page_775"></span></p>
<p class="indent">The problem with the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#sec14_3_2">Section 14.3.2</a> is that <code><strong><span class="colork1">following_ids</span></strong></code> pulls <em>all</em> the followed users’ ids into memory, and creates an array the full length of the followed users array. Since the condition in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex045">Listing 14.45</a> actually just checks inclusion in a set, there must be a more efficient way to do this, and indeed SQL is optimized for just such set operations. The solution involves pushing the finding of followed user ids into the database using a <em>subselect</em>.</p>
<p class="indent">We’ll start by refactoring the feed with the slightly modified code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex047">Listing 14.47</a>.</p>
<p class="ex-title" id="ch14ex047"><strong>Listing 14.47:</strong> Using key-value pairs in the feed’s <code><strong><span class="colork1">where</span></strong></code> method. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-47a" id="list14-47">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork18"># Returns a user's status feed.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">feed</span>
<span class="mark">    <span class="colork22">Micropost.</span>where(<span class="colork22">"user_id IN (:following_ids) OR user_id = :user_id"</span>,</span>
<span class="mark">                    <span class="colork8">following_ids</span>: following_ids, user_id: <span class="colork22">id</span>)</span>
  <strong><span class="colork10">end</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent">As preparation for the next step, we have replaced</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg775-01a" id="pg775-01">Click here to view code image</a></p>
<pre class="pre1"><span class="colork1">Micropost.</span>where(<span class="colork22">"user_id IN (?) OR user_id = ?"</span>, following_ids, <span class="colork1">id</span>)</pre>
<p class="indent">with the equivalent</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg775-02a" id="pg775-02">Click here to view code image</a></p>
<pre class="pre1"><span class="colork22">Micropost.</span>where(<span class="colork22">"user_id IN (:following_ids) OR user_id = :user_id"</span>,
                <span class="colork8">following_ids</span>: following_ids, <span class="colork8">user_id</span>: <span class="colork8">id</span>)</pre>
<p class="noindent">The question-mark syntax is fine, but when we want the <em>same</em> variable inserted in more than one place, the second syntax is more convenient.</p>
<p class="indent">The preceding discussion implies that we will be adding a <em>second</em> occurrence of <code><strong><span class="colork1">user_id</span></strong></code> in the SQL query. In particular, we can replace the Ruby code<span epub:type="pagebreak" id="page_776"></span></p>
<pre class="pre1">following_ids</pre>
<p class="noindent">with the SQL snippet</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg776-01a" id="pg776-01">Click here to view code image</a></p>
<pre class="pre1">following_ids <span class="colork1">= "SELECT followed_id FROM relationships</span>
                 <span class="colork1">WHERE follower_id = :user_id"</span></pre>
<p class="noindent">This code contains an SQL subselect, and internally the entire select for user 1 would look something like this:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg776-02a" id="pg776-02">Click here to view code image</a></p>
<pre class="pre1"><strong><span class="colork10">SELECT</span></strong> * <strong><span class="colork10">FROM</span></strong> microposts
<strong><span class="colork10">WHERE</span></strong> user_id <strong><span class="colork10">IN</span></strong> (<strong><span class="colork10">SELECT</span></strong> followed_id <strong><span class="colork10">FROM</span></strong> relationships
                  <strong><span class="colork10">WHERE</span></strong> follower_id <span class="colork22">= 1</span>)
      <strong><span class="colork10">OR</span></strong> user_id <span class="colork22">= 1</span></pre>
<p class="noindent">This subselect arranges for all the set logic to be pushed into the database, which is more efficient.</p>
<p class="indent">With this foundation, we are ready for a more efficient feed implementation, as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex048">Listing 14.48</a>. Note that, because it is now raw SQL, the <code><strong><span class="colork1">following_ids</span></strong></code> string is <em>interpolated</em>, not escaped.</p>
<p class="ex-title" id="ch14ex048"><strong>Listing 14.48:</strong> The final implementation of the feed. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-48a" id="list14-48">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork18"># Returns a user's status feed.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">feed</span>
    following_ids <span class="colork1">= "SELECT followed_id FROM relationships</span>
                     <span class="colork1">WHERE follower_id = :user_id"</span>
    <span class="colork1">Micropost.</span>where(<span class="colork1">"user_id IN</span> (<strong><span class="grayk1">#{</span></strong>following_ids<strong><span class="grayk1">}</span></strong>)
                     O<span class="colork1">R user_id = :user_id"</span>, <span class="colork8">user_id</span>: <span class="colork8">id</span>)
  <strong><span class="colork10">end</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="noindent"><span epub:type="pagebreak" id="page_777"></span>This code contains a formidable combination of Rails, Ruby, and SQL, but it does the job, and does it well:</p>
<p class="ex-title" id="ch14ex049"><strong>Listing 14.49:</strong> <small><span class="colork14">GREEN</span></small></p>
<div class="example">
<pre>$ rails test</pre>
</div>
<p class="indent">Of course, even the subselect won’t scale forever. For bigger sites, you would probably need to generate the feed asynchronously using a background job, but such scaling subtleties are beyond the scope of this tutorial.</p>
<p class="indent">With the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex048">Listing 14.48</a>, our status feed is now complete. Recall from <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#sec13_3_3">Section 13.3.3</a> that the Home page already includes the feed. In <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13">Chapter 13</a>, the result was only a proto-feed (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml#ch13fig014">Figure 13.14</a>), but with the implementation in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex048">Listing 14.48</a> as seen in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig023">Figure 14.23</a> the Home page now shows the full feed.</p>
<figure id="ch14fig023" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_23.jpg" alt="Image" width="677" height="521" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_23.jpg">
<figcaption><p><strong>Figure 14.23:</strong> The Home page with a working status feed.</p></figcaption>
</figure>
<p class="indent"><span epub:type="pagebreak" id="page_778"></span>At this point, we’re ready to merge our changes into the master branch:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg778-01a" id="pg778-01">Click here to view code image</a></p>
<pre class="pre1">$ rails test
$ git add -A
$ git commit -m "Add user following"
$ git checkout master
$ git merge following-users</pre>
<p class="noindent">We can then push the code to the remote repository and deploy the application to production:</p>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#pg778-02a" id="pg778-02">Click here to view code image</a></p>
<pre class="pre1">$ git push
$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rails db:migrate
$ heroku run rails db:seed</pre>
<p class="noindent">The result is a working status feed on the live web (<a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fig024">Figure 14.24</a>).</p>
<figure id="ch14fig024" class="image-l">
<img src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/fig14_24.jpg" alt="Image" width="677" height="523" data-mfp-src="/library/view/ruby-on-rails/9780136702726/graphics/fig14_24.jpg">
<figcaption><p><strong>Figure 14.24:</strong> A working status feed on the live web.<span epub:type="pagebreak" id="page_779"></span></p></figcaption>
</figure>
<section>
<h5 class="h5" id="lev183">Exercises</h5>
<p class="noindent">Solutions to the exercises are available to all Rails Tutorial purchasers at <a href="https://www.railstutorial.org/aw-solutions">https://www.railstutorial.org/aw-solutions</a>.</p>
<p class="indent">To see other people’s answers and to record your own, subscribe to the Rails Tutorial course or to the Learn Enough All Access Bundle.</p>
<ol class="num">
<li><p class="num">Write an integration test to verify that the first page of the feed appears on the Home page as required. A template appears in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex050">Listing 14.50</a>.</p></li>
<li><p class="num">Note that <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex050">Listing 14.50</a> escapes the expected HTML using <code><strong><span class="colork1">CGI.escapeHTML</span></strong></code> (which is closely related to the <code><strong><span class="colork1">CGI.escape</span></strong></code> method we used in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch11.xhtml#sec11_2_3">Section 11.2.3</a> to escape URLs). Why is escaping the HTML necessary in this case? <em>Hint</em>: Try removing the escaping and carefully inspect the page source for the micropost content that doesn’t match. Using the search feature of your terminal shell (Cmd-F or Ctrl-F on most systems) to find the word “sorry” may prove particularly helpful.</p></li>
<li><p class="num">The code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex048">Listing 14.48</a> can be expressed directly in Rails using an <em>inner join</em> using the <code><strong><span class="colork1">join</span></strong></code> method. By running the tests, show that the code in <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14ex051">Listing 14.51</a> returns a valid feed.<sup><a id="ch14fn12a" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn12">12</a></sup> What is the SQL query generated by this code? (<em>Hint</em>: Run <code><strong><span class="colork1">User.first.feed</span></strong></code> in the console.)</p></li>
</ol>
<p class="footnote"><a id="ch14fn12" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#ch14fn12a">12</a>. Thanks to reader Anna for suggesting this version.</p>
<p class="ex-title" id="ch14ex050"><strong>Listing 14.50:</strong> Testing the feed HTML. <small><span class="colork14">GREEN</span></small></p>
<pre class="pre2">test/integration/following_test.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-50a" id="list14-50">Click here to view code image</a></p>
<div class="example">
<pre><span class="colork3">require</span> <span class="colork11">'test_helper'</span>

<strong><span class="colork10">class</span> <span class="colork4">FollowingTest</span></strong> <span class="colork11">&lt; ActionDispatch::IntegrationTest</span>

  <strong><span class="colork10">def</span></strong> <span class="colork4">setup</span>
    <span class="colork8">@user =</span> users(<span class="colork8">:michael</span>)
    log_in_as(<span class="colork8">@user</span>)
  <strong><span class="colork10">end</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork8">test</span> <span class="colork22">"feed on Home page"</span> <strong><span class="colork10">do</span></strong>
<span epub:type="pagebreak" id="page_780"></span>    get root_path
    <span class="colork8">@user.</span>feed.paginate(<span class="colork8">page: 1</span>).each <strong><span class="colork10">do</span></strong> <span class="colork9">|</span>micropost<span class="colork9">|</span>
      assert_match <span class="colork1">CGI.</span>escapeHTML(<span class="colork1">FILL_IN</span>), <span class="colork1">FILL_IN</span>
    <strong><span class="colork10">end</span></strong>
  <strong><span class="colork10">end</span></strong>
<strong><span class="colork10">end</span></strong></pre>
</div>
<p class="ex-title" id="ch14ex051"><strong>Listing 14.51:</strong> Using a <code><strong><span class="colork1">join</span></strong></code> to make the feed.</p>
<pre class="pre2">app/models/user.rb</pre>
<p class="codelink"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14_images.xhtml#list14-51a" id="list14-51">Click here to view code image</a></p>
<div class="example">
<pre><strong><span class="colork10">class</span> <span class="colork4">User</span></strong> <span class="colork27">&lt; ApplicationRecord</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork18"># Returns a user's status feed.</span>
  <strong><span class="colork10">def</span></strong> <span class="colork4">feed</span>
    part_of_feed <span class="colork22">= "relationships.follower_id = :id or microposts.user_id = :id"</span>
    <span class="colork1">Micropost</span><span class="colork9">.</span>joins(<span class="colork8">user</span>: <span class="colork8">:followers</span>).where(part_of_feed, { <span class="colork8">id</span>: <span class="colork22">id</span> })
  <strong><span class="colork10">end</span></strong>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
  <span class="colork9">.</span>
<strong><span class="colork10">end</span></strong></pre>
</div>
</section>
</section>
</section>
<section>
<h3 class="h3" id="sec14_4">14.4 Conclusion</h3>
<p class="noindent">With the addition of the status feed, we’ve finished the sample application for the <em>Ruby on Rails Tutorial</em>. This application includes examples of all the major features of Rails, including models, views, controllers, templates, partials, filters, validations, callbacks, <code><strong><span class="colork1">has_many</span></strong></code>/<code><strong><span class="colork1">belongs_to</span></strong></code> and <code><strong><span class="colork1">has_many :through</span></strong></code> associations, security, testing, and deployment.</p>
<p class="indent">Despite this impressive list, there is still much to learn about web development. As a first step in this process, this section contains some suggestions for further learning.</p>
<section>
<h4 class="h4" id="sec14_4_1">14.4.1 Guide to Further Resources</h4>
<p class="noindent">A wealth of Rails resources are available in stores and on the web—indeed, the supply is so rich that it can be overwhelming. The good news is that, having gotten this far, <span epub:type="pagebreak" id="page_781"></span>you’re ready for almost anything else out there. Here are some suggestions for further learning:</p>
<p class="bullet">• Learn Enough All Access Bundle: Premium subscription service that includes a special enhanced version of the <em>Ruby on Rails Tutorial</em> book and 15-plus hours of streaming screencast lessons filled with the kind of tips, tricks, and live demos that you can’t get from reading a book. Also includes text and videos for the other Learn Enough tutorials. Scholarship discounts are available.</p>
<p class="bullet">• Launch School: Lots of in-person developer bootcamps have sprung up in recent years, and I recommend looking for one in your area, but Launch School is available online and so can be taken from anywhere. Launch School is an especially good choice if you want instructor feedback within the context of a structured curriculum.</p>
<p class="bullet">• The Turing School of Software &amp; Design: A full-time, 27-week Ruby/Rails/-JavaScript training program in Denver, Colorado. Most of its students start with limited programming experience but have the determination and drive needed to pick it up quickly. Turing guarantees its students will find a job after graduating or the school will refund the cost of tuition.</p>
<p class="bullet">• Bloc: An online bootcamp with a structured curriculum, personalized mentorship, and a focus on learning through concrete projects. Use the coupon code BLOCLOVESHARTL to get $500 off the enrollment fee.</p>
<p class="bullet">• Thinkful: An online class that pairs you with a professional engineer as you work through a project-based curriculum. Subjects include Ruby on Rails, front-end development, web design, and data science.</p>
<p class="bullet">• Pragmatic Studio: Online Ruby and Rails courses from Mike and Nicole Clark.</p>
<p class="bullet">• RailsApps: Instructive sample Rails apps.</p>
<p class="bullet">• Lambda School: An innovative full-time online program that you pay for only if you land a high-paying job.</p>
</section>
<section>
<h4 class="h4" id="sec14_4_2">14.4.2 What We Learned in this Chapter</h4>
<p class="bullet">• Rails’ <code><strong><span class="colork1">has_many :through</span></strong></code> allows the modeling of complicated data relationships.<span epub:type="pagebreak" id="page_782"></span></p>
<p class="bullet">• The <code><strong><span class="colork1">has_many</span></strong></code> method takes several optional arguments, including the object class name and the foreign key.</p>
<p class="bullet">• Using <code><strong><span class="colork1">has_many</span></strong></code> and <code><strong><span class="colork1">has_many :through</span></strong></code> with properly chosen class names and foreign keys, we can model both active (following) and passive (being followed) relationships.</p>
<p class="bullet">• Rails routing supports nested routes.</p>
<p class="bullet">• The <code><strong><span class="colork1">where</span></strong></code> method is a flexible and powerful way to create database queries.</p>
<p class="bullet">• Rails supports issuing lower-level SQL queries if needed.</p>
<p class="bullet">• By putting together everything we’ve learned in this book, we’ve successfully implemented user following with a status feed of microposts from followed users.</p>
</section>
</section>
</section>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-16" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch13.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Chapter 13. User Microposts</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/index.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Index</div>
        </a>
    
  
  </div>

</section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed slideUp">
        
        
          <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://learning.oreilly.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
        

        
        

      </div>

    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
  <a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">© 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(1)" charset="utf-8"></script><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/embed.js.download"></script>
    <script src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/saved_resource(2)" charset="utf-8"></script>
  

<div></div><div></div><div class="selection_bubble_root" style="display: none;"></div><div class="annotator-notice"></div><div class="font-flyout" style="top: 201.006px; left: 1194.34px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/ruby-on-rails/9780136702726/ch14.xhtml#">Reset</a>
</div>
</div><script type="text/javascript" async="" src="./Chapter 14. Following Users - Ruby on Rails Tutorial, 6th Edition_files/generic1604331345324.js.download" charset="UTF-8"></script><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script><span></span><script type="text/javascript" id="">dataLayer.push({"ld.experiment":void 0,"ld.variation":void 0});</script><div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size2, sans-serif;"></div></div></body></html>